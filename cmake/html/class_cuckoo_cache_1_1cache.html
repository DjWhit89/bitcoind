<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>bitcoind: cache&lt; Element, Hash &gt; Class Template Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="bitcoin.ico"/></td>
  <td id="projectalign">
   <div id="projectname">bitcoind<span id="projectnumber">&#160;2.8</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('class_cuckoo_cache_1_1cache.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">cache&lt; Element, Hash &gt; Class Template Reference</div></div>
</div><!--header-->
<div class="contents">

<p><code>#include &lt;<a class="el" href="cuckoocache_8h_source.html">cuckoocache.h</a>&gt;</code></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-pub-methods" class="groupheader"><a id="pub-methods" name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:ab23554f62408c63d48b826b5f2bf85d1" id="r_ab23554f62408c63d48b826b5f2bf85d1"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ab23554f62408c63d48b826b5f2bf85d1">cache</a> ()</td></tr>
<tr class="memitem:a285a84ed8df980e01cf6675f5129a506" id="r_a285a84ed8df980e01cf6675f5129a506"><td class="memItemLeft" align="right" valign="top">uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a285a84ed8df980e01cf6675f5129a506">setup</a> (uint32_t new_size)</td></tr>
<tr class="memitem:abc547a231db5bfa46b6f3912bb894380" id="r_abc547a231db5bfa46b6f3912bb894380"><td class="memItemLeft" align="right" valign="top">std::pair&lt; uint32_t, size_t &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#abc547a231db5bfa46b6f3912bb894380">setup_bytes</a> (size_t bytes)</td></tr>
<tr class="memitem:ad890f3cd4e0725ea56d7e4a3305a3487" id="r_ad890f3cd4e0725ea56d7e4a3305a3487"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ad890f3cd4e0725ea56d7e4a3305a3487">insert</a> (Element e)</td></tr>
<tr class="memitem:a0c6c8da8f3b8de3c38a99ed23d92099e" id="r_a0c6c8da8f3b8de3c38a99ed23d92099e"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a0c6c8da8f3b8de3c38a99ed23d92099e">contains</a> (const Element &amp;e, const bool erase) const</td></tr>
</table>
<a name="details" id="details"></a><h2 id="header-details" class="groupheader">Detailed Description</h2>
<div class="textblock"><div class="compoundTemplParams">template&lt;typename Element, typename <a class="el" href="hash_8h.html#ac49a4a382d911138c745234f2fe7986d">Hash</a>&gt;<br />
class CuckooCache::cache&lt; Element, Hash &gt;</div><p><a class="el" href="class_cuckoo_cache_1_1cache.html">cache</a> implements a cache with properties similar to a cuckoo-set.</p>
<p>The cache is able to hold up to <span class="tt">(~(uint32_t)0) - 1</span> elements.</p>
<p>Read Operations:</p><ul>
<li><a class="el" href="#a0c6c8da8f3b8de3c38a99ed23d92099e">contains()</a> for <span class="tt">erase=false</span></li>
</ul>
<p>Read+Erase Operations:</p><ul>
<li><a class="el" href="#a0c6c8da8f3b8de3c38a99ed23d92099e">contains()</a> for <span class="tt">erase=true</span></li>
</ul>
<p>Erase Operations:</p><ul>
<li>allow_erase()</li>
</ul>
<p>Write Operations:</p><ul>
<li><a class="el" href="#a285a84ed8df980e01cf6675f5129a506">setup()</a></li>
<li><a class="el" href="#abc547a231db5bfa46b6f3912bb894380">setup_bytes()</a></li>
<li><a class="el" href="#ad890f3cd4e0725ea56d7e4a3305a3487">insert()</a></li>
<li>please_keep()</li>
</ul>
<p>Synchronization Free Operations:</p><ul>
<li>invalid()</li>
<li>compute_hashes()</li>
</ul>
<p>User Must Guarantee:</p>
<ol type="1">
<li>Write requires synchronized access (e.g. a lock)</li>
<li>Read requires no concurrent Write, synchronized with last insert.</li>
<li>Erase requires no concurrent Write, synchronized with last insert.</li>
<li>An Erase caller must release all memory before allowing a new Writer.</li>
</ol>
<p>Note on function names:</p><ul>
<li>The name "allow_erase" is used because the real discard happens later.</li>
<li>The name "please_keep" is used because elements may be erased anyways on insert.</li>
</ul>
<dl class="tparams"><dt>Template Parameters</dt><dd>
  <table class="tparams">
    <tr><td class="paramname">Element</td><td>should be a movable and copyable type </td></tr>
    <tr><td class="paramname">Hash</td><td>should be a function/callable which takes a template parameter hash_select and an Element and extracts a hash from it. Should return high-entropy uint32_t hashes for <span class="tt"><a class="el" href="hash_8h.html#ac49a4a382d911138c745234f2fe7986d">Hash</a> h; h&lt;0&gt;(e) ... h&lt;7&gt;(e)</span>. </td></tr>
  </table>
  </dd>
</dl>
</div><a name="doc-constructors" id="doc-constructors"></a><h2 id="header-doc-constructors" class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="ab23554f62408c63d48b826b5f2bf85d1" name="ab23554f62408c63d48b826b5f2bf85d1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab23554f62408c63d48b826b5f2bf85d1">&#9670;&#160;</a></span>cache()</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename Element, typename <a class="el" href="hash_8h.html#ac49a4a382d911138c745234f2fe7986d">Hash</a>&gt; </div>
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">cache </td>
          <td>(</td>
          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>You must always construct a cache with some elements via a subsequent call to setup or setup_bytes, otherwise operations may segfault. </p>

</div>
</div>
<a name="doc-func-members" id="doc-func-members"></a><h2 id="header-doc-func-members" class="groupheader">Member Function Documentation</h2>
<a id="a0c6c8da8f3b8de3c38a99ed23d92099e" name="a0c6c8da8f3b8de3c38a99ed23d92099e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0c6c8da8f3b8de3c38a99ed23d92099e">&#9670;&#160;</a></span>contains()</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename Element, typename <a class="el" href="hash_8h.html#ac49a4a382d911138c745234f2fe7986d">Hash</a>&gt; </div>
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">bool contains </td>
          <td>(</td>
          <td class="paramtype">const Element &amp;</td>          <td class="paramname"><span class="paramname"><em>e</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const bool</td>          <td class="paramname"><span class="paramname"><em>erase</em></span>&#160;) const</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>contains iterates through the hash locations for a given element and checks to see if it is present.</p>
<p>contains does not check garbage collected state (in other words, garbage is only collected when the space is needed), so:</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="#ad890f3cd4e0725ea56d7e4a3305a3487">insert</a>(x);</div>
<div class="line"><span class="keywordflow">if</span> (<a class="code hl_function" href="#a0c6c8da8f3b8de3c38a99ed23d92099e">contains</a>(x, <span class="keyword">true</span>))</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_function" href="#a0c6c8da8f3b8de3c38a99ed23d92099e">contains</a>(x, <span class="keyword">false</span>);</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="ttc" id="aclass_cuckoo_cache_1_1cache_html_a0c6c8da8f3b8de3c38a99ed23d92099e"><div class="ttname"><a href="#a0c6c8da8f3b8de3c38a99ed23d92099e">CuckooCache::cache::contains</a></div><div class="ttdeci">bool contains(const Element &amp;e, const bool erase) const</div><div class="ttdef"><b>Definition</b> cuckoocache.h:474</div></div>
<div class="ttc" id="aclass_cuckoo_cache_1_1cache_html_ad890f3cd4e0725ea56d7e4a3305a3487"><div class="ttname"><a href="#ad890f3cd4e0725ea56d7e4a3305a3487">CuckooCache::cache::insert</a></div><div class="ttdeci">void insert(Element e)</div><div class="ttdef"><b>Definition</b> cuckoocache.h:397</div></div>
</div><!-- fragment --><p>executed on a single thread will always return true!</p>
<p>This is a great property for re-org performance for example.</p>
<p>contains returns a bool set true if the element was found.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">e</td><td>the element to check </td></tr>
    <tr><td class="paramname">erase</td><td>whether to attempt setting the garbage collect flag</td></tr>
  </table>
  </dd>
</dl>
<dl class="section post"><dt>Postcondition</dt><dd>if erase is true and the element is found, then the garbage collect flag is set </dd></dl>
<dl class="section return"><dt>Returns</dt><dd>true if the element is found, false otherwise </dd></dl>

</div>
</div>
<a id="ad890f3cd4e0725ea56d7e4a3305a3487" name="ad890f3cd4e0725ea56d7e4a3305a3487"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad890f3cd4e0725ea56d7e4a3305a3487">&#9670;&#160;</a></span>insert()</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename Element, typename <a class="el" href="hash_8h.html#ac49a4a382d911138c745234f2fe7986d">Hash</a>&gt; </div>
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void insert </td>
          <td>(</td>
          <td class="paramtype">Element</td>          <td class="paramname"><span class="paramname"><em>e</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>insert loops at most depth_limit times trying to insert a hash at various locations in the table via a variant of the Cuckoo Algorithm with eight hash locations.</p>
<p>It drops the last tried element if it runs out of depth before encountering an open slot.</p>
<p>Thus:</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="#ad890f3cd4e0725ea56d7e4a3305a3487">insert</a>(x);</div>
<div class="line"><span class="keywordflow">return</span> <a class="code hl_function" href="#a0c6c8da8f3b8de3c38a99ed23d92099e">contains</a>(x, <span class="keyword">false</span>);</div>
</div><!-- fragment --><p>is not guaranteed to return true.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">e</td><td>the element to insert </td></tr>
  </table>
  </dd>
</dl>
<dl class="section post"><dt>Postcondition</dt><dd>one of the following: All previously inserted elements and e are now in the table, one previously inserted element is evicted from the table, the entry attempted to be inserted is evicted. </dd></dl>
<p>Swap with the element at the location that was not the last one looked at. Example:</p>
<ol type="1">
<li>On first iteration, last_loc == invalid(), find returns last, so last_loc defaults to locs[0].</li>
<li>On further iterations, where last_loc == locs[k], last_loc will go to locs[k+1 % 8], i.e., next of the 8 indices wrapping around to 0 if needed.</li>
</ol>
<p>This prevents moving the element we just put in.</p>
<p>The swap is not a move &ndash; we must switch onto the evicted element for the next iteration.</p>

</div>
</div>
<a id="a285a84ed8df980e01cf6675f5129a506" name="a285a84ed8df980e01cf6675f5129a506"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a285a84ed8df980e01cf6675f5129a506">&#9670;&#160;</a></span>setup()</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename Element, typename <a class="el" href="hash_8h.html#ac49a4a382d911138c745234f2fe7986d">Hash</a>&gt; </div>
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t setup </td>
          <td>(</td>
          <td class="paramtype">uint32_t</td>          <td class="paramname"><span class="paramname"><em>new_size</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>setup initializes the container to store no more than new_size elements and no less than 2 elements.</p>
<p>setup should only be called once.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">new_size</td><td>the desired number of elements to store </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the maximum number of elements storable </dd></dl>

</div>
</div>
<a id="abc547a231db5bfa46b6f3912bb894380" name="abc547a231db5bfa46b6f3912bb894380"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abc547a231db5bfa46b6f3912bb894380">&#9670;&#160;</a></span>setup_bytes()</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename Element, typename <a class="el" href="hash_8h.html#ac49a4a382d911138c745234f2fe7986d">Hash</a>&gt; </div>
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">std::pair&lt; uint32_t, size_t &gt; setup_bytes </td>
          <td>(</td>
          <td class="paramtype">size_t</td>          <td class="paramname"><span class="paramname"><em>bytes</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel inline">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>setup_bytes is a convenience function which accounts for internal memory usage when deciding how many elements to store. It isn't perfect because it doesn't account for any overhead (struct size, MallocUsage, collection and epoch flags). This was done to simplify selecting a power of two size. In the expected use case, an extra two bits per entry should be negligible compared to the size of the elements.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">bytes</td><td>the approximate number of bytes to use for this data structure </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>A pair of the maximum number of elements storable (see <a class="el" href="#a285a84ed8df980e01cf6675f5129a506">setup()</a> documentation for more detail) and the approximate total size of these elements in bytes. </dd></dl>

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>src/<a class="el" href="cuckoocache_8h_source.html">cuckoocache.h</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a href="namespace_cuckoo_cache.html">CuckooCache</a></li><li class="navelem"><a href="class_cuckoo_cache_1_1cache.html">cache</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
