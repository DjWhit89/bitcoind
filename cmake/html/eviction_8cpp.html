<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>bitcoind: src/node/eviction.cpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="bitcoin.ico"/></td>
  <td id="projectalign">
   <div id="projectname">bitcoind<span id="projectnumber">&#160;2.8</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('eviction_8cpp.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">eviction.cpp File Reference</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;<a class="el" href="eviction_8h_source.html">node/eviction.h</a>&gt;</code><br />
<code>#include &lt;algorithm&gt;</code><br />
<code>#include &lt;array&gt;</code><br />
<code>#include &lt;chrono&gt;</code><br />
<code>#include &lt;cstdint&gt;</code><br />
<code>#include &lt;functional&gt;</code><br />
<code>#include &lt;map&gt;</code><br />
<code>#include &lt;vector&gt;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-nested-classes" class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:CompareNodeNetworkTime" id="r_CompareNodeNetworkTime"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct_compare_node_network_time.html">CompareNodeNetworkTime</a></td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-func-members" class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a31eb14e9967af753ff75ef1e61520314" id="r_a31eb14e9967af753ff75ef1e61520314"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a31eb14e9967af753ff75ef1e61520314">ProtectNoBanConnections</a> (std::vector&lt; <a class="el" href="struct_node_eviction_candidate.html">NodeEvictionCandidate</a> &gt; &amp;eviction_candidates)</td></tr>
<tr class="memitem:ad5272b431f51c08dd3d65ed5d6c10be3" id="r_ad5272b431f51c08dd3d65ed5d6c10be3"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ad5272b431f51c08dd3d65ed5d6c10be3">ProtectOutboundConnections</a> (std::vector&lt; <a class="el" href="struct_node_eviction_candidate.html">NodeEvictionCandidate</a> &gt; &amp;eviction_candidates)</td></tr>
<tr class="memitem:a6d7ad378024a7749d028e7e9f570b1e3" id="r_a6d7ad378024a7749d028e7e9f570b1e3"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a6d7ad378024a7749d028e7e9f570b1e3">ProtectEvictionCandidatesByRatio</a> (std::vector&lt; <a class="el" href="struct_node_eviction_candidate.html">NodeEvictionCandidate</a> &gt; &amp;eviction_candidates)</td></tr>
<tr class="memitem:a799d58489ce4ea35e8bc556dd9ffb33c" id="r_a799d58489ce4ea35e8bc556dd9ffb33c"><td class="memItemLeft" align="right" valign="top">std::optional&lt; <a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a799d58489ce4ea35e8bc556dd9ffb33c">SelectNodeToEvict</a> (std::vector&lt; <a class="el" href="struct_node_eviction_candidate.html">NodeEvictionCandidate</a> &gt; &amp;&amp;vEvictionCandidates)</td></tr>
</table>
<a name="doc-func-members" id="doc-func-members"></a><h2 id="header-doc-func-members" class="groupheader">Function Documentation</h2>
<a id="a6d7ad378024a7749d028e7e9f570b1e3" name="a6d7ad378024a7749d028e7e9f570b1e3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6d7ad378024a7749d028e7e9f570b1e3">&#9670;&#160;</a></span>ProtectEvictionCandidatesByRatio()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ProtectEvictionCandidatesByRatio </td>
          <td>(</td>
          <td class="paramtype">std::vector&lt; <a class="el" href="struct_node_eviction_candidate.html">NodeEvictionCandidate</a> &gt; &amp;</td>          <td class="paramname"><span class="paramname"><em>vEvictionCandidates</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Protect desirable or disadvantaged inbound peers from eviction by ratio.</p>
<p>This function protects half of the peers which have been connected the longest, to replicate the non-eviction implicit behavior and preclude attacks that start later.</p>
<p>Half of these protected spots (1/4 of the total) are reserved for the following categories of peers, sorted by longest uptime, even if they're not longest uptime overall:</p>
<ul>
<li>onion peers connected via our tor control service</li>
<li>localhost peers, as manually configured hidden services not using <span class="tt">-bind=addr[:port]=onion</span> will not be detected as inbound onion connections</li>
<li>I2P peers</li>
<li>CJDNS peers</li>
</ul>
<p>This helps protect these privacy network peers, which tend to be otherwise disadvantaged under our eviction criteria for their higher min ping times relative to IPv4/IPv6 peers, and favorise the diversity of peer connections. </p>

</div>
</div>
<a id="a31eb14e9967af753ff75ef1e61520314" name="a31eb14e9967af753ff75ef1e61520314"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a31eb14e9967af753ff75ef1e61520314">&#9670;&#160;</a></span>ProtectNoBanConnections()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ProtectNoBanConnections </td>
          <td>(</td>
          <td class="paramtype">std::vector&lt; <a class="el" href="struct_node_eviction_candidate.html">NodeEvictionCandidate</a> &gt; &amp;</td>          <td class="paramname"><span class="paramname"><em>eviction_candidates</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ad5272b431f51c08dd3d65ed5d6c10be3" name="ad5272b431f51c08dd3d65ed5d6c10be3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad5272b431f51c08dd3d65ed5d6c10be3">&#9670;&#160;</a></span>ProtectOutboundConnections()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ProtectOutboundConnections </td>
          <td>(</td>
          <td class="paramtype">std::vector&lt; <a class="el" href="struct_node_eviction_candidate.html">NodeEvictionCandidate</a> &gt; &amp;</td>          <td class="paramname"><span class="paramname"><em>eviction_candidates</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a799d58489ce4ea35e8bc556dd9ffb33c" name="a799d58489ce4ea35e8bc556dd9ffb33c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a799d58489ce4ea35e8bc556dd9ffb33c">&#9670;&#160;</a></span>SelectNodeToEvict()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">std::optional&lt; <a class="el" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> &gt; SelectNodeToEvict </td>
          <td>(</td>
          <td class="paramtype">std::vector&lt; <a class="el" href="struct_node_eviction_candidate.html">NodeEvictionCandidate</a> &gt; &amp;&amp;</td>          <td class="paramname"><span class="paramname"><em>vEvictionCandidates</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel nodiscard">nodiscard</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Select an inbound peer to evict after filtering out (protecting) peers having distinct, difficult-to-forge characteristics. The protection logic picks out fixed numbers of desirable peers per various criteria, followed by (mostly) ratios of desirable or disadvantaged peers. If any eviction candidates remain, the selection logic chooses a peer to evict. </p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a href="dir_18ae7af74d885898b85cbb543ae51b63.html">node</a></li><li class="navelem"><a href="eviction_8cpp.html">eviction.cpp</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
