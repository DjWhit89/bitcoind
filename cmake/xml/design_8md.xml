<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.15.0" xml:lang="en-US">
  <compounddef id="design_8md" kind="file" language="Markdown">
    <compoundname>design.md</compoundname>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline><highlight class="normal">#<sp/>libmultiprocess<sp/>Design</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">Given<sp/>an<sp/>interface<sp/>description<sp/>of<sp/>an<sp/>object<sp/>with<sp/>one<sp/>or<sp/>more<sp/>methods,<sp/>libmultiprocess<sp/>generates:</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">*<sp/>A<sp/>C++<sp/>`ProxyClient`<sp/>class<sp/>template<sp/>specialization<sp/>with<sp/>an<sp/>implementation<sp/>of<sp/>each<sp/>interface<sp/>method<sp/>that<sp/>sends<sp/>a<sp/>request<sp/>over<sp/>a<sp/>socket,<sp/>waits<sp/>for<sp/>a<sp/>response,<sp/>and<sp/>returns<sp/>the<sp/>result.</highlight></codeline>
<codeline><highlight class="normal">*<sp/>A<sp/>C++<sp/>`ProxyServer`<sp/>class<sp/>template<sp/>specialization<sp/>that<sp/>listens<sp/>for<sp/>requests<sp/>over<sp/>a<sp/>socket<sp/>and<sp/>calls<sp/>a<sp/>wrapped<sp/>C++<sp/>object<sp/>implementing<sp/>the<sp/>same<sp/>interface<sp/>to<sp/>actually<sp/>execute<sp/>the<sp/>requests.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">The<sp/>function<sp/>call<sp/>â‡†<sp/>request<sp/>translation<sp/>supports<sp/>input<sp/>and<sp/>output<sp/>arguments,<sp/>standard<sp/>types<sp/>like<sp/>`unique_ptr`,<sp/>`vector`,<sp/>`map`,<sp/>and<sp/>`optional`,<sp/>and<sp/>bidirectional<sp/>calls<sp/>between<sp/>processes<sp/>through<sp/>interface<sp/>pointer<sp/>and<sp/>`std::function`<sp/>arguments.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">If<sp/>the<sp/>wrapped<sp/>C++<sp/>object<sp/>inherits<sp/>from<sp/>an<sp/>abstract<sp/>base<sp/>class<sp/>declaring<sp/>virtual<sp/>methods,<sp/>the<sp/>generated<sp/>`ProxyClient`<sp/>objects<sp/>can<sp/>inherit<sp/>from<sp/>the<sp/>same<sp/>class,<sp/>allowing<sp/>interprocess<sp/>calls<sp/>to<sp/>replace<sp/>local<sp/>calls<sp/>without<sp/>changes<sp/>to<sp/>existing<sp/>code.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">There<sp/>is<sp/>also<sp/>optional<sp/>support<sp/>for<sp/>thread<sp/>mapping,<sp/>so<sp/>each<sp/>thread<sp/>making<sp/>interprocess<sp/>calls<sp/>can<sp/>have<sp/>a<sp/>dedicated<sp/>thread<sp/>processing<sp/>requests<sp/>from<sp/>it,<sp/>and<sp/>callbacks<sp/>from<sp/>processing<sp/>threads<sp/>are<sp/>executed<sp/>on<sp/>corresponding<sp/>request<sp/>threads<sp/>(so<sp/>recursive<sp/>mutexes<sp/>and<sp/>thread<sp/>names<sp/>function<sp/>as<sp/>expected<sp/>in<sp/>callbacks).</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">Libmultiprocess<sp/>acts<sp/>as<sp/>a<sp/>pure<sp/>wrapper<sp/>or<sp/>layer<sp/>over<sp/>the<sp/>underlying<sp/>protocol.<sp/>Clients<sp/>and<sp/>servers<sp/>written<sp/>in<sp/>other<sp/>languages,<sp/>but<sp/>using<sp/>a<sp/>shared<sp/>capnproto<sp/>schema<sp/>can<sp/>communicate<sp/>with<sp/>interprocess<sp/>counterparties<sp/>using<sp/>libmultiprocess<sp/>without<sp/>having<sp/>to<sp/>use<sp/>libmultiprocess<sp/>themselves<sp/>or<sp/>having<sp/>to<sp/>know<sp/>about<sp/>the<sp/>implementation<sp/>details<sp/>of<sp/>libmultiprocess.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">###<sp/>Internals</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">The<sp/>`ProxyClient`<sp/>and<sp/>`ProxyServer`<sp/>generated<sp/>classes<sp/>are<sp/>not<sp/>directly<sp/>exposed<sp/>to<sp/>the<sp/>user,<sp/>as<sp/>described<sp/>in<sp/>[usage.md](usage.md).<sp/>Instead,<sp/>they<sp/>wrap<sp/>C++<sp/>interfaces<sp/>and<sp/>appear<sp/>to<sp/>the<sp/>user<sp/>as<sp/>pointers<sp/>to<sp/>an<sp/>interface.<sp/>They<sp/>are<sp/>first<sp/>instantiated<sp/>when<sp/>calling<sp/>`ConnectStream`<sp/>and<sp/>`ServeStream`<sp/>respectively<sp/>for<sp/>creating<sp/>the<sp/>`InitInterface`.<sp/>These<sp/>methods<sp/>establish<sp/>connections<sp/>through<sp/>sockets,<sp/>internally<sp/>creating<sp/>`Connection`<sp/>objects<sp/>wrapping<sp/>a<sp/>`capnp::RpcSystem`<sp/>configured<sp/>for<sp/>client<sp/>and<sp/>server<sp/>mode<sp/>respectively.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">The<sp/>`InitInterface`<sp/>interface<sp/>will<sp/>typically<sp/>have<sp/>methods<sp/>which<sp/>return<sp/>other<sp/>interfaces,<sp/>giving<sp/>the<sp/>connecting<sp/>process<sp/>the<sp/>ability<sp/>to<sp/>call<sp/>other<sp/>functions<sp/>in<sp/>the<sp/>serving<sp/>process.<sp/>Interfaces<sp/>can<sp/>also<sp/>have<sp/>methods<sp/>accepting<sp/>other<sp/>interfaces<sp/>as<sp/>parameters,<sp/>giving<sp/>serving<sp/>processes<sp/>the<sp/>ability<sp/>to<sp/>call<sp/>back<sp/>and<sp/>invoke<sp/>functions<sp/>in<sp/>connecting<sp/>processes.<sp/>Creating<sp/>new<sp/>interfaces<sp/>does<sp/>not<sp/>create<sp/>new<sp/>connections,<sp/>and<sp/>typically<sp/>many<sp/>interface<sp/>objects<sp/>will<sp/>share<sp/>the<sp/>same<sp/>connection.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">Both<sp/>`ConnectStream`<sp/>and<sp/>`ServeStream`<sp/>also<sp/>require<sp/>an<sp/>instantiation<sp/>of<sp/>the<sp/>`EventLoop`.<sp/>The<sp/>`EventLoop`<sp/>owns<sp/>pending<sp/>requests,<sp/>notifies<sp/>on<sp/>request<sp/>dispatch,<sp/>allows<sp/>clients<sp/>from<sp/>multiple<sp/>threads<sp/>to<sp/>make<sp/>synchronous<sp/>calls,<sp/>and<sp/>handles<sp/>some<sp/>cleanup<sp/>routines<sp/>on<sp/>exit.<sp/>It<sp/>must<sp/>be<sp/>run<sp/>in<sp/>a<sp/>separate<sp/>thread<sp/>so<sp/>it<sp/>is<sp/>always<sp/>active<sp/>and<sp/>can<sp/>process<sp/>incoming<sp/>requests<sp/>from<sp/>local<sp/>clients<sp/>and<sp/>remote<sp/>connections.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">When<sp/>a<sp/>generated<sp/>method<sp/>on<sp/>the<sp/>`ProxyClient`<sp/>is<sp/>called,<sp/>it<sp/>calls<sp/>`clientInvoke`<sp/>with<sp/>the<sp/>capnp-translated<sp/>types.<sp/>`clientInvoke`<sp/>creates<sp/>a<sp/>self-executing<sp/>promise<sp/>(`kj::TaskSet`)<sp/>that<sp/>drives<sp/>the<sp/>execution<sp/>of<sp/>the<sp/>request<sp/>and<sp/>gives<sp/>ownership<sp/>of<sp/>it<sp/>to<sp/>the<sp/>`EventLoop`.<sp/>`clientInvoke`<sp/>blocks<sp/>until<sp/>a<sp/>response<sp/>is<sp/>received,<sp/>or<sp/>until<sp/>there<sp/>is<sp/>a<sp/>call<sp/>from<sp/>the<sp/>server<sp/>that<sp/>needs<sp/>to<sp/>run<sp/>on<sp/>the<sp/>same<sp/>client<sp/>thread,<sp/>using<sp/>a<sp/>`Waiter`<sp/>object.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">On<sp/>the<sp/>server<sp/>side,<sp/>the<sp/>`capnp::RpcSystem`<sp/>receives<sp/>the<sp/>capnp<sp/>request<sp/>and<sp/>invokes<sp/>the<sp/>corresponding<sp/>C++<sp/>method<sp/>through<sp/>the<sp/>corresponding<sp/>`ProxyServer`<sp/>and<sp/>the<sp/>heavily<sp/>templated<sp/>`serverInvoke`<sp/>triggering<sp/>a<sp/>`ServerCall`.<sp/>The<sp/>return<sp/>values<sp/>from<sp/>the<sp/>actual<sp/>C++<sp/>methods<sp/>are<sp/>copied<sp/>into<sp/>capnp<sp/>responses<sp/>by<sp/>`ServerRet`<sp/>and<sp/>exceptions<sp/>are<sp/>caught<sp/>and<sp/>copied<sp/>by<sp/>`ServerExcept`.<sp/>The<sp/>two<sp/>are<sp/>connected<sp/>through<sp/>`ServerField`.<sp/>The<sp/>main<sp/>method<sp/>driving<sp/>execution<sp/>of<sp/>a<sp/>request<sp/>is<sp/>`PassField`,<sp/>which<sp/>is<sp/>invoked<sp/>through<sp/>`ServerField`.<sp/>Instantiated<sp/>interfaces,<sp/>or<sp/>capabilities<sp/>in<sp/>capnp<sp/>speak,<sp/>are<sp/>tracked<sp/>and<sp/>owned<sp/>by<sp/>the<sp/>server&apos;s<sp/>`capnp::RpcSystem`.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Interface<sp/>descriptions</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">As<sp/>explained<sp/>in<sp/>the<sp/>[usage](usage.md)<sp/>document,<sp/>interface<sp/>descriptions<sp/>need<sp/>to<sp/>be<sp/>consumed<sp/>both<sp/>by<sp/>the<sp/>_libmultiprocess_<sp/>code<sp/>generator,<sp/>and<sp/>by<sp/>C++<sp/>code<sp/>that<sp/>calls<sp/>and<sp/>implements<sp/>the<sp/>interfaces.<sp/>The<sp/>C++<sp/>code<sp/>only<sp/>needs<sp/>to<sp/>know<sp/>about<sp/>C++<sp/>arguments<sp/>and<sp/>return<sp/>types,<sp/>while<sp/>the<sp/>code<sp/>generator<sp/>only<sp/>needs<sp/>to<sp/>know<sp/>about<sp/>capnp<sp/>arguments<sp/>and<sp/>return<sp/>types,<sp/>but<sp/>both<sp/>need<sp/>to<sp/>know<sp/>class<sp/>and<sp/>method<sp/>names,<sp/>so<sp/>the<sp/>corresponding<sp/>`.h`<sp/>and<sp/>`.capnp`<sp/>source<sp/>files<sp/>contain<sp/>some<sp/>of<sp/>the<sp/>same<sp/>information,<sp/>and<sp/>have<sp/>to<sp/>be<sp/>kept<sp/>in<sp/>sync<sp/>manually<sp/>when<sp/>methods<sp/>or<sp/>parameters<sp/>change.<sp/>Despite<sp/>the<sp/>redundancy,<sp/>reconciling<sp/>the<sp/>interface<sp/>definitions<sp/>is<sp/>designed<sp/>to<sp/>be<sp/>_straightforward_<sp/>and<sp/>_safe_.<sp/>_Straightforward_<sp/>because<sp/>there<sp/>is<sp/>no<sp/>need<sp/>to<sp/>write<sp/>manual<sp/>serialization<sp/>code<sp/>or<sp/>use<sp/>awkward<sp/>intermediate<sp/>types<sp/>like<sp/>[`UniValue`](https://github.com/bitcoin/bitcoin/blob/master/src/univalue/include/univalue.h)<sp/>instead<sp/>of<sp/>native<sp/>types.<sp/>_Safe_<sp/>because<sp/>if<sp/>there<sp/>are<sp/>any<sp/>inconsistencies<sp/>between<sp/>API<sp/>and<sp/>data<sp/>definitions<sp/>(even<sp/>minor<sp/>ones<sp/>like<sp/>using<sp/>a<sp/>narrow<sp/>int<sp/>data<sp/>type<sp/>for<sp/>a<sp/>wider<sp/>int<sp/>API<sp/>input),<sp/>there<sp/>are<sp/>errors<sp/>at<sp/>build<sp/>time<sp/>instead<sp/>of<sp/>errors<sp/>or<sp/>bugs<sp/>at<sp/>runtime.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">In<sp/>the<sp/>future,<sp/>it<sp/>would<sp/>be<sp/>possible<sp/>to<sp/>combine<sp/>API<sp/>and<sp/>data<sp/>definitions<sp/>together<sp/>using<sp/>[C++<sp/>attributes](https://en.cppreference.com/w/cpp/language/attributes).<sp/>To<sp/>do<sp/>this<sp/>we<sp/>would<sp/>add<sp/>attributes<sp/>to<sp/>the<sp/>API<sp/>definition<sp/>files,<sp/>and<sp/>then<sp/>generate<sp/>the<sp/>data<sp/>definitions<sp/>from<sp/>the<sp/>API<sp/>definitions<sp/>and<sp/>attributes.<sp/>I<sp/>didn&apos;t<sp/>take<sp/>this<sp/>approach<sp/>mostly<sp/>because<sp/>it<sp/>would<sp/>be<sp/>extra<sp/>work,<sp/>but<sp/>also<sp/>because<sp/>until<sp/>C++<sp/>standardizes<sp/>reflection,<sp/>this<sp/>would<sp/>require<sp/>either<sp/>hooking<sp/>into<sp/>compiler<sp/>APIs<sp/>like<sp/>https://github.com/RosettaCommons/binder,<sp/>or<sp/>parsing<sp/>C++<sp/>code<sp/>manually<sp/>like<sp/>http://www.swig.org/.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>What<sp/>is<sp/>`kj`?</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">KJ<sp/>is<sp/>a<sp/>concurrency<sp/>framework<sp/>[bundled<sp/>with</highlight></codeline>
<codeline><highlight class="normal">capnproto](https://capnproto.org/cxxrpc.html#kj-concurrency-framework);<sp/>it<sp/>is<sp/>used<sp/>as<sp/>a</highlight></codeline>
<codeline><highlight class="normal">basis<sp/>in<sp/>this<sp/>library<sp/>to<sp/>construct<sp/>the<sp/>event-loop<sp/>necessary<sp/>to<sp/>service<sp/>IPC<sp/>requests.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">##<sp/>Future<sp/>directions</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">_libmultiprocess_<sp/>uses<sp/>the<sp/>[Cap&apos;n<sp/>Proto](https://capnproto.org)<sp/>interface<sp/>description<sp/>language<sp/>and<sp/>protocol,<sp/>but<sp/>it<sp/>could<sp/>be<sp/>extended<sp/>or<sp/>changed<sp/>to<sp/>use<sp/>a<sp/>different<sp/>IDL/protocol<sp/>like<sp/>[gRPC](https://grpc.io).<sp/>The<sp/>nice<sp/>thing<sp/>about<sp/>_Cap&apos;n<sp/>Proto_<sp/>compared<sp/>to<sp/>_gRPC_<sp/>and<sp/>most<sp/>other<sp/>lower<sp/>level<sp/>protocols<sp/>is<sp/>that<sp/>it<sp/>allows<sp/>interface<sp/>pointers<sp/>(_Services_<sp/>in<sp/>gRPC<sp/>parlance)<sp/>to<sp/>be<sp/>passed<sp/>as<sp/>method<sp/>arguments<sp/>and<sp/>return<sp/>values,<sp/>so<sp/>object<sp/>references<sp/>and<sp/>bidirectional<sp/>requests<sp/>work<sp/>out<sp/>of<sp/>the<sp/>box.<sp/>Supporting<sp/>a<sp/>lower-level<sp/>protocol<sp/>would<sp/>require<sp/>adding<sp/>maps<sp/>and<sp/>tracking<sp/>code<sp/>to<sp/>proxy<sp/>objects.</highlight></codeline>
<codeline></codeline>
<codeline><highlight class="normal">_libmultiprocess_<sp/>is<sp/>currently<sp/>compatible<sp/>with<sp/>sandboxing<sp/>but<sp/>could<sp/>add<sp/>platform-specific<sp/>sandboxing<sp/>support<sp/>or<sp/>integration<sp/>with<sp/>a<sp/>sandboxing<sp/>library<sp/>like<sp/>[SAPI](https://github.com/google/sandboxed-api).</highlight></codeline>
    </programlisting>
    <location file="src/ipc/libmultiprocess/doc/design.md"/>
  </compounddef>
</doxygen>
