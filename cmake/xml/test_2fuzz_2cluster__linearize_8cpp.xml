<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.15.0" xml:lang="en-US">
  <compounddef id="test_2fuzz_2cluster__linearize_8cpp" kind="file" language="C++">
    <compoundname>cluster_linearize.cpp</compoundname>
    <includes local="no">cluster_linearize.h</includes>
    <includes local="no">random.h</includes>
    <includes refid="serialize_8h" local="no">serialize.h</includes>
    <includes refid="streams_8h" local="no">streams.h</includes>
    <includes refid="_fuzzed_data_provider_8h" local="no">test/fuzz/FuzzedDataProvider.h</includes>
    <includes refid="fuzz_8h" local="no">test/fuzz/fuzz.h</includes>
    <includes refid="test_2util_2cluster__linearize_8h" local="no">test/util/cluster_linearize.h</includes>
    <includes refid="bitset_8h" local="no">util/bitset.h</includes>
    <includes refid="feefrac_8h" local="no">util/feefrac.h</includes>
    <includes local="no">algorithm</includes>
    <includes local="no">cstdint</includes>
    <includes local="no">utility</includes>
    <includes local="no">vector</includes>
    <incdepgraph>
      <node id="5">
        <label>attributes.h</label>
        <link refid="attributes_8h"/>
      </node>
      <node id="6">
        <label>compat/assumptions.h</label>
        <link refid="compat_2assumptions_8h"/>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
      </node>
      <node id="10">
        <label>compat/byteswap.h</label>
        <link refid="byteswap_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
      </node>
      <node id="9">
        <label>compat/endian.h</label>
        <link refid="endian_8h"/>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
      </node>
      <node id="63">
        <label>crypto/hex_base.h</label>
        <link refid="hex__base_8h"/>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
      </node>
      <node id="32">
        <label>crypto/siphash.h</label>
        <link refid="siphash_8h"/>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
      </node>
      <node id="31">
        <label>logging.h</label>
        <link refid="logging_8h"/>
        <childnode refid="32" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
        <childnode refid="46" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="53" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="56" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
        <childnode refid="58" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="13">
        <label>prevector.h</label>
        <link refid="prevector_8h"/>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
      </node>
      <node id="4">
        <label>serialize.h</label>
        <link refid="serialize_8h"/>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="21">
        <label>span.h</label>
        <link refid="span_8h"/>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
      </node>
      <node id="30">
        <label>streams.h</label>
        <link refid="streams_8h"/>
        <childnode refid="31" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
        <childnode refid="61" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="59">
        <label>support/allocators/zeroafterfree.h</label>
        <link refid="zeroafterfree_8h"/>
        <childnode refid="60" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="60">
        <label>support/cleanse.h</label>
        <link refid="cleanse_8h"/>
        <childnode refid="16" relation="include">
        </childnode>
      </node>
      <node id="68">
        <label>test/fuzz/FuzzedDataProvider.h</label>
        <link refid="_fuzzed_data_provider_8h"/>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="69" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="1">
        <label>src/test/fuzz/cluster_linearize.cpp</label>
        <link refid="test_2fuzz_2cluster__linearize_8cpp"/>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="70" relation="include">
        </childnode>
        <childnode refid="71" relation="include">
        </childnode>
        <childnode refid="72" relation="include">
        </childnode>
        <childnode refid="73" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="70">
        <label>test/fuzz/fuzz.h</label>
        <link refid="fuzz_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
      </node>
      <node id="71">
        <label>test/util/cluster_linearize.h</label>
        <link refid="test_2util_2cluster__linearize_8h"/>
        <childnode refid="71" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="72" relation="include">
        </childnode>
        <childnode refid="73" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="75" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="34">
        <label>threadsafety.h</label>
        <link refid="threadsafety_8h"/>
        <childnode refid="35" relation="include">
        </childnode>
      </node>
      <node id="36">
        <label>tinyformat.h</label>
        <link refid="tinyformat_8h"/>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="37" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
      </node>
      <node id="72">
        <label>util/bitset.h</label>
        <link refid="bitset_8h"/>
        <childnode refid="43" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
      </node>
      <node id="43">
        <label>util/check.h</label>
        <link refid="check_8h"/>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
      </node>
      <node id="73">
        <label>util/feefrac.h</label>
        <link refid="feefrac_8h"/>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
        <childnode refid="74" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="46">
        <label>util/fs.h</label>
        <link refid="fs_8h"/>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="51" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="52" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
      </node>
      <node id="61">
        <label>util/obfuscation.h</label>
        <link refid="obfuscation_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="62" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
      </node>
      <node id="66">
        <label>util/overflow.h</label>
        <link refid="overflow_8h"/>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
      </node>
      <node id="62">
        <label>util/strencodings.h</label>
        <link refid="strencodings_8h"/>
        <childnode refid="63" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="64" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="52" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="40">
        <label>util/string.h</label>
        <link refid="string_8h"/>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="67">
        <label>util/syserror.h</label>
        <link refid="syserror_8h"/>
        <childnode refid="28" relation="include">
        </childnode>
      </node>
      <node id="53">
        <label>util/time.h</label>
        <link refid="util_2time_8h"/>
        <childnode refid="54" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
      </node>
      <node id="14">
        <label>algorithm</label>
      </node>
      <node id="33">
        <label>array</label>
      </node>
      <node id="44">
        <label>atomic</label>
      </node>
      <node id="12">
        <label>bit</label>
      </node>
      <node id="15">
        <label>cassert</label>
      </node>
      <node id="64">
        <label>charconv</label>
      </node>
      <node id="54">
        <label>chrono</label>
      </node>
      <node id="65">
        <label>climits</label>
      </node>
      <node id="2">
        <label>cluster_linearize.h</label>
      </node>
      <node id="74">
        <label>compare</label>
      </node>
      <node id="23">
        <label>concepts</label>
      </node>
      <node id="7">
        <label>cstddef</label>
      </node>
      <node id="11">
        <label>cstdint</label>
      </node>
      <node id="47">
        <label>cstdio</label>
      </node>
      <node id="16">
        <label>cstdlib</label>
      </node>
      <node id="17">
        <label>cstring</label>
      </node>
      <node id="48">
        <label>filesystem</label>
      </node>
      <node id="49">
        <label>functional</label>
      </node>
      <node id="69">
        <label>initializer_list</label>
      </node>
      <node id="50">
        <label>iomanip</label>
      </node>
      <node id="24">
        <label>ios</label>
      </node>
      <node id="37">
        <label>iostream</label>
      </node>
      <node id="18">
        <label>iterator</label>
      </node>
      <node id="8">
        <label>limits</label>
      </node>
      <node id="56">
        <label>list</label>
      </node>
      <node id="41">
        <label>locale</label>
      </node>
      <node id="25">
        <label>map</label>
      </node>
      <node id="26">
        <label>memory</label>
      </node>
      <node id="35">
        <label>mutex</label>
      </node>
      <node id="75">
        <label>numeric</label>
      </node>
      <node id="55">
        <label>optional</label>
      </node>
      <node id="51">
        <label>ostream</label>
      </node>
      <node id="3">
        <label>random.h</label>
      </node>
      <node id="27">
        <label>set</label>
      </node>
      <node id="45">
        <label>source_location</label>
      </node>
      <node id="22">
        <label>span</label>
      </node>
      <node id="38">
        <label>sstream</label>
      </node>
      <node id="39">
        <label>stdexcept</label>
      </node>
      <node id="28">
        <label>string</label>
      </node>
      <node id="42">
        <label>string_view</label>
      </node>
      <node id="52">
        <label>system_error</label>
      </node>
      <node id="19">
        <label>type_traits</label>
      </node>
      <node id="57">
        <label>unordered_map</label>
      </node>
      <node id="58">
        <label>unordered_set</label>
      </node>
      <node id="20">
        <label>utility</label>
      </node>
      <node id="29">
        <label>vector</label>
      </node>
    </incdepgraph>
    <sectiondef kind="var">
      <memberdef kind="variable" id="test_2fuzz_2cluster__linearize_8cpp_1aba7b33b537908f3fe5b038742c8042ae" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto MAX_SIMPLE_ITERATIONS</definition>
        <argsstring></argsstring>
        <name>MAX_SIMPLE_ITERATIONS</name>
        <initializer>= 300000</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/test/fuzz/cluster_linearize.cpp" line="766" column="23" bodyfile="src/test/fuzz/cluster_linearize.cpp" bodystart="766" bodyend="-1"/>
      </memberdef>
    </sectiondef>
    <sectiondef kind="func">
      <memberdef kind="function" id="test_2fuzz_2cluster__linearize_8cpp_1a2582722c1ccf3bec79c4d155a567e0de" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>FUZZ_TARGET</definition>
        <argsstring>(clusterlin_depgraph_sim)</argsstring>
        <name>FUZZ_TARGET</name>
        <param>
          <type>clusterlin_depgraph_sim</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
<para>Real DepGraph being tested.</para>
<para>Simulated DepGraph (sim[i] is std::nullopt if position i does not exist; otherwise, sim[i]-&gt;first is its individual feerate, and sim[i]-&gt;second is its set of ancestors.</para>
<para>The number of non-nullopt position in sim.</para>
<para>Read a valid index of a transaction from the provider.</para>
<para>Read a valid subset of the transactions from the provider.</para>
<para>Read any set of transactions from the provider (including unused positions).</para>
<para>Propagate ancestor information in sim.</para>
<para>Compare the state of transaction i in the simulation with the real one.</para>
        </inbodydescription>
        <location file="src/test/fuzz/cluster_linearize.cpp" line="402" column="1" bodyfile="src/test/fuzz/cluster_linearize.cpp" bodystart="402" bodyend="562"/>
      </memberdef>
      <memberdef kind="function" id="test_2fuzz_2cluster__linearize_8cpp_1a3f577ef7b84e675cbe062c63551a803b" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>FUZZ_TARGET</definition>
        <argsstring>(clusterlin_depgraph_serialization)</argsstring>
        <name>FUZZ_TARGET</name>
        <param>
          <type>clusterlin_depgraph_serialization</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/test/fuzz/cluster_linearize.cpp" line="564" column="1" bodyfile="src/test/fuzz/cluster_linearize.cpp" bodystart="564" bodyend="607"/>
      </memberdef>
      <memberdef kind="function" id="test_2fuzz_2cluster__linearize_8cpp_1a692ebd5005e0c91eb44f1896a4fa866f" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>FUZZ_TARGET</definition>
        <argsstring>(clusterlin_components)</argsstring>
        <name>FUZZ_TARGET</name>
        <param>
          <type>clusterlin_components</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/test/fuzz/cluster_linearize.cpp" line="609" column="1" bodyfile="src/test/fuzz/cluster_linearize.cpp" bodystart="609" bodyend="699"/>
      </memberdef>
      <memberdef kind="function" id="test_2fuzz_2cluster__linearize_8cpp_1a10d0e4847ae5f9c1a024c1e3f3383b2f" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>FUZZ_TARGET</definition>
        <argsstring>(clusterlin_make_connected)</argsstring>
        <name>FUZZ_TARGET</name>
        <param>
          <type>clusterlin_make_connected</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/test/fuzz/cluster_linearize.cpp" line="701" column="1" bodyfile="src/test/fuzz/cluster_linearize.cpp" bodystart="701" bodyend="713"/>
      </memberdef>
      <memberdef kind="function" id="test_2fuzz_2cluster__linearize_8cpp_1ab799774fda8f673fa7ea1d601447b02c" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>FUZZ_TARGET</definition>
        <argsstring>(clusterlin_chunking)</argsstring>
        <name>FUZZ_TARGET</name>
        <param>
          <type>clusterlin_chunking</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/test/fuzz/cluster_linearize.cpp" line="715" column="1" bodyfile="src/test/fuzz/cluster_linearize.cpp" bodystart="715" bodyend="764"/>
      </memberdef>
      <memberdef kind="function" id="test_2fuzz_2cluster__linearize_8cpp_1a05ca1cc577f19f3c2164620b8211f63e" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>FUZZ_TARGET</definition>
        <argsstring>(clusterlin_simple_finder)</argsstring>
        <name>FUZZ_TARGET</name>
        <param>
          <type>clusterlin_simple_finder</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/test/fuzz/cluster_linearize.cpp" line="768" column="1" bodyfile="src/test/fuzz/cluster_linearize.cpp" bodystart="768" bodyend="844"/>
      </memberdef>
      <memberdef kind="function" id="test_2fuzz_2cluster__linearize_8cpp_1aa280e281b43c551485ad38d97a6c3f25" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>FUZZ_TARGET</definition>
        <argsstring>(clusterlin_simple_linearize)</argsstring>
        <name>FUZZ_TARGET</name>
        <param>
          <type>clusterlin_simple_linearize</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/test/fuzz/cluster_linearize.cpp" line="846" column="1" bodyfile="src/test/fuzz/cluster_linearize.cpp" bodystart="846" bodyend="891"/>
      </memberdef>
      <memberdef kind="function" id="test_2fuzz_2cluster__linearize_8cpp_1a0c32bb84e4b8c9a561c216c18aa77f1b" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>FUZZ_TARGET</definition>
        <argsstring>(clusterlin_sfl)</argsstring>
        <name>FUZZ_TARGET</name>
        <param>
          <type>clusterlin_sfl</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
<para>Whether to make the depgraph connected.</para>
<para>Whether to load some input linearization into the state.</para>
<para>Whether that input linearization is topological.</para>
        </inbodydescription>
        <location file="src/test/fuzz/cluster_linearize.cpp" line="893" column="1" bodyfile="src/test/fuzz/cluster_linearize.cpp" bodystart="893" bodyend="989"/>
      </memberdef>
      <memberdef kind="function" id="test_2fuzz_2cluster__linearize_8cpp_1af70e927669284fcae1fd656756a536b6" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>FUZZ_TARGET</definition>
        <argsstring>(clusterlin_linearize)</argsstring>
        <name>FUZZ_TARGET</name>
        <param>
          <type>clusterlin_linearize</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/test/fuzz/cluster_linearize.cpp" line="991" column="1" bodyfile="src/test/fuzz/cluster_linearize.cpp" bodystart="991" bodyend="1065"/>
      </memberdef>
      <memberdef kind="function" id="test_2fuzz_2cluster__linearize_8cpp_1a77cb94847c35267b64408375241ad1e6" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>FUZZ_TARGET</definition>
        <argsstring>(clusterlin_postlinearize)</argsstring>
        <name>FUZZ_TARGET</name>
        <param>
          <type>clusterlin_postlinearize</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/test/fuzz/cluster_linearize.cpp" line="1067" column="1" bodyfile="src/test/fuzz/cluster_linearize.cpp" bodystart="1067" bodyend="1107"/>
      </memberdef>
      <memberdef kind="function" id="test_2fuzz_2cluster__linearize_8cpp_1a1dabd70fa18bbee66f1ec64981df03e6" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>FUZZ_TARGET</definition>
        <argsstring>(clusterlin_postlinearize_tree)</argsstring>
        <name>FUZZ_TARGET</name>
        <param>
          <type>clusterlin_postlinearize_tree</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/test/fuzz/cluster_linearize.cpp" line="1109" column="1" bodyfile="src/test/fuzz/cluster_linearize.cpp" bodystart="1109" bodyend="1156"/>
      </memberdef>
      <memberdef kind="function" id="test_2fuzz_2cluster__linearize_8cpp_1a95f21174477c28583fa151bf0c1a3bc4" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>FUZZ_TARGET</definition>
        <argsstring>(clusterlin_postlinearize_moved_leaf)</argsstring>
        <name>FUZZ_TARGET</name>
        <param>
          <type>clusterlin_postlinearize_moved_leaf</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/test/fuzz/cluster_linearize.cpp" line="1158" column="1" bodyfile="src/test/fuzz/cluster_linearize.cpp" bodystart="1158" bodyend="1199"/>
      </memberdef>
      <memberdef kind="function" id="test_2fuzz_2cluster__linearize_8cpp_1a196af49a47ccb77b1e99db8adcdace9f" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>FUZZ_TARGET</definition>
        <argsstring>(clusterlin_fix_linearization)</argsstring>
        <name>FUZZ_TARGET</name>
        <param>
          <type>clusterlin_fix_linearization</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/test/fuzz/cluster_linearize.cpp" line="1201" column="1" bodyfile="src/test/fuzz/cluster_linearize.cpp" bodystart="1201" bodyend="1242"/>
      </memberdef>
    </sectiondef>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="comment">//<sp/>Copyright<sp/>(c)<sp/>The<sp/>Bitcoin<sp/>Core<sp/>developers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Distributed<sp/>under<sp/>the<sp/>MIT<sp/>software<sp/>license,<sp/>see<sp/>the<sp/>accompanying</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3"><highlight class="normal"></highlight><highlight class="comment">//<sp/>file<sp/>COPYING<sp/>or<sp/>http://www.opensource.org/licenses/mit-license.php.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4"><highlight class="normal"></highlight></codeline>
<codeline lineno="5"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="test_2util_2cluster__linearize_8h" kindref="compound">cluster_linearize.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;random.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="serialize_8h" kindref="compound">serialize.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="streams_8h" kindref="compound">streams.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="_fuzzed_data_provider_8h" kindref="compound">test/fuzz/FuzzedDataProvider.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="fuzz_8h" kindref="compound">test/fuzz/fuzz.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="test_2util_2cluster__linearize_8h" kindref="compound">test/util/cluster_linearize.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="bitset_8h" kindref="compound">util/bitset.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="13"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="feefrac_8h" kindref="compound">util/feefrac.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="14"><highlight class="normal"></highlight></codeline>
<codeline lineno="15"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;algorithm&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="16"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;cstdint&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="17"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;utility&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="18"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;vector&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="19"><highlight class="normal"></highlight></codeline>
<codeline lineno="20"><highlight class="normal"></highlight><highlight class="comment">/*</highlight></codeline>
<codeline lineno="21"><highlight class="comment"><sp/>*<sp/>The<sp/>tests<sp/>in<sp/>this<sp/>file<sp/>primarily<sp/>cover<sp/>the<sp/>candidate<sp/>finder<sp/>classes<sp/>and<sp/>linearization<sp/>algorithms.</highlight></codeline>
<codeline lineno="22"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="23"><highlight class="comment"><sp/>*<sp/><sp/><sp/>&lt;----:<sp/>An<sp/>implementation<sp/>(at<sp/>the<sp/>start<sp/>of<sp/>the<sp/>line<sp/>--)<sp/>is<sp/>tested<sp/>in<sp/>the<sp/>test<sp/>marked<sp/>with<sp/>*,</highlight></codeline>
<codeline lineno="24"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>possibly<sp/>by<sp/>comparison<sp/>with<sp/>other<sp/>implementations<sp/>(at<sp/>the<sp/>end<sp/>of<sp/>the<sp/>line<sp/>-&gt;).</highlight></codeline>
<codeline lineno="25"><highlight class="comment"><sp/>*<sp/><sp/><sp/>&lt;&lt;---:<sp/>The<sp/>right<sp/>side<sp/>is<sp/>implemented<sp/>using<sp/>the<sp/>left<sp/>side.</highlight></codeline>
<codeline lineno="26"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="27"><highlight class="comment"><sp/>*<sp/><sp/><sp/>+---------------------+<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>+-----------+</highlight></codeline>
<codeline lineno="28"><highlight class="comment"><sp/>*<sp/><sp/><sp/>|<sp/>SpanningForestState<sp/>|<sp/>&lt;&lt;--------------------<sp/>|<sp/>Linearize<sp/>|</highlight></codeline>
<codeline lineno="29"><highlight class="comment"><sp/>*<sp/><sp/><sp/>+---------------------+<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>+-----------+</highlight></codeline>
<codeline lineno="30"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>|<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>|</highlight></codeline>
<codeline lineno="31"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>|<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>|<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>^^<sp/><sp/>PRODUCTION<sp/>CODE</highlight></codeline>
<codeline lineno="32"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>|<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>|<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>||</highlight></codeline>
<codeline lineno="33"><highlight class="comment"><sp/>*<sp/><sp/>==============================================================================================</highlight></codeline>
<codeline lineno="34"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>|<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>|<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>||</highlight></codeline>
<codeline lineno="35"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>|-clusterlin_sfl*<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>|<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vv<sp/><sp/>TEST<sp/>CODE</highlight></codeline>
<codeline lineno="36"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>|<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>|</highlight></codeline>
<codeline lineno="37"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>\------------------------------------\<sp/><sp/>|-clusterlin_linearize*</highlight></codeline>
<codeline lineno="38"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>|<sp/><sp/>|</highlight></codeline>
<codeline lineno="39"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>v<sp/><sp/>v</highlight></codeline>
<codeline lineno="40"><highlight class="comment"><sp/>*<sp/><sp/><sp/>+-----------------------+<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>+-----------------+</highlight></codeline>
<codeline lineno="41"><highlight class="comment"><sp/>*<sp/><sp/><sp/>|<sp/>SimpleCandidateFinder<sp/>|<sp/>&lt;&lt;-------------------|<sp/>SimpleLinearize<sp/>|</highlight></codeline>
<codeline lineno="42"><highlight class="comment"><sp/>*<sp/><sp/><sp/>+-----------------------+<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>+-----------------+</highlight></codeline>
<codeline lineno="43"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>|<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>|</highlight></codeline>
<codeline lineno="44"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>|-clusterlin_simple_finder*<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>|-clusterlin_simple_linearize*</highlight></codeline>
<codeline lineno="45"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>v<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>v</highlight></codeline>
<codeline lineno="46"><highlight class="comment"><sp/>*<sp/><sp/><sp/>+---------------------------+<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>+---------------------+</highlight></codeline>
<codeline lineno="47"><highlight class="comment"><sp/>*<sp/><sp/><sp/>|<sp/>ExhaustiveCandidateFinder<sp/>|<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>|<sp/>ExhaustiveLinearize<sp/>|</highlight></codeline>
<codeline lineno="48"><highlight class="comment"><sp/>*<sp/><sp/><sp/>+---------------------------+<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>+---------------------+</highlight></codeline>
<codeline lineno="49"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="50"><highlight class="comment"><sp/>*<sp/>More<sp/>tests<sp/>are<sp/>included<sp/>for<sp/>lower-level<sp/>and<sp/>related<sp/>functions<sp/>and<sp/>classes:</highlight></codeline>
<codeline lineno="51"><highlight class="comment"><sp/>*<sp/>-<sp/>DepGraph<sp/>tests:</highlight></codeline>
<codeline lineno="52"><highlight class="comment"><sp/>*<sp/><sp/><sp/>-<sp/>clusterlin_depgraph_sim</highlight></codeline>
<codeline lineno="53"><highlight class="comment"><sp/>*<sp/><sp/><sp/>-<sp/>clusterlin_depgraph_serialization</highlight></codeline>
<codeline lineno="54"><highlight class="comment"><sp/>*<sp/><sp/><sp/>-<sp/>clusterlin_components</highlight></codeline>
<codeline lineno="55"><highlight class="comment"><sp/>*<sp/>-<sp/>ChunkLinearization<sp/>and<sp/>ChunkLinearizationInfo<sp/>tests:</highlight></codeline>
<codeline lineno="56"><highlight class="comment"><sp/>*<sp/><sp/><sp/>-<sp/>clusterlin_chunking</highlight></codeline>
<codeline lineno="57"><highlight class="comment"><sp/>*<sp/>-<sp/>PostLinearize<sp/>tests:</highlight></codeline>
<codeline lineno="58"><highlight class="comment"><sp/>*<sp/><sp/><sp/>-<sp/>clusterlin_postlinearize</highlight></codeline>
<codeline lineno="59"><highlight class="comment"><sp/>*<sp/><sp/><sp/>-<sp/>clusterlin_postlinearize_tree</highlight></codeline>
<codeline lineno="60"><highlight class="comment"><sp/>*<sp/><sp/><sp/>-<sp/>clusterlin_postlinearize_moved_leaf</highlight></codeline>
<codeline lineno="61"><highlight class="comment"><sp/>*<sp/>-<sp/>FixLinearization<sp/>tests:</highlight></codeline>
<codeline lineno="62"><highlight class="comment"><sp/>*<sp/><sp/><sp/>-<sp/>clusterlin_fix_linearization</highlight></codeline>
<codeline lineno="63"><highlight class="comment"><sp/>*<sp/>-<sp/>MakeConnected<sp/>tests<sp/>(a<sp/>test-only<sp/>function):</highlight></codeline>
<codeline lineno="64"><highlight class="comment"><sp/>*<sp/><sp/><sp/>-<sp/>clusterlin_make_connected</highlight></codeline>
<codeline lineno="65"><highlight class="comment"><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="66"><highlight class="normal"></highlight></codeline>
<codeline lineno="67"><highlight class="normal"></highlight><highlight class="keyword">using<sp/>namespace<sp/></highlight><highlight class="normal"><ref refid="namespacecluster__linearize" kindref="compound">cluster_linearize</ref>;</highlight></codeline>
<codeline lineno="68"><highlight class="normal"></highlight></codeline>
<codeline lineno="69"><highlight class="normal"></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="70"><highlight class="normal"></highlight></codeline>
<codeline lineno="73"><highlight class="normal"></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">typename</highlight><highlight class="normal"><sp/>SetType&gt;</highlight></codeline>
<codeline lineno="74"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal">SimpleCandidateFinder</highlight></codeline>
<codeline lineno="75"><highlight class="normal">{</highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>DepGraph&lt;SetType&gt;&amp;<sp/>m_depgraph;</highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><sp/><sp/>SetType<sp/>m_todo;</highlight></codeline>
<codeline lineno="80"><highlight class="normal"></highlight></codeline>
<codeline lineno="81"><highlight class="normal"></highlight><highlight class="keyword">public</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/><sp/><sp/>SimpleCandidateFinder(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>DepGraph&lt;SetType&gt;&amp;<sp/>depgraph<sp/><ref refid="attributes_8h_1a37bc3dacb49779a0d18439d4383e5fd9" kindref="member">LIFETIMEBOUND</ref>)<sp/>noexcept<sp/>:</highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_depgraph(depgraph),<sp/>m_todo{depgraph.Positions()}<sp/>{}</highlight></codeline>
<codeline lineno="85"><highlight class="normal"></highlight></codeline>
<codeline lineno="87"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>MarkDone(SetType<sp/>select)<sp/></highlight><highlight class="keyword">noexcept</highlight><highlight class="normal"><sp/>{<sp/>m_todo<sp/>-=<sp/>select;<sp/>}</highlight></codeline>
<codeline lineno="88"><highlight class="normal"></highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>AllDone()<sp/>const<sp/>noexcept<sp/>{<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>m_todo.None();<sp/>}</highlight></codeline>
<codeline lineno="91"><highlight class="normal"></highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/><sp/><sp/>std::pair&lt;SetInfo&lt;SetType&gt;,<sp/>uint64_t&gt;<sp/>FindCandidateSet(uint64_t<sp/>max_iterations)<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">noexcept</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>iterations_left<sp/>=<sp/>max_iterations;</highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Queue<sp/>of<sp/>work<sp/>units.<sp/>Each<sp/>consists<sp/>of:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>inc:<sp/>set<sp/>of<sp/>transactions<sp/>definitely<sp/>included</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>und:<sp/>set<sp/>of<sp/>transactions<sp/>that<sp/>can<sp/>be<sp/>added<sp/>to<sp/>inc<sp/>still</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;std::pair&lt;SetType,<sp/>SetType&gt;&gt;<sp/>queue;</highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Initially<sp/>we<sp/>have<sp/>just<sp/>one<sp/>queue<sp/>element,<sp/>with<sp/>the<sp/>entire<sp/>graph<sp/>in<sp/>und.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>queue.emplace_back(SetType{},<sp/>m_todo);</highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Best<sp/>solution<sp/>so<sp/>far.<sp/>Initialize<sp/>with<sp/>the<sp/>remaining<sp/>ancestors<sp/>of<sp/>the<sp/>first<sp/>remaining</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transaction.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SetInfo<sp/>best(m_depgraph,<sp/>m_depgraph.Ancestors(m_todo.First())<sp/>&amp;<sp/>m_todo);</highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Process<sp/>the<sp/>queue.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(!queue.empty()<sp/>&amp;&amp;<sp/>iterations_left)<sp/>{</highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Pop<sp/>top<sp/>element<sp/>of<sp/>the<sp/>queue.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>[inc,<sp/>und]<sp/>=<sp/>queue.back();</highlight></codeline>
<codeline lineno="116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>queue.pop_back();</highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Look<sp/>for<sp/>a<sp/>transaction<sp/>to<sp/>consider<sp/>adding/removing.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>inc_none<sp/>=<sp/>inc.None();</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>split<sp/>:<sp/>und)<sp/>{</highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>inc<sp/>is<sp/>empty,<sp/>consider<sp/>any<sp/>split<sp/>transaction.<sp/>Otherwise<sp/>only<sp/>consider</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transactions<sp/>that<sp/>share<sp/>ancestry<sp/>with<sp/>inc<sp/>so<sp/>far<sp/>(which<sp/>means<sp/>only<sp/>connected</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>sets<sp/>will<sp/>be<sp/>considered).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(inc_none<sp/>||<sp/>inc.Overlaps(m_depgraph.Ancestors(split)))<sp/>{</highlight></codeline>
<codeline lineno="124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--iterations_left;</highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Add<sp/>a<sp/>queue<sp/>entry<sp/>with<sp/>split<sp/>included.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SetInfo<sp/>new_inc(m_depgraph,<sp/>inc<sp/>|<sp/>(m_todo<sp/>&amp;<sp/>m_depgraph.Ancestors(split)));</highlight></codeline>
<codeline lineno="127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>queue.emplace_back(new_inc.transactions,<sp/>und<sp/>-<sp/>new_inc.transactions);</highlight></codeline>
<codeline lineno="128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Add<sp/>a<sp/>queue<sp/>entry<sp/>with<sp/>split<sp/>excluded.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>queue.emplace_back(inc,<sp/>und<sp/>-<sp/>m_depgraph.Descendants(split));</highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Update<sp/>statistics<sp/>to<sp/>account<sp/>for<sp/>the<sp/>candidate<sp/>new_inc.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(new_inc.feerate<sp/>&gt;<sp/>best.feerate)<sp/>best<sp/>=<sp/>new_inc;</highlight></codeline>
<codeline lineno="132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{std::move(best),<sp/>max_iterations<sp/>-<sp/>iterations_left};</highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="138"><highlight class="normal">};</highlight></codeline>
<codeline lineno="139"><highlight class="normal"></highlight></codeline>
<codeline lineno="146"><highlight class="normal"></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">typename</highlight><highlight class="normal"><sp/>SetType&gt;</highlight></codeline>
<codeline lineno="147"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal">ExhaustiveCandidateFinder</highlight></codeline>
<codeline lineno="148"><highlight class="normal">{</highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>DepGraph&lt;SetType&gt;&amp;<sp/>m_depgraph;</highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/><sp/><sp/>SetType<sp/>m_todo;</highlight></codeline>
<codeline lineno="153"><highlight class="normal"></highlight></codeline>
<codeline lineno="154"><highlight class="normal"></highlight><highlight class="keyword">public</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/><sp/><sp/>ExhaustiveCandidateFinder(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>DepGraph&lt;SetType&gt;&amp;<sp/>depgraph<sp/><ref refid="attributes_8h_1a37bc3dacb49779a0d18439d4383e5fd9" kindref="member">LIFETIMEBOUND</ref>)<sp/>noexcept<sp/>:</highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_depgraph(depgraph),<sp/>m_todo{depgraph.Positions()}<sp/>{}</highlight></codeline>
<codeline lineno="158"><highlight class="normal"></highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>MarkDone(SetType<sp/>select)<sp/></highlight><highlight class="keyword">noexcept</highlight><highlight class="normal"><sp/>{<sp/>m_todo<sp/>-=<sp/>select;<sp/>}</highlight></codeline>
<codeline lineno="161"><highlight class="normal"></highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>AllDone()<sp/>const<sp/>noexcept<sp/>{<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>m_todo.None();<sp/>}</highlight></codeline>
<codeline lineno="164"><highlight class="normal"></highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/><sp/><sp/>SetInfo&lt;SetType&gt;<sp/>FindCandidateSet()<sp/>const<sp/>noexcept</highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Best<sp/>solution<sp/>so<sp/>far.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="172"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SetInfo&lt;SetType&gt;<sp/>best{m_todo,<sp/>m_depgraph.FeeRate(m_todo)};</highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>number<sp/>of<sp/>combinations<sp/>to<sp/>try.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="174"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>limit<sp/>=<sp/>(uint64_t{1}<sp/>&lt;&lt;<sp/>m_todo.Count())<sp/>-<sp/>1;</highlight></codeline>
<codeline lineno="175"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Try<sp/>the<sp/>transitive<sp/>closure<sp/>of<sp/>every<sp/>non-empty<sp/>subset<sp/>of<sp/>m_todo.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(uint64_t<sp/>x<sp/>=<sp/>1;<sp/>x<sp/>&lt;<sp/>limit;<sp/>++x)<sp/>{</highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>bit<sp/>number<sp/>b<sp/>is<sp/>set<sp/>in<sp/>x,<sp/>then<sp/>the<sp/>remaining<sp/>ancestors<sp/>of<sp/>the<sp/>b&apos;th<sp/>remaining</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transaction<sp/>in<sp/>m_todo<sp/>are<sp/>included.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="179"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SetType<sp/>txn;</highlight></codeline>
<codeline lineno="180"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>x_shifted{x};</highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>i<sp/>:<sp/>m_todo)<sp/>{</highlight></codeline>
<codeline lineno="182"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(x_shifted<sp/>&amp;<sp/>1)<sp/>txn<sp/>|=<sp/>m_depgraph.Ancestors(i);</highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>x_shifted<sp/>&gt;&gt;=<sp/>1;</highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SetInfo<sp/>cur(m_depgraph,<sp/>txn<sp/>&amp;<sp/>m_todo);</highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cur.feerate<sp/>&gt;<sp/>best.<ref refid="structcluster__linearize_1_1_set_info_1a1d8fb318f45e11d349ee4ea1c7019abe" kindref="member">feerate</ref>)<sp/>best<sp/>=<sp/>cur;</highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>best;</highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="190"><highlight class="normal">};</highlight></codeline>
<codeline lineno="191"><highlight class="normal"></highlight></codeline>
<codeline lineno="198"><highlight class="normal"></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">typename</highlight><highlight class="normal"><sp/>SetType&gt;</highlight></codeline>
<codeline lineno="199"><highlight class="normal">std::pair&lt;std::vector&lt;DepGraphIndex&gt;,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal">&gt;<sp/>SimpleLinearize(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;SetType&gt;</ref>&amp;<sp/>depgraph,<sp/>uint64_t<sp/>max_iterations)</highlight></codeline>
<codeline lineno="200"><highlight class="normal">{</highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;DepGraphIndex&gt;<sp/>linearization;</highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/><sp/><sp/>SimpleCandidateFinder<sp/>finder(depgraph);</highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/><sp/><sp/>SetType<sp/>todo<sp/>=<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a700dd1176f1aa1e6f3b2202fc0377dbe" kindref="member">Positions</ref>();</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>optimal<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(todo.Any())<sp/>{</highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>[candidate,<sp/>iterations_done]<sp/>=<sp/>finder.FindCandidateSet(max_iterations);</highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(iterations_done<sp/>==<sp/>max_iterations)<sp/>optimal<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1aa2ca195ccdca805f5ae56e7dc53beee8" kindref="member">AppendTopo</ref>(linearization,<sp/>candidate.transactions);</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>todo<sp/>-=<sp/>candidate.transactions;</highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>finder.MarkDone(candidate.transactions);</highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_iterations<sp/>-=<sp/>iterations_done;</highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{std::move(linearization),<sp/>optimal};</highlight></codeline>
<codeline lineno="214"><highlight class="normal">}</highlight></codeline>
<codeline lineno="215"><highlight class="normal"></highlight></codeline>
<codeline lineno="223"><highlight class="normal"></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">typename</highlight><highlight class="normal"><sp/>SetType&gt;</highlight></codeline>
<codeline lineno="224"><highlight class="normal">std::vector&lt;DepGraphIndex&gt;<sp/>ExhaustiveLinearize(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;SetType&gt;</ref>&amp;<sp/>depgraph)</highlight></codeline>
<codeline lineno="225"><highlight class="normal">{</highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>best<sp/>linearization<sp/>so<sp/>far,<sp/>and<sp/>its<sp/>chunking.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;DepGraphIndex&gt;<sp/>linearization;</highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;FeeFrac&gt;<sp/>chunking;</highlight></codeline>
<codeline lineno="229"><highlight class="normal"></highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;DepGraphIndex&gt;<sp/>perm_linearization;</highlight></codeline>
<codeline lineno="231"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Initialize<sp/>with<sp/>the<sp/>lexicographically-first<sp/>linearization.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="232"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(<ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>i<sp/>:<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a700dd1176f1aa1e6f3b2202fc0377dbe" kindref="member">Positions</ref>())<sp/>perm_linearization.push_back(i);</highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Iterate<sp/>over<sp/>all<sp/>valid<sp/>permutations.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">do</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>topo_length{0};</highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>TestBitSet<sp/>perm_done;</highlight></codeline>
<codeline lineno="238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(topo_length<sp/>&lt;<sp/>perm_linearization.size())<sp/>{</highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>perm_linearization[topo_length];</highlight></codeline>
<codeline lineno="240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>perm_done.Set(i);</highlight></codeline>
<codeline lineno="241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1afc3ed1d0c57b777822863b057012f993" kindref="member">Ancestors</ref>(i).IsSubsetOf(perm_done))<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++topo_length;</highlight></codeline>
<codeline lineno="243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="244"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(topo_length<sp/>==<sp/>perm_linearization.size())<sp/>{</highlight></codeline>
<codeline lineno="245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>all<sp/>of<sp/>perm_linearization<sp/>is<sp/>topological,<sp/>check<sp/>if<sp/>it<sp/>is<sp/>perhaps<sp/>our<sp/>best</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>linearization<sp/>so<sp/>far.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>perm_chunking<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph,<sp/>perm_linearization);</highlight></codeline>
<codeline lineno="248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>cmp<sp/>=<sp/><ref refid="util_2feefrac_8cpp_1ac6b51471a8ec142402968632e02bbfe5" kindref="member">CompareChunks</ref>(perm_chunking,<sp/>chunking);</highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>diagram<sp/>is<sp/>better,<sp/>or<sp/>if<sp/>it<sp/>is<sp/>equal<sp/>but<sp/>with<sp/>more<sp/>chunks<sp/>(because<sp/>we</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>prefer<sp/>minimal<sp/>chunks),<sp/>consider<sp/>this<sp/>better.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(linearization.empty()<sp/>||<sp/>cmp<sp/>&gt;<sp/>0<sp/>||<sp/>(cmp<sp/>==<sp/>0<sp/>&amp;&amp;<sp/>perm_chunking.size()<sp/>&gt;<sp/>chunking.size()))<sp/>{</highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>linearization<sp/>=<sp/>perm_linearization;</highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>chunking<sp/>=<sp/>perm_chunking;</highlight></codeline>
<codeline lineno="254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Otherwise,<sp/>fast<sp/>forward<sp/>to<sp/>the<sp/>last<sp/>permutation<sp/>with<sp/>the<sp/>same<sp/>non-topological</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>prefix.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>first_non_topo<sp/>=<sp/>perm_linearization.begin()<sp/>+<sp/>topo_length;</highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(std::is_sorted(first_non_topo<sp/>+<sp/>1,<sp/>perm_linearization.end()));</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::reverse(first_non_topo<sp/>+<sp/>1,<sp/>perm_linearization.end());</highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal">(std::next_permutation(perm_linearization.begin(),<sp/>perm_linearization.end()));</highlight></codeline>
<codeline lineno="263"><highlight class="normal"></highlight></codeline>
<codeline lineno="264"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>linearization;</highlight></codeline>
<codeline lineno="265"><highlight class="normal">}</highlight></codeline>
<codeline lineno="266"><highlight class="normal"></highlight></codeline>
<codeline lineno="267"><highlight class="normal"></highlight></codeline>
<codeline lineno="269"><highlight class="normal"></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">typename</highlight><highlight class="normal"><sp/>BS&gt;</highlight></codeline>
<codeline lineno="270"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>MakeConnected(<ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;BS&gt;</ref>&amp;<sp/>depgraph)</highlight></codeline>
<codeline lineno="271"><highlight class="normal">{</highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>todo<sp/>=<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a700dd1176f1aa1e6f3b2202fc0377dbe" kindref="member">Positions</ref>();</highlight></codeline>
<codeline lineno="273"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>comp<sp/>=<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1ac5fbeb4ad21962416c511bd250f53730" kindref="member">FindConnectedComponent</ref>(todo);</highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1aecc46909fd08c461aeab4cd0807509d1" kindref="member">IsConnected</ref>(comp));</highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/>todo<sp/>-=<sp/>comp;</highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(todo.Any())<sp/>{</highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>nextcomp<sp/>=<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1ac5fbeb4ad21962416c511bd250f53730" kindref="member">FindConnectedComponent</ref>(todo);</highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1aecc46909fd08c461aeab4cd0807509d1" kindref="member">IsConnected</ref>(nextcomp));</highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1aba3e34d0a7b3d68b385fa80cbea06495" kindref="member">AddDependencies</ref>(BS::Singleton(comp.Last()),<sp/>nextcomp.First());</highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>todo<sp/>-=<sp/>nextcomp;</highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>comp<sp/>=<sp/>nextcomp;</highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="283"><highlight class="normal">}</highlight></codeline>
<codeline lineno="284"><highlight class="normal"></highlight></codeline>
<codeline lineno="286"><highlight class="normal"></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">typename</highlight><highlight class="normal"><sp/>SetType&gt;</highlight></codeline>
<codeline lineno="287"><highlight class="normal">SetType<sp/>ReadTopologicalSet(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;SetType&gt;</ref>&amp;<sp/>depgraph,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SetType&amp;<sp/>todo,<sp/><ref refid="class_span_reader" kindref="compound">SpanReader</ref>&amp;<sp/>reader,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>non_empty)</highlight></codeline>
<codeline lineno="288"><highlight class="normal">{</highlight></codeline>
<codeline lineno="289"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Read<sp/>a<sp/>bitmask<sp/>from<sp/>the<sp/>fuzzing<sp/>input.<sp/>Add<sp/>1<sp/>if<sp/>non_empty,<sp/>so<sp/>the<sp/>mask<sp/>is<sp/>definitely<sp/>not</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>zero<sp/>in<sp/>that<sp/>case.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/>uint64_t<sp/>mask{0};</highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reader<sp/>&gt;&gt;<sp/><ref refid="serialize_8h_1a1383f2a4c22ffaeba9b2924d90459f76" kindref="member">VARINT</ref>(mask);</highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal">(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::ios_base::failure&amp;)<sp/>{}</highlight></codeline>
<codeline lineno="295"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(mask<sp/>!=<sp/>uint64_t(-1))<sp/>mask<sp/>+=<sp/>non_empty;</highlight></codeline>
<codeline lineno="296"><highlight class="normal"></highlight></codeline>
<codeline lineno="297"><highlight class="normal"><sp/><sp/><sp/><sp/>SetType<sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>;</highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>i<sp/>:<sp/>todo)<sp/>{</highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>[i])<sp/>{</highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(mask<sp/>&amp;<sp/>1)<sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref><sp/>|=<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1afc3ed1d0c57b777822863b057012f993" kindref="member">Ancestors</ref>(i);</highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mask<sp/>&gt;&gt;=<sp/>1;</highlight></codeline>
<codeline lineno="302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref><sp/>&amp;=<sp/>todo;</highlight></codeline>
<codeline lineno="305"><highlight class="normal"></highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>While<sp/>mask<sp/>starts<sp/>off<sp/>non-zero<sp/>if<sp/>non_empty<sp/>is<sp/>true,<sp/>it<sp/>is<sp/>still<sp/>possible<sp/>that<sp/>all<sp/>its<sp/>low</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="307"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>bits<sp/>are<sp/>0,<sp/>and<sp/>ret<sp/>ends<sp/>up<sp/>being<sp/>empty.<sp/>As<sp/>a<sp/>last<sp/>resort,<sp/>use<sp/>the<sp/>in-todo<sp/>ancestry<sp/>of<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>first<sp/>todo<sp/>position.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(non_empty<sp/>&amp;&amp;<sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>.None())<sp/>{</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(todo.Any());</highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref><sp/>=<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1afc3ed1d0c57b777822863b057012f993" kindref="member">Ancestors</ref>(todo.First())<sp/>&amp;<sp/>todo;</highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(<ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>.Any());</highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>;</highlight></codeline>
<codeline lineno="315"><highlight class="normal">}</highlight></codeline>
<codeline lineno="316"><highlight class="normal"></highlight></codeline>
<codeline lineno="318"><highlight class="normal"></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">typename</highlight><highlight class="normal"><sp/>BS&gt;</highlight></codeline>
<codeline lineno="319"><highlight class="normal">std::vector&lt;DepGraphIndex&gt;<sp/>ReadLinearization(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;BS&gt;</ref>&amp;<sp/>depgraph,<sp/><ref refid="class_span_reader" kindref="compound">SpanReader</ref>&amp;<sp/>reader,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>topological=</highlight><highlight class="keyword">true</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="320"><highlight class="normal">{</highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;DepGraphIndex&gt;<sp/>linearization;</highlight></codeline>
<codeline lineno="322"><highlight class="normal"><sp/><sp/><sp/><sp/>TestBitSet<sp/>todo<sp/>=<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a700dd1176f1aa1e6f3b2202fc0377dbe" kindref="member">Positions</ref>();</highlight></codeline>
<codeline lineno="323"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>In<sp/>every<sp/>iteration<sp/>one<sp/>transaction<sp/>is<sp/>appended<sp/>to<sp/>linearization.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="324"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(todo.Any())<sp/>{</highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compute<sp/>the<sp/>set<sp/>of<sp/>transactions<sp/>to<sp/>select<sp/>from.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>TestBitSet<sp/>potential_next;</highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(topological)<sp/>{</highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Find<sp/>all<sp/>transactions<sp/>with<sp/>no<sp/>not-yet-included<sp/>ancestors.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>j<sp/>:<sp/>todo)<sp/>{</highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1afc3ed1d0c57b777822863b057012f993" kindref="member">Ancestors</ref>(j)<sp/>&amp;<sp/>todo)<sp/>==<sp/>TestBitSet::Singleton(j))<sp/>{</highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>potential_next.Set(j);</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Allow<sp/>any<sp/>element<sp/>to<sp/>be<sp/>selected<sp/>next,<sp/>regardless<sp/>of<sp/>topology.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>potential_next<sp/>=<sp/>todo;</highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>There<sp/>must<sp/>always<sp/>be<sp/>one<sp/>(otherwise<sp/>there<sp/>is<sp/>a<sp/>cycle<sp/>in<sp/>the<sp/>graph).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(potential_next.Any());</highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Read<sp/>a<sp/>number<sp/>from<sp/>reader,<sp/>and<sp/>interpret<sp/>it<sp/>as<sp/>index<sp/>into<sp/>potential_next.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>idx{0};</highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reader<sp/>&gt;&gt;<sp/><ref refid="serialize_8h_1a1383f2a4c22ffaeba9b2924d90459f76" kindref="member">VARINT</ref>(idx);</highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::ios_base::failure&amp;)<sp/>{}</highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>idx<sp/>%=<sp/>potential_next.Count();</highlight></codeline>
<codeline lineno="346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Find<sp/>out<sp/>which<sp/>transaction<sp/>that<sp/>corresponds<sp/>to.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>j<sp/>:<sp/>potential_next)<sp/>{</highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(idx<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="349"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When<sp/>found,<sp/>add<sp/>it<sp/>to<sp/>linearization<sp/>and<sp/>remove<sp/>it<sp/>from<sp/>todo.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>linearization.push_back(j);</highlight></codeline>
<codeline lineno="351"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(todo[j]);</highlight></codeline>
<codeline lineno="352"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>todo.Reset(j);</highlight></codeline>
<codeline lineno="353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="355"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--idx;</highlight></codeline>
<codeline lineno="356"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="357"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>linearization;</highlight></codeline>
<codeline lineno="359"><highlight class="normal">}</highlight></codeline>
<codeline lineno="360"><highlight class="normal"></highlight></codeline>
<codeline lineno="366"><highlight class="normal"></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">typename</highlight><highlight class="normal"><sp/>BS&gt;</highlight></codeline>
<codeline lineno="367"><highlight class="normal"><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;BS&gt;</ref><sp/>BuildTreeGraph(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;BS&gt;</ref>&amp;<sp/>depgraph,<sp/>uint8_t<sp/>direction)</highlight></codeline>
<codeline lineno="368"><highlight class="normal">{</highlight></codeline>
<codeline lineno="369"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;BS&gt;</ref><sp/>depgraph_tree;</highlight></codeline>
<codeline lineno="370"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(<ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a25ec009eed6f7c821ec6d420cf32e1f0" kindref="member">PositionRange</ref>();<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="371"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a700dd1176f1aa1e6f3b2202fc0377dbe" kindref="member">Positions</ref>()[i])<sp/>{</highlight></codeline>
<codeline lineno="372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>depgraph_tree.<ref refid="classcluster__linearize_1_1_dep_graph_1ae677b48bbeb0fa8b274c1e49eafea7d1" kindref="member">AddTransaction</ref>(depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a401a234c54f61fb05821094ad38f24d5" kindref="member">FeeRate</ref>(i));</highlight></codeline>
<codeline lineno="373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>For<sp/>holes,<sp/>add<sp/>a<sp/>dummy<sp/>transaction<sp/>which<sp/>is<sp/>deleted<sp/>below,<sp/>so<sp/>that<sp/>non-hole</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="375"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transactions<sp/>retain<sp/>their<sp/>position.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="376"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>depgraph_tree.<ref refid="classcluster__linearize_1_1_dep_graph_1ae677b48bbeb0fa8b274c1e49eafea7d1" kindref="member">AddTransaction</ref>(<ref refid="struct_fee_frac" kindref="compound">FeeFrac</ref>{});</highlight></codeline>
<codeline lineno="377"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="378"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="379"><highlight class="normal"><sp/><sp/><sp/><sp/>depgraph_tree.<ref refid="classcluster__linearize_1_1_dep_graph_1aaf442181ff5e5d3c28e8cc74c5208494" kindref="member">RemoveTransactions</ref>(BS::Fill(depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a25ec009eed6f7c821ec6d420cf32e1f0" kindref="member">PositionRange</ref>())<sp/>-<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a700dd1176f1aa1e6f3b2202fc0377dbe" kindref="member">Positions</ref>());</highlight></codeline>
<codeline lineno="380"><highlight class="normal"></highlight></codeline>
<codeline lineno="381"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(direction<sp/>&amp;<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(<ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>i<sp/>:<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a700dd1176f1aa1e6f3b2202fc0377dbe" kindref="member">Positions</ref>())<sp/>{</highlight></codeline>
<codeline lineno="383"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>children<sp/>=<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a6c1d3528a880d2e75f69e6707f6a616b" kindref="member">GetReducedChildren</ref>(i);</highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(children.Any())<sp/>{</highlight></codeline>
<codeline lineno="385"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>depgraph_tree.<ref refid="classcluster__linearize_1_1_dep_graph_1aba3e34d0a7b3d68b385fa80cbea06495" kindref="member">AddDependencies</ref>(BS::Singleton(i),<sp/>children.First());</highlight></codeline>
<codeline lineno="386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="387"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="388"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="389"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(<ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>i<sp/>:<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a700dd1176f1aa1e6f3b2202fc0377dbe" kindref="member">Positions</ref>())<sp/>{</highlight></codeline>
<codeline lineno="390"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>parents<sp/>=<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a29920af7e4f40b2c3e80c2232051a489" kindref="member">GetReducedParents</ref>(i);</highlight></codeline>
<codeline lineno="391"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(parents.Any())<sp/>{</highlight></codeline>
<codeline lineno="392"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>depgraph_tree.<ref refid="classcluster__linearize_1_1_dep_graph_1aba3e34d0a7b3d68b385fa80cbea06495" kindref="member">AddDependencies</ref>(BS::Singleton(parents.First()),<sp/>i);</highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="395"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="396"><highlight class="normal"></highlight></codeline>
<codeline lineno="397"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>depgraph_tree;</highlight></codeline>
<codeline lineno="398"><highlight class="normal">}</highlight></codeline>
<codeline lineno="399"><highlight class="normal"></highlight></codeline>
<codeline lineno="400"><highlight class="normal">}<sp/></highlight><highlight class="comment">//<sp/>namespace</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="401"><highlight class="normal"></highlight></codeline>
<codeline lineno="402"><highlight class="normal"><ref refid="fuzz_8h_1a1b5a7b9b93ade1576569510908cc4bb9" kindref="member">FUZZ_TARGET</ref>(clusterlin_depgraph_sim)</highlight></codeline>
<codeline lineno="403"><highlight class="normal">{</highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Simulation<sp/>test<sp/>to<sp/>verify<sp/>the<sp/>full<sp/>behavior<sp/>of<sp/>DepGraph.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="405"><highlight class="normal"></highlight></codeline>
<codeline lineno="406"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_fuzzed_data_provider" kindref="compound">FuzzedDataProvider</ref><sp/>provider(buffer.data(),<sp/>buffer.size());</highlight></codeline>
<codeline lineno="407"><highlight class="normal"></highlight></codeline>
<codeline lineno="409"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;TestBitSet&gt;</ref><sp/>real;</highlight></codeline>
<codeline lineno="412"><highlight class="normal"><sp/><sp/><sp/><sp/>std::array&lt;std::optional&lt;std::pair&lt;FeeFrac,<sp/>TestBitSet&gt;&gt;,<sp/>TestBitSet::Size()&gt;<sp/>sim;</highlight></codeline>
<codeline lineno="414"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>num_tx_sim{0};</highlight></codeline>
<codeline lineno="415"><highlight class="normal"></highlight></codeline>
<codeline lineno="417"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>idx_fn<sp/>=<sp/>[&amp;]()<sp/>{</highlight></codeline>
<codeline lineno="418"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>offset<sp/>=<sp/>provider.ConsumeIntegralInRange&lt;<ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref>&gt;(0,<sp/>num_tx_sim<sp/>-<sp/>1);</highlight></codeline>
<codeline lineno="419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(<ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>sim.size();<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sim[i].has_value())<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="421"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(offset<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>i;</highlight></codeline>
<codeline lineno="422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--offset;</highlight></codeline>
<codeline lineno="423"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="424"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(</highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="425"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref>(-1);</highlight></codeline>
<codeline lineno="426"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="427"><highlight class="normal"></highlight></codeline>
<codeline lineno="429"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>subset_fn<sp/>=<sp/>[&amp;]()<sp/>{</highlight></codeline>
<codeline lineno="430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>range<sp/>=<sp/>(uint64_t{1}<sp/>&lt;&lt;<sp/>num_tx_sim)<sp/>-<sp/>1;</highlight></codeline>
<codeline lineno="431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>mask<sp/>=<sp/>provider.ConsumeIntegralInRange&lt;uint64_t&gt;(0,<sp/>range);</highlight></codeline>
<codeline lineno="432"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>mask_shifted<sp/>=<sp/>mask;</highlight></codeline>
<codeline lineno="433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>TestBitSet<sp/>subset;</highlight></codeline>
<codeline lineno="434"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(<ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>sim.size();<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="435"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sim[i].has_value())<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="436"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(mask_shifted<sp/>&amp;<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="437"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>subset.Set(i);</highlight></codeline>
<codeline lineno="438"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="439"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mask_shifted<sp/>&gt;&gt;=<sp/>1;</highlight></codeline>
<codeline lineno="440"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="441"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(mask_shifted<sp/>==<sp/>0);</highlight></codeline>
<codeline lineno="442"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>subset;</highlight></codeline>
<codeline lineno="443"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="444"><highlight class="normal"></highlight></codeline>
<codeline lineno="446"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>set_fn<sp/>=<sp/>[&amp;]()<sp/>{</highlight></codeline>
<codeline lineno="447"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>range<sp/>=<sp/>(uint64_t{1}<sp/>&lt;&lt;<sp/>sim.size())<sp/>-<sp/>1;</highlight></codeline>
<codeline lineno="448"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>mask<sp/>=<sp/>provider.ConsumeIntegralInRange&lt;uint64_t&gt;(0,<sp/>range);</highlight></codeline>
<codeline lineno="449"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>TestBitSet<sp/>set;</highlight></codeline>
<codeline lineno="450"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(<ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>sim.size();<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((mask<sp/>&gt;&gt;<sp/>i)<sp/>&amp;<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="452"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>set.Set(i);</highlight></codeline>
<codeline lineno="453"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="455"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>set;</highlight></codeline>
<codeline lineno="456"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="457"><highlight class="normal"></highlight></codeline>
<codeline lineno="459"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>anc_update_fn<sp/>=<sp/>[&amp;]()<sp/>{</highlight></codeline>
<codeline lineno="460"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">true</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="461"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>updates{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="462"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(<ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>chl<sp/>=<sp/>0;<sp/>chl<sp/>&lt;<sp/>sim.size();<sp/>++chl)<sp/>{</highlight></codeline>
<codeline lineno="463"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sim[chl].has_value())<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="464"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>par<sp/>:<sp/>sim[chl]-&gt;second)<sp/>{</highlight></codeline>
<codeline lineno="465"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sim[chl]-&gt;second.IsSupersetOf(sim[par]-&gt;second))<sp/>{</highlight></codeline>
<codeline lineno="466"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sim[chl]-&gt;second<sp/>|=<sp/>sim[par]-&gt;second;</highlight></codeline>
<codeline lineno="467"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>updates<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="468"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="469"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="470"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="471"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!updates)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="472"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="473"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="474"><highlight class="normal"></highlight></codeline>
<codeline lineno="476"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>check_fn<sp/>=<sp/>[&amp;](<ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>i)<sp/>{</highlight></codeline>
<codeline lineno="477"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compare<sp/>used<sp/>positions.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="478"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(real.<ref refid="classcluster__linearize_1_1_dep_graph_1a700dd1176f1aa1e6f3b2202fc0377dbe" kindref="member">Positions</ref>()[i]<sp/>==<sp/>sim[i].has_value());</highlight></codeline>
<codeline lineno="479"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sim[i].has_value())<sp/>{</highlight></codeline>
<codeline lineno="480"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compare<sp/>feerate.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="481"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(real.<ref refid="classcluster__linearize_1_1_dep_graph_1a401a234c54f61fb05821094ad38f24d5" kindref="member">FeeRate</ref>(i)<sp/>==<sp/>sim[i]-&gt;first);</highlight></codeline>
<codeline lineno="482"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compare<sp/>ancestors<sp/>(note<sp/>that<sp/>SanityCheck<sp/>verifies<sp/>correspondence<sp/>between<sp/>ancestors</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="483"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>descendants,<sp/>so<sp/>we<sp/>can<sp/>restrict<sp/>ourselves<sp/>to<sp/>ancestors<sp/>here).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="484"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(real.<ref refid="classcluster__linearize_1_1_dep_graph_1afc3ed1d0c57b777822863b057012f993" kindref="member">Ancestors</ref>(i)<sp/>==<sp/>sim[i]-&gt;second);</highlight></codeline>
<codeline lineno="485"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="486"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="487"><highlight class="normal"></highlight></codeline>
<codeline lineno="488"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>last_compaction_pos{real.<ref refid="classcluster__linearize_1_1_dep_graph_1a25ec009eed6f7c821ec6d420cf32e1f0" kindref="member">PositionRange</ref>()};</highlight></codeline>
<codeline lineno="489"><highlight class="normal"></highlight></codeline>
<codeline lineno="490"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="fuzz_8h_1abad697b2e7eda14afa093f4107ca6b2a" kindref="member">LIMITED_WHILE</ref>(provider.remaining_bytes()<sp/>&gt;<sp/>0,<sp/>1000)<sp/>{</highlight></codeline>
<codeline lineno="491"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="bitcoin-wallet_8cpp_1a64b0c5844a38fc862dcb5b4e30b1ca49" kindref="member">command</ref><sp/>=<sp/>provider.ConsumeIntegral&lt;uint8_t&gt;()<sp/>%<sp/>4;</highlight></codeline>
<codeline lineno="492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">true</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Iterate<sp/>decreasing<sp/>command<sp/>until<sp/>an<sp/>applicable<sp/>branch<sp/>is<sp/>found.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(num_tx_sim<sp/>&lt;<sp/>TestBitSet::Size()<sp/>&amp;&amp;<sp/><ref refid="bitcoin-wallet_8cpp_1a64b0c5844a38fc862dcb5b4e30b1ca49" kindref="member">command</ref>--<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="495"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>AddTransaction.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="496"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/><ref refid="mempool__ephemeral__spends_8cpp_1ab1754b8fc0364199f0cbb58d5e1f98e8" kindref="member">fee</ref><sp/>=<sp/>provider.ConsumeIntegralInRange&lt;int64_t&gt;(-0x8000000000000,<sp/>0x7ffffffffffff);</highlight></codeline>
<codeline lineno="497"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>size<sp/>=<sp/>provider.ConsumeIntegralInRange&lt;int32_t&gt;(1,<sp/>0x3fffff);</highlight></codeline>
<codeline lineno="498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_fee_frac" kindref="compound">FeeFrac</ref><sp/>feerate{<ref refid="mempool__ephemeral__spends_8cpp_1ab1754b8fc0364199f0cbb58d5e1f98e8" kindref="member">fee</ref>,<sp/>size};</highlight></codeline>
<codeline lineno="499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Apply<sp/>to<sp/>DepGraph.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>idx<sp/>=<sp/>real.<ref refid="classcluster__linearize_1_1_dep_graph_1ae677b48bbeb0fa8b274c1e49eafea7d1" kindref="member">AddTransaction</ref>(feerate);</highlight></codeline>
<codeline lineno="501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>that<sp/>the<sp/>returned<sp/>index<sp/>is<sp/>correct.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!sim[idx].has_value());</highlight></codeline>
<codeline lineno="503"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(<ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>TestBitSet::Size();<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="504"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sim[i].has_value())<sp/>{</highlight></codeline>
<codeline lineno="505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(idx<sp/>==<sp/>i);</highlight></codeline>
<codeline lineno="506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="508"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="509"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Update<sp/>sim.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sim[idx]<sp/>=<sp/>{feerate,<sp/>TestBitSet::Singleton(idx)};</highlight></codeline>
<codeline lineno="511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++num_tx_sim;</highlight></codeline>
<codeline lineno="512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="513"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(num_tx_sim<sp/>&gt;<sp/>0<sp/>&amp;&amp;<sp/><ref refid="bitcoin-wallet_8cpp_1a64b0c5844a38fc862dcb5b4e30b1ca49" kindref="member">command</ref>--<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>AddDependencies.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="515"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>child<sp/>=<sp/>idx_fn();</highlight></codeline>
<codeline lineno="516"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>parents<sp/>=<sp/>subset_fn();</highlight></codeline>
<codeline lineno="517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Apply<sp/>to<sp/>DepGraph.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>real.<ref refid="classcluster__linearize_1_1_dep_graph_1aba3e34d0a7b3d68b385fa80cbea06495" kindref="member">AddDependencies</ref>(parents,<sp/>child);</highlight></codeline>
<codeline lineno="519"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Apply<sp/>to<sp/>sim.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="520"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sim[child]-&gt;second<sp/>|=<sp/>parents;</highlight></codeline>
<codeline lineno="521"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(num_tx_sim<sp/>&gt;<sp/>0<sp/>&amp;&amp;<sp/><ref refid="bitcoin-wallet_8cpp_1a64b0c5844a38fc862dcb5b4e30b1ca49" kindref="member">command</ref>--<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="523"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Remove<sp/>transactions.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>del<sp/>=<sp/>set_fn();</highlight></codeline>
<codeline lineno="525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Propagate<sp/>all<sp/>ancestry<sp/>information<sp/>before<sp/>deleting<sp/>anything<sp/>in<sp/>the<sp/>simulation<sp/>(as</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="526"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>intermediary<sp/>transactions<sp/>may<sp/>be<sp/>deleted<sp/>which<sp/>impact<sp/>connectivity).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="527"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>anc_update_fn();</highlight></codeline>
<codeline lineno="528"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compare<sp/>the<sp/>state<sp/>of<sp/>the<sp/>transactions<sp/>being<sp/>deleted.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="529"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>i<sp/>:<sp/>del)<sp/>check_fn(i);</highlight></codeline>
<codeline lineno="530"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Apply<sp/>to<sp/>DepGraph.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="531"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>real.<ref refid="classcluster__linearize_1_1_dep_graph_1aaf442181ff5e5d3c28e8cc74c5208494" kindref="member">RemoveTransactions</ref>(del);</highlight></codeline>
<codeline lineno="532"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Apply<sp/>to<sp/>sim.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="533"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(<ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>sim.size();<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="534"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sim[i].has_value())<sp/>{</highlight></codeline>
<codeline lineno="535"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(del[i])<sp/>{</highlight></codeline>
<codeline lineno="536"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--num_tx_sim;</highlight></codeline>
<codeline lineno="537"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sim[i]<sp/>=<sp/>std::nullopt;</highlight></codeline>
<codeline lineno="538"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="539"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sim[i]-&gt;second<sp/>-=<sp/>del;</highlight></codeline>
<codeline lineno="540"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="541"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="542"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="543"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="544"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="bitcoin-wallet_8cpp_1a64b0c5844a38fc862dcb5b4e30b1ca49" kindref="member">command</ref>--<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="545"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compact.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="546"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mem_before{real.<ref refid="classcluster__linearize_1_1_dep_graph_1a194cf51253e199ba4050864d31a69624" kindref="member">DynamicMemoryUsage</ref>()};</highlight></codeline>
<codeline lineno="547"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>real.<ref refid="classcluster__linearize_1_1_dep_graph_1ab5aba587be7c8108197235c42fe22c1d" kindref="member">Compact</ref>();</highlight></codeline>
<codeline lineno="548"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mem_after{real.<ref refid="classcluster__linearize_1_1_dep_graph_1a194cf51253e199ba4050864d31a69624" kindref="member">DynamicMemoryUsage</ref>()};</highlight></codeline>
<codeline lineno="549"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(real.<ref refid="classcluster__linearize_1_1_dep_graph_1a25ec009eed6f7c821ec6d420cf32e1f0" kindref="member">PositionRange</ref>()<sp/>&lt;<sp/>last_compaction_pos<sp/>?<sp/>mem_after<sp/>&lt;<sp/>mem_before<sp/>:<sp/>mem_after<sp/>&lt;=<sp/>mem_before);</highlight></codeline>
<codeline lineno="550"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>last_compaction_pos<sp/>=<sp/>real.<ref refid="classcluster__linearize_1_1_dep_graph_1a25ec009eed6f7c821ec6d420cf32e1f0" kindref="member">PositionRange</ref>();</highlight></codeline>
<codeline lineno="551"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="552"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="553"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="554"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="555"><highlight class="normal"></highlight></codeline>
<codeline lineno="556"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compare<sp/>the<sp/>real<sp/>obtained<sp/>depgraph<sp/>against<sp/>the<sp/>simulation.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="557"><highlight class="normal"><sp/><sp/><sp/><sp/>anc_update_fn();</highlight></codeline>
<codeline lineno="558"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(<ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>sim.size();<sp/>++i)<sp/>check_fn(i);</highlight></codeline>
<codeline lineno="559"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(real.<ref refid="classcluster__linearize_1_1_dep_graph_1ae3cec0644fd4e8562d14b99badc3c91e" kindref="member">TxCount</ref>()<sp/>==<sp/>num_tx_sim);</highlight></codeline>
<codeline lineno="560"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Sanity<sp/>check<sp/>the<sp/>result<sp/>(which<sp/>includes<sp/>round-tripping<sp/>serialization,<sp/>if<sp/>applicable).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="561"><highlight class="normal"><sp/><sp/><sp/><sp/>SanityCheck(real);</highlight></codeline>
<codeline lineno="562"><highlight class="normal">}</highlight></codeline>
<codeline lineno="563"><highlight class="normal"></highlight></codeline>
<codeline lineno="564"><highlight class="normal"><ref refid="fuzz_8h_1a1b5a7b9b93ade1576569510908cc4bb9" kindref="member">FUZZ_TARGET</ref>(clusterlin_depgraph_serialization)</highlight></codeline>
<codeline lineno="565"><highlight class="normal">{</highlight></codeline>
<codeline lineno="566"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>that<sp/>any<sp/>deserialized<sp/>depgraph<sp/>is<sp/>acyclic<sp/>and<sp/>roundtrips<sp/>to<sp/>an<sp/>identical<sp/>depgraph.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="567"><highlight class="normal"></highlight></codeline>
<codeline lineno="568"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Construct<sp/>a<sp/>graph<sp/>by<sp/>deserializing.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="569"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_span_reader" kindref="compound">SpanReader</ref><sp/>reader(buffer);</highlight></codeline>
<codeline lineno="570"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;TestBitSet&gt;</ref><sp/>depgraph;</highlight></codeline>
<codeline lineno="571"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>par_code{0},<sp/>chl_code{0};</highlight></codeline>
<codeline lineno="572"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reader<sp/>&gt;&gt;<sp/>Using&lt;DepGraphFormatter&gt;(depgraph)<sp/>&gt;&gt;<sp/><ref refid="serialize_8h_1a1383f2a4c22ffaeba9b2924d90459f76" kindref="member">VARINT</ref>(par_code)<sp/>&gt;&gt;<sp/><ref refid="serialize_8h_1a1383f2a4c22ffaeba9b2924d90459f76" kindref="member">VARINT</ref>(chl_code);</highlight></codeline>
<codeline lineno="574"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::ios_base::failure&amp;)<sp/>{}</highlight></codeline>
<codeline lineno="575"><highlight class="normal"><sp/><sp/><sp/><sp/>SanityCheck(depgraph);</highlight></codeline>
<codeline lineno="576"><highlight class="normal"></highlight></codeline>
<codeline lineno="577"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>the<sp/>graph<sp/>is<sp/>a<sp/>DAG.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="578"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a2ba3e82525f7494fdd6ffb29fa8c147d" kindref="member">IsAcyclic</ref>());</highlight></codeline>
<codeline lineno="579"><highlight class="normal"></highlight></codeline>
<codeline lineno="580"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Introduce<sp/>a<sp/>cycle,<sp/>and<sp/>then<sp/>test<sp/>that<sp/>IsAcyclic<sp/>returns<sp/>false.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="581"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1ae3cec0644fd4e8562d14b99badc3c91e" kindref="member">TxCount</ref>()<sp/>&lt;<sp/>2)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="582"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>par(0),<sp/>chl(0);</highlight></codeline>
<codeline lineno="583"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Pick<sp/>any<sp/>transaction<sp/>of<sp/>depgraph<sp/>as<sp/>parent.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="584"><highlight class="normal"><sp/><sp/><sp/><sp/>par_code<sp/>%=<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1ae3cec0644fd4e8562d14b99badc3c91e" kindref="member">TxCount</ref>();</highlight></codeline>
<codeline lineno="585"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>i<sp/>:<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a700dd1176f1aa1e6f3b2202fc0377dbe" kindref="member">Positions</ref>())<sp/>{</highlight></codeline>
<codeline lineno="586"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(par_code<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="587"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>par<sp/>=<sp/>i;</highlight></codeline>
<codeline lineno="588"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="589"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="590"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--par_code;</highlight></codeline>
<codeline lineno="591"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="592"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Pick<sp/>any<sp/>ancestor<sp/>of<sp/>par<sp/>(excluding<sp/>itself)<sp/>as<sp/>child,<sp/>if<sp/>any.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="593"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>ancestors<sp/>=<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1afc3ed1d0c57b777822863b057012f993" kindref="member">Ancestors</ref>(par)<sp/>-<sp/>TestBitSet::Singleton(par);</highlight></codeline>
<codeline lineno="594"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ancestors.None())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="595"><highlight class="normal"><sp/><sp/><sp/><sp/>chl_code<sp/>%=<sp/>ancestors.Count();</highlight></codeline>
<codeline lineno="596"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>i<sp/>:<sp/>ancestors)<sp/>{</highlight></codeline>
<codeline lineno="597"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(chl_code<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="598"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>chl<sp/>=<sp/>i;</highlight></codeline>
<codeline lineno="599"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="600"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="601"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--chl_code;</highlight></codeline>
<codeline lineno="602"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="603"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Add<sp/>the<sp/>cycle-introducing<sp/>dependency.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="604"><highlight class="normal"><sp/><sp/><sp/><sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1aba3e34d0a7b3d68b385fa80cbea06495" kindref="member">AddDependencies</ref>(TestBitSet::Singleton(par),<sp/>chl);</highlight></codeline>
<codeline lineno="605"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>that<sp/>we<sp/>now<sp/>detect<sp/>a<sp/>cycle.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="606"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a2ba3e82525f7494fdd6ffb29fa8c147d" kindref="member">IsAcyclic</ref>());</highlight></codeline>
<codeline lineno="607"><highlight class="normal">}</highlight></codeline>
<codeline lineno="608"><highlight class="normal"></highlight></codeline>
<codeline lineno="609"><highlight class="normal"><ref refid="fuzz_8h_1a1b5a7b9b93ade1576569510908cc4bb9" kindref="member">FUZZ_TARGET</ref>(clusterlin_components)</highlight></codeline>
<codeline lineno="610"><highlight class="normal">{</highlight></codeline>
<codeline lineno="611"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>the<sp/>behavior<sp/>of<sp/>DepGraphs&apos;s<sp/>FindConnectedComponent<sp/>and<sp/>IsConnected<sp/>functions.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="612"><highlight class="normal"></highlight></codeline>
<codeline lineno="613"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Construct<sp/>a<sp/>depgraph.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="614"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_span_reader" kindref="compound">SpanReader</ref><sp/>reader(buffer);</highlight></codeline>
<codeline lineno="615"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;TestBitSet&gt;</ref><sp/>depgraph;</highlight></codeline>
<codeline lineno="616"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;DepGraphIndex&gt;<sp/>linearization;</highlight></codeline>
<codeline lineno="617"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="618"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reader<sp/>&gt;&gt;<sp/>Using&lt;DepGraphFormatter&gt;(depgraph);</highlight></codeline>
<codeline lineno="619"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::ios_base::failure&amp;)<sp/>{}</highlight></codeline>
<codeline lineno="620"><highlight class="normal"></highlight></codeline>
<codeline lineno="621"><highlight class="normal"><sp/><sp/><sp/><sp/>TestBitSet<sp/>todo<sp/>=<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a700dd1176f1aa1e6f3b2202fc0377dbe" kindref="member">Positions</ref>();</highlight></codeline>
<codeline lineno="622"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(todo.Any())<sp/>{</highlight></codeline>
<codeline lineno="623"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Pick<sp/>a<sp/>transaction<sp/>in<sp/>todo,<sp/>or<sp/>nothing.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="624"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::optional&lt;DepGraphIndex&gt;<sp/>picked;</highlight></codeline>
<codeline lineno="625"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="626"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>picked_num{0};</highlight></codeline>
<codeline lineno="627"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="628"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reader<sp/>&gt;&gt;<sp/><ref refid="serialize_8h_1a1383f2a4c22ffaeba9b2924d90459f76" kindref="member">VARINT</ref>(picked_num);</highlight></codeline>
<codeline lineno="629"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::ios_base::failure&amp;)<sp/>{}</highlight></codeline>
<codeline lineno="630"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(picked_num<sp/>&lt;<sp/>todo.Size()<sp/>&amp;&amp;<sp/>todo[picked_num])<sp/>{</highlight></codeline>
<codeline lineno="631"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>picked<sp/>=<sp/>picked_num;</highlight></codeline>
<codeline lineno="632"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="633"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="634"><highlight class="normal"></highlight></codeline>
<codeline lineno="635"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Find<sp/>a<sp/>connected<sp/>component<sp/>inside<sp/>todo,<sp/>including<sp/>picked<sp/>if<sp/>any.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="636"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>component<sp/>=<sp/>picked<sp/>?<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a286faed858256ba9f84e7f1a71097784" kindref="member">GetConnectedComponent</ref>(todo,<sp/>*picked)</highlight></codeline>
<codeline lineno="637"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>:<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1ac5fbeb4ad21962416c511bd250f53730" kindref="member">FindConnectedComponent</ref>(todo);</highlight></codeline>
<codeline lineno="638"><highlight class="normal"></highlight></codeline>
<codeline lineno="639"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>component<sp/>must<sp/>be<sp/>a<sp/>subset<sp/>of<sp/>todo<sp/>and<sp/>non-empty.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="640"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(component.IsSubsetOf(todo));</highlight></codeline>
<codeline lineno="641"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(component.Any());</highlight></codeline>
<codeline lineno="642"><highlight class="normal"></highlight></codeline>
<codeline lineno="643"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>picked<sp/>was<sp/>provided,<sp/>the<sp/>component<sp/>must<sp/>include<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="644"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(picked)<sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(component[*picked]);</highlight></codeline>
<codeline lineno="645"><highlight class="normal"></highlight></codeline>
<codeline lineno="646"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>todo<sp/>is<sp/>the<sp/>entire<sp/>graph,<sp/>and<sp/>the<sp/>entire<sp/>graph<sp/>is<sp/>connected,<sp/>then<sp/>the<sp/>component<sp/>must</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="647"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>be<sp/>the<sp/>entire<sp/>graph.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="648"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(todo<sp/>==<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a700dd1176f1aa1e6f3b2202fc0377dbe" kindref="member">Positions</ref>())<sp/>{</highlight></codeline>
<codeline lineno="649"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>((component<sp/>==<sp/>todo)<sp/>==<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1aecc46909fd08c461aeab4cd0807509d1" kindref="member">IsConnected</ref>());</highlight></codeline>
<codeline lineno="650"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="651"><highlight class="normal"></highlight></codeline>
<codeline lineno="652"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>subset<sp/>is<sp/>connected,<sp/>then<sp/>component<sp/>must<sp/>match<sp/>subset.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="653"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>((component<sp/>==<sp/>todo)<sp/>==<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1aecc46909fd08c461aeab4cd0807509d1" kindref="member">IsConnected</ref>(todo));</highlight></codeline>
<codeline lineno="654"><highlight class="normal"></highlight></codeline>
<codeline lineno="655"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>component<sp/>cannot<sp/>have<sp/>any<sp/>ancestors<sp/>or<sp/>descendants<sp/>outside<sp/>of<sp/>component<sp/>but<sp/>in<sp/>todo.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="656"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>i<sp/>:<sp/>component)<sp/>{</highlight></codeline>
<codeline lineno="657"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>((depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1afc3ed1d0c57b777822863b057012f993" kindref="member">Ancestors</ref>(i)<sp/>&amp;<sp/>todo).IsSubsetOf(component));</highlight></codeline>
<codeline lineno="658"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>((depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a923c8c0baa44ffa39f9efde63a36021c" kindref="member">Descendants</ref>(i)<sp/>&amp;<sp/>todo).IsSubsetOf(component));</highlight></codeline>
<codeline lineno="659"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="660"><highlight class="normal"></highlight></codeline>
<codeline lineno="661"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Starting<sp/>from<sp/>any<sp/>component<sp/>element,<sp/>we<sp/>must<sp/>be<sp/>able<sp/>to<sp/>reach<sp/>every<sp/>element.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="662"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>i<sp/>:<sp/>component)<sp/>{</highlight></codeline>
<codeline lineno="663"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Start<sp/>with<sp/>just<sp/>i<sp/>as<sp/>reachable.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="664"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>TestBitSet<sp/>reachable<sp/>=<sp/>TestBitSet::Singleton(i);</highlight></codeline>
<codeline lineno="665"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Add<sp/>in-todo<sp/>descendants<sp/>and<sp/>ancestors<sp/>to<sp/>reachable<sp/>until<sp/>it<sp/>does<sp/>not<sp/>change<sp/>anymore.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="666"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">true</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="667"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>TestBitSet<sp/>new_reachable<sp/>=<sp/>reachable;</highlight></codeline>
<codeline lineno="668"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>j<sp/>:<sp/>new_reachable)<sp/>{</highlight></codeline>
<codeline lineno="669"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_reachable<sp/>|=<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1afc3ed1d0c57b777822863b057012f993" kindref="member">Ancestors</ref>(j)<sp/>&amp;<sp/>todo;</highlight></codeline>
<codeline lineno="670"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_reachable<sp/>|=<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a923c8c0baa44ffa39f9efde63a36021c" kindref="member">Descendants</ref>(j)<sp/>&amp;<sp/>todo;</highlight></codeline>
<codeline lineno="671"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="672"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(new_reachable<sp/>==<sp/>reachable)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="673"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reachable<sp/>=<sp/>new_reachable;</highlight></codeline>
<codeline lineno="674"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>that<sp/>the<sp/>result<sp/>is<sp/>the<sp/>entire<sp/>component.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="676"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(component<sp/>==<sp/>reachable);</highlight></codeline>
<codeline lineno="677"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="678"><highlight class="normal"></highlight></codeline>
<codeline lineno="679"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Construct<sp/>an<sp/>arbitrary<sp/>subset<sp/>of<sp/>todo.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="680"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>subset_bits{0};</highlight></codeline>
<codeline lineno="681"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="682"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reader<sp/>&gt;&gt;<sp/><ref refid="serialize_8h_1a1383f2a4c22ffaeba9b2924d90459f76" kindref="member">VARINT</ref>(subset_bits);</highlight></codeline>
<codeline lineno="683"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::ios_base::failure&amp;)<sp/>{}</highlight></codeline>
<codeline lineno="684"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>TestBitSet<sp/>subset;</highlight></codeline>
<codeline lineno="685"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(<ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>i<sp/>:<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a700dd1176f1aa1e6f3b2202fc0377dbe" kindref="member">Positions</ref>())<sp/>{</highlight></codeline>
<codeline lineno="686"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(todo[i])<sp/>{</highlight></codeline>
<codeline lineno="687"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(subset_bits<sp/>&amp;<sp/>1)<sp/>subset.Set(i);</highlight></codeline>
<codeline lineno="688"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>subset_bits<sp/>&gt;&gt;=<sp/>1;</highlight></codeline>
<codeline lineno="689"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="690"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="691"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Which<sp/>must<sp/>be<sp/>non-empty.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="692"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(subset.None())<sp/>subset<sp/>=<sp/>TestBitSet::Singleton(todo.First());</highlight></codeline>
<codeline lineno="693"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Remove<sp/>it<sp/>from<sp/>todo.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="694"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>todo<sp/>-=<sp/>subset;</highlight></codeline>
<codeline lineno="695"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="696"><highlight class="normal"></highlight></codeline>
<codeline lineno="697"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>No<sp/>components<sp/>can<sp/>be<sp/>found<sp/>in<sp/>an<sp/>empty<sp/>subset.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="698"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1ac5fbeb4ad21962416c511bd250f53730" kindref="member">FindConnectedComponent</ref>(todo).None());</highlight></codeline>
<codeline lineno="699"><highlight class="normal">}</highlight></codeline>
<codeline lineno="700"><highlight class="normal"></highlight></codeline>
<codeline lineno="701"><highlight class="normal"><ref refid="fuzz_8h_1a1b5a7b9b93ade1576569510908cc4bb9" kindref="member">FUZZ_TARGET</ref>(clusterlin_make_connected)</highlight></codeline>
<codeline lineno="702"><highlight class="normal">{</highlight></codeline>
<codeline lineno="703"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>that<sp/>MakeConnected<sp/>makes<sp/>graphs<sp/>connected.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="704"><highlight class="normal"></highlight></codeline>
<codeline lineno="705"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_span_reader" kindref="compound">SpanReader</ref><sp/>reader(buffer);</highlight></codeline>
<codeline lineno="706"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;TestBitSet&gt;</ref><sp/>depgraph;</highlight></codeline>
<codeline lineno="707"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="708"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reader<sp/>&gt;&gt;<sp/>Using&lt;DepGraphFormatter&gt;(depgraph);</highlight></codeline>
<codeline lineno="709"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::ios_base::failure&amp;)<sp/>{}</highlight></codeline>
<codeline lineno="710"><highlight class="normal"><sp/><sp/><sp/><sp/>MakeConnected(depgraph);</highlight></codeline>
<codeline lineno="711"><highlight class="normal"><sp/><sp/><sp/><sp/>SanityCheck(depgraph);</highlight></codeline>
<codeline lineno="712"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1aecc46909fd08c461aeab4cd0807509d1" kindref="member">IsConnected</ref>());</highlight></codeline>
<codeline lineno="713"><highlight class="normal">}</highlight></codeline>
<codeline lineno="714"><highlight class="normal"></highlight></codeline>
<codeline lineno="715"><highlight class="normal"><ref refid="fuzz_8h_1a1b5a7b9b93ade1576569510908cc4bb9" kindref="member">FUZZ_TARGET</ref>(clusterlin_chunking)</highlight></codeline>
<codeline lineno="716"><highlight class="normal">{</highlight></codeline>
<codeline lineno="717"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>the<sp/>correctness<sp/>of<sp/>the<sp/>ChunkLinearization<sp/>function.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="718"><highlight class="normal"></highlight></codeline>
<codeline lineno="719"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Construct<sp/>a<sp/>graph<sp/>by<sp/>deserializing.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="720"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_span_reader" kindref="compound">SpanReader</ref><sp/>reader(buffer);</highlight></codeline>
<codeline lineno="721"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;TestBitSet&gt;</ref><sp/>depgraph;</highlight></codeline>
<codeline lineno="722"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="723"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reader<sp/>&gt;&gt;<sp/>Using&lt;DepGraphFormatter&gt;(depgraph);</highlight></codeline>
<codeline lineno="724"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::ios_base::failure&amp;)<sp/>{}</highlight></codeline>
<codeline lineno="725"><highlight class="normal"></highlight></codeline>
<codeline lineno="726"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Read<sp/>a<sp/>valid<sp/>linearization<sp/>for<sp/>depgraph.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="727"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>linearization<sp/>=<sp/>ReadLinearization(depgraph,<sp/>reader);</highlight></codeline>
<codeline lineno="728"><highlight class="normal"></highlight></codeline>
<codeline lineno="729"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Invoke<sp/>the<sp/>chunking<sp/>functions.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="730"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>chunking<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph,<sp/>linearization);</highlight></codeline>
<codeline lineno="731"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>chunking_info<sp/>=<sp/><ref refid="namespacecluster__linearize_1a30f9a354e247428df47e59a11e2a098f" kindref="member">ChunkLinearizationInfo</ref>(depgraph,<sp/>linearization);</highlight></codeline>
<codeline lineno="732"><highlight class="normal"></highlight></codeline>
<codeline lineno="733"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>consistency<sp/>between<sp/>the<sp/>two<sp/>functions.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="734"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(chunking.size()<sp/>==<sp/>chunking_info.size());</highlight></codeline>
<codeline lineno="735"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>chunking.size();<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="736"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(chunking[i]<sp/>==<sp/>chunking_info[i].feerate);</highlight></codeline>
<codeline lineno="737"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(<ref refid="structcluster__linearize_1_1_set_info" kindref="compound">SetInfo</ref>(depgraph,<sp/>chunking_info[i].transactions)<sp/>==<sp/>chunking_info[i]);</highlight></codeline>
<codeline lineno="738"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="739"><highlight class="normal"></highlight></codeline>
<codeline lineno="740"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>that<sp/>chunk<sp/>feerates<sp/>are<sp/>monotonically<sp/>non-increasing.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="741"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>1;<sp/>i<sp/>&lt;<sp/>chunking.size();<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="742"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!(chunking[i]<sp/>&gt;&gt;<sp/>chunking[i<sp/>-<sp/>1]));</highlight></codeline>
<codeline lineno="743"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="744"><highlight class="normal"></highlight></codeline>
<codeline lineno="745"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Naively<sp/>recompute<sp/>the<sp/>chunks<sp/>(each<sp/>is<sp/>the<sp/>highest-feerate<sp/>prefix<sp/>of<sp/>what<sp/>remains).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="746"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>todo<sp/>=<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a700dd1176f1aa1e6f3b2202fc0377dbe" kindref="member">Positions</ref>();</highlight></codeline>
<codeline lineno="747"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>[chunk_set,<sp/>chunk_feerate]<sp/>:<sp/>chunking_info)<sp/>{</highlight></codeline>
<codeline lineno="748"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(todo.Any());</highlight></codeline>
<codeline lineno="749"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structcluster__linearize_1_1_set_info" kindref="compound">SetInfo&lt;TestBitSet&gt;</ref><sp/>accumulator,<sp/>best;</highlight></codeline>
<codeline lineno="750"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(<ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>idx<sp/>:<sp/>linearization)<sp/>{</highlight></codeline>
<codeline lineno="751"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(todo[idx])<sp/>{</highlight></codeline>
<codeline lineno="752"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>accumulator.<ref refid="structcluster__linearize_1_1_set_info_1a2fe099d57c1ad8eeabe2c20933e4fd06" kindref="member">Set</ref>(depgraph,<sp/>idx);</highlight></codeline>
<codeline lineno="753"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(best.<ref refid="structcluster__linearize_1_1_set_info_1a1d8fb318f45e11d349ee4ea1c7019abe" kindref="member">feerate</ref>.<ref refid="struct_fee_frac_1a43a51a0b54bb8a19b68ff5f09d861b3d" kindref="member">IsEmpty</ref>()<sp/>||<sp/>accumulator.<ref refid="structcluster__linearize_1_1_set_info_1a1d8fb318f45e11d349ee4ea1c7019abe" kindref="member">feerate</ref><sp/>&gt;&gt;<sp/>best.<ref refid="structcluster__linearize_1_1_set_info_1a1d8fb318f45e11d349ee4ea1c7019abe" kindref="member">feerate</ref>)<sp/>{</highlight></codeline>
<codeline lineno="754"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>best<sp/>=<sp/>accumulator;</highlight></codeline>
<codeline lineno="755"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="756"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="757"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="758"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(chunk_feerate<sp/>==<sp/>best.<ref refid="structcluster__linearize_1_1_set_info_1a1d8fb318f45e11d349ee4ea1c7019abe" kindref="member">feerate</ref>);</highlight></codeline>
<codeline lineno="759"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(chunk_set<sp/>==<sp/>best.<ref refid="structcluster__linearize_1_1_set_info_1a09dffca136fb2eda02e4010634af341d" kindref="member">transactions</ref>);</highlight></codeline>
<codeline lineno="760"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(best.<ref refid="structcluster__linearize_1_1_set_info_1a09dffca136fb2eda02e4010634af341d" kindref="member">transactions</ref>.IsSubsetOf(todo));</highlight></codeline>
<codeline lineno="761"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>todo<sp/>-=<sp/>best.<ref refid="structcluster__linearize_1_1_set_info_1a09dffca136fb2eda02e4010634af341d" kindref="member">transactions</ref>;</highlight></codeline>
<codeline lineno="762"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="763"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(todo.None());</highlight></codeline>
<codeline lineno="764"><highlight class="normal">}</highlight></codeline>
<codeline lineno="765"><highlight class="normal"></highlight></codeline>
<codeline lineno="766"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>MAX_SIMPLE_ITERATIONS<sp/>=<sp/>300000;</highlight></codeline>
<codeline lineno="767"><highlight class="normal"></highlight></codeline>
<codeline lineno="768"><highlight class="normal"><ref refid="fuzz_8h_1a1b5a7b9b93ade1576569510908cc4bb9" kindref="member">FUZZ_TARGET</ref>(clusterlin_simple_finder)</highlight></codeline>
<codeline lineno="769"><highlight class="normal">{</highlight></codeline>
<codeline lineno="770"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>that<sp/>SimpleCandidateFinder<sp/>works<sp/>as<sp/>expected<sp/>by<sp/>sanity<sp/>checking<sp/>the<sp/>results</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="771"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>comparing<sp/>them<sp/>(if<sp/>claimed<sp/>to<sp/>be<sp/>optimal)<sp/>against<sp/>the<sp/>sets<sp/>found<sp/>by</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="772"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ExhaustiveCandidateFinder.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="773"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="774"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note<sp/>that<sp/>SimpleCandidateFinder<sp/>is<sp/>only<sp/>used<sp/>in<sp/>tests;<sp/>the<sp/>purpose<sp/>of<sp/>this<sp/>fuzz<sp/>test<sp/>is<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="775"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>establish<sp/>confidence<sp/>in<sp/>SimpleCandidateFinder,<sp/>so<sp/>that<sp/>it<sp/>can<sp/>be<sp/>used<sp/>in<sp/>SimpleLinearize,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="776"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>which<sp/>is<sp/>then<sp/>used<sp/>to<sp/>test<sp/>Linearize<sp/>below.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="777"><highlight class="normal"></highlight></codeline>
<codeline lineno="778"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Retrieve<sp/>a<sp/>depgraph<sp/>from<sp/>the<sp/>fuzz<sp/>input.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="779"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_span_reader" kindref="compound">SpanReader</ref><sp/>reader(buffer);</highlight></codeline>
<codeline lineno="780"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;TestBitSet&gt;</ref><sp/>depgraph;</highlight></codeline>
<codeline lineno="781"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="782"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reader<sp/>&gt;&gt;<sp/>Using&lt;DepGraphFormatter&gt;(depgraph);</highlight></codeline>
<codeline lineno="783"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::ios_base::failure&amp;)<sp/>{}</highlight></codeline>
<codeline lineno="784"><highlight class="normal"></highlight></codeline>
<codeline lineno="785"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Instantiate<sp/>the<sp/>SimpleCandidateFinder<sp/>to<sp/>be<sp/>tested,<sp/>and<sp/>the<sp/>ExhaustiveCandidateFinder<sp/>it<sp/>is</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="786"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>being<sp/>tested<sp/>against.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="787"><highlight class="normal"><sp/><sp/><sp/><sp/>SimpleCandidateFinder<sp/>smp_finder(depgraph);</highlight></codeline>
<codeline lineno="788"><highlight class="normal"><sp/><sp/><sp/><sp/>ExhaustiveCandidateFinder<sp/>exh_finder(depgraph);</highlight></codeline>
<codeline lineno="789"><highlight class="normal"></highlight></codeline>
<codeline lineno="790"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>todo<sp/>=<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a700dd1176f1aa1e6f3b2202fc0377dbe" kindref="member">Positions</ref>();</highlight></codeline>
<codeline lineno="791"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(todo.Any())<sp/>{</highlight></codeline>
<codeline lineno="792"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!smp_finder.AllDone());</highlight></codeline>
<codeline lineno="793"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!exh_finder.AllDone());</highlight></codeline>
<codeline lineno="794"><highlight class="normal"></highlight></codeline>
<codeline lineno="795"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Call<sp/>SimpleCandidateFinder.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="796"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>[found,<sp/>iterations_done]<sp/>=<sp/>smp_finder.FindCandidateSet(MAX_SIMPLE_ITERATIONS);</highlight></codeline>
<codeline lineno="797"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>optimal<sp/>=<sp/>(iterations_done<sp/>!=<sp/>MAX_SIMPLE_ITERATIONS);</highlight></codeline>
<codeline lineno="798"><highlight class="normal"></highlight></codeline>
<codeline lineno="799"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Sanity<sp/>check<sp/>the<sp/>result.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="800"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(iterations_done<sp/>&lt;=<sp/>MAX_SIMPLE_ITERATIONS);</highlight></codeline>
<codeline lineno="801"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(found.transactions.Any());</highlight></codeline>
<codeline lineno="802"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(found.transactions.IsSubsetOf(todo));</highlight></codeline>
<codeline lineno="803"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a401a234c54f61fb05821094ad38f24d5" kindref="member">FeeRate</ref>(found.transactions)<sp/>==<sp/>found.feerate);</highlight></codeline>
<codeline lineno="804"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>that<sp/>it<sp/>is<sp/>topologically<sp/>valid.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="805"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>i<sp/>:<sp/>found.transactions)<sp/>{</highlight></codeline>
<codeline lineno="806"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(found.transactions.IsSupersetOf(depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1afc3ed1d0c57b777822863b057012f993" kindref="member">Ancestors</ref>(i)<sp/>&amp;<sp/>todo));</highlight></codeline>
<codeline lineno="807"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="808"><highlight class="normal"></highlight></codeline>
<codeline lineno="809"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>At<sp/>most<sp/>2^(N-1)<sp/>iterations<sp/>can<sp/>be<sp/>required:<sp/>the<sp/>number<sp/>of<sp/>non-empty<sp/>connected<sp/>subsets<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="810"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>graph<sp/>with<sp/>N<sp/>transactions<sp/>can<sp/>have.<sp/>If<sp/>MAX_SIMPLE_ITERATIONS<sp/>exceeds<sp/>this<sp/>number,<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="811"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>result<sp/>is<sp/>necessarily<sp/>optimal.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="812"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(iterations_done<sp/>&lt;=<sp/>(uint64_t{1}<sp/>&lt;&lt;<sp/>(todo.Count()<sp/>-<sp/>1)));</highlight></codeline>
<codeline lineno="813"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(MAX_SIMPLE_ITERATIONS<sp/>&gt;<sp/>(uint64_t{1}<sp/>&lt;&lt;<sp/>(todo.Count()<sp/>-<sp/>1)))<sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(optimal);</highlight></codeline>
<codeline lineno="814"><highlight class="normal"></highlight></codeline>
<codeline lineno="815"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>SimpleCandidateFinder<sp/>only<sp/>finds<sp/>connected<sp/>sets.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="816"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1aecc46909fd08c461aeab4cd0807509d1" kindref="member">IsConnected</ref>(found.transactions));</highlight></codeline>
<codeline lineno="817"><highlight class="normal"></highlight></codeline>
<codeline lineno="818"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Perform<sp/>further<sp/>quality<sp/>checks<sp/>only<sp/>if<sp/>SimpleCandidateFinder<sp/>claims<sp/>an<sp/>optimal<sp/>result.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="819"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(optimal)<sp/>{</highlight></codeline>
<codeline lineno="820"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(todo.Count()<sp/>&lt;=<sp/>12)<sp/>{</highlight></codeline>
<codeline lineno="821"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compare<sp/>with<sp/>ExhaustiveCandidateFinder.<sp/>This<sp/>quickly<sp/>gets<sp/>computationally</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="822"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>expensive<sp/>for<sp/>large<sp/>clusters<sp/>(O(2^n)),<sp/>so<sp/>only<sp/>do<sp/>it<sp/>for<sp/>sufficiently<sp/>small<sp/>ones.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="823"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>exhaustive<sp/>=<sp/>exh_finder.FindCandidateSet();</highlight></codeline>
<codeline lineno="824"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(exhaustive.feerate<sp/>==<sp/>found.feerate);</highlight></codeline>
<codeline lineno="825"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="826"><highlight class="normal"></highlight></codeline>
<codeline lineno="827"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compare<sp/>with<sp/>a<sp/>non-empty<sp/>topological<sp/>set<sp/>read<sp/>from<sp/>the<sp/>fuzz<sp/>input<sp/>(comparing<sp/>with<sp/>an</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="828"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>empty<sp/>set<sp/>is<sp/>not<sp/>interesting).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="829"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>read_topo<sp/>=<sp/>ReadTopologicalSet(depgraph,<sp/>todo,<sp/>reader,<sp/></highlight><highlight class="comment">/*non_empty=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="830"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(found.feerate<sp/>&gt;=<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a401a234c54f61fb05821094ad38f24d5" kindref="member">FeeRate</ref>(read_topo));</highlight></codeline>
<codeline lineno="831"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="832"><highlight class="normal"></highlight></codeline>
<codeline lineno="833"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Find<sp/>a<sp/>non-empty<sp/>topologically<sp/>valid<sp/>subset<sp/>of<sp/>transactions<sp/>to<sp/>remove<sp/>from<sp/>the<sp/>graph.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="834"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Using<sp/>an<sp/>empty<sp/>set<sp/>would<sp/>mean<sp/>the<sp/>next<sp/>iteration<sp/>is<sp/>identical<sp/>to<sp/>the<sp/>current<sp/>one,<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="835"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>could<sp/>cause<sp/>an<sp/>infinite<sp/>loop.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="836"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>del_set<sp/>=<sp/>ReadTopologicalSet(depgraph,<sp/>todo,<sp/>reader,<sp/></highlight><highlight class="comment">/*non_empty=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="837"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>todo<sp/>-=<sp/>del_set;</highlight></codeline>
<codeline lineno="838"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>smp_finder.MarkDone(del_set);</highlight></codeline>
<codeline lineno="839"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>exh_finder.MarkDone(del_set);</highlight></codeline>
<codeline lineno="840"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="841"><highlight class="normal"></highlight></codeline>
<codeline lineno="842"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(smp_finder.AllDone());</highlight></codeline>
<codeline lineno="843"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(exh_finder.AllDone());</highlight></codeline>
<codeline lineno="844"><highlight class="normal">}</highlight></codeline>
<codeline lineno="845"><highlight class="normal"></highlight></codeline>
<codeline lineno="846"><highlight class="normal"><ref refid="fuzz_8h_1a1b5a7b9b93ade1576569510908cc4bb9" kindref="member">FUZZ_TARGET</ref>(clusterlin_simple_linearize)</highlight></codeline>
<codeline lineno="847"><highlight class="normal">{</highlight></codeline>
<codeline lineno="848"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>the<sp/>behavior<sp/>of<sp/>SimpleLinearize().<sp/>Note<sp/>that<sp/>SimpleLinearize<sp/>is<sp/>only<sp/>used<sp/>in<sp/>tests;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="849"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>purpose<sp/>of<sp/>this<sp/>fuzz<sp/>test<sp/>is<sp/>to<sp/>establish<sp/>confidence<sp/>in<sp/>SimpleLinearize,<sp/>so<sp/>that<sp/>it<sp/>can</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="850"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>be<sp/>used<sp/>to<sp/>test<sp/>the<sp/>real<sp/>Linearize<sp/>function<sp/>in<sp/>the<sp/>fuzz<sp/>test<sp/>below.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="851"><highlight class="normal"></highlight></codeline>
<codeline lineno="852"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Retrieve<sp/>an<sp/>iteration<sp/>count<sp/>and<sp/>a<sp/>depgraph<sp/>from<sp/>the<sp/>fuzz<sp/>input.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="853"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_span_reader" kindref="compound">SpanReader</ref><sp/>reader(buffer);</highlight></codeline>
<codeline lineno="854"><highlight class="normal"><sp/><sp/><sp/><sp/>uint64_t<sp/>iter_count{0};</highlight></codeline>
<codeline lineno="855"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;TestBitSet&gt;</ref><sp/>depgraph;</highlight></codeline>
<codeline lineno="856"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="857"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reader<sp/>&gt;&gt;<sp/><ref refid="serialize_8h_1a1383f2a4c22ffaeba9b2924d90459f76" kindref="member">VARINT</ref>(iter_count)<sp/>&gt;&gt;<sp/>Using&lt;DepGraphFormatter&gt;(depgraph);</highlight></codeline>
<codeline lineno="858"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::ios_base::failure&amp;)<sp/>{}</highlight></codeline>
<codeline lineno="859"><highlight class="normal"><sp/><sp/><sp/><sp/>iter_count<sp/>%=<sp/>MAX_SIMPLE_ITERATIONS;</highlight></codeline>
<codeline lineno="860"><highlight class="normal"></highlight></codeline>
<codeline lineno="861"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Invoke<sp/>SimpleLinearize().</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="862"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>[linearization,<sp/>optimal]<sp/>=<sp/>SimpleLinearize(depgraph,<sp/>iter_count);</highlight></codeline>
<codeline lineno="863"><highlight class="normal"><sp/><sp/><sp/><sp/>SanityCheck(depgraph,<sp/>linearization);</highlight></codeline>
<codeline lineno="864"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>simple_chunking<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph,<sp/>linearization);</highlight></codeline>
<codeline lineno="865"><highlight class="normal"></highlight></codeline>
<codeline lineno="866"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>iteration<sp/>count<sp/>is<sp/>sufficiently<sp/>high,<sp/>an<sp/>optimal<sp/>linearization<sp/>must<sp/>be<sp/>found.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="867"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>SimpleLinearize<sp/>on<sp/>k<sp/>transactions<sp/>can<sp/>take<sp/>up<sp/>to<sp/>2^(k-1)<sp/>iterations<sp/>(one<sp/>per<sp/>non-empty</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="868"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>connected<sp/>topologically<sp/>valid<sp/>subset),<sp/>which<sp/>sums<sp/>over<sp/>k=1..n<sp/>to<sp/>(2^n)-1.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="869"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>n<sp/>=<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1ae3cec0644fd4e8562d14b99badc3c91e" kindref="member">TxCount</ref>();</highlight></codeline>
<codeline lineno="870"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(n<sp/>&lt;=<sp/>63<sp/>&amp;&amp;<sp/>(iter_count<sp/>&gt;&gt;<sp/>n))<sp/>{</highlight></codeline>
<codeline lineno="871"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(optimal);</highlight></codeline>
<codeline lineno="872"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="873"><highlight class="normal"></highlight></codeline>
<codeline lineno="874"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>SimpleLinearize<sp/>claims<sp/>optimal<sp/>result,<sp/>and<sp/>the<sp/>cluster<sp/>is<sp/>sufficiently<sp/>small<sp/>(there<sp/>are</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="875"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>n!<sp/>linearizations),<sp/>test<sp/>that<sp/>the<sp/>result<sp/>is<sp/>as<sp/>good<sp/>as<sp/>every<sp/>valid<sp/>linearization.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="876"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(optimal<sp/>&amp;&amp;<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1ae3cec0644fd4e8562d14b99badc3c91e" kindref="member">TxCount</ref>()<sp/>&lt;=<sp/>8)<sp/>{</highlight></codeline>
<codeline lineno="877"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>exh_linearization<sp/>=<sp/>ExhaustiveLinearize(depgraph);</highlight></codeline>
<codeline lineno="878"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>exh_chunking<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph,<sp/>exh_linearization);</highlight></codeline>
<codeline lineno="879"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>cmp<sp/>=<sp/><ref refid="util_2feefrac_8cpp_1ac6b51471a8ec142402968632e02bbfe5" kindref="member">CompareChunks</ref>(simple_chunking,<sp/>exh_chunking);</highlight></codeline>
<codeline lineno="880"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(cmp<sp/>==<sp/>0);</highlight></codeline>
<codeline lineno="881"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(simple_chunking.size()<sp/>==<sp/>exh_chunking.size());</highlight></codeline>
<codeline lineno="882"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="883"><highlight class="normal"></highlight></codeline>
<codeline lineno="884"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(optimal)<sp/>{</highlight></codeline>
<codeline lineno="885"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compare<sp/>with<sp/>a<sp/>linearization<sp/>read<sp/>from<sp/>the<sp/>fuzz<sp/>input.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="886"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>read<sp/>=<sp/>ReadLinearization(depgraph,<sp/>reader);</highlight></codeline>
<codeline lineno="887"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>read_chunking<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph,<sp/>read);</highlight></codeline>
<codeline lineno="888"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>cmp<sp/>=<sp/><ref refid="util_2feefrac_8cpp_1ac6b51471a8ec142402968632e02bbfe5" kindref="member">CompareChunks</ref>(simple_chunking,<sp/>read_chunking);</highlight></codeline>
<codeline lineno="889"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(cmp<sp/>&gt;=<sp/>0);</highlight></codeline>
<codeline lineno="890"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="891"><highlight class="normal">}</highlight></codeline>
<codeline lineno="892"><highlight class="normal"></highlight></codeline>
<codeline lineno="893"><highlight class="normal"><ref refid="fuzz_8h_1a1b5a7b9b93ade1576569510908cc4bb9" kindref="member">FUZZ_TARGET</ref>(clusterlin_sfl)</highlight></codeline>
<codeline lineno="894"><highlight class="normal">{</highlight></codeline>
<codeline lineno="895"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>the<sp/>individual<sp/>steps<sp/>of<sp/>the<sp/>SFL<sp/>algorithm.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="896"><highlight class="normal"></highlight></codeline>
<codeline lineno="897"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_span_reader" kindref="compound">SpanReader</ref><sp/>reader(buffer);</highlight></codeline>
<codeline lineno="898"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;TestBitSet&gt;</ref><sp/>depgraph;</highlight></codeline>
<codeline lineno="899"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t<sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref>{1};</highlight></codeline>
<codeline lineno="900"><highlight class="normal"><sp/><sp/><sp/><sp/>uint64_t<sp/>rng_seed{0};</highlight></codeline>
<codeline lineno="901"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="902"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reader<sp/>&gt;&gt;<sp/>rng_seed<sp/>&gt;&gt;<sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref><sp/>&gt;&gt;<sp/>Using&lt;DepGraphFormatter&gt;(depgraph);</highlight></codeline>
<codeline lineno="903"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::ios_base::failure&amp;)<sp/>{}</highlight></codeline>
<codeline lineno="904"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1ae3cec0644fd4e8562d14b99badc3c91e" kindref="member">TxCount</ref>()<sp/>&lt;=<sp/>1)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="905"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_insecure_random_context" kindref="compound">InsecureRandomContext</ref><sp/>rng(rng_seed);</highlight></codeline>
<codeline lineno="907"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>make_connected<sp/>=<sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref><sp/>&amp;<sp/>1;</highlight></codeline>
<codeline lineno="909"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>load_linearization<sp/>=<sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref><sp/>&amp;<sp/>2;</highlight></codeline>
<codeline lineno="911"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>load_topological<sp/>=<sp/>load_linearization<sp/>&amp;&amp;<sp/>(<ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref><sp/>&amp;<sp/>4);</highlight></codeline>
<codeline lineno="912"><highlight class="normal"></highlight></codeline>
<codeline lineno="913"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Initialize<sp/>SFL<sp/>state.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="914"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(make_connected)<sp/>MakeConnected(depgraph);</highlight></codeline>
<codeline lineno="915"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classcluster__linearize_1_1_spanning_forest_state" kindref="compound">SpanningForestState</ref><sp/>sfl(depgraph,<sp/>rng.rand64());</highlight></codeline>
<codeline lineno="916"><highlight class="normal"></highlight></codeline>
<codeline lineno="917"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Function<sp/>to<sp/>test<sp/>the<sp/>state.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="918"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;FeeFrac&gt;<sp/>last_diagram;</highlight></codeline>
<codeline lineno="919"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/><ref refid="unit__test_8h_1afa1caae414600bd4fe17e0d90f830b0c" kindref="member">test_fn</ref><sp/>=<sp/>[&amp;](</highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>is_optimal<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="920"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rng.randbits(4)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="921"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Perform<sp/>sanity<sp/>checks<sp/>from<sp/>time<sp/>to<sp/>time<sp/>(too<sp/>computationally<sp/>expensive<sp/>to<sp/>do<sp/>after</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="922"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>every<sp/>step).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="923"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sfl.SanityCheck(depgraph);</highlight></codeline>
<codeline lineno="924"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="925"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>diagram<sp/>=<sp/>sfl.GetDiagram();</highlight></codeline>
<codeline lineno="926"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rng.randbits(4)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="927"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>that<sp/>the<sp/>diagram<sp/>of<sp/>GetLinearization()<sp/>is<sp/>at<sp/>least<sp/>as<sp/>good<sp/>as<sp/>GetDiagram(),</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="928"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>from<sp/>time<sp/>to<sp/>time.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="929"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>lin<sp/>=<sp/>sfl.GetLinearization();</highlight></codeline>
<codeline lineno="930"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>lin_diagram<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph,<sp/>lin);</highlight></codeline>
<codeline lineno="931"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>cmp_lin<sp/>=<sp/><ref refid="util_2feefrac_8cpp_1ac6b51471a8ec142402968632e02bbfe5" kindref="member">CompareChunks</ref>(lin_diagram,<sp/>diagram);</highlight></codeline>
<codeline lineno="932"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(cmp_lin<sp/>&gt;=<sp/>0);</highlight></codeline>
<codeline lineno="933"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we&apos;re<sp/>in<sp/>an<sp/>allegedly<sp/>optimal<sp/>state,<sp/>they<sp/>must<sp/>match.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="934"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(is_optimal)<sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(cmp_lin<sp/>==<sp/>0);</highlight></codeline>
<codeline lineno="935"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="936"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>that<sp/>subsequent<sp/>calls<sp/>to<sp/>GetDiagram()<sp/>never<sp/>get<sp/>worse/incomparable.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="937"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!last_diagram.empty())<sp/>{</highlight></codeline>
<codeline lineno="938"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>cmp<sp/>=<sp/><ref refid="util_2feefrac_8cpp_1ac6b51471a8ec142402968632e02bbfe5" kindref="member">CompareChunks</ref>(diagram,<sp/>last_diagram);</highlight></codeline>
<codeline lineno="939"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(cmp<sp/>&gt;=<sp/>0);</highlight></codeline>
<codeline lineno="940"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="941"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>last_diagram<sp/>=<sp/>std::move(diagram);</highlight></codeline>
<codeline lineno="942"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="943"><highlight class="normal"></highlight></codeline>
<codeline lineno="944"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(load_linearization)<sp/>{</highlight></codeline>
<codeline lineno="945"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>input_lin<sp/>=<sp/>ReadLinearization(depgraph,<sp/>reader,<sp/>load_topological);</highlight></codeline>
<codeline lineno="946"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sfl.LoadLinearization(input_lin);</highlight></codeline>
<codeline lineno="947"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(load_topological)<sp/>{</highlight></codeline>
<codeline lineno="948"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>diagram<sp/>of<sp/>the<sp/>loaded<sp/>linearization<sp/>forms<sp/>an<sp/>initial<sp/>lower<sp/>bound<sp/>on<sp/>future</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="949"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>diagrams.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="950"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>last_diagram<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph,<sp/>input_lin);</highlight></codeline>
<codeline lineno="951"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="952"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>input<sp/>linearization<sp/>may<sp/>have<sp/>been<sp/>non-topological,<sp/>so<sp/>invoke<sp/>MakeTopological<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="953"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>fix<sp/>it<sp/>still.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="954"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sfl.MakeTopological();</highlight></codeline>
<codeline lineno="955"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="956"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="957"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Invoke<sp/>MakeTopological<sp/>to<sp/>create<sp/>an<sp/>initial<sp/>from-scratch<sp/>topological<sp/>state.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="958"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sfl.MakeTopological();</highlight></codeline>
<codeline lineno="959"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="960"><highlight class="normal"></highlight></codeline>
<codeline lineno="961"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Loop<sp/>until<sp/>optimal.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="962"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="unit__test_8h_1afa1caae414600bd4fe17e0d90f830b0c" kindref="member">test_fn</ref>();</highlight></codeline>
<codeline lineno="963"><highlight class="normal"><sp/><sp/><sp/><sp/>sfl.StartOptimizing();</highlight></codeline>
<codeline lineno="964"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">true</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="965"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="unit__test_8h_1afa1caae414600bd4fe17e0d90f830b0c" kindref="member">test_fn</ref>();</highlight></codeline>
<codeline lineno="966"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sfl.OptimizeStep())<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="967"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="968"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="unit__test_8h_1afa1caae414600bd4fe17e0d90f830b0c" kindref="member">test_fn</ref>(</highlight><highlight class="comment">/*is_optimal=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="969"><highlight class="normal"></highlight></codeline>
<codeline lineno="970"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>that<sp/>optimality<sp/>is<sp/>reached<sp/>within<sp/>an<sp/>expected<sp/>amount<sp/>of<sp/>work.<sp/>This<sp/>protects<sp/>against</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="971"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>hypothetical<sp/>bugs<sp/>that<sp/>hugely<sp/>increase<sp/>the<sp/>amount<sp/>of<sp/>work<sp/>needed<sp/>to<sp/>reach<sp/>optimality.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="972"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(sfl.GetCost()<sp/>&lt;=<sp/>MaxOptimalLinearizationIters(depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1ae3cec0644fd4e8562d14b99badc3c91e" kindref="member">TxCount</ref>()));</highlight></codeline>
<codeline lineno="973"><highlight class="normal"></highlight></codeline>
<codeline lineno="974"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>result<sp/>must<sp/>be<sp/>as<sp/>good<sp/>as<sp/>SimpleLinearize.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="975"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>[simple_linearization,<sp/>simple_optimal]<sp/>=<sp/>SimpleLinearize(depgraph,<sp/>MAX_SIMPLE_ITERATIONS<sp/>/<sp/>10);</highlight></codeline>
<codeline lineno="976"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>simple_diagram<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph,<sp/>simple_linearization);</highlight></codeline>
<codeline lineno="977"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>simple_cmp<sp/>=<sp/><ref refid="util_2feefrac_8cpp_1ac6b51471a8ec142402968632e02bbfe5" kindref="member">CompareChunks</ref>(last_diagram,<sp/>simple_diagram);</highlight></codeline>
<codeline lineno="978"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(simple_cmp<sp/>&gt;=<sp/>0);</highlight></codeline>
<codeline lineno="979"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(simple_optimal)<sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(simple_cmp<sp/>==<sp/>0);</highlight></codeline>
<codeline lineno="980"><highlight class="normal"></highlight></codeline>
<codeline lineno="981"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>can<sp/>compare<sp/>with<sp/>any<sp/>arbitrary<sp/>linearization,<sp/>and<sp/>the<sp/>diagram<sp/>must<sp/>be<sp/>at<sp/>least<sp/>as<sp/>good<sp/>as</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="982"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>each.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="983"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>10;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="984"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>read_lin<sp/>=<sp/>ReadLinearization(depgraph,<sp/>reader);</highlight></codeline>
<codeline lineno="985"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>read_diagram<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph,<sp/>read_lin);</highlight></codeline>
<codeline lineno="986"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>cmp<sp/>=<sp/><ref refid="util_2feefrac_8cpp_1ac6b51471a8ec142402968632e02bbfe5" kindref="member">CompareChunks</ref>(last_diagram,<sp/>read_diagram);</highlight></codeline>
<codeline lineno="987"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(cmp<sp/>&gt;=<sp/>0);</highlight></codeline>
<codeline lineno="988"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="989"><highlight class="normal">}</highlight></codeline>
<codeline lineno="990"><highlight class="normal"></highlight></codeline>
<codeline lineno="991"><highlight class="normal"><ref refid="fuzz_8h_1a1b5a7b9b93ade1576569510908cc4bb9" kindref="member">FUZZ_TARGET</ref>(clusterlin_linearize)</highlight></codeline>
<codeline lineno="992"><highlight class="normal">{</highlight></codeline>
<codeline lineno="993"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>the<sp/>behavior<sp/>of<sp/>Linearize().</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="994"><highlight class="normal"></highlight></codeline>
<codeline lineno="995"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Retrieve<sp/>an<sp/>RNG<sp/>seed,<sp/>an<sp/>iteration<sp/>count,<sp/>a<sp/>depgraph,<sp/>and<sp/>whether<sp/>to<sp/>make<sp/>it<sp/>connected<sp/>from</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="996"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>fuzz<sp/>input.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="997"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_span_reader" kindref="compound">SpanReader</ref><sp/>reader(buffer);</highlight></codeline>
<codeline lineno="998"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;TestBitSet&gt;</ref><sp/>depgraph;</highlight></codeline>
<codeline lineno="999"><highlight class="normal"><sp/><sp/><sp/><sp/>uint64_t<sp/>rng_seed{0};</highlight></codeline>
<codeline lineno="1000"><highlight class="normal"><sp/><sp/><sp/><sp/>uint64_t<sp/>iter_count{0};</highlight></codeline>
<codeline lineno="1001"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t<sp/>make_connected{1};</highlight></codeline>
<codeline lineno="1002"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1003"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reader<sp/>&gt;&gt;<sp/><ref refid="serialize_8h_1a1383f2a4c22ffaeba9b2924d90459f76" kindref="member">VARINT</ref>(iter_count)<sp/>&gt;&gt;<sp/>Using&lt;DepGraphFormatter&gt;(depgraph)<sp/>&gt;&gt;<sp/>rng_seed<sp/>&gt;&gt;<sp/>make_connected;</highlight></codeline>
<codeline lineno="1004"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::ios_base::failure&amp;)<sp/>{}</highlight></codeline>
<codeline lineno="1005"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>most<sp/>complicated<sp/>graphs<sp/>are<sp/>connected<sp/>ones<sp/>(other<sp/>ones<sp/>just<sp/>split<sp/>up).<sp/>Optionally<sp/>force</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1006"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>graph<sp/>to<sp/>be<sp/>connected.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1007"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(make_connected)<sp/>MakeConnected(depgraph);</highlight></codeline>
<codeline lineno="1008"><highlight class="normal"></highlight></codeline>
<codeline lineno="1009"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Optionally<sp/>construct<sp/>an<sp/>old<sp/>linearization<sp/>for<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1010"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;DepGraphIndex&gt;<sp/>old_linearization;</highlight></codeline>
<codeline lineno="1011"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="1012"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint8_t<sp/>have_old_linearization{0};</highlight></codeline>
<codeline lineno="1013"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1014"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reader<sp/>&gt;&gt;<sp/>have_old_linearization;</highlight></codeline>
<codeline lineno="1015"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal">(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::ios_base::failure&amp;)<sp/>{}</highlight></codeline>
<codeline lineno="1016"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(have_old_linearization<sp/>&amp;<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="1017"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>old_linearization<sp/>=<sp/>ReadLinearization(depgraph,<sp/>reader);</highlight></codeline>
<codeline lineno="1018"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SanityCheck(depgraph,<sp/>old_linearization);</highlight></codeline>
<codeline lineno="1019"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1020"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1021"><highlight class="normal"></highlight></codeline>
<codeline lineno="1022"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Invoke<sp/>Linearize().</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1023"><highlight class="normal"><sp/><sp/><sp/><sp/>iter_count<sp/>&amp;=<sp/>0x7ffff;</highlight></codeline>
<codeline lineno="1024"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>[linearization,<sp/>optimal,<sp/>cost]<sp/>=<sp/><ref refid="namespacecluster__linearize_1ad7fec78514892bfc4213dec2180ea5fa" kindref="member">Linearize</ref>(depgraph,<sp/>iter_count,<sp/>rng_seed,<sp/>old_linearization);</highlight></codeline>
<codeline lineno="1025"><highlight class="normal"><sp/><sp/><sp/><sp/>SanityCheck(depgraph,<sp/>linearization);</highlight></codeline>
<codeline lineno="1026"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>chunking<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph,<sp/>linearization);</highlight></codeline>
<codeline lineno="1027"><highlight class="normal"></highlight></codeline>
<codeline lineno="1028"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Linearization<sp/>must<sp/>always<sp/>be<sp/>as<sp/>good<sp/>as<sp/>the<sp/>old<sp/>one,<sp/>if<sp/>provided.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1029"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!old_linearization.empty())<sp/>{</highlight></codeline>
<codeline lineno="1030"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>old_chunking<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph,<sp/>old_linearization);</highlight></codeline>
<codeline lineno="1031"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>cmp<sp/>=<sp/><ref refid="util_2feefrac_8cpp_1ac6b51471a8ec142402968632e02bbfe5" kindref="member">CompareChunks</ref>(chunking,<sp/>old_chunking);</highlight></codeline>
<codeline lineno="1032"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(cmp<sp/>&gt;=<sp/>0);</highlight></codeline>
<codeline lineno="1033"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1034"><highlight class="normal"></highlight></codeline>
<codeline lineno="1035"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>iteration<sp/>count<sp/>is<sp/>sufficiently<sp/>high,<sp/>an<sp/>optimal<sp/>linearization<sp/>must<sp/>be<sp/>found.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1036"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(iter_count<sp/>&gt;<sp/>MaxOptimalLinearizationIters(depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1ae3cec0644fd4e8562d14b99badc3c91e" kindref="member">TxCount</ref>()))<sp/>{</highlight></codeline>
<codeline lineno="1037"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(optimal);</highlight></codeline>
<codeline lineno="1038"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1039"><highlight class="normal"></highlight></codeline>
<codeline lineno="1040"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>Linearize<sp/>claims<sp/>optimal<sp/>result,<sp/>run<sp/>quality<sp/>tests.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1041"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(optimal)<sp/>{</highlight></codeline>
<codeline lineno="1042"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>It<sp/>must<sp/>be<sp/>as<sp/>good<sp/>as<sp/>SimpleLinearize.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1043"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>[simple_linearization,<sp/>simple_optimal]<sp/>=<sp/>SimpleLinearize(depgraph,<sp/>MAX_SIMPLE_ITERATIONS);</highlight></codeline>
<codeline lineno="1044"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SanityCheck(depgraph,<sp/>simple_linearization);</highlight></codeline>
<codeline lineno="1045"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>simple_chunking<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph,<sp/>simple_linearization);</highlight></codeline>
<codeline lineno="1046"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>cmp<sp/>=<sp/><ref refid="util_2feefrac_8cpp_1ac6b51471a8ec142402968632e02bbfe5" kindref="member">CompareChunks</ref>(chunking,<sp/>simple_chunking);</highlight></codeline>
<codeline lineno="1047"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(cmp<sp/>&gt;=<sp/>0);</highlight></codeline>
<codeline lineno="1048"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>SimpleLinearize<sp/>finds<sp/>the<sp/>optimal<sp/>result<sp/>too,<sp/>they<sp/>must<sp/>be<sp/>equal<sp/>(if<sp/>not,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1049"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>SimpleLinearize<sp/>is<sp/>broken).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1050"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(simple_optimal)<sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(cmp<sp/>==<sp/>0);</highlight></codeline>
<codeline lineno="1051"><highlight class="normal"></highlight></codeline>
<codeline lineno="1052"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Temporarily<sp/>disabled,<sp/>as<sp/>Linearize()<sp/>currently<sp/>does<sp/>not<sp/>guarantee<sp/>minimal<sp/>chunks,<sp/>even</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1053"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>when<sp/>it<sp/>reports<sp/>an<sp/>optimal<sp/>result.<sp/>This<sp/>will<sp/>be<sp/>re-introduced<sp/>in<sp/>a<sp/>later<sp/>commit.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1054"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1055"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>//<sp/>If<sp/>simple_chunking<sp/>is<sp/>diagram-optimal,<sp/>it<sp/>cannot<sp/>have<sp/>more<sp/>chunks<sp/>than<sp/>chunking<sp/>(as</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1056"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>//<sp/>chunking<sp/>is<sp/>claimed<sp/>to<sp/>be<sp/>optimal,<sp/>which<sp/>implies<sp/>minimal<sp/>chunks).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1057"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>(cmp<sp/>==<sp/>0)<sp/>assert(chunking.size()<sp/>&gt;=<sp/>simple_chunking.size());</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1058"><highlight class="normal"></highlight></codeline>
<codeline lineno="1059"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compare<sp/>with<sp/>a<sp/>linearization<sp/>read<sp/>from<sp/>the<sp/>fuzz<sp/>input.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1060"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>read<sp/>=<sp/>ReadLinearization(depgraph,<sp/>reader);</highlight></codeline>
<codeline lineno="1061"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>read_chunking<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph,<sp/>read);</highlight></codeline>
<codeline lineno="1062"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>cmp_read<sp/>=<sp/><ref refid="util_2feefrac_8cpp_1ac6b51471a8ec142402968632e02bbfe5" kindref="member">CompareChunks</ref>(chunking,<sp/>read_chunking);</highlight></codeline>
<codeline lineno="1063"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(cmp_read<sp/>&gt;=<sp/>0);</highlight></codeline>
<codeline lineno="1064"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1065"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1066"><highlight class="normal"></highlight></codeline>
<codeline lineno="1067"><highlight class="normal"><ref refid="fuzz_8h_1a1b5a7b9b93ade1576569510908cc4bb9" kindref="member">FUZZ_TARGET</ref>(clusterlin_postlinearize)</highlight></codeline>
<codeline lineno="1068"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1069"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>expected<sp/>properties<sp/>of<sp/>PostLinearize()<sp/>on<sp/>arbitrary<sp/>linearizations.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1070"><highlight class="normal"></highlight></codeline>
<codeline lineno="1071"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Retrieve<sp/>a<sp/>depgraph<sp/>from<sp/>the<sp/>fuzz<sp/>input.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1072"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_span_reader" kindref="compound">SpanReader</ref><sp/>reader(buffer);</highlight></codeline>
<codeline lineno="1073"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;TestBitSet&gt;</ref><sp/>depgraph;</highlight></codeline>
<codeline lineno="1074"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1075"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reader<sp/>&gt;&gt;<sp/>Using&lt;DepGraphFormatter&gt;(depgraph);</highlight></codeline>
<codeline lineno="1076"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::ios_base::failure&amp;)<sp/>{}</highlight></codeline>
<codeline lineno="1077"><highlight class="normal"></highlight></codeline>
<codeline lineno="1078"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Retrieve<sp/>a<sp/>linearization<sp/>from<sp/>the<sp/>fuzz<sp/>input.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1079"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;DepGraphIndex&gt;<sp/>linearization;</highlight></codeline>
<codeline lineno="1080"><highlight class="normal"><sp/><sp/><sp/><sp/>linearization<sp/>=<sp/>ReadLinearization(depgraph,<sp/>reader);</highlight></codeline>
<codeline lineno="1081"><highlight class="normal"><sp/><sp/><sp/><sp/>SanityCheck(depgraph,<sp/>linearization);</highlight></codeline>
<codeline lineno="1082"><highlight class="normal"></highlight></codeline>
<codeline lineno="1083"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Produce<sp/>a<sp/>post-processed<sp/>version.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1084"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>post_linearization<sp/>=<sp/>linearization;</highlight></codeline>
<codeline lineno="1085"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespacecluster__linearize_1ab4dfb7a53e485a4f5eac2219e4176a91" kindref="member">PostLinearize</ref>(depgraph,<sp/>post_linearization);</highlight></codeline>
<codeline lineno="1086"><highlight class="normal"><sp/><sp/><sp/><sp/>SanityCheck(depgraph,<sp/>post_linearization);</highlight></codeline>
<codeline lineno="1087"><highlight class="normal"></highlight></codeline>
<codeline lineno="1088"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compare<sp/>diagrams:<sp/>post-linearization<sp/>cannot<sp/>worsen<sp/>anywhere.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1089"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>chunking<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph,<sp/>linearization);</highlight></codeline>
<codeline lineno="1090"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>post_chunking<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph,<sp/>post_linearization);</highlight></codeline>
<codeline lineno="1091"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>cmp<sp/>=<sp/><ref refid="util_2feefrac_8cpp_1ac6b51471a8ec142402968632e02bbfe5" kindref="member">CompareChunks</ref>(post_chunking,<sp/>chunking);</highlight></codeline>
<codeline lineno="1092"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(cmp<sp/>&gt;=<sp/>0);</highlight></codeline>
<codeline lineno="1093"><highlight class="normal"></highlight></codeline>
<codeline lineno="1094"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Run<sp/>again,<sp/>things<sp/>can<sp/>keep<sp/>improving<sp/>(and<sp/>never<sp/>get<sp/>worse)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1095"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>post_post_linearization<sp/>=<sp/>post_linearization;</highlight></codeline>
<codeline lineno="1096"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespacecluster__linearize_1ab4dfb7a53e485a4f5eac2219e4176a91" kindref="member">PostLinearize</ref>(depgraph,<sp/>post_post_linearization);</highlight></codeline>
<codeline lineno="1097"><highlight class="normal"><sp/><sp/><sp/><sp/>SanityCheck(depgraph,<sp/>post_post_linearization);</highlight></codeline>
<codeline lineno="1098"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>post_post_chunking<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph,<sp/>post_post_linearization);</highlight></codeline>
<codeline lineno="1099"><highlight class="normal"><sp/><sp/><sp/><sp/>cmp<sp/>=<sp/><ref refid="util_2feefrac_8cpp_1ac6b51471a8ec142402968632e02bbfe5" kindref="member">CompareChunks</ref>(post_post_chunking,<sp/>post_chunking);</highlight></codeline>
<codeline lineno="1100"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(cmp<sp/>&gt;=<sp/>0);</highlight></codeline>
<codeline lineno="1101"><highlight class="normal"></highlight></codeline>
<codeline lineno="1102"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>chunks<sp/>that<sp/>come<sp/>out<sp/>of<sp/>postlinearizing<sp/>are<sp/>always<sp/>connected.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1103"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>linchunking<sp/>=<sp/><ref refid="namespacecluster__linearize_1a30f9a354e247428df47e59a11e2a098f" kindref="member">ChunkLinearizationInfo</ref>(depgraph,<sp/>post_linearization);</highlight></codeline>
<codeline lineno="1104"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>[chunk_set,<sp/>_chunk_feerate]<sp/>:<sp/>linchunking)<sp/>{</highlight></codeline>
<codeline lineno="1105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1aecc46909fd08c461aeab4cd0807509d1" kindref="member">IsConnected</ref>(chunk_set));</highlight></codeline>
<codeline lineno="1106"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1107"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1108"><highlight class="normal"></highlight></codeline>
<codeline lineno="1109"><highlight class="normal"><ref refid="fuzz_8h_1a1b5a7b9b93ade1576569510908cc4bb9" kindref="member">FUZZ_TARGET</ref>(clusterlin_postlinearize_tree)</highlight></codeline>
<codeline lineno="1110"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1111"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>expected<sp/>properties<sp/>of<sp/>PostLinearize()<sp/>on<sp/>linearizations<sp/>of<sp/>graphs<sp/>that<sp/>form<sp/>either</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1112"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>an<sp/>upright<sp/>or<sp/>reverse<sp/>tree<sp/>structure.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1113"><highlight class="normal"></highlight></codeline>
<codeline lineno="1114"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Construct<sp/>a<sp/>direction,<sp/>RNG<sp/>seed,<sp/>and<sp/>an<sp/>arbitrary<sp/>graph<sp/>from<sp/>the<sp/>fuzz<sp/>input.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1115"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_span_reader" kindref="compound">SpanReader</ref><sp/>reader(buffer);</highlight></codeline>
<codeline lineno="1116"><highlight class="normal"><sp/><sp/><sp/><sp/>uint64_t<sp/>rng_seed{0};</highlight></codeline>
<codeline lineno="1117"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;TestBitSet&gt;</ref><sp/>depgraph_gen;</highlight></codeline>
<codeline lineno="1118"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t<sp/>direction{0};</highlight></codeline>
<codeline lineno="1119"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reader<sp/>&gt;&gt;<sp/>direction<sp/>&gt;&gt;<sp/>rng_seed<sp/>&gt;&gt;<sp/>Using&lt;DepGraphFormatter&gt;(depgraph_gen);</highlight></codeline>
<codeline lineno="1121"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::ios_base::failure&amp;)<sp/>{}</highlight></codeline>
<codeline lineno="1122"><highlight class="normal"></highlight></codeline>
<codeline lineno="1123"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>depgraph_tree<sp/>=<sp/>BuildTreeGraph(depgraph_gen,<sp/>direction);</highlight></codeline>
<codeline lineno="1124"><highlight class="normal"></highlight></codeline>
<codeline lineno="1125"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Retrieve<sp/>a<sp/>linearization<sp/>from<sp/>the<sp/>fuzz<sp/>input.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1126"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;DepGraphIndex&gt;<sp/>linearization;</highlight></codeline>
<codeline lineno="1127"><highlight class="normal"><sp/><sp/><sp/><sp/>linearization<sp/>=<sp/>ReadLinearization(depgraph_tree,<sp/>reader);</highlight></codeline>
<codeline lineno="1128"><highlight class="normal"><sp/><sp/><sp/><sp/>SanityCheck(depgraph_tree,<sp/>linearization);</highlight></codeline>
<codeline lineno="1129"><highlight class="normal"></highlight></codeline>
<codeline lineno="1130"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Produce<sp/>a<sp/>postlinearized<sp/>version.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1131"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>post_linearization<sp/>=<sp/>linearization;</highlight></codeline>
<codeline lineno="1132"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespacecluster__linearize_1ab4dfb7a53e485a4f5eac2219e4176a91" kindref="member">PostLinearize</ref>(depgraph_tree,<sp/>post_linearization);</highlight></codeline>
<codeline lineno="1133"><highlight class="normal"><sp/><sp/><sp/><sp/>SanityCheck(depgraph_tree,<sp/>post_linearization);</highlight></codeline>
<codeline lineno="1134"><highlight class="normal"></highlight></codeline>
<codeline lineno="1135"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compare<sp/>diagrams.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1136"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>chunking<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph_tree,<sp/>linearization);</highlight></codeline>
<codeline lineno="1137"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>post_chunking<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph_tree,<sp/>post_linearization);</highlight></codeline>
<codeline lineno="1138"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>cmp<sp/>=<sp/><ref refid="util_2feefrac_8cpp_1ac6b51471a8ec142402968632e02bbfe5" kindref="member">CompareChunks</ref>(post_chunking,<sp/>chunking);</highlight></codeline>
<codeline lineno="1139"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(cmp<sp/>&gt;=<sp/>0);</highlight></codeline>
<codeline lineno="1140"><highlight class="normal"></highlight></codeline>
<codeline lineno="1141"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>that<sp/>post-linearizing<sp/>again<sp/>does<sp/>not<sp/>change<sp/>the<sp/>diagram.<sp/>The<sp/>result<sp/>must<sp/>be<sp/>identical</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1142"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>as<sp/>post_linearization<sp/>ought<sp/>to<sp/>be<sp/>optimal<sp/>already<sp/>with<sp/>a<sp/>tree-structured<sp/>graph.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1143"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>post_post_linearization<sp/>=<sp/>post_linearization;</highlight></codeline>
<codeline lineno="1144"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespacecluster__linearize_1ab4dfb7a53e485a4f5eac2219e4176a91" kindref="member">PostLinearize</ref>(depgraph_tree,<sp/>post_post_linearization);</highlight></codeline>
<codeline lineno="1145"><highlight class="normal"><sp/><sp/><sp/><sp/>SanityCheck(depgraph_tree,<sp/>post_post_linearization);</highlight></codeline>
<codeline lineno="1146"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>post_post_chunking<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph_tree,<sp/>post_post_linearization);</highlight></codeline>
<codeline lineno="1147"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>cmp_post<sp/>=<sp/><ref refid="util_2feefrac_8cpp_1ac6b51471a8ec142402968632e02bbfe5" kindref="member">CompareChunks</ref>(post_post_chunking,<sp/>post_chunking);</highlight></codeline>
<codeline lineno="1148"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(cmp_post<sp/>==<sp/>0);</highlight></codeline>
<codeline lineno="1149"><highlight class="normal"></highlight></codeline>
<codeline lineno="1150"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Try<sp/>to<sp/>find<sp/>an<sp/>even<sp/>better<sp/>linearization<sp/>directly.<sp/>This<sp/>must<sp/>not<sp/>change<sp/>the<sp/>diagram<sp/>for<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1151"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>same<sp/>reason.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1152"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>[opt_linearization,<sp/>_optimal,<sp/>_cost]<sp/>=<sp/><ref refid="namespacecluster__linearize_1ad7fec78514892bfc4213dec2180ea5fa" kindref="member">Linearize</ref>(depgraph_tree,<sp/>100000,<sp/>rng_seed,<sp/>post_linearization);</highlight></codeline>
<codeline lineno="1153"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>opt_chunking<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph_tree,<sp/>opt_linearization);</highlight></codeline>
<codeline lineno="1154"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>cmp_opt<sp/>=<sp/><ref refid="util_2feefrac_8cpp_1ac6b51471a8ec142402968632e02bbfe5" kindref="member">CompareChunks</ref>(opt_chunking,<sp/>post_chunking);</highlight></codeline>
<codeline lineno="1155"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(cmp_opt<sp/>==<sp/>0);</highlight></codeline>
<codeline lineno="1156"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1157"><highlight class="normal"></highlight></codeline>
<codeline lineno="1158"><highlight class="normal"><ref refid="fuzz_8h_1a1b5a7b9b93ade1576569510908cc4bb9" kindref="member">FUZZ_TARGET</ref>(clusterlin_postlinearize_moved_leaf)</highlight></codeline>
<codeline lineno="1159"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1160"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>that<sp/>taking<sp/>an<sp/>existing<sp/>linearization,<sp/>and<sp/>moving<sp/>a<sp/>leaf<sp/>to<sp/>the<sp/>back,<sp/>potentially</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1161"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>increasing<sp/>its<sp/>fee,<sp/>and<sp/>then<sp/>post-linearizing,<sp/>results<sp/>in<sp/>something<sp/>as<sp/>good<sp/>as<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1162"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>original.<sp/>This<sp/>guarantees<sp/>that<sp/>in<sp/>an<sp/>RBF<sp/>that<sp/>replaces<sp/>a<sp/>transaction<sp/>with<sp/>one<sp/>of<sp/>the<sp/>same</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1163"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>size<sp/>but<sp/>higher<sp/>fee,<sp/>applying<sp/>the<sp/>&quot;remove<sp/>conflicts,<sp/>append<sp/>new<sp/>transaction,<sp/>postlinearize&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1164"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>process<sp/>will<sp/>never<sp/>worsen<sp/>linearization<sp/>quality.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1165"><highlight class="normal"></highlight></codeline>
<codeline lineno="1166"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Construct<sp/>an<sp/>arbitrary<sp/>graph<sp/>and<sp/>a<sp/>fee<sp/>from<sp/>the<sp/>fuzz<sp/>input.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1167"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_span_reader" kindref="compound">SpanReader</ref><sp/>reader(buffer);</highlight></codeline>
<codeline lineno="1168"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;TestBitSet&gt;</ref><sp/>depgraph;</highlight></codeline>
<codeline lineno="1169"><highlight class="normal"><sp/><sp/><sp/><sp/>int32_t<sp/>fee_inc{0};</highlight></codeline>
<codeline lineno="1170"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>fee_inc_code;</highlight></codeline>
<codeline lineno="1172"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reader<sp/>&gt;&gt;<sp/>Using&lt;DepGraphFormatter&gt;(depgraph)<sp/>&gt;&gt;<sp/><ref refid="serialize_8h_1a1383f2a4c22ffaeba9b2924d90459f76" kindref="member">VARINT</ref>(fee_inc_code);</highlight></codeline>
<codeline lineno="1173"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fee_inc<sp/>=<sp/>fee_inc_code<sp/>&amp;<sp/>0x3ffff;</highlight></codeline>
<codeline lineno="1174"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::ios_base::failure&amp;)<sp/>{}</highlight></codeline>
<codeline lineno="1175"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1ae3cec0644fd4e8562d14b99badc3c91e" kindref="member">TxCount</ref>()<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1176"><highlight class="normal"></highlight></codeline>
<codeline lineno="1177"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Retrieve<sp/>two<sp/>linearizations<sp/>from<sp/>the<sp/>fuzz<sp/>input.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1178"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>lin<sp/>=<sp/>ReadLinearization(depgraph,<sp/>reader);</highlight></codeline>
<codeline lineno="1179"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>lin_leaf<sp/>=<sp/>ReadLinearization(depgraph,<sp/>reader);</highlight></codeline>
<codeline lineno="1180"><highlight class="normal"></highlight></codeline>
<codeline lineno="1181"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Construct<sp/>a<sp/>linearization<sp/>identical<sp/>to<sp/>lin,<sp/>but<sp/>with<sp/>the<sp/>tail<sp/>end<sp/>of<sp/>lin_leaf<sp/>moved<sp/>to<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1182"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>back.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1183"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;DepGraphIndex&gt;<sp/>lin_moved;</highlight></codeline>
<codeline lineno="1184"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>i<sp/>:<sp/>lin)<sp/>{</highlight></codeline>
<codeline lineno="1185"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(i<sp/>!=<sp/>lin_leaf.back())<sp/>lin_moved.push_back(i);</highlight></codeline>
<codeline lineno="1186"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1187"><highlight class="normal"><sp/><sp/><sp/><sp/>lin_moved.push_back(lin_leaf.back());</highlight></codeline>
<codeline lineno="1188"><highlight class="normal"></highlight></codeline>
<codeline lineno="1189"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Postlinearize<sp/>lin_moved.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1190"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespacecluster__linearize_1ab4dfb7a53e485a4f5eac2219e4176a91" kindref="member">PostLinearize</ref>(depgraph,<sp/>lin_moved);</highlight></codeline>
<codeline lineno="1191"><highlight class="normal"><sp/><sp/><sp/><sp/>SanityCheck(depgraph,<sp/>lin_moved);</highlight></codeline>
<codeline lineno="1192"><highlight class="normal"></highlight></codeline>
<codeline lineno="1193"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compare<sp/>diagrams<sp/>(applying<sp/>the<sp/>fee<sp/>delta<sp/>after<sp/>computing<sp/>the<sp/>old<sp/>one).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1194"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>old_chunking<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph,<sp/>lin);</highlight></codeline>
<codeline lineno="1195"><highlight class="normal"><sp/><sp/><sp/><sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a401a234c54f61fb05821094ad38f24d5" kindref="member">FeeRate</ref>(lin_leaf.back()).<ref refid="struct_fee_frac_1a6c6b1afb7a3ce84aa1ff3890e731b3d3" kindref="member">fee</ref><sp/>+=<sp/>fee_inc;</highlight></codeline>
<codeline lineno="1196"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>new_chunking<sp/>=<sp/><ref refid="namespacecluster__linearize_1a8efd6c0d9203d9d942b0c8b9baf81e87" kindref="member">ChunkLinearization</ref>(depgraph,<sp/>lin_moved);</highlight></codeline>
<codeline lineno="1197"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>cmp<sp/>=<sp/><ref refid="util_2feefrac_8cpp_1ac6b51471a8ec142402968632e02bbfe5" kindref="member">CompareChunks</ref>(new_chunking,<sp/>old_chunking);</highlight></codeline>
<codeline lineno="1198"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(cmp<sp/>&gt;=<sp/>0);</highlight></codeline>
<codeline lineno="1199"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1200"><highlight class="normal"></highlight></codeline>
<codeline lineno="1201"><highlight class="normal"><ref refid="fuzz_8h_1a1b5a7b9b93ade1576569510908cc4bb9" kindref="member">FUZZ_TARGET</ref>(clusterlin_fix_linearization)</highlight></codeline>
<codeline lineno="1202"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1203"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>expected<sp/>properties<sp/>of<sp/>FixLinearization()<sp/>on<sp/>arbitrary<sp/>linearizations.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1204"><highlight class="normal"></highlight></codeline>
<codeline lineno="1205"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Retrieve<sp/>a<sp/>depgraph<sp/>from<sp/>the<sp/>fuzz<sp/>input.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1206"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_span_reader" kindref="compound">SpanReader</ref><sp/>reader(buffer);</highlight></codeline>
<codeline lineno="1207"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classcluster__linearize_1_1_dep_graph" kindref="compound">DepGraph&lt;TestBitSet&gt;</ref><sp/>depgraph;</highlight></codeline>
<codeline lineno="1208"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reader<sp/>&gt;&gt;<sp/>Using&lt;DepGraphFormatter&gt;(depgraph);</highlight></codeline>
<codeline lineno="1210"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::ios_base::failure&amp;)<sp/>{}</highlight></codeline>
<codeline lineno="1211"><highlight class="normal"></highlight></codeline>
<codeline lineno="1212"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Construct<sp/>an<sp/>arbitrary<sp/>linearization<sp/>(not<sp/>necessarily<sp/>topological<sp/>for<sp/>depgraph).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1213"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;DepGraphIndex&gt;<sp/>linearization<sp/>=<sp/>ReadLinearization(depgraph,<sp/>reader,<sp/></highlight><highlight class="comment">/*topological=*/</highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1214"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(linearization.size()<sp/>==<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1ae3cec0644fd4e8562d14b99badc3c91e" kindref="member">TxCount</ref>());</highlight></codeline>
<codeline lineno="1215"><highlight class="normal"></highlight></codeline>
<codeline lineno="1216"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Determine<sp/>what<sp/>prefix<sp/>of<sp/>linearization<sp/>is<sp/>topological,<sp/>i.e.,<sp/>the<sp/>position<sp/>of<sp/>the<sp/>first<sp/>entry</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1217"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>in<sp/>linearization<sp/>which<sp/>corresponds<sp/>to<sp/>a<sp/>transaction<sp/>that<sp/>is<sp/>not<sp/>preceded<sp/>by<sp/>all<sp/>its</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1218"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ancestors.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1219"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>topo_prefix<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1220"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>todo<sp/>=<sp/>depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1a700dd1176f1aa1e6f3b2202fc0377dbe" kindref="member">Positions</ref>();</highlight></codeline>
<codeline lineno="1221"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(topo_prefix<sp/>&lt;<sp/>linearization.size())<sp/>{</highlight></codeline>
<codeline lineno="1222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacecluster__linearize_1afe7ae098b4cbd5b112f81d1e9429e90d" kindref="member">DepGraphIndex</ref><sp/>idx<sp/>=<sp/>linearization[topo_prefix];</highlight></codeline>
<codeline lineno="1223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>todo.Reset(idx);</highlight></codeline>
<codeline lineno="1224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(todo.Overlaps(depgraph.<ref refid="classcluster__linearize_1_1_dep_graph_1afc3ed1d0c57b777822863b057012f993" kindref="member">Ancestors</ref>(idx)))<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++topo_prefix;</highlight></codeline>
<codeline lineno="1226"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1227"><highlight class="normal"></highlight></codeline>
<codeline lineno="1228"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Then<sp/>make<sp/>a<sp/>fixed<sp/>copy<sp/>of<sp/>linearization.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1229"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>linearization_fixed<sp/>=<sp/>linearization;</highlight></codeline>
<codeline lineno="1230"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespacecluster__linearize_1a2d8e8c7af3c1fd9b4bbd67716b358430" kindref="member">FixLinearization</ref>(depgraph,<sp/>linearization_fixed);</highlight></codeline>
<codeline lineno="1231"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Sanity<sp/>check<sp/>it<sp/>(which<sp/>includes<sp/>testing<sp/>whether<sp/>it<sp/>is<sp/>topological).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1232"><highlight class="normal"><sp/><sp/><sp/><sp/>SanityCheck(depgraph,<sp/>linearization_fixed);</highlight></codeline>
<codeline lineno="1233"><highlight class="normal"></highlight></codeline>
<codeline lineno="1234"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>FixLinearization<sp/>does<sp/>not<sp/>modify<sp/>the<sp/>topological<sp/>prefix<sp/>of<sp/>linearization.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1235"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(std::equal(linearization.begin(),<sp/>linearization.begin()<sp/>+<sp/>topo_prefix,</highlight></codeline>
<codeline lineno="1236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>linearization_fixed.begin()));</highlight></codeline>
<codeline lineno="1237"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>also<sp/>means<sp/>that<sp/>if<sp/>linearization<sp/>was<sp/>entirely<sp/>topological,<sp/>FixLinearization<sp/>cannot<sp/>have</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1238"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>modified<sp/>it.<sp/>This<sp/>is<sp/>implied<sp/>by<sp/>the<sp/>assertion<sp/>above<sp/>already,<sp/>but<sp/>repeat<sp/>it<sp/>explicitly.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1239"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(topo_prefix<sp/>==<sp/>linearization.size())<sp/>{</highlight></codeline>
<codeline lineno="1240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(linearization<sp/>==<sp/>linearization_fixed);</highlight></codeline>
<codeline lineno="1241"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1242"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="src/test/fuzz/cluster_linearize.cpp"/>
  </compounddef>
</doxygen>
