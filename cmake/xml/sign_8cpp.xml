<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.15.0" xml:lang="en-US">
  <compounddef id="sign_8cpp" kind="file" language="C++">
    <compoundname>sign.cpp</compoundname>
    <includes refid="sign_8h" local="no">script/sign.h</includes>
    <includes refid="amount_8h" local="no">consensus/amount.h</includes>
    <includes refid="key_8h" local="no">key.h</includes>
    <includes refid="musig_8h" local="no">musig.h</includes>
    <includes refid="policy_8h" local="no">policy/policy.h</includes>
    <includes refid="primitives_2transaction_8h" local="no">primitives/transaction.h</includes>
    <includes local="no">random.h</includes>
    <includes refid="keyorigin_8h" local="no">script/keyorigin.h</includes>
    <includes refid="miniscript_8h" local="no">script/miniscript.h</includes>
    <includes refid="script_2script_8h" local="no">script/script.h</includes>
    <includes refid="signingprovider_8h" local="no">script/signingprovider.h</includes>
    <includes refid="solver_8h" local="no">script/solver.h</includes>
    <includes refid="uint256_8h" local="no">uint256.h</includes>
    <includes refid="translation_8h" local="no">util/translation.h</includes>
    <includes refid="vector_8h" local="no">util/vector.h</includes>
    <incdepgraph>
      <node id="63">
        <label>addresstype.h</label>
        <link refid="addresstype_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="64" relation="include">
        </childnode>
        <childnode refid="56" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="54" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
      </node>
      <node id="3">
        <label>attributes.h</label>
        <link refid="attributes_8h"/>
      </node>
      <node id="27">
        <label>compat/assumptions.h</label>
        <link refid="compat_2assumptions_8h"/>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
      </node>
      <node id="10">
        <label>compat/byteswap.h</label>
        <link refid="byteswap_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
      </node>
      <node id="9">
        <label>compat/endian.h</label>
        <link refid="endian_8h"/>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
      </node>
      <node id="48">
        <label>consensus/amount.h</label>
        <link refid="amount_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
      </node>
      <node id="82">
        <label>consensus/consensus.h</label>
        <link refid="consensus_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
      </node>
      <node id="8">
        <label>crypto/common.h</label>
        <link refid="crypto_2common_8h"/>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
      </node>
      <node id="38">
        <label>crypto/hex_base.h</label>
        <link refid="hex__base_8h"/>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
      </node>
      <node id="16">
        <label>crypto/ripemd160.h</label>
        <link refid="ripemd160_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
      </node>
      <node id="18">
        <label>crypto/sha256.h</label>
        <link refid="sha256_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
      </node>
      <node id="7">
        <label>hash.h</label>
        <link refid="hash_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
      </node>
      <node id="67">
        <label>key.h</label>
        <link refid="key_8h"/>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="69" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
      </node>
      <node id="68">
        <label>musig.h</label>
        <link refid="musig_8h"/>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
      </node>
      <node id="81">
        <label>policy/policy.h</label>
        <link refid="policy_8h"/>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="82" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="83" relation="include">
        </childnode>
        <childnode refid="84" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
      </node>
      <node id="20">
        <label>prevector.h</label>
        <link refid="prevector_8h"/>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
      </node>
      <node id="49">
        <label>primitives/transaction.h</label>
        <link refid="primitives_2transaction_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="31" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="58" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="53" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
      </node>
      <node id="50">
        <label>primitives/transaction_identifier.h</label>
        <link refid="transaction__identifier_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="51" relation="include">
        </childnode>
        <childnode refid="52" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="53" relation="include">
        </childnode>
        <childnode refid="54" relation="include">
        </childnode>
      </node>
      <node id="6">
        <label>pubkey.h</label>
        <link refid="pubkey_8h"/>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
      </node>
      <node id="47">
        <label>script/interpreter.h</label>
        <link refid="interpreter_8h"/>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="60" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
      </node>
      <node id="61">
        <label>script/keyorigin.h</label>
        <link refid="keyorigin_8h"/>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
      </node>
      <node id="86">
        <label>script/miniscript.h</label>
        <link refid="miniscript_8h"/>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="52" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
        <childnode refid="53" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="82" relation="include">
        </childnode>
        <childnode refid="81" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="87" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="64" relation="include">
        </childnode>
        <childnode refid="37" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="88" relation="include">
        </childnode>
      </node>
      <node id="87">
        <label>script/parsing.h</label>
        <link refid="parsing_8h"/>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
      </node>
      <node id="55">
        <label>script/script.h</label>
        <link refid="script_2script_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="56" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
      </node>
      <node id="59">
        <label>script/script_error.h</label>
        <link refid="script__error_8h"/>
        <childnode refid="19" relation="include">
        </childnode>
      </node>
      <node id="1">
        <label>src/script/sign.cpp</label>
        <link refid="sign_8cpp"/>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="81" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="85" relation="include">
        </childnode>
        <childnode refid="61" relation="include">
        </childnode>
        <childnode refid="86" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="62" relation="include">
        </childnode>
        <childnode refid="83" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="90" relation="include">
        </childnode>
        <childnode refid="88" relation="include">
        </childnode>
      </node>
      <node id="2">
        <label>script/sign.h</label>
        <link refid="sign_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="61" relation="include">
        </childnode>
        <childnode refid="62" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
      </node>
      <node id="62">
        <label>script/signingprovider.h</label>
        <link refid="signingprovider_8h"/>
        <childnode refid="63" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="61" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="75" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
      </node>
      <node id="83">
        <label>script/solver.h</label>
        <link refid="solver_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
      </node>
      <node id="60">
        <label>script/verify_flags.h</label>
        <link refid="verify__flags_8h"/>
        <childnode refid="52" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
      </node>
      <node id="26">
        <label>serialize.h</label>
        <link refid="serialize_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="31" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="32" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
      </node>
      <node id="29">
        <label>span.h</label>
        <link refid="span_8h"/>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
      </node>
      <node id="69">
        <label>support/allocators/secure.h</label>
        <link refid="secure_8h"/>
        <childnode refid="70" relation="include">
        </childnode>
        <childnode refid="74" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
      </node>
      <node id="74">
        <label>support/cleanse.h</label>
        <link refid="cleanse_8h"/>
        <childnode refid="17" relation="include">
        </childnode>
      </node>
      <node id="70">
        <label>support/lockedpool.h</label>
        <link refid="lockedpool_8h"/>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="71" relation="include">
        </childnode>
        <childnode refid="32" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="72" relation="include">
        </childnode>
        <childnode refid="73" relation="include">
        </childnode>
      </node>
      <node id="75">
        <label>sync.h</label>
        <link refid="sync_8h"/>
        <childnode refid="76" relation="include">
        </childnode>
        <childnode refid="77" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="78" relation="include">
        </childnode>
        <childnode refid="72" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
      </node>
      <node id="76">
        <label>threadsafety.h</label>
        <link refid="threadsafety_8h"/>
        <childnode refid="72" relation="include">
        </childnode>
      </node>
      <node id="91">
        <label>tinyformat.h</label>
        <link refid="tinyformat_8h"/>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="92" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
      </node>
      <node id="36">
        <label>uint256.h</label>
        <link refid="uint256_8h"/>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="37" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="64">
        <label>util/check.h</label>
        <link refid="check_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
      </node>
      <node id="84">
        <label>util/feefrac.h</label>
        <link refid="feefrac_8h"/>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="64" relation="include">
        </childnode>
        <childnode refid="52" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
      </node>
      <node id="56">
        <label>util/hash_type.h</label>
        <link refid="hash__type_8h"/>
      </node>
      <node id="77">
        <label>util/macros.h</label>
        <link refid="macros_8h"/>
      </node>
      <node id="37">
        <label>util/strencodings.h</label>
        <link refid="strencodings_8h"/>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
        <childnode refid="46" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
      </node>
      <node id="39">
        <label>util/string.h</label>
        <link refid="string_8h"/>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
      </node>
      <node id="90">
        <label>util/translation.h</label>
        <link refid="translation_8h"/>
        <childnode refid="91" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
      </node>
      <node id="51">
        <label>util/types.h</label>
        <link refid="util_2types_8h"/>
      </node>
      <node id="88">
        <label>util/vector.h</label>
        <link refid="vector_8h"/>
        <childnode refid="80" relation="include">
        </childnode>
        <childnode refid="89" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
      </node>
      <node id="21">
        <label>algorithm</label>
      </node>
      <node id="40">
        <label>array</label>
      </node>
      <node id="65">
        <label>atomic</label>
      </node>
      <node id="12">
        <label>bit</label>
      </node>
      <node id="22">
        <label>cassert</label>
      </node>
      <node id="44">
        <label>charconv</label>
      </node>
      <node id="4">
        <label>coins.h</label>
      </node>
      <node id="52">
        <label>compare</label>
      </node>
      <node id="13">
        <label>concepts</label>
      </node>
      <node id="78">
        <label>condition_variable</label>
      </node>
      <node id="14">
        <label>cstddef</label>
      </node>
      <node id="11">
        <label>cstdint</label>
      </node>
      <node id="17">
        <label>cstdlib</label>
      </node>
      <node id="15">
        <label>cstring</label>
      </node>
      <node id="80">
        <label>functional</label>
      </node>
      <node id="5">
        <label>hash.h</label>
      </node>
      <node id="89">
        <label>initializer_list</label>
      </node>
      <node id="31">
        <label>ios</label>
      </node>
      <node id="92">
        <label>iostream</label>
      </node>
      <node id="23">
        <label>iterator</label>
      </node>
      <node id="28">
        <label>limits</label>
      </node>
      <node id="71">
        <label>list</label>
      </node>
      <node id="41">
        <label>locale</label>
      </node>
      <node id="32">
        <label>map</label>
      </node>
      <node id="33">
        <label>memory</label>
      </node>
      <node id="72">
        <label>mutex</label>
      </node>
      <node id="58">
        <label>numeric</label>
      </node>
      <node id="45">
        <label>optional</label>
      </node>
      <node id="85">
        <label>random.h</label>
      </node>
      <node id="34">
        <label>set</label>
      </node>
      <node id="66">
        <label>source_location</label>
      </node>
      <node id="30">
        <label>span</label>
      </node>
      <node id="42">
        <label>sstream</label>
      </node>
      <node id="57">
        <label>stdexcept</label>
      </node>
      <node id="19">
        <label>string</label>
      </node>
      <node id="43">
        <label>string_view</label>
      </node>
      <node id="46">
        <label>system_error</label>
      </node>
      <node id="79">
        <label>thread</label>
      </node>
      <node id="53">
        <label>tuple</label>
      </node>
      <node id="24">
        <label>type_traits</label>
      </node>
      <node id="73">
        <label>unordered_map</label>
      </node>
      <node id="25">
        <label>utility</label>
      </node>
      <node id="54">
        <label>variant</label>
      </node>
      <node id="35">
        <label>vector</label>
      </node>
    </incdepgraph>
    <innerclass refid="struct_satisfier" prot="public">Satisfier</innerclass>
    <innerclass refid="struct_wsh_satisfier" prot="public">WshSatisfier</innerclass>
    <innerclass refid="struct_tap_satisfier" prot="public">TapSatisfier</innerclass>
    <sectiondef kind="typedef">
      <memberdef kind="typedef" id="sign_8cpp_1a893ae190c4461e89b01441657f8975ed" prot="public" static="no">
        <type>std::vector&lt; unsigned char &gt;</type>
        <definition>typedef std::vector&lt;unsigned char&gt; valtype</definition>
        <argsstring></argsstring>
        <name>valtype</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/script/sign.cpp" line="23" column="21" bodyfile="src/script/sign.cpp" bodystart="23" bodyend="-1"/>
      </memberdef>
    </sectiondef>
    <sectiondef kind="var">
      <memberdef kind="variable" id="sign_8cpp_1ac7c8cef845db98e77532b1f1b75d3284" prot="public" static="no" mutable="no">
        <type>const <ref refid="class_base_signature_checker" kindref="compound">BaseSignatureChecker</ref> &amp;</type>
        <definition>const BaseSignatureChecker&amp; DUMMY_CHECKER</definition>
        <argsstring></argsstring>
        <name>DUMMY_CHECKER</name>
        <initializer>= DummySignatureChecker()</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>A signature checker that accepts all signatures </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/script/sign.cpp" line="937" column="28" bodyfile="src/script/sign.cpp" bodystart="937" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="sign_8cpp_1adeb428a7d137dcfc2a1f29dd1a562ca8" prot="public" static="no" mutable="no">
        <type>const <ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref> &amp;</type>
        <definition>const BaseSignatureCreator&amp; DUMMY_SIGNATURE_CREATOR</definition>
        <argsstring></argsstring>
        <name>DUMMY_SIGNATURE_CREATOR</name>
        <initializer>= DummySignatureCreator(32, 32)</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>A signature creator that just produces 71-byte empty signatures. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/script/sign.cpp" line="987" column="28" bodyfile="src/script/sign.cpp" bodystart="987" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="sign_8cpp_1aa46e7059be2d9fa3dc2f4675704e8218" prot="public" static="no" mutable="no">
        <type>const <ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref> &amp;</type>
        <definition>const BaseSignatureCreator&amp; DUMMY_MAXIMUM_SIGNATURE_CREATOR</definition>
        <argsstring></argsstring>
        <name>DUMMY_MAXIMUM_SIGNATURE_CREATOR</name>
        <initializer>= DummySignatureCreator(33, 32)</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>A signature creator that just produces 72-byte empty signatures. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/script/sign.cpp" line="988" column="28" bodyfile="src/script/sign.cpp" bodystart="988" bodyend="-1"/>
      </memberdef>
    </sectiondef>
    <sectiondef kind="func">
      <memberdef kind="function" id="sign_8cpp_1afad3d5639014767ac04b3476922bf6a0" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>static bool GetCScript</definition>
        <argsstring>(const SigningProvider &amp;provider, const SignatureData &amp;sigdata, const CScriptID &amp;scriptid, CScript &amp;script)</argsstring>
        <name>GetCScript</name>
        <param>
          <type>const <ref refid="class_signing_provider" kindref="compound">SigningProvider</ref> &amp;</type>
          <declname>provider</declname>
        </param>
        <param>
          <type>const <ref refid="struct_signature_data" kindref="compound">SignatureData</ref> &amp;</type>
          <declname>sigdata</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_script_i_d" kindref="compound">CScriptID</ref> &amp;</type>
          <declname>scriptid</declname>
        </param>
        <param>
          <type><ref refid="class_c_script" kindref="compound">CScript</ref> &amp;</type>
          <declname>script</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/script/sign.cpp" line="205" column="13" bodyfile="src/script/sign.cpp" bodystart="205" bodyend="219"/>
      </memberdef>
      <memberdef kind="function" id="sign_8cpp_1aa7ca6e5e16aecdbd41f63821f2b286ba" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>static bool GetPubKey</definition>
        <argsstring>(const SigningProvider &amp;provider, const SignatureData &amp;sigdata, const CKeyID &amp;address, CPubKey &amp;pubkey)</argsstring>
        <name>GetPubKey</name>
        <param>
          <type>const <ref refid="class_signing_provider" kindref="compound">SigningProvider</ref> &amp;</type>
          <declname>provider</declname>
        </param>
        <param>
          <type>const <ref refid="struct_signature_data" kindref="compound">SignatureData</ref> &amp;</type>
          <declname>sigdata</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_key_i_d" kindref="compound">CKeyID</ref> &amp;</type>
          <declname>address</declname>
        </param>
        <param>
          <type><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref> &amp;</type>
          <declname>pubkey</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/script/sign.cpp" line="221" column="13" bodyfile="src/script/sign.cpp" bodystart="221" bodyend="242"/>
      </memberdef>
      <memberdef kind="function" id="sign_8cpp_1a4dc8c44312f1c11f40c3d9adf44f9ca6" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>static bool CreateSig</definition>
        <argsstring>(const BaseSignatureCreator &amp;creator, SignatureData &amp;sigdata, const SigningProvider &amp;provider, std::vector&lt; unsigned char &gt; &amp;sig_out, const CPubKey &amp;pubkey, const CScript &amp;scriptcode, SigVersion sigversion)</argsstring>
        <name>CreateSig</name>
        <param>
          <type>const <ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref> &amp;</type>
          <declname>creator</declname>
        </param>
        <param>
          <type><ref refid="struct_signature_data" kindref="compound">SignatureData</ref> &amp;</type>
          <declname>sigdata</declname>
        </param>
        <param>
          <type>const <ref refid="class_signing_provider" kindref="compound">SigningProvider</ref> &amp;</type>
          <declname>provider</declname>
        </param>
        <param>
          <type>std::vector&lt; unsigned char &gt; &amp;</type>
          <declname>sig_out</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_pub_key" kindref="compound">CPubKey</ref> &amp;</type>
          <declname>pubkey</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_script" kindref="compound">CScript</ref> &amp;</type>
          <declname>scriptcode</declname>
        </param>
        <param>
          <type><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref></type>
          <declname>sigversion</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/script/sign.cpp" line="244" column="13" bodyfile="src/script/sign.cpp" bodystart="244" bodyend="264"/>
      </memberdef>
      <memberdef kind="function" id="sign_8cpp_1ab4f611ab27ba872636969eba7899aa53" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>static bool SignMuSig2</definition>
        <argsstring>(const BaseSignatureCreator &amp;creator, SignatureData &amp;sigdata, const SigningProvider &amp;provider, std::vector&lt; unsigned char &gt; &amp;sig_out, const XOnlyPubKey &amp;script_pubkey, const uint256 *merkle_root, const uint256 *leaf_hash, SigVersion sigversion)</argsstring>
        <name>SignMuSig2</name>
        <param>
          <type>const <ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref> &amp;</type>
          <declname>creator</declname>
        </param>
        <param>
          <type><ref refid="struct_signature_data" kindref="compound">SignatureData</ref> &amp;</type>
          <declname>sigdata</declname>
        </param>
        <param>
          <type>const <ref refid="class_signing_provider" kindref="compound">SigningProvider</ref> &amp;</type>
          <declname>provider</declname>
        </param>
        <param>
          <type>std::vector&lt; unsigned char &gt; &amp;</type>
          <declname>sig_out</declname>
        </param>
        <param>
          <type>const <ref refid="class_x_only_pub_key" kindref="compound">XOnlyPubKey</ref> &amp;</type>
          <declname>script_pubkey</declname>
        </param>
        <param>
          <type>const <ref refid="classuint256" kindref="compound">uint256</ref> *</type>
          <declname>merkle_root</declname>
        </param>
        <param>
          <type>const <ref refid="classuint256" kindref="compound">uint256</ref> *</type>
          <declname>leaf_hash</declname>
        </param>
        <param>
          <type><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref></type>
          <declname>sigversion</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/script/sign.cpp" line="266" column="13" bodyfile="src/script/sign.cpp" bodystart="266" bodyend="358"/>
      </memberdef>
      <memberdef kind="function" id="sign_8cpp_1a1fd7997d7c966cd587c3413394f38f4d" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>static bool CreateTaprootScriptSig</definition>
        <argsstring>(const BaseSignatureCreator &amp;creator, SignatureData &amp;sigdata, const SigningProvider &amp;provider, std::vector&lt; unsigned char &gt; &amp;sig_out, const XOnlyPubKey &amp;pubkey, const uint256 &amp;leaf_hash, SigVersion sigversion)</argsstring>
        <name>CreateTaprootScriptSig</name>
        <param>
          <type>const <ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref> &amp;</type>
          <declname>creator</declname>
        </param>
        <param>
          <type><ref refid="struct_signature_data" kindref="compound">SignatureData</ref> &amp;</type>
          <declname>sigdata</declname>
        </param>
        <param>
          <type>const <ref refid="class_signing_provider" kindref="compound">SigningProvider</ref> &amp;</type>
          <declname>provider</declname>
        </param>
        <param>
          <type>std::vector&lt; unsigned char &gt; &amp;</type>
          <declname>sig_out</declname>
        </param>
        <param>
          <type>const <ref refid="class_x_only_pub_key" kindref="compound">XOnlyPubKey</ref> &amp;</type>
          <declname>pubkey</declname>
        </param>
        <param>
          <type>const <ref refid="classuint256" kindref="compound">uint256</ref> &amp;</type>
          <declname>leaf_hash</declname>
        </param>
        <param>
          <type><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref></type>
          <declname>sigversion</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/script/sign.cpp" line="360" column="13" bodyfile="src/script/sign.cpp" bodystart="360" bodyend="386"/>
      </memberdef>
      <memberdef kind="function" id="sign_8cpp_1af1a1b251ba23c7ea4c2b29a6ef96cff6" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <templateparamlist>
          <param>
            <type>typename M</type>
          </param>
          <param>
            <type>typename K</type>
          </param>
          <param>
            <type>typename V</type>
          </param>
        </templateparamlist>
        <type><ref refid="namespaceminiscript_1adfd5523d4b709d5e28349355e79255db" kindref="member">miniscript::Availability</ref></type>
        <definition>miniscript::Availability MsLookupHelper</definition>
        <argsstring>(const M &amp;map, const K &amp;key, V &amp;value)</argsstring>
        <name>MsLookupHelper</name>
        <param>
          <type>const M &amp;</type>
          <declname>map</declname>
        </param>
        <param>
          <type>const K &amp;</type>
          <declname>key</declname>
        </param>
        <param>
          <type>V &amp;</type>
          <declname>value</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/script/sign.cpp" line="389" column="26" bodyfile="src/script/sign.cpp" bodystart="389" bodyend="397"/>
      </memberdef>
      <memberdef kind="function" id="sign_8cpp_1a12f1811c290d37387f51740c788f0a15" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>static bool SignTaprootScript</definition>
        <argsstring>(const SigningProvider &amp;provider, const BaseSignatureCreator &amp;creator, SignatureData &amp;sigdata, int leaf_version, std::span&lt; const unsigned char &gt; script_bytes, std::vector&lt; valtype &gt; &amp;result)</argsstring>
        <name>SignTaprootScript</name>
        <param>
          <type>const <ref refid="class_signing_provider" kindref="compound">SigningProvider</ref> &amp;</type>
          <declname>provider</declname>
        </param>
        <param>
          <type>const <ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref> &amp;</type>
          <declname>creator</declname>
        </param>
        <param>
          <type><ref refid="struct_signature_data" kindref="compound">SignatureData</ref> &amp;</type>
          <declname>sigdata</declname>
        </param>
        <param>
          <type>int</type>
          <declname>leaf_version</declname>
        </param>
        <param>
          <type>std::span&lt; const unsigned char &gt;</type>
          <declname>script_bytes</declname>
        </param>
        <param>
          <type>std::vector&lt; <ref refid="addresstype_8cpp_1a893ae190c4461e89b01441657f8975ed" kindref="member">valtype</ref> &gt; &amp;</type>
          <declname>result</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/script/sign.cpp" line="529" column="13" bodyfile="src/script/sign.cpp" bodystart="529" bodyend="540"/>
      </memberdef>
      <memberdef kind="function" id="sign_8cpp_1a943ab73506694fd9664a4a6b9cbc38c4" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>static bool SignTaproot</definition>
        <argsstring>(const SigningProvider &amp;provider, const BaseSignatureCreator &amp;creator, const WitnessV1Taproot &amp;output, SignatureData &amp;sigdata, std::vector&lt; valtype &gt; &amp;result)</argsstring>
        <name>SignTaproot</name>
        <param>
          <type>const <ref refid="class_signing_provider" kindref="compound">SigningProvider</ref> &amp;</type>
          <declname>provider</declname>
        </param>
        <param>
          <type>const <ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref> &amp;</type>
          <declname>creator</declname>
        </param>
        <param>
          <type>const <ref refid="struct_witness_v1_taproot" kindref="compound">WitnessV1Taproot</ref> &amp;</type>
          <declname>output</declname>
        </param>
        <param>
          <type><ref refid="struct_signature_data" kindref="compound">SignatureData</ref> &amp;</type>
          <declname>sigdata</declname>
        </param>
        <param>
          <type>std::vector&lt; <ref refid="addresstype_8cpp_1a893ae190c4461e89b01441657f8975ed" kindref="member">valtype</ref> &gt; &amp;</type>
          <declname>result</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/script/sign.cpp" line="542" column="13" bodyfile="src/script/sign.cpp" bodystart="542" bodyend="620"/>
      </memberdef>
      <memberdef kind="function" id="sign_8cpp_1a0336723e9e538c2fc0fb2033651a6eeb" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>static bool SignStep</definition>
        <argsstring>(const SigningProvider &amp;provider, const BaseSignatureCreator &amp;creator, const CScript &amp;scriptPubKey, std::vector&lt; valtype &gt; &amp;ret, TxoutType &amp;whichTypeRet, SigVersion sigversion, SignatureData &amp;sigdata)</argsstring>
        <name>SignStep</name>
        <param>
          <type>const <ref refid="class_signing_provider" kindref="compound">SigningProvider</ref> &amp;</type>
          <declname>provider</declname>
        </param>
        <param>
          <type>const <ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref> &amp;</type>
          <declname>creator</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_script" kindref="compound">CScript</ref> &amp;</type>
          <declname>scriptPubKey</declname>
        </param>
        <param>
          <type>std::vector&lt; <ref refid="addresstype_8cpp_1a893ae190c4461e89b01441657f8975ed" kindref="member">valtype</ref> &gt; &amp;</type>
          <declname>ret</declname>
        </param>
        <param>
          <type><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8f" kindref="member">TxoutType</ref> &amp;</type>
          <declname>whichTypeRet</declname>
        </param>
        <param>
          <type><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref></type>
          <declname>sigversion</declname>
        </param>
        <param>
          <type><ref refid="struct_signature_data" kindref="compound">SignatureData</ref> &amp;</type>
          <declname>sigdata</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Sign scriptPubKey using signature made with creator. Signatures are returned in scriptSigRet (or returns false if scriptPubKey can&apos;t be signed), unless whichTypeRet is <ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fa27f02ca8bff408e6f6bfa149474cc28e" kindref="member">TxoutType::SCRIPTHASH</ref>, in which case scriptSigRet is the redemption script. Returns false if scriptPubKey could not be completely satisfied. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/script/sign.cpp" line="628" column="13" bodyfile="src/script/sign.cpp" bodystart="628" bodyend="710"/>
      </memberdef>
      <memberdef kind="function" id="sign_8cpp_1ad903f2cff6c393ba5351bfd5730157b5" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="class_c_script" kindref="compound">CScript</ref></type>
        <definition>static CScript PushAll</definition>
        <argsstring>(const std::vector&lt; valtype &gt; &amp;values)</argsstring>
        <name>PushAll</name>
        <param>
          <type>const std::vector&lt; <ref refid="addresstype_8cpp_1a893ae190c4461e89b01441657f8975ed" kindref="member">valtype</ref> &gt; &amp;</type>
          <declname>values</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/script/sign.cpp" line="712" column="16" bodyfile="src/script/sign.cpp" bodystart="712" bodyend="727"/>
      </memberdef>
      <memberdef kind="function" id="sign_8cpp_1a0c453416d09212d876bee81dc9353c16" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool ProduceSignature</definition>
        <argsstring>(const SigningProvider &amp;provider, const BaseSignatureCreator &amp;creator, const CScript &amp;fromPubKey, SignatureData &amp;sigdata)</argsstring>
        <name>ProduceSignature</name>
        <param>
          <type>const <ref refid="class_signing_provider" kindref="compound">SigningProvider</ref> &amp;</type>
          <declname>provider</declname>
        </param>
        <param>
          <type>const <ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref> &amp;</type>
          <declname>creator</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_script" kindref="compound">CScript</ref> &amp;</type>
          <declname>scriptPubKey</declname>
          <defname>fromPubKey</defname>
        </param>
        <param>
          <type><ref refid="struct_signature_data" kindref="compound">SignatureData</ref> &amp;</type>
          <declname>sigdata</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Produce a script signature using a generic signature creator. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/script/sign.cpp" line="729" column="6" bodyfile="src/script/sign.cpp" bodystart="729" bodyend="801"/>
      </memberdef>
      <memberdef kind="function" id="sign_8cpp_1ac43070bee0b6bc72e2e2a738892dd1f3" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="struct_signature_data" kindref="compound">SignatureData</ref></type>
        <definition>SignatureData DataFromTransaction</definition>
        <argsstring>(const CMutableTransaction &amp;tx, unsigned int nIn, const CTxOut &amp;txout)</argsstring>
        <name>DataFromTransaction</name>
        <param>
          <type>const <ref refid="struct_c_mutable_transaction" kindref="compound">CMutableTransaction</ref> &amp;</type>
          <declname>tx</declname>
        </param>
        <param>
          <type>unsigned int</type>
          <declname>nIn</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_tx_out" kindref="compound">CTxOut</ref> &amp;</type>
          <declname>txout</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Extract signature data from a transaction input, and insert it. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/script/sign.cpp" line="837" column="15" bodyfile="src/script/sign.cpp" bodystart="837" bodyend="900"/>
      </memberdef>
      <memberdef kind="function" id="sign_8cpp_1a2051a9625f7300cb8ad7fdc1bc06f5c5" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void UpdateInput</definition>
        <argsstring>(CTxIn &amp;input, const SignatureData &amp;data)</argsstring>
        <name>UpdateInput</name>
        <param>
          <type><ref refid="class_c_tx_in" kindref="compound">CTxIn</ref> &amp;</type>
          <declname>input</declname>
        </param>
        <param>
          <type>const <ref refid="struct_signature_data" kindref="compound">SignatureData</ref> &amp;</type>
          <declname>data</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/script/sign.cpp" line="902" column="6" bodyfile="src/script/sign.cpp" bodystart="902" bodyend="906"/>
      </memberdef>
      <memberdef kind="function" id="sign_8cpp_1a234967049e0c0b1a8fcb9e3983f1ae64" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool IsSegWitOutput</definition>
        <argsstring>(const SigningProvider &amp;provider, const CScript &amp;script)</argsstring>
        <name>IsSegWitOutput</name>
        <param>
          <type>const <ref refid="class_signing_provider" kindref="compound">SigningProvider</ref> &amp;</type>
          <declname>provider</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_script" kindref="compound">CScript</ref> &amp;</type>
          <declname>script</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Check whether a scriptPubKey is known to be segwit. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/script/sign.cpp" line="990" column="6" bodyfile="src/script/sign.cpp" bodystart="990" bodyend="1007"/>
      </memberdef>
      <memberdef kind="function" id="sign_8cpp_1ac7f35d5b9f97114ac2e04834aad42f35" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool SignTransaction</definition>
        <argsstring>(CMutableTransaction &amp;mtx, const SigningProvider *keystore, const std::map&lt; COutPoint, Coin &gt; &amp;coins, int nHashType, std::map&lt; int, bilingual_str &gt; &amp;input_errors)</argsstring>
        <name>SignTransaction</name>
        <param>
          <type><ref refid="struct_c_mutable_transaction" kindref="compound">CMutableTransaction</ref> &amp;</type>
          <declname>mtx</declname>
        </param>
        <param>
          <type>const <ref refid="class_signing_provider" kindref="compound">SigningProvider</ref> *</type>
          <declname>provider</declname>
          <defname>keystore</defname>
        </param>
        <param>
          <type>const std::map&lt; <ref refid="class_c_out_point" kindref="compound">COutPoint</ref>, <ref refid="class_coin" kindref="compound">Coin</ref> &gt; &amp;</type>
          <declname>coins</declname>
        </param>
        <param>
          <type>int</type>
          <declname>sighash</declname>
          <defname>nHashType</defname>
        </param>
        <param>
          <type>std::map&lt; int, <ref refid="structbilingual__str" kindref="compound">bilingual_str</ref> &gt; &amp;</type>
          <declname>input_errors</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Sign the <ref refid="struct_c_mutable_transaction" kindref="compound">CMutableTransaction</ref> </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/script/sign.cpp" line="1009" column="6" bodyfile="src/script/sign.cpp" bodystart="1009" bodyend="1075"/>
      </memberdef>
    </sectiondef>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="comment">//<sp/>Copyright<sp/>(c)<sp/>2009-2010<sp/>Satoshi<sp/>Nakamoto</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Copyright<sp/>(c)<sp/>2009-present<sp/>The<sp/>Bitcoin<sp/>Core<sp/>developers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Distributed<sp/>under<sp/>the<sp/>MIT<sp/>software<sp/>license,<sp/>see<sp/>the<sp/>accompanying</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4"><highlight class="normal"></highlight><highlight class="comment">//<sp/>file<sp/>COPYING<sp/>or<sp/>http://www.opensource.org/licenses/mit-license.php.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5"><highlight class="normal"></highlight></codeline>
<codeline lineno="6"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="sign_8h" kindref="compound">script/sign.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="amount_8h" kindref="compound">consensus/amount.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="key_8h" kindref="compound">key.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="musig_8h" kindref="compound">musig.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="policy_8h" kindref="compound">policy/policy.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="primitives_2transaction_8h" kindref="compound">primitives/transaction.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="13"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;random.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="14"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="keyorigin_8h" kindref="compound">script/keyorigin.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="15"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="miniscript_8h" kindref="compound">script/miniscript.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="16"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="script_2script_8h" kindref="compound">script/script.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="17"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="signingprovider_8h" kindref="compound">script/signingprovider.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="18"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="solver_8h" kindref="compound">script/solver.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="19"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="uint256_8h" kindref="compound">uint256.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="20"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="translation_8h" kindref="compound">util/translation.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="21"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="vector_8h" kindref="compound">util/vector.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="22"><highlight class="normal"></highlight></codeline>
<codeline lineno="23"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/>std::vector&lt;unsigned<sp/>char&gt;<sp/><ref refid="addresstype_8cpp_1a893ae190c4461e89b01441657f8975ed" kindref="member">valtype</ref>;</highlight></codeline>
<codeline lineno="24"><highlight class="normal"></highlight></codeline>
<codeline lineno="25"><highlight class="normal"><ref refid="class_mutable_transaction_signature_creator_1a00aa6e37eb878636ab4a02f449a7f4c3" kindref="member">MutableTransactionSignatureCreator::MutableTransactionSignatureCreator</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_c_mutable_transaction" kindref="compound">CMutableTransaction</ref>&amp;<sp/>tx,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>input_idx,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref>&amp;<sp/>amount,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>hash_type)</highlight></codeline>
<codeline lineno="26"><highlight class="normal"><sp/><sp/><sp/><sp/>:<sp/>m_txto{tx},<sp/>nIn{input_idx},<sp/>nHashType{hash_type},<sp/>amount{amount},<sp/>checker{&amp;m_txto,<sp/>nIn,<sp/>amount,<sp/><ref refid="interpreter_8h_1acc6ee21a72d2acd6c95fc4de2c9e672e" kindref="member">MissingDataBehavior</ref>::<ref refid="interpreter_8h_1acc6ee21a72d2acd6c95fc4de2c9e672eac2759effffc94bb9acc71d69fe3e8a1f" kindref="member">FAIL</ref>},</highlight></codeline>
<codeline lineno="27"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_txdata(nullptr)</highlight></codeline>
<codeline lineno="28"><highlight class="normal">{</highlight></codeline>
<codeline lineno="29"><highlight class="normal">}</highlight></codeline>
<codeline lineno="30"><highlight class="normal"></highlight></codeline>
<codeline lineno="31"><highlight class="normal"><ref refid="class_mutable_transaction_signature_creator_1a00aa6e37eb878636ab4a02f449a7f4c3" kindref="member">MutableTransactionSignatureCreator::MutableTransactionSignatureCreator</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_c_mutable_transaction" kindref="compound">CMutableTransaction</ref>&amp;<sp/>tx,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>input_idx,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref>&amp;<sp/>amount,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_precomputed_transaction_data" kindref="compound">PrecomputedTransactionData</ref>*<sp/>txdata,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>hash_type)</highlight></codeline>
<codeline lineno="32"><highlight class="normal"><sp/><sp/><sp/><sp/>:<sp/>m_txto{tx},<sp/>nIn{input_idx},<sp/>nHashType{hash_type},<sp/>amount{amount},</highlight></codeline>
<codeline lineno="33"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>checker{txdata<sp/>?<sp/><ref refid="interpreter_8h_1a550f6fff1a461a56192dad807a412988" kindref="member">MutableTransactionSignatureChecker</ref>{&amp;m_txto,<sp/>nIn,<sp/>amount,<sp/>*txdata,<sp/><ref refid="interpreter_8h_1acc6ee21a72d2acd6c95fc4de2c9e672e" kindref="member">MissingDataBehavior</ref>::<ref refid="interpreter_8h_1acc6ee21a72d2acd6c95fc4de2c9e672eac2759effffc94bb9acc71d69fe3e8a1f" kindref="member">FAIL</ref>}<sp/>:</highlight></codeline>
<codeline lineno="34"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="interpreter_8h_1a550f6fff1a461a56192dad807a412988" kindref="member">MutableTransactionSignatureChecker</ref>{&amp;m_txto,<sp/>nIn,<sp/>amount,<sp/><ref refid="interpreter_8h_1acc6ee21a72d2acd6c95fc4de2c9e672e" kindref="member">MissingDataBehavior</ref>::<ref refid="interpreter_8h_1acc6ee21a72d2acd6c95fc4de2c9e672eac2759effffc94bb9acc71d69fe3e8a1f" kindref="member">FAIL</ref>}},</highlight></codeline>
<codeline lineno="35"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_txdata(txdata)</highlight></codeline>
<codeline lineno="36"><highlight class="normal">{</highlight></codeline>
<codeline lineno="37"><highlight class="normal">}</highlight></codeline>
<codeline lineno="38"><highlight class="normal"></highlight></codeline>
<codeline lineno="39"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_mutable_transaction_signature_creator_1a5560a7ae13132887ee7174d54e412199" kindref="member">MutableTransactionSignatureCreator::CreateSig</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_signing_provider" kindref="compound">SigningProvider</ref>&amp;<sp/>provider,<sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>vchSig,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_key_i_d" kindref="compound">CKeyID</ref>&amp;<sp/>address,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_script" kindref="compound">CScript</ref>&amp;<sp/>scriptCode,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref><sp/>sigversion)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="40"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="41"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(sigversion<sp/>==<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fae7b1a5c82772e0e055096008cb9883ef" kindref="member">SigVersion::BASE</ref><sp/>||<sp/>sigversion<sp/>==<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fafd7f573f76ca2911662d17ada249f8b0" kindref="member">SigVersion::WITNESS_V0</ref>);</highlight></codeline>
<codeline lineno="42"><highlight class="normal"></highlight></codeline>
<codeline lineno="43"><highlight class="normal"><sp/><sp/><sp/><sp/>CKey<sp/>key;</highlight></codeline>
<codeline lineno="44"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!provider.<ref refid="class_signing_provider_1a3704982f70765d351e289e3e329d1203" kindref="member">GetKey</ref>(address,<sp/>key))</highlight></codeline>
<codeline lineno="45"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="46"><highlight class="normal"></highlight></codeline>
<codeline lineno="47"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Signing<sp/>with<sp/>uncompressed<sp/>keys<sp/>is<sp/>disabled<sp/>in<sp/>witness<sp/>scripts</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="48"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sigversion<sp/>==<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fafd7f573f76ca2911662d17ada249f8b0" kindref="member">SigVersion::WITNESS_V0</ref><sp/>&amp;&amp;<sp/>!key.<ref refid="class_c_key_1a61c81b509c5f281f1afae76c7a3f3b4b" kindref="member">IsCompressed</ref>())</highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="50"><highlight class="normal"></highlight></codeline>
<codeline lineno="51"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Signing<sp/>without<sp/>known<sp/>amount<sp/>does<sp/>not<sp/>work<sp/>in<sp/>witness<sp/>scripts.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="52"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sigversion<sp/>==<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fafd7f573f76ca2911662d17ada249f8b0" kindref="member">SigVersion::WITNESS_V0</ref><sp/>&amp;&amp;<sp/>!<ref refid="amount_8h_1a12db56a9a1c931941f0943ecbb278aae" kindref="member">MoneyRange</ref>(amount))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="53"><highlight class="normal"></highlight></codeline>
<codeline lineno="54"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>BASE/WITNESS_V0<sp/>signatures<sp/>don&apos;t<sp/>support<sp/>explicit<sp/>SIGHASH_DEFAULT,<sp/>use<sp/>SIGHASH_ALL<sp/>instead.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="55"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>hashtype<sp/>=<sp/>nHashType<sp/>==<sp/><ref refid="interpreter_8h_1aad9879e99a65218a36881f0bc8713fcdab9456a9165db395967f3f02cf2609afa" kindref="member">SIGHASH_DEFAULT</ref><sp/>?<sp/><ref refid="interpreter_8h_1aad9879e99a65218a36881f0bc8713fcdac68c7df6528b3001624e56b2de3826de" kindref="member">SIGHASH_ALL</ref><sp/>:<sp/>nHashType;</highlight></codeline>
<codeline lineno="56"><highlight class="normal"></highlight></codeline>
<codeline lineno="57"><highlight class="normal"><sp/><sp/><sp/><sp/>uint256<sp/>hash<sp/>=<sp/><ref refid="interpreter_8cpp_1a63c4884dd720c4d306603998b5d02b49" kindref="member">SignatureHash</ref>(scriptCode,<sp/>m_txto,<sp/>nIn,<sp/>hashtype,<sp/>amount,<sp/>sigversion,<sp/>m_txdata);</highlight></codeline>
<codeline lineno="58"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!key.<ref refid="class_c_key_1a4143ab43733a1eef40d194163a2f69b0" kindref="member">Sign</ref>(hash,<sp/>vchSig))</highlight></codeline>
<codeline lineno="59"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="60"><highlight class="normal"><sp/><sp/><sp/><sp/>vchSig.push_back((</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">)hashtype);</highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="62"><highlight class="normal">}</highlight></codeline>
<codeline lineno="63"><highlight class="normal"></highlight></codeline>
<codeline lineno="64"><highlight class="normal">std::optional&lt;uint256&gt;<sp/>MutableTransactionSignatureCreator::ComputeSchnorrSignatureHash(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classuint256" kindref="compound">uint256</ref>*<sp/>leaf_hash,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref><sp/>sigversion)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="65"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="66"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(sigversion<sp/>==<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fa1526b180923f9569c6045129400229b9" kindref="member">SigVersion::TAPROOT</ref><sp/>||<sp/>sigversion<sp/>==<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8faf91c6e2b2fe0cbda47ac0801786555e9" kindref="member">SigVersion::TAPSCRIPT</ref>);</highlight></codeline>
<codeline lineno="67"><highlight class="normal"></highlight></codeline>
<codeline lineno="68"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>BIP341/BIP342<sp/>signing<sp/>needs<sp/>lots<sp/>of<sp/>precomputed<sp/>transaction<sp/>data.<sp/>While<sp/>some</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="69"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(non-SIGHASH_DEFAULT)<sp/>sighash<sp/>modes<sp/>exist<sp/>that<sp/>can<sp/>work<sp/>with<sp/>just<sp/>some<sp/>subset</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="70"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>of<sp/>data<sp/>present,<sp/>for<sp/>now,<sp/>only<sp/>support<sp/>signing<sp/>when<sp/>everything<sp/>is<sp/>provided.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="71"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_txdata<sp/>||<sp/>!m_txdata-&gt;m_bip341_taproot_ready<sp/>||<sp/>!m_txdata-&gt;m_spent_outputs_ready)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::nullopt;</highlight></codeline>
<codeline lineno="72"><highlight class="normal"></highlight></codeline>
<codeline lineno="73"><highlight class="normal"><sp/><sp/><sp/><sp/>ScriptExecutionData<sp/>execdata;</highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/><sp/><sp/>execdata.<ref refid="struct_script_execution_data_1a11f7505dd56cf7987f1854274e4e62a1" kindref="member">m_annex_init</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/><sp/><sp/>execdata.<ref refid="struct_script_execution_data_1a31f474872cf1cb9130722d4245c743b7" kindref="member">m_annex_present</ref><sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>Only<sp/>support<sp/>annex-less<sp/>signing<sp/>for<sp/>now.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sigversion<sp/>==<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8faf91c6e2b2fe0cbda47ac0801786555e9" kindref="member">SigVersion::TAPSCRIPT</ref>)<sp/>{</highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>execdata.<ref refid="struct_script_execution_data_1a5a0bb77afe371e4698e23df165ec0b42" kindref="member">m_codeseparator_pos_init</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>execdata.<ref refid="struct_script_execution_data_1ae44e83db143824e0b1b99c58c54e0056" kindref="member">m_codeseparator_pos</ref><sp/>=<sp/>0xFFFFFFFF;<sp/></highlight><highlight class="comment">//<sp/>Only<sp/>support<sp/>non-OP_CODESEPARATOR<sp/>BIP342<sp/>signing<sp/>for<sp/>now.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!leaf_hash)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::nullopt;<sp/></highlight><highlight class="comment">//<sp/>BIP342<sp/>signing<sp/>needs<sp/>leaf<sp/>hash.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>execdata.<ref refid="struct_script_execution_data_1a7f8c35c66c82d40b38b97447a93a620c" kindref="member">m_tapleaf_hash_init</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>execdata.<ref refid="struct_script_execution_data_1aebfcebdf336c738dabb9957952b800e1" kindref="member">m_tapleaf_hash</ref><sp/>=<sp/>*leaf_hash;</highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/><sp/><sp/>uint256<sp/>hash;</highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="interpreter_8cpp_1a1820ab094aadaa6bc34ff9ef9ee54cb4" kindref="member">SignatureHashSchnorr</ref>(hash,<sp/>execdata,<sp/>m_txto,<sp/>nIn,<sp/>nHashType,<sp/>sigversion,<sp/>*m_txdata,<sp/><ref refid="interpreter_8h_1acc6ee21a72d2acd6c95fc4de2c9e672eac2759effffc94bb9acc71d69fe3e8a1f" kindref="member">MissingDataBehavior::FAIL</ref>))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::nullopt;</highlight></codeline>
<codeline lineno="85"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>hash;</highlight></codeline>
<codeline lineno="86"><highlight class="normal">}</highlight></codeline>
<codeline lineno="87"><highlight class="normal"></highlight></codeline>
<codeline lineno="88"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_mutable_transaction_signature_creator_1ac4b0a71f471eb5705e91dec4c8043fbd" kindref="member">MutableTransactionSignatureCreator::CreateSchnorrSig</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_signing_provider" kindref="compound">SigningProvider</ref>&amp;<sp/>provider,<sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>sig,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_x_only_pub_key" kindref="compound">XOnlyPubKey</ref>&amp;<sp/>pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classuint256" kindref="compound">uint256</ref>*<sp/>leaf_hash,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classuint256" kindref="compound">uint256</ref>*<sp/>merkle_root,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref><sp/>sigversion)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="89"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/><sp/><sp/>CKey<sp/>key;</highlight></codeline>
<codeline lineno="91"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!provider.<ref refid="class_signing_provider_1a288fc2c4e4bffe6e93f0a9ac29a161eb" kindref="member">GetKeyByXOnly</ref>(pubkey,<sp/>key))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="92"><highlight class="normal"></highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/><sp/><sp/>std::optional&lt;uint256&gt;<sp/>hash<sp/>=<sp/>ComputeSchnorrSignatureHash(leaf_hash,<sp/>sigversion);</highlight></codeline>
<codeline lineno="94"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!hash.has_value())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="95"><highlight class="normal"></highlight></codeline>
<codeline lineno="96"><highlight class="normal"><sp/><sp/><sp/><sp/>sig.resize(64);</highlight></codeline>
<codeline lineno="97"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Use<sp/>uint256{}<sp/>as<sp/>aux_rnd<sp/>for<sp/>now.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="98"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!key.<ref refid="class_c_key_1a0884ca8071e122315e1fb5dc8efda906" kindref="member">SignSchnorr</ref>(*hash,<sp/>sig,<sp/>merkle_root,<sp/>{}))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nHashType)<sp/>sig.push_back(nHashType);</highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="101"><highlight class="normal">}</highlight></codeline>
<codeline lineno="102"><highlight class="normal"></highlight></codeline>
<codeline lineno="103"><highlight class="normal">std::vector&lt;uint8_t&gt;<sp/><ref refid="class_mutable_transaction_signature_creator_1a4d8795414a41622f361137fcb8458970" kindref="member">MutableTransactionSignatureCreator::CreateMuSig2Nonce</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_signing_provider" kindref="compound">SigningProvider</ref>&amp;<sp/>provider,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref>&amp;<sp/>aggregate_pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref>&amp;<sp/>script_pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref>&amp;<sp/>part_pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classuint256" kindref="compound">uint256</ref>*<sp/>leaf_hash,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classuint256" kindref="compound">uint256</ref>*<sp/>merkle_root,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref><sp/>sigversion,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_signature_data" kindref="compound">SignatureData</ref>&amp;<sp/>sigdata)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="104"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(sigversion<sp/>==<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fa1526b180923f9569c6045129400229b9" kindref="member">SigVersion::TAPROOT</ref><sp/>||<sp/>sigversion<sp/>==<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8faf91c6e2b2fe0cbda47ac0801786555e9" kindref="member">SigVersion::TAPSCRIPT</ref>);</highlight></codeline>
<codeline lineno="106"><highlight class="normal"></highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Retrieve<sp/>the<sp/>private<sp/>key</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/><sp/><sp/>CKey<sp/>key;</highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!provider.<ref refid="class_signing_provider_1a3704982f70765d351e289e3e329d1203" kindref="member">GetKey</ref>(part_pubkey.<ref refid="class_c_pub_key_1a0dcc3372f6142fc89e4bab57e10a67c7" kindref="member">GetID</ref>(),<sp/>key))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{};</highlight></codeline>
<codeline lineno="110"><highlight class="normal"></highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Retrieve<sp/>participant<sp/>pubkeys</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it<sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1abd1bbe6e76408211e402400d4c3029f0" kindref="member">musig2_pubkeys</ref>.find(aggregate_pubkey);</highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>==<sp/>sigdata.<ref refid="struct_signature_data_1abd1bbe6e76408211e402400d4c3029f0" kindref="member">musig2_pubkeys</ref>.end())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{};</highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;CPubKey&gt;&amp;<sp/>pubkeys<sp/>=<sp/>it-&gt;second;</highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(std::find(pubkeys.begin(),<sp/>pubkeys.end(),<sp/>part_pubkey)<sp/>==<sp/>pubkeys.end())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{};</highlight></codeline>
<codeline lineno="116"><highlight class="normal"></highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compute<sp/>sighash</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/><sp/><sp/>std::optional&lt;uint256&gt;<sp/>sighash<sp/>=<sp/>ComputeSchnorrSignatureHash(leaf_hash,<sp/>sigversion);</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sighash.has_value())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{};</highlight></codeline>
<codeline lineno="120"><highlight class="normal"></highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/><sp/><sp/>MuSig2SecNonce<sp/>secnonce;</highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;uint8_t&gt;<sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref><sp/>=<sp/>key.<ref refid="class_c_key_1a9f8effa6c90983899312668a2268c99f" kindref="member">CreateMuSig2Nonce</ref>(secnonce,<sp/>*sighash,<sp/>aggregate_pubkey,<sp/>pubkeys);</highlight></codeline>
<codeline lineno="123"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>.empty())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{};</highlight></codeline>
<codeline lineno="124"><highlight class="normal"></highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Store<sp/>the<sp/>secnonce<sp/>in<sp/>the<sp/>SigningProvider</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="126"><highlight class="normal"><sp/><sp/><sp/><sp/>provider.<ref refid="class_signing_provider_1a9e151c94981d85054608d981068f5356" kindref="member">SetMuSig2SecNonce</ref>(<ref refid="musig_8cpp_1a64c70b08ecbd7cec9f5765cc4d7f7046" kindref="member">MuSig2SessionID</ref>(script_pubkey,<sp/>part_pubkey,<sp/>*sighash),<sp/>std::move(secnonce));</highlight></codeline>
<codeline lineno="127"><highlight class="normal"></highlight></codeline>
<codeline lineno="128"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>;</highlight></codeline>
<codeline lineno="129"><highlight class="normal">}</highlight></codeline>
<codeline lineno="130"><highlight class="normal"></highlight></codeline>
<codeline lineno="131"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_mutable_transaction_signature_creator_1ae6a7a376bf7d3d4034b070848153e57a" kindref="member">MutableTransactionSignatureCreator::CreateMuSig2PartialSig</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_signing_provider" kindref="compound">SigningProvider</ref>&amp;<sp/>provider,<sp/><ref refid="classuint256" kindref="compound">uint256</ref>&amp;<sp/>partial_sig,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref>&amp;<sp/>aggregate_pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref>&amp;<sp/>script_pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref>&amp;<sp/>part_pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classuint256" kindref="compound">uint256</ref>*<sp/>leaf_hash,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;std::pair&lt;uint256,<sp/>bool&gt;&gt;&amp;<sp/>tweaks,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref><sp/>sigversion,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_signature_data" kindref="compound">SignatureData</ref>&amp;<sp/>sigdata)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="132"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(sigversion<sp/>==<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fa1526b180923f9569c6045129400229b9" kindref="member">SigVersion::TAPROOT</ref><sp/>||<sp/>sigversion<sp/>==<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8faf91c6e2b2fe0cbda47ac0801786555e9" kindref="member">SigVersion::TAPSCRIPT</ref>);</highlight></codeline>
<codeline lineno="134"><highlight class="normal"></highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Retrieve<sp/>private<sp/>key</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="136"><highlight class="normal"><sp/><sp/><sp/><sp/>CKey<sp/>key;</highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!provider.<ref refid="class_signing_provider_1a3704982f70765d351e289e3e329d1203" kindref="member">GetKey</ref>(part_pubkey.<ref refid="class_c_pub_key_1a0dcc3372f6142fc89e4bab57e10a67c7" kindref="member">GetID</ref>(),<sp/>key))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="138"><highlight class="normal"></highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Retrieve<sp/>participant<sp/>pubkeys</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it<sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1abd1bbe6e76408211e402400d4c3029f0" kindref="member">musig2_pubkeys</ref>.find(aggregate_pubkey);</highlight></codeline>
<codeline lineno="141"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>==<sp/>sigdata.<ref refid="struct_signature_data_1abd1bbe6e76408211e402400d4c3029f0" kindref="member">musig2_pubkeys</ref>.end())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="142"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;CPubKey&gt;&amp;<sp/>pubkeys<sp/>=<sp/>it-&gt;second;</highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(std::find(pubkeys.begin(),<sp/>pubkeys.end(),<sp/>part_pubkey)<sp/>==<sp/>pubkeys.end())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{};</highlight></codeline>
<codeline lineno="144"><highlight class="normal"></highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Retrieve<sp/>pubnonces</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="146"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>this_leaf_aggkey<sp/>=<sp/>std::make_pair(script_pubkey,<sp/>leaf_hash<sp/>?<sp/>*leaf_hash<sp/>:<sp/>uint256());</highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>pubnonce_it<sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1aa6000d64c345a191d20fa180d4f68800" kindref="member">musig2_pubnonces</ref>.find(this_leaf_aggkey);</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pubnonce_it<sp/>==<sp/>sigdata.<ref refid="struct_signature_data_1aa6000d64c345a191d20fa180d4f68800" kindref="member">musig2_pubnonces</ref>.end())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="149"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::map&lt;CPubKey,<sp/>std::vector&lt;uint8_t&gt;&gt;&amp;<sp/>pubnonces<sp/>=<sp/>pubnonce_it-&gt;second;</highlight></codeline>
<codeline lineno="150"><highlight class="normal"></highlight></codeline>
<codeline lineno="151"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>if<sp/>enough<sp/>pubnonces</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pubnonces.size()<sp/>!=<sp/>pubkeys.size())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="153"><highlight class="normal"></highlight></codeline>
<codeline lineno="154"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compute<sp/>sighash</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="155"><highlight class="normal"><sp/><sp/><sp/><sp/>std::optional&lt;uint256&gt;<sp/>sighash<sp/>=<sp/>ComputeSchnorrSignatureHash(leaf_hash,<sp/>sigversion);</highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sighash.has_value())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="157"><highlight class="normal"></highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Retrieve<sp/>the<sp/>secnonce</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="159"><highlight class="normal"><sp/><sp/><sp/><sp/>uint256<sp/>session_id<sp/>=<sp/><ref refid="musig_8cpp_1a64c70b08ecbd7cec9f5765cc4d7f7046" kindref="member">MuSig2SessionID</ref>(script_pubkey,<sp/>part_pubkey,<sp/>*sighash);</highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/><sp/><sp/>std::optional&lt;std::reference_wrapper&lt;MuSig2SecNonce&gt;&gt;<sp/>secnonce<sp/>=<sp/>provider.<ref refid="class_signing_provider_1a82df8438ba975095882baae73d16b338" kindref="member">GetMuSig2SecNonce</ref>(session_id);</highlight></codeline>
<codeline lineno="161"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!secnonce<sp/>||<sp/>!secnonce-&gt;get().IsValid())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="162"><highlight class="normal"></highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compute<sp/>the<sp/>sig</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/>std::optional&lt;uint256&gt;<sp/>sig<sp/>=<sp/>key.<ref refid="class_c_key_1a88514aca46316a04e95dfce4ec209d68" kindref="member">CreateMuSig2PartialSig</ref>(*sighash,<sp/>aggregate_pubkey,<sp/>pubkeys,<sp/>pubnonces,<sp/>*secnonce,<sp/>tweaks);</highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sig)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/><sp/><sp/>partial_sig<sp/>=<sp/>std::move(*sig);</highlight></codeline>
<codeline lineno="167"><highlight class="normal"></highlight></codeline>
<codeline lineno="168"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Delete<sp/>the<sp/>secnonce<sp/>now<sp/>that<sp/>we&apos;re<sp/>done<sp/>with<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!secnonce-&gt;get().IsValid());</highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/><sp/><sp/>provider.<ref refid="class_signing_provider_1a4911c90235623cb19aee6860a263a0d5" kindref="member">DeleteMuSig2Session</ref>(session_id);</highlight></codeline>
<codeline lineno="171"><highlight class="normal"></highlight></codeline>
<codeline lineno="172"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="173"><highlight class="normal">}</highlight></codeline>
<codeline lineno="174"><highlight class="normal"></highlight></codeline>
<codeline lineno="175"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_mutable_transaction_signature_creator_1a7a8936f50aa4cb36c4b59fc85996cf9f" kindref="member">MutableTransactionSignatureCreator::CreateMuSig2AggregateSig</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;CPubKey&gt;&amp;<sp/>participants,<sp/>std::vector&lt;uint8_t&gt;&amp;<sp/>sig,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref>&amp;<sp/>aggregate_pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref>&amp;<sp/>script_pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classuint256" kindref="compound">uint256</ref>*<sp/>leaf_hash,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;std::pair&lt;uint256,<sp/>bool&gt;&gt;&amp;<sp/>tweaks,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref><sp/>sigversion,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_signature_data" kindref="compound">SignatureData</ref>&amp;<sp/>sigdata)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="176"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(sigversion<sp/>==<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fa1526b180923f9569c6045129400229b9" kindref="member">SigVersion::TAPROOT</ref><sp/>||<sp/>sigversion<sp/>==<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8faf91c6e2b2fe0cbda47ac0801786555e9" kindref="member">SigVersion::TAPSCRIPT</ref>);</highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!participants.size())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="179"><highlight class="normal"></highlight></codeline>
<codeline lineno="180"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Retrieve<sp/>pubnonces<sp/>and<sp/>partial<sp/>sigs</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>this_leaf_aggkey<sp/>=<sp/>std::make_pair(script_pubkey,<sp/>leaf_hash<sp/>?<sp/>*leaf_hash<sp/>:<sp/>uint256());</highlight></codeline>
<codeline lineno="182"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>pubnonce_it<sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1aa6000d64c345a191d20fa180d4f68800" kindref="member">musig2_pubnonces</ref>.find(this_leaf_aggkey);</highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pubnonce_it<sp/>==<sp/>sigdata.<ref refid="struct_signature_data_1aa6000d64c345a191d20fa180d4f68800" kindref="member">musig2_pubnonces</ref>.end())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::map&lt;CPubKey,<sp/>std::vector&lt;uint8_t&gt;&gt;&amp;<sp/>pubnonces<sp/>=<sp/>pubnonce_it-&gt;second;</highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>partial_sigs_it<sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1a31623fa24c348b05a10013d5cd0a6714" kindref="member">musig2_partial_sigs</ref>.find(this_leaf_aggkey);</highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(partial_sigs_it<sp/>==<sp/>sigdata.<ref refid="struct_signature_data_1a31623fa24c348b05a10013d5cd0a6714" kindref="member">musig2_partial_sigs</ref>.end())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::map&lt;CPubKey,<sp/>uint256&gt;&amp;<sp/>partial_sigs<sp/>=<sp/>partial_sigs_it-&gt;second;</highlight></codeline>
<codeline lineno="188"><highlight class="normal"></highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>if<sp/>enough<sp/>pubnonces<sp/>and<sp/>partial<sp/>sigs</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pubnonces.size()<sp/>!=<sp/>participants.size())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(partial_sigs.size()<sp/>!=<sp/>participants.size())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="192"><highlight class="normal"></highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compute<sp/>sighash</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/>std::optional&lt;uint256&gt;<sp/>sighash<sp/>=<sp/>ComputeSchnorrSignatureHash(leaf_hash,<sp/>sigversion);</highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sighash.has_value())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="196"><highlight class="normal"></highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/>std::optional&lt;std::vector&lt;uint8_t&gt;&gt;<sp/>res<sp/>=<sp/><ref refid="class_mutable_transaction_signature_creator_1a7a8936f50aa4cb36c4b59fc85996cf9f" kindref="member">::CreateMuSig2AggregateSig</ref>(participants,<sp/>aggregate_pubkey,<sp/>tweaks,<sp/>*sighash,<sp/>pubnonces,<sp/>partial_sigs);</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!res)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/><sp/><sp/>sig<sp/>=<sp/>res.value();</highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nHashType)<sp/>sig.push_back(nHashType);</highlight></codeline>
<codeline lineno="201"><highlight class="normal"></highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="203"><highlight class="normal">}</highlight></codeline>
<codeline lineno="204"><highlight class="normal"></highlight></codeline>
<codeline lineno="205"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>GetCScript(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_signing_provider" kindref="compound">SigningProvider</ref>&amp;<sp/>provider,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_signature_data" kindref="compound">SignatureData</ref>&amp;<sp/>sigdata,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_script_i_d" kindref="compound">CScriptID</ref>&amp;<sp/>scriptid,<sp/><ref refid="class_c_script" kindref="compound">CScript</ref>&amp;<sp/><ref refid="namespacescript" kindref="compound">script</ref>)</highlight></codeline>
<codeline lineno="206"><highlight class="normal">{</highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(provider.<ref refid="class_signing_provider_1a375a2e74144c11516a5782d9ebc7c776" kindref="member">GetCScript</ref>(scriptid,<sp/><ref refid="namespacescript" kindref="compound">script</ref>))<sp/>{</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Look<sp/>for<sp/>scripts<sp/>in<sp/>SignatureData</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_c_script_i_d" kindref="compound">CScriptID</ref>(sigdata.<ref refid="struct_signature_data_1a3d6df9a2049980afa670d25531b9df35" kindref="member">redeem_script</ref>)<sp/>==<sp/>scriptid)<sp/>{</highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacescript" kindref="compound">script</ref><sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1a3d6df9a2049980afa670d25531b9df35" kindref="member">redeem_script</ref>;</highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_c_script_i_d" kindref="compound">CScriptID</ref>(sigdata.<ref refid="struct_signature_data_1a7968944b3535b0880179f50b2d2f111e" kindref="member">witness_script</ref>)<sp/>==<sp/>scriptid)<sp/>{</highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacescript" kindref="compound">script</ref><sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1a7968944b3535b0880179f50b2d2f111e" kindref="member">witness_script</ref>;</highlight></codeline>
<codeline lineno="216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="217"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="218"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="219"><highlight class="normal">}</highlight></codeline>
<codeline lineno="220"><highlight class="normal"></highlight></codeline>
<codeline lineno="221"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>GetPubKey(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_signing_provider" kindref="compound">SigningProvider</ref>&amp;<sp/>provider,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_signature_data" kindref="compound">SignatureData</ref>&amp;<sp/>sigdata,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_key_i_d" kindref="compound">CKeyID</ref>&amp;<sp/>address,<sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref>&amp;<sp/>pubkey)</highlight></codeline>
<codeline lineno="222"><highlight class="normal">{</highlight></codeline>
<codeline lineno="223"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Look<sp/>for<sp/>pubkey<sp/>in<sp/>all<sp/>partial<sp/>sigs</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it<sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1a45f002ec3e29dc54f4154d9b506e1b46" kindref="member">signatures</ref>.find(address);</highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>!=<sp/>sigdata.<ref refid="struct_signature_data_1a45f002ec3e29dc54f4154d9b506e1b46" kindref="member">signatures</ref>.end())<sp/>{</highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pubkey<sp/>=<sp/>it-&gt;second.first;</highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="229"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Look<sp/>for<sp/>pubkey<sp/>in<sp/>pubkey<sp/>lists</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>pk_it<sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1ae4c061edafaba77b8c49f7393797b580" kindref="member">misc_pubkeys</ref>.find(address);</highlight></codeline>
<codeline lineno="231"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pk_it<sp/>!=<sp/>sigdata.<ref refid="struct_signature_data_1ae4c061edafaba77b8c49f7393797b580" kindref="member">misc_pubkeys</ref>.end())<sp/>{</highlight></codeline>
<codeline lineno="232"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pubkey<sp/>=<sp/>pk_it-&gt;second.first;</highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tap_pk_it<sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1a2a352f8ea466f3c4da68dbf09e385d6b" kindref="member">tap_pubkeys</ref>.find(address);</highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tap_pk_it<sp/>!=<sp/>sigdata.<ref refid="struct_signature_data_1a2a352f8ea466f3c4da68dbf09e385d6b" kindref="member">tap_pubkeys</ref>.end())<sp/>{</highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pubkey<sp/>=<sp/>tap_pk_it-&gt;second.GetEvenCorrespondingCPubKey();</highlight></codeline>
<codeline lineno="238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="240"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Query<sp/>the<sp/>underlying<sp/>provider</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="241"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>provider.<ref refid="class_signing_provider_1a176f28791cca9bb7467bc56bac22909d" kindref="member">GetPubKey</ref>(address,<sp/>pubkey);</highlight></codeline>
<codeline lineno="242"><highlight class="normal">}</highlight></codeline>
<codeline lineno="243"><highlight class="normal"></highlight></codeline>
<codeline lineno="244"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CreateSig(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref>&amp;<sp/>creator,<sp/><ref refid="struct_signature_data" kindref="compound">SignatureData</ref>&amp;<sp/>sigdata,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_signing_provider" kindref="compound">SigningProvider</ref>&amp;<sp/>provider,<sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>sig_out,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref>&amp;<sp/>pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_script" kindref="compound">CScript</ref>&amp;<sp/>scriptcode,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref><sp/>sigversion)</highlight></codeline>
<codeline lineno="245"><highlight class="normal">{</highlight></codeline>
<codeline lineno="246"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_key_i_d" kindref="compound">CKeyID</ref><sp/>keyid<sp/>=<sp/>pubkey.<ref refid="class_c_pub_key_1a0dcc3372f6142fc89e4bab57e10a67c7" kindref="member">GetID</ref>();</highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it<sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1a45f002ec3e29dc54f4154d9b506e1b46" kindref="member">signatures</ref>.find(keyid);</highlight></codeline>
<codeline lineno="248"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>!=<sp/>sigdata.<ref refid="struct_signature_data_1a45f002ec3e29dc54f4154d9b506e1b46" kindref="member">signatures</ref>.end())<sp/>{</highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sig_out<sp/>=<sp/>it-&gt;second.second;</highlight></codeline>
<codeline lineno="250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_key_origin_info" kindref="compound">KeyOriginInfo</ref><sp/>info;</highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(provider.<ref refid="class_signing_provider_1a2e762f6836777e0fde8ccc31f1497079" kindref="member">GetKeyOrigin</ref>(keyid,<sp/>info))<sp/>{</highlight></codeline>
<codeline lineno="254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1ae4c061edafaba77b8c49f7393797b580" kindref="member">misc_pubkeys</ref>.emplace(keyid,<sp/>std::make_pair(pubkey,<sp/>std::move(info)));</highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(creator.<ref refid="class_base_signature_creator_1a4814a3d71dfa16e5f953757ab139ad72" kindref="member">CreateSig</ref>(provider,<sp/>sig_out,<sp/>keyid,<sp/>scriptcode,<sp/>sigversion))<sp/>{</highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1a45f002ec3e29dc54f4154d9b506e1b46" kindref="member">signatures</ref>.emplace(keyid,<sp/><ref refid="sign_8h_1a423149d75b2fd4374004050af6d777eb" kindref="member">SigPair</ref>(pubkey,<sp/>sig_out));</highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(i.second);</highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Could<sp/>not<sp/>make<sp/>signature<sp/>or<sp/>signature<sp/>not<sp/>found,<sp/>add<sp/>keyid<sp/>to<sp/>missing</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1a1162c496a29b007709f1590026acfbfc" kindref="member">missing_sigs</ref>.push_back(keyid);</highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="264"><highlight class="normal">}</highlight></codeline>
<codeline lineno="265"><highlight class="normal"></highlight></codeline>
<codeline lineno="266"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>SignMuSig2(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref>&amp;<sp/>creator,<sp/><ref refid="struct_signature_data" kindref="compound">SignatureData</ref>&amp;<sp/>sigdata,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_signing_provider" kindref="compound">SigningProvider</ref>&amp;<sp/>provider,<sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>sig_out,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_x_only_pub_key" kindref="compound">XOnlyPubKey</ref>&amp;<sp/>script_pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classuint256" kindref="compound">uint256</ref>*<sp/>merkle_root,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classuint256" kindref="compound">uint256</ref>*<sp/>leaf_hash,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref><sp/>sigversion)</highlight></codeline>
<codeline lineno="267"><highlight class="normal">{</highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(sigversion<sp/>==<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fa1526b180923f9569c6045129400229b9" kindref="member">SigVersion::TAPROOT</ref><sp/>||<sp/>sigversion<sp/>==<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8faf91c6e2b2fe0cbda47ac0801786555e9" kindref="member">SigVersion::TAPSCRIPT</ref>);</highlight></codeline>
<codeline lineno="269"><highlight class="normal"></highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Lookup<sp/>derivation<sp/>paths<sp/>for<sp/>the<sp/>script<sp/>pubkey</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_key_origin_info" kindref="compound">KeyOriginInfo</ref><sp/>agg_info;</highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>misc_pk_it<sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1ac6afd2e226063a81e81a813883883803" kindref="member">taproot_misc_pubkeys</ref>.find(script_pubkey);</highlight></codeline>
<codeline lineno="273"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(misc_pk_it<sp/>!=<sp/>sigdata.<ref refid="struct_signature_data_1ac6afd2e226063a81e81a813883883803" kindref="member">taproot_misc_pubkeys</ref>.end())<sp/>{</highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>agg_info<sp/>=<sp/>misc_pk_it-&gt;second.second;</highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="276"><highlight class="normal"></highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>[agg_pub,<sp/>part_pks]<sp/>:<sp/>sigdata.<ref refid="struct_signature_data_1abd1bbe6e76408211e402400d4c3029f0" kindref="member">musig2_pubkeys</ref>)<sp/>{</highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(part_pks.empty())<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="279"><highlight class="normal"></highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Fill<sp/>participant<sp/>derivation<sp/>path<sp/>info</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>part_pk<sp/>:<sp/>part_pks)<sp/>{</highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_key_origin_info" kindref="compound">KeyOriginInfo</ref><sp/>part_info;</highlight></codeline>
<codeline lineno="283"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(provider.<ref refid="class_signing_provider_1a2e762f6836777e0fde8ccc31f1497079" kindref="member">GetKeyOrigin</ref>(part_pk.GetID(),<sp/>part_info))<sp/>{</highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_x_only_pub_key" kindref="compound">XOnlyPubKey</ref><sp/>xonly_part(part_pk);</highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it<sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1ac6afd2e226063a81e81a813883883803" kindref="member">taproot_misc_pubkeys</ref>.find(xonly_part);</highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>==<sp/>sigdata.<ref refid="struct_signature_data_1ac6afd2e226063a81e81a813883883803" kindref="member">taproot_misc_pubkeys</ref>.end())<sp/>{</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>it<sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1ac6afd2e226063a81e81a813883883803" kindref="member">taproot_misc_pubkeys</ref>.emplace(xonly_part,<sp/>std::make_pair(std::set&lt;uint256&gt;(),<sp/>part_info)).first;</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="289"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(leaf_hash)<sp/>it-&gt;second.first.insert(*leaf_hash);</highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="292"><highlight class="normal"></highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>pubkey<sp/>in<sp/>the<sp/>script<sp/>may<sp/>not<sp/>be<sp/>the<sp/>actual<sp/>aggregate<sp/>of<sp/>the<sp/>participants,<sp/>but<sp/>derived<sp/>from<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>the<sp/>derivation,<sp/>and<sp/>compute<sp/>the<sp/>BIP<sp/>32<sp/>derivation<sp/>tweaks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;std::pair&lt;uint256,<sp/>bool&gt;&gt;<sp/>tweaks;</highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref><sp/>plain_pub<sp/>=<sp/>agg_pub;</highlight></codeline>
<codeline lineno="297"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_x_only_pub_key" kindref="compound">XOnlyPubKey</ref>(agg_pub)<sp/>!=<sp/>script_pubkey)<sp/>{</highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(agg_info.<ref refid="struct_key_origin_info_1a4e72d747441d675f2c8b53617d2cfdd8" kindref="member">path</ref>.empty())<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compute<sp/>and<sp/>compare<sp/>fingerprint</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_key_i_d" kindref="compound">CKeyID</ref><sp/>keyid<sp/>=<sp/>agg_pub.GetID();</highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!std::equal(agg_info.<ref refid="struct_key_origin_info_1a5c5c4261288c6c88bcf9a15684d773c4" kindref="member">fingerprint</ref>,<sp/>agg_info.<ref refid="struct_key_origin_info_1a5c5c4261288c6c88bcf9a15684d773c4" kindref="member">fingerprint</ref><sp/>+<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(agg_info.<ref refid="struct_key_origin_info_1a5c5c4261288c6c88bcf9a15684d773c4" kindref="member">fingerprint</ref>),<sp/>keyid.<ref refid="classbase__blob_1ad33ec60b8fc9ad7eef168e57aa6c5fb9" kindref="member">data</ref>()))<sp/>{</highlight></codeline>
<codeline lineno="302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Get<sp/>the<sp/>BIP32<sp/>derivation<sp/>tweaks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_c_ext_pub_key" kindref="compound">CExtPubKey</ref><sp/>extpub<sp/>=<sp/><ref refid="musig_8cpp_1a3abea53654d71e451d7c6f92ab3b7e67" kindref="member">CreateMuSig2SyntheticXpub</ref>(agg_pub);</highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>:<sp/>agg_info.<ref refid="struct_key_origin_info_1a4e72d747441d675f2c8b53617d2cfdd8" kindref="member">path</ref>)<sp/>{</highlight></codeline>
<codeline lineno="307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>[<ref refid="strencodings_8h_1a7a8fe8e8ebe30d3329bb57478f49ae2cae358efa489f58062f10dd7316b65649e" kindref="member">t</ref>,<sp/>xonly]<sp/>=<sp/>tweaks.emplace_back();</highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>xonly<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!extpub.<ref refid="struct_c_ext_pub_key_1a11f9cd6106eedd60befba6af71138308" kindref="member">Derive</ref>(extpub,<sp/>i,<sp/>&amp;<ref refid="strencodings_8h_1a7a8fe8e8ebe30d3329bb57478f49ae2cae358efa489f58062f10dd7316b65649e" kindref="member">t</ref>))<sp/>{</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(<ref refid="class_x_only_pub_key" kindref="compound">XOnlyPubKey</ref>(extpub.<ref refid="struct_c_ext_pub_key_1a01b5be1d1442d81c24bb9602c0bb402b" kindref="member">pubkey</ref>)<sp/>==<sp/>script_pubkey);</highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>plain_pub<sp/>=<sp/>extpub.<ref refid="struct_c_ext_pub_key_1a01b5be1d1442d81c24bb9602c0bb402b" kindref="member">pubkey</ref>;</highlight></codeline>
<codeline lineno="315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="316"><highlight class="normal"></highlight></codeline>
<codeline lineno="317"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Add<sp/>the<sp/>merkle<sp/>root<sp/>tweak</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sigversion<sp/>==<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fa1526b180923f9569c6045129400229b9" kindref="member">SigVersion::TAPROOT</ref><sp/>&amp;&amp;<sp/>merkle_root)<sp/>{</highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tweaks.emplace_back(script_pubkey.<ref refid="class_x_only_pub_key_1a05761a29a67a2217e5af0ca0789d119c" kindref="member">ComputeTapTweakHash</ref>(merkle_root-&gt;<ref refid="classbase__blob_1a067b44b9f2bd293d8a93401655e6476e" kindref="member">IsNull</ref>()<sp/>?<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>:<sp/>merkle_root),<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::optional&lt;std::pair&lt;XOnlyPubKey,<sp/>bool&gt;&gt;<sp/>tweaked<sp/>=<sp/>script_pubkey.<ref refid="class_x_only_pub_key_1a78106f91eb59a5eb7957bb4da69e47d6" kindref="member">CreateTapTweak</ref>(merkle_root-&gt;<ref refid="classbase__blob_1a067b44b9f2bd293d8a93401655e6476e" kindref="member">IsNull</ref>()<sp/>?<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>:<sp/>merkle_root);</highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(tweaked))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>plain_pub<sp/>=<sp/>tweaked-&gt;first.GetCPubKeys().at(tweaked-&gt;second<sp/>?<sp/>1<sp/>:<sp/>0);</highlight></codeline>
<codeline lineno="323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="324"><highlight class="normal"></highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>First<sp/>try<sp/>to<sp/>aggregate</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(creator.<ref refid="class_base_signature_creator_1ab5b62473d424817cf4f70b754b181acc" kindref="member">CreateMuSig2AggregateSig</ref>(part_pks,<sp/>sig_out,<sp/>agg_pub,<sp/>plain_pub,<sp/>leaf_hash,<sp/>tweaks,<sp/>sigversion,<sp/>sigdata))<sp/>{</highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sigversion<sp/>==<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fa1526b180923f9569c6045129400229b9" kindref="member">SigVersion::TAPROOT</ref>)<sp/>{</highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1a47015f3e4f10adf42eefeea003a0ef4e" kindref="member">taproot_key_path_sig</ref><sp/>=<sp/>sig_out;</highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>lookup_key<sp/>=<sp/>std::make_pair(script_pubkey,<sp/>leaf_hash<sp/>?<sp/>*leaf_hash<sp/>:<sp/><ref refid="classuint256" kindref="compound">uint256</ref>());</highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1aa8cf7ecedb1a6cb158f33c9e77ffcf89" kindref="member">taproot_script_sigs</ref>[lookup_key]<sp/>=<sp/>sig_out;</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Cannot<sp/>aggregate,<sp/>try<sp/>making<sp/>partial<sp/>sigs<sp/>for<sp/>every<sp/>participant</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>pub_key_leaf_hash<sp/>=<sp/>std::make_pair(plain_pub,<sp/>leaf_hash<sp/>?<sp/>*leaf_hash<sp/>:<sp/><ref refid="classuint256" kindref="compound">uint256</ref>());</highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref>&amp;<sp/>part_pk<sp/>:<sp/>part_pks)<sp/>{</highlight></codeline>
<codeline lineno="338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classuint256" kindref="compound">uint256</ref><sp/>partial_sig;</highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(creator.<ref refid="class_base_signature_creator_1ad1bb640ddefd7c413527858c764f53fd" kindref="member">CreateMuSig2PartialSig</ref>(provider,<sp/>partial_sig,<sp/>agg_pub,<sp/>plain_pub,<sp/>part_pk,<sp/>leaf_hash,<sp/>tweaks,<sp/>sigversion,<sp/>sigdata)<sp/>&amp;&amp;<sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(!partial_sig.<ref refid="classbase__blob_1a067b44b9f2bd293d8a93401655e6476e" kindref="member">IsNull</ref>()))<sp/>{</highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1a31623fa24c348b05a10013d5cd0a6714" kindref="member">musig2_partial_sigs</ref>[pub_key_leaf_hash].emplace(part_pk,<sp/>partial_sig);</highlight></codeline>
<codeline lineno="341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>there<sp/>are<sp/>any<sp/>partial<sp/>signatures,<sp/>continue<sp/>with<sp/>next<sp/>aggregate<sp/>pubkey</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>partial_sigs_it<sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1a31623fa24c348b05a10013d5cd0a6714" kindref="member">musig2_partial_sigs</ref>.find(pub_key_leaf_hash);</highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(partial_sigs_it<sp/>!=<sp/>sigdata.<ref refid="struct_signature_data_1a31623fa24c348b05a10013d5cd0a6714" kindref="member">musig2_partial_sigs</ref>.end()<sp/>&amp;&amp;<sp/>!partial_sigs_it-&gt;second.empty())<sp/>{</highlight></codeline>
<codeline lineno="346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>No<sp/>partial<sp/>sigs,<sp/>try<sp/>to<sp/>make<sp/>pubnonces</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="349"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::map&lt;CPubKey,<sp/>std::vector&lt;uint8_t&gt;&gt;&amp;<sp/>pubnonces<sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1aa6000d64c345a191d20fa180d4f68800" kindref="member">musig2_pubnonces</ref>[pub_key_leaf_hash];</highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref>&amp;<sp/>part_pk<sp/>:<sp/>part_pks)<sp/>{</highlight></codeline>
<codeline lineno="351"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pubnonces.contains(part_pk))<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="352"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;uint8_t&gt;<sp/>pubnonce<sp/>=<sp/>creator.<ref refid="class_base_signature_creator_1a66aed277cd58bf002129cab0f512dc0c" kindref="member">CreateMuSig2Nonce</ref>(provider,<sp/>agg_pub,<sp/>plain_pub,<sp/>part_pk,<sp/>leaf_hash,<sp/>merkle_root,<sp/>sigversion,<sp/>sigdata);</highlight></codeline>
<codeline lineno="353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pubnonce.empty())<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pubnonces[part_pk]<sp/>=<sp/>std::move(pubnonce);</highlight></codeline>
<codeline lineno="355"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="356"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="357"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="358"><highlight class="normal">}</highlight></codeline>
<codeline lineno="359"><highlight class="normal"></highlight></codeline>
<codeline lineno="360"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CreateTaprootScriptSig(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref>&amp;<sp/>creator,<sp/><ref refid="struct_signature_data" kindref="compound">SignatureData</ref>&amp;<sp/>sigdata,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_signing_provider" kindref="compound">SigningProvider</ref>&amp;<sp/>provider,<sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>sig_out,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_x_only_pub_key" kindref="compound">XOnlyPubKey</ref>&amp;<sp/>pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classuint256" kindref="compound">uint256</ref>&amp;<sp/>leaf_hash,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref><sp/>sigversion)</highlight></codeline>
<codeline lineno="361"><highlight class="normal">{</highlight></codeline>
<codeline lineno="362"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_key_origin_info" kindref="compound">KeyOriginInfo</ref><sp/>info;</highlight></codeline>
<codeline lineno="363"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(provider.<ref refid="class_signing_provider_1a2b9533a2d663e22a10065e4639ce55f0" kindref="member">GetKeyOriginByXOnly</ref>(pubkey,<sp/>info))<sp/>{</highlight></codeline>
<codeline lineno="364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it<sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1ac6afd2e226063a81e81a813883883803" kindref="member">taproot_misc_pubkeys</ref>.find(pubkey);</highlight></codeline>
<codeline lineno="365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>==<sp/>sigdata.<ref refid="struct_signature_data_1ac6afd2e226063a81e81a813883883803" kindref="member">taproot_misc_pubkeys</ref>.end())<sp/>{</highlight></codeline>
<codeline lineno="366"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1ac6afd2e226063a81e81a813883883803" kindref="member">taproot_misc_pubkeys</ref>.emplace(pubkey,<sp/>std::make_pair(std::set&lt;uint256&gt;({leaf_hash}),<sp/>info));</highlight></codeline>
<codeline lineno="367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>it-&gt;second.first.insert(leaf_hash);</highlight></codeline>
<codeline lineno="369"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="370"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="371"><highlight class="normal"></highlight></codeline>
<codeline lineno="372"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>lookup_key<sp/>=<sp/>std::make_pair(pubkey,<sp/>leaf_hash);</highlight></codeline>
<codeline lineno="373"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it<sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1aa8cf7ecedb1a6cb158f33c9e77ffcf89" kindref="member">taproot_script_sigs</ref>.find(lookup_key);</highlight></codeline>
<codeline lineno="374"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>!=<sp/>sigdata.<ref refid="struct_signature_data_1aa8cf7ecedb1a6cb158f33c9e77ffcf89" kindref="member">taproot_script_sigs</ref>.end())<sp/>{</highlight></codeline>
<codeline lineno="375"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sig_out<sp/>=<sp/>it-&gt;second;</highlight></codeline>
<codeline lineno="376"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="377"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="378"><highlight class="normal"></highlight></codeline>
<codeline lineno="379"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(creator.<ref refid="class_base_signature_creator_1afd93116b087bcf9fb2a936884d551d39" kindref="member">CreateSchnorrSig</ref>(provider,<sp/>sig_out,<sp/>pubkey,<sp/>&amp;leaf_hash,<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">,<sp/>sigversion))<sp/>{</highlight></codeline>
<codeline lineno="380"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1aa8cf7ecedb1a6cb158f33c9e77ffcf89" kindref="member">taproot_script_sigs</ref>[lookup_key]<sp/>=<sp/>sig_out;</highlight></codeline>
<codeline lineno="381"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!SignMuSig2(creator,<sp/>sigdata,<sp/>provider,<sp/>sig_out,<sp/>pubkey,<sp/></highlight><highlight class="comment">/*merkle_root=*/</highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">,<sp/>&amp;leaf_hash,<sp/>sigversion))<sp/>{</highlight></codeline>
<codeline lineno="382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="383"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="384"><highlight class="normal"></highlight></codeline>
<codeline lineno="385"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>sigdata.<ref refid="struct_signature_data_1aa8cf7ecedb1a6cb158f33c9e77ffcf89" kindref="member">taproot_script_sigs</ref>.contains(lookup_key);</highlight></codeline>
<codeline lineno="386"><highlight class="normal">}</highlight></codeline>
<codeline lineno="387"><highlight class="normal"></highlight></codeline>
<codeline lineno="388"><highlight class="normal"></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">typename</highlight><highlight class="normal"><sp/>M,<sp/></highlight><highlight class="keyword">typename</highlight><highlight class="normal"><sp/>K,<sp/></highlight><highlight class="keyword">typename</highlight><highlight class="normal"><sp/>V&gt;</highlight></codeline>
<codeline lineno="389"><highlight class="normal"><ref refid="namespaceminiscript_1adfd5523d4b709d5e28349355e79255db" kindref="member">miniscript::Availability</ref><sp/><ref refid="sign_8cpp_1af1a1b251ba23c7ea4c2b29a6ef96cff6" kindref="member">MsLookupHelper</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="strencodings_8h_1a7a8fe8e8ebe30d3329bb57478f49ae2ca69691c7bdcc3ce6d5d8a1361f22d04ac" kindref="member">M</ref>&amp;<sp/>map,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="strencodings_8h_1a7a8fe8e8ebe30d3329bb57478f49ae2caa5f3c6a11b03839d46af9fb43c97c188" kindref="member">K</ref>&amp;<sp/>key,<sp/>V&amp;<sp/>value)</highlight></codeline>
<codeline lineno="390"><highlight class="normal">{</highlight></codeline>
<codeline lineno="391"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it<sp/>=<sp/>map.find(key);</highlight></codeline>
<codeline lineno="392"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>!=<sp/>map.end())<sp/>{</highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>value<sp/>=<sp/>it-&gt;second;</highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="namespaceminiscript_1adfd5523d4b709d5e28349355e79255dba7469a286259799e5b37e5db9296f00b3" kindref="member">miniscript::Availability::YES</ref>;</highlight></codeline>
<codeline lineno="395"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="396"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="namespaceminiscript_1adfd5523d4b709d5e28349355e79255dbac2f3f489a00553e7a01d369c103c7251" kindref="member">miniscript::Availability::NO</ref>;</highlight></codeline>
<codeline lineno="397"><highlight class="normal">}</highlight></codeline>
<codeline lineno="398"><highlight class="normal"></highlight></codeline>
<codeline lineno="403"><highlight class="normal"></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">typename</highlight><highlight class="normal"><sp/>Pk&gt;</highlight></codeline>
<codeline lineno="404" refid="struct_satisfier" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="struct_satisfier_1aade33e8a5daf0b26c7503871f9f43b7d" kindref="member">Satisfier</ref><sp/>{</highlight></codeline>
<codeline lineno="405"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">using<sp/></highlight><highlight class="normal"><ref refid="struct_satisfier_1a6fd11019e6416be302ef4918dd7be409" kindref="member">Key</ref><sp/>=<sp/>Pk;</highlight></codeline>
<codeline lineno="406"><highlight class="normal"></highlight></codeline>
<codeline lineno="407"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_signing_provider" kindref="compound">SigningProvider</ref>&amp;<sp/><ref refid="struct_satisfier_1a2e98a1e2cc3613678bcc06d089df9a10" kindref="member">m_provider</ref>;</highlight></codeline>
<codeline lineno="408"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_signature_data" kindref="compound">SignatureData</ref>&amp;<sp/><ref refid="struct_satisfier_1ab49df918fdf53583d06794469dd41f8c" kindref="member">m_sig_data</ref>;</highlight></codeline>
<codeline lineno="409"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref>&amp;<sp/><ref refid="struct_satisfier_1a8fbc1d542a6eb9085f406441a7256039" kindref="member">m_creator</ref>;</highlight></codeline>
<codeline lineno="410"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_script" kindref="compound">CScript</ref>&amp;<sp/><ref refid="struct_satisfier_1aa1b9e74aa56f436d2deaa266efbc50f6" kindref="member">m_witness_script</ref>;</highlight></codeline>
<codeline lineno="412"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="namespaceminiscript_1a2bd485f92f346bb2c8cb4189d22e1530" kindref="member">miniscript::MiniscriptContext</ref><sp/><ref refid="struct_satisfier_1ae6634fbeec551fbec71c7e9db119581d" kindref="member">m_script_ctx</ref>;</highlight></codeline>
<codeline lineno="413"><highlight class="normal"></highlight></codeline>
<codeline lineno="414"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">explicit</highlight><highlight class="normal"><sp/><ref refid="struct_satisfier_1aade33e8a5daf0b26c7503871f9f43b7d" kindref="member">Satisfier</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_signing_provider" kindref="compound">SigningProvider</ref>&amp;<sp/>provider<sp/><ref refid="attributes_8h_1a37bc3dacb49779a0d18439d4383e5fd9" kindref="member">LIFETIMEBOUND</ref>,<sp/><ref refid="struct_signature_data" kindref="compound">SignatureData</ref>&amp;<sp/>sig_data<sp/><ref refid="attributes_8h_1a37bc3dacb49779a0d18439d4383e5fd9" kindref="member">LIFETIMEBOUND</ref>,</highlight></codeline>
<codeline lineno="415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref>&amp;<sp/>creator<sp/><ref refid="attributes_8h_1a37bc3dacb49779a0d18439d4383e5fd9" kindref="member">LIFETIMEBOUND</ref>,</highlight></codeline>
<codeline lineno="416"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_script" kindref="compound">CScript</ref>&amp;<sp/>witscript<sp/><ref refid="attributes_8h_1a37bc3dacb49779a0d18439d4383e5fd9" kindref="member">LIFETIMEBOUND</ref>,</highlight></codeline>
<codeline lineno="417"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceminiscript_1a2bd485f92f346bb2c8cb4189d22e1530" kindref="member">miniscript::MiniscriptContext</ref><sp/>script_ctx)<sp/>:<sp/><ref refid="struct_satisfier_1a2e98a1e2cc3613678bcc06d089df9a10" kindref="member">m_provider</ref>(provider),</highlight></codeline>
<codeline lineno="418"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_satisfier_1ab49df918fdf53583d06794469dd41f8c" kindref="member">m_sig_data</ref>(sig_data),</highlight></codeline>
<codeline lineno="419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_satisfier_1a8fbc1d542a6eb9085f406441a7256039" kindref="member">m_creator</ref>(creator),</highlight></codeline>
<codeline lineno="420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_satisfier_1aa1b9e74aa56f436d2deaa266efbc50f6" kindref="member">m_witness_script</ref>(witscript),</highlight></codeline>
<codeline lineno="421"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_satisfier_1ae6634fbeec551fbec71c7e9db119581d" kindref="member">m_script_ctx</ref>(script_ctx)<sp/>{}</highlight></codeline>
<codeline lineno="422"><highlight class="normal"></highlight></codeline>
<codeline lineno="423"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="struct_satisfier_1a2be31829c364848785959a46fd381feb" kindref="member">KeyCompare</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_satisfier_1a6fd11019e6416be302ef4918dd7be409" kindref="member">Key</ref>&amp;<sp/>a,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_satisfier_1a6fd11019e6416be302ef4918dd7be409" kindref="member">Key</ref>&amp;<sp/>b)<sp/>{</highlight></codeline>
<codeline lineno="424"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>a<sp/>&lt;<sp/>b;</highlight></codeline>
<codeline lineno="425"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="426"><highlight class="normal"></highlight></codeline>
<codeline lineno="428"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">typename</highlight><highlight class="normal"><sp/>I&gt;</highlight></codeline>
<codeline lineno="429"><highlight class="normal"><sp/><sp/><sp/><sp/>std::optional&lt;CPubKey&gt;<sp/><ref refid="struct_satisfier_1aaef0e1823d1d3bd63234cd5a94c1b6ed" kindref="member">CPubFromPKHBytes</ref>(I<sp/>first,<sp/>I<sp/>last)</highlight><highlight class="keyword"><sp/>const<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(last<sp/>-<sp/>first<sp/>==<sp/>20);</highlight></codeline>
<codeline lineno="431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref><sp/>pubkey;</highlight></codeline>
<codeline lineno="432"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_key_i_d" kindref="compound">CKeyID</ref><sp/>key_id;</highlight></codeline>
<codeline lineno="433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::copy(first,<sp/>last,<sp/>key_id.<ref refid="classbase__blob_1a899a629fc7846994a3bbd28ba2777243" kindref="member">begin</ref>());</highlight></codeline>
<codeline lineno="434"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(GetPubKey(<ref refid="struct_satisfier_1a2e98a1e2cc3613678bcc06d089df9a10" kindref="member">m_provider</ref>,<sp/><ref refid="struct_satisfier_1ab49df918fdf53583d06794469dd41f8c" kindref="member">m_sig_data</ref>,<sp/>key_id,<sp/>pubkey))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>pubkey;</highlight></codeline>
<codeline lineno="435"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_satisfier_1ab49df918fdf53583d06794469dd41f8c" kindref="member">m_sig_data</ref>.missing_pubkeys.push_back(key_id);</highlight></codeline>
<codeline lineno="436"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{};</highlight></codeline>
<codeline lineno="437"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="438"><highlight class="normal"></highlight></codeline>
<codeline lineno="440"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;unsigned<sp/>char&gt;<sp/><ref refid="struct_satisfier_1a0792ebbb073cd589279502a432ec98f3" kindref="member">ToPKBytes</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_satisfier_1a6fd11019e6416be302ef4918dd7be409" kindref="member">Key</ref>&amp;<sp/>key)</highlight><highlight class="keyword"><sp/>const<sp/></highlight><highlight class="normal">{<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{key.begin(),<sp/>key.end()};<sp/>}</highlight></codeline>
<codeline lineno="441"><highlight class="normal"></highlight></codeline>
<codeline lineno="443"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="struct_satisfier_1ab4eb2ae69b37e6922c37d890480812a0" kindref="member">CheckAfter</ref>(uint32_t<sp/>value)</highlight><highlight class="keyword"><sp/>const<sp/></highlight><highlight class="normal">{<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_satisfier_1a8fbc1d542a6eb9085f406441a7256039" kindref="member">m_creator</ref>.Checker().CheckLockTime(<ref refid="class_c_script_num" kindref="compound">CScriptNum</ref>(value));<sp/>}</highlight></codeline>
<codeline lineno="444"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="struct_satisfier_1ad6ff15327553132a13305aa067988bd4" kindref="member">CheckOlder</ref>(uint32_t<sp/>value)</highlight><highlight class="keyword"><sp/>const<sp/></highlight><highlight class="normal">{<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_satisfier_1a8fbc1d542a6eb9085f406441a7256039" kindref="member">m_creator</ref>.Checker().CheckSequence(<ref refid="class_c_script_num" kindref="compound">CScriptNum</ref>(value));<sp/>}</highlight></codeline>
<codeline lineno="445"><highlight class="normal"></highlight></codeline>
<codeline lineno="447"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespaceminiscript_1adfd5523d4b709d5e28349355e79255db" kindref="member">miniscript::Availability</ref><sp/><ref refid="struct_satisfier_1ab8b9afba21be4503aefd877dc6851c67" kindref="member">SatSHA256</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>hash,<sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>preimage)</highlight><highlight class="keyword"><sp/>const<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="448"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="sign_8cpp_1af1a1b251ba23c7ea4c2b29a6ef96cff6" kindref="member">MsLookupHelper</ref>(<ref refid="struct_satisfier_1ab49df918fdf53583d06794469dd41f8c" kindref="member">m_sig_data</ref>.sha256_preimages,<sp/>hash,<sp/>preimage);</highlight></codeline>
<codeline lineno="449"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="450"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespaceminiscript_1adfd5523d4b709d5e28349355e79255db" kindref="member">miniscript::Availability</ref><sp/><ref refid="struct_satisfier_1a3fd4b81b13dd59a032c60428ee16427d" kindref="member">SatRIPEMD160</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>hash,<sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>preimage)</highlight><highlight class="keyword"><sp/>const<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="sign_8cpp_1af1a1b251ba23c7ea4c2b29a6ef96cff6" kindref="member">MsLookupHelper</ref>(<ref refid="struct_satisfier_1ab49df918fdf53583d06794469dd41f8c" kindref="member">m_sig_data</ref>.ripemd160_preimages,<sp/>hash,<sp/>preimage);</highlight></codeline>
<codeline lineno="452"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="453"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespaceminiscript_1adfd5523d4b709d5e28349355e79255db" kindref="member">miniscript::Availability</ref><sp/><ref refid="struct_satisfier_1ac21d5d7a72cc12ac83990bab30ef675c" kindref="member">SatHASH256</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>hash,<sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>preimage)</highlight><highlight class="keyword"><sp/>const<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="sign_8cpp_1af1a1b251ba23c7ea4c2b29a6ef96cff6" kindref="member">MsLookupHelper</ref>(<ref refid="struct_satisfier_1ab49df918fdf53583d06794469dd41f8c" kindref="member">m_sig_data</ref>.hash256_preimages,<sp/>hash,<sp/>preimage);</highlight></codeline>
<codeline lineno="455"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="456"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespaceminiscript_1adfd5523d4b709d5e28349355e79255db" kindref="member">miniscript::Availability</ref><sp/><ref refid="struct_satisfier_1a9439c2169aa4580084a8e3ede2044e38" kindref="member">SatHASH160</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>hash,<sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>preimage)</highlight><highlight class="keyword"><sp/>const<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="457"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="sign_8cpp_1af1a1b251ba23c7ea4c2b29a6ef96cff6" kindref="member">MsLookupHelper</ref>(<ref refid="struct_satisfier_1ab49df918fdf53583d06794469dd41f8c" kindref="member">m_sig_data</ref>.hash160_preimages,<sp/>hash,<sp/>preimage);</highlight></codeline>
<codeline lineno="458"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="459"><highlight class="normal"></highlight></codeline>
<codeline lineno="460"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespaceminiscript_1a2bd485f92f346bb2c8cb4189d22e1530" kindref="member">miniscript::MiniscriptContext</ref><sp/><ref refid="struct_satisfier_1a1d913c0e30b83b2707a2d882233916b9" kindref="member">MsContext</ref>()</highlight><highlight class="keyword"><sp/>const<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="461"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_satisfier_1ae6634fbeec551fbec71c7e9db119581d" kindref="member">m_script_ctx</ref>;</highlight></codeline>
<codeline lineno="462"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="463"><highlight class="normal">};</highlight></codeline>
<codeline lineno="464"><highlight class="normal"></highlight></codeline>
<codeline lineno="466" refid="struct_wsh_satisfier" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="struct_wsh_satisfier_1a7632692ba52486a2c5507efd10dcf02d" kindref="member">WshSatisfier</ref>:<sp/><ref refid="struct_satisfier_1aade33e8a5daf0b26c7503871f9f43b7d" kindref="member">Satisfier</ref>&lt;CPubKey&gt;<sp/>{</highlight></codeline>
<codeline lineno="467"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">explicit</highlight><highlight class="normal"><sp/><ref refid="struct_wsh_satisfier_1a7632692ba52486a2c5507efd10dcf02d" kindref="member">WshSatisfier</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_signing_provider" kindref="compound">SigningProvider</ref>&amp;<sp/>provider<sp/><ref refid="attributes_8h_1a37bc3dacb49779a0d18439d4383e5fd9" kindref="member">LIFETIMEBOUND</ref>,<sp/><ref refid="struct_signature_data" kindref="compound">SignatureData</ref>&amp;<sp/>sig_data<sp/><ref refid="attributes_8h_1a37bc3dacb49779a0d18439d4383e5fd9" kindref="member">LIFETIMEBOUND</ref>,</highlight></codeline>
<codeline lineno="468"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref>&amp;<sp/>creator<sp/><ref refid="attributes_8h_1a37bc3dacb49779a0d18439d4383e5fd9" kindref="member">LIFETIMEBOUND</ref>,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_script" kindref="compound">CScript</ref>&amp;<sp/>witscript<sp/><ref refid="attributes_8h_1a37bc3dacb49779a0d18439d4383e5fd9" kindref="member">LIFETIMEBOUND</ref>)</highlight></codeline>
<codeline lineno="469"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>:<sp/><ref refid="struct_satisfier_1aade33e8a5daf0b26c7503871f9f43b7d" kindref="member">Satisfier</ref>(provider,<sp/>sig_data,<sp/>creator,<sp/>witscript,<sp/><ref refid="namespaceminiscript_1a2bd485f92f346bb2c8cb4189d22e1530a4b704d9e9a465228c6eaa83e9a286da6" kindref="member">miniscript::MiniscriptContext::P2WSH</ref>)<sp/>{}</highlight></codeline>
<codeline lineno="470"><highlight class="normal"></highlight></codeline>
<codeline lineno="472"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">template</highlight><highlight class="normal"><sp/>&lt;</highlight><highlight class="keyword">typename</highlight><highlight class="normal"><sp/>I&gt;</highlight></codeline>
<codeline lineno="473"><highlight class="normal"><sp/><sp/><sp/><sp/>std::optional&lt;CPubKey&gt;<sp/><ref refid="struct_wsh_satisfier_1aca95ae7d129f38fe20ba973a64f7b566" kindref="member">FromPKBytes</ref>(I<sp/>first,<sp/>I<sp/>last)</highlight><highlight class="keyword"><sp/>const<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="474"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref><sp/>pubkey{first,<sp/>last};</highlight></codeline>
<codeline lineno="475"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pubkey.<ref refid="class_c_pub_key_1ac532c4b500b1a85ea22217f2c65a70ed" kindref="member">IsValid</ref>())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>pubkey;</highlight></codeline>
<codeline lineno="476"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{};</highlight></codeline>
<codeline lineno="477"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="478"><highlight class="normal"></highlight></codeline>
<codeline lineno="480"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">typename</highlight><highlight class="normal"><sp/>I&gt;</highlight></codeline>
<codeline lineno="481"><highlight class="normal"><sp/><sp/><sp/><sp/>std::optional&lt;CPubKey&gt;<sp/><ref refid="struct_wsh_satisfier_1adcc7bec889698c27a0f8725eddd2f7cd" kindref="member">FromPKHBytes</ref>(I<sp/>first,<sp/>I<sp/>last)</highlight><highlight class="keyword"><sp/>const<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="482"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_satisfier_1aaef0e1823d1d3bd63234cd5a94c1b6ed" kindref="member">Satisfier::CPubFromPKHBytes</ref>(first,<sp/>last);</highlight></codeline>
<codeline lineno="483"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="484"><highlight class="normal"></highlight></codeline>
<codeline lineno="486"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespaceminiscript_1adfd5523d4b709d5e28349355e79255db" kindref="member">miniscript::Availability</ref><sp/><ref refid="struct_wsh_satisfier_1aa8f993c848774da21e4919891a9092e6" kindref="member">Sign</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref>&amp;<sp/>key,<sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>sig)</highlight><highlight class="keyword"><sp/>const<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="487"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(CreateSig(<ref refid="struct_satisfier_1a8fbc1d542a6eb9085f406441a7256039" kindref="member">m_creator</ref>,<sp/><ref refid="struct_satisfier_1ab49df918fdf53583d06794469dd41f8c" kindref="member">m_sig_data</ref>,<sp/><ref refid="struct_satisfier_1a2e98a1e2cc3613678bcc06d089df9a10" kindref="member">m_provider</ref>,<sp/>sig,<sp/>key,<sp/><ref refid="struct_satisfier_1aa1b9e74aa56f436d2deaa266efbc50f6" kindref="member">m_witness_script</ref>,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fafd7f573f76ca2911662d17ada249f8b0" kindref="member">SigVersion::WITNESS_V0</ref>))<sp/>{</highlight></codeline>
<codeline lineno="488"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="namespaceminiscript_1adfd5523d4b709d5e28349355e79255dba7469a286259799e5b37e5db9296f00b3" kindref="member">miniscript::Availability::YES</ref>;</highlight></codeline>
<codeline lineno="489"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="namespaceminiscript_1adfd5523d4b709d5e28349355e79255dbac2f3f489a00553e7a01d369c103c7251" kindref="member">miniscript::Availability::NO</ref>;</highlight></codeline>
<codeline lineno="491"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="492"><highlight class="normal">};</highlight></codeline>
<codeline lineno="493"><highlight class="normal"></highlight></codeline>
<codeline lineno="495" refid="struct_tap_satisfier" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="struct_tap_satisfier_1ae34ceb911567172d1dd17ddd4c40b91c" kindref="member">TapSatisfier</ref>:<sp/><ref refid="struct_satisfier_1aade33e8a5daf0b26c7503871f9f43b7d" kindref="member">Satisfier</ref>&lt;XOnlyPubKey&gt;<sp/>{</highlight></codeline>
<codeline lineno="496"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classuint256" kindref="compound">uint256</ref>&amp;<sp/><ref refid="struct_tap_satisfier_1a0cf1d00cbe5f554d54760bf2a356f336" kindref="member">m_leaf_hash</ref>;</highlight></codeline>
<codeline lineno="497"><highlight class="normal"></highlight></codeline>
<codeline lineno="498"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">explicit</highlight><highlight class="normal"><sp/><ref refid="struct_tap_satisfier_1ae34ceb911567172d1dd17ddd4c40b91c" kindref="member">TapSatisfier</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_signing_provider" kindref="compound">SigningProvider</ref>&amp;<sp/>provider<sp/><ref refid="attributes_8h_1a37bc3dacb49779a0d18439d4383e5fd9" kindref="member">LIFETIMEBOUND</ref>,<sp/><ref refid="struct_signature_data" kindref="compound">SignatureData</ref>&amp;<sp/>sig_data<sp/><ref refid="attributes_8h_1a37bc3dacb49779a0d18439d4383e5fd9" kindref="member">LIFETIMEBOUND</ref>,</highlight></codeline>
<codeline lineno="499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref>&amp;<sp/>creator<sp/><ref refid="attributes_8h_1a37bc3dacb49779a0d18439d4383e5fd9" kindref="member">LIFETIMEBOUND</ref>,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_script" kindref="compound">CScript</ref>&amp;<sp/><ref refid="namespacescript" kindref="compound">script</ref><sp/><ref refid="attributes_8h_1a37bc3dacb49779a0d18439d4383e5fd9" kindref="member">LIFETIMEBOUND</ref>,</highlight></codeline>
<codeline lineno="500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classuint256" kindref="compound">uint256</ref>&amp;<sp/>leaf_hash<sp/><ref refid="attributes_8h_1a37bc3dacb49779a0d18439d4383e5fd9" kindref="member">LIFETIMEBOUND</ref>)</highlight></codeline>
<codeline lineno="501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>:<sp/><ref refid="struct_satisfier_1aade33e8a5daf0b26c7503871f9f43b7d" kindref="member">Satisfier</ref>(provider,<sp/>sig_data,<sp/>creator,<sp/><ref refid="namespacescript" kindref="compound">script</ref>,<sp/><ref refid="namespaceminiscript_1a2bd485f92f346bb2c8cb4189d22e1530af91c6e2b2fe0cbda47ac0801786555e9" kindref="member">miniscript::MiniscriptContext::TAPSCRIPT</ref>),</highlight></codeline>
<codeline lineno="502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_tap_satisfier_1a0cf1d00cbe5f554d54760bf2a356f336" kindref="member">m_leaf_hash</ref>(leaf_hash)<sp/>{}</highlight></codeline>
<codeline lineno="503"><highlight class="normal"></highlight></codeline>
<codeline lineno="505"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">template</highlight><highlight class="normal"><sp/>&lt;</highlight><highlight class="keyword">typename</highlight><highlight class="normal"><sp/>I&gt;</highlight></codeline>
<codeline lineno="506"><highlight class="normal"><sp/><sp/><sp/><sp/>std::optional&lt;XOnlyPubKey&gt;<sp/><ref refid="struct_tap_satisfier_1a9751ce9b027aaf79f9a5c41ddb4b7e47" kindref="member">FromPKBytes</ref>(I<sp/>first,<sp/>I<sp/>last)</highlight><highlight class="keyword"><sp/>const<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(last<sp/>-<sp/>first<sp/>!=<sp/>32)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{};</highlight></codeline>
<codeline lineno="508"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_x_only_pub_key" kindref="compound">XOnlyPubKey</ref><sp/>pubkey;</highlight></codeline>
<codeline lineno="509"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::copy(first,<sp/>last,<sp/>pubkey.<ref refid="class_x_only_pub_key_1a1b0b9d70f5f2ebe577cb78aa60d88ba5" kindref="member">begin</ref>());</highlight></codeline>
<codeline lineno="510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>pubkey;</highlight></codeline>
<codeline lineno="511"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="512"><highlight class="normal"></highlight></codeline>
<codeline lineno="514"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">typename</highlight><highlight class="normal"><sp/>I&gt;</highlight></codeline>
<codeline lineno="515"><highlight class="normal"><sp/><sp/><sp/><sp/>std::optional&lt;XOnlyPubKey&gt;<sp/><ref refid="struct_tap_satisfier_1a32698f95bdfd4e75dcd3311ee41e82e7" kindref="member">FromPKHBytes</ref>(I<sp/>first,<sp/>I<sp/>last)</highlight><highlight class="keyword"><sp/>const<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="516"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>pubkey<sp/>=<sp/><ref refid="struct_satisfier_1aaef0e1823d1d3bd63234cd5a94c1b6ed" kindref="member">Satisfier::CPubFromPKHBytes</ref>(first,<sp/>last))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="class_x_only_pub_key" kindref="compound">XOnlyPubKey</ref>{*pubkey};</highlight></codeline>
<codeline lineno="517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{};</highlight></codeline>
<codeline lineno="518"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="519"><highlight class="normal"></highlight></codeline>
<codeline lineno="521"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespaceminiscript_1adfd5523d4b709d5e28349355e79255db" kindref="member">miniscript::Availability</ref><sp/><ref refid="struct_tap_satisfier_1a75cc2a742a159d4ea237c4434e2ab885" kindref="member">Sign</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_x_only_pub_key" kindref="compound">XOnlyPubKey</ref>&amp;<sp/>key,<sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>sig)</highlight><highlight class="keyword"><sp/>const<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(CreateTaprootScriptSig(<ref refid="struct_satisfier_1a8fbc1d542a6eb9085f406441a7256039" kindref="member">m_creator</ref>,<sp/><ref refid="struct_satisfier_1ab49df918fdf53583d06794469dd41f8c" kindref="member">m_sig_data</ref>,<sp/><ref refid="struct_satisfier_1a2e98a1e2cc3613678bcc06d089df9a10" kindref="member">m_provider</ref>,<sp/>sig,<sp/>key,<sp/><ref refid="struct_tap_satisfier_1a0cf1d00cbe5f554d54760bf2a356f336" kindref="member">m_leaf_hash</ref>,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8faf91c6e2b2fe0cbda47ac0801786555e9" kindref="member">SigVersion::TAPSCRIPT</ref>))<sp/>{</highlight></codeline>
<codeline lineno="523"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="namespaceminiscript_1adfd5523d4b709d5e28349355e79255dba7469a286259799e5b37e5db9296f00b3" kindref="member">miniscript::Availability::YES</ref>;</highlight></codeline>
<codeline lineno="524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="namespaceminiscript_1adfd5523d4b709d5e28349355e79255dbac2f3f489a00553e7a01d369c103c7251" kindref="member">miniscript::Availability::NO</ref>;</highlight></codeline>
<codeline lineno="526"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="527"><highlight class="normal">};</highlight></codeline>
<codeline lineno="528"><highlight class="normal"></highlight></codeline>
<codeline lineno="529"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>SignTaprootScript(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_signing_provider" kindref="compound">SigningProvider</ref>&amp;<sp/>provider,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref>&amp;<sp/>creator,<sp/><ref refid="struct_signature_data" kindref="compound">SignatureData</ref>&amp;<sp/>sigdata,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>leaf_version,<sp/>std::span&lt;const<sp/>unsigned<sp/>char&gt;<sp/>script_bytes,<sp/>std::vector&lt;valtype&gt;&amp;<sp/>result)</highlight></codeline>
<codeline lineno="530"><highlight class="normal">{</highlight></codeline>
<codeline lineno="531"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>BIP342<sp/>tapscript<sp/>signing<sp/>is<sp/>supported<sp/>for<sp/>now.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="532"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(leaf_version<sp/>!=<sp/>TAPROOT_LEAF_TAPSCRIPT)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="533"><highlight class="normal"></highlight></codeline>
<codeline lineno="534"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classuint256" kindref="compound">uint256</ref><sp/>leaf_hash<sp/>=<sp/><ref refid="interpreter_8cpp_1a5de681691157c99012b3328ef4ed5a53" kindref="member">ComputeTapleafHash</ref>(leaf_version,<sp/>script_bytes);</highlight></codeline>
<codeline lineno="535"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_script" kindref="compound">CScript</ref><sp/><ref refid="namespacescript" kindref="compound">script</ref><sp/>=<sp/><ref refid="class_c_script" kindref="compound">CScript</ref>(script_bytes.begin(),<sp/>script_bytes.end());</highlight></codeline>
<codeline lineno="536"><highlight class="normal"></highlight></codeline>
<codeline lineno="537"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_tap_satisfier" kindref="compound">TapSatisfier</ref><sp/>ms_satisfier{provider,<sp/>sigdata,<sp/>creator,<sp/><ref refid="namespacescript" kindref="compound">script</ref>,<sp/>leaf_hash};</highlight></codeline>
<codeline lineno="538"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>ms<sp/>=<sp/><ref refid="namespaceminiscript_1a0f4f74f7e9edf9d40b75cd4ca43656a7" kindref="member">miniscript::FromScript</ref>(<ref refid="namespacescript" kindref="compound">script</ref>,<sp/>ms_satisfier);</highlight></codeline>
<codeline lineno="539"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ms<sp/>&amp;&amp;<sp/>ms-&gt;Satisfy(ms_satisfier,<sp/>result)<sp/>==<sp/><ref refid="namespaceminiscript_1adfd5523d4b709d5e28349355e79255dba7469a286259799e5b37e5db9296f00b3" kindref="member">miniscript::Availability::YES</ref>;</highlight></codeline>
<codeline lineno="540"><highlight class="normal">}</highlight></codeline>
<codeline lineno="541"><highlight class="normal"></highlight></codeline>
<codeline lineno="542"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>SignTaproot(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_signing_provider" kindref="compound">SigningProvider</ref>&amp;<sp/>provider,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref>&amp;<sp/>creator,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_witness_v1_taproot" kindref="compound">WitnessV1Taproot</ref>&amp;<sp/>output,<sp/><ref refid="struct_signature_data" kindref="compound">SignatureData</ref>&amp;<sp/>sigdata,<sp/>std::vector&lt;valtype&gt;&amp;<sp/>result)</highlight></codeline>
<codeline lineno="543"><highlight class="normal">{</highlight></codeline>
<codeline lineno="544"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_taproot_spend_data" kindref="compound">TaprootSpendData</ref><sp/>spenddata;</highlight></codeline>
<codeline lineno="545"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_taproot_builder" kindref="compound">TaprootBuilder</ref><sp/>builder;</highlight></codeline>
<codeline lineno="546"><highlight class="normal"></highlight></codeline>
<codeline lineno="547"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Gather<sp/>information<sp/>about<sp/>this<sp/>output.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="548"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(provider.<ref refid="class_signing_provider_1ab3b95c32df40b5babb1c56af5f070502" kindref="member">GetTaprootSpendData</ref>(output,<sp/>spenddata))<sp/>{</highlight></codeline>
<codeline lineno="549"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1a8cb2d96f937f0f1ba805d86fed2e2632" kindref="member">tr_spenddata</ref>.<ref refid="struct_taproot_spend_data_1a3c92887e49dbb027c00798802bdc6360" kindref="member">Merge</ref>(spenddata);</highlight></codeline>
<codeline lineno="550"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="551"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(provider.<ref refid="class_signing_provider_1af98fd4696d7d98d88c34911513da8808" kindref="member">GetTaprootBuilder</ref>(output,<sp/>builder))<sp/>{</highlight></codeline>
<codeline lineno="552"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1a81083580f1399faaa06eb30ccca6efcf" kindref="member">tr_builder</ref><sp/>=<sp/>builder;</highlight></codeline>
<codeline lineno="553"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="554"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>agg_keys<sp/>=<sp/>provider.<ref refid="class_signing_provider_1ac85cd36db8c307226dc85e1c08523319" kindref="member">GetAllMuSig2ParticipantPubkeys</ref>();<sp/>!agg_keys.empty())<sp/>{</highlight></codeline>
<codeline lineno="555"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1abd1bbe6e76408211e402400d4c3029f0" kindref="member">musig2_pubkeys</ref>.insert(agg_keys.begin(),<sp/>agg_keys.end());</highlight></codeline>
<codeline lineno="556"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="557"><highlight class="normal"></highlight></codeline>
<codeline lineno="558"><highlight class="normal"></highlight></codeline>
<codeline lineno="559"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Try<sp/>key<sp/>path<sp/>spending.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="560"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="561"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_key_origin_info" kindref="compound">KeyOriginInfo</ref><sp/>internal_key_info;</highlight></codeline>
<codeline lineno="562"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(provider.<ref refid="class_signing_provider_1a2b9533a2d663e22a10065e4639ce55f0" kindref="member">GetKeyOriginByXOnly</ref>(sigdata.<ref refid="struct_signature_data_1a8cb2d96f937f0f1ba805d86fed2e2632" kindref="member">tr_spenddata</ref>.<ref refid="struct_taproot_spend_data_1ab138efbd7558e42f6c8cac5cf558756f" kindref="member">internal_key</ref>,<sp/>internal_key_info))<sp/>{</highlight></codeline>
<codeline lineno="563"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it<sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1ac6afd2e226063a81e81a813883883803" kindref="member">taproot_misc_pubkeys</ref>.find(sigdata.<ref refid="struct_signature_data_1a8cb2d96f937f0f1ba805d86fed2e2632" kindref="member">tr_spenddata</ref>.<ref refid="struct_taproot_spend_data_1ab138efbd7558e42f6c8cac5cf558756f" kindref="member">internal_key</ref>);</highlight></codeline>
<codeline lineno="564"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>==<sp/>sigdata.<ref refid="struct_signature_data_1ac6afd2e226063a81e81a813883883803" kindref="member">taproot_misc_pubkeys</ref>.end())<sp/>{</highlight></codeline>
<codeline lineno="565"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1ac6afd2e226063a81e81a813883883803" kindref="member">taproot_misc_pubkeys</ref>.emplace(sigdata.<ref refid="struct_signature_data_1a8cb2d96f937f0f1ba805d86fed2e2632" kindref="member">tr_spenddata</ref>.<ref refid="struct_taproot_spend_data_1ab138efbd7558e42f6c8cac5cf558756f" kindref="member">internal_key</ref>,<sp/>std::make_pair(std::set&lt;uint256&gt;(),<sp/>internal_key_info));</highlight></codeline>
<codeline lineno="566"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="568"><highlight class="normal"></highlight></codeline>
<codeline lineno="569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_key_origin_info" kindref="compound">KeyOriginInfo</ref><sp/>output_key_info;</highlight></codeline>
<codeline lineno="570"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(provider.<ref refid="class_signing_provider_1a2b9533a2d663e22a10065e4639ce55f0" kindref="member">GetKeyOriginByXOnly</ref>(output,<sp/>output_key_info))<sp/>{</highlight></codeline>
<codeline lineno="571"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it<sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1ac6afd2e226063a81e81a813883883803" kindref="member">taproot_misc_pubkeys</ref>.find(output);</highlight></codeline>
<codeline lineno="572"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>==<sp/>sigdata.<ref refid="struct_signature_data_1ac6afd2e226063a81e81a813883883803" kindref="member">taproot_misc_pubkeys</ref>.end())<sp/>{</highlight></codeline>
<codeline lineno="573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1ac6afd2e226063a81e81a813883883803" kindref="member">taproot_misc_pubkeys</ref>.emplace(output,<sp/>std::make_pair(std::set&lt;uint256&gt;(),<sp/>output_key_info));</highlight></codeline>
<codeline lineno="574"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="575"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="576"><highlight class="normal"></highlight></codeline>
<codeline lineno="577"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>make_keypath_sig<sp/>=<sp/>[&amp;](</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_x_only_pub_key" kindref="compound">XOnlyPubKey</ref>&amp;<sp/><ref refid="namespacetests__wycheproof__generate__ecdh_1a58c180b301e382c190377b9dd48c1833" kindref="member">pk</ref>,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classuint256" kindref="compound">uint256</ref>*<sp/>merkle_root)<sp/>{</highlight></codeline>
<codeline lineno="578"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;unsigned<sp/>char&gt;<sp/>sig;</highlight></codeline>
<codeline lineno="579"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(creator.<ref refid="class_base_signature_creator_1afd93116b087bcf9fb2a936884d551d39" kindref="member">CreateSchnorrSig</ref>(provider,<sp/>sig,<sp/>pk,<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">,<sp/>merkle_root,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fa1526b180923f9569c6045129400229b9" kindref="member">SigVersion::TAPROOT</ref>))<sp/>{</highlight></codeline>
<codeline lineno="580"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1a47015f3e4f10adf42eefeea003a0ef4e" kindref="member">taproot_key_path_sig</ref><sp/>=<sp/>sig;</highlight></codeline>
<codeline lineno="581"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="582"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SignMuSig2(creator,<sp/>sigdata,<sp/>provider,<sp/>sig,<sp/>pk,<sp/>merkle_root,<sp/></highlight><highlight class="comment">/*leaf_hash=*/</highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fa1526b180923f9569c6045129400229b9" kindref="member">SigVersion::TAPROOT</ref>);</highlight></codeline>
<codeline lineno="583"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="584"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="585"><highlight class="normal"></highlight></codeline>
<codeline lineno="586"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>First<sp/>try<sp/>signing<sp/>with<sp/>internal<sp/>key</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="587"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sigdata.<ref refid="struct_signature_data_1a47015f3e4f10adf42eefeea003a0ef4e" kindref="member">taproot_key_path_sig</ref>.size()<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="588"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>make_keypath_sig(sigdata.<ref refid="struct_signature_data_1a8cb2d96f937f0f1ba805d86fed2e2632" kindref="member">tr_spenddata</ref>.<ref refid="struct_taproot_spend_data_1ab138efbd7558e42f6c8cac5cf558756f" kindref="member">internal_key</ref>,<sp/>&amp;sigdata.<ref refid="struct_signature_data_1a8cb2d96f937f0f1ba805d86fed2e2632" kindref="member">tr_spenddata</ref>.<ref refid="struct_taproot_spend_data_1a3ee5bee8e91112d23ab299476284e4a8" kindref="member">merkle_root</ref>);</highlight></codeline>
<codeline lineno="589"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="590"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Try<sp/>signing<sp/>with<sp/>output<sp/>key<sp/>if<sp/>still<sp/>no<sp/>signature</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="591"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sigdata.<ref refid="struct_signature_data_1a47015f3e4f10adf42eefeea003a0ef4e" kindref="member">taproot_key_path_sig</ref>.size()<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="592"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>make_keypath_sig(output,<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="593"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="594"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sigdata.<ref refid="struct_signature_data_1a47015f3e4f10adf42eefeea003a0ef4e" kindref="member">taproot_key_path_sig</ref>.size())<sp/>{</highlight></codeline>
<codeline lineno="595"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result<sp/>=<sp/><ref refid="vector_8h_1a99cbb5fac6b713705162f5c56079defb" kindref="member">Vector</ref>(sigdata.<ref refid="struct_signature_data_1a47015f3e4f10adf42eefeea003a0ef4e" kindref="member">taproot_key_path_sig</ref>);</highlight></codeline>
<codeline lineno="596"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="597"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="598"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="599"><highlight class="normal"></highlight></codeline>
<codeline lineno="600"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Try<sp/>script<sp/>path<sp/>spending.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="601"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;std::vector&lt;unsigned<sp/>char&gt;&gt;<sp/>smallest_result_stack;</highlight></codeline>
<codeline lineno="602"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>[key,<sp/>control_blocks]<sp/>:<sp/>sigdata.<ref refid="struct_signature_data_1a8cb2d96f937f0f1ba805d86fed2e2632" kindref="member">tr_spenddata</ref>.<ref refid="struct_taproot_spend_data_1a4ab6670aa413d8141538b347e4096dbe" kindref="member">scripts</ref>)<sp/>{</highlight></codeline>
<codeline lineno="603"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>[<ref refid="namespacescript" kindref="compound">script</ref>,<sp/>leaf_ver]<sp/>=<sp/>key;</highlight></codeline>
<codeline lineno="604"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;std::vector&lt;unsigned<sp/>char&gt;&gt;<sp/>result_stack;</highlight></codeline>
<codeline lineno="605"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(SignTaprootScript(provider,<sp/>creator,<sp/>sigdata,<sp/>leaf_ver,<sp/><ref refid="namespacescript" kindref="compound">script</ref>,<sp/>result_stack))<sp/>{</highlight></codeline>
<codeline lineno="606"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result_stack.emplace_back(std::begin(<ref refid="namespacescript" kindref="compound">script</ref>),<sp/>std::end(<ref refid="namespacescript" kindref="compound">script</ref>));<sp/></highlight><highlight class="comment">//<sp/>Push<sp/>the<sp/>script</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="607"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result_stack.push_back(*control_blocks.begin());<sp/></highlight><highlight class="comment">//<sp/>Push<sp/>the<sp/>smallest<sp/>control<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="608"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(smallest_result_stack.size()<sp/>==<sp/>0<sp/>||</highlight></codeline>
<codeline lineno="609"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="serialize_8h_1ac0154eb0a74cc852efc55684de85b1f5" kindref="member">GetSerializeSize</ref>(result_stack)<sp/>&lt;<sp/><ref refid="serialize_8h_1ac0154eb0a74cc852efc55684de85b1f5" kindref="member">GetSerializeSize</ref>(smallest_result_stack))<sp/>{</highlight></codeline>
<codeline lineno="610"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>smallest_result_stack<sp/>=<sp/>std::move(result_stack);</highlight></codeline>
<codeline lineno="611"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="612"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="613"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="614"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(smallest_result_stack.size()<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="615"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result<sp/>=<sp/>std::move(smallest_result_stack);</highlight></codeline>
<codeline lineno="616"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="617"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="618"><highlight class="normal"></highlight></codeline>
<codeline lineno="619"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="620"><highlight class="normal">}</highlight></codeline>
<codeline lineno="621"><highlight class="normal"></highlight></codeline>
<codeline lineno="628"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>SignStep(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_signing_provider" kindref="compound">SigningProvider</ref>&amp;<sp/>provider,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref>&amp;<sp/>creator,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_script" kindref="compound">CScript</ref>&amp;<sp/>scriptPubKey,</highlight></codeline>
<codeline lineno="629"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;valtype&gt;&amp;<sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>,<sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8f" kindref="member">TxoutType</ref>&amp;<sp/>whichTypeRet,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref><sp/>sigversion,<sp/><ref refid="struct_signature_data" kindref="compound">SignatureData</ref>&amp;<sp/>sigdata)</highlight></codeline>
<codeline lineno="630"><highlight class="normal">{</highlight></codeline>
<codeline lineno="631"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_script" kindref="compound">CScript</ref><sp/>scriptRet;</highlight></codeline>
<codeline lineno="632"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>.clear();</highlight></codeline>
<codeline lineno="633"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;unsigned<sp/>char&gt;<sp/>sig;</highlight></codeline>
<codeline lineno="634"><highlight class="normal"></highlight></codeline>
<codeline lineno="635"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;valtype&gt;<sp/>vSolutions;</highlight></codeline>
<codeline lineno="636"><highlight class="normal"><sp/><sp/><sp/><sp/>whichTypeRet<sp/>=<sp/><ref refid="solver_8cpp_1a0664b19198e4496f7cc0365a46a25020" kindref="member">Solver</ref>(scriptPubKey,<sp/>vSolutions);</highlight></codeline>
<codeline lineno="637"><highlight class="normal"></highlight></codeline>
<codeline lineno="638"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(whichTypeRet)<sp/>{</highlight></codeline>
<codeline lineno="639"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fab4c03417b9e4221f084c33e152c3535f" kindref="member">TxoutType::NONSTANDARD</ref>:</highlight></codeline>
<codeline lineno="640"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8faacefa22e15602129aa782e5495bc496f" kindref="member">TxoutType::NULL_DATA</ref>:</highlight></codeline>
<codeline lineno="641"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fa0a72348992c8c18c766d8b4040e48065" kindref="member">TxoutType::WITNESS_UNKNOWN</ref>:</highlight></codeline>
<codeline lineno="642"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="643"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8faef44d07ca186ab3d0e8f7b211aaa9dab" kindref="member">TxoutType::PUBKEY</ref>:</highlight></codeline>
<codeline lineno="644"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!CreateSig(creator,<sp/>sigdata,<sp/>provider,<sp/>sig,<sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref>(vSolutions[0]),<sp/>scriptPubKey,<sp/>sigversion))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="645"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>.push_back(std::move(sig));</highlight></codeline>
<codeline lineno="646"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="647"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fa6f659c5c6a9ef703f9bf764627c38a98" kindref="member">TxoutType::PUBKEYHASH</ref>:<sp/>{</highlight></codeline>
<codeline lineno="648"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_key_i_d" kindref="compound">CKeyID</ref><sp/>keyID<sp/>=<sp/><ref refid="class_c_key_i_d" kindref="compound">CKeyID</ref>(<ref refid="classuint160" kindref="compound">uint160</ref>(vSolutions[0]));</highlight></codeline>
<codeline lineno="649"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref><sp/>pubkey;</highlight></codeline>
<codeline lineno="650"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!GetPubKey(provider,<sp/>sigdata,<sp/>keyID,<sp/>pubkey))<sp/>{</highlight></codeline>
<codeline lineno="651"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Pubkey<sp/>could<sp/>not<sp/>be<sp/>found,<sp/>add<sp/>to<sp/>missing</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="652"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1acbf6c552f206cc856cc7d61e5bbd1990" kindref="member">missing_pubkeys</ref>.push_back(keyID);</highlight></codeline>
<codeline lineno="653"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="654"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="655"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!CreateSig(creator,<sp/>sigdata,<sp/>provider,<sp/>sig,<sp/>pubkey,<sp/>scriptPubKey,<sp/>sigversion))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="656"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>.push_back(std::move(sig));</highlight></codeline>
<codeline lineno="657"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>.push_back(<ref refid="script_2script_8h_1adb3d23f17cd1c3d543c096c67489a738" kindref="member">ToByteVector</ref>(pubkey));</highlight></codeline>
<codeline lineno="658"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="659"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="660"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fa27f02ca8bff408e6f6bfa149474cc28e" kindref="member">TxoutType::SCRIPTHASH</ref>:<sp/>{</highlight></codeline>
<codeline lineno="661"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classuint160" kindref="compound">uint160</ref><sp/>h160{vSolutions[0]};</highlight></codeline>
<codeline lineno="662"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(GetCScript(provider,<sp/>sigdata,<sp/><ref refid="class_c_script_i_d" kindref="compound">CScriptID</ref>{h160},<sp/>scriptRet))<sp/>{</highlight></codeline>
<codeline lineno="663"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>.emplace_back(scriptRet.<ref refid="classprevector_1ad69bd11391be1a1dba5c8202259664f8" kindref="member">begin</ref>(),<sp/>scriptRet.<ref refid="classprevector_1acad38d52497a975bfb6f2f6acd76631f" kindref="member">end</ref>());</highlight></codeline>
<codeline lineno="664"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="665"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="666"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Could<sp/>not<sp/>find<sp/>redeemScript,<sp/>add<sp/>to<sp/>missing</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="667"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1a6e660daaff505ae86168fc917926f597" kindref="member">missing_redeem_script</ref><sp/>=<sp/>h160;</highlight></codeline>
<codeline lineno="668"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="669"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="670"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fae50f553ee62b9fcbec1b8c8120c29050" kindref="member">TxoutType::MULTISIG</ref>:<sp/>{</highlight></codeline>
<codeline lineno="671"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>required<sp/>=<sp/>vSolutions.front()[0];</highlight></codeline>
<codeline lineno="672"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>.emplace_back();<sp/></highlight><highlight class="comment">//<sp/>workaround<sp/>CHECKMULTISIG<sp/>bug</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="673"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>1;<sp/>i<sp/>&lt;<sp/>vSolutions.size()<sp/>-<sp/>1;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="674"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref><sp/>pubkey<sp/>=<sp/><ref refid="class_c_pub_key" kindref="compound">CPubKey</ref>(vSolutions[i]);</highlight></codeline>
<codeline lineno="675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>need<sp/>to<sp/>always<sp/>call<sp/>CreateSig<sp/>in<sp/>order<sp/>to<sp/>fill<sp/>sigdata<sp/>with<sp/>all</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="676"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>possible<sp/>signatures<sp/>that<sp/>we<sp/>can<sp/>create.<sp/>This<sp/>will<sp/>allow<sp/>further<sp/>PSBT</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="677"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>processing<sp/>to<sp/>work<sp/>as<sp/>it<sp/>needs<sp/>all<sp/>possible<sp/>signature<sp/>and<sp/>pubkey<sp/>pairs</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="678"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(CreateSig(creator,<sp/>sigdata,<sp/>provider,<sp/>sig,<sp/>pubkey,<sp/>scriptPubKey,<sp/>sigversion))<sp/>{</highlight></codeline>
<codeline lineno="679"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>.size()<sp/>&lt;<sp/>required<sp/>+<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="680"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>.push_back(std::move(sig));</highlight></codeline>
<codeline lineno="681"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="682"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="683"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="684"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>ok<sp/>=<sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>.size()<sp/>==<sp/>required<sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="685"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>+<sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>.size()<sp/>&lt;<sp/>required<sp/>+<sp/>1;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="686"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>.emplace_back();</highlight></codeline>
<codeline lineno="687"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="688"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ok;</highlight></codeline>
<codeline lineno="689"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="690"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fae7992ec297aa2c0cb081815c6a671668" kindref="member">TxoutType::WITNESS_V0_KEYHASH</ref>:</highlight></codeline>
<codeline lineno="691"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>.push_back(vSolutions[0]);</highlight></codeline>
<codeline lineno="692"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="693"><highlight class="normal"></highlight></codeline>
<codeline lineno="694"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fa264ed4d13f767aab3553a6144d64b226" kindref="member">TxoutType::WITNESS_V0_SCRIPTHASH</ref>:</highlight></codeline>
<codeline lineno="695"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(GetCScript(provider,<sp/>sigdata,<sp/><ref refid="class_c_script_i_d" kindref="compound">CScriptID</ref>{<ref refid="hash_8h_1a5a59295ec04ef6dc48d408bbbaafbf81" kindref="member">RIPEMD160</ref>(vSolutions[0])},<sp/>scriptRet))<sp/>{</highlight></codeline>
<codeline lineno="696"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>.emplace_back(scriptRet.<ref refid="classprevector_1ad69bd11391be1a1dba5c8202259664f8" kindref="member">begin</ref>(),<sp/>scriptRet.<ref refid="classprevector_1acad38d52497a975bfb6f2f6acd76631f" kindref="member">end</ref>());</highlight></codeline>
<codeline lineno="697"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="698"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="699"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Could<sp/>not<sp/>find<sp/>witnessScript,<sp/>add<sp/>to<sp/>missing</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="700"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1af71782d053b52b80eb69a663b32b4bc6" kindref="member">missing_witness_script</ref><sp/>=<sp/><ref refid="classuint256" kindref="compound">uint256</ref>(vSolutions[0]);</highlight></codeline>
<codeline lineno="701"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="702"><highlight class="normal"></highlight></codeline>
<codeline lineno="703"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fa049dd79ed8ccf583d838427d6fc30d9f" kindref="member">TxoutType::WITNESS_V1_TAPROOT</ref>:</highlight></codeline>
<codeline lineno="704"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SignTaproot(provider,<sp/>creator,<sp/><ref refid="struct_witness_v1_taproot" kindref="compound">WitnessV1Taproot</ref>(<ref refid="class_x_only_pub_key" kindref="compound">XOnlyPubKey</ref>{vSolutions[0]}),<sp/>sigdata,<sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>);</highlight></codeline>
<codeline lineno="705"><highlight class="normal"></highlight></codeline>
<codeline lineno="706"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fa1d0d6d35c52e907b5e0af4a7f5a81a9f" kindref="member">TxoutType::ANCHOR</ref>:</highlight></codeline>
<codeline lineno="707"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="708"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>no<sp/>default<sp/>case,<sp/>so<sp/>the<sp/>compiler<sp/>can<sp/>warn<sp/>about<sp/>missing<sp/>cases</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="709"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(</highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="710"><highlight class="normal">}</highlight></codeline>
<codeline lineno="711"><highlight class="normal"></highlight></codeline>
<codeline lineno="712"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/><ref refid="class_c_script" kindref="compound">CScript</ref><sp/>PushAll(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;valtype&gt;&amp;<sp/>values)</highlight></codeline>
<codeline lineno="713"><highlight class="normal">{</highlight></codeline>
<codeline lineno="714"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_script" kindref="compound">CScript</ref><sp/>result;</highlight></codeline>
<codeline lineno="715"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="addresstype_8cpp_1a893ae190c4461e89b01441657f8975ed" kindref="member">valtype</ref>&amp;<sp/>v<sp/>:<sp/>values)<sp/>{</highlight></codeline>
<codeline lineno="716"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v.size()<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="717"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result<sp/>&lt;&lt;<sp/><ref refid="script_2script_8h_1a63e349a6089a54da9fe09a3d858648bdaccd484dad2223fffdbdc2637c4f1e40e" kindref="member">OP_0</ref>;</highlight></codeline>
<codeline lineno="718"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v.size()<sp/>==<sp/>1<sp/>&amp;&amp;<sp/>v[0]<sp/>&gt;=<sp/>1<sp/>&amp;&amp;<sp/>v[0]<sp/>&lt;=<sp/>16)<sp/>{</highlight></codeline>
<codeline lineno="719"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result<sp/>&lt;&lt;<sp/><ref refid="class_c_script_1a66992ecdfdfc784b5e72bcaeedde4f74" kindref="member">CScript::EncodeOP_N</ref>(v[0]);</highlight></codeline>
<codeline lineno="720"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(v.size()<sp/>==<sp/>1<sp/>&amp;&amp;<sp/>v[0]<sp/>==<sp/>0x81)<sp/>{</highlight></codeline>
<codeline lineno="721"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result<sp/>&lt;&lt;<sp/><ref refid="script_2script_8h_1a63e349a6089a54da9fe09a3d858648bda2c15591fd644754476410d5bcdfed2ad" kindref="member">OP_1NEGATE</ref>;</highlight></codeline>
<codeline lineno="722"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="723"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result<sp/>&lt;&lt;<sp/>v;</highlight></codeline>
<codeline lineno="724"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="725"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="726"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>result;</highlight></codeline>
<codeline lineno="727"><highlight class="normal">}</highlight></codeline>
<codeline lineno="728"><highlight class="normal"></highlight></codeline>
<codeline lineno="729"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="sign_8cpp_1a0c453416d09212d876bee81dc9353c16" kindref="member">ProduceSignature</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_signing_provider" kindref="compound">SigningProvider</ref>&amp;<sp/>provider,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref>&amp;<sp/>creator,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_script" kindref="compound">CScript</ref>&amp;<sp/>fromPubKey,<sp/><ref refid="struct_signature_data" kindref="compound">SignatureData</ref>&amp;<sp/>sigdata)</highlight></codeline>
<codeline lineno="730"><highlight class="normal">{</highlight></codeline>
<codeline lineno="731"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sigdata.<ref refid="struct_signature_data_1af6b1fef28954e41d75acf35f76bc8d39" kindref="member">complete</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="732"><highlight class="normal"></highlight></codeline>
<codeline lineno="733"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;valtype&gt;<sp/>result;</highlight></codeline>
<codeline lineno="734"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8f" kindref="member">TxoutType</ref><sp/>whichType;</highlight></codeline>
<codeline lineno="735"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>solved<sp/>=<sp/>SignStep(provider,<sp/>creator,<sp/>fromPubKey,<sp/>result,<sp/>whichType,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fae7b1a5c82772e0e055096008cb9883ef" kindref="member">SigVersion::BASE</ref>,<sp/>sigdata);</highlight></codeline>
<codeline lineno="736"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="namespacebtck_1a37ca9ef033e139218f38f297722c0bb5a4b69887a2296a09d0c227fd7ca37c7ec" kindref="member">P2SH</ref><sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="737"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_script" kindref="compound">CScript</ref><sp/>subscript;</highlight></codeline>
<codeline lineno="738"><highlight class="normal"></highlight></codeline>
<codeline lineno="739"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(solved<sp/>&amp;&amp;<sp/>whichType<sp/>==<sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fa27f02ca8bff408e6f6bfa149474cc28e" kindref="member">TxoutType::SCRIPTHASH</ref>)</highlight></codeline>
<codeline lineno="740"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="741"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Solver<sp/>returns<sp/>the<sp/>subscript<sp/>that<sp/>needs<sp/>to<sp/>be<sp/>evaluated;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="742"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>final<sp/>scriptSig<sp/>is<sp/>the<sp/>signatures<sp/>from<sp/>that</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="743"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>then<sp/>the<sp/>serialized<sp/>subscript:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="744"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>subscript<sp/>=<sp/><ref refid="class_c_script" kindref="compound">CScript</ref>(result[0].begin(),<sp/>result[0].end());</highlight></codeline>
<codeline lineno="745"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1a3d6df9a2049980afa670d25531b9df35" kindref="member">redeem_script</ref><sp/>=<sp/>subscript;</highlight></codeline>
<codeline lineno="746"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>solved<sp/>=<sp/>solved<sp/>&amp;&amp;<sp/>SignStep(provider,<sp/>creator,<sp/>subscript,<sp/>result,<sp/>whichType,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fae7b1a5c82772e0e055096008cb9883ef" kindref="member">SigVersion::BASE</ref>,<sp/>sigdata)<sp/>&amp;&amp;<sp/>whichType<sp/>!=<sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fa27f02ca8bff408e6f6bfa149474cc28e" kindref="member">TxoutType::SCRIPTHASH</ref>;</highlight></codeline>
<codeline lineno="747"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacebtck_1a37ca9ef033e139218f38f297722c0bb5a4b69887a2296a09d0c227fd7ca37c7ec" kindref="member">P2SH</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="748"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="749"><highlight class="normal"></highlight></codeline>
<codeline lineno="750"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(solved<sp/>&amp;&amp;<sp/>whichType<sp/>==<sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fae7992ec297aa2c0cb081815c6a671668" kindref="member">TxoutType::WITNESS_V0_KEYHASH</ref>)</highlight></codeline>
<codeline lineno="751"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="752"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_script" kindref="compound">CScript</ref><sp/>witnessscript;</highlight></codeline>
<codeline lineno="753"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>witnessscript<sp/>&lt;&lt;<sp/><ref refid="script_2script_8h_1a63e349a6089a54da9fe09a3d858648bda47360cbb2e673baa31591adbb153c9b3" kindref="member">OP_DUP</ref><sp/>&lt;&lt;<sp/><ref refid="script_2script_8h_1a63e349a6089a54da9fe09a3d858648bda73c89133f3d2bdf12ac1ec91e06ba3cd" kindref="member">OP_HASH160</ref><sp/>&lt;&lt;<sp/><ref refid="script_2script_8h_1adb3d23f17cd1c3d543c096c67489a738" kindref="member">ToByteVector</ref>(result[0])<sp/>&lt;&lt;<sp/><ref refid="script_2script_8h_1a63e349a6089a54da9fe09a3d858648bdae24d4b553a43d3d57bbac4d9bd4bdf24" kindref="member">OP_EQUALVERIFY</ref><sp/>&lt;&lt;<sp/><ref refid="script_2script_8h_1a63e349a6089a54da9fe09a3d858648bda2c190c5caf052f92d3d9ac31a0d96151" kindref="member">OP_CHECKSIG</ref>;</highlight></codeline>
<codeline lineno="754"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8f" kindref="member">TxoutType</ref><sp/>subType;</highlight></codeline>
<codeline lineno="755"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>solved<sp/>=<sp/>solved<sp/>&amp;&amp;<sp/>SignStep(provider,<sp/>creator,<sp/>witnessscript,<sp/>result,<sp/>subType,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fafd7f573f76ca2911662d17ada249f8b0" kindref="member">SigVersion::WITNESS_V0</ref>,<sp/>sigdata);</highlight></codeline>
<codeline lineno="756"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1a5503eca20f89c14ff58eaca675cecd11" kindref="member">scriptWitness</ref>.<ref refid="struct_c_script_witness_1aa36391680511f7fb505821af71fdb1f2" kindref="member">stack</ref><sp/>=<sp/>result;</highlight></codeline>
<codeline lineno="757"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1a46af9ee2f1e1080fe0faf1c958a1dcd8" kindref="member">witness</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="758"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result.clear();</highlight></codeline>
<codeline lineno="759"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="760"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(solved<sp/>&amp;&amp;<sp/>whichType<sp/>==<sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fa264ed4d13f767aab3553a6144d64b226" kindref="member">TxoutType::WITNESS_V0_SCRIPTHASH</ref>)</highlight></codeline>
<codeline lineno="761"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="762"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_script" kindref="compound">CScript</ref><sp/>witnessscript(result[0].begin(),<sp/>result[0].end());</highlight></codeline>
<codeline lineno="763"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1a7968944b3535b0880179f50b2d2f111e" kindref="member">witness_script</ref><sp/>=<sp/>witnessscript;</highlight></codeline>
<codeline lineno="764"><highlight class="normal"></highlight></codeline>
<codeline lineno="765"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8f" kindref="member">TxoutType</ref><sp/>subType{<ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fab4c03417b9e4221f084c33e152c3535f" kindref="member">TxoutType::NONSTANDARD</ref>};</highlight></codeline>
<codeline lineno="766"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>solved<sp/>=<sp/>solved<sp/>&amp;&amp;<sp/>SignStep(provider,<sp/>creator,<sp/>witnessscript,<sp/>result,<sp/>subType,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fafd7f573f76ca2911662d17ada249f8b0" kindref="member">SigVersion::WITNESS_V0</ref>,<sp/>sigdata)<sp/>&amp;&amp;<sp/>subType<sp/>!=<sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fa27f02ca8bff408e6f6bfa149474cc28e" kindref="member">TxoutType::SCRIPTHASH</ref><sp/>&amp;&amp;<sp/>subType<sp/>!=<sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fa264ed4d13f767aab3553a6144d64b226" kindref="member">TxoutType::WITNESS_V0_SCRIPTHASH</ref><sp/>&amp;&amp;<sp/>subType<sp/>!=<sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fae7992ec297aa2c0cb081815c6a671668" kindref="member">TxoutType::WITNESS_V0_KEYHASH</ref>;</highlight></codeline>
<codeline lineno="767"><highlight class="normal"></highlight></codeline>
<codeline lineno="768"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>couldn&apos;t<sp/>find<sp/>a<sp/>solution<sp/>with<sp/>the<sp/>legacy<sp/>satisfier,<sp/>try<sp/>satisfying<sp/>the<sp/>script<sp/>using<sp/>Miniscript.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="769"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note<sp/>we<sp/>need<sp/>to<sp/>check<sp/>if<sp/>the<sp/>result<sp/>stack<sp/>is<sp/>empty<sp/>before,<sp/>because<sp/>it<sp/>might<sp/>be<sp/>used<sp/>even<sp/>if<sp/>the<sp/>Script</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="770"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>isn&apos;t<sp/>fully<sp/>solved.<sp/>For<sp/>instance<sp/>the<sp/>CHECKMULTISIG<sp/>satisfaction<sp/>in<sp/>SignStep()<sp/>pushes<sp/>partial<sp/>signatures</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="771"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>the<sp/>extractor<sp/>relies<sp/>on<sp/>this<sp/>behaviour<sp/>to<sp/>combine<sp/>witnesses.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="772"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!solved<sp/>&amp;&amp;<sp/>result.empty())<sp/>{</highlight></codeline>
<codeline lineno="773"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_wsh_satisfier" kindref="compound">WshSatisfier</ref><sp/>ms_satisfier{provider,<sp/>sigdata,<sp/>creator,<sp/>witnessscript};</highlight></codeline>
<codeline lineno="774"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>ms<sp/>=<sp/><ref refid="namespaceminiscript_1a0f4f74f7e9edf9d40b75cd4ca43656a7" kindref="member">miniscript::FromScript</ref>(witnessscript,<sp/>ms_satisfier);</highlight></codeline>
<codeline lineno="775"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>solved<sp/>=<sp/>ms<sp/>&amp;&amp;<sp/>ms-&gt;Satisfy(ms_satisfier,<sp/>result)<sp/>==<sp/><ref refid="namespaceminiscript_1adfd5523d4b709d5e28349355e79255dba7469a286259799e5b37e5db9296f00b3" kindref="member">miniscript::Availability::YES</ref>;</highlight></codeline>
<codeline lineno="776"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="777"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result.emplace_back(witnessscript.<ref refid="classprevector_1ad69bd11391be1a1dba5c8202259664f8" kindref="member">begin</ref>(),<sp/>witnessscript.<ref refid="classprevector_1acad38d52497a975bfb6f2f6acd76631f" kindref="member">end</ref>());</highlight></codeline>
<codeline lineno="778"><highlight class="normal"></highlight></codeline>
<codeline lineno="779"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1a5503eca20f89c14ff58eaca675cecd11" kindref="member">scriptWitness</ref>.<ref refid="struct_c_script_witness_1aa36391680511f7fb505821af71fdb1f2" kindref="member">stack</ref><sp/>=<sp/>result;</highlight></codeline>
<codeline lineno="780"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1a46af9ee2f1e1080fe0faf1c958a1dcd8" kindref="member">witness</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="781"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result.clear();</highlight></codeline>
<codeline lineno="782"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(whichType<sp/>==<sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fa049dd79ed8ccf583d838427d6fc30d9f" kindref="member">TxoutType::WITNESS_V1_TAPROOT</ref><sp/>&amp;&amp;<sp/>!P2SH)<sp/>{</highlight></codeline>
<codeline lineno="783"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1a46af9ee2f1e1080fe0faf1c958a1dcd8" kindref="member">witness</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="784"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(solved)<sp/>{</highlight></codeline>
<codeline lineno="785"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1a5503eca20f89c14ff58eaca675cecd11" kindref="member">scriptWitness</ref>.<ref refid="struct_c_script_witness_1aa36391680511f7fb505821af71fdb1f2" kindref="member">stack</ref><sp/>=<sp/>std::move(result);</highlight></codeline>
<codeline lineno="786"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="787"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result.clear();</highlight></codeline>
<codeline lineno="788"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(solved<sp/>&amp;&amp;<sp/>whichType<sp/>==<sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fa0a72348992c8c18c766d8b4040e48065" kindref="member">TxoutType::WITNESS_UNKNOWN</ref>)<sp/>{</highlight></codeline>
<codeline lineno="789"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1a46af9ee2f1e1080fe0faf1c958a1dcd8" kindref="member">witness</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="790"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="791"><highlight class="normal"></highlight></codeline>
<codeline lineno="792"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sigdata.<ref refid="struct_signature_data_1a46af9ee2f1e1080fe0faf1c958a1dcd8" kindref="member">witness</ref>)<sp/>sigdata.<ref refid="struct_signature_data_1a5503eca20f89c14ff58eaca675cecd11" kindref="member">scriptWitness</ref>.<ref refid="struct_c_script_witness_1aa36391680511f7fb505821af71fdb1f2" kindref="member">stack</ref>.clear();</highlight></codeline>
<codeline lineno="793"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(P2SH)<sp/>{</highlight></codeline>
<codeline lineno="794"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result.emplace_back(subscript.<ref refid="classprevector_1ad69bd11391be1a1dba5c8202259664f8" kindref="member">begin</ref>(),<sp/>subscript.<ref refid="classprevector_1acad38d52497a975bfb6f2f6acd76631f" kindref="member">end</ref>());</highlight></codeline>
<codeline lineno="795"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="796"><highlight class="normal"><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1a12bda3b498d6ed110bfb102a19ef5a12" kindref="member">scriptSig</ref><sp/>=<sp/>PushAll(result);</highlight></codeline>
<codeline lineno="797"><highlight class="normal"></highlight></codeline>
<codeline lineno="798"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Test<sp/>solution</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="799"><highlight class="normal"><sp/><sp/><sp/><sp/>sigdata.<ref refid="struct_signature_data_1af6b1fef28954e41d75acf35f76bc8d39" kindref="member">complete</ref><sp/>=<sp/>solved<sp/>&amp;&amp;<sp/><ref refid="interpreter_8cpp_1acdeac884f2fbcea533277458e8097e87" kindref="member">VerifyScript</ref>(sigdata.<ref refid="struct_signature_data_1a12bda3b498d6ed110bfb102a19ef5a12" kindref="member">scriptSig</ref>,<sp/>fromPubKey,<sp/>&amp;sigdata.<ref refid="struct_signature_data_1a5503eca20f89c14ff58eaca675cecd11" kindref="member">scriptWitness</ref>,<sp/>STANDARD_SCRIPT_VERIFY_FLAGS,<sp/>creator.<ref refid="class_base_signature_creator_1ad40b298b5a93b6ce3a5f4cb5d5a1246f" kindref="member">Checker</ref>());</highlight></codeline>
<codeline lineno="800"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>sigdata.<ref refid="struct_signature_data_1af6b1fef28954e41d75acf35f76bc8d39" kindref="member">complete</ref>;</highlight></codeline>
<codeline lineno="801"><highlight class="normal">}</highlight></codeline>
<codeline lineno="802"><highlight class="normal"></highlight></codeline>
<codeline lineno="803"><highlight class="normal"></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="804"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal">SignatureExtractorChecker<sp/>final<sp/>:<sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/><ref refid="class_deferring_signature_checker" kindref="compound">DeferringSignatureChecker</ref></highlight></codeline>
<codeline lineno="805"><highlight class="normal">{</highlight></codeline>
<codeline lineno="806"><highlight class="normal"></highlight><highlight class="keyword">private</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="807"><highlight class="normal"><sp/><sp/><sp/><sp/>SignatureData&amp;<sp/>sigdata;</highlight></codeline>
<codeline lineno="808"><highlight class="normal"></highlight></codeline>
<codeline lineno="809"><highlight class="normal"></highlight><highlight class="keyword">public</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="810"><highlight class="normal"><sp/><sp/><sp/><sp/>SignatureExtractorChecker(SignatureData&amp;<sp/>sigdata,<sp/>BaseSignatureChecker&amp;<sp/>checker)<sp/>:<sp/>DeferringSignatureChecker(checker),<sp/>sigdata(sigdata)<sp/>{}</highlight></codeline>
<codeline lineno="811"><highlight class="normal"></highlight></codeline>
<codeline lineno="812"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CheckECDSASignature(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>scriptSig,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>vchPubKey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CScript&amp;<sp/>scriptCode,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref><sp/>sigversion)</highlight><highlight class="keyword"><sp/>const<sp/>override</highlight></codeline>
<codeline lineno="813"><highlight class="keyword"><sp/><sp/><sp/><sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="814"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_checker.CheckECDSASignature(scriptSig,<sp/>vchPubKey,<sp/>scriptCode,<sp/>sigversion))<sp/>{</highlight></codeline>
<codeline lineno="815"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CPubKey<sp/>pubkey(vchPubKey);</highlight></codeline>
<codeline lineno="816"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigdata.signatures.emplace(pubkey.<ref refid="class_c_pub_key_1a0dcc3372f6142fc89e4bab57e10a67c7" kindref="member">GetID</ref>(),<sp/><ref refid="sign_8h_1a423149d75b2fd4374004050af6d777eb" kindref="member">SigPair</ref>(pubkey,<sp/>scriptSig));</highlight></codeline>
<codeline lineno="817"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="818"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="819"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="820"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="821"><highlight class="normal">};</highlight></codeline>
<codeline lineno="822"><highlight class="normal"></highlight></codeline>
<codeline lineno="823"><highlight class="normal"></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">Stacks</highlight></codeline>
<codeline lineno="824"><highlight class="normal">{</highlight></codeline>
<codeline lineno="825"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;valtype&gt;<sp/>script;</highlight></codeline>
<codeline lineno="826"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;valtype&gt;<sp/>witness;</highlight></codeline>
<codeline lineno="827"><highlight class="normal"></highlight></codeline>
<codeline lineno="828"><highlight class="normal"><sp/><sp/><sp/><sp/>Stacks()<sp/>=<sp/></highlight><highlight class="keyword">delete</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="829"><highlight class="normal"><sp/><sp/><sp/><sp/>Stacks(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Stacks&amp;)<sp/>=<sp/></highlight><highlight class="keyword">delete</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="830"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">explicit</highlight><highlight class="normal"><sp/>Stacks(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SignatureData&amp;<sp/>data)<sp/>:<sp/>witness(<ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>.scriptWitness.stack)<sp/>{</highlight></codeline>
<codeline lineno="831"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="interpreter_8cpp_1a631b2ddc793b03b5914da1eac99bdd17" kindref="member">EvalScript</ref>(script,<sp/><ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>.scriptSig,<sp/><ref refid="interpreter_8h_1adfb2695ade741a5e62728f3586ec1637a23082594a50dd409538ddba4fd05c354" kindref="member">SCRIPT_VERIFY_STRICTENC</ref>,<sp/>BaseSignatureChecker(),<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fae7b1a5c82772e0e055096008cb9883ef" kindref="member">SigVersion::BASE</ref>);</highlight></codeline>
<codeline lineno="832"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="833"><highlight class="normal">};</highlight></codeline>
<codeline lineno="834"><highlight class="normal">}</highlight></codeline>
<codeline lineno="835"><highlight class="normal"></highlight></codeline>
<codeline lineno="836"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Extracts<sp/>signatures<sp/>and<sp/>scripts<sp/>from<sp/>incomplete<sp/>scriptSigs.<sp/>Please<sp/>do<sp/>not<sp/>extend<sp/>this,<sp/>use<sp/>PSBT<sp/>instead</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="837"><highlight class="normal"><ref refid="struct_signature_data" kindref="compound">SignatureData</ref><sp/><ref refid="sign_8cpp_1ac43070bee0b6bc72e2e2a738892dd1f3" kindref="member">DataFromTransaction</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_c_mutable_transaction" kindref="compound">CMutableTransaction</ref>&amp;<sp/>tx,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nIn,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_tx_out" kindref="compound">CTxOut</ref>&amp;<sp/>txout)</highlight></codeline>
<codeline lineno="838"><highlight class="normal">{</highlight></codeline>
<codeline lineno="839"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_signature_data" kindref="compound">SignatureData</ref><sp/><ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>;</highlight></codeline>
<codeline lineno="840"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(tx.<ref refid="struct_c_mutable_transaction_1afd91da81fb92925e0cdf710fd8addadb" kindref="member">vin</ref>.size()<sp/>&gt;<sp/>nIn);</highlight></codeline>
<codeline lineno="841"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>.scriptSig<sp/>=<sp/>tx.<ref refid="struct_c_mutable_transaction_1afd91da81fb92925e0cdf710fd8addadb" kindref="member">vin</ref>[nIn].scriptSig;</highlight></codeline>
<codeline lineno="842"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>.scriptWitness<sp/>=<sp/>tx.<ref refid="struct_c_mutable_transaction_1afd91da81fb92925e0cdf710fd8addadb" kindref="member">vin</ref>[nIn].scriptWitness;</highlight></codeline>
<codeline lineno="843"><highlight class="normal"><sp/><sp/><sp/><sp/>Stacks<sp/>stack(data);</highlight></codeline>
<codeline lineno="844"><highlight class="normal"></highlight></codeline>
<codeline lineno="845"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Get<sp/>signatures</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="846"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="interpreter_8h_1a550f6fff1a461a56192dad807a412988" kindref="member">MutableTransactionSignatureChecker</ref><sp/>tx_checker(&amp;tx,<sp/>nIn,<sp/>txout.<ref refid="class_c_tx_out_1a2565a2ff256ecf0a445d0fc53180fe07" kindref="member">nValue</ref>,<sp/><ref refid="interpreter_8h_1acc6ee21a72d2acd6c95fc4de2c9e672eac2759effffc94bb9acc71d69fe3e8a1f" kindref="member">MissingDataBehavior::FAIL</ref>);</highlight></codeline>
<codeline lineno="847"><highlight class="normal"><sp/><sp/><sp/><sp/>SignatureExtractorChecker<sp/>extractor_checker(data,<sp/>tx_checker);</highlight></codeline>
<codeline lineno="848"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="interpreter_8cpp_1acdeac884f2fbcea533277458e8097e87" kindref="member">VerifyScript</ref>(<ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>.scriptSig,<sp/>txout.<ref refid="class_c_tx_out_1ae3e8cf0b02315c479aae11f2b51f83bf" kindref="member">scriptPubKey</ref>,<sp/>&amp;<ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>.scriptWitness,<sp/>STANDARD_SCRIPT_VERIFY_FLAGS,<sp/>extractor_checker))<sp/>{</highlight></codeline>
<codeline lineno="849"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>.complete<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="850"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>;</highlight></codeline>
<codeline lineno="851"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="852"><highlight class="normal"></highlight></codeline>
<codeline lineno="853"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Get<sp/>scripts</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="854"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;std::vector&lt;unsigned<sp/>char&gt;&gt;<sp/>solutions;</highlight></codeline>
<codeline lineno="855"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8f" kindref="member">TxoutType</ref><sp/>script_type<sp/>=<sp/><ref refid="solver_8cpp_1a0664b19198e4496f7cc0365a46a25020" kindref="member">Solver</ref>(txout.<ref refid="class_c_tx_out_1ae3e8cf0b02315c479aae11f2b51f83bf" kindref="member">scriptPubKey</ref>,<sp/>solutions);</highlight></codeline>
<codeline lineno="856"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref><sp/>sigversion<sp/>=<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fae7b1a5c82772e0e055096008cb9883ef" kindref="member">SigVersion::BASE</ref>;</highlight></codeline>
<codeline lineno="857"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_script" kindref="compound">CScript</ref><sp/>next_script<sp/>=<sp/>txout.<ref refid="class_c_tx_out_1ae3e8cf0b02315c479aae11f2b51f83bf" kindref="member">scriptPubKey</ref>;</highlight></codeline>
<codeline lineno="858"><highlight class="normal"></highlight></codeline>
<codeline lineno="859"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(script_type<sp/>==<sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fa27f02ca8bff408e6f6bfa149474cc28e" kindref="member">TxoutType::SCRIPTHASH</ref><sp/>&amp;&amp;<sp/>!stack.script.empty()<sp/>&amp;&amp;<sp/>!stack.script.back().empty())<sp/>{</highlight></codeline>
<codeline lineno="860"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Get<sp/>the<sp/>redeemScript</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="861"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_script" kindref="compound">CScript</ref><sp/>redeem_script(stack.script.back().begin(),<sp/>stack.script.back().end());</highlight></codeline>
<codeline lineno="862"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>.redeem_script<sp/>=<sp/>redeem_script;</highlight></codeline>
<codeline lineno="863"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>next_script<sp/>=<sp/>std::move(redeem_script);</highlight></codeline>
<codeline lineno="864"><highlight class="normal"></highlight></codeline>
<codeline lineno="865"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Get<sp/>redeemScript<sp/>type</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="866"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>script_type<sp/>=<sp/><ref refid="solver_8cpp_1a0664b19198e4496f7cc0365a46a25020" kindref="member">Solver</ref>(next_script,<sp/>solutions);</highlight></codeline>
<codeline lineno="867"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stack.script.pop_back();</highlight></codeline>
<codeline lineno="868"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="869"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(script_type<sp/>==<sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fa264ed4d13f767aab3553a6144d64b226" kindref="member">TxoutType::WITNESS_V0_SCRIPTHASH</ref><sp/>&amp;&amp;<sp/>!stack.witness.empty()<sp/>&amp;&amp;<sp/>!stack.witness.back().empty())<sp/>{</highlight></codeline>
<codeline lineno="870"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Get<sp/>the<sp/>witnessScript</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="871"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_script" kindref="compound">CScript</ref><sp/>witness_script(stack.witness.back().begin(),<sp/>stack.witness.back().end());</highlight></codeline>
<codeline lineno="872"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>.witness_script<sp/>=<sp/>witness_script;</highlight></codeline>
<codeline lineno="873"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>next_script<sp/>=<sp/>std::move(witness_script);</highlight></codeline>
<codeline lineno="874"><highlight class="normal"></highlight></codeline>
<codeline lineno="875"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Get<sp/>witnessScript<sp/>type</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="876"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>script_type<sp/>=<sp/><ref refid="solver_8cpp_1a0664b19198e4496f7cc0365a46a25020" kindref="member">Solver</ref>(next_script,<sp/>solutions);</highlight></codeline>
<codeline lineno="877"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stack.witness.pop_back();</highlight></codeline>
<codeline lineno="878"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stack.script<sp/>=<sp/>std::move(stack.witness);</highlight></codeline>
<codeline lineno="879"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stack.witness.clear();</highlight></codeline>
<codeline lineno="880"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sigversion<sp/>=<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8fafd7f573f76ca2911662d17ada249f8b0" kindref="member">SigVersion::WITNESS_V0</ref>;</highlight></codeline>
<codeline lineno="881"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="882"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(script_type<sp/>==<sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fae50f553ee62b9fcbec1b8c8120c29050" kindref="member">TxoutType::MULTISIG</ref><sp/>&amp;&amp;<sp/>!stack.script.empty())<sp/>{</highlight></codeline>
<codeline lineno="883"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Build<sp/>a<sp/>map<sp/>of<sp/>pubkey<sp/>-&gt;<sp/>signature<sp/>by<sp/>matching<sp/>sigs<sp/>to<sp/>pubkeys:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="884"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(solutions.size()<sp/>&gt;<sp/>1);</highlight></codeline>
<codeline lineno="885"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="namespacetest__vectors__musig2__generate_1ac9420d8f411b5fe9b3a7afcedb4bdaa4" kindref="member">num_pubkeys</ref><sp/>=<sp/>solutions.size()-2;</highlight></codeline>
<codeline lineno="886"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>last_success_key<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="887"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="addresstype_8cpp_1a893ae190c4461e89b01441657f8975ed" kindref="member">valtype</ref>&amp;<sp/>sig<sp/>:<sp/>stack.script)<sp/>{</highlight></codeline>
<codeline lineno="888"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>last_success_key;<sp/>i<sp/>&lt;<sp/><ref refid="namespacetest__vectors__musig2__generate_1ac9420d8f411b5fe9b3a7afcedb4bdaa4" kindref="member">num_pubkeys</ref>;<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="889"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="addresstype_8cpp_1a893ae190c4461e89b01441657f8975ed" kindref="member">valtype</ref>&amp;<sp/>pubkey<sp/>=<sp/>solutions[i+1];</highlight></codeline>
<codeline lineno="890"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>either<sp/>have<sp/>a<sp/>signature<sp/>for<sp/>this<sp/>pubkey,<sp/>or<sp/>we<sp/>have<sp/>found<sp/>a<sp/>signature<sp/>and<sp/>it<sp/>is<sp/>valid</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="891"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>.signatures.contains(<ref refid="class_c_pub_key" kindref="compound">CPubKey</ref>(pubkey).GetID())<sp/>||<sp/>extractor_checker.CheckECDSASignature(sig,<sp/>pubkey,<sp/>next_script,<sp/>sigversion))<sp/>{</highlight></codeline>
<codeline lineno="892"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>last_success_key<sp/>=<sp/>i<sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="893"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="894"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="895"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="896"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="897"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="898"><highlight class="normal"></highlight></codeline>
<codeline lineno="899"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>;</highlight></codeline>
<codeline lineno="900"><highlight class="normal">}</highlight></codeline>
<codeline lineno="901"><highlight class="normal"></highlight></codeline>
<codeline lineno="902"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="sign_8cpp_1a2051a9625f7300cb8ad7fdc1bc06f5c5" kindref="member">UpdateInput</ref>(<ref refid="class_c_tx_in" kindref="compound">CTxIn</ref>&amp;<sp/>input,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_signature_data" kindref="compound">SignatureData</ref>&amp;<sp/>data)</highlight></codeline>
<codeline lineno="903"><highlight class="normal">{</highlight></codeline>
<codeline lineno="904"><highlight class="normal"><sp/><sp/><sp/><sp/>input.<ref refid="class_c_tx_in_1a12bda3b498d6ed110bfb102a19ef5a12" kindref="member">scriptSig</ref><sp/>=<sp/><ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>.scriptSig;</highlight></codeline>
<codeline lineno="905"><highlight class="normal"><sp/><sp/><sp/><sp/>input.<ref refid="class_c_tx_in_1a5503eca20f89c14ff58eaca675cecd11" kindref="member">scriptWitness</ref><sp/>=<sp/><ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>.scriptWitness;</highlight></codeline>
<codeline lineno="906"><highlight class="normal">}</highlight></codeline>
<codeline lineno="907"><highlight class="normal"></highlight></codeline>
<codeline lineno="908"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="struct_signature_data_1a19b35b17458ffdf3e87520763bf3fe0c" kindref="member">SignatureData::MergeSignatureData</ref>(<ref refid="struct_signature_data" kindref="compound">SignatureData</ref><sp/>sigdata)</highlight></codeline>
<codeline lineno="909"><highlight class="normal">{</highlight></codeline>
<codeline lineno="910"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="struct_signature_data_1af6b1fef28954e41d75acf35f76bc8d39" kindref="member">complete</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="911"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sigdata.<ref refid="struct_signature_data_1af6b1fef28954e41d75acf35f76bc8d39" kindref="member">complete</ref>)<sp/>{</highlight></codeline>
<codeline lineno="912"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*</highlight><highlight class="keyword">this</highlight><highlight class="normal"><sp/>=<sp/>std::move(sigdata);</highlight></codeline>
<codeline lineno="913"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="914"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="915"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="struct_signature_data_1a3d6df9a2049980afa670d25531b9df35" kindref="member">redeem_script</ref>.empty()<sp/>&amp;&amp;<sp/>!sigdata.<ref refid="struct_signature_data_1a3d6df9a2049980afa670d25531b9df35" kindref="member">redeem_script</ref>.<ref refid="classprevector_1a644718bb2fb240de962dc3c9a1fdf0dc" kindref="member">empty</ref>())<sp/>{</highlight></codeline>
<codeline lineno="916"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_signature_data_1a3d6df9a2049980afa670d25531b9df35" kindref="member">redeem_script</ref><sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1a3d6df9a2049980afa670d25531b9df35" kindref="member">redeem_script</ref>;</highlight></codeline>
<codeline lineno="917"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="918"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="struct_signature_data_1a7968944b3535b0880179f50b2d2f111e" kindref="member">witness_script</ref>.empty()<sp/>&amp;&amp;<sp/>!sigdata.<ref refid="struct_signature_data_1a7968944b3535b0880179f50b2d2f111e" kindref="member">witness_script</ref>.<ref refid="classprevector_1a644718bb2fb240de962dc3c9a1fdf0dc" kindref="member">empty</ref>())<sp/>{</highlight></codeline>
<codeline lineno="919"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_signature_data_1a7968944b3535b0880179f50b2d2f111e" kindref="member">witness_script</ref><sp/>=<sp/>sigdata.<ref refid="struct_signature_data_1a7968944b3535b0880179f50b2d2f111e" kindref="member">witness_script</ref>;</highlight></codeline>
<codeline lineno="920"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="921"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_signature_data_1a45f002ec3e29dc54f4154d9b506e1b46" kindref="member">signatures</ref>.insert(std::make_move_iterator(sigdata.<ref refid="struct_signature_data_1a45f002ec3e29dc54f4154d9b506e1b46" kindref="member">signatures</ref>.begin()),<sp/>std::make_move_iterator(sigdata.<ref refid="struct_signature_data_1a45f002ec3e29dc54f4154d9b506e1b46" kindref="member">signatures</ref>.end()));</highlight></codeline>
<codeline lineno="922"><highlight class="normal">}</highlight></codeline>
<codeline lineno="923"><highlight class="normal"></highlight></codeline>
<codeline lineno="924"><highlight class="normal"></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="926"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal">DummySignatureChecker<sp/>final<sp/>:<sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/><ref refid="class_base_signature_checker" kindref="compound">BaseSignatureChecker</ref></highlight></codeline>
<codeline lineno="927"><highlight class="normal">{</highlight></codeline>
<codeline lineno="928"><highlight class="normal"></highlight><highlight class="keyword">public</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="929"><highlight class="normal"><sp/><sp/><sp/><sp/>DummySignatureChecker()<sp/>=<sp/></highlight><highlight class="keywordflow">default</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="930"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CheckECDSASignature(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>sig,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>vchPubKey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CScript&amp;<sp/>scriptCode,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref><sp/>sigversion)</highlight><highlight class="keyword"><sp/>const<sp/>override<sp/></highlight><highlight class="normal">{<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>sig.size()<sp/>!=<sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="931"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CheckSchnorrSignature(std::span&lt;const<sp/>unsigned<sp/>char&gt;<sp/>sig,<sp/>std::span&lt;const<sp/>unsigned<sp/>char&gt;<sp/>pubkey,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref><sp/>sigversion,<sp/>ScriptExecutionData&amp;<sp/>execdata,<sp/><ref refid="script__error_8h_1a1453a82c0adda9b334edde231c762f31" kindref="member">ScriptError</ref>*<sp/>serror)</highlight><highlight class="keyword"><sp/>const<sp/>override<sp/></highlight><highlight class="normal">{<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>sig.size()<sp/>!=<sp/>0;<sp/>}</highlight></codeline>
<codeline lineno="932"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CheckLockTime(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CScriptNum&amp;<sp/>nLockTime)</highlight><highlight class="keyword"><sp/>const<sp/>override<sp/></highlight><highlight class="normal">{<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;<sp/>}</highlight></codeline>
<codeline lineno="933"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CheckSequence(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CScriptNum&amp;<sp/>nSequence)</highlight><highlight class="keyword"><sp/>const<sp/>override<sp/></highlight><highlight class="normal">{<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;<sp/>}</highlight></codeline>
<codeline lineno="934"><highlight class="normal">};</highlight></codeline>
<codeline lineno="935"><highlight class="normal">}</highlight></codeline>
<codeline lineno="936"><highlight class="normal"></highlight></codeline>
<codeline lineno="937"><highlight class="normal"></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_base_signature_checker" kindref="compound">BaseSignatureChecker</ref>&amp;<sp/><ref refid="sign_8cpp_1ac7c8cef845db98e77532b1f1b75d3284" kindref="member">DUMMY_CHECKER</ref><sp/>=<sp/>DummySignatureChecker();</highlight></codeline>
<codeline lineno="938"><highlight class="normal"></highlight></codeline>
<codeline lineno="939"><highlight class="normal"></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="940"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal">DummySignatureCreator<sp/>final<sp/>:<sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/><ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref><sp/>{</highlight></codeline>
<codeline lineno="941"><highlight class="normal"></highlight><highlight class="keyword">private</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="942"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>m_r_len<sp/>=<sp/>32;</highlight></codeline>
<codeline lineno="943"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>m_s_len<sp/>=<sp/>32;</highlight></codeline>
<codeline lineno="944"><highlight class="normal"></highlight><highlight class="keyword">public</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="945"><highlight class="normal"><sp/><sp/><sp/><sp/>DummySignatureCreator(</highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>r_len,<sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>s_len)<sp/>:<sp/>m_r_len(r_len),<sp/>m_s_len(s_len)<sp/>{}</highlight></codeline>
<codeline lineno="946"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BaseSignatureChecker&amp;<sp/>Checker()</highlight><highlight class="keyword"><sp/>const<sp/>override<sp/></highlight><highlight class="normal">{<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="sign_8cpp_1ac7c8cef845db98e77532b1f1b75d3284" kindref="member">DUMMY_CHECKER</ref>;<sp/>}</highlight></codeline>
<codeline lineno="947"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CreateSig(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SigningProvider&amp;<sp/>provider,<sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>vchSig,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CKeyID&amp;<sp/>keyid,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CScript&amp;<sp/>scriptCode,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref><sp/>sigversion)</highlight><highlight class="keyword"><sp/>const<sp/>override</highlight></codeline>
<codeline lineno="948"><highlight class="keyword"><sp/><sp/><sp/><sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="949"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Create<sp/>a<sp/>dummy<sp/>signature<sp/>that<sp/>is<sp/>a<sp/>valid<sp/>DER-encoding</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="950"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vchSig.assign(m_r_len<sp/>+<sp/>m_s_len<sp/>+<sp/>7,<sp/></highlight><highlight class="charliteral">&apos;\000&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="951"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vchSig[0]<sp/>=<sp/>0x30;</highlight></codeline>
<codeline lineno="952"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vchSig[1]<sp/>=<sp/>m_r_len<sp/>+<sp/>m_s_len<sp/>+<sp/>4;</highlight></codeline>
<codeline lineno="953"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vchSig[2]<sp/>=<sp/>0x02;</highlight></codeline>
<codeline lineno="954"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vchSig[3]<sp/>=<sp/>m_r_len;</highlight></codeline>
<codeline lineno="955"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vchSig[4]<sp/>=<sp/>0x01;</highlight></codeline>
<codeline lineno="956"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vchSig[4<sp/>+<sp/>m_r_len]<sp/>=<sp/>0x02;</highlight></codeline>
<codeline lineno="957"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vchSig[5<sp/>+<sp/>m_r_len]<sp/>=<sp/>m_s_len;</highlight></codeline>
<codeline lineno="958"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vchSig[6<sp/>+<sp/>m_r_len]<sp/>=<sp/>0x01;</highlight></codeline>
<codeline lineno="959"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vchSig[6<sp/>+<sp/>m_r_len<sp/>+<sp/>m_s_len]<sp/>=<sp/><ref refid="interpreter_8h_1aad9879e99a65218a36881f0bc8713fcdac68c7df6528b3001624e56b2de3826de" kindref="member">SIGHASH_ALL</ref>;</highlight></codeline>
<codeline lineno="960"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="961"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="962"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CreateSchnorrSig(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SigningProvider&amp;<sp/>provider,<sp/>std::vector&lt;unsigned<sp/>char&gt;&amp;<sp/>sig,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>XOnlyPubKey&amp;<sp/>pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256*<sp/>leaf_hash,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256*<sp/>tweak,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref><sp/>sigversion)</highlight><highlight class="keyword"><sp/>const<sp/>override</highlight></codeline>
<codeline lineno="963"><highlight class="keyword"><sp/><sp/><sp/><sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="964"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sig.assign(64,<sp/></highlight><highlight class="charliteral">&apos;\000&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="965"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="966"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="967"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;uint8_t&gt;<sp/>CreateMuSig2Nonce(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SigningProvider&amp;<sp/>provider,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CPubKey&amp;<sp/>aggregate_pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CPubKey&amp;<sp/>script_pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CPubKey&amp;<sp/>part_pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256*<sp/>leaf_hash,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256*<sp/>merkle_root,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref><sp/>sigversion,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SignatureData&amp;<sp/>sigdata)</highlight><highlight class="keyword"><sp/>const<sp/>override</highlight></codeline>
<codeline lineno="968"><highlight class="keyword"><sp/><sp/><sp/><sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="969"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;uint8_t&gt;<sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>;</highlight></codeline>
<codeline lineno="970"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>.assign(<ref refid="musig_8h_1a4e0153b3f51a3a0cd42dbf0ad0b24b1a" kindref="member">MUSIG2_PUBNONCE_SIZE</ref>,<sp/></highlight><highlight class="charliteral">&apos;\000&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="971"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>;</highlight></codeline>
<codeline lineno="972"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="973"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CreateMuSig2PartialSig(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SigningProvider&amp;<sp/>provider,<sp/>uint256&amp;<sp/>partial_sig,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CPubKey&amp;<sp/>aggregate_pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CPubKey&amp;<sp/>script_pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CPubKey&amp;<sp/>part_pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256*<sp/>leaf_hash,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;std::pair&lt;uint256,<sp/>bool&gt;&gt;&amp;<sp/>tweaks,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref><sp/>sigversion,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SignatureData&amp;<sp/>sigdata)</highlight><highlight class="keyword"><sp/>const<sp/>override</highlight></codeline>
<codeline lineno="974"><highlight class="keyword"><sp/><sp/><sp/><sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="975"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>partial_sig<sp/>=<sp/><ref refid="classuint256_1afe31bf960eff93e9fbb93ae573acaef9" kindref="member">uint256::ONE</ref>;</highlight></codeline>
<codeline lineno="976"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="977"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="978"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="musig_8cpp_1a49c9c80de5454c916e9f24a0e32ace85" kindref="member">CreateMuSig2AggregateSig</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;CPubKey&gt;&amp;<sp/>participants,<sp/>std::vector&lt;uint8_t&gt;&amp;<sp/>sig,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CPubKey&amp;<sp/>aggregate_pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CPubKey&amp;<sp/>script_pubkey,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256*<sp/>leaf_hash,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;std::pair&lt;uint256,<sp/>bool&gt;&gt;&amp;<sp/>tweaks,<sp/><ref refid="interpreter_8h_1a3db3199560fd5419a3be2fcd88a28f8f" kindref="member">SigVersion</ref><sp/>sigversion,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>SignatureData&amp;<sp/>sigdata)</highlight><highlight class="keyword"><sp/>const<sp/>override</highlight></codeline>
<codeline lineno="979"><highlight class="keyword"><sp/><sp/><sp/><sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="980"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sig.assign(64,<sp/></highlight><highlight class="charliteral">&apos;\000&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="981"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="982"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="983"><highlight class="normal">};</highlight></codeline>
<codeline lineno="984"><highlight class="normal"></highlight></codeline>
<codeline lineno="985"><highlight class="normal">}</highlight></codeline>
<codeline lineno="986"><highlight class="normal"></highlight></codeline>
<codeline lineno="987"><highlight class="normal"></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref>&amp;<sp/><ref refid="sign_8cpp_1adeb428a7d137dcfc2a1f29dd1a562ca8" kindref="member">DUMMY_SIGNATURE_CREATOR</ref><sp/>=<sp/>DummySignatureCreator(32,<sp/>32);</highlight></codeline>
<codeline lineno="988"><highlight class="normal"></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_base_signature_creator" kindref="compound">BaseSignatureCreator</ref>&amp;<sp/><ref refid="sign_8cpp_1aa46e7059be2d9fa3dc2f4675704e8218" kindref="member">DUMMY_MAXIMUM_SIGNATURE_CREATOR</ref><sp/>=<sp/>DummySignatureCreator(33,<sp/>32);</highlight></codeline>
<codeline lineno="989"><highlight class="normal"></highlight></codeline>
<codeline lineno="990"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="sign_8cpp_1a234967049e0c0b1a8fcb9e3983f1ae64" kindref="member">IsSegWitOutput</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_signing_provider" kindref="compound">SigningProvider</ref>&amp;<sp/>provider,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_script" kindref="compound">CScript</ref>&amp;<sp/><ref refid="namespacescript" kindref="compound">script</ref>)</highlight></codeline>
<codeline lineno="991"><highlight class="normal">{</highlight></codeline>
<codeline lineno="992"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>version;</highlight></codeline>
<codeline lineno="993"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="addresstype_8cpp_1a893ae190c4461e89b01441657f8975ed" kindref="member">valtype</ref><sp/>program;</highlight></codeline>
<codeline lineno="994"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="namespacescript" kindref="compound">script</ref>.IsWitnessProgram(version,<sp/>program))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="995"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="namespacescript" kindref="compound">script</ref>.IsPayToScriptHash())<sp/>{</highlight></codeline>
<codeline lineno="996"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;valtype&gt;<sp/>solutions;</highlight></codeline>
<codeline lineno="997"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>whichtype<sp/>=<sp/><ref refid="solver_8cpp_1a0664b19198e4496f7cc0365a46a25020" kindref="member">Solver</ref>(<ref refid="namespacescript" kindref="compound">script</ref>,<sp/>solutions);</highlight></codeline>
<codeline lineno="998"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(whichtype<sp/>==<sp/><ref refid="solver_8h_1ac908d0e5a62eac70931dae97c6fd3c8fa27f02ca8bff408e6f6bfa149474cc28e" kindref="member">TxoutType::SCRIPTHASH</ref>)<sp/>{</highlight></codeline>
<codeline lineno="999"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>h160<sp/>=<sp/><ref refid="classuint160" kindref="compound">uint160</ref>(solutions[0]);</highlight></codeline>
<codeline lineno="1000"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_script" kindref="compound">CScript</ref><sp/>subscript;</highlight></codeline>
<codeline lineno="1001"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(provider.<ref refid="class_signing_provider_1a375a2e74144c11516a5782d9ebc7c776" kindref="member">GetCScript</ref>(<ref refid="class_c_script_i_d" kindref="compound">CScriptID</ref>{h160},<sp/>subscript))<sp/>{</highlight></codeline>
<codeline lineno="1002"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(subscript.<ref refid="class_c_script_1acc9f83d121b82096dcb2e84aa8fe36ff" kindref="member">IsWitnessProgram</ref>(version,<sp/>program))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1003"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1004"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1005"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1006"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1007"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1008"><highlight class="normal"></highlight></codeline>
<codeline lineno="1009"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="sign_8cpp_1ac7f35d5b9f97114ac2e04834aad42f35" kindref="member">SignTransaction</ref>(<ref refid="struct_c_mutable_transaction" kindref="compound">CMutableTransaction</ref>&amp;<sp/>mtx,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_signing_provider" kindref="compound">SigningProvider</ref>*<sp/>keystore,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::map&lt;COutPoint,<sp/>Coin&gt;&amp;<sp/>coins,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nHashType,<sp/>std::map&lt;int,<sp/>bilingual_str&gt;&amp;<sp/>input_errors)</highlight></codeline>
<codeline lineno="1010"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1011"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fHashSingle<sp/>=<sp/>((nHashType<sp/>&amp;<sp/><ref refid="interpreter_8h_1aad9879e99a65218a36881f0bc8713fcda9412c721b741fe9be1e3247dc390a4d2" kindref="member">~SIGHASH_ANYONECANPAY</ref>)<sp/>==<sp/><ref refid="interpreter_8h_1aad9879e99a65218a36881f0bc8713fcdad9bb96e76cf9f1b6ebbf50373f4f9ca5" kindref="member">SIGHASH_SINGLE</ref>);</highlight></codeline>
<codeline lineno="1012"><highlight class="normal"></highlight></codeline>
<codeline lineno="1013"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Use<sp/>CTransaction<sp/>for<sp/>the<sp/>constant<sp/>parts<sp/>of<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1014"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transaction<sp/>to<sp/>avoid<sp/>rehashing.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1015"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_transaction" kindref="compound">CTransaction</ref><sp/>txConst(mtx);</highlight></codeline>
<codeline lineno="1016"><highlight class="normal"></highlight></codeline>
<codeline lineno="1017"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_precomputed_transaction_data" kindref="compound">PrecomputedTransactionData</ref><sp/>txdata;</highlight></codeline>
<codeline lineno="1018"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;CTxOut&gt;<sp/>spent_outputs;</highlight></codeline>
<codeline lineno="1019"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>mtx.<ref refid="struct_c_mutable_transaction_1afd91da81fb92925e0cdf710fd8addadb" kindref="member">vin</ref>.size();<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="1020"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_tx_in" kindref="compound">CTxIn</ref>&amp;<sp/>txin<sp/>=<sp/>mtx.<ref refid="struct_c_mutable_transaction_1afd91da81fb92925e0cdf710fd8addadb" kindref="member">vin</ref>[i];</highlight></codeline>
<codeline lineno="1021"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>coin<sp/>=<sp/>coins.find(txin.<ref refid="class_c_tx_in_1a1c567359e133d98c72b5e9a928ffd41a" kindref="member">prevout</ref>);</highlight></codeline>
<codeline lineno="1022"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(coin<sp/>==<sp/>coins.end()<sp/>||<sp/>coin-&gt;second.IsSpent())<sp/>{</highlight></codeline>
<codeline lineno="1023"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>txdata.<ref refid="struct_precomputed_transaction_data_1a9d8d06b4401f04ceb58d7e5a21425a6f" kindref="member">Init</ref>(txConst,<sp/></highlight><highlight class="comment">/*spent_outputs=*/</highlight><highlight class="normal">{},<sp/></highlight><highlight class="comment">/*force=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1024"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1025"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1026"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>spent_outputs.emplace_back(coin-&gt;second.out.nValue,<sp/>coin-&gt;second.out.scriptPubKey);</highlight></codeline>
<codeline lineno="1027"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1028"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1029"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(spent_outputs.size()<sp/>==<sp/>mtx.<ref refid="struct_c_mutable_transaction_1afd91da81fb92925e0cdf710fd8addadb" kindref="member">vin</ref>.size())<sp/>{</highlight></codeline>
<codeline lineno="1030"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>txdata.<ref refid="struct_precomputed_transaction_data_1a9d8d06b4401f04ceb58d7e5a21425a6f" kindref="member">Init</ref>(txConst,<sp/>std::move(spent_outputs),<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1031"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1032"><highlight class="normal"></highlight></codeline>
<codeline lineno="1033"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Sign<sp/>what<sp/>we<sp/>can:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1034"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>mtx.<ref refid="struct_c_mutable_transaction_1afd91da81fb92925e0cdf710fd8addadb" kindref="member">vin</ref>.size();<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="1035"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_tx_in" kindref="compound">CTxIn</ref>&amp;<sp/>txin<sp/>=<sp/>mtx.<ref refid="struct_c_mutable_transaction_1afd91da81fb92925e0cdf710fd8addadb" kindref="member">vin</ref>[i];</highlight></codeline>
<codeline lineno="1036"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>coin<sp/>=<sp/>coins.find(txin.<ref refid="class_c_tx_in_1a1c567359e133d98c72b5e9a928ffd41a" kindref="member">prevout</ref>);</highlight></codeline>
<codeline lineno="1037"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(coin<sp/>==<sp/>coins.end()<sp/>||<sp/>coin-&gt;second.IsSpent())<sp/>{</highlight></codeline>
<codeline lineno="1038"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>input_errors[i]<sp/>=<sp/><ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight><highlight class="stringliteral">&quot;Input<sp/>not<sp/>found<sp/>or<sp/>already<sp/>spent&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1039"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1040"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1041"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_script" kindref="compound">CScript</ref>&amp;<sp/>prevPubKey<sp/>=<sp/>coin-&gt;second.out.scriptPubKey;</highlight></codeline>
<codeline lineno="1042"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref>&amp;<sp/>amount<sp/>=<sp/>coin-&gt;second.out.nValue;</highlight></codeline>
<codeline lineno="1043"><highlight class="normal"></highlight></codeline>
<codeline lineno="1044"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_signature_data" kindref="compound">SignatureData</ref><sp/>sigdata<sp/>=<sp/><ref refid="sign_8cpp_1ac43070bee0b6bc72e2e2a738892dd1f3" kindref="member">DataFromTransaction</ref>(mtx,<sp/>i,<sp/>coin-&gt;second.out);</highlight></codeline>
<codeline lineno="1045"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>sign<sp/>SIGHASH_SINGLE<sp/>if<sp/>there&apos;s<sp/>a<sp/>corresponding<sp/>output:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1046"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!fHashSingle<sp/>||<sp/>(i<sp/>&lt;<sp/>mtx.<ref refid="struct_c_mutable_transaction_1a9a7a8db8703f71229398b5dec69c027d" kindref="member">vout</ref>.size()))<sp/>{</highlight></codeline>
<codeline lineno="1047"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sign_8cpp_1a0c453416d09212d876bee81dc9353c16" kindref="member">ProduceSignature</ref>(*keystore,<sp/><ref refid="class_mutable_transaction_signature_creator" kindref="compound">MutableTransactionSignatureCreator</ref>(mtx,<sp/>i,<sp/>amount,<sp/>&amp;txdata,<sp/>nHashType),<sp/>prevPubKey,<sp/>sigdata);</highlight></codeline>
<codeline lineno="1048"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1049"><highlight class="normal"></highlight></codeline>
<codeline lineno="1050"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sign_8cpp_1a2051a9625f7300cb8ad7fdc1bc06f5c5" kindref="member">UpdateInput</ref>(txin,<sp/>sigdata);</highlight></codeline>
<codeline lineno="1051"><highlight class="normal"></highlight></codeline>
<codeline lineno="1052"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>amount<sp/>must<sp/>be<sp/>specified<sp/>for<sp/>valid<sp/>segwit<sp/>signature</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1053"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(amount<sp/>==<sp/>MAX_MONEY<sp/>&amp;&amp;<sp/>!txin.<ref refid="class_c_tx_in_1a5503eca20f89c14ff58eaca675cecd11" kindref="member">scriptWitness</ref>.<ref refid="struct_c_script_witness_1ac4d637a0dec45d546495c1660c9f6047" kindref="member">IsNull</ref>())<sp/>{</highlight></codeline>
<codeline lineno="1054"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>input_errors[i]<sp/>=<sp/><ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight><highlight class="stringliteral">&quot;Missing<sp/>amount&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1055"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1056"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1057"><highlight class="normal"></highlight></codeline>
<codeline lineno="1058"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="script__error_8h_1a1453a82c0adda9b334edde231c762f31" kindref="member">ScriptError</ref><sp/>serror<sp/>=<sp/><ref refid="script__error_8h_1a3150eb7362e5d1e0732dd10c973a0eb5aad599193e51936be396937d4a6e32780" kindref="member">SCRIPT_ERR_OK</ref>;</highlight></codeline>
<codeline lineno="1059"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sigdata.<ref refid="struct_signature_data_1af6b1fef28954e41d75acf35f76bc8d39" kindref="member">complete</ref><sp/>&amp;&amp;<sp/>!<ref refid="interpreter_8cpp_1acdeac884f2fbcea533277458e8097e87" kindref="member">VerifyScript</ref>(txin.<ref refid="class_c_tx_in_1a12bda3b498d6ed110bfb102a19ef5a12" kindref="member">scriptSig</ref>,<sp/>prevPubKey,<sp/>&amp;txin.<ref refid="class_c_tx_in_1a5503eca20f89c14ff58eaca675cecd11" kindref="member">scriptWitness</ref>,<sp/>STANDARD_SCRIPT_VERIFY_FLAGS,<sp/><ref refid="interpreter_8h_1a8d681a40278017c40e6fb3eb7663aeed" kindref="member">TransactionSignatureChecker</ref>(&amp;txConst,<sp/>i,<sp/>amount,<sp/>txdata,<sp/><ref refid="interpreter_8h_1acc6ee21a72d2acd6c95fc4de2c9e672eac2759effffc94bb9acc71d69fe3e8a1f" kindref="member">MissingDataBehavior::FAIL</ref>),<sp/>&amp;serror))<sp/>{</highlight></codeline>
<codeline lineno="1060"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(serror<sp/>==<sp/><ref refid="script__error_8h_1a3150eb7362e5d1e0732dd10c973a0eb5a86cf550aacd290782e55821bdfef63b6" kindref="member">SCRIPT_ERR_INVALID_STACK_OPERATION</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1061"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Unable<sp/>to<sp/>sign<sp/>input<sp/>and<sp/>verification<sp/>failed<sp/>(possible<sp/>attempt<sp/>to<sp/>partially<sp/>sign).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1062"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>input_errors[i]<sp/>=<sp/><ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(</highlight><highlight class="stringliteral">&quot;Unable<sp/>to<sp/>sign<sp/>input,<sp/>invalid<sp/>stack<sp/>size<sp/>(possibly<sp/>missing<sp/>key)&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1063"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(serror<sp/>==<sp/><ref refid="script__error_8h_1a3150eb7362e5d1e0732dd10c973a0eb5aa53f12847a5af7ece344e9e03e949ba8" kindref="member">SCRIPT_ERR_SIG_NULLFAIL</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1064"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verification<sp/>failed<sp/>(possibly<sp/>due<sp/>to<sp/>insufficient<sp/>signatures).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1065"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>input_errors[i]<sp/>=<sp/><ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(</highlight><highlight class="stringliteral">&quot;CHECK(MULTI)SIG<sp/>failing<sp/>with<sp/>non-zero<sp/>signature<sp/>(possibly<sp/>need<sp/>more<sp/>signatures)&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1066"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1067"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>input_errors[i]<sp/>=<sp/><ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(<ref refid="script__error_8cpp_1a6f3546ccbe6a83df56ed8791543e2ff5" kindref="member">ScriptErrorString</ref>(serror));</highlight></codeline>
<codeline lineno="1068"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1069"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1070"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>this<sp/>input<sp/>succeeds,<sp/>make<sp/>sure<sp/>there<sp/>is<sp/>no<sp/>error<sp/>set<sp/>for<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1071"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>input_errors.erase(i);</highlight></codeline>
<codeline lineno="1072"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1073"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1074"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>input_errors.empty();</highlight></codeline>
<codeline lineno="1075"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="src/script/sign.cpp"/>
  </compounddef>
</doxygen>
