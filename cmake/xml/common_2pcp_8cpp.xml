<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.15.0" xml:lang="en-US">
  <compounddef id="common_2pcp_8cpp" kind="file" language="C++">
    <compoundname>pcp.cpp</compoundname>
    <includes refid="pcp_8h" local="no">common/pcp.h</includes>
    <includes refid="netif_8h" local="no">common/netif.h</includes>
    <includes refid="crypto_2common_8h" local="no">crypto/common.h</includes>
    <includes local="no">logging.h</includes>
    <includes refid="netaddress_8h" local="no">netaddress.h</includes>
    <includes refid="netbase_8h" local="no">netbase.h</includes>
    <includes local="no">random.h</includes>
    <includes refid="span_8h" local="no">span.h</includes>
    <includes refid="check_8h" local="no">util/check.h</includes>
    <includes refid="readwritefile_8h" local="no">util/readwritefile.h</includes>
    <includes refid="sock_8h" local="no">util/sock.h</includes>
    <includes refid="strencodings_8h" local="no">util/strencodings.h</includes>
    <includes local="no">util/threadinterrupt.h</includes>
    <incdepgraph>
      <node id="52">
        <label>attributes.h</label>
        <link refid="attributes_8h"/>
      </node>
      <node id="67">
        <label>common/netif.h</label>
        <link refid="netif_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
      </node>
      <node id="1">
        <label>src/common/pcp.cpp</label>
        <link refid="common_2pcp_8cpp"/>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="32" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="69" relation="include">
        </childnode>
        <childnode refid="82" relation="include">
        </childnode>
        <childnode refid="37" relation="include">
        </childnode>
        <childnode refid="51" relation="include">
        </childnode>
        <childnode refid="83" relation="include">
        </childnode>
        <childnode refid="70" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
      </node>
      <node id="2">
        <label>common/pcp.h</label>
        <link refid="pcp_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
      </node>
      <node id="58">
        <label>compat/assumptions.h</label>
        <link refid="compat_2assumptions_8h"/>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
      </node>
      <node id="34">
        <label>compat/byteswap.h</label>
        <link refid="byteswap_8h"/>
        <childnode refid="19" relation="include">
        </childnode>
      </node>
      <node id="4">
        <label>compat/compat.h</label>
        <link refid="compat_8h"/>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
      </node>
      <node id="33">
        <label>compat/endian.h</label>
        <link refid="endian_8h"/>
        <childnode refid="34" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
      </node>
      <node id="31">
        <label>crypto/chacha20.h</label>
        <link refid="chacha20_8h"/>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="32">
        <label>crypto/common.h</label>
        <link refid="crypto_2common_8h"/>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
      </node>
      <node id="40">
        <label>crypto/hex_base.h</label>
        <link refid="hex__base_8h"/>
        <childnode refid="37" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
      </node>
      <node id="17">
        <label>crypto/siphash.h</label>
        <link refid="siphash_8h"/>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
      </node>
      <node id="3">
        <label>netaddress.h</label>
        <link refid="netaddress_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
        <childnode refid="63" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="46" relation="include">
        </childnode>
      </node>
      <node id="69">
        <label>netbase.h</label>
        <link refid="netbase_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
        <childnode refid="70" relation="include">
        </childnode>
        <childnode refid="73" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
        <childnode refid="61" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="81" relation="include">
        </childnode>
        <childnode refid="46" relation="include">
        </childnode>
      </node>
      <node id="21">
        <label>prevector.h</label>
        <link refid="prevector_8h"/>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="30">
        <label>random.h</label>
        <link refid="random_8h"/>
        <childnode refid="31" relation="include">
        </childnode>
        <childnode refid="32" relation="include">
        </childnode>
        <childnode refid="37" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="51" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="56" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="46" relation="include">
        </childnode>
      </node>
      <node id="57">
        <label>serialize.h</label>
        <link refid="serialize_8h"/>
        <childnode refid="52" relation="include">
        </childnode>
        <childnode refid="58" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="37" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="60" relation="include">
        </childnode>
        <childnode refid="61" relation="include">
        </childnode>
        <childnode refid="62" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="46" relation="include">
        </childnode>
      </node>
      <node id="37">
        <label>span.h</label>
        <link refid="span_8h"/>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="74">
        <label>sync.h</label>
        <link refid="sync_8h"/>
        <childnode refid="75" relation="include">
        </childnode>
        <childnode refid="77" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="78" relation="include">
        </childnode>
        <childnode refid="76" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
      </node>
      <node id="75">
        <label>threadsafety.h</label>
        <link refid="threadsafety_8h"/>
        <childnode refid="76" relation="include">
        </childnode>
      </node>
      <node id="63">
        <label>tinyformat.h</label>
        <link refid="tinyformat_8h"/>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="52" relation="include">
        </childnode>
        <childnode refid="64" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
      </node>
      <node id="38">
        <label>uint256.h</label>
        <link refid="uint256_8h"/>
        <childnode refid="32" relation="include">
        </childnode>
        <childnode refid="37" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
      </node>
      <node id="51">
        <label>util/check.h</label>
        <link refid="check_8h"/>
        <childnode refid="52" relation="include">
        </childnode>
        <childnode refid="53" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="54" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="84">
        <label>util/fs.h</label>
        <link refid="fs_8h"/>
        <childnode refid="63" relation="include">
        </childnode>
        <childnode refid="85" relation="include">
        </childnode>
        <childnode refid="86" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
        <childnode refid="87" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="88" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="77">
        <label>util/macros.h</label>
        <link refid="macros_8h"/>
      </node>
      <node id="83">
        <label>util/readwritefile.h</label>
        <link refid="readwritefile_8h"/>
        <childnode refid="84" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="70">
        <label>util/sock.h</label>
        <link refid="sock_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="71" relation="include">
        </childnode>
        <childnode refid="56" relation="include">
        </childnode>
        <childnode refid="61" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="72" relation="include">
        </childnode>
      </node>
      <node id="39">
        <label>util/strencodings.h</label>
        <link refid="strencodings_8h"/>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="37" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="46" relation="include">
        </childnode>
      </node>
      <node id="42">
        <label>util/string.h</label>
        <link refid="string_8h"/>
        <childnode refid="37" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="46" relation="include">
        </childnode>
      </node>
      <node id="73">
        <label>util/threadinterrupt.h</label>
        <link refid="util_2threadinterrupt_8h"/>
        <childnode refid="74" relation="include">
        </childnode>
        <childnode refid="75" relation="include">
        </childnode>
        <childnode refid="53" relation="include">
        </childnode>
        <childnode refid="56" relation="include">
        </childnode>
        <childnode refid="78" relation="include">
        </childnode>
      </node>
      <node id="22">
        <label>algorithm</label>
      </node>
      <node id="5">
        <label>arpa/inet.h</label>
      </node>
      <node id="18">
        <label>array</label>
      </node>
      <node id="53">
        <label>atomic</label>
      </node>
      <node id="35">
        <label>bit</label>
      </node>
      <node id="23">
        <label>cassert</label>
      </node>
      <node id="16">
        <label>cerrno</label>
      </node>
      <node id="47">
        <label>charconv</label>
      </node>
      <node id="56">
        <label>chrono</label>
      </node>
      <node id="36">
        <label>concepts</label>
      </node>
      <node id="78">
        <label>condition_variable</label>
      </node>
      <node id="24">
        <label>cstddef</label>
      </node>
      <node id="19">
        <label>cstdint</label>
      </node>
      <node id="85">
        <label>cstdio</label>
      </node>
      <node id="25">
        <label>cstdlib</label>
      </node>
      <node id="26">
        <label>cstring</label>
      </node>
      <node id="6">
        <label>fcntl.h</label>
      </node>
      <node id="86">
        <label>filesystem</label>
      </node>
      <node id="80">
        <label>functional</label>
      </node>
      <node id="87">
        <label>iomanip</label>
      </node>
      <node id="59">
        <label>ios</label>
      </node>
      <node id="64">
        <label>iostream</label>
      </node>
      <node id="27">
        <label>iterator</label>
      </node>
      <node id="48">
        <label>limits</label>
      </node>
      <node id="43">
        <label>locale</label>
      </node>
      <node id="68">
        <label>logging.h</label>
      </node>
      <node id="60">
        <label>map</label>
      </node>
      <node id="61">
        <label>memory</label>
      </node>
      <node id="76">
        <label>mutex</label>
      </node>
      <node id="7">
        <label>net/if.h</label>
      </node>
      <node id="8">
        <label>netdb.h</label>
      </node>
      <node id="9">
        <label>netinet/in.h</label>
      </node>
      <node id="10">
        <label>netinet/tcp.h</label>
      </node>
      <node id="49">
        <label>optional</label>
      </node>
      <node id="88">
        <label>ostream</label>
      </node>
      <node id="82">
        <label>random.h</label>
      </node>
      <node id="62">
        <label>set</label>
      </node>
      <node id="54">
        <label>source_location</label>
      </node>
      <node id="20">
        <label>span</label>
      </node>
      <node id="44">
        <label>sstream</label>
      </node>
      <node id="55">
        <label>stdexcept</label>
      </node>
      <node id="41">
        <label>string</label>
      </node>
      <node id="45">
        <label>string_view</label>
      </node>
      <node id="11">
        <label>sys/mman.h</label>
      </node>
      <node id="12">
        <label>sys/select.h</label>
      </node>
      <node id="13">
        <label>sys/socket.h</label>
      </node>
      <node id="14">
        <label>sys/types.h</label>
      </node>
      <node id="50">
        <label>system_error</label>
      </node>
      <node id="79">
        <label>thread</label>
      </node>
      <node id="28">
        <label>type_traits</label>
      </node>
      <node id="15">
        <label>unistd.h</label>
      </node>
      <node id="72">
        <label>unordered_map</label>
      </node>
      <node id="81">
        <label>unordered_set</label>
      </node>
      <node id="65">
        <label>util/threadinterrupt.h</label>
      </node>
      <node id="71">
        <label>util/time.h</label>
      </node>
      <node id="29">
        <label>utility</label>
      </node>
      <node id="66">
        <label>variant</label>
      </node>
      <node id="46">
        <label>vector</label>
      </node>
    </incdepgraph>
    <sectiondef kind="func">
      <memberdef kind="function" id="common_2pcp_8cpp_1a862c9fc77990f48d908dd6f75932cb92" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>std::variant&lt; <ref refid="struct_mapping_result" kindref="compound">MappingResult</ref>, <ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24" kindref="member">MappingError</ref> &gt;</type>
        <definition>std::variant&lt; MappingResult, MappingError &gt; NATPMPRequestPortMap</definition>
        <argsstring>(const CNetAddr &amp;gateway, uint16_t port, uint32_t lifetime, CThreadInterrupt &amp;interrupt, int num_tries, std::chrono::milliseconds timeout_per_try)</argsstring>
        <name>NATPMPRequestPortMap</name>
        <param>
          <type>const <ref refid="class_c_net_addr" kindref="compound">CNetAddr</ref> &amp;</type>
          <declname>gateway</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>port</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>lifetime</declname>
        </param>
        <param>
          <type><ref refid="class_c_thread_interrupt" kindref="compound">CThreadInterrupt</ref> &amp;</type>
          <declname>interrupt</declname>
        </param>
        <param>
          <type>int</type>
          <declname>num_tries</declname>
          <defval>3</defval>
        </param>
        <param>
          <type>std::chrono::milliseconds</type>
          <declname>timeout_per_try</declname>
          <defval>std::chrono::milliseconds(1000)</defval>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Try to open a port using RFC 6886 NAT-PMP. IPv4 only.</para>
<para><itemizedlist>
<listitem><para>gateway: Destination address for PCP requests (usually the default gateway).</para>
</listitem><listitem><para>port: Internal port, and desired external port.</para>
</listitem><listitem><para>lifetime: Requested lifetime in seconds for mapping. The server may assign as shorter or longer lifetime. A lifetime of 0 deletes the mapping.</para>
</listitem><listitem><para>num_tries: Number of tries in case of no response.</para>
</listitem></itemizedlist>
</para>
<para>Returns the external_ip:external_port of the mapping if successful, otherwise a <ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24" kindref="member">MappingError</ref>. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/common/pcp.cpp" line="277" column="14" bodyfile="src/common/pcp.cpp" bodystart="277" bodyend="390"/>
      </memberdef>
      <memberdef kind="function" id="common_2pcp_8cpp_1aca35c511d2afcb871e00ca441e3881c3" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>std::variant&lt; <ref refid="struct_mapping_result" kindref="compound">MappingResult</ref>, <ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24" kindref="member">MappingError</ref> &gt;</type>
        <definition>std::variant&lt; MappingResult, MappingError &gt; PCPRequestPortMap</definition>
        <argsstring>(const PCPMappingNonce &amp;nonce, const CNetAddr &amp;gateway, const CNetAddr &amp;bind, uint16_t port, uint32_t lifetime, CThreadInterrupt &amp;interrupt, int num_tries, std::chrono::milliseconds timeout_per_try)</argsstring>
        <name>PCPRequestPortMap</name>
        <param>
          <type>const <ref refid="pcp_8h_1a761c2cf99a646566fbfd29df4d42d498" kindref="member">PCPMappingNonce</ref> &amp;</type>
          <declname>nonce</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_net_addr" kindref="compound">CNetAddr</ref> &amp;</type>
          <declname>gateway</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_net_addr" kindref="compound">CNetAddr</ref> &amp;</type>
          <declname>bind</declname>
        </param>
        <param>
          <type>uint16_t</type>
          <declname>port</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>lifetime</declname>
        </param>
        <param>
          <type><ref refid="class_c_thread_interrupt" kindref="compound">CThreadInterrupt</ref> &amp;</type>
          <declname>interrupt</declname>
        </param>
        <param>
          <type>int</type>
          <declname>num_tries</declname>
          <defval>3</defval>
        </param>
        <param>
          <type>std::chrono::milliseconds</type>
          <declname>timeout_per_try</declname>
          <defval>std::chrono::milliseconds(1000)</defval>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Try to open a port using RFC 6887 Port Control Protocol (PCP). Handles IPv4 and IPv6.</para>
<para><itemizedlist>
<listitem><para>nonce: Mapping cookie. Keep this the same over renewals.</para>
</listitem><listitem><para>gateway: Destination address for PCP requests (usually the default gateway).</para>
</listitem><listitem><para>bind: Specific local bind address for IPv6 pinholing. Set this as INADDR_ANY for IPv4.</para>
</listitem><listitem><para>port: Internal port, and desired external port.</para>
</listitem><listitem><para>lifetime: Requested lifetime in seconds for mapping. The server may assign as shorter or longer lifetime. A lifetime of 0 deletes the mapping.</para>
</listitem><listitem><para>num_tries: Number of tries in case of no response.</para>
</listitem></itemizedlist>
</para>
<para>Returns the external_ip:external_port of the mapping if successful, otherwise a <ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24" kindref="member">MappingError</ref>. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/common/pcp.cpp" line="392" column="14" bodyfile="src/common/pcp.cpp" bodystart="392" bodyend="519"/>
      </memberdef>
    </sectiondef>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="comment">//<sp/>Copyright<sp/>(c)<sp/>2024-present<sp/>The<sp/>Bitcoin<sp/>Core<sp/>developers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Distributed<sp/>under<sp/>the<sp/>MIT<sp/>software<sp/>license,<sp/>see<sp/>the<sp/>accompanying</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3"><highlight class="normal"></highlight><highlight class="comment">//<sp/>file<sp/>COPYING<sp/>or<sp/>https://www.opensource.org/licenses/mit-license.php.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4"><highlight class="normal"></highlight></codeline>
<codeline lineno="5"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="pcp_8h" kindref="compound">common/pcp.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6"><highlight class="normal"></highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="netif_8h" kindref="compound">common/netif.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="crypto_2common_8h" kindref="compound">crypto/common.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;logging.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="netaddress_8h" kindref="compound">netaddress.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="netbase_8h" kindref="compound">netbase.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;random.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="13"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="span_8h" kindref="compound">span.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="14"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="check_8h" kindref="compound">util/check.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="15"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="readwritefile_8h" kindref="compound">util/readwritefile.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="16"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="sock_8h" kindref="compound">util/sock.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="17"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="strencodings_8h" kindref="compound">util/strencodings.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="18"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;util/threadinterrupt.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="19"><highlight class="normal"></highlight></codeline>
<codeline lineno="20"><highlight class="normal"></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="21"><highlight class="normal"></highlight></codeline>
<codeline lineno="22"><highlight class="normal"></highlight><highlight class="comment">//<sp/>RFC6886<sp/>NAT-PMP<sp/>and<sp/>RFC6887<sp/>Port<sp/>Control<sp/>Protocol<sp/>(PCP)<sp/>implementation.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="23"><highlight class="normal"></highlight><highlight class="comment">//<sp/>NAT-PMP<sp/>and<sp/>PCP<sp/>use<sp/>network<sp/>byte<sp/>order<sp/>(big-endian).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="24"><highlight class="normal"></highlight></codeline>
<codeline lineno="25"><highlight class="normal"></highlight><highlight class="comment">//<sp/>NAT-PMP<sp/>(v0)<sp/>protocol<sp/>constants.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="27"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint16_t<sp/>NATPMP_SERVER_PORT<sp/>=<sp/>5351;</highlight></codeline>
<codeline lineno="29"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint8_t<sp/>NATPMP_VERSION<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="31"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint8_t<sp/>NATPMP_REQUEST<sp/>=<sp/>0x00;</highlight></codeline>
<codeline lineno="33"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint8_t<sp/>NATPMP_RESPONSE<sp/>=<sp/>0x80;</highlight></codeline>
<codeline lineno="35"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint8_t<sp/>NATPMP_OP_GETEXTERNAL<sp/>=<sp/>0x00;</highlight></codeline>
<codeline lineno="37"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint8_t<sp/>NATPMP_OP_MAP_TCP<sp/>=<sp/>0x02;</highlight></codeline>
<codeline lineno="39"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>NATPMP_REQUEST_HDR_SIZE<sp/>=<sp/>2;</highlight></codeline>
<codeline lineno="41"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>NATPMP_RESPONSE_HDR_SIZE<sp/>=<sp/>8;</highlight></codeline>
<codeline lineno="43"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>NATPMP_GETEXTERNAL_REQUEST_SIZE<sp/>=<sp/>NATPMP_REQUEST_HDR_SIZE<sp/>+<sp/>0;</highlight></codeline>
<codeline lineno="45"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>NATPMP_GETEXTERNAL_RESPONSE_SIZE<sp/>=<sp/>NATPMP_RESPONSE_HDR_SIZE<sp/>+<sp/>4;</highlight></codeline>
<codeline lineno="47"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>NATPMP_MAP_REQUEST_SIZE<sp/>=<sp/>NATPMP_REQUEST_HDR_SIZE<sp/>+<sp/>10;</highlight></codeline>
<codeline lineno="49"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>NATPMP_MAP_RESPONSE_SIZE<sp/>=<sp/>NATPMP_RESPONSE_HDR_SIZE<sp/>+<sp/>8;</highlight></codeline>
<codeline lineno="50"><highlight class="normal"></highlight></codeline>
<codeline lineno="51"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Shared<sp/>header<sp/>offsets<sp/>(RFC6886<sp/>3.2,<sp/>3.3),<sp/>relative<sp/>to<sp/>start<sp/>of<sp/>packet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="53"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>NATPMP_HDR_VERSION_OFS<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="55"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>NATPMP_HDR_OP_OFS<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="57"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>NATPMP_RESPONSE_HDR_RESULT_OFS<sp/>=<sp/>2;</highlight></codeline>
<codeline lineno="58"><highlight class="normal"></highlight></codeline>
<codeline lineno="59"><highlight class="normal"></highlight><highlight class="comment">//<sp/>GETEXTERNAL<sp/>response<sp/>offsets<sp/>(RFC6886<sp/>3.2),<sp/>relative<sp/>to<sp/>start<sp/>of<sp/>packet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="61"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>NATPMP_GETEXTERNAL_RESPONSE_IP_OFS<sp/>=<sp/>8;</highlight></codeline>
<codeline lineno="62"><highlight class="normal"></highlight></codeline>
<codeline lineno="63"><highlight class="normal"></highlight><highlight class="comment">//<sp/>MAP<sp/>request<sp/>offsets<sp/>(RFC6886<sp/>3.3),<sp/>relative<sp/>to<sp/>start<sp/>of<sp/>packet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="65"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>NATPMP_MAP_REQUEST_INTERNAL_PORT_OFS<sp/>=<sp/>4;</highlight></codeline>
<codeline lineno="67"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>NATPMP_MAP_REQUEST_EXTERNAL_PORT_OFS<sp/>=<sp/>6;</highlight></codeline>
<codeline lineno="69"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>NATPMP_MAP_REQUEST_LIFETIME_OFS<sp/>=<sp/>8;</highlight></codeline>
<codeline lineno="70"><highlight class="normal"></highlight></codeline>
<codeline lineno="71"><highlight class="normal"></highlight><highlight class="comment">//<sp/>MAP<sp/>response<sp/>offsets<sp/>(RFC6886<sp/>3.3),<sp/>relative<sp/>to<sp/>start<sp/>of<sp/>packet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="73"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>NATPMP_MAP_RESPONSE_INTERNAL_PORT_OFS<sp/>=<sp/>8;</highlight></codeline>
<codeline lineno="75"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>NATPMP_MAP_RESPONSE_EXTERNAL_PORT_OFS<sp/>=<sp/>10;</highlight></codeline>
<codeline lineno="77"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>NATPMP_MAP_RESPONSE_LIFETIME_OFS<sp/>=<sp/>12;</highlight></codeline>
<codeline lineno="78"><highlight class="normal"></highlight></codeline>
<codeline lineno="79"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Relevant<sp/>NETPMP<sp/>result<sp/>codes<sp/>(RFC6886<sp/>3.5).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="81"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint8_t<sp/>NATPMP_RESULT_SUCCESS<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="83"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint8_t<sp/>NATPMP_RESULT_UNSUPP_VERSION<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="85"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint8_t<sp/>NATPMP_RESULT_NO_RESOURCES<sp/>=<sp/>4;</highlight></codeline>
<codeline lineno="86"><highlight class="normal"></highlight></codeline>
<codeline lineno="88"><highlight class="normal"></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::map&lt;uint16_t,<sp/>std::string&gt;<sp/>NATPMP_RESULT_STR{</highlight></codeline>
<codeline lineno="89"><highlight class="normal"><sp/><sp/><sp/><sp/>{0,<sp/><sp/></highlight><highlight class="stringliteral">&quot;SUCCESS&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/><sp/><sp/>{1,<sp/><sp/></highlight><highlight class="stringliteral">&quot;UNSUPP_VERSION&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="91"><highlight class="normal"><sp/><sp/><sp/><sp/>{2,<sp/><sp/></highlight><highlight class="stringliteral">&quot;NOT_AUTHORIZED&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/><sp/><sp/>{3,<sp/><sp/></highlight><highlight class="stringliteral">&quot;NETWORK_FAILURE&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/><sp/><sp/>{4,<sp/><sp/></highlight><highlight class="stringliteral">&quot;NO_RESOURCES&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="94"><highlight class="normal"><sp/><sp/><sp/><sp/>{5,<sp/><sp/></highlight><highlight class="stringliteral">&quot;UNSUPP_OPCODE&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="95"><highlight class="normal">};</highlight></codeline>
<codeline lineno="96"><highlight class="normal"></highlight></codeline>
<codeline lineno="97"><highlight class="normal"></highlight><highlight class="comment">//<sp/>PCP<sp/>(v2)<sp/>protocol<sp/>constants.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="99"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>PCP_MAX_SIZE<sp/>=<sp/>1100;</highlight></codeline>
<codeline lineno="101"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint16_t<sp/>PCP_SERVER_PORT<sp/>=<sp/>NATPMP_SERVER_PORT;</highlight></codeline>
<codeline lineno="103"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint8_t<sp/>PCP_VERSION<sp/>=<sp/>2;</highlight></codeline>
<codeline lineno="105"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint8_t<sp/>PCP_REQUEST<sp/>=<sp/>NATPMP_REQUEST;<sp/></highlight><highlight class="comment">//<sp/>R<sp/>=<sp/>0</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="107"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint8_t<sp/>PCP_RESPONSE<sp/>=<sp/>NATPMP_RESPONSE;<sp/></highlight><highlight class="comment">//<sp/>R<sp/>=<sp/>1</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="109"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint8_t<sp/>PCP_OP_MAP<sp/>=<sp/>0x01;</highlight></codeline>
<codeline lineno="111"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint16_t<sp/>PCP_PROTOCOL_TCP<sp/>=<sp/>6;</highlight></codeline>
<codeline lineno="113"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>PCP_HDR_SIZE<sp/>=<sp/>24;</highlight></codeline>
<codeline lineno="115"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>PCP_MAP_SIZE<sp/>=<sp/>36;</highlight></codeline>
<codeline lineno="116"><highlight class="normal"></highlight></codeline>
<codeline lineno="117"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Header<sp/>offsets<sp/>shared<sp/>between<sp/>request<sp/>and<sp/>responses<sp/>(RFC6887<sp/>7.1,<sp/>7.2),<sp/>relative<sp/>to<sp/>start<sp/>of<sp/>packet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="119"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>PCP_HDR_VERSION_OFS<sp/>=<sp/>NATPMP_HDR_VERSION_OFS;</highlight></codeline>
<codeline lineno="121"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>PCP_HDR_OP_OFS<sp/>=<sp/>NATPMP_HDR_OP_OFS;</highlight></codeline>
<codeline lineno="123"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>PCP_HDR_LIFETIME_OFS<sp/>=<sp/>4;</highlight></codeline>
<codeline lineno="124"><highlight class="normal"></highlight></codeline>
<codeline lineno="125"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Request<sp/>header<sp/>offsets<sp/>(RFC6887<sp/>7.1),<sp/>relative<sp/>to<sp/>start<sp/>of<sp/>packet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="127"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>PCP_REQUEST_HDR_IP_OFS<sp/>=<sp/>8;</highlight></codeline>
<codeline lineno="128"><highlight class="normal"></highlight></codeline>
<codeline lineno="129"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Response<sp/>header<sp/>offsets<sp/>(RFC6887<sp/>7.2),<sp/>relative<sp/>to<sp/>start<sp/>of<sp/>packet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="131"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>PCP_RESPONSE_HDR_RESULT_OFS<sp/>=<sp/>3;</highlight></codeline>
<codeline lineno="132"><highlight class="normal"></highlight></codeline>
<codeline lineno="133"><highlight class="normal"></highlight><highlight class="comment">//<sp/>MAP<sp/>request/response<sp/>offsets<sp/>(RFC6887<sp/>11.1),<sp/>relative<sp/>to<sp/>start<sp/>of<sp/>opcode-specific<sp/>data.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="135"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>PCP_MAP_NONCE_OFS<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="137"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>PCP_MAP_PROTOCOL_OFS<sp/>=<sp/>12;</highlight></codeline>
<codeline lineno="139"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>PCP_MAP_INTERNAL_PORT_OFS<sp/>=<sp/>16;</highlight></codeline>
<codeline lineno="141"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>PCP_MAP_EXTERNAL_PORT_OFS<sp/>=<sp/>18;</highlight></codeline>
<codeline lineno="143"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>PCP_MAP_EXTERNAL_IP_OFS<sp/>=<sp/>20;</highlight></codeline>
<codeline lineno="144"><highlight class="normal"></highlight></codeline>
<codeline lineno="146"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint8_t<sp/>PCP_RESULT_SUCCESS<sp/>=<sp/>NATPMP_RESULT_SUCCESS;</highlight></codeline>
<codeline lineno="148"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint8_t<sp/>PCP_RESULT_NO_RESOURCES<sp/>=<sp/>8;</highlight></codeline>
<codeline lineno="149"><highlight class="normal"></highlight></codeline>
<codeline lineno="151"><highlight class="normal"></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::map&lt;uint8_t,<sp/>std::string&gt;<sp/>PCP_RESULT_STR{</highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/><sp/><sp/>{0,<sp/><sp/></highlight><highlight class="stringliteral">&quot;SUCCESS&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/><sp/><sp/>{1,<sp/><sp/></highlight><highlight class="stringliteral">&quot;UNSUPP_VERSION&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="154"><highlight class="normal"><sp/><sp/><sp/><sp/>{2,<sp/><sp/></highlight><highlight class="stringliteral">&quot;NOT_AUTHORIZED&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="155"><highlight class="normal"><sp/><sp/><sp/><sp/>{3,<sp/><sp/></highlight><highlight class="stringliteral">&quot;MALFORMED_REQUEST&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/><sp/><sp/>{4,<sp/><sp/></highlight><highlight class="stringliteral">&quot;UNSUPP_OPCODE&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/><sp/><sp/>{5,<sp/><sp/></highlight><highlight class="stringliteral">&quot;UNSUPP_OPTION&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/><sp/><sp/>{6,<sp/><sp/></highlight><highlight class="stringliteral">&quot;MALFORMED_OPTION&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="159"><highlight class="normal"><sp/><sp/><sp/><sp/>{7,<sp/><sp/></highlight><highlight class="stringliteral">&quot;NETWORK_FAILURE&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/><sp/><sp/>{8,<sp/><sp/></highlight><highlight class="stringliteral">&quot;NO_RESOURCES&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="161"><highlight class="normal"><sp/><sp/><sp/><sp/>{9,<sp/><sp/></highlight><highlight class="stringliteral">&quot;UNSUPP_PROTOCOL&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/><sp/><sp/>{10,<sp/></highlight><highlight class="stringliteral">&quot;USER_EX_QUOTA&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/>{11,<sp/></highlight><highlight class="stringliteral">&quot;CANNOT_PROVIDE_EXTERNAL&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/>{12,<sp/></highlight><highlight class="stringliteral">&quot;ADDRESS_MISMATCH&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><sp/><sp/>{13,<sp/></highlight><highlight class="stringliteral">&quot;EXCESSIVE_REMOTE_PEER&quot;</highlight><highlight class="normal">},</highlight></codeline>
<codeline lineno="166"><highlight class="normal">};</highlight></codeline>
<codeline lineno="167"><highlight class="normal"></highlight></codeline>
<codeline lineno="169"><highlight class="normal">std::string<sp/>NATPMPResultString(uint16_t<sp/>result_code)</highlight></codeline>
<codeline lineno="170"><highlight class="normal">{</highlight></codeline>
<codeline lineno="171"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>result_i<sp/>=<sp/>NATPMP_RESULT_STR.find(result_code);</highlight></codeline>
<codeline lineno="172"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;%s<sp/>(code<sp/>%d)&quot;</highlight><highlight class="normal">,<sp/>result_i<sp/>==<sp/>NATPMP_RESULT_STR.end()<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;(unknown)&quot;</highlight><highlight class="normal"><sp/>:<sp/>result_i-&gt;second,<sp/><sp/>result_code);</highlight></codeline>
<codeline lineno="173"><highlight class="normal">}</highlight></codeline>
<codeline lineno="174"><highlight class="normal"></highlight></codeline>
<codeline lineno="176"><highlight class="normal">std::string<sp/>PCPResultString(uint8_t<sp/>result_code)</highlight></codeline>
<codeline lineno="177"><highlight class="normal">{</highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>result_i<sp/>=<sp/>PCP_RESULT_STR.find(result_code);</highlight></codeline>
<codeline lineno="179"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;%s<sp/>(code<sp/>%d)&quot;</highlight><highlight class="normal">,<sp/>result_i<sp/>==<sp/>PCP_RESULT_STR.end()<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;(unknown)&quot;</highlight><highlight class="normal"><sp/>:<sp/>result_i-&gt;second,<sp/><sp/>result_code);</highlight></codeline>
<codeline lineno="180"><highlight class="normal">}</highlight></codeline>
<codeline lineno="181"><highlight class="normal"></highlight></codeline>
<codeline lineno="183"><highlight class="normal">[[nodiscard]]<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PCPWrapAddress(std::span&lt;uint8_t&gt;<sp/>wrapped_addr,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_net_addr" kindref="compound">CNetAddr</ref><sp/>&amp;addr)</highlight></codeline>
<codeline lineno="184"><highlight class="normal">{</highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(wrapped_addr.size()<sp/>==<sp/>ADDR_IPV6_SIZE);</highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(addr.<ref refid="class_c_net_addr_1aaed993e317901f42322412d93d4cbd23" kindref="member">IsIPv4</ref>())<sp/>{</highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">in_addr<sp/>addr4;</highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!addr.<ref refid="class_c_net_addr_1a9740bb7c9b09f33439c608bca061c413" kindref="member">GetInAddr</ref>(&amp;addr4))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Section<sp/>5:<sp/>&quot;When<sp/>the<sp/>address<sp/>field<sp/>holds<sp/>an<sp/>IPv4<sp/>address,<sp/>an<sp/>IPv4-mapped<sp/>IPv6<sp/>address<sp/>[RFC4291]<sp/>is<sp/>used<sp/>(::ffff:0:0/96).&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::memcpy(wrapped_addr.data(),<sp/>IPV4_IN_IPV6_PREFIX.data(),<sp/>IPV4_IN_IPV6_PREFIX.size());</highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::memcpy(wrapped_addr.data()<sp/>+<sp/>IPV4_IN_IPV6_PREFIX.size(),<sp/>&amp;addr4,<sp/>ADDR_IPV4_SIZE);</highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(addr.<ref refid="class_c_net_addr_1af2abb915add82ed245df21127a3fcb9b" kindref="member">IsIPv6</ref>())<sp/>{</highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">in6_addr<sp/>addr6;</highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!addr.<ref refid="class_c_net_addr_1aed9676a59fc54a9a421d717afa2132f1" kindref="member">GetIn6Addr</ref>(&amp;addr6))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::memcpy(wrapped_addr.data(),<sp/>&amp;addr6,<sp/>ADDR_IPV6_SIZE);</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="201"><highlight class="normal">}</highlight></codeline>
<codeline lineno="202"><highlight class="normal"></highlight></codeline>
<codeline lineno="204"><highlight class="normal"><ref refid="class_c_net_addr" kindref="compound">CNetAddr</ref><sp/>PCPUnwrapAddress(std::span&lt;const<sp/>uint8_t&gt;<sp/>wrapped_addr)</highlight></codeline>
<codeline lineno="205"><highlight class="normal">{</highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(wrapped_addr.size()<sp/>==<sp/>ADDR_IPV6_SIZE);</highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="namespaceutil_1af23d4553c526fce640a92f491182057a" kindref="member">util::HasPrefix</ref>(wrapped_addr,<sp/>IPV4_IN_IPV6_PREFIX))<sp/>{</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">in_addr<sp/>addr4;</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::memcpy(&amp;addr4,<sp/>wrapped_addr.data()<sp/>+<sp/>IPV4_IN_IPV6_PREFIX.size(),<sp/>ADDR_IPV4_SIZE);</highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="class_c_net_addr" kindref="compound">CNetAddr</ref>(addr4);</highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">in6_addr<sp/>addr6;</highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::memcpy(&amp;addr6,<sp/>wrapped_addr.data(),<sp/>ADDR_IPV6_SIZE);</highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="class_c_net_addr" kindref="compound">CNetAddr</ref>(addr6);</highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="216"><highlight class="normal">}</highlight></codeline>
<codeline lineno="217"><highlight class="normal"></highlight></codeline>
<codeline lineno="219"><highlight class="normal">std::optional&lt;std::vector&lt;uint8_t&gt;&gt;<sp/>PCPSendRecv(<ref refid="class_sock" kindref="compound">Sock</ref><sp/>&amp;sock,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::string<sp/>&amp;protocol,<sp/>std::span&lt;const<sp/>uint8_t&gt;<sp/>request,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>num_tries,</highlight></codeline>
<codeline lineno="220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::chrono::milliseconds<sp/>timeout_per_try,</highlight></codeline>
<codeline lineno="221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::function&lt;</highlight><highlight class="keywordtype">bool</highlight><highlight class="normal">(std::span&lt;const<sp/>uint8_t&gt;)&gt;<sp/>check_packet,</highlight></codeline>
<codeline lineno="222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_thread_interrupt" kindref="compound">CThreadInterrupt</ref>&amp;<sp/>interrupt)</highlight></codeline>
<codeline lineno="223"><highlight class="normal">{</highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">using<sp/>namespace<sp/></highlight><highlight class="normal">std::chrono;</highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>UDP<sp/>is<sp/>a<sp/>potentially<sp/>lossy<sp/>protocol,<sp/>so<sp/>we<sp/>try<sp/>to<sp/>send<sp/>again<sp/>a<sp/>few<sp/>times.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t<sp/>response[PCP_MAX_SIZE];</highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>got_response<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>recvsz<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="229"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>ntry<sp/>=<sp/>0;<sp/>!got_response<sp/>&amp;&amp;<sp/>ntry<sp/>&lt;<sp/>num_tries;<sp/>++ntry)<sp/>{</highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ntry<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="231"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s:<sp/>Retrying<sp/>(%d)\n&quot;</highlight><highlight class="normal">,<sp/>protocol,<sp/>ntry);</highlight></codeline>
<codeline lineno="232"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Dispatch<sp/>packet<sp/>to<sp/>gateway.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sock.<ref refid="class_sock_1ad50f4b43d2b968d64162193e9254d6b5" kindref="member">Send</ref>(request.data(),<sp/>request.size(),<sp/>0)<sp/>!=<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="normal">ssize_t</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(request.size()))<sp/>{</highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s:<sp/>Could<sp/>not<sp/>send<sp/>request:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>protocol,<sp/><ref refid="sock_8cpp_1a8ddb7d8d6e5b5cfabfdeea132f556977" kindref="member">NetworkErrorString</ref>(<ref refid="compat_8h_1a6d24fe3ab2906c21c373505ca244f90b" kindref="member">WSAGetLastError</ref>()));</highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::nullopt;<sp/></highlight><highlight class="comment">//<sp/>Network-level<sp/>error,<sp/>probably<sp/>no<sp/>use<sp/>retrying.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="238"><highlight class="normal"></highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Wait<sp/>for<sp/>response(s)<sp/>until<sp/>we<sp/>get<sp/>a<sp/>valid<sp/>response,<sp/>a<sp/>network<sp/>error,<sp/>or<sp/>time<sp/>out.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>cur_time<sp/>=<sp/>time_point_cast&lt;milliseconds&gt;(<ref refid="struct_mockable_steady_clock_1adffd6475a6c9d2db2eb802508626e900" kindref="member">MockableSteadyClock::now</ref>());</highlight></codeline>
<codeline lineno="241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>deadline<sp/>=<sp/>cur_time<sp/>+<sp/>timeout_per_try;</highlight></codeline>
<codeline lineno="242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>((cur_time<sp/>=<sp/>time_point_cast&lt;milliseconds&gt;(<ref refid="struct_mockable_steady_clock_1adffd6475a6c9d2db2eb802508626e900" kindref="member">MockableSteadyClock::now</ref>()))<sp/>&lt;<sp/>deadline)<sp/>{</highlight></codeline>
<codeline lineno="243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(interrupt)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::nullopt;</highlight></codeline>
<codeline lineno="244"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_sock_1a4b6dc81990bf0cf4838a46f8c9729e1b" kindref="member">Sock::Event</ref><sp/>occurred<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sock.<ref refid="class_sock_1a851a09613d347a157da032137020065a" kindref="member">Wait</ref>(deadline<sp/>-<sp/>cur_time,<sp/><ref refid="class_sock_1ae15d539512bccb6583fc75310b0d2f86" kindref="member">Sock::RECV</ref>,<sp/>&amp;occurred))<sp/>{</highlight></codeline>
<codeline lineno="246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;%s:<sp/>Could<sp/>not<sp/>wait<sp/>on<sp/>socket:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>protocol,<sp/><ref refid="sock_8cpp_1a8ddb7d8d6e5b5cfabfdeea132f556977" kindref="member">NetworkErrorString</ref>(<ref refid="compat_8h_1a6d24fe3ab2906c21c373505ca244f90b" kindref="member">WSAGetLastError</ref>()));</highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::nullopt;<sp/></highlight><highlight class="comment">//<sp/>Network-level<sp/>error,<sp/>probably<sp/>no<sp/>use<sp/>retrying.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!occurred)<sp/>{</highlight></codeline>
<codeline lineno="250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s:<sp/>Timeout\n&quot;</highlight><highlight class="normal">,<sp/>protocol);</highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>Retry.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="253"><highlight class="normal"></highlight></codeline>
<codeline lineno="254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Receive<sp/>response.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>recvsz<sp/>=<sp/>sock.<ref refid="class_sock_1ad5d478226aba69810d73757744e13317" kindref="member">Recv</ref>(response,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(response),<sp/><ref refid="compat_8h_1ab18d3d439e4a9c8d0f73e7166e8eb376" kindref="member">MSG_DONTWAIT</ref>);</highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(recvsz<sp/>&lt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s:<sp/>Could<sp/>not<sp/>receive<sp/>response:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>protocol,<sp/><ref refid="sock_8cpp_1a8ddb7d8d6e5b5cfabfdeea132f556977" kindref="member">NetworkErrorString</ref>(<ref refid="compat_8h_1a6d24fe3ab2906c21c373505ca244f90b" kindref="member">WSAGetLastError</ref>()));</highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::nullopt;<sp/></highlight><highlight class="comment">//<sp/>Network-level<sp/>error,<sp/>probably<sp/>no<sp/>use<sp/>retrying.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s:<sp/>Received<sp/>response<sp/>of<sp/>%d<sp/>bytes:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>protocol,<sp/>recvsz,<sp/><ref refid="hex__base_8cpp_1ac2c88b156e9e245fa3d0a66105ecd371" kindref="member">HexStr</ref>(std::span(response,<sp/>recvsz)));</highlight></codeline>
<codeline lineno="261"><highlight class="normal"></highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(check_packet(std::span&lt;uint8_t&gt;(response,<sp/>recvsz)))<sp/>{</highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>got_response<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>Got<sp/>expected<sp/>response,<sp/>break<sp/>from<sp/>receive<sp/>loop<sp/>as<sp/>well<sp/>as<sp/>from<sp/>retry<sp/>loop.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="264"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="266"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="267"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!got_response)<sp/>{</highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s:<sp/>Giving<sp/>up<sp/>after<sp/>%d<sp/>tries\n&quot;</highlight><highlight class="normal">,<sp/>protocol,<sp/>num_tries);</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::nullopt;</highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::vector&lt;uint8_t&gt;(response,<sp/>response<sp/>+<sp/>recvsz);</highlight></codeline>
<codeline lineno="273"><highlight class="normal">}</highlight></codeline>
<codeline lineno="274"><highlight class="normal"></highlight></codeline>
<codeline lineno="275"><highlight class="normal">}</highlight></codeline>
<codeline lineno="276"><highlight class="normal"></highlight></codeline>
<codeline lineno="277"><highlight class="normal">std::variant&lt;MappingResult,<sp/>MappingError&gt;<sp/><ref refid="common_2pcp_8cpp_1a862c9fc77990f48d908dd6f75932cb92" kindref="member">NATPMPRequestPortMap</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_net_addr" kindref="compound">CNetAddr</ref><sp/>&amp;gateway,<sp/>uint16_t<sp/>port,<sp/>uint32_t<sp/>lifetime,<sp/><ref refid="class_c_thread_interrupt" kindref="compound">CThreadInterrupt</ref>&amp;<sp/>interrupt,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>num_tries,<sp/>std::chrono::milliseconds<sp/>timeout_per_try)</highlight></codeline>
<codeline lineno="278"><highlight class="normal">{</highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">sockaddr_storage<sp/>dest_addr;</highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/>socklen_t<sp/>dest_addrlen<sp/>=<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">sockaddr_storage);</highlight></codeline>
<codeline lineno="281"><highlight class="normal"></highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;natpmp:<sp/>Requesting<sp/>port<sp/>mapping<sp/>port<sp/>%d<sp/>from<sp/>gateway<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>port,<sp/>gateway.<ref refid="class_c_net_addr_1aa811113cabd7bfaaaf6a1bea17c0b9f4" kindref="member">ToStringAddr</ref>());</highlight></codeline>
<codeline lineno="283"><highlight class="normal"></highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Validate<sp/>gateway,<sp/>make<sp/>sure<sp/>it&apos;s<sp/>IPv4.<sp/>NAT-PMP<sp/>does<sp/>not<sp/>support<sp/>IPv6.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_c_service" kindref="compound">CService</ref>(gateway,<sp/>PCP_SERVER_PORT).GetSockAddr((</highlight><highlight class="keyword">struct</highlight><highlight class="normal"><sp/>sockaddr*)&amp;dest_addr,<sp/>&amp;dest_addrlen))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a547ba52b62f9302ee1b6950111c36f9f" kindref="member">MappingError::NETWORK_ERROR</ref>;</highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(dest_addr.ss_family<sp/>!=<sp/>AF_INET)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a547ba52b62f9302ee1b6950111c36f9f" kindref="member">MappingError::NETWORK_ERROR</ref>;</highlight></codeline>
<codeline lineno="287"><highlight class="normal"></highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Create<sp/>IPv4<sp/>UDP<sp/>socket</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="289"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>sock{<ref refid="netbase_8cpp_1ae0a040134849ed822e283537c1c902cd" kindref="member">CreateSock</ref>(AF_INET,<sp/>SOCK_DGRAM,<sp/>IPPROTO_UDP)};</highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sock)<sp/>{</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;natpmp:<sp/>Could<sp/>not<sp/>create<sp/>UDP<sp/>socket:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/><ref refid="sock_8cpp_1a8ddb7d8d6e5b5cfabfdeea132f556977" kindref="member">NetworkErrorString</ref>(<ref refid="compat_8h_1a6d24fe3ab2906c21c373505ca244f90b" kindref="member">WSAGetLastError</ref>()));</highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a547ba52b62f9302ee1b6950111c36f9f" kindref="member">MappingError::NETWORK_ERROR</ref>;</highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="294"><highlight class="normal"></highlight></codeline>
<codeline lineno="295"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Associate<sp/>UDP<sp/>socket<sp/>to<sp/>gateway.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sock-&gt;<ref refid="class_sock_1a5f5be77492fb494cd6b2effd50d18435" kindref="member">Connect</ref>((</highlight><highlight class="keyword">struct</highlight><highlight class="normal"><sp/>sockaddr*)&amp;dest_addr,<sp/>dest_addrlen)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="297"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;natpmp:<sp/>Could<sp/>not<sp/>connect<sp/>to<sp/>gateway:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/><ref refid="sock_8cpp_1a8ddb7d8d6e5b5cfabfdeea132f556977" kindref="member">NetworkErrorString</ref>(<ref refid="compat_8h_1a6d24fe3ab2906c21c373505ca244f90b" kindref="member">WSAGetLastError</ref>()));</highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a547ba52b62f9302ee1b6950111c36f9f" kindref="member">MappingError::NETWORK_ERROR</ref>;</highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="300"><highlight class="normal"></highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Use<sp/>getsockname<sp/>to<sp/>get<sp/>the<sp/>address<sp/>toward<sp/>the<sp/>default<sp/>gateway<sp/>(the<sp/>internal<sp/>address).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="302"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">sockaddr_in<sp/>internal;</highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/><sp/><sp/>socklen_t<sp/>internal_addrlen<sp/>=<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">sockaddr_in);</highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sock-&gt;<ref refid="class_sock_1a8544fa939816100e03ecba0a79fde2b1" kindref="member">GetSockName</ref>((</highlight><highlight class="keyword">struct</highlight><highlight class="normal"><sp/>sockaddr*)&amp;internal,<sp/>&amp;internal_addrlen)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LogWarning(</highlight><highlight class="stringliteral">&quot;natpmp:<sp/>Could<sp/>not<sp/>get<sp/>sock<sp/>name:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>NetworkErrorString(WSAGetLastError()));</highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>MappingError::NETWORK_ERROR;</highlight></codeline>
<codeline lineno="307"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="308"><highlight class="normal"></highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Request<sp/>external<sp/>IP<sp/>address<sp/>(RFC6886<sp/>section<sp/>3.2).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;uint8_t&gt;<sp/>request(NATPMP_GETEXTERNAL_REQUEST_SIZE);</highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/>request[NATPMP_HDR_VERSION_OFS]<sp/>=<sp/>NATPMP_VERSION;</highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><sp/><sp/>request[NATPMP_HDR_OP_OFS]<sp/>=<sp/>NATPMP_REQUEST<sp/>|<sp/>NATPMP_OP_GETEXTERNAL;</highlight></codeline>
<codeline lineno="313"><highlight class="normal"></highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>recv_res<sp/>=<sp/>PCPSendRecv(*sock,<sp/></highlight><highlight class="stringliteral">&quot;natpmp&quot;</highlight><highlight class="normal">,<sp/>request,<sp/>num_tries,<sp/>timeout_per_try,</highlight></codeline>
<codeline lineno="315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[&amp;](</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::span&lt;const<sp/>uint8_t&gt;<sp/>response)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(response.size()<sp/>&lt;<sp/>NATPMP_GETEXTERNAL_RESPONSE_SIZE)<sp/>{</highlight></codeline>
<codeline lineno="317"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;natpmp:<sp/>Response<sp/>too<sp/>small\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>Wasn&apos;t<sp/>response<sp/>to<sp/>what<sp/>we<sp/>expected,<sp/>try<sp/>receiving<sp/>next<sp/>packet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(response[NATPMP_HDR_VERSION_OFS]<sp/>!=<sp/>NATPMP_VERSION<sp/>||<sp/>response[NATPMP_HDR_OP_OFS]<sp/>!=<sp/>(NATPMP_RESPONSE<sp/>|<sp/>NATPMP_OP_GETEXTERNAL))<sp/>{</highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;natpmp:<sp/>Response<sp/>to<sp/>wrong<sp/>command\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>Wasn&apos;t<sp/>response<sp/>to<sp/>what<sp/>we<sp/>expected,<sp/>try<sp/>receiving<sp/>next<sp/>packet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>},</highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>interrupt);</highlight></codeline>
<codeline lineno="327"><highlight class="normal"></highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">in_addr<sp/>external_addr;</highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(recv_res)<sp/>{</highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::span&lt;const<sp/>uint8_t&gt;<sp/>response<sp/>=<sp/>*recv_res;</highlight></codeline>
<codeline lineno="331"><highlight class="normal"></highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(response.size()<sp/>&gt;=<sp/>NATPMP_GETEXTERNAL_RESPONSE_SIZE);</highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint16_t<sp/>result_code<sp/>=<sp/><ref refid="crypto_2common_8h_1a776d823b1cdb3ba6f9c7966d16f7acf0" kindref="member">ReadBE16</ref>(response.data()<sp/>+<sp/>NATPMP_RESPONSE_HDR_RESULT_OFS);</highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(result_code<sp/>!=<sp/>NATPMP_RESULT_SUCCESS)<sp/>{</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;natpmp:<sp/>Getting<sp/>external<sp/>address<sp/>failed<sp/>with<sp/>result<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>NATPMPResultString(result_code));</highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a23f149f0f9ae9ed9e0119e7209178a5d" kindref="member">MappingError::PROTOCOL_ERROR</ref>;</highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="338"><highlight class="normal"></highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::memcpy(&amp;external_addr,<sp/>response.data()<sp/>+<sp/>NATPMP_GETEXTERNAL_RESPONSE_IP_OFS,<sp/>ADDR_IPV4_SIZE);</highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a547ba52b62f9302ee1b6950111c36f9f" kindref="member">MappingError::NETWORK_ERROR</ref>;</highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="343"><highlight class="normal"></highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Create<sp/>TCP<sp/>mapping<sp/>request<sp/>(RFC6886<sp/>section<sp/>3.3).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/>request<sp/>=<sp/>std::vector&lt;uint8_t&gt;(NATPMP_MAP_REQUEST_SIZE);</highlight></codeline>
<codeline lineno="346"><highlight class="normal"><sp/><sp/><sp/><sp/>request[NATPMP_HDR_VERSION_OFS]<sp/>=<sp/>NATPMP_VERSION;</highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/>request[NATPMP_HDR_OP_OFS]<sp/>=<sp/>NATPMP_REQUEST<sp/>|<sp/>NATPMP_OP_MAP_TCP;</highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="crypto_2common_8h_1a6e69ee0476db79bba4a9523b97380856" kindref="member">WriteBE16</ref>(request.data()<sp/>+<sp/>NATPMP_MAP_REQUEST_INTERNAL_PORT_OFS,<sp/>port);</highlight></codeline>
<codeline lineno="349"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="crypto_2common_8h_1a6e69ee0476db79bba4a9523b97380856" kindref="member">WriteBE16</ref>(request.data()<sp/>+<sp/>NATPMP_MAP_REQUEST_EXTERNAL_PORT_OFS,<sp/>port);</highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="crypto_2common_8h_1a61710c1fb467677ea004c83f207235f6" kindref="member">WriteBE32</ref>(request.data()<sp/>+<sp/>NATPMP_MAP_REQUEST_LIFETIME_OFS,<sp/>lifetime);</highlight></codeline>
<codeline lineno="351"><highlight class="normal"></highlight></codeline>
<codeline lineno="352"><highlight class="normal"><sp/><sp/><sp/><sp/>recv_res<sp/>=<sp/>PCPSendRecv(*sock,<sp/></highlight><highlight class="stringliteral">&quot;natpmp&quot;</highlight><highlight class="normal">,<sp/>request,<sp/>num_tries,<sp/>timeout_per_try,</highlight></codeline>
<codeline lineno="353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[&amp;](</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::span&lt;const<sp/>uint8_t&gt;<sp/>response)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(response.size()<sp/>&lt;<sp/>NATPMP_MAP_RESPONSE_SIZE)<sp/>{</highlight></codeline>
<codeline lineno="355"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;natpmp:<sp/>Response<sp/>too<sp/>small\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="356"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>Wasn&apos;t<sp/>response<sp/>to<sp/>what<sp/>we<sp/>expected,<sp/>try<sp/>receiving<sp/>next<sp/>packet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(response[0]<sp/>!=<sp/>NATPMP_VERSION<sp/>||<sp/>response[1]<sp/>!=<sp/>(NATPMP_RESPONSE<sp/>|<sp/>NATPMP_OP_MAP_TCP))<sp/>{</highlight></codeline>
<codeline lineno="359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;natpmp:<sp/>Response<sp/>to<sp/>wrong<sp/>command\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>Wasn&apos;t<sp/>response<sp/>to<sp/>what<sp/>we<sp/>expected,<sp/>try<sp/>receiving<sp/>next<sp/>packet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint16_t<sp/>internal_port<sp/>=<sp/><ref refid="crypto_2common_8h_1a776d823b1cdb3ba6f9c7966d16f7acf0" kindref="member">ReadBE16</ref>(response.data()<sp/>+<sp/>NATPMP_MAP_RESPONSE_INTERNAL_PORT_OFS);</highlight></codeline>
<codeline lineno="363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(internal_port<sp/>!=<sp/>port)<sp/>{</highlight></codeline>
<codeline lineno="364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;natpmp:<sp/>Response<sp/>port<sp/>doesn&apos;t<sp/>match<sp/>request\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>Wasn&apos;t<sp/>response<sp/>to<sp/>what<sp/>we<sp/>expected,<sp/>try<sp/>receiving<sp/>next<sp/>packet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="366"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>},</highlight></codeline>
<codeline lineno="369"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>interrupt);</highlight></codeline>
<codeline lineno="370"><highlight class="normal"></highlight></codeline>
<codeline lineno="371"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(recv_res)<sp/>{</highlight></codeline>
<codeline lineno="372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::span&lt;uint8_t&gt;<sp/>response<sp/>=<sp/>*recv_res;</highlight></codeline>
<codeline lineno="373"><highlight class="normal"></highlight></codeline>
<codeline lineno="374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(response.size()<sp/>&gt;=<sp/>NATPMP_MAP_RESPONSE_SIZE);</highlight></codeline>
<codeline lineno="375"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint16_t<sp/>result_code<sp/>=<sp/><ref refid="crypto_2common_8h_1a776d823b1cdb3ba6f9c7966d16f7acf0" kindref="member">ReadBE16</ref>(response.data()<sp/>+<sp/>NATPMP_RESPONSE_HDR_RESULT_OFS);</highlight></codeline>
<codeline lineno="376"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(result_code<sp/>!=<sp/>NATPMP_RESULT_SUCCESS)<sp/>{</highlight></codeline>
<codeline lineno="377"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;natpmp:<sp/>Port<sp/>mapping<sp/>failed<sp/>with<sp/>result<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>NATPMPResultString(result_code));</highlight></codeline>
<codeline lineno="378"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(result_code<sp/>==<sp/>NATPMP_RESULT_NO_RESOURCES)<sp/>{</highlight></codeline>
<codeline lineno="379"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a3e052484eaaabf0d14b8c4b40267694f" kindref="member">MappingError::NO_RESOURCES</ref>;</highlight></codeline>
<codeline lineno="380"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="381"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a23f149f0f9ae9ed9e0119e7209178a5d" kindref="member">MappingError::PROTOCOL_ERROR</ref>;</highlight></codeline>
<codeline lineno="382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="383"><highlight class="normal"></highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>lifetime_ret<sp/>=<sp/><ref refid="crypto_2common_8h_1ae34e43528bdaaf18b35710e52ba493d5" kindref="member">ReadBE32</ref>(response.data()<sp/>+<sp/>NATPMP_MAP_RESPONSE_LIFETIME_OFS);</highlight></codeline>
<codeline lineno="385"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint16_t<sp/>external_port<sp/>=<sp/><ref refid="crypto_2common_8h_1a776d823b1cdb3ba6f9c7966d16f7acf0" kindref="member">ReadBE16</ref>(response.data()<sp/>+<sp/>NATPMP_MAP_RESPONSE_EXTERNAL_PORT_OFS);</highlight></codeline>
<codeline lineno="386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_mapping_result" kindref="compound">MappingResult</ref>(NATPMP_VERSION,<sp/><ref refid="class_c_service" kindref="compound">CService</ref>(internal.sin_addr,<sp/>port),<sp/><ref refid="class_c_service" kindref="compound">CService</ref>(external_addr,<sp/>external_port),<sp/>lifetime_ret);</highlight></codeline>
<codeline lineno="387"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="388"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a547ba52b62f9302ee1b6950111c36f9f" kindref="member">MappingError::NETWORK_ERROR</ref>;</highlight></codeline>
<codeline lineno="389"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="390"><highlight class="normal">}</highlight></codeline>
<codeline lineno="391"><highlight class="normal"></highlight></codeline>
<codeline lineno="392"><highlight class="normal">std::variant&lt;MappingResult,<sp/>MappingError&gt;<sp/><ref refid="common_2pcp_8cpp_1aca35c511d2afcb871e00ca441e3881c3" kindref="member">PCPRequestPortMap</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1a761c2cf99a646566fbfd29df4d42d498" kindref="member">PCPMappingNonce</ref><sp/>&amp;<ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref>,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_net_addr" kindref="compound">CNetAddr</ref><sp/>&amp;gateway,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_net_addr" kindref="compound">CNetAddr</ref><sp/>&amp;bind,<sp/>uint16_t<sp/>port,<sp/>uint32_t<sp/>lifetime,<sp/><ref refid="class_c_thread_interrupt" kindref="compound">CThreadInterrupt</ref>&amp;<sp/>interrupt,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>num_tries,<sp/>std::chrono::milliseconds<sp/>timeout_per_try)</highlight></codeline>
<codeline lineno="393"><highlight class="normal">{</highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">sockaddr_storage<sp/>dest_addr,<sp/>bind_addr;</highlight></codeline>
<codeline lineno="395"><highlight class="normal"><sp/><sp/><sp/><sp/>socklen_t<sp/>dest_addrlen<sp/>=<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">sockaddr_storage),<sp/>bind_addrlen<sp/>=<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">sockaddr_storage);</highlight></codeline>
<codeline lineno="396"><highlight class="normal"></highlight></codeline>
<codeline lineno="397"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;pcp:<sp/>Requesting<sp/>port<sp/>mapping<sp/>for<sp/>addr<sp/>%s<sp/>port<sp/>%d<sp/>from<sp/>gateway<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>bind.<ref refid="class_c_net_addr_1aa811113cabd7bfaaaf6a1bea17c0b9f4" kindref="member">ToStringAddr</ref>(),<sp/>port,<sp/>gateway.<ref refid="class_c_net_addr_1aa811113cabd7bfaaaf6a1bea17c0b9f4" kindref="member">ToStringAddr</ref>());</highlight></codeline>
<codeline lineno="398"><highlight class="normal"></highlight></codeline>
<codeline lineno="399"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Validate<sp/>addresses,<sp/>make<sp/>sure<sp/>they&apos;re<sp/>the<sp/>same<sp/>network<sp/>family.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="400"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_c_service" kindref="compound">CService</ref>(gateway,<sp/>PCP_SERVER_PORT).GetSockAddr((</highlight><highlight class="keyword">struct</highlight><highlight class="normal"><sp/>sockaddr*)&amp;dest_addr,<sp/>&amp;dest_addrlen))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a547ba52b62f9302ee1b6950111c36f9f" kindref="member">MappingError::NETWORK_ERROR</ref>;</highlight></codeline>
<codeline lineno="401"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_c_service" kindref="compound">CService</ref>(bind,<sp/>0).GetSockAddr((</highlight><highlight class="keyword">struct</highlight><highlight class="normal"><sp/>sockaddr*)&amp;bind_addr,<sp/>&amp;bind_addrlen))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a547ba52b62f9302ee1b6950111c36f9f" kindref="member">MappingError::NETWORK_ERROR</ref>;</highlight></codeline>
<codeline lineno="402"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(dest_addr.ss_family<sp/>!=<sp/>bind_addr.ss_family)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a547ba52b62f9302ee1b6950111c36f9f" kindref="member">MappingError::NETWORK_ERROR</ref>;</highlight></codeline>
<codeline lineno="403"><highlight class="normal"></highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Create<sp/>UDP<sp/>socket<sp/>(IPv4<sp/>or<sp/>IPv6<sp/>based<sp/>on<sp/>provided<sp/>gateway).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="405"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>sock{<ref refid="netbase_8cpp_1ae0a040134849ed822e283537c1c902cd" kindref="member">CreateSock</ref>(dest_addr.ss_family,<sp/>SOCK_DGRAM,<sp/>IPPROTO_UDP)};</highlight></codeline>
<codeline lineno="406"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!sock)<sp/>{</highlight></codeline>
<codeline lineno="407"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;pcp:<sp/>Could<sp/>not<sp/>create<sp/>UDP<sp/>socket:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/><ref refid="sock_8cpp_1a8ddb7d8d6e5b5cfabfdeea132f556977" kindref="member">NetworkErrorString</ref>(<ref refid="compat_8h_1a6d24fe3ab2906c21c373505ca244f90b" kindref="member">WSAGetLastError</ref>()));</highlight></codeline>
<codeline lineno="408"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a547ba52b62f9302ee1b6950111c36f9f" kindref="member">MappingError::NETWORK_ERROR</ref>;</highlight></codeline>
<codeline lineno="409"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="410"><highlight class="normal"></highlight></codeline>
<codeline lineno="411"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Make<sp/>sure<sp/>that<sp/>we<sp/>send<sp/>from<sp/>requested<sp/>destination<sp/>address,<sp/>anything<sp/>else<sp/>will<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="412"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>rejected<sp/>by<sp/>a<sp/>security-conscious<sp/>router.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="413"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sock-&gt;<ref refid="class_sock_1ae84297efb7d81f94d5c839a4b3b2abd8" kindref="member">Bind</ref>((</highlight><highlight class="keyword">struct</highlight><highlight class="normal"><sp/>sockaddr*)&amp;bind_addr,<sp/>bind_addrlen)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="414"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;pcp:<sp/>Could<sp/>not<sp/>bind<sp/>to<sp/>address:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/><ref refid="sock_8cpp_1a8ddb7d8d6e5b5cfabfdeea132f556977" kindref="member">NetworkErrorString</ref>(<ref refid="compat_8h_1a6d24fe3ab2906c21c373505ca244f90b" kindref="member">WSAGetLastError</ref>()));</highlight></codeline>
<codeline lineno="415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a547ba52b62f9302ee1b6950111c36f9f" kindref="member">MappingError::NETWORK_ERROR</ref>;</highlight></codeline>
<codeline lineno="416"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="417"><highlight class="normal"></highlight></codeline>
<codeline lineno="418"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Associate<sp/>UDP<sp/>socket<sp/>to<sp/>gateway.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="419"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sock-&gt;<ref refid="class_sock_1a5f5be77492fb494cd6b2effd50d18435" kindref="member">Connect</ref>((</highlight><highlight class="keyword">struct</highlight><highlight class="normal"><sp/>sockaddr*)&amp;dest_addr,<sp/>dest_addrlen)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;pcp:<sp/>Could<sp/>not<sp/>connect<sp/>to<sp/>gateway:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/><ref refid="sock_8cpp_1a8ddb7d8d6e5b5cfabfdeea132f556977" kindref="member">NetworkErrorString</ref>(<ref refid="compat_8h_1a6d24fe3ab2906c21c373505ca244f90b" kindref="member">WSAGetLastError</ref>()));</highlight></codeline>
<codeline lineno="421"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a547ba52b62f9302ee1b6950111c36f9f" kindref="member">MappingError::NETWORK_ERROR</ref>;</highlight></codeline>
<codeline lineno="422"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="423"><highlight class="normal"></highlight></codeline>
<codeline lineno="424"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Use<sp/>getsockname<sp/>to<sp/>get<sp/>the<sp/>address<sp/>toward<sp/>the<sp/>default<sp/>gateway<sp/>(the<sp/>internal<sp/>address),</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="425"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>in<sp/>case<sp/>we<sp/>don&apos;t<sp/>know<sp/>what<sp/>address<sp/>to<sp/>map</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="426"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(this<sp/>is<sp/>only<sp/>needed<sp/>if<sp/>bind<sp/>is<sp/>INADDR_ANY,<sp/>but<sp/>it<sp/>doesn&apos;t<sp/>hurt<sp/>as<sp/>an<sp/>extra<sp/>check).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="427"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">sockaddr_storage<sp/>internal_addr;</highlight></codeline>
<codeline lineno="428"><highlight class="normal"><sp/><sp/><sp/><sp/>socklen_t<sp/>internal_addrlen<sp/>=<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">sockaddr_storage);</highlight></codeline>
<codeline lineno="429"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sock-&gt;<ref refid="class_sock_1a8544fa939816100e03ecba0a79fde2b1" kindref="member">GetSockName</ref>((</highlight><highlight class="keyword">struct</highlight><highlight class="normal"><sp/>sockaddr*)&amp;internal_addr,<sp/>&amp;internal_addrlen)<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LogWarning(</highlight><highlight class="stringliteral">&quot;pcp:<sp/>Could<sp/>not<sp/>get<sp/>sock<sp/>name:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>NetworkErrorString(WSAGetLastError()));</highlight></codeline>
<codeline lineno="431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>MappingError::NETWORK_ERROR;</highlight></codeline>
<codeline lineno="432"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="433"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_service" kindref="compound">CService</ref><sp/>internal;</highlight></codeline>
<codeline lineno="434"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="bitcoin-cli_8cpp_1a33ca945cbc30c0f7b2a7e5393a99d5d4" kindref="member">if</ref><sp/>(!internal.SetSockAddr((</highlight><highlight class="keyword">struct</highlight><highlight class="normal"><sp/>sockaddr*)&amp;internal_addr,<sp/>internal_addrlen))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a547ba52b62f9302ee1b6950111c36f9f" kindref="member">MappingError::NETWORK_ERROR</ref>;</highlight></codeline>
<codeline lineno="435"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;pcp:<sp/>Internal<sp/>address<sp/>after<sp/>connect:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>internal.ToStringAddr());</highlight></codeline>
<codeline lineno="436"><highlight class="normal"></highlight></codeline>
<codeline lineno="437"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Build<sp/>request<sp/>packet.<sp/>Make<sp/>sure<sp/>the<sp/>packet<sp/>is<sp/>zeroed<sp/>so<sp/>that<sp/>reserved<sp/>fields<sp/>are<sp/>zero</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="438"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>as<sp/>required<sp/>by<sp/>the<sp/>spec<sp/>(and<sp/>not<sp/>potentially<sp/>leak<sp/>data).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="439"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Make<sp/>sure<sp/>there&apos;s<sp/>space<sp/>for<sp/>the<sp/>request<sp/>header<sp/>and<sp/>MAP<sp/>specific<sp/>request<sp/>data.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="440"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;uint8_t&gt;<sp/>request(PCP_HDR_SIZE<sp/>+<sp/>PCP_MAP_SIZE);</highlight></codeline>
<codeline lineno="441"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Fill<sp/>in<sp/>request<sp/>header,<sp/>See<sp/>RFC6887<sp/>Figure<sp/>2.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="442"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>ofs<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="443"><highlight class="normal"><sp/><sp/><sp/><sp/>request[ofs<sp/>+<sp/>PCP_HDR_VERSION_OFS]<sp/>=<sp/>PCP_VERSION;</highlight></codeline>
<codeline lineno="444"><highlight class="normal"><sp/><sp/><sp/><sp/>request[ofs<sp/>+<sp/>PCP_HDR_OP_OFS]<sp/>=<sp/>PCP_REQUEST<sp/>|<sp/>PCP_OP_MAP;</highlight></codeline>
<codeline lineno="445"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="crypto_2common_8h_1a61710c1fb467677ea004c83f207235f6" kindref="member">WriteBE32</ref>(request.data()<sp/>+<sp/>ofs<sp/>+<sp/>PCP_HDR_LIFETIME_OFS,<sp/>lifetime);</highlight></codeline>
<codeline lineno="446"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!PCPWrapAddress(std::span(request).subspan(ofs<sp/>+<sp/>PCP_REQUEST_HDR_IP_OFS,<sp/>ADDR_IPV6_SIZE),<sp/>internal))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a547ba52b62f9302ee1b6950111c36f9f" kindref="member">MappingError::NETWORK_ERROR</ref>;</highlight></codeline>
<codeline lineno="447"><highlight class="normal"></highlight></codeline>
<codeline lineno="448"><highlight class="normal"><sp/><sp/><sp/><sp/>ofs<sp/>+=<sp/>PCP_HDR_SIZE;</highlight></codeline>
<codeline lineno="449"><highlight class="normal"></highlight></codeline>
<codeline lineno="450"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Fill<sp/>in<sp/>MAP<sp/>request<sp/>packet,<sp/>See<sp/>RFC6887<sp/>Figure<sp/>9.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="451"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Randomize<sp/>mapping<sp/>nonce<sp/>(this<sp/>is<sp/>repeated<sp/>in<sp/>the<sp/>response,<sp/>to<sp/>be<sp/>able<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="452"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>correlate<sp/>requests<sp/>and<sp/>responses,<sp/>and<sp/>used<sp/>to<sp/>authenticate<sp/>changes<sp/>to<sp/>the<sp/>mapping).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="453"><highlight class="normal"><sp/><sp/><sp/><sp/>std::memcpy(request.data()<sp/>+<sp/>ofs<sp/>+<sp/>PCP_MAP_NONCE_OFS,<sp/><ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref>.data(),<sp/><ref refid="pcp_8h_1a85e8c19b124b5dee5fb8f43f8dcc0b75" kindref="member">PCP_MAP_NONCE_SIZE</ref>);</highlight></codeline>
<codeline lineno="454"><highlight class="normal"><sp/><sp/><sp/><sp/>request[ofs<sp/>+<sp/>PCP_MAP_PROTOCOL_OFS]<sp/>=<sp/>PCP_PROTOCOL_TCP;</highlight></codeline>
<codeline lineno="455"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="crypto_2common_8h_1a6e69ee0476db79bba4a9523b97380856" kindref="member">WriteBE16</ref>(request.data()<sp/>+<sp/>ofs<sp/>+<sp/>PCP_MAP_INTERNAL_PORT_OFS,<sp/>port);</highlight></codeline>
<codeline lineno="456"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="crypto_2common_8h_1a6e69ee0476db79bba4a9523b97380856" kindref="member">WriteBE16</ref>(request.data()<sp/>+<sp/>ofs<sp/>+<sp/>PCP_MAP_EXTERNAL_PORT_OFS,<sp/>port);</highlight></codeline>
<codeline lineno="457"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!PCPWrapAddress(std::span(request).subspan(ofs<sp/>+<sp/>PCP_MAP_EXTERNAL_IP_OFS,<sp/>ADDR_IPV6_SIZE),<sp/>bind))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a547ba52b62f9302ee1b6950111c36f9f" kindref="member">MappingError::NETWORK_ERROR</ref>;</highlight></codeline>
<codeline lineno="458"><highlight class="normal"></highlight></codeline>
<codeline lineno="459"><highlight class="normal"><sp/><sp/><sp/><sp/>ofs<sp/>+=<sp/>PCP_MAP_SIZE;</highlight></codeline>
<codeline lineno="460"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(ofs<sp/>==<sp/>request.size());</highlight></codeline>
<codeline lineno="461"><highlight class="normal"></highlight></codeline>
<codeline lineno="462"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Receive<sp/>loop.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="463"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>is_natpmp<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="464"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>recv_res<sp/>=<sp/>PCPSendRecv(*sock,<sp/></highlight><highlight class="stringliteral">&quot;pcp&quot;</highlight><highlight class="normal">,<sp/>request,<sp/>num_tries,<sp/>timeout_per_try,</highlight></codeline>
<codeline lineno="465"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[&amp;](</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::span&lt;const<sp/>uint8_t&gt;<sp/>response)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="466"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Unsupported<sp/>version<sp/>according<sp/>to<sp/>RFC6887<sp/>appendix<sp/>A<sp/>and<sp/>RFC6886<sp/>section<sp/>3.5,<sp/>can<sp/>fall<sp/>back<sp/>to<sp/>NAT-PMP.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="467"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(response.size()<sp/>==<sp/>NATPMP_RESPONSE_HDR_SIZE<sp/>&amp;&amp;<sp/>response[PCP_HDR_VERSION_OFS]<sp/>==<sp/>NATPMP_VERSION<sp/>&amp;&amp;<sp/>response[PCP_RESPONSE_HDR_RESULT_OFS]<sp/>==<sp/>NATPMP_RESULT_UNSUPP_VERSION)<sp/>{</highlight></codeline>
<codeline lineno="468"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>is_natpmp<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="469"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>Let<sp/>it<sp/>through<sp/>to<sp/>caller.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="470"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="471"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(response.size()<sp/>&lt;<sp/>(PCP_HDR_SIZE<sp/>+<sp/>PCP_MAP_SIZE))<sp/>{</highlight></codeline>
<codeline lineno="472"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;pcp:<sp/>Response<sp/>too<sp/>small\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="473"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>Wasn&apos;t<sp/>response<sp/>to<sp/>what<sp/>we<sp/>expected,<sp/>try<sp/>receiving<sp/>next<sp/>packet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="474"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="475"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(response[PCP_HDR_VERSION_OFS]<sp/>!=<sp/>PCP_VERSION<sp/>||<sp/>response[PCP_HDR_OP_OFS]<sp/>!=<sp/>(PCP_RESPONSE<sp/>|<sp/>PCP_OP_MAP))<sp/>{</highlight></codeline>
<codeline lineno="476"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;pcp:<sp/>Response<sp/>to<sp/>wrong<sp/>command\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="477"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>Wasn&apos;t<sp/>response<sp/>to<sp/>what<sp/>we<sp/>expected,<sp/>try<sp/>receiving<sp/>next<sp/>packet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="478"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="479"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Handle<sp/>MAP<sp/>opcode<sp/>response.<sp/>See<sp/>RFC6887<sp/>Figure<sp/>10.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="480"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>that<sp/>returned<sp/>mapping<sp/>nonce<sp/>matches<sp/>our<sp/>request.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="481"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!std::ranges::equal(response.subspan(PCP_HDR_SIZE<sp/>+<sp/>PCP_MAP_NONCE_OFS,<sp/><ref refid="pcp_8h_1a85e8c19b124b5dee5fb8f43f8dcc0b75" kindref="member">PCP_MAP_NONCE_SIZE</ref>),<sp/><ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref>))<sp/>{</highlight></codeline>
<codeline lineno="482"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;pcp:<sp/>Mapping<sp/>nonce<sp/>mismatch\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="483"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>Wasn&apos;t<sp/>response<sp/>to<sp/>what<sp/>we<sp/>expected,<sp/>try<sp/>receiving<sp/>next<sp/>packet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="484"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="485"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint8_t<sp/>protocol<sp/>=<sp/>response[PCP_HDR_SIZE<sp/>+<sp/>12];</highlight></codeline>
<codeline lineno="486"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint16_t<sp/>internal_port<sp/>=<sp/><ref refid="crypto_2common_8h_1a776d823b1cdb3ba6f9c7966d16f7acf0" kindref="member">ReadBE16</ref>(response.data()<sp/>+<sp/>PCP_HDR_SIZE<sp/>+<sp/>16);</highlight></codeline>
<codeline lineno="487"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(protocol<sp/>!=<sp/>PCP_PROTOCOL_TCP<sp/>||<sp/>internal_port<sp/>!=<sp/>port)<sp/>{</highlight></codeline>
<codeline lineno="488"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;pcp:<sp/>Response<sp/>protocol<sp/>or<sp/>port<sp/>doesn&apos;t<sp/>match<sp/>request\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="489"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>Wasn&apos;t<sp/>response<sp/>to<sp/>what<sp/>we<sp/>expected,<sp/>try<sp/>receiving<sp/>next<sp/>packet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="491"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>},</highlight></codeline>
<codeline lineno="493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>interrupt);</highlight></codeline>
<codeline lineno="494"><highlight class="normal"></highlight></codeline>
<codeline lineno="495"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!recv_res)<sp/>{</highlight></codeline>
<codeline lineno="496"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a547ba52b62f9302ee1b6950111c36f9f" kindref="member">MappingError::NETWORK_ERROR</ref>;</highlight></codeline>
<codeline lineno="497"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="498"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(is_natpmp)<sp/>{</highlight></codeline>
<codeline lineno="499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a4c734943fdf497b8695362e2809a9121" kindref="member">MappingError::UNSUPP_VERSION</ref>;</highlight></codeline>
<codeline lineno="500"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="501"><highlight class="normal"></highlight></codeline>
<codeline lineno="502"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::span&lt;const<sp/>uint8_t&gt;<sp/>response<sp/>=<sp/>*recv_res;</highlight></codeline>
<codeline lineno="503"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>get<sp/>here,<sp/>we<sp/>got<sp/>a<sp/>valid<sp/>MAP<sp/>response<sp/>to<sp/>our<sp/>request.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="504"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>to<sp/>see<sp/>if<sp/>we<sp/>got<sp/>the<sp/>result<sp/>we<sp/>expected.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="505"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(response.size()<sp/>&gt;=<sp/>(PCP_HDR_SIZE<sp/>+<sp/>PCP_MAP_SIZE));</highlight></codeline>
<codeline lineno="506"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t<sp/>result_code<sp/>=<sp/>response[PCP_RESPONSE_HDR_RESULT_OFS];</highlight></codeline>
<codeline lineno="507"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>lifetime_ret<sp/>=<sp/><ref refid="crypto_2common_8h_1ae34e43528bdaaf18b35710e52ba493d5" kindref="member">ReadBE32</ref>(response.data()<sp/>+<sp/>PCP_HDR_LIFETIME_OFS);</highlight></codeline>
<codeline lineno="508"><highlight class="normal"><sp/><sp/><sp/><sp/>uint16_t<sp/>external_port<sp/>=<sp/><ref refid="crypto_2common_8h_1a776d823b1cdb3ba6f9c7966d16f7acf0" kindref="member">ReadBE16</ref>(response.data()<sp/>+<sp/>PCP_HDR_SIZE<sp/>+<sp/>PCP_MAP_EXTERNAL_PORT_OFS);</highlight></codeline>
<codeline lineno="509"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_net_addr" kindref="compound">CNetAddr</ref><sp/>external_addr{PCPUnwrapAddress(response.subspan(PCP_HDR_SIZE<sp/>+<sp/>PCP_MAP_EXTERNAL_IP_OFS,<sp/>ADDR_IPV6_SIZE))};</highlight></codeline>
<codeline lineno="510"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(result_code<sp/>!=<sp/>PCP_RESULT_SUCCESS)<sp/>{</highlight></codeline>
<codeline lineno="511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;pcp:<sp/>Mapping<sp/>failed<sp/>with<sp/>result<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>PCPResultString(result_code));</highlight></codeline>
<codeline lineno="512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(result_code<sp/>==<sp/>PCP_RESULT_NO_RESOURCES)<sp/>{</highlight></codeline>
<codeline lineno="513"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a3e052484eaaabf0d14b8c4b40267694f" kindref="member">MappingError::NO_RESOURCES</ref>;</highlight></codeline>
<codeline lineno="514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="515"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="pcp_8h_1aa28e34b90cecaa1b5630d1c12b6c8b24a23f149f0f9ae9ed9e0119e7209178a5d" kindref="member">MappingError::PROTOCOL_ERROR</ref>;</highlight></codeline>
<codeline lineno="516"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="517"><highlight class="normal"></highlight></codeline>
<codeline lineno="518"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_mapping_result" kindref="compound">MappingResult</ref>(PCP_VERSION,<sp/><ref refid="class_c_service" kindref="compound">CService</ref>(internal,<sp/>port),<sp/><ref refid="class_c_service" kindref="compound">CService</ref>(external_addr,<sp/>external_port),<sp/>lifetime_ret);</highlight></codeline>
<codeline lineno="519"><highlight class="normal">}</highlight></codeline>
<codeline lineno="520"><highlight class="normal"></highlight></codeline>
<codeline lineno="521"><highlight class="normal">std::string<sp/><ref refid="struct_mapping_result_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">MappingResult::ToString</ref>()</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="522"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="523"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(<ref refid="struct_mapping_result_1ab22abc2906422da61885ac6c8e6a1a59" kindref="member">version</ref><sp/>==<sp/>NATPMP_VERSION<sp/>||<sp/><ref refid="struct_mapping_result_1ab22abc2906422da61885ac6c8e6a1a59" kindref="member">version</ref><sp/>==<sp/>PCP_VERSION);</highlight></codeline>
<codeline lineno="524"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;%s:%s<sp/>-&gt;<sp/>%s<sp/>(for<sp/>%ds)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_mapping_result_1ab22abc2906422da61885ac6c8e6a1a59" kindref="member">version</ref><sp/>==<sp/>NATPMP_VERSION<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;natpmp&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;pcp&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="526"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_mapping_result_1a305c3b0eb5efa430eed7695c6e0c51a1" kindref="member">external</ref>.ToStringAddrPort(),</highlight></codeline>
<codeline lineno="527"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_mapping_result_1afd7dd8c23f65fc1ecb09aac7e7ae9ca0" kindref="member">internal</ref>.ToStringAddrPort(),</highlight></codeline>
<codeline lineno="528"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_mapping_result_1a569e06e92ec3d06c5ebf7f40d7f9a84e" kindref="member">lifetime</ref></highlight></codeline>
<codeline lineno="529"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="530"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="src/common/pcp.cpp"/>
  </compounddef>
</doxygen>
