<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.15.0" xml:lang="en-US">
  <compounddef id="validation_8cpp" kind="file" language="C++">
    <compoundname>validation.cpp</compoundname>
    <includes local="no">bitcoin-build-config.h</includes>
    <includes refid="validation_8h" local="no">validation.h</includes>
    <includes refid="arith__uint256_8h" local="no">arith_uint256.h</includes>
    <includes refid="chain_8h" local="no">chain.h</includes>
    <includes refid="checkqueue_8h" local="no">checkqueue.h</includes>
    <includes refid="clientversion_8h" local="no">clientversion.h</includes>
    <includes refid="amount_8h" local="no">consensus/amount.h</includes>
    <includes refid="consensus_8h" local="no">consensus/consensus.h</includes>
    <includes refid="merkle_8h" local="no">consensus/merkle.h</includes>
    <includes refid="tx__check_8h" local="no">consensus/tx_check.h</includes>
    <includes refid="tx__verify_8h" local="no">consensus/tx_verify.h</includes>
    <includes refid="consensus_2validation_8h" local="no">consensus/validation.h</includes>
    <includes refid="cuckoocache_8h" local="no">cuckoocache.h</includes>
    <includes refid="flatfile_8h" local="no">flatfile.h</includes>
    <includes refid="hash_8h" local="no">hash.h</includes>
    <includes refid="kernel_2chainparams_8h" local="no">kernel/chainparams.h</includes>
    <includes refid="coinstats_8h" local="no">kernel/coinstats.h</includes>
    <includes refid="disconnected__transactions_8h" local="no">kernel/disconnected_transactions.h</includes>
    <includes refid="mempool__entry_8h" local="no">kernel/mempool_entry.h</includes>
    <includes refid="messagestartchars_8h" local="no">kernel/messagestartchars.h</includes>
    <includes refid="notifications__interface_8h" local="no">kernel/notifications_interface.h</includes>
    <includes refid="kernel_2types_8h" local="no">kernel/types.h</includes>
    <includes refid="warning_8h" local="no">kernel/warning.h</includes>
    <includes refid="logging_8h" local="no">logging.h</includes>
    <includes refid="timer_8h" local="no">logging/timer.h</includes>
    <includes refid="blockstorage_8h" local="no">node/blockstorage.h</includes>
    <includes refid="utxo__snapshot_8h" local="no">node/utxo_snapshot.h</includes>
    <includes refid="ephemeral__policy_8h" local="no">policy/ephemeral_policy.h</includes>
    <includes refid="policy_8h" local="no">policy/policy.h</includes>
    <includes refid="policy_2rbf_8h" local="no">policy/rbf.h</includes>
    <includes refid="policy_2settings_8h" local="no">policy/settings.h</includes>
    <includes refid="truc__policy_8h" local="no">policy/truc_policy.h</includes>
    <includes refid="pow_8h" local="no">pow.h</includes>
    <includes refid="primitives_2block_8h" local="no">primitives/block.h</includes>
    <includes refid="primitives_2transaction_8h" local="no">primitives/transaction.h</includes>
    <includes refid="random_8h" local="no">random.h</includes>
    <includes refid="script_2script_8h" local="no">script/script.h</includes>
    <includes refid="sigcache_8h" local="no">script/sigcache.h</includes>
    <includes refid="signet_8h" local="no">signet.h</includes>
    <includes refid="tinyformat_8h" local="no">tinyformat.h</includes>
    <includes refid="txdb_8h" local="no">txdb.h</includes>
    <includes refid="txmempool_8h" local="no">txmempool.h</includes>
    <includes refid="uint256_8h" local="no">uint256.h</includes>
    <includes refid="undo_8h" local="no">undo.h</includes>
    <includes refid="check_8h" local="no">util/check.h</includes>
    <includes refid="fs_8h" local="no">util/fs.h</includes>
    <includes refid="fs__helpers_8h" local="no">util/fs_helpers.h</includes>
    <includes refid="hasher_8h" local="no">util/hasher.h</includes>
    <includes refid="moneystr_8h" local="no">util/moneystr.h</includes>
    <includes refid="util_2rbf_8h" local="no">util/rbf.h</includes>
    <includes refid="result_8h" local="no">util/result.h</includes>
    <includes refid="signalinterrupt_8h" local="no">util/signalinterrupt.h</includes>
    <includes refid="strencodings_8h" local="no">util/strencodings.h</includes>
    <includes refid="string_8h" local="no">util/string.h</includes>
    <includes refid="util_2time_8h" local="no">util/time.h</includes>
    <includes refid="trace_8h" local="no">util/trace.h</includes>
    <includes refid="translation_8h" local="no">util/translation.h</includes>
    <includes refid="validationinterface_8h" local="no">validationinterface.h</includes>
    <includes local="no">algorithm</includes>
    <includes local="no">cassert</includes>
    <includes local="no">chrono</includes>
    <includes local="no">deque</includes>
    <includes local="no">numeric</includes>
    <includes local="no">optional</includes>
    <includes local="no">ranges</includes>
    <includes local="no">span</includes>
    <includes local="no">string</includes>
    <includes local="no">tuple</includes>
    <includes local="no">utility</includes>
    <incdepgraph>
      <node id="4">
        <label>arith_uint256.h</label>
        <link refid="arith__uint256_8h"/>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="11">
        <label>attributes.h</label>
        <link refid="attributes_8h"/>
      </node>
      <node id="12">
        <label>chain.h</label>
        <link refid="chain_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="58" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="76" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="77">
        <label>checkqueue.h</label>
        <link refid="checkqueue_8h"/>
        <childnode refid="78" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="51" relation="include">
        </childnode>
        <childnode refid="86" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="46" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="155">
        <label>clientversion.h</label>
        <link refid="clientversion_8h"/>
        <childnode refid="62" relation="include">
        </childnode>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="117">
        <label>coins.h</label>
        <link refid="coins_8h"/>
        <childnode refid="118" relation="include">
        </childnode>
        <childnode refid="119" relation="include">
        </childnode>
        <childnode refid="120" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="122" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="84" relation="include">
        </childnode>
      </node>
      <node id="43">
        <label>compat/assumptions.h</label>
        <link refid="compat_2assumptions_8h"/>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
      </node>
      <node id="18">
        <label>compat/byteswap.h</label>
        <link refid="byteswap_8h"/>
        <childnode refid="6" relation="include">
        </childnode>
      </node>
      <node id="17">
        <label>compat/endian.h</label>
        <link refid="endian_8h"/>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
      </node>
      <node id="118">
        <label>compressor.h</label>
        <link refid="compressor_8h"/>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="72" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
      </node>
      <node id="67">
        <label>consensus/amount.h</label>
        <link refid="amount_8h"/>
        <childnode refid="6" relation="include">
        </childnode>
      </node>
      <node id="134">
        <label>consensus/consensus.h</label>
        <link refid="consensus_8h"/>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
      </node>
      <node id="156">
        <label>consensus/merkle.h</label>
        <link refid="merkle_8h"/>
        <childnode refid="34" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
      </node>
      <node id="13">
        <label>consensus/params.h</label>
        <link refid="params_8h"/>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="157">
        <label>consensus/tx_check.h</label>
        <link refid="tx__check_8h"/>
      </node>
      <node id="158">
        <label>consensus/tx_verify.h</label>
        <link refid="tx__verify_8h"/>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="135">
        <label>consensus/validation.h</label>
        <link refid="consensus_2validation_8h"/>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="134" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
      </node>
      <node id="119">
        <label>core_memusage.h</label>
        <link refid="core__memusage_8h"/>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="120" relation="include">
        </childnode>
      </node>
      <node id="175">
        <label>crypto/chacha20.h</label>
        <link refid="chacha20_8h"/>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="46" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
      </node>
      <node id="16">
        <label>crypto/common.h</label>
        <link refid="crypto_2common_8h"/>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
      </node>
      <node id="28">
        <label>crypto/hex_base.h</label>
        <link refid="hex__base_8h"/>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="162">
        <label>crypto/muhash.h</label>
        <link refid="muhash_8h"/>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
      </node>
      <node id="160">
        <label>crypto/ripemd160.h</label>
        <link refid="ripemd160_8h"/>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
      </node>
      <node id="110">
        <label>crypto/sha256.h</label>
        <link refid="sha256_8h"/>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="79">
        <label>crypto/siphash.h</label>
        <link refid="siphash_8h"/>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
      </node>
      <node id="87">
        <label>cuckoocache.h</label>
        <link refid="cuckoocache_8h"/>
        <childnode refid="88" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="81" relation="include">
        </childnode>
        <childnode refid="89" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="100">
        <label>dbwrapper.h</label>
        <link refid="dbwrapper_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="101" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="90">
        <label>deploymentstatus.h</label>
        <link refid="deploymentstatus_8h"/>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="91" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
      </node>
      <node id="41">
        <label>flatfile.h</label>
        <link refid="flatfile_8h"/>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
      </node>
      <node id="159">
        <label>hash.h</label>
        <link refid="hash_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="160" relation="include">
        </childnode>
        <childnode refid="110" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="121">
        <label>indirectmap.h</label>
        <link refid="indirectmap_8h"/>
        <childnode refid="40" relation="include">
        </childnode>
      </node>
      <node id="128">
        <label>kernel/blockmanager_opts.h</label>
        <link refid="blockmanager__opts_8h"/>
        <childnode refid="100" relation="include">
        </childnode>
        <childnode refid="99" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
      </node>
      <node id="124">
        <label>kernel/caches.h</label>
        <link refid="kernel_2caches_8h"/>
        <childnode refid="125" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
      </node>
      <node id="92">
        <label>kernel/chain.h</label>
        <link refid="kernel_2chain_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="52" relation="include">
        </childnode>
      </node>
      <node id="93">
        <label>kernel/chainparams.h</label>
        <link refid="kernel_2chainparams_8h"/>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="94" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="95" relation="include">
        </childnode>
        <childnode refid="73" relation="include">
        </childnode>
        <childnode refid="96" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="46" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="84" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="98">
        <label>kernel/chainstatemanager_opts.h</label>
        <link refid="chainstatemanager__opts_8h"/>
        <childnode refid="99" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="100" relation="include">
        </childnode>
        <childnode refid="109" relation="include">
        </childnode>
        <childnode refid="116" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="75" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
      </node>
      <node id="161">
        <label>kernel/coinstats.h</label>
        <link refid="coinstats_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="162" relation="include">
        </childnode>
        <childnode refid="101" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
      </node>
      <node id="58">
        <label>kernel/cs_main.h</label>
        <link refid="cs__main_8h"/>
        <childnode refid="59" relation="include">
        </childnode>
      </node>
      <node id="163">
        <label>kernel/disconnected_transactions.h</label>
        <link refid="disconnected__transactions_8h"/>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="83" relation="include">
        </childnode>
        <childnode refid="84" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="139">
        <label>kernel/mempool_entry.h</label>
        <link refid="mempool__entry_8h"/>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="135" relation="include">
        </childnode>
        <childnode refid="119" relation="include">
        </childnode>
        <childnode refid="136" relation="include">
        </childnode>
        <childnode refid="140" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="141" relation="include">
        </childnode>
        <childnode refid="142" relation="include">
        </childnode>
        <childnode refid="106" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
      </node>
      <node id="143">
        <label>kernel/mempool_limits.h</label>
        <link refid="mempool__limits_8h"/>
        <childnode refid="136" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
      </node>
      <node id="144">
        <label>kernel/mempool_options.h</label>
        <link refid="mempool__options_8h"/>
        <childnode refid="143" relation="include">
        </childnode>
        <childnode refid="131" relation="include">
        </childnode>
        <childnode refid="136" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
      </node>
      <node id="145">
        <label>kernel/mempool_removal_reason.h</label>
        <link refid="mempool__removal__reason_8h"/>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="94">
        <label>kernel/messagestartchars.h</label>
        <link refid="messagestartchars_8h"/>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
      </node>
      <node id="99">
        <label>kernel/notifications_interface.h</label>
        <link refid="notifications__interface_8h"/>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="71" relation="include">
        </childnode>
      </node>
      <node id="164">
        <label>kernel/types.h</label>
        <link refid="kernel_2types_8h"/>
      </node>
      <node id="165">
        <label>kernel/warning.h</label>
        <link refid="warning_8h"/>
      </node>
      <node id="78">
        <label>logging.h</label>
        <link refid="logging_8h"/>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="60" relation="include">
        </childnode>
        <childnode refid="51" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="76" relation="include">
        </childnode>
        <childnode refid="81" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="83" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="61" relation="include">
        </childnode>
        <childnode refid="82" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="84" relation="include">
        </childnode>
        <childnode refid="85" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="166">
        <label>logging/timer.h</label>
        <link refid="timer_8h"/>
        <childnode refid="167" relation="include">
        </childnode>
        <childnode refid="62" relation="include">
        </childnode>
        <childnode refid="75" relation="include">
        </childnode>
        <childnode refid="69" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="120">
        <label>memusage.h</label>
        <link refid="memusage_8h"/>
        <childnode refid="121" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="122" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="83" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
        <childnode refid="84" relation="include">
        </childnode>
        <childnode refid="85" relation="include">
        </childnode>
      </node>
      <node id="126">
        <label>node/blockstorage.h</label>
        <link refid="blockstorage_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="127" relation="include">
        </childnode>
        <childnode refid="100" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="128" relation="include">
        </childnode>
        <childnode refid="93" relation="include">
        </childnode>
        <childnode refid="58" relation="include">
        </childnode>
        <childnode refid="94" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="101" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="129" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="104" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="81" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="130" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="84" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="168">
        <label>node/utxo_snapshot.h</label>
        <link refid="utxo__snapshot_8h"/>
        <childnode refid="93" relation="include">
        </childnode>
        <childnode refid="58" relation="include">
        </childnode>
        <childnode refid="94" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="51" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="95" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
      </node>
      <node id="169">
        <label>policy/ephemeral_policy.h</label>
        <link refid="ephemeral__policy_8h"/>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="133" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
      </node>
      <node id="131">
        <label>policy/feerate.h</label>
        <link refid="feerate_8h"/>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="132" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
      </node>
      <node id="133">
        <label>policy/packages.h</label>
        <link refid="packages_8h"/>
        <childnode refid="134" relation="include">
        </childnode>
        <childnode refid="135" relation="include">
        </childnode>
        <childnode refid="136" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="85" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="136">
        <label>policy/policy.h</label>
        <link refid="policy_8h"/>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="134" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="111" relation="include">
        </childnode>
        <childnode refid="137" relation="include">
        </childnode>
        <childnode refid="132" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="170">
        <label>policy/rbf.h</label>
        <link refid="policy_2rbf_8h"/>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="60" relation="include">
        </childnode>
        <childnode refid="171" relation="include">
        </childnode>
        <childnode refid="132" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="140">
        <label>policy/settings.h</label>
        <link refid="policy_2settings_8h"/>
      </node>
      <node id="172">
        <label>policy/truc_policy.h</label>
        <link refid="truc__policy_8h"/>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="133" relation="include">
        </childnode>
        <childnode refid="136" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="171" relation="include">
        </childnode>
        <childnode refid="146" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="173">
        <label>pow.h</label>
        <link refid="pow_8h"/>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
      </node>
      <node id="44">
        <label>prevector.h</label>
        <link refid="prevector_8h"/>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="46" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
      </node>
      <node id="65">
        <label>primitives/block.h</label>
        <link refid="primitives_2block_8h"/>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="75" relation="include">
        </childnode>
      </node>
      <node id="66">
        <label>primitives/transaction.h</label>
        <link refid="primitives_2transaction_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="72" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="74" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="70" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="68">
        <label>primitives/transaction_identifier.h</label>
        <link refid="transaction__identifier_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="69" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="70" relation="include">
        </childnode>
        <childnode refid="71" relation="include">
        </childnode>
      </node>
      <node id="174">
        <label>random.h</label>
        <link refid="random_8h"/>
        <childnode refid="175" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="111">
        <label>script/interpreter.h</label>
        <link refid="interpreter_8h"/>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="112" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="113" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="72">
        <label>script/script.h</label>
        <link refid="script_2script_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="73" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="113">
        <label>script/script_error.h</label>
        <link refid="script__error_8h"/>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="109">
        <label>script/sigcache.h</label>
        <link refid="sigcache_8h"/>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="110" relation="include">
        </childnode>
        <childnode refid="87" relation="include">
        </childnode>
        <childnode refid="111" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="115" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="137">
        <label>script/solver.h</label>
        <link refid="solver_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="72" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="14">
        <label>script/verify_flags.h</label>
        <link refid="verify__flags_8h"/>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
      </node>
      <node id="42">
        <label>serialize.h</label>
        <link refid="serialize_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="176">
        <label>signet.h</label>
        <link refid="signet_8h"/>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
      </node>
      <node id="22">
        <label>span.h</label>
        <link refid="span_8h"/>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
      </node>
      <node id="101">
        <label>streams.h</label>
        <link refid="streams_8h"/>
        <childnode refid="78" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="102" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
        <childnode refid="104" relation="include">
        </childnode>
        <childnode refid="106" relation="include">
        </childnode>
        <childnode refid="107" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="53" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="122">
        <label>support/allocators/pool.h</label>
        <link refid="pool_8h"/>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="83" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="123" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
      </node>
      <node id="102">
        <label>support/allocators/zeroafterfree.h</label>
        <link refid="zeroafterfree_8h"/>
        <childnode refid="103" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="103">
        <label>support/cleanse.h</label>
        <link refid="cleanse_8h"/>
        <childnode refid="45" relation="include">
        </childnode>
      </node>
      <node id="59">
        <label>sync.h</label>
        <link refid="sync_8h"/>
        <childnode refid="60" relation="include">
        </childnode>
        <childnode refid="62" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="63" relation="include">
        </childnode>
        <childnode refid="61" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="64" relation="include">
        </childnode>
      </node>
      <node id="60">
        <label>threadsafety.h</label>
        <link refid="threadsafety_8h"/>
        <childnode refid="61" relation="include">
        </childnode>
      </node>
      <node id="51">
        <label>tinyformat.h</label>
        <link refid="tinyformat_8h"/>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="52" relation="include">
        </childnode>
        <childnode refid="32" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
      </node>
      <node id="116">
        <label>txdb.h</label>
        <link refid="txdb_8h"/>
        <childnode refid="117" relation="include">
        </childnode>
        <childnode refid="100" relation="include">
        </childnode>
        <childnode refid="124" relation="include">
        </childnode>
        <childnode refid="58" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="141">
        <label>txgraph.h</label>
        <link refid="txgraph_8h"/>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
        <childnode refid="132" relation="include">
        </childnode>
      </node>
      <node id="138">
        <label>txmempool.h</label>
        <link refid="txmempool_8h"/>
        <childnode refid="117" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="121" relation="include">
        </childnode>
        <childnode refid="58" relation="include">
        </childnode>
        <childnode refid="139" relation="include">
        </childnode>
        <childnode refid="143" relation="include">
        </childnode>
        <childnode refid="144" relation="include">
        </childnode>
        <childnode refid="145" relation="include">
        </childnode>
        <childnode refid="131" relation="include">
        </childnode>
        <childnode refid="133" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="141" relation="include">
        </childnode>
        <childnode refid="142" relation="include">
        </childnode>
        <childnode refid="132" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="146" relation="include">
        </childnode>
        <childnode refid="148" relation="include">
        </childnode>
        <childnode refid="149" relation="include">
        </childnode>
        <childnode refid="150" relation="include">
        </childnode>
        <childnode refid="151" relation="include">
        </childnode>
        <childnode refid="152" relation="include">
        </childnode>
        <childnode refid="153" relation="include">
        </childnode>
        <childnode refid="154" relation="include">
        </childnode>
        <childnode refid="81" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="15">
        <label>uint256.h</label>
        <link refid="uint256_8h"/>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
      </node>
      <node id="177">
        <label>undo.h</label>
        <link refid="undo_8h"/>
        <childnode refid="117" relation="include">
        </childnode>
        <childnode refid="118" relation="include">
        </childnode>
        <childnode refid="134" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
      </node>
      <node id="125">
        <label>util/byte_units.h</label>
        <link refid="byte__units_8h"/>
        <childnode refid="106" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
      </node>
      <node id="95">
        <label>util/chaintype.h</label>
        <link refid="chaintype_8h"/>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="80">
        <label>util/check.h</label>
        <link refid="check_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="81" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="82" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
      </node>
      <node id="142">
        <label>util/epochguard.h</label>
        <link refid="epochguard_8h"/>
        <childnode refid="60" relation="include">
        </childnode>
        <childnode refid="62" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
      </node>
      <node id="129">
        <label>util/expected.h</label>
        <link refid="expected_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="71" relation="include">
        </childnode>
      </node>
      <node id="88">
        <label>util/fastrange.h</label>
        <link refid="fastrange_8h"/>
        <childnode refid="6" relation="include">
        </childnode>
      </node>
      <node id="132">
        <label>util/feefrac.h</label>
        <link refid="feefrac_8h"/>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="50">
        <label>util/fs.h</label>
        <link refid="fs_8h"/>
        <childnode refid="51" relation="include">
        </childnode>
        <childnode refid="53" relation="include">
        </childnode>
        <childnode refid="54" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="56" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="37" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
      </node>
      <node id="178">
        <label>util/fs_helpers.h</label>
        <link refid="fs__helpers_8h"/>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="53" relation="include">
        </childnode>
        <childnode refid="130" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
      </node>
      <node id="73">
        <label>util/hash_type.h</label>
        <link refid="hash__type_8h"/>
      </node>
      <node id="114">
        <label>util/hasher.h</label>
        <link refid="hasher_8h"/>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
      </node>
      <node id="62">
        <label>util/macros.h</label>
        <link refid="macros_8h"/>
      </node>
      <node id="179">
        <label>util/moneystr.h</label>
        <link refid="moneystr_8h"/>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="104">
        <label>util/obfuscation.h</label>
        <link refid="obfuscation_8h"/>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="51" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="105" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
      </node>
      <node id="106">
        <label>util/overflow.h</label>
        <link refid="overflow_8h"/>
        <childnode refid="105" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
      </node>
      <node id="180">
        <label>util/rbf.h</label>
        <link refid="util_2rbf_8h"/>
        <childnode refid="6" relation="include">
        </childnode>
      </node>
      <node id="146">
        <label>util/result.h</label>
        <link refid="result_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="147" relation="include">
        </childnode>
        <childnode refid="71" relation="include">
        </childnode>
      </node>
      <node id="181">
        <label>util/signalinterrupt.h</label>
        <link refid="signalinterrupt_8h"/>
        <childnode refid="182" relation="include">
        </childnode>
        <childnode refid="81" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
      </node>
      <node id="27">
        <label>util/strencodings.h</label>
        <link refid="strencodings_8h"/>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="37" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="29">
        <label>util/string.h</label>
        <link refid="string_8h"/>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="31" relation="include">
        </childnode>
        <childnode refid="32" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="107">
        <label>util/syserror.h</label>
        <link refid="syserror_8h"/>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="86">
        <label>util/threadnames.h</label>
        <link refid="threadnames_8h"/>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="76">
        <label>util/time.h</label>
        <link refid="util_2time_8h"/>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
      </node>
      <node id="182">
        <label>util/tokenpipe.h</label>
        <link refid="tokenpipe_8h"/>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
      </node>
      <node id="183">
        <label>util/trace.h</label>
        <link refid="trace_8h"/>
        <childnode refid="2" relation="include">
        </childnode>
      </node>
      <node id="147">
        <label>util/translation.h</label>
        <link refid="translation_8h"/>
        <childnode refid="51" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="69">
        <label>util/types.h</label>
        <link refid="util_2types_8h"/>
      </node>
      <node id="96">
        <label>util/vector.h</label>
        <link refid="vector_8h"/>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="97" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="1">
        <label>src/validation.cpp</label>
        <link refid="validation_8cpp"/>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="77" relation="include">
        </childnode>
        <childnode refid="155" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="134" relation="include">
        </childnode>
        <childnode refid="156" relation="include">
        </childnode>
        <childnode refid="157" relation="include">
        </childnode>
        <childnode refid="158" relation="include">
        </childnode>
        <childnode refid="135" relation="include">
        </childnode>
        <childnode refid="87" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="159" relation="include">
        </childnode>
        <childnode refid="93" relation="include">
        </childnode>
        <childnode refid="161" relation="include">
        </childnode>
        <childnode refid="163" relation="include">
        </childnode>
        <childnode refid="139" relation="include">
        </childnode>
        <childnode refid="94" relation="include">
        </childnode>
        <childnode refid="99" relation="include">
        </childnode>
        <childnode refid="164" relation="include">
        </childnode>
        <childnode refid="165" relation="include">
        </childnode>
        <childnode refid="78" relation="include">
        </childnode>
        <childnode refid="166" relation="include">
        </childnode>
        <childnode refid="126" relation="include">
        </childnode>
        <childnode refid="168" relation="include">
        </childnode>
        <childnode refid="169" relation="include">
        </childnode>
        <childnode refid="136" relation="include">
        </childnode>
        <childnode refid="170" relation="include">
        </childnode>
        <childnode refid="140" relation="include">
        </childnode>
        <childnode refid="172" relation="include">
        </childnode>
        <childnode refid="173" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="174" relation="include">
        </childnode>
        <childnode refid="72" relation="include">
        </childnode>
        <childnode refid="109" relation="include">
        </childnode>
        <childnode refid="176" relation="include">
        </childnode>
        <childnode refid="51" relation="include">
        </childnode>
        <childnode refid="116" relation="include">
        </childnode>
        <childnode refid="138" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="177" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="178" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="179" relation="include">
        </childnode>
        <childnode refid="180" relation="include">
        </childnode>
        <childnode refid="146" relation="include">
        </childnode>
        <childnode refid="181" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="76" relation="include">
        </childnode>
        <childnode refid="183" relation="include">
        </childnode>
        <childnode refid="147" relation="include">
        </childnode>
        <childnode refid="184" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="185" relation="include">
        </childnode>
        <childnode refid="74" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="186" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="70" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
      </node>
      <node id="3">
        <label>validation.h</label>
        <link refid="validation_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="77" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="87" relation="include">
        </childnode>
        <childnode refid="90" relation="include">
        </childnode>
        <childnode refid="92" relation="include">
        </childnode>
        <childnode refid="93" relation="include">
        </childnode>
        <childnode refid="98" relation="include">
        </childnode>
        <childnode refid="58" relation="include">
        </childnode>
        <childnode refid="126" relation="include">
        </childnode>
        <childnode refid="131" relation="include">
        </childnode>
        <childnode refid="133" relation="include">
        </childnode>
        <childnode refid="136" relation="include">
        </childnode>
        <childnode refid="113" relation="include">
        </childnode>
        <childnode refid="109" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="116" relation="include">
        </childnode>
        <childnode refid="138" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="125" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="146" relation="include">
        </childnode>
        <childnode refid="76" relation="include">
        </childnode>
        <childnode refid="147" relation="include">
        </childnode>
        <childnode refid="91" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="81" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="184">
        <label>validationinterface.h</label>
        <link refid="validationinterface_8h"/>
        <childnode refid="58" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="91">
        <label>versionbits.h</label>
        <link refid="versionbits_8h"/>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="38">
        <label>algorithm</label>
      </node>
      <node id="30">
        <label>array</label>
      </node>
      <node id="81">
        <label>atomic</label>
      </node>
      <node id="19">
        <label>bit</label>
      </node>
      <node id="2">
        <label>bitcoin-build-config.h</label>
      </node>
      <node id="148">
        <label>boost/multi_index/hashed_index.hpp</label>
      </node>
      <node id="149">
        <label>boost/multi_index/identity.hpp</label>
      </node>
      <node id="150">
        <label>boost/multi_index/indexed_by.hpp</label>
      </node>
      <node id="151">
        <label>boost/multi_index/ordered_index.hpp</label>
      </node>
      <node id="152">
        <label>boost/multi_index/sequenced_index.hpp</label>
      </node>
      <node id="153">
        <label>boost/multi_index/tag.hpp</label>
      </node>
      <node id="154">
        <label>boost/multi_index_container.hpp</label>
      </node>
      <node id="23">
        <label>cassert</label>
      </node>
      <node id="127">
        <label>chain.h</label>
      </node>
      <node id="35">
        <label>charconv</label>
      </node>
      <node id="39">
        <label>chrono</label>
      </node>
      <node id="105">
        <label>climits</label>
      </node>
      <node id="89">
        <label>cmath</label>
      </node>
      <node id="5">
        <label>compare</label>
      </node>
      <node id="20">
        <label>concepts</label>
      </node>
      <node id="63">
        <label>condition_variable</label>
      </node>
      <node id="21">
        <label>cstddef</label>
      </node>
      <node id="6">
        <label>cstdint</label>
      </node>
      <node id="53">
        <label>cstdio</label>
      </node>
      <node id="45">
        <label>cstdlib</label>
      </node>
      <node id="7">
        <label>cstring</label>
      </node>
      <node id="185">
        <label>deque</label>
      </node>
      <node id="108">
        <label>exception</label>
      </node>
      <node id="54">
        <label>filesystem</label>
      </node>
      <node id="55">
        <label>functional</label>
      </node>
      <node id="112">
        <label>hash.h</label>
      </node>
      <node id="97">
        <label>initializer_list</label>
      </node>
      <node id="56">
        <label>iomanip</label>
      </node>
      <node id="47">
        <label>ios</label>
      </node>
      <node id="130">
        <label>iosfwd</label>
      </node>
      <node id="52">
        <label>iostream</label>
      </node>
      <node id="46">
        <label>iterator</label>
      </node>
      <node id="8">
        <label>limits</label>
      </node>
      <node id="83">
        <label>list</label>
      </node>
      <node id="31">
        <label>locale</label>
      </node>
      <node id="167">
        <label>logging.h</label>
      </node>
      <node id="40">
        <label>map</label>
      </node>
      <node id="48">
        <label>memory</label>
      </node>
      <node id="61">
        <label>mutex</label>
      </node>
      <node id="123">
        <label>new</label>
      </node>
      <node id="74">
        <label>numeric</label>
      </node>
      <node id="36">
        <label>optional</label>
      </node>
      <node id="57">
        <label>ostream</label>
      </node>
      <node id="186">
        <label>ranges</label>
      </node>
      <node id="49">
        <label>set</label>
      </node>
      <node id="115">
        <label>shared_mutex</label>
      </node>
      <node id="82">
        <label>source_location</label>
      </node>
      <node id="24">
        <label>span</label>
      </node>
      <node id="32">
        <label>sstream</label>
      </node>
      <node id="9">
        <label>stdexcept</label>
      </node>
      <node id="10">
        <label>string</label>
      </node>
      <node id="33">
        <label>string_view</label>
      </node>
      <node id="37">
        <label>system_error</label>
      </node>
      <node id="64">
        <label>thread</label>
      </node>
      <node id="70">
        <label>tuple</label>
      </node>
      <node id="171">
        <label>txmempool.h</label>
      </node>
      <node id="25">
        <label>type_traits</label>
      </node>
      <node id="84">
        <label>unordered_map</label>
      </node>
      <node id="85">
        <label>unordered_set</label>
      </node>
      <node id="75">
        <label>util/time.h</label>
      </node>
      <node id="26">
        <label>utility</label>
      </node>
      <node id="71">
        <label>variant</label>
      </node>
      <node id="34">
        <label>vector</label>
      </node>
    </incdepgraph>
    <innerclass refid="struct_per_block_connect_trace" prot="public">PerBlockConnectTrace</innerclass>
    <innerclass refid="class_connect_trace" prot="public">ConnectTrace</innerclass>
    <innerclass refid="struct_stop_hashing_exception" prot="public">StopHashingException</innerclass>
    <innerclass refid="class_notifications" prot="public">Notifications</innerclass>
    <innerclass refid="struct_c_block_index_height_only_comparator" prot="public">CBlockIndexHeightOnlyComparator</innerclass>
    <innerclass refid="struct_c_block_index_work_comparator" prot="public">CBlockIndexWorkComparator</innerclass>
    <sectiondef kind="var">
      <memberdef kind="variable" id="validation_8cpp_1a37b311e235bd494a3d9b9cae423b8c3f" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>size_t</type>
        <definition>size_t WARN_FLUSH_COINS_SIZE</definition>
        <argsstring></argsstring>
        <name>WARN_FLUSH_COINS_SIZE</name>
        <initializer>= 1 &lt;&lt; 30</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Size threshold for warning about slow UTXO set flush to disk. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="93" column="25" bodyfile="src/validation.cpp" bodystart="93" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="validation_8cpp_1abe2455b9980d3453f26514b98b843d89" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto DATABASE_WRITE_INTERVAL_MIN</definition>
        <argsstring></argsstring>
        <name>DATABASE_WRITE_INTERVAL_MIN</name>
        <initializer>{50min}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Time window to wait between writing blocks/block index and chainstate to disk. Randomize writing time inside the window to prevent a situation where the network over time settles into a few cohorts of synchronized writers. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="98" column="23" bodyfile="src/validation.cpp" bodystart="98" bodyend="98"/>
      </memberdef>
      <memberdef kind="variable" id="validation_8cpp_1a7405d3c5cd5f21b8e2258569c2621ba1" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto DATABASE_WRITE_INTERVAL_MAX</definition>
        <argsstring></argsstring>
        <name>DATABASE_WRITE_INTERVAL_MAX</name>
        <initializer>{70min}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="99" column="23" bodyfile="src/validation.cpp" bodystart="99" bodyend="99"/>
      </memberdef>
      <memberdef kind="variable" id="validation_8cpp_1aac72b3c736052714b838493e13a37317" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>std::chrono::hours</type>
        <definition>std::chrono::hours MAX_FEE_ESTIMATION_TIP_AGE</definition>
        <argsstring></argsstring>
        <name>MAX_FEE_ESTIMATION_TIP_AGE</name>
        <initializer>{3}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Maximum age of our tip for us to be considered current for fee estimation </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="101" column="37" bodyfile="src/validation.cpp" bodystart="101" bodyend="101"/>
      </memberdef>
      <memberdef kind="variable" id="validation_8cpp_1aa6bf79aa2e37d5ce26771d5af135cf51" prot="public" static="no" mutable="no">
        <type>const std::vector&lt; std::string &gt;</type>
        <definition>const std::vector&lt;std::string&gt; CHECKLEVEL_DOC</definition>
        <argsstring></argsstring>
        <name>CHECKLEVEL_DOC</name>
        <initializer>{
    &quot;level 0 reads the blocks from disk&quot;,
    &quot;level 1 verifies block validity&quot;,
    &quot;level 2 verifies undo data&quot;,
    &quot;level 3 checks disconnection of tip blocks&quot;,
    &quot;level 4 tries to reconnect the blocks&quot;,
    &quot;each level includes the checks of the previous levels&quot;,
}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Documentation for argument &apos;checklevel&apos;. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="102" column="19" bodyfile="src/validation.cpp" bodystart="102" bodyend="109"/>
      </memberdef>
      <memberdef kind="variable" id="validation_8cpp_1a7d98929d8740756bbb825d22b2c5c2d1" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>int</type>
        <definition>int PRUNE_LOCK_BUFFER</definition>
        <argsstring></argsstring>
        <name>PRUNE_LOCK_BUFFER</name>
        <initializer>{10}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>The number of blocks to keep below the deepest prune lock. There is nothing special about this number. It is higher than what we expect to see in regular mainnet reorgs, but not so high that it would noticeably interfere with the pruning mechanism. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="115" column="22" bodyfile="src/validation.cpp" bodystart="115" bodyend="115"/>
      </memberdef>
      <memberdef kind="variable" id="validation_8cpp_1a24f5ac7f44949e51d88ed714f978baa8" prot="public" static="no" mutable="no">
        <type>bool pool</type>
        <definition>bool pool cs</definition>
        <argsstring></argsstring>
        <name>cs</name>
        <initializer>{
    <ref refid="validation_8cpp_1abee2920f50f82cc5721ae2cd3f1c4f95" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>)</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="401" column="22" bodyfile="src/validation.cpp" bodystart="402" bodyend="-1"/>
      </memberdef>
    </sectiondef>
    <sectiondef kind="func">
      <memberdef kind="function" id="validation_8cpp_1af4f26ad2a7c3b4428d86f2800747941e" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>TRACEPOINT_SEMAPHORE</definition>
        <argsstring>(validation, block_connected)</argsstring>
        <name>TRACEPOINT_SEMAPHORE</name>
        <param>
          <type>validation</type>
        </param>
        <param>
          <type>block_connected</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="117" column="1" declfile="src/validation.cpp" declline="117" declcolumn="1"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1ab3fb81a955a4a81d5d1810945c417656" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>TRACEPOINT_SEMAPHORE</definition>
        <argsstring>(utxocache, flush)</argsstring>
        <name>TRACEPOINT_SEMAPHORE</name>
        <param>
          <type>utxocache</type>
        </param>
        <param>
          <type>flush</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="118" column="1" declfile="src/validation.cpp" declline="118" declcolumn="1"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1ad55d6e305372171ae8b4b559b4840db5" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>TRACEPOINT_SEMAPHORE</definition>
        <argsstring>(mempool, replaced)</argsstring>
        <name>TRACEPOINT_SEMAPHORE</name>
        <param>
          <type>mempool</type>
        </param>
        <param>
          <type>replaced</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="119" column="1" declfile="src/validation.cpp" declline="119" declcolumn="1"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1af2678f331b1bf35b16d3b3df42230b85" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>TRACEPOINT_SEMAPHORE</definition>
        <argsstring>(mempool, rejected)</argsstring>
        <name>TRACEPOINT_SEMAPHORE</name>
        <param>
          <type>mempool</type>
        </param>
        <param>
          <type>rejected</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="120" column="1" declfile="src/validation.cpp" declline="120" declcolumn="1"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1af9f454ea56c86078990a64f3fe8e72e2" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool CheckInputScripts</definition>
        <argsstring>(const CTransaction &amp;tx, TxValidationState &amp;state, const CCoinsViewCache &amp;inputs, script_verify_flags flags, bool cacheSigStore, bool cacheFullScriptStore, PrecomputedTransactionData &amp;txdata, ValidationCache &amp;validation_cache, std::vector&lt; CScriptCheck &gt; *pvChecks=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main)</argsstring>
        <name>CheckInputScripts</name>
        <param>
          <type>const <ref refid="class_c_transaction" kindref="compound">CTransaction</ref> &amp;</type>
          <declname>tx</declname>
        </param>
        <param>
          <type><ref refid="class_tx_validation_state" kindref="compound">TxValidationState</ref> &amp;</type>
          <declname>state</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref> &amp;</type>
          <declname>inputs</declname>
        </param>
        <param>
          <type><ref refid="classscript__verify__flags" kindref="compound">script_verify_flags</ref></type>
          <declname>flags</declname>
        </param>
        <param>
          <type>bool</type>
          <declname>cacheSigStore</declname>
        </param>
        <param>
          <type>bool</type>
          <declname>cacheFullScriptStore</declname>
        </param>
        <param>
          <type><ref refid="struct_precomputed_transaction_data" kindref="compound">PrecomputedTransactionData</ref> &amp;</type>
          <declname>txdata</declname>
        </param>
        <param>
          <type><ref refid="class_validation_cache" kindref="compound">ValidationCache</ref> &amp;</type>
          <declname>validation_cache</declname>
        </param>
        <param>
          <type>std::vector&lt; <ref refid="class_c_script_check" kindref="compound">CScriptCheck</ref> &gt; *</type>
          <declname>pvChecks</declname>
          <defval>nullptr</defval>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Check whether all of this transaction&apos;s input scripts succeed.</para>
<para>This involves ECDSA signature checks so can be computationally intensive. This function should only be called after the cheap sanity checks in CheckTxInputs passed.</para>
<para>If pvChecks is not nullptr, script checks are pushed onto it instead of being performed inline. Any script checks which are not necessary (eg due to script execution cache hits) are, obviously, not pushed onto pvChecks/run.</para>
<para>Setting cacheSigStore/cacheFullScriptStore to false will remove elements from the corresponding cache which are matched. This is useful for checking blocks where we will likely never need the cache entry again.</para>
<para>Note that we may set state.reason to NOT_STANDARD for extra soft-fork flags in flags, block-checking callers should probably reset it to CONSENSUS in such cases.</para>
<para>Non-static (and redeclared) in <ref refid="txvalidationcache__tests_8cpp" kindref="compound">src/test/txvalidationcache_tests.cpp</ref> </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="2102" column="6" bodyfile="src/validation.cpp" bodystart="2102" bodyend="2175" declfile="src/validation.cpp" declline="142" declcolumn="6"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a3b90ca0d639cfea2208c7c0aa5118aaa" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool CheckFinalTxAtTip</definition>
        <argsstring>(const CBlockIndex &amp;active_chain_tip, const CTransaction &amp;tx)</argsstring>
        <name>CheckFinalTxAtTip</name>
        <param>
          <type>const <ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref> &amp;</type>
          <declname>active_chain_tip</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_transaction" kindref="compound">CTransaction</ref> &amp;</type>
          <declname>tx</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="149" column="6" bodyfile="src/validation.cpp" bodystart="149" bodyend="169"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a245fe8ced32e74fc6d7b9f2c72ef3605" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>std::optional&lt; <ref refid="struct_lock_points" kindref="compound">LockPoints</ref> &gt;</type>
        <definition>std::optional&lt; LockPoints &gt; CalculateLockPointsAtTip</definition>
        <argsstring>(CBlockIndex *tip, const CCoinsView &amp;coins_view, const CTransaction &amp;tx)</argsstring>
        <name>CalculateLockPointsAtTip</name>
        <param>
          <type><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref> *</type>
          <declname>tip</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_coins_view" kindref="compound">CCoinsView</ref> &amp;</type>
          <declname>coins_view</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_transaction" kindref="compound">CTransaction</ref> &amp;</type>
          <declname>tx</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="203" column="15" bodyfile="src/validation.cpp" bodystart="203" bodyend="246"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a4bb60528a48d01c047a4b004e13136ff" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool CheckSequenceLocksAtTip</definition>
        <argsstring>(CBlockIndex *tip, const LockPoints &amp;lock_points)</argsstring>
        <name>CheckSequenceLocksAtTip</name>
        <param>
          <type><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref> *</type>
          <declname>tip</declname>
        </param>
        <param>
          <type>const <ref refid="struct_lock_points" kindref="compound">LockPoints</ref> &amp;</type>
          <declname>lock_points</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Check if transaction will be BIP68 final in the next block to be created on top of tip. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">tip</parametername>
</parameternamelist>
<parameterdescription>
<para><ref refid="class_chain" kindref="compound">Chain</ref> tip to check tx sequence locks against. For example, the tip of the current active chain. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">lock_points</parametername>
</parameternamelist>
<parameterdescription>
<para><ref refid="struct_lock_points" kindref="compound">LockPoints</ref> containing the height and time at which this transaction is final. Simulates calling <ref refid="tx__verify_8cpp_1ad5b7bf644ada0a55c6aac8cfa89ed14a" kindref="member">SequenceLocks()</ref> with data from the tip passed in. The <ref refid="struct_lock_points" kindref="compound">LockPoints</ref> should not be considered valid if CheckSequenceLocksAtTip returns false. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="248" column="6" bodyfile="src/validation.cpp" bodystart="248" bodyend="264"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a081a71ed691674a63362f7279184845a" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void LimitMempoolSize</definition>
        <argsstring>(CTxMemPool &amp;pool, CCoinsViewCache &amp;coins_cache) EXCLUSIVE_LOCKS_REQUIRED(</argsstring>
        <name>LimitMempoolSize</name>
        <param>
          <type><ref refid="class_c_tx_mem_pool" kindref="compound">CTxMemPool</ref> &amp;</type>
          <declname>pool</declname>
        </param>
        <param>
          <type><ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref> &amp;</type>
          <declname>coins_cache</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="266" column="13" bodyfile="src/validation.cpp" bodystart="266" bodyend="280"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1abc2662c203ba0999195d25ae78490452" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>static bool IsCurrentForFeeEstimation</definition>
        <argsstring>(Chainstate &amp;active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(cs_main)</argsstring>
        <name>IsCurrentForFeeEstimation</name>
        <param>
          <type><ref refid="class_chainstate" kindref="compound">Chainstate</ref> &amp;</type>
          <declname>active_chainstate</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="282" column="13" bodyfile="src/validation.cpp" bodystart="282" bodyend="294"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a72134c921eab4116da9984150176d886" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>static bool CheckInputsFromMempoolAndCache</definition>
        <argsstring>(const CTransaction &amp;tx, TxValidationState &amp;state, const CCoinsViewCache &amp;view, const CTxMemPool &amp;pool, script_verify_flags flags, PrecomputedTransactionData &amp;txdata, CCoinsViewCache &amp;coins_tip, ValidationCache &amp;validation_cache) EXCLUSIVE_LOCKS_REQUIRED(cs_main</argsstring>
        <name>CheckInputsFromMempoolAndCache</name>
        <param>
          <type>const <ref refid="class_c_transaction" kindref="compound">CTransaction</ref> &amp;</type>
          <declname>tx</declname>
        </param>
        <param>
          <type><ref refid="class_tx_validation_state" kindref="compound">TxValidationState</ref> &amp;</type>
          <declname>state</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref> &amp;</type>
          <declname>view</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_tx_mem_pool" kindref="compound">CTxMemPool</ref> &amp;</type>
          <declname>pool</declname>
        </param>
        <param>
          <type><ref refid="classscript__verify__flags" kindref="compound">script_verify_flags</ref></type>
          <declname>flags</declname>
        </param>
        <param>
          <type><ref refid="struct_precomputed_transaction_data" kindref="compound">PrecomputedTransactionData</ref> &amp;</type>
          <declname>txdata</declname>
        </param>
        <param>
          <type><ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref> &amp;</type>
          <declname>coins_tip</declname>
        </param>
        <param>
          <type><ref refid="class_validation_cache" kindref="compound">ValidationCache</ref> &amp;</type>
          <declname>validation_cache</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Checks to avoid mempool polluting consensus critical paths since cached signature and script validity results will be reused if we validate this transaction again during block validation. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="397" column="13"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1abee2920f50f82cc5721ae2cd3f1c4f95" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>AssertLockHeld</definition>
        <argsstring>(pool.cs)</argsstring>
        <name>AssertLockHeld</name>
        <param>
          <type>pool.</type>
          <declname>cs</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="404" column="5" declfile="src/validation.cpp" declline="404" declcolumn="5"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>assert</definition>
        <argsstring>(!tx.IsCoinBase())</argsstring>
        <name>assert</name>
        <param>
          <type>!tx.</type>
          <declname>IsCoinBase</declname>
          <array>()</array>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="406" column="5" declfile="src/validation.cpp" declline="406" declcolumn="5"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1ab7c9794093e95d5e2d9c5942d2fb4d15" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>for</definition>
        <argsstring>(const CTxIn &amp;txin :tx.vin)</argsstring>
        <name>for</name>
        <param>
          <type>const <ref refid="class_c_tx_in" kindref="compound">CTxIn</ref> &amp;txin :tx.</type>
          <declname>vin</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="407" column="5" bodyfile="src/validation.cpp" bodystart="407" bodyend="429"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a731f477cdd04b22ecd6b2098b2b8f9a7" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>return</type>
        <definition>return CheckInputScripts</definition>
        <argsstring>(tx, state, view, flags, true, true, txdata, validation_cache)</argsstring>
        <name>CheckInputScripts</name>
        <param>
          <type>tx</type>
        </param>
        <param>
          <type>state</type>
        </param>
        <param>
          <type>view</type>
        </param>
        <param>
          <type><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref></type>
        </param>
        <param>
          <type>true</type>
        </param>
        <param>
          <type>true</type>
        </param>
        <param>
          <type>txdata</type>
        </param>
        <param>
          <type>validation_cache</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="432" column="12" declfile="src/validation.cpp" declline="432" declcolumn="12"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a400e902384ac40a640a3a2dd0dba312a" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="struct_mempool_accept_result" kindref="compound">MempoolAcceptResult</ref></type>
        <definition>MempoolAcceptResult AcceptToMemoryPool</definition>
        <argsstring>(Chainstate &amp;active_chainstate, const CTransactionRef &amp;tx, int64_t accept_time, bool bypass_limits, bool test_accept)</argsstring>
        <name>AcceptToMemoryPool</name>
        <param>
          <type><ref refid="class_chainstate" kindref="compound">Chainstate</ref> &amp;</type>
          <declname>active_chainstate</declname>
        </param>
        <param>
          <type>const <ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref> &amp;</type>
          <declname>tx</declname>
        </param>
        <param>
          <type>int64_t</type>
          <declname>accept_time</declname>
        </param>
        <param>
          <type>bool</type>
          <declname>bypass_limits</declname>
        </param>
        <param>
          <type>bool</type>
          <declname>test_accept</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Try to add a transaction to the mempool. This is an internal function and is exposed only for testing. Client code should use <ref refid="class_chainstate_manager_1a9c7d6797a606a08696d722e7489b6d4d" kindref="member">ChainstateManager::ProcessTransaction()</ref></para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">active_chainstate</parametername>
</parameternamelist>
<parameterdescription>
<para>Reference to the active chainstate. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">tx</parametername>
</parameternamelist>
<parameterdescription>
<para>The transaction to submit for mempool acceptance. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">accept_time</parametername>
</parameternamelist>
<parameterdescription>
<para>The timestamp for adding the transaction to the mempool. It is also used to determine when the entry expires. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">bypass_limits</parametername>
</parameternamelist>
<parameterdescription>
<para>When true, don&apos;t enforce mempool fee and capacity limits, and set entry_sequence to zero. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">test_accept</parametername>
</parameternamelist>
<parameterdescription>
<para>When true, run validation checks but don&apos;t submit to mempool.</para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>a <ref refid="struct_mempool_accept_result" kindref="compound">MempoolAcceptResult</ref> indicating whether the transaction was accepted/rejected with reason. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="1791" column="21" bodyfile="src/validation.cpp" bodystart="1791" bodyend="1821"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a050f5f1343cc094282474bf0aff8e07f" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="struct_package_mempool_accept_result" kindref="compound">PackageMempoolAcceptResult</ref></type>
        <definition>PackageMempoolAcceptResult ProcessNewPackage</definition>
        <argsstring>(Chainstate &amp;active_chainstate, CTxMemPool &amp;pool, const Package &amp;package, bool test_accept, const std::optional&lt; CFeeRate &gt; &amp;client_maxfeerate)</argsstring>
        <name>ProcessNewPackage</name>
        <param>
          <type><ref refid="class_chainstate" kindref="compound">Chainstate</ref> &amp;</type>
          <declname>active_chainstate</declname>
        </param>
        <param>
          <type><ref refid="class_c_tx_mem_pool" kindref="compound">CTxMemPool</ref> &amp;</type>
          <declname>pool</declname>
        </param>
        <param>
          <type>const <ref refid="packages_8h_1a138b5dbe56c4869308e2bc7a28b51d9c" kindref="member">Package</ref> &amp;</type>
          <declname>txns</declname>
          <defname>package</defname>
        </param>
        <param>
          <type>bool</type>
          <declname>test_accept</declname>
        </param>
        <param>
          <type>const std::optional&lt; <ref refid="class_c_fee_rate" kindref="compound">CFeeRate</ref> &gt; &amp;</type>
          <declname>client_maxfeerate</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Validate (and maybe submit) a package to the mempool. See doc/policy/packages.md for full details on package validation rules. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">test_accept</parametername>
</parameternamelist>
<parameterdescription>
<para>When true, run validation checks but don&apos;t submit to mempool. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">client_maxfeerate</parametername>
</parameternamelist>
<parameterdescription>
<para>If exceeded by an individual transaction, rest of (sub)package evaluation is aborted. Only for sanity checks against local submission of transactions. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>a <ref refid="struct_package_mempool_accept_result" kindref="compound">PackageMempoolAcceptResult</ref> which includes a <ref refid="struct_mempool_accept_result" kindref="compound">MempoolAcceptResult</ref> for each transaction. If a transaction fails, validation will exit early and some results may be missing. It is also possible for the package to be partially submitted. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="1823" column="28" bodyfile="src/validation.cpp" bodystart="1823" bodyend="1853"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a3e7cb06e156ad8400b9214479e946187" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref></type>
        <definition>CAmount GetBlockSubsidy</definition>
        <argsstring>(int nHeight, const Consensus::Params &amp;consensusParams)</argsstring>
        <name>GetBlockSubsidy</name>
        <param>
          <type>int</type>
          <declname>nHeight</declname>
        </param>
        <param>
          <type>const <ref refid="struct_consensus_1_1_params" kindref="compound">Consensus::Params</ref> &amp;</type>
          <declname>consensusParams</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="1855" column="9" bodyfile="src/validation.cpp" bodystart="1855" bodyend="1866"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a76ffac026788c8c1e6d55fb1beae0962" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void UpdateCoins</definition>
        <argsstring>(const CTransaction &amp;tx, CCoinsViewCache &amp;inputs, CTxUndo &amp;txundo, int nHeight)</argsstring>
        <name>UpdateCoins</name>
        <param>
          <type>const <ref refid="class_c_transaction" kindref="compound">CTransaction</ref> &amp;</type>
          <declname>tx</declname>
        </param>
        <param>
          <type><ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref> &amp;</type>
          <declname>inputs</declname>
        </param>
        <param>
          <type><ref refid="class_c_tx_undo" kindref="compound">CTxUndo</ref> &amp;</type>
          <declname>txundo</declname>
        </param>
        <param>
          <type>int</type>
          <declname>nHeight</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="2040" column="6" bodyfile="src/validation.cpp" bodystart="2040" bodyend="2053"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a497b8df01226639187a706653e88fe50" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool FatalError</definition>
        <argsstring>(Notifications &amp;notifications, BlockValidationState &amp;state, const bilingual_str &amp;message)</argsstring>
        <name>FatalError</name>
        <param>
          <type><ref refid="class_notifications" kindref="compound">Notifications</ref> &amp;</type>
          <declname>notifications</declname>
        </param>
        <param>
          <type><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref> &amp;</type>
          <declname>state</declname>
        </param>
        <param>
          <type>const <ref refid="structbilingual__str" kindref="compound">bilingual_str</ref> &amp;</type>
          <declname>message</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="2177" column="6" bodyfile="src/validation.cpp" bodystart="2177" bodyend="2181"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a492da8f7add38097a8e55f3445a9c83b" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int ApplyTxInUndo</definition>
        <argsstring>(Coin &amp;&amp;undo, CCoinsViewCache &amp;view, const COutPoint &amp;out)</argsstring>
        <name>ApplyTxInUndo</name>
        <param>
          <type><ref refid="class_coin" kindref="compound">Coin</ref> &amp;&amp;</type>
          <declname>undo</declname>
        </param>
        <param>
          <type><ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref> &amp;</type>
          <declname>view</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_out_point" kindref="compound">COutPoint</ref> &amp;</type>
          <declname>out</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Restore the UTXO in a <ref refid="class_coin" kindref="compound">Coin</ref> at a given <ref refid="class_c_out_point" kindref="compound">COutPoint</ref> <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>undo</parametername>
</parameternamelist>
<parameterdescription>
<para>The <ref refid="class_coin" kindref="compound">Coin</ref> to be restored. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>view</parametername>
</parameternamelist>
<parameterdescription>
<para>The coins view to which to apply the changes. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>out</parametername>
</parameternamelist>
<parameterdescription>
<para>The out point that corresponds to the tx input. </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>A <ref refid="validation_8h_1aeaef80b01ee5387f474a63ed23c9cc50" kindref="member">DisconnectResult</ref> as an int </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="2190" column="5" bodyfile="src/validation.cpp" bodystart="2190" bodyend="2216"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a1c5c1cc0abaf193cde025de8c0827b50" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="classscript__verify__flags" kindref="compound">script_verify_flags</ref></type>
        <definition>script_verify_flags GetBlockScriptFlags</definition>
        <argsstring>(const CBlockIndex &amp;block_index, const ChainstateManager &amp;chainman)</argsstring>
        <name>GetBlockScriptFlags</name>
        <param>
          <type>const <ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref> &amp;</type>
          <declname>block_index</declname>
        </param>
        <param>
          <type>const <ref refid="class_chainstate_manager" kindref="compound">ChainstateManager</ref> &amp;</type>
          <declname>chainman</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="2291" column="21" bodyfile="src/validation.cpp" bodystart="2291" bodyend="2330"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a5f7230ad411f6724c53a8b42936680be" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void UpdateTipLog</definition>
        <argsstring>(const ChainstateManager &amp;chainman, const CCoinsViewCache &amp;coins_tip, const CBlockIndex *tip, const std::string &amp;func_name, const std::string &amp;prefix, const std::string &amp;warning_messages) EXCLUSIVE_LOCKS_REQUIRED(</argsstring>
        <name>UpdateTipLog</name>
        <param>
          <type>const <ref refid="class_chainstate_manager" kindref="compound">ChainstateManager</ref> &amp;</type>
          <declname>chainman</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref> &amp;</type>
          <declname>coins_tip</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref> *</type>
          <declname>tip</declname>
        </param>
        <param>
          <type>const std::string &amp;</type>
          <declname>func_name</declname>
        </param>
        <param>
          <type>const std::string &amp;</type>
          <declname>prefix</declname>
        </param>
        <param>
          <type>const std::string &amp;</type>
          <declname>warning_messages</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="2905" column="13" bodyfile="src/validation.cpp" bodystart="2905" bodyend="2926"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1aebe15affe0ce685ac6a9372dddc9864c" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="validation_8h_1a6c3c8e6370214538a00a221a568b5219" kindref="member">SynchronizationState</ref></type>
        <definition>static SynchronizationState GetSynchronizationState</definition>
        <argsstring>(bool init, bool blockfiles_indexed)</argsstring>
        <name>GetSynchronizationState</name>
        <param>
          <type>bool</type>
          <declname>init</declname>
        </param>
        <param>
          <type>bool</type>
          <declname>blockfiles_indexed</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="3356" column="29" bodyfile="src/validation.cpp" bodystart="3356" bodyend="3361"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1af8630cb79449836c9c7ec3d5eca6e9b2" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void LimitValidationInterfaceQueue</definition>
        <argsstring>(ValidationSignals &amp;signals) LOCKS_EXCLUDED(cs_main)</argsstring>
        <name>LimitValidationInterfaceQueue</name>
        <param>
          <type><ref refid="class_validation_signals" kindref="compound">ValidationSignals</ref> &amp;</type>
          <declname>signals</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="3385" column="13" bodyfile="src/validation.cpp" bodystart="3385" bodyend="3391"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1ac77f722da23b1398d17b850eec00c739" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>static bool CheckBlockHeader</definition>
        <argsstring>(const CBlockHeader &amp;block, BlockValidationState &amp;state, const Consensus::Params &amp;consensusParams, bool fCheckPOW=true)</argsstring>
        <name>CheckBlockHeader</name>
        <param>
          <type>const <ref refid="class_c_block_header" kindref="compound">CBlockHeader</ref> &amp;</type>
          <declname>block</declname>
        </param>
        <param>
          <type><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref> &amp;</type>
          <declname>state</declname>
        </param>
        <param>
          <type>const <ref refid="struct_consensus_1_1_params" kindref="compound">Consensus::Params</ref> &amp;</type>
          <declname>consensusParams</declname>
        </param>
        <param>
          <type>bool</type>
          <declname>fCheckPOW</declname>
          <defval>true</defval>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="3907" column="13" bodyfile="src/validation.cpp" bodystart="3907" bodyend="3914"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a79d529fdb416d3027d0911e2c20ebebc" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>static bool CheckMerkleRoot</definition>
        <argsstring>(const CBlock &amp;block, BlockValidationState &amp;state)</argsstring>
        <name>CheckMerkleRoot</name>
        <param>
          <type>const <ref refid="class_c_block" kindref="compound">CBlock</ref> &amp;</type>
          <declname>block</declname>
        </param>
        <param>
          <type><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref> &amp;</type>
          <declname>state</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="3916" column="13" bodyfile="src/validation.cpp" bodystart="3916" bodyend="3941"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a74b652ca0aecdfb7b4bdf808feeaa6c9" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>static bool CheckWitnessMalleation</definition>
        <argsstring>(const CBlock &amp;block, bool expect_witness_commitment, BlockValidationState &amp;state)</argsstring>
        <name>CheckWitnessMalleation</name>
        <param>
          <type>const <ref refid="class_c_block" kindref="compound">CBlock</ref> &amp;</type>
          <declname>block</declname>
        </param>
        <param>
          <type>bool</type>
          <declname>expect_witness_commitment</declname>
        </param>
        <param>
          <type><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref> &amp;</type>
          <declname>state</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>CheckWitnessMalleation performs checks for block malleation with regard to its witnesses.</para>
<para>Note: If the witness commitment is expected (i.e. <computeroutput>expect_witness_commitment = true</computeroutput>), then the block is required to have at least one transaction and the first transaction needs to have at least one input. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="3949" column="13" bodyfile="src/validation.cpp" bodystart="3949" bodyend="3995"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1aac26467a10843087935711c71e43e184" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool CheckBlock</definition>
        <argsstring>(const CBlock &amp;block, BlockValidationState &amp;state, const Consensus::Params &amp;consensusParams, bool fCheckPOW, bool fCheckMerkleRoot)</argsstring>
        <name>CheckBlock</name>
        <param>
          <type>const <ref refid="class_c_block" kindref="compound">CBlock</ref> &amp;</type>
          <declname>block</declname>
        </param>
        <param>
          <type><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref> &amp;</type>
          <declname>state</declname>
        </param>
        <param>
          <type>const <ref refid="struct_consensus_1_1_params" kindref="compound">Consensus::Params</ref> &amp;</type>
          <declname>consensusParams</declname>
        </param>
        <param>
          <type>bool</type>
          <declname>fCheckPOW</declname>
          <defval>true</defval>
        </param>
        <param>
          <type>bool</type>
          <declname>fCheckMerkleRoot</declname>
          <defval>true</defval>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Functions for validating blocks and updating the block tree Context-independent validity checks </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="3997" column="6" bodyfile="src/validation.cpp" bodystart="3997" bodyend="4062"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a600cde3b7d04dc488eec00d290931db7" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool HasValidProofOfWork</definition>
        <argsstring>(const std::vector&lt; CBlockHeader &gt; &amp;headers, const Consensus::Params &amp;consensusParams)</argsstring>
        <name>HasValidProofOfWork</name>
        <param>
          <type>const std::vector&lt; <ref refid="class_c_block_header" kindref="compound">CBlockHeader</ref> &gt; &amp;</type>
          <declname>headers</declname>
        </param>
        <param>
          <type>const <ref refid="struct_consensus_1_1_params" kindref="compound">Consensus::Params</ref> &amp;</type>
          <declname>consensusParams</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Check with the proof of work on each blockheader matches the value in nBits </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="4103" column="6" bodyfile="src/validation.cpp" bodystart="4103" bodyend="4107"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a10bb051c7f669d2bea4c37e6b6d3ed5c" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool IsBlockMutated</definition>
        <argsstring>(const CBlock &amp;block, bool check_witness_root)</argsstring>
        <name>IsBlockMutated</name>
        <param>
          <type>const <ref refid="class_c_block" kindref="compound">CBlock</ref> &amp;</type>
          <declname>block</declname>
        </param>
        <param>
          <type>bool</type>
          <declname>check_witness_root</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Check if a block has been mutated (with respect to its merkle root and witness commitments). </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="4109" column="6" bodyfile="src/validation.cpp" bodystart="4109" bodyend="4138"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a805faf00f329288736b407376d6edb7a" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="classarith__uint256" kindref="compound">arith_uint256</ref></type>
        <definition>arith_uint256 CalculateClaimedHeadersWork</definition>
        <argsstring>(std::span&lt; const CBlockHeader &gt; headers)</argsstring>
        <name>CalculateClaimedHeadersWork</name>
        <param>
          <type>std::span&lt; const <ref refid="class_c_block_header" kindref="compound">CBlockHeader</ref> &gt;</type>
          <declname>headers</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Return the sum of the claimed work on a given set of headers. No verification of PoW is done. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="4140" column="15" bodyfile="src/validation.cpp" bodystart="4140" bodyend="4148"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1af290b57f5e71a70529e00f508e5682aa" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>static bool ContextualCheckBlockHeader</definition>
        <argsstring>(const CBlockHeader &amp;block, BlockValidationState &amp;state, BlockManager &amp;blockman, const ChainstateManager &amp;chainman, const CBlockIndex *pindexPrev) EXCLUSIVE_LOCKS_REQUIRED(</argsstring>
        <name>ContextualCheckBlockHeader</name>
        <param>
          <type>const <ref refid="class_c_block_header" kindref="compound">CBlockHeader</ref> &amp;</type>
          <declname>block</declname>
        </param>
        <param>
          <type><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref> &amp;</type>
          <declname>state</declname>
        </param>
        <param>
          <type><ref refid="class_block_manager" kindref="compound">BlockManager</ref> &amp;</type>
          <declname>blockman</declname>
        </param>
        <param>
          <type>const <ref refid="class_chainstate_manager" kindref="compound">ChainstateManager</ref> &amp;</type>
          <declname>chainman</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref> *</type>
          <declname>pindexPrev</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Context-dependent validity checks. By &quot;context&quot;, we mean only the previous block headers, but not the UTXO set; UTXO-related validity checks are done in ConnectBlock(). NOTE: This function is not currently invoked by ConnectBlock(), so we should consider upgrade issues if we change which consensus rules are enforced in this function (eg by adding a new consensus rule). See comment in ConnectBlock(). Note that -reindex-chainstate skips the validation that happens here!</para>
<para>NOTE: failing to check the header&apos;s height against the last checkpoint&apos;s opened a DoS vector between v0.12 and v0.15 (when no additional protection was in place) whereby an attacker could unboundedly grow our in-memory block index. See <ulink url="https://bitcoincore.org/en/2024/07/03/disclose-header-spam">https://bitcoincore.org/en/2024/07/03/disclose-header-spam</ulink>. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="4163" column="13" bodyfile="src/validation.cpp" bodystart="4163" bodyend="4204"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a494711edb2505fda9ada41f219634976" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>static bool ContextualCheckBlock</definition>
        <argsstring>(const CBlock &amp;block, BlockValidationState &amp;state, const ChainstateManager &amp;chainman, const CBlockIndex *pindexPrev)</argsstring>
        <name>ContextualCheckBlock</name>
        <param>
          <type>const <ref refid="class_c_block" kindref="compound">CBlock</ref> &amp;</type>
          <declname>block</declname>
        </param>
        <param>
          <type><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref> &amp;</type>
          <declname>state</declname>
        </param>
        <param>
          <type>const <ref refid="class_chainstate_manager" kindref="compound">ChainstateManager</ref> &amp;</type>
          <declname>chainman</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref> *</type>
          <declname>pindexPrev</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>NOTE: This function is not currently invoked by ConnectBlock(), so we should consider upgrade issues if we change which consensus rules are enforced in this function (eg by adding a new consensus rule). See comment in ConnectBlock(). Note that -reindex-chainstate skips the validation that happens here! </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="4212" column="13" bodyfile="src/validation.cpp" bodystart="4212" bodyend="4267"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1ac0610c85af2e020fe5284c21b47beb39" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref></type>
        <definition>BlockValidationState TestBlockValidity</definition>
        <argsstring>(Chainstate &amp;chainstate, const CBlock &amp;block, const bool check_pow, const bool check_merkle_root)</argsstring>
        <name>TestBlockValidity</name>
        <param>
          <type><ref refid="class_chainstate" kindref="compound">Chainstate</ref> &amp;</type>
          <declname>chainstate</declname>
        </param>
        <param>
          <type>const <ref refid="class_c_block" kindref="compound">CBlock</ref> &amp;</type>
          <declname>block</declname>
        </param>
        <param>
          <type>bool</type>
          <declname>check_pow</declname>
        </param>
        <param>
          <type>bool</type>
          <declname>check_merkle_root</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Verify a block, including transactions.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">block</parametername>
</parameternamelist>
<parameterdescription>
<para>The block we want to process. Must connect to the current tip. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">chainstate</parametername>
</parameternamelist>
<parameterdescription>
<para>The chainstate to connect to. </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">check_pow</parametername>
</parameternamelist>
<parameterdescription>
<para>perform proof-of-work check, nBits in the header is always checked </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">check_merkle_root</parametername>
</parameternamelist>
<parameterdescription>
<para>check the merkle root</para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>Valid or Invalid state. This doesn&apos;t currently return an Error state, and shouldn&apos;t unless there is something wrong with the existing chainstate. (This is different from functions like AcceptBlock which can fail trying to save new data.)</para>
</simplesect>
For signets the challenge verification is skipped when check_pow is false. </para>
        </detaileddescription>
        <inbodydescription>
<para>At this point ProcessNewBlock would call AcceptBlock(), but we don&apos;t want to store the block or its header. Run individual checks instead:<itemizedlist>
<listitem><para>skip AcceptBlockHeader() because:<itemizedlist>
<listitem><para>we don&apos;t want to update the block index</para>
</listitem><listitem><para>we do not care about duplicates</para>
</listitem><listitem><para>we already ran CheckBlockHeader() via <ref refid="validation_8h_1a9d72a901e6237b2e81465a7425f4112c" kindref="member">CheckBlock()</ref></para>
</listitem><listitem><para>we already checked for prev-blk-not-found</para>
</listitem><listitem><para>we know the tip is valid, so no need to check bad-prevblk</para>
</listitem></itemizedlist>
</para>
</listitem><listitem><para>we already ran <ref refid="validation_8h_1a9d72a901e6237b2e81465a7425f4112c" kindref="member">CheckBlock()</ref></para>
</listitem><listitem><para>do run ContextualCheckBlockHeader()</para>
</listitem><listitem><para>do run ContextualCheckBlock()</para>
</listitem></itemizedlist>
</para>
        </inbodydescription>
        <location file="src/validation.cpp" line="4546" column="22" bodyfile="src/validation.cpp" bodystart="4546" bodyend="4617"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1ab256293c94a9e05d6d9a9ccb5d6b2c58" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void PruneBlockFilesManual</definition>
        <argsstring>(Chainstate &amp;active_chainstate, int nManualPruneHeight)</argsstring>
        <name>PruneBlockFilesManual</name>
        <param>
          <type><ref refid="class_chainstate" kindref="compound">Chainstate</ref> &amp;</type>
          <declname>active_chainstate</declname>
        </param>
        <param>
          <type>int</type>
          <declname>nManualPruneHeight</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Prune block files up to a given height </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="4620" column="6" bodyfile="src/validation.cpp" bodystart="4620" bodyend="4627"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a79b095824602e0dc2777e8efdb7951c9" prot="public" static="yes" nodiscard="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>static bool DeleteCoinsDBFromDisk</definition>
        <argsstring>(const fs::path db_path, bool is_snapshot) EXCLUSIVE_LOCKS_REQUIRED(</argsstring>
        <name>DeleteCoinsDBFromDisk</name>
        <param>
          <type>const <ref refid="classfs_1_1path" kindref="compound">fs::path</ref></type>
          <declname>db_path</declname>
        </param>
        <param>
          <type>bool</type>
          <declname>is_snapshot</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="5615" column="14" bodyfile="src/validation.cpp" bodystart="5615" bodyend="5653"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1ab40937f16c00be485fd82c2530799bda" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void FlushSnapshotToDisk</definition>
        <argsstring>(CCoinsViewCache &amp;coins_cache, bool snapshot_loaded)</argsstring>
        <name>FlushSnapshotToDisk</name>
        <param>
          <type><ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref> &amp;</type>
          <declname>coins_cache</declname>
        </param>
        <param>
          <type>bool</type>
          <declname>snapshot_loaded</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="5797" column="13" bodyfile="src/validation.cpp" bodystart="5797" bodyend="5806"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1ad832702f2eff6443396dced7fa0acf22" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>static void SnapshotUTXOHashBreakpoint</definition>
        <argsstring>(const util::SignalInterrupt &amp;interrupt)</argsstring>
        <name>SnapshotUTXOHashBreakpoint</name>
        <param>
          <type>const <ref refid="classutil_1_1_signal_interrupt" kindref="compound">util::SignalInterrupt</ref> &amp;</type>
          <declname>interrupt</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="5816" column="13" bodyfile="src/validation.cpp" bodystart="5816" bodyend="5819"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a678b5a0ed349249e53f98b15e123cba1" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type><ref refid="class_chainstate_manager_1a66bc0ee7102eaf1cbd62d3a9d7087e52" kindref="member">ChainstateManager::Options</ref> &amp;&amp;</type>
        <definition>static ChainstateManager::Options &amp;&amp; Flatten</definition>
        <argsstring>(ChainstateManager::Options &amp;&amp;opts)</argsstring>
        <name>Flatten</name>
        <param>
          <type><ref refid="class_chainstate_manager_1a66bc0ee7102eaf1cbd62d3a9d7087e52" kindref="member">ChainstateManager::Options</ref> &amp;&amp;</type>
          <declname>opts</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Apply default chain params to nullopt members. This helps to avoid coding errors around the accidental use of the compare operators that accept nullopt, thus ignoring the intended default value. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="6195" column="35" bodyfile="src/validation.cpp" bodystart="6195" bodyend="6201"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1ad2cf17561482ed386ab70ddaa9b6b7a1" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool IsBIP30Repeat</definition>
        <argsstring>(const CBlockIndex &amp;block_index)</argsstring>
        <name>IsBIP30Repeat</name>
        <param>
          <type>const <ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref> &amp;</type>
          <declname>block_index</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Identifies blocks that overwrote an existing coinbase output in the UTXO set (see BIP30) </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="6257" column="6" bodyfile="src/validation.cpp" bodystart="6257" bodyend="6261"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1af3fd9113ad463595ffeac4bf813ceea4" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool IsBIP30Unspendable</definition>
        <argsstring>(const uint256 &amp;block_hash, int block_height)</argsstring>
        <name>IsBIP30Unspendable</name>
        <param>
          <type>const <ref refid="classuint256" kindref="compound">uint256</ref> &amp;</type>
          <declname>block_hash</declname>
        </param>
        <param>
          <type>int</type>
          <declname>block_height</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Identifies blocks which coinbase output was subsequently overwritten in the UTXO set (see BIP30) </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="6263" column="6" bodyfile="src/validation.cpp" bodystart="6263" bodyend="6267"/>
      </memberdef>
      <memberdef kind="function" id="validation_8cpp_1a0b115ee6418fd7957d1e1dfa52d7297a" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <templateparamlist>
          <param>
            <type>typename <ref refid="hash__tests_8cpp_1ad4971a985148c784a362f962d42aa012" kindref="member">T</ref></type>
          </param>
        </templateparamlist>
        <type>bool</type>
        <definition>static bool ComputeUTXOStats</definition>
        <argsstring>(CCoinsView *view, CCoinsStats &amp;stats, T hash_obj, const std::function&lt; void()&gt; &amp;interruption_point)</argsstring>
        <name>ComputeUTXOStats</name>
        <param>
          <type><ref refid="class_c_coins_view" kindref="compound">CCoinsView</ref> *</type>
          <declname>view</declname>
        </param>
        <param>
          <type><ref refid="struct_c_coins_stats" kindref="compound">CCoinsStats</ref> &amp;</type>
          <declname>stats</declname>
        </param>
        <param>
          <type><ref refid="hash__tests_8cpp_1ad4971a985148c784a362f962d42aa012" kindref="member">T</ref></type>
          <declname>hash_obj</declname>
        </param>
        <param>
          <type>const std::function&lt; void()&gt; &amp;</type>
          <declname>interruption_point</declname>
        </param>
        <briefdescription>
<para>Calculate statistics about the unspent transaction output set. </para>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="82" column="1" bodyfile="src/kernel/coinstats.cpp" bodystart="116" bodyend="152"/>
      </memberdef>
    </sectiondef>
    <sectiondef kind="enum">
      <memberdef kind="enum" id="validation_8cpp_1a77fe3880fe4048d786e97a070552eca7" prot="public" static="no" strong="yes">
        <type></type>
        <name>CoinStatsHashType</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="81" column="1" bodyfile="src/kernel/coinstats.h" bodystart="27" bodyend="31"/>
      </memberdef>
    </sectiondef>
    <sectiondef kind="typedef">
      <memberdef kind="typedef" id="validation_8cpp_1a37b0fd82fe2a81c8cf4ecedc6f083cd5" prot="public" static="no">
        <type>std::function&lt; FILE *(const <ref refid="classfs_1_1path" kindref="compound">fs::path</ref> &amp;, const char *)&gt;</type>
        <definition>using FopenFn =  std::function&lt;FILE*(const fs::path&amp;, const char*)&gt;</definition>
        <argsstring></argsstring>
        <name>FopenFn</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="85" column="1" bodyfile="src/util/fs.h" bodystart="192" bodyend="-1"/>
      </memberdef>
      <memberdef kind="typedef" id="validation_8cpp_1acee0086a0c833617dd1532caf93206a3" prot="public" static="no">
        <type>std::unordered_map&lt; <ref refid="classuint256" kindref="compound">uint256</ref>, <ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>, <ref refid="struct_block_hasher" kindref="compound">BlockHasher</ref> &gt;</type>
        <definition>using BlockMap =  std::unordered_map&lt;uint256, CBlockIndex, BlockHasher&gt;</definition>
        <argsstring></argsstring>
        <name>BlockMap</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/validation.cpp" line="87" column="1" bodyfile="src/node/blockstorage.h" bodystart="135" bodyend="-1"/>
      </memberdef>
    </sectiondef>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="comment">//<sp/>Copyright<sp/>(c)<sp/>2009-2010<sp/>Satoshi<sp/>Nakamoto</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Copyright<sp/>(c)<sp/>2009-present<sp/>The<sp/>Bitcoin<sp/>Core<sp/>developers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Distributed<sp/>under<sp/>the<sp/>MIT<sp/>software<sp/>license,<sp/>see<sp/>the<sp/>accompanying</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4"><highlight class="normal"></highlight><highlight class="comment">//<sp/>file<sp/>COPYING<sp/>or<sp/>http://www.opensource.org/licenses/mit-license.php.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5"><highlight class="normal"></highlight></codeline>
<codeline lineno="6"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;bitcoin-build-config.h&gt;</highlight><highlight class="normal"><sp/></highlight><highlight class="comment">//<sp/>IWYU<sp/>pragma:<sp/>keep</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="validation_8h" kindref="compound">validation.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="arith__uint256_8h" kindref="compound">arith_uint256.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="chain_8h" kindref="compound">chain.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="checkqueue_8h" kindref="compound">checkqueue.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="13"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="clientversion_8h" kindref="compound">clientversion.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="14"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="amount_8h" kindref="compound">consensus/amount.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="15"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="consensus_8h" kindref="compound">consensus/consensus.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="16"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="merkle_8h" kindref="compound">consensus/merkle.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="17"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="tx__check_8h" kindref="compound">consensus/tx_check.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="18"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="tx__verify_8h" kindref="compound">consensus/tx_verify.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="19"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="consensus_2validation_8h" kindref="compound">consensus/validation.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="20"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="cuckoocache_8h" kindref="compound">cuckoocache.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="21"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="flatfile_8h" kindref="compound">flatfile.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="22"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="hash_8h" kindref="compound">hash.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="23"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="kernel_2chainparams_8h" kindref="compound">kernel/chainparams.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="24"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="coinstats_8h" kindref="compound">kernel/coinstats.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="25"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="disconnected__transactions_8h" kindref="compound">kernel/disconnected_transactions.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="26"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="mempool__entry_8h" kindref="compound">kernel/mempool_entry.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="27"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="messagestartchars_8h" kindref="compound">kernel/messagestartchars.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="28"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="notifications__interface_8h" kindref="compound">kernel/notifications_interface.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="29"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="kernel_2types_8h" kindref="compound">kernel/types.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="30"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="warning_8h" kindref="compound">kernel/warning.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="31"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="logging_8h" kindref="compound">logging.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="32"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="timer_8h" kindref="compound">logging/timer.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="33"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="blockstorage_8h" kindref="compound">node/blockstorage.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="34"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="utxo__snapshot_8h" kindref="compound">node/utxo_snapshot.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="35"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="ephemeral__policy_8h" kindref="compound">policy/ephemeral_policy.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="36"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="policy_8h" kindref="compound">policy/policy.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="37"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="policy_2rbf_8h" kindref="compound">policy/rbf.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="38"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="policy_2settings_8h" kindref="compound">policy/settings.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="39"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="truc__policy_8h" kindref="compound">policy/truc_policy.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="40"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="pow_8h" kindref="compound">pow.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="41"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="primitives_2block_8h" kindref="compound">primitives/block.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="42"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="primitives_2transaction_8h" kindref="compound">primitives/transaction.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="43"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="random_8h" kindref="compound">random.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="44"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="script_2script_8h" kindref="compound">script/script.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="45"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="sigcache_8h" kindref="compound">script/sigcache.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="46"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="signet_8h" kindref="compound">signet.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="47"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="tinyformat_8h" kindref="compound">tinyformat.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="48"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="txdb_8h" kindref="compound">txdb.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="49"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="txmempool_8h" kindref="compound">txmempool.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="50"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="uint256_8h" kindref="compound">uint256.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="51"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="undo_8h" kindref="compound">undo.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="52"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="check_8h" kindref="compound">util/check.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="53"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="fs_8h" kindref="compound">util/fs.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="54"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="fs__helpers_8h" kindref="compound">util/fs_helpers.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="55"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="hasher_8h" kindref="compound">util/hasher.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="56"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="moneystr_8h" kindref="compound">util/moneystr.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="57"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="util_2rbf_8h" kindref="compound">util/rbf.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="58"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="result_8h" kindref="compound">util/result.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="59"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="signalinterrupt_8h" kindref="compound">util/signalinterrupt.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="60"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="strencodings_8h" kindref="compound">util/strencodings.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="61"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="string_8h" kindref="compound">util/string.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="62"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="util_2time_8h" kindref="compound">util/time.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="63"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="trace_8h" kindref="compound">util/trace.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="64"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="translation_8h" kindref="compound">util/translation.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="65"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="validationinterface_8h" kindref="compound">validationinterface.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="66"><highlight class="normal"></highlight></codeline>
<codeline lineno="67"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;algorithm&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="68"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;cassert&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="69"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;chrono&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="70"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;deque&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="71"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;numeric&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="72"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;optional&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="73"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;ranges&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="74"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;span&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="75"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;string&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="76"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;tuple&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="77"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;utility&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="78"><highlight class="normal"></highlight></codeline>
<codeline lineno="79"><highlight class="normal"></highlight><highlight class="keyword">using<sp/></highlight><highlight class="normal"><ref refid="structkernel_1_1_c_coins_stats" kindref="compound">kernel::CCoinsStats</ref>;</highlight></codeline>
<codeline lineno="80"><highlight class="normal"></highlight><highlight class="keyword">using<sp/></highlight><highlight class="normal"><ref refid="structkernel_1_1_chainstate_role" kindref="compound">kernel::ChainstateRole</ref>;</highlight></codeline>
<codeline lineno="81"><highlight class="normal"></highlight><highlight class="keyword">using<sp/></highlight><highlight class="normal"><ref refid="namespacekernel_1a77fe3880fe4048d786e97a070552eca7" kindref="member">kernel::CoinStatsHashType</ref>;</highlight></codeline>
<codeline lineno="82"><highlight class="normal"></highlight><highlight class="keyword">using<sp/></highlight><highlight class="normal">kernel::ComputeUTXOStats;</highlight></codeline>
<codeline lineno="83"><highlight class="normal"></highlight><highlight class="keyword">using<sp/></highlight><highlight class="normal"><ref refid="classkernel_1_1_notifications" kindref="compound">kernel::Notifications</ref>;</highlight></codeline>
<codeline lineno="84"><highlight class="normal"></highlight></codeline>
<codeline lineno="85"><highlight class="normal"></highlight><highlight class="keyword">using<sp/></highlight><highlight class="normal"><ref refid="namespacefsbridge_1a37b0fd82fe2a81c8cf4ecedc6f083cd5" kindref="member">fsbridge::FopenFn</ref>;</highlight></codeline>
<codeline lineno="86"><highlight class="normal"></highlight><highlight class="keyword">using<sp/></highlight><highlight class="normal"><ref refid="classnode_1_1_block_manager" kindref="compound">node::BlockManager</ref>;</highlight></codeline>
<codeline lineno="87"><highlight class="normal"></highlight><highlight class="keyword">using<sp/></highlight><highlight class="normal"><ref refid="namespacenode_1acee0086a0c833617dd1532caf93206a3" kindref="member">node::BlockMap</ref>;</highlight></codeline>
<codeline lineno="88"><highlight class="normal"></highlight><highlight class="keyword">using<sp/></highlight><highlight class="normal"><ref refid="structnode_1_1_c_block_index_height_only_comparator" kindref="compound">node::CBlockIndexHeightOnlyComparator</ref>;</highlight></codeline>
<codeline lineno="89"><highlight class="normal"></highlight><highlight class="keyword">using<sp/></highlight><highlight class="normal"><ref refid="structnode_1_1_c_block_index_work_comparator" kindref="compound">node::CBlockIndexWorkComparator</ref>;</highlight></codeline>
<codeline lineno="90"><highlight class="normal"></highlight><highlight class="keyword">using<sp/></highlight><highlight class="normal"><ref refid="classnode_1_1_snapshot_metadata" kindref="compound">node::SnapshotMetadata</ref>;</highlight></codeline>
<codeline lineno="91"><highlight class="normal"></highlight></codeline>
<codeline lineno="93"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>WARN_FLUSH_COINS_SIZE<sp/>=<sp/>1<sp/>&lt;&lt;<sp/>30;<sp/></highlight><highlight class="comment">//<sp/>1<sp/>GiB</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="98"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>DATABASE_WRITE_INTERVAL_MIN{50min};</highlight></codeline>
<codeline lineno="99"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>DATABASE_WRITE_INTERVAL_MAX{70min};</highlight></codeline>
<codeline lineno="101"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>std::chrono::hours<sp/>MAX_FEE_ESTIMATION_TIP_AGE{3};</highlight></codeline>
<codeline lineno="102"><highlight class="normal"></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;std::string&gt;<sp/><ref refid="validation_8cpp_1aa6bf79aa2e37d5ce26771d5af135cf51" kindref="member">CHECKLEVEL_DOC</ref><sp/>{</highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;level<sp/>0<sp/>reads<sp/>the<sp/>blocks<sp/>from<sp/>disk&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;level<sp/>1<sp/>verifies<sp/>block<sp/>validity&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;level<sp/>2<sp/>verifies<sp/>undo<sp/>data&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="106"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;level<sp/>3<sp/>checks<sp/>disconnection<sp/>of<sp/>tip<sp/>blocks&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;level<sp/>4<sp/>tries<sp/>to<sp/>reconnect<sp/>the<sp/>blocks&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;each<sp/>level<sp/>includes<sp/>the<sp/>checks<sp/>of<sp/>the<sp/>previous<sp/>levels&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="109"><highlight class="normal">};</highlight></codeline>
<codeline lineno="115"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>PRUNE_LOCK_BUFFER{10};</highlight></codeline>
<codeline lineno="116"><highlight class="normal"></highlight></codeline>
<codeline lineno="117"><highlight class="normal"><ref refid="trace_8h_1af7302c002c156c1b9ea318c0d86f624a" kindref="member">TRACEPOINT_SEMAPHORE</ref>(validation,<sp/>block_connected);</highlight></codeline>
<codeline lineno="118"><highlight class="normal"><ref refid="trace_8h_1af7302c002c156c1b9ea318c0d86f624a" kindref="member">TRACEPOINT_SEMAPHORE</ref>(utxocache,<sp/>flush);</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><ref refid="trace_8h_1af7302c002c156c1b9ea318c0d86f624a" kindref="member">TRACEPOINT_SEMAPHORE</ref>(mempool,<sp/>replaced);</highlight></codeline>
<codeline lineno="120"><highlight class="normal"><ref refid="trace_8h_1af7302c002c156c1b9ea318c0d86f624a" kindref="member">TRACEPOINT_SEMAPHORE</ref>(mempool,<sp/>rejected);</highlight></codeline>
<codeline lineno="121"><highlight class="normal"></highlight></codeline>
<codeline lineno="122"><highlight class="normal"></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/><ref refid="class_chainstate_1a06368acc383ffa8737427c7279e7d8ac" kindref="member">Chainstate::FindForkInGlobalIndex</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_c_block_locator" kindref="compound">CBlockLocator</ref>&amp;<sp/>locator)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="123"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="124"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="125"><highlight class="normal"></highlight></codeline>
<codeline lineno="126"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Find<sp/>the<sp/>latest<sp/>block<sp/>common<sp/>to<sp/>locator<sp/>and<sp/>chain<sp/>-<sp/>we<sp/>expect<sp/>that</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="127"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>locator.vHave<sp/>is<sp/>sorted<sp/>descending<sp/>by<sp/>height.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="128"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256&amp;<sp/>hash<sp/>:<sp/>locator.<ref refid="struct_c_block_locator_1af22e36b5cd0c4f442c0e8f14252711f4" kindref="member">vHave</ref>)<sp/>{</highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindex{<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.LookupBlockIndex(hash)};</highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex)<sp/>{</highlight></codeline>
<codeline lineno="131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Contains(pindex))<sp/>{</highlight></codeline>
<codeline lineno="132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>pindex;</highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1ac20120d6b64792647a63d216b26e4b53" kindref="member">GetAncestor</ref>(<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Height())<sp/>==<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip())<sp/>{</highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip();</highlight></codeline>
<codeline lineno="136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="138"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Genesis();</highlight></codeline>
<codeline lineno="140"><highlight class="normal">}</highlight></codeline>
<codeline lineno="141"><highlight class="normal"></highlight></codeline>
<codeline lineno="142"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="validation_8cpp_1af9f454ea56c86078990a64f3fe8e72e2" kindref="member">CheckInputScripts</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_transaction" kindref="compound">CTransaction</ref>&amp;<sp/>tx,<sp/><ref refid="class_tx_validation_state" kindref="compound">TxValidationState</ref>&amp;<sp/>state,</highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref>&amp;<sp/>inputs,<sp/><ref refid="classscript__verify__flags" kindref="compound">script_verify_flags</ref><sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref>,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>cacheSigStore,</highlight></codeline>
<codeline lineno="144"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>cacheFullScriptStore,<sp/><ref refid="struct_precomputed_transaction_data" kindref="compound">PrecomputedTransactionData</ref>&amp;<sp/>txdata,</highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_validation_cache" kindref="compound">ValidationCache</ref>&amp;<sp/>validation_cache,</highlight></codeline>
<codeline lineno="146"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CScriptCheck&gt;*<sp/>pvChecks<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="148"><highlight class="normal"></highlight></codeline>
<codeline lineno="149"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="validation_8cpp_1a3b90ca0d639cfea2208c7c0aa5118aaa" kindref="member">CheckFinalTxAtTip</ref>(const<sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>&amp;<sp/>active_chain_tip,<sp/>const<sp/><ref refid="class_c_transaction" kindref="compound">CTransaction</ref>&amp;<sp/>tx)</highlight></codeline>
<codeline lineno="150"><highlight class="normal">{</highlight></codeline>
<codeline lineno="151"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="152"><highlight class="normal"></highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>CheckFinalTxAtTip()<sp/>uses<sp/>active_chain_tip.Height()+1<sp/>to<sp/>evaluate</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="154"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>nLockTime<sp/>because<sp/>when<sp/>IsFinalTx()<sp/>is<sp/>called<sp/>within</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="155"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>AcceptBlock(),<sp/>the<sp/>height<sp/>of<sp/>the<sp/>block<sp/>*being*</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>evaluated<sp/>is<sp/>what<sp/>is<sp/>used.<sp/>Thus<sp/>if<sp/>we<sp/>want<sp/>to<sp/>know<sp/>if<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transaction<sp/>can<sp/>be<sp/>part<sp/>of<sp/>the<sp/>*next*<sp/>block,<sp/>we<sp/>need<sp/>to<sp/>call</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>IsFinalTx()<sp/>with<sp/>one<sp/>more<sp/>than<sp/>active_chain_tip.Height().</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="159"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nBlockHeight<sp/>=<sp/>active_chain_tip.nHeight<sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="160"><highlight class="normal"></highlight></codeline>
<codeline lineno="161"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>BIP113<sp/>requires<sp/>that<sp/>time-locked<sp/>transactions<sp/>have<sp/>nLockTime<sp/>set<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>less<sp/>than<sp/>the<sp/>median<sp/>time<sp/>of<sp/>the<sp/>previous<sp/>block<sp/>they&apos;re<sp/>contained<sp/>in.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When<sp/>the<sp/>next<sp/>block<sp/>is<sp/>created<sp/>its<sp/>previous<sp/>block<sp/>will<sp/>be<sp/>the<sp/>current</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>chain<sp/>tip,<sp/>so<sp/>we<sp/>use<sp/>that<sp/>to<sp/>calculate<sp/>the<sp/>median<sp/>time<sp/>passed<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>IsFinalTx().</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>int64_t<sp/>nBlockTime{active_chain_tip.GetMedianTimePast()};</highlight></codeline>
<codeline lineno="167"><highlight class="normal"></highlight></codeline>
<codeline lineno="168"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="tx__verify_8cpp_1adc332cd7ac94e639bb4239618341be19" kindref="member">IsFinalTx</ref>(tx,<sp/>nBlockHeight,<sp/>nBlockTime);</highlight></codeline>
<codeline lineno="169"><highlight class="normal">}</highlight></codeline>
<codeline lineno="170"><highlight class="normal"></highlight></codeline>
<codeline lineno="171"><highlight class="normal"></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="182"><highlight class="normal">std::optional&lt;std::vector&lt;int&gt;&gt;<sp/>CalculatePrevHeights(</highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>&amp;<sp/>tip,</highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_coins_view" kindref="compound">CCoinsView</ref>&amp;<sp/>coins,</highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_transaction" kindref="compound">CTransaction</ref>&amp;<sp/>tx)</highlight></codeline>
<codeline lineno="186"><highlight class="normal">{</highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;int&gt;<sp/>prev_heights;</highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><sp/><sp/>prev_heights.resize(tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>.size());</highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>.size();<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>coin{coins.<ref refid="class_c_coins_view_1a61b812f0303e2e66dcbdd78992bf3478" kindref="member">GetCoin</ref>(tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>[i].prevout)})<sp/>{</highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prev_heights[i]<sp/>=<sp/>coin-&gt;nHeight<sp/>==<sp/>MEMPOOL_HEIGHT</highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>?<sp/>tip.<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>+<sp/>1<sp/></highlight><highlight class="comment">//<sp/>Assume<sp/>all<sp/>mempool<sp/>transaction<sp/>confirm<sp/>in<sp/>the<sp/>next<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>:<sp/>coin-&gt;nHeight;</highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;ERROR:<sp/>%s:<sp/>Missing<sp/>input<sp/>%d<sp/>in<sp/>transaction<sp/>\&apos;%s\&apos;\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>i,<sp/>tx.<ref refid="class_c_transaction_1a919ff1093793433f4717d74fb751423b" kindref="member">GetHash</ref>().<ref refid="classtransaction__identifier_1a312eb7d0b83837e9d7597a27f1c545a8" kindref="member">GetHex</ref>());</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::nullopt;</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>prev_heights;</highlight></codeline>
<codeline lineno="200"><highlight class="normal">}</highlight></codeline>
<codeline lineno="201"><highlight class="normal">}<sp/></highlight><highlight class="comment">//<sp/>namespace</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="202"><highlight class="normal"></highlight></codeline>
<codeline lineno="203"><highlight class="normal">std::optional&lt;LockPoints&gt;<sp/><ref refid="validation_8h_1a32144d8c77b444fd1bacffc7de991a8a" kindref="member">CalculateLockPointsAtTip</ref>(</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>tip,</highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_coins_view" kindref="compound">CCoinsView</ref>&amp;<sp/>coins_view,</highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_transaction" kindref="compound">CTransaction</ref>&amp;<sp/>tx)</highlight></codeline>
<codeline lineno="207"><highlight class="normal">{</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(tip);</highlight></codeline>
<codeline lineno="209"><highlight class="normal"></highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>prev_heights{CalculatePrevHeights(*tip,<sp/>coins_view,<sp/>tx)};</highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!prev_heights.has_value())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::nullopt;</highlight></codeline>
<codeline lineno="212"><highlight class="normal"></highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref><sp/>next_tip;</highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/>next_tip.<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>=<sp/>tip;</highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When<sp/>SequenceLocks()<sp/>is<sp/>called<sp/>within<sp/>ConnectBlock(),<sp/>the<sp/>height</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="216"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>of<sp/>the<sp/>block<sp/>*being*<sp/>evaluated<sp/>is<sp/>what<sp/>is<sp/>used.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="217"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Thus<sp/>if<sp/>we<sp/>want<sp/>to<sp/>know<sp/>if<sp/>a<sp/>transaction<sp/>can<sp/>be<sp/>part<sp/>of<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="218"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>*next*<sp/>block,<sp/>we<sp/>need<sp/>to<sp/>use<sp/>one<sp/>more<sp/>than<sp/>active_chainstate.m_chain.Height()</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="219"><highlight class="normal"><sp/><sp/><sp/><sp/>next_tip.<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>=<sp/>tip-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="220"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>[min_height,<sp/>min_time]<sp/>=<sp/><ref refid="tx__verify_8cpp_1abc528b150bf26a1644aef9713336dda2" kindref="member">CalculateSequenceLocks</ref>(tx,<sp/>STANDARD_LOCKTIME_VERIFY_FLAGS,<sp/>prev_heights.value(),<sp/>next_tip);</highlight></codeline>
<codeline lineno="221"><highlight class="normal"></highlight></codeline>
<codeline lineno="222"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Also<sp/>store<sp/>the<sp/>hash<sp/>of<sp/>the<sp/>block<sp/>with<sp/>the<sp/>highest<sp/>height<sp/>of</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="223"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>all<sp/>the<sp/>blocks<sp/>which<sp/>have<sp/>sequence<sp/>locked<sp/>prevouts.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>hash<sp/>needs<sp/>to<sp/>still<sp/>be<sp/>on<sp/>the<sp/>chain</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>for<sp/>these<sp/>LockPoint<sp/>calculations<sp/>to<sp/>be<sp/>valid</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note:<sp/>It<sp/>is<sp/>impossible<sp/>to<sp/>correctly<sp/>calculate<sp/>a<sp/>maxInputBlock</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>any<sp/>of<sp/>the<sp/>sequence<sp/>locked<sp/>inputs<sp/>depend<sp/>on<sp/>unconfirmed<sp/>txs,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>except<sp/>in<sp/>the<sp/>special<sp/>case<sp/>where<sp/>the<sp/>relative<sp/>lock<sp/>time/height</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="229"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>is<sp/>0,<sp/>which<sp/>is<sp/>equivalent<sp/>to<sp/>no<sp/>sequence<sp/>lock.<sp/>Since<sp/>we<sp/>assume</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>input<sp/>height<sp/>of<sp/>tip+1<sp/>for<sp/>mempool<sp/>txs<sp/>and<sp/>test<sp/>the<sp/>resulting</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="231"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>min_height<sp/>and<sp/>min_time<sp/>from<sp/>CalculateSequenceLocks<sp/>against<sp/>tip+1.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="232"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>max_input_height{0};</highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>height<sp/>:<sp/>prev_heights.value())<sp/>{</highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Can<sp/>ignore<sp/>mempool<sp/>inputs<sp/>since<sp/>we&apos;ll<sp/>fail<sp/>if<sp/>they<sp/>had<sp/>non-zero<sp/>locks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(height<sp/>!=<sp/>next_tip.<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>)<sp/>{</highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_input_height<sp/>=<sp/>std::max(max_input_height,<sp/>height);</highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="238"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="239"><highlight class="normal"></highlight></codeline>
<codeline lineno="240"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>tip-&gt;GetAncestor(max_input_height)<sp/>should<sp/>never<sp/>return<sp/>a<sp/>nullptr</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="241"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>because<sp/>max_input_height<sp/>is<sp/>always<sp/>less<sp/>than<sp/>the<sp/>tip<sp/>height.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="242"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>It<sp/>would,<sp/>however,<sp/>be<sp/>a<sp/>bad<sp/>bug<sp/>to<sp/>continue<sp/>execution,<sp/>since<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="243"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>LockPoints<sp/>object<sp/>with<sp/>the<sp/>maxInputBlock<sp/>member<sp/>set<sp/>to<sp/>nullptr</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="244"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>signifies<sp/>no<sp/>relative<sp/>lock<sp/>time.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="245"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_lock_points" kindref="compound">LockPoints</ref>{min_height,<sp/>min_time,<sp/><ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(tip-&gt;<ref refid="class_c_block_index_1ac20120d6b64792647a63d216b26e4b53" kindref="member">GetAncestor</ref>(max_input_height))};</highlight></codeline>
<codeline lineno="246"><highlight class="normal">}</highlight></codeline>
<codeline lineno="247"><highlight class="normal"></highlight></codeline>
<codeline lineno="248"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="validation_8cpp_1a4bb60528a48d01c047a4b004e13136ff" kindref="member">CheckSequenceLocksAtTip</ref>(<ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>tip,</highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_lock_points" kindref="compound">LockPoints</ref>&amp;<sp/>lock_points)</highlight></codeline>
<codeline lineno="250"><highlight class="normal">{</highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(tip<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="252"><highlight class="normal"></highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref><sp/>index;</highlight></codeline>
<codeline lineno="254"><highlight class="normal"><sp/><sp/><sp/><sp/>index.<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>=<sp/>tip;</highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>CheckSequenceLocksAtTip()<sp/>uses<sp/>active_chainstate.m_chain.Height()+1<sp/>to<sp/>evaluate</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>height<sp/>based<sp/>locks<sp/>because<sp/>when<sp/>SequenceLocks()<sp/>is<sp/>called<sp/>within</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ConnectBlock(),<sp/>the<sp/>height<sp/>of<sp/>the<sp/>block<sp/>*being*</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>evaluated<sp/>is<sp/>what<sp/>is<sp/>used.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Thus<sp/>if<sp/>we<sp/>want<sp/>to<sp/>know<sp/>if<sp/>a<sp/>transaction<sp/>can<sp/>be<sp/>part<sp/>of<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>*next*<sp/>block,<sp/>we<sp/>need<sp/>to<sp/>use<sp/>one<sp/>more<sp/>than<sp/>active_chainstate.m_chain.Height()</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/><sp/><sp/>index.<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>=<sp/>tip-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="262"><highlight class="normal"></highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="tx__verify_8cpp_1ab6bb0246e751e82b8d6e3c97ed88b839" kindref="member">EvaluateSequenceLocks</ref>(index,<sp/>{lock_points.<ref refid="struct_lock_points_1ad12fc34ce789bce6c8a05d8a17138534" kindref="member">height</ref>,<sp/>lock_points.<ref refid="struct_lock_points_1aee52de7b225665566aa47246b9d6b8fa" kindref="member">time</ref>});</highlight></codeline>
<codeline lineno="264"><highlight class="normal">}</highlight></codeline>
<codeline lineno="265"><highlight class="normal"></highlight></codeline>
<codeline lineno="266"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>LimitMempoolSize(<ref refid="class_c_tx_mem_pool" kindref="compound">CTxMemPool</ref>&amp;<sp/>pool,<sp/><ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref>&amp;<sp/>coins_cache)</highlight></codeline>
<codeline lineno="267"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>,<sp/>pool.cs)</highlight></codeline>
<codeline lineno="268"><highlight class="normal">{</highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(pool.cs);</highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>expired<sp/>=<sp/>pool.Expire(<ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime&lt;std::chrono::seconds&gt;</ref>()<sp/>-<sp/>pool.m_opts.expiry);</highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(expired<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="273"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395afb374f9d778e803545f3af036ca147a0" kindref="member">BCLog::MEMPOOL</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Expired<sp/>%i<sp/>transactions<sp/>from<sp/>the<sp/>memory<sp/>pool\n&quot;</highlight><highlight class="normal">,<sp/>expired);</highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="275"><highlight class="normal"></highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;COutPoint&gt;<sp/>vNoSpendsRemaining;</highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/>pool.TrimToSize(pool.m_opts.max_size_bytes,<sp/>&amp;vNoSpendsRemaining);</highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_out_point" kindref="compound">COutPoint</ref>&amp;<sp/>removed<sp/>:<sp/>vNoSpendsRemaining)</highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_cache.Uncache(removed);</highlight></codeline>
<codeline lineno="280"><highlight class="normal">}</highlight></codeline>
<codeline lineno="281"><highlight class="normal"></highlight></codeline>
<codeline lineno="282"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>IsCurrentForFeeEstimation(<ref refid="class_chainstate" kindref="compound">Chainstate</ref>&amp;<sp/>active_chainstate)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>)</highlight></codeline>
<codeline lineno="283"><highlight class="normal">{</highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(active_chainstate.m_chainman.IsInitialBlockDownload())<sp/>{</highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(active_chainstate.m_chain.Tip()-&gt;GetBlockTime()<sp/>&lt;<sp/><ref refid="util_2time_8h_1a888f421c54ec4d38a01dd0f7ddacd6a6" kindref="member">count_seconds</ref>(<ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime&lt;std::chrono::seconds&gt;</ref>()<sp/>-<sp/>MAX_FEE_ESTIMATION_TIP_AGE))</highlight></codeline>
<codeline lineno="289"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(active_chainstate.m_chain.Height()<sp/>&lt;<sp/>active_chainstate.m_chainman.m_best_header-&gt;nHeight<sp/>-<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="294"><highlight class="normal">}</highlight></codeline>
<codeline lineno="295"><highlight class="normal"></highlight></codeline>
<codeline lineno="296"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1a6382a5c89f0cc48c00603fdfb6426caa" kindref="member">Chainstate::MaybeUpdateMempoolForReorg</ref>(</highlight></codeline>
<codeline lineno="297"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_disconnected_block_transactions" kindref="compound">DisconnectedBlockTransactions</ref>&amp;<sp/>disconnectpool,</highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fAddToMempool)</highlight></codeline>
<codeline lineno="299"><highlight class="normal">{</highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="301"><highlight class="normal"></highlight></codeline>
<codeline lineno="302"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>-&gt;cs);</highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;Txid&gt;<sp/>vHashUpdate;</highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>disconnectpool<sp/>is<sp/>ordered<sp/>so<sp/>that<sp/>the<sp/>front<sp/>is<sp/>the<sp/>most<sp/>recently-confirmed</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transaction<sp/>(the<sp/>last<sp/>tx<sp/>of<sp/>the<sp/>block<sp/>at<sp/>the<sp/>tip)<sp/>in<sp/>the<sp/>disconnected<sp/>chain.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Iterate<sp/>disconnectpool<sp/>in<sp/>reverse,<sp/>so<sp/>that<sp/>we<sp/>add<sp/>transactions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>back<sp/>to<sp/>the<sp/>mempool<sp/>starting<sp/>with<sp/>the<sp/>earliest<sp/>transaction<sp/>that<sp/>had</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>been<sp/>previously<sp/>seen<sp/>in<sp/>a<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>queuedTx<sp/>=<sp/>disconnectpool.<ref refid="class_disconnected_block_transactions_1a4c515d69876e67351a7cdbb6d261dc21" kindref="member">take</ref>();</highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it<sp/>=<sp/>queuedTx.rbegin();</highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(it<sp/>!=<sp/>queuedTx.rend())<sp/>{</highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ignore<sp/>validation<sp/>errors<sp/>in<sp/>resurrected<sp/>transactions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!fAddToMempool<sp/>||<sp/>(*it)-&gt;IsCoinBase()<sp/>||</highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8h_1a5f178a2bb141cae949283673ad12ca6b" kindref="member">AcceptToMemoryPool</ref>(*</highlight><highlight class="keyword">this</highlight><highlight class="normal">,<sp/>*it,<sp/><ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime</ref>(),</highlight></codeline>
<codeline lineno="317"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*bypass_limits=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">,<sp/></highlight><highlight class="comment">/*test_accept=*/</highlight><highlight class="keyword">false</highlight><highlight class="normal">).m_result_type<sp/>!=</highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_mempool_accept_result_1aa71b5fc2a82d29a91db3a734ff892a49ac9f1a6384b1c466d4612f513bd8e13ea" kindref="member">MempoolAcceptResult::ResultType::VALID</ref>)<sp/>{</highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>transaction<sp/>doesn&apos;t<sp/>make<sp/>it<sp/>in<sp/>to<sp/>the<sp/>mempool,<sp/>remove<sp/>any</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transactions<sp/>that<sp/>depend<sp/>on<sp/>it<sp/>(which<sp/>would<sp/>now<sp/>be<sp/>orphans).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>-&gt;removeRecursive(**it,<sp/><ref refid="mempool__removal__reason_8h_1a2bc6653552b5871101b6cbefdbaf251fae8dd7fa48e6491a8929b38fa835dd1c6" kindref="member">MemPoolRemovalReason::REORG</ref>);</highlight></codeline>
<codeline lineno="322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>-&gt;exists((*it)-&gt;GetHash()))<sp/>{</highlight></codeline>
<codeline lineno="323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vHashUpdate.push_back((*it)-&gt;GetHash());</highlight></codeline>
<codeline lineno="324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++it;</highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="328"><highlight class="normal"></highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>AcceptToMemoryPool/addNewTransaction<sp/>all<sp/>assume<sp/>that<sp/>new<sp/>mempool<sp/>entries<sp/>have</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>no<sp/>in-mempool<sp/>children,<sp/>which<sp/>is<sp/>generally<sp/>not<sp/>true<sp/>when<sp/>adding</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>previously-confirmed<sp/>transactions<sp/>back<sp/>to<sp/>the<sp/>mempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>UpdateTransactionsFromBlock<sp/>finds<sp/>descendants<sp/>of<sp/>any<sp/>transactions<sp/>in</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>disconnectpool<sp/>that<sp/>were<sp/>added<sp/>back<sp/>and<sp/>cleans<sp/>up<sp/>the<sp/>mempool<sp/>state.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>-&gt;UpdateTransactionsFromBlock(vHashUpdate);</highlight></codeline>
<codeline lineno="335"><highlight class="normal"></highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Predicate<sp/>to<sp/>use<sp/>for<sp/>filtering<sp/>transactions<sp/>in<sp/>removeForReorg.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Checks<sp/>whether<sp/>the<sp/>transaction<sp/>is<sp/>still<sp/>final<sp/>and,<sp/>if<sp/>it<sp/>spends<sp/>a<sp/>coinbase<sp/>output,<sp/>mature.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="338"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Also<sp/>updates<sp/>valid<sp/>entries&apos;<sp/>cached<sp/>LockPoints<sp/>if<sp/>needed.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>false,<sp/>the<sp/>tx<sp/>is<sp/>still<sp/>valid<sp/>and<sp/>its<sp/>lockpoints<sp/>are<sp/>updated.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>true,<sp/>the<sp/>tx<sp/>would<sp/>be<sp/>invalid<sp/>in<sp/>the<sp/>next<sp/>block;<sp/>remove<sp/>this<sp/>entry<sp/>and<sp/>all<sp/>of<sp/>its<sp/>descendants.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="341"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note<sp/>that<sp/>TRUC<sp/>rules<sp/>are<sp/>not<sp/>applied<sp/>here,<sp/>so<sp/>reorgs<sp/>may<sp/>cause<sp/>violations<sp/>of<sp/>TRUC<sp/>inheritance<sp/>or</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>topology<sp/>restrictions.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>filter_final_and_mature<sp/>=<sp/>[&amp;](<ref refid="class_c_tx_mem_pool_1abd8c1d2efe4dbb1d8eb1c86646dd4b00" kindref="member">CTxMemPool::txiter</ref><sp/>it)</highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>-&gt;cs,<sp/><ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>)<sp/>{</highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>-&gt;cs);</highlight></codeline>
<codeline lineno="346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CTransaction&amp;<sp/>tx<sp/>=<sp/>it-&gt;GetTx();</highlight></codeline>
<codeline lineno="348"><highlight class="normal"></highlight></codeline>
<codeline lineno="349"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>transaction<sp/>must<sp/>be<sp/>final.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="validation_8cpp_1a3b90ca0d639cfea2208c7c0aa5118aaa" kindref="member">CheckFinalTxAtTip</ref>(*<ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip()),<sp/>tx))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="351"><highlight class="normal"></highlight></codeline>
<codeline lineno="352"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>LockPoints&amp;<sp/><ref refid="mempool__ephemeral__spends_8cpp_1ad9fc5be56aa884a443262a52de4ed5f6" kindref="member">lp</ref><sp/>=<sp/>it-&gt;GetLockPoints();</highlight></codeline>
<codeline lineno="353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>CheckSequenceLocksAtTip<sp/>checks<sp/>if<sp/>the<sp/>transaction<sp/>will<sp/>be<sp/>final<sp/>in<sp/>the<sp/>next<sp/>block<sp/>to<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>created<sp/>on<sp/>top<sp/>of<sp/>the<sp/>new<sp/>chain.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="355"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="txmempool_8cpp_1ad61fa00c366181debb1c3a0c46ff3df9" kindref="member">TestLockPointValidity</ref>(<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>,<sp/><ref refid="mempool__ephemeral__spends_8cpp_1ad9fc5be56aa884a443262a52de4ed5f6" kindref="member">lp</ref>))<sp/>{</highlight></codeline>
<codeline lineno="356"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="validation_8h_1a4bb60528a48d01c047a4b004e13136ff" kindref="member">CheckSequenceLocksAtTip</ref>(<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip(),<sp/><ref refid="mempool__ephemeral__spends_8cpp_1ad9fc5be56aa884a443262a52de4ed5f6" kindref="member">lp</ref>))<sp/>{</highlight></codeline>
<codeline lineno="357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CCoinsViewMemPool<sp/>view_mempool{&amp;<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>(),<sp/>*<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>};</highlight></codeline>
<codeline lineno="361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::optional&lt;LockPoints&gt;<sp/>new_lock_points{<ref refid="validation_8h_1a32144d8c77b444fd1bacffc7de991a8a" kindref="member">CalculateLockPointsAtTip</ref>(<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip(),<sp/>view_mempool,<sp/>tx)};</highlight></codeline>
<codeline lineno="362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(new_lock_points.has_value()<sp/>&amp;&amp;<sp/><ref refid="validation_8h_1a4bb60528a48d01c047a4b004e13136ff" kindref="member">CheckSequenceLocksAtTip</ref>(<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip(),<sp/>*new_lock_points))<sp/>{</highlight></codeline>
<codeline lineno="363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Now<sp/>update<sp/>the<sp/>mempool<sp/>entry<sp/>lockpoints<sp/>as<sp/>well.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>it-&gt;UpdateLockPoints(*new_lock_points);</highlight></codeline>
<codeline lineno="365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="366"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="369"><highlight class="normal"></highlight></codeline>
<codeline lineno="370"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>transaction<sp/>spends<sp/>any<sp/>coinbase<sp/>outputs,<sp/>it<sp/>must<sp/>be<sp/>mature.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="371"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it-&gt;GetSpendsCoinbase())<sp/>{</highlight></codeline>
<codeline lineno="372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CTxIn&amp;<sp/>txin<sp/>:<sp/>tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>)<sp/>{</highlight></codeline>
<codeline lineno="373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>-&gt;exists(txin.<ref refid="class_c_tx_in_1a1c567359e133d98c72b5e9a928ffd41a" kindref="member">prevout</ref>.<ref refid="class_c_out_point_1a021232319a9e2a4d04c8c9a95e66c96f" kindref="member">hash</ref>))<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Coin&amp;<sp/>coin{<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>().<ref refid="class_c_coins_view_cache_1a87f1f2449e10859291ddbdc1d090cba3" kindref="member">AccessCoin</ref>(txin.<ref refid="class_c_tx_in_1a1c567359e133d98c72b5e9a928ffd41a" kindref="member">prevout</ref>)};</highlight></codeline>
<codeline lineno="375"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!coin.<ref refid="class_coin_1ae0032141d9e76130a91e97e19eaad1ec" kindref="member">IsSpent</ref>());</highlight></codeline>
<codeline lineno="376"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>mempool_spend_height{<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip()-&gt;nHeight<sp/>+<sp/>1};</highlight></codeline>
<codeline lineno="377"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(coin.<ref refid="class_coin_1a6b4def31a0a2fbc975d0087ad2d4391a" kindref="member">IsCoinBase</ref>()<sp/>&amp;&amp;<sp/>mempool_spend_height<sp/>-<sp/>coin.<ref refid="class_coin_1a83c6e5c63b15b7acaec51e3bb857fe16" kindref="member">nHeight</ref><sp/>&lt;<sp/>COINBASE_MATURITY)<sp/>{</highlight></codeline>
<codeline lineno="378"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="379"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="380"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="381"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Transaction<sp/>is<sp/>still<sp/>valid<sp/>and<sp/>cached<sp/>LockPoints<sp/>are<sp/>updated.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="383"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="385"><highlight class="normal"></highlight></codeline>
<codeline lineno="386"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>also<sp/>need<sp/>to<sp/>remove<sp/>any<sp/>now-immature<sp/>transactions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="387"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>-&gt;removeForReorg(<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>,<sp/>filter_final_and_mature);</highlight></codeline>
<codeline lineno="388"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Re-limit<sp/>mempool<sp/>size,<sp/>in<sp/>case<sp/>we<sp/>added<sp/>any<sp/>transactions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="389"><highlight class="normal"><sp/><sp/><sp/><sp/>LimitMempoolSize(*<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>,<sp/>this-&gt;<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>());</highlight></codeline>
<codeline lineno="390"><highlight class="normal">}</highlight></codeline>
<codeline lineno="391"><highlight class="normal"></highlight></codeline>
<codeline lineno="397"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CheckInputsFromMempoolAndCache(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_transaction" kindref="compound">CTransaction</ref>&amp;<sp/>tx,<sp/><ref refid="class_tx_validation_state" kindref="compound">TxValidationState</ref>&amp;<sp/>state,</highlight></codeline>
<codeline lineno="398"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref>&amp;<sp/>view,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_tx_mem_pool" kindref="compound">CTxMemPool</ref>&amp;<sp/>pool,</highlight></codeline>
<codeline lineno="399"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classscript__verify__flags" kindref="compound">script_verify_flags</ref><sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref>,<sp/><ref refid="struct_precomputed_transaction_data" kindref="compound">PrecomputedTransactionData</ref>&amp;<sp/>txdata,<sp/><ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref>&amp;<sp/>coins_tip,</highlight></codeline>
<codeline lineno="400"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_validation_cache" kindref="compound">ValidationCache</ref>&amp;<sp/>validation_cache)</highlight></codeline>
<codeline lineno="401"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>pool.cs)</highlight></codeline>
<codeline lineno="402"><highlight class="normal">{</highlight></codeline>
<codeline lineno="403"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(pool.cs);</highlight></codeline>
<codeline lineno="405"><highlight class="normal"></highlight></codeline>
<codeline lineno="406"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!tx.<ref refid="class_c_transaction_1a6b4def31a0a2fbc975d0087ad2d4391a" kindref="member">IsCoinBase</ref>());</highlight></codeline>
<codeline lineno="407"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_tx_in" kindref="compound">CTxIn</ref>&amp;<sp/>txin<sp/>:<sp/>tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>)<sp/>{</highlight></codeline>
<codeline lineno="408"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_coin" kindref="compound">Coin</ref>&amp;<sp/>coin<sp/>=<sp/>view.AccessCoin(txin.<ref refid="class_c_tx_in_1a1c567359e133d98c72b5e9a928ffd41a" kindref="member">prevout</ref>);</highlight></codeline>
<codeline lineno="409"><highlight class="normal"></highlight></codeline>
<codeline lineno="410"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>coin<sp/>was<sp/>checked<sp/>in<sp/>PreChecks<sp/>and<sp/>MemPoolAccept</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>has<sp/>been<sp/>holding<sp/>cs_main<sp/>since<sp/>then.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="412"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(!coin.<ref refid="class_coin_1ae0032141d9e76130a91e97e19eaad1ec" kindref="member">IsSpent</ref>());</highlight></codeline>
<codeline lineno="413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(coin.<ref refid="class_coin_1ae0032141d9e76130a91e97e19eaad1ec" kindref="member">IsSpent</ref>())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="414"><highlight class="normal"></highlight></codeline>
<codeline lineno="415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>Coin<sp/>is<sp/>available,<sp/>there<sp/>are<sp/>2<sp/>possibilities:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="416"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>it<sp/>is<sp/>available<sp/>in<sp/>our<sp/>current<sp/>ChainstateActive<sp/>UTXO<sp/>set,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="417"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>or<sp/>it&apos;s<sp/>a<sp/>UTXO<sp/>provided<sp/>by<sp/>a<sp/>transaction<sp/>in<sp/>our<sp/>mempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="418"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ensure<sp/>the<sp/>scriptPubKeys<sp/>in<sp/>Coins<sp/>from<sp/>CoinsView<sp/>are<sp/>correct.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref>&amp;<sp/>txFrom<sp/>=<sp/>pool.get(txin.<ref refid="class_c_tx_in_1a1c567359e133d98c72b5e9a928ffd41a" kindref="member">prevout</ref>.<ref refid="class_c_out_point_1a021232319a9e2a4d04c8c9a95e66c96f" kindref="member">hash</ref>);</highlight></codeline>
<codeline lineno="420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(txFrom)<sp/>{</highlight></codeline>
<codeline lineno="421"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(txFrom-&gt;GetHash()<sp/>==<sp/>txin.<ref refid="class_c_tx_in_1a1c567359e133d98c72b5e9a928ffd41a" kindref="member">prevout</ref>.<ref refid="class_c_out_point_1a021232319a9e2a4d04c8c9a95e66c96f" kindref="member">hash</ref>);</highlight></codeline>
<codeline lineno="422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(txFrom-&gt;vout.size()<sp/>&gt;<sp/>txin.<ref refid="class_c_tx_in_1a1c567359e133d98c72b5e9a928ffd41a" kindref="member">prevout</ref>.<ref refid="class_c_out_point_1a3d8a9527a2ee4a7ebf59175650142e75" kindref="member">n</ref>);</highlight></codeline>
<codeline lineno="423"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(txFrom-&gt;vout[txin.<ref refid="class_c_tx_in_1a1c567359e133d98c72b5e9a928ffd41a" kindref="member">prevout</ref>.<ref refid="class_c_out_point_1a3d8a9527a2ee4a7ebf59175650142e75" kindref="member">n</ref>]<sp/>==<sp/>coin.<ref refid="class_coin_1adafe93fbab174bb8f09c8a3b9df178fa" kindref="member">out</ref>);</highlight></codeline>
<codeline lineno="424"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="425"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_coin" kindref="compound">Coin</ref>&amp;<sp/>coinFromUTXOSet<sp/>=<sp/>coins_tip.AccessCoin(txin.<ref refid="class_c_tx_in_1a1c567359e133d98c72b5e9a928ffd41a" kindref="member">prevout</ref>);</highlight></codeline>
<codeline lineno="426"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!coinFromUTXOSet.<ref refid="class_coin_1ae0032141d9e76130a91e97e19eaad1ec" kindref="member">IsSpent</ref>());</highlight></codeline>
<codeline lineno="427"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(coinFromUTXOSet.<ref refid="class_coin_1adafe93fbab174bb8f09c8a3b9df178fa" kindref="member">out</ref><sp/>==<sp/>coin.<ref refid="class_coin_1adafe93fbab174bb8f09c8a3b9df178fa" kindref="member">out</ref>);</highlight></codeline>
<codeline lineno="428"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="429"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="430"><highlight class="normal"></highlight></codeline>
<codeline lineno="431"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Call<sp/>CheckInputScripts()<sp/>to<sp/>cache<sp/>signature<sp/>and<sp/>script<sp/>validity<sp/>against<sp/>current<sp/>tip<sp/>consensus<sp/>rules.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="432"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8cpp_1af9f454ea56c86078990a64f3fe8e72e2" kindref="member">CheckInputScripts</ref>(tx,<sp/>state,<sp/>view,<sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref>,<sp/></highlight><highlight class="comment">/*<sp/>cacheSigStore=<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">,<sp/></highlight><highlight class="comment">/*<sp/>cacheFullScriptStore=<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">,<sp/>txdata,<sp/>validation_cache);</highlight></codeline>
<codeline lineno="433"><highlight class="normal">}</highlight></codeline>
<codeline lineno="434"><highlight class="normal"></highlight></codeline>
<codeline lineno="435"><highlight class="normal"></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="436"><highlight class="normal"></highlight></codeline>
<codeline lineno="437"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal">MemPoolAccept</highlight></codeline>
<codeline lineno="438"><highlight class="normal">{</highlight></codeline>
<codeline lineno="439"><highlight class="normal"></highlight><highlight class="keyword">public</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="440"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">explicit</highlight><highlight class="normal"><sp/>MemPoolAccept(CTxMemPool&amp;<sp/>mempool,<sp/>Chainstate&amp;<sp/>active_chainstate)<sp/>:</highlight></codeline>
<codeline lineno="441"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_pool(mempool),</highlight></codeline>
<codeline lineno="442"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_view(&amp;m_dummy),</highlight></codeline>
<codeline lineno="443"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_viewmempool(&amp;active_chainstate.CoinsTip(),<sp/>m_pool),</highlight></codeline>
<codeline lineno="444"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_active_chainstate(active_chainstate)</highlight></codeline>
<codeline lineno="445"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="446"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="447"><highlight class="normal"></highlight></codeline>
<codeline lineno="448"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>put<sp/>the<sp/>arguments<sp/>we&apos;re<sp/>handed<sp/>into<sp/>a<sp/>struct,<sp/>so<sp/>we<sp/>can<sp/>pass<sp/>them</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="449"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>around<sp/>easier.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="450"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">ATMPArgs<sp/>{</highlight></codeline>
<codeline lineno="451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CChainParams&amp;<sp/>m_chainparams;</highlight></codeline>
<codeline lineno="452"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>int64_t<sp/>m_accept_time;</highlight></codeline>
<codeline lineno="453"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_bypass_limits;</highlight></codeline>
<codeline lineno="454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*</highlight></codeline>
<codeline lineno="455"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*<sp/>Return<sp/>any<sp/>outpoints<sp/>which<sp/>were<sp/>not<sp/>previously<sp/>present<sp/>in<sp/>the<sp/>coins</highlight></codeline>
<codeline lineno="456"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*<sp/>cache,<sp/>but<sp/>were<sp/>added<sp/>as<sp/>a<sp/>result<sp/>of<sp/>validating<sp/>the<sp/>tx<sp/>for<sp/>mempool</highlight></codeline>
<codeline lineno="457"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*<sp/>acceptance.<sp/>This<sp/>allows<sp/>the<sp/>caller<sp/>to<sp/>optionally<sp/>remove<sp/>the<sp/>cache</highlight></codeline>
<codeline lineno="458"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*<sp/>additions<sp/>if<sp/>the<sp/>associated<sp/>transaction<sp/>ends<sp/>up<sp/>being<sp/>rejected<sp/>by</highlight></codeline>
<codeline lineno="459"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*<sp/>the<sp/>mempool.</highlight></codeline>
<codeline lineno="460"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="461"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;COutPoint&gt;&amp;<sp/>m_coins_to_uncache;</highlight></codeline>
<codeline lineno="463"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_test_accept;</highlight></codeline>
<codeline lineno="467"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_allow_replacement;</highlight></codeline>
<codeline lineno="469"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_allow_sibling_eviction;</highlight></codeline>
<codeline lineno="472"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_package_submission;</highlight></codeline>
<codeline lineno="476"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_package_feerates;</highlight></codeline>
<codeline lineno="481"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::optional&lt;CFeeRate&gt;<sp/>m_client_maxfeerate;</highlight></codeline>
<codeline lineno="482"><highlight class="normal"></highlight></codeline>
<codeline lineno="484"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>ATMPArgs<sp/>SingleAccept(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CChainParams&amp;<sp/>chainparams,<sp/>int64_t<sp/>accept_time,</highlight></codeline>
<codeline lineno="485"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>bypass_limits,<sp/>std::vector&lt;COutPoint&gt;&amp;<sp/>coins_to_uncache,</highlight></codeline>
<codeline lineno="486"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>test_accept)<sp/>{</highlight></codeline>
<codeline lineno="487"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ATMPArgs{</highlight><highlight class="comment">/*<sp/>m_chainparams<sp/>*/</highlight><highlight class="normal"><sp/>chainparams,</highlight></codeline>
<codeline lineno="488"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_accept_time<sp/>*/</highlight><highlight class="normal"><sp/>accept_time,</highlight></codeline>
<codeline lineno="489"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_bypass_limits<sp/>*/</highlight><highlight class="normal"><sp/>bypass_limits,</highlight></codeline>
<codeline lineno="490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_coins_to_uncache<sp/>*/</highlight><highlight class="normal"><sp/>coins_to_uncache,</highlight></codeline>
<codeline lineno="491"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_test_accept<sp/>*/</highlight><highlight class="normal"><sp/>test_accept,</highlight></codeline>
<codeline lineno="492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_allow_replacement<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_allow_sibling_eviction<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_package_submission<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="495"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_package_feerates<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="496"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_client_maxfeerate<sp/>*/</highlight><highlight class="normal"><sp/>{},<sp/></highlight><highlight class="comment">//<sp/>checked<sp/>by<sp/>caller</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="497"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="499"><highlight class="normal"></highlight></codeline>
<codeline lineno="501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>ATMPArgs<sp/>PackageTestAccept(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CChainParams&amp;<sp/>chainparams,<sp/>int64_t<sp/>accept_time,</highlight></codeline>
<codeline lineno="502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;COutPoint&gt;&amp;<sp/>coins_to_uncache)<sp/>{</highlight></codeline>
<codeline lineno="503"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ATMPArgs{</highlight><highlight class="comment">/*<sp/>m_chainparams<sp/>*/</highlight><highlight class="normal"><sp/>chainparams,</highlight></codeline>
<codeline lineno="504"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_accept_time<sp/>*/</highlight><highlight class="normal"><sp/>accept_time,</highlight></codeline>
<codeline lineno="505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_bypass_limits<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_coins_to_uncache<sp/>*/</highlight><highlight class="normal"><sp/>coins_to_uncache,</highlight></codeline>
<codeline lineno="507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_test_accept<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="508"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_allow_replacement<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="509"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_allow_sibling_eviction<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_package_submission<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">,<sp/></highlight><highlight class="comment">//<sp/>not<sp/>submitting<sp/>to<sp/>mempool</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_package_feerates<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_client_maxfeerate<sp/>*/</highlight><highlight class="normal"><sp/>{},<sp/></highlight><highlight class="comment">//<sp/>checked<sp/>by<sp/>caller</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="513"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="515"><highlight class="normal"></highlight></codeline>
<codeline lineno="517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>ATMPArgs<sp/>PackageChildWithParents(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CChainParams&amp;<sp/>chainparams,<sp/>int64_t<sp/>accept_time,</highlight></codeline>
<codeline lineno="518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;COutPoint&gt;&amp;<sp/>coins_to_uncache,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::optional&lt;CFeeRate&gt;&amp;<sp/>client_maxfeerate)<sp/>{</highlight></codeline>
<codeline lineno="519"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ATMPArgs{</highlight><highlight class="comment">/*<sp/>m_chainparams<sp/>*/</highlight><highlight class="normal"><sp/>chainparams,</highlight></codeline>
<codeline lineno="520"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_accept_time<sp/>*/</highlight><highlight class="normal"><sp/>accept_time,</highlight></codeline>
<codeline lineno="521"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_bypass_limits<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_coins_to_uncache<sp/>*/</highlight><highlight class="normal"><sp/>coins_to_uncache,</highlight></codeline>
<codeline lineno="523"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_test_accept<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_allow_replacement<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_allow_sibling_eviction<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="526"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_package_submission<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="527"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_package_feerates<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="528"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_client_maxfeerate<sp/>*/</highlight><highlight class="normal"><sp/>client_maxfeerate,</highlight></codeline>
<codeline lineno="529"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="530"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="531"><highlight class="normal"></highlight></codeline>
<codeline lineno="533"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>ATMPArgs<sp/>SingleInPackageAccept(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>ATMPArgs&amp;<sp/>package_args)<sp/>{</highlight></codeline>
<codeline lineno="534"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ATMPArgs{</highlight><highlight class="comment">/*<sp/>m_chainparams<sp/>*/</highlight><highlight class="normal"><sp/>package_args.m_chainparams,</highlight></codeline>
<codeline lineno="535"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_accept_time<sp/>*/</highlight><highlight class="normal"><sp/>package_args.m_accept_time,</highlight></codeline>
<codeline lineno="536"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_bypass_limits<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="537"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_coins_to_uncache<sp/>*/</highlight><highlight class="normal"><sp/>package_args.m_coins_to_uncache,</highlight></codeline>
<codeline lineno="538"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_test_accept<sp/>*/</highlight><highlight class="normal"><sp/>package_args.m_test_accept,</highlight></codeline>
<codeline lineno="539"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_allow_replacement<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="540"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_allow_sibling_eviction<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="541"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_package_submission<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">,<sp/></highlight><highlight class="comment">//<sp/>trim<sp/>at<sp/>the<sp/>end<sp/>of<sp/>AcceptPackage()</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="542"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_package_feerates<sp/>*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">,<sp/></highlight><highlight class="comment">//<sp/>only<sp/>1<sp/>transaction</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="543"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>m_client_maxfeerate<sp/>*/</highlight><highlight class="normal"><sp/>package_args.m_client_maxfeerate,</highlight></codeline>
<codeline lineno="544"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="545"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="546"><highlight class="normal"></highlight></codeline>
<codeline lineno="547"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">private</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="548"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Private<sp/>ctor<sp/>to<sp/>avoid<sp/>exposing<sp/>details<sp/>to<sp/>clients<sp/>and<sp/>allowing<sp/>the<sp/>possibility<sp/>of</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="549"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>mixing<sp/>up<sp/>the<sp/>order<sp/>of<sp/>the<sp/>arguments.<sp/>Use<sp/>static<sp/>functions<sp/>above<sp/>instead.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="550"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ATMPArgs(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CChainParams&amp;<sp/>chainparams,</highlight></codeline>
<codeline lineno="551"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int64_t<sp/>accept_time,</highlight></codeline>
<codeline lineno="552"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>bypass_limits,</highlight></codeline>
<codeline lineno="553"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;COutPoint&gt;&amp;<sp/>coins_to_uncache,</highlight></codeline>
<codeline lineno="554"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>test_accept,</highlight></codeline>
<codeline lineno="555"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>allow_replacement,</highlight></codeline>
<codeline lineno="556"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>allow_sibling_eviction,</highlight></codeline>
<codeline lineno="557"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>package_submission,</highlight></codeline>
<codeline lineno="558"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>package_feerates,</highlight></codeline>
<codeline lineno="559"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::optional&lt;CFeeRate&gt;<sp/>client_maxfeerate)</highlight></codeline>
<codeline lineno="560"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>:<sp/>m_chainparams{chainparams},</highlight></codeline>
<codeline lineno="561"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_accept_time{accept_time},</highlight></codeline>
<codeline lineno="562"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_bypass_limits{bypass_limits},</highlight></codeline>
<codeline lineno="563"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_coins_to_uncache{coins_to_uncache},</highlight></codeline>
<codeline lineno="564"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_test_accept{test_accept},</highlight></codeline>
<codeline lineno="565"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_allow_replacement{allow_replacement},</highlight></codeline>
<codeline lineno="566"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_allow_sibling_eviction{allow_sibling_eviction},</highlight></codeline>
<codeline lineno="567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_package_submission{package_submission},</highlight></codeline>
<codeline lineno="568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_package_feerates{package_feerates},</highlight></codeline>
<codeline lineno="569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_client_maxfeerate{client_maxfeerate}</highlight></codeline>
<codeline lineno="570"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="571"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>are<sp/>using<sp/>package<sp/>feerates,<sp/>we<sp/>must<sp/>be<sp/>doing<sp/>package<sp/>submission.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="572"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>It<sp/>also<sp/>means<sp/>sibling<sp/>eviction<sp/>is<sp/>not<sp/>permitted.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_package_feerates)<sp/>{</highlight></codeline>
<codeline lineno="574"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(m_package_submission);</highlight></codeline>
<codeline lineno="575"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(!m_allow_sibling_eviction);</highlight></codeline>
<codeline lineno="576"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="577"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_allow_sibling_eviction)<sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(m_allow_replacement);</highlight></codeline>
<codeline lineno="578"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="579"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="580"><highlight class="normal"></highlight></codeline>
<codeline lineno="582"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>CleanupTemporaryCoins()<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>m_pool.cs);</highlight></codeline>
<codeline lineno="583"><highlight class="normal"></highlight></codeline>
<codeline lineno="584"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Single<sp/>transaction<sp/>acceptance</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="585"><highlight class="normal"><sp/><sp/><sp/><sp/>MempoolAcceptResult<sp/>AcceptSingleTransactionAndCleanup(const<sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref>&amp;<sp/>ptx,<sp/>ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>)<sp/>{</highlight></codeline>
<codeline lineno="586"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_pool.cs);</highlight></codeline>
<codeline lineno="587"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MempoolAcceptResult<sp/>result<sp/>=<sp/>AcceptSingleTransactionInternal(ptx,<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>);</highlight></codeline>
<codeline lineno="588"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ClearSubPackageState();</highlight></codeline>
<codeline lineno="589"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>result;</highlight></codeline>
<codeline lineno="590"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="591"><highlight class="normal"><sp/><sp/><sp/><sp/>MempoolAcceptResult<sp/>AcceptSingleTransactionInternal(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref>&amp;<sp/>ptx,<sp/>ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>m_pool.cs);</highlight></codeline>
<codeline lineno="592"><highlight class="normal"></highlight></codeline>
<codeline lineno="598"><highlight class="normal"><sp/><sp/><sp/><sp/>PackageMempoolAcceptResult<sp/>AcceptMultipleTransactionsAndCleanup(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;CTransactionRef&gt;&amp;<sp/>txns,<sp/>ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>)<sp/>{</highlight></codeline>
<codeline lineno="599"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_pool.cs);</highlight></codeline>
<codeline lineno="600"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PackageMempoolAcceptResult<sp/>result<sp/>=<sp/>AcceptMultipleTransactionsInternal(txns,<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>);</highlight></codeline>
<codeline lineno="601"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ClearSubPackageState();</highlight></codeline>
<codeline lineno="602"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>result;</highlight></codeline>
<codeline lineno="603"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="604"><highlight class="normal"><sp/><sp/><sp/><sp/>PackageMempoolAcceptResult<sp/>AcceptMultipleTransactionsInternal(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;CTransactionRef&gt;&amp;<sp/>txns,<sp/>ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>m_pool.cs);</highlight></codeline>
<codeline lineno="605"><highlight class="normal"></highlight></codeline>
<codeline lineno="616"><highlight class="normal"><sp/><sp/><sp/><sp/>PackageMempoolAcceptResult<sp/>AcceptSubPackage(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;CTransactionRef&gt;&amp;<sp/>subpackage,<sp/>ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>)</highlight></codeline>
<codeline lineno="617"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>m_pool.cs);</highlight></codeline>
<codeline lineno="618"><highlight class="normal"></highlight></codeline>
<codeline lineno="623"><highlight class="normal"><sp/><sp/><sp/><sp/>PackageMempoolAcceptResult<sp/>AcceptPackage(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="packages_8h_1a138b5dbe56c4869308e2bc7a28b51d9c" kindref="member">Package</ref>&amp;<sp/>package,<sp/>ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="624"><highlight class="normal"></highlight></codeline>
<codeline lineno="625"><highlight class="normal"></highlight><highlight class="keyword">private</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="626"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>All<sp/>the<sp/>intermediate<sp/>state<sp/>that<sp/>gets<sp/>passed<sp/>between<sp/>the<sp/>various<sp/>levels</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="627"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>of<sp/>checking<sp/>a<sp/>given<sp/>transaction.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="628"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">Workspace<sp/>{</highlight></codeline>
<codeline lineno="629"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">explicit</highlight><highlight class="normal"><sp/>Workspace(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref>&amp;<sp/>ptx)<sp/>:<sp/>m_ptx(ptx),<sp/>m_hash(ptx-&gt;GetHash())<sp/>{}</highlight></codeline>
<codeline lineno="632"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::set&lt;Txid&gt;<sp/>m_conflicts;</highlight></codeline>
<codeline lineno="635"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_tx_mem_pool_1aa8f69e66acbab7cc883b13876a49766a" kindref="member">CTxMemPool::setEntries</ref><sp/>m_iters_conflicting;</highlight></codeline>
<codeline lineno="637"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CTxMemPoolEntry::CTxMemPoolEntryRef&gt;<sp/>m_parents;</highlight></codeline>
<codeline lineno="638"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Handle<sp/>to<sp/>the<sp/>tx<sp/>in<sp/>the<sp/>changeset<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="639"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_tx_mem_pool_1_1_change_set_1aa6276ff5d456cf000795544331b9c14c" kindref="member">CTxMemPool::ChangeSet::TxHandle</ref><sp/>m_tx_handle;</highlight></codeline>
<codeline lineno="642"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_sibling_eviction{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="643"><highlight class="normal"></highlight></codeline>
<codeline lineno="646"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int64_t<sp/>m_vsize;</highlight></codeline>
<codeline lineno="648"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/>m_base_fees;</highlight></codeline>
<codeline lineno="650"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/>m_modified_fees;</highlight></codeline>
<codeline lineno="651"><highlight class="normal"></highlight></codeline>
<codeline lineno="655"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CFeeRate<sp/>m_package_feerate{0};</highlight></codeline>
<codeline lineno="656"><highlight class="normal"></highlight></codeline>
<codeline lineno="657"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref>&amp;<sp/>m_ptx;</highlight></codeline>
<codeline lineno="659"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="transaction__identifier_8h_1ac4bb3c35b94889843d632be4de4b223c" kindref="member">Txid</ref>&amp;<sp/>m_hash;</highlight></codeline>
<codeline lineno="660"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>TxValidationState<sp/>m_state;</highlight></codeline>
<codeline lineno="663"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PrecomputedTransactionData<sp/>m_precomputed_txdata;</highlight></codeline>
<codeline lineno="664"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="665"><highlight class="normal"></highlight></codeline>
<codeline lineno="666"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Run<sp/>the<sp/>policy<sp/>checks<sp/>on<sp/>a<sp/>given<sp/>transaction,<sp/>excluding<sp/>any<sp/>script<sp/>checks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="667"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Looks<sp/>up<sp/>inputs,<sp/>calculates<sp/>feerate,<sp/>considers<sp/>replacement,<sp/>evaluates</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="668"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>package<sp/>limits,<sp/>etc.<sp/>As<sp/>this<sp/>function<sp/>can<sp/>be<sp/>invoked<sp/>for<sp/>&quot;free&quot;<sp/>by<sp/>a<sp/>peer,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="669"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>only<sp/>tests<sp/>that<sp/>are<sp/>fast<sp/>should<sp/>be<sp/>done<sp/>here<sp/>(to<sp/>avoid<sp/>CPU<sp/>DoS).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="670"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PreChecks(ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>,<sp/>Workspace&amp;<sp/>ws)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>m_pool.cs);</highlight></codeline>
<codeline lineno="671"><highlight class="normal"></highlight></codeline>
<codeline lineno="672"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Run<sp/>checks<sp/>for<sp/>mempool<sp/>replace-by-fee,<sp/>only<sp/>used<sp/>in<sp/>AcceptSingleTransaction.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="673"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>ReplacementChecks(Workspace&amp;<sp/>ws)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>m_pool.cs);</highlight></codeline>
<codeline lineno="674"><highlight class="normal"></highlight></codeline>
<codeline lineno="675"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Enforce<sp/>package<sp/>mempool<sp/>ancestor/descendant<sp/>limits<sp/>(distinct<sp/>from<sp/>individual</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="676"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ancestor/descendant<sp/>limits<sp/>done<sp/>in<sp/>PreChecks)<sp/>and<sp/>run<sp/>Package<sp/>RBF<sp/>checks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="677"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PackageMempoolChecks(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;CTransactionRef&gt;&amp;<sp/>txns,</highlight></codeline>
<codeline lineno="678"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;Workspace&gt;&amp;<sp/>workspaces,</highlight></codeline>
<codeline lineno="679"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int64_t<sp/>total_vsize,</highlight></codeline>
<codeline lineno="680"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PackageValidationState&amp;<sp/>package_state)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>m_pool.cs);</highlight></codeline>
<codeline lineno="681"><highlight class="normal"></highlight></codeline>
<codeline lineno="682"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Run<sp/>the<sp/>script<sp/>checks<sp/>using<sp/>our<sp/>policy<sp/>flags.<sp/>As<sp/>this<sp/>can<sp/>be<sp/>slow,<sp/>we<sp/>should</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="683"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>only<sp/>invoke<sp/>this<sp/>on<sp/>transactions<sp/>that<sp/>have<sp/>otherwise<sp/>passed<sp/>policy<sp/>checks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="684"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PolicyScriptChecks(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>,<sp/>Workspace&amp;<sp/>ws)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>m_pool.cs);</highlight></codeline>
<codeline lineno="685"><highlight class="normal"></highlight></codeline>
<codeline lineno="686"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Re-run<sp/>the<sp/>script<sp/>checks,<sp/>using<sp/>consensus<sp/>flags,<sp/>and<sp/>try<sp/>to<sp/>cache<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="687"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>result<sp/>in<sp/>the<sp/>scriptcache.<sp/>This<sp/>should<sp/>be<sp/>done<sp/>after</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="688"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>PolicyScriptChecks().<sp/>This<sp/>requires<sp/>that<sp/>all<sp/>inputs<sp/>either<sp/>be<sp/>in<sp/>our</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="689"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>utxo<sp/>set<sp/>or<sp/>in<sp/>the<sp/>mempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="690"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>ConsensusScriptChecks(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>,<sp/>Workspace&amp;<sp/>ws)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>m_pool.cs);</highlight></codeline>
<codeline lineno="691"><highlight class="normal"></highlight></codeline>
<codeline lineno="692"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Try<sp/>to<sp/>add<sp/>the<sp/>transaction<sp/>to<sp/>the<sp/>mempool,<sp/>removing<sp/>any<sp/>conflicts<sp/>first.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="693"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>FinalizeSubpackage(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>m_pool.cs);</highlight></codeline>
<codeline lineno="694"><highlight class="normal"></highlight></codeline>
<codeline lineno="695"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Submit<sp/>all<sp/>transactions<sp/>to<sp/>the<sp/>mempool<sp/>and<sp/>call<sp/>ConsensusScriptChecks<sp/>to<sp/>add<sp/>to<sp/>the<sp/>script</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="696"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>cache<sp/>-<sp/>should<sp/>only<sp/>be<sp/>called<sp/>after<sp/>successful<sp/>validation<sp/>of<sp/>all<sp/>transactions<sp/>in<sp/>the<sp/>package.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="697"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Does<sp/>not<sp/>call<sp/>LimitMempoolSize(),<sp/>so<sp/>mempool<sp/>max_size_bytes<sp/>may<sp/>be<sp/>temporarily<sp/>exceeded.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="698"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>SubmitPackage(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>,<sp/>std::vector&lt;Workspace&gt;&amp;<sp/>workspaces,<sp/>PackageValidationState&amp;<sp/>package_state,</highlight></codeline>
<codeline lineno="699"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::map&lt;Wtxid,<sp/>MempoolAcceptResult&gt;&amp;<sp/>results)</highlight></codeline>
<codeline lineno="700"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>m_pool.cs);</highlight></codeline>
<codeline lineno="701"><highlight class="normal"></highlight></codeline>
<codeline lineno="702"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compare<sp/>a<sp/>package&apos;s<sp/>feerate<sp/>against<sp/>minimum<sp/>allowed.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="703"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CheckFeeRate(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>package_size,<sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/>package_fee,<sp/>TxValidationState&amp;<sp/>state)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>,<sp/>m_pool.cs)</highlight></codeline>
<codeline lineno="704"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="705"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="706"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(m_pool.cs);</highlight></codeline>
<codeline lineno="707"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/>mempoolRejectFee<sp/>=<sp/>m_pool.GetMinFee().GetFee(package_size);</highlight></codeline>
<codeline lineno="708"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(mempoolRejectFee<sp/>&gt;<sp/>0<sp/>&amp;&amp;<sp/>package_fee<sp/>&lt;<sp/>mempoolRejectFee)<sp/>{</highlight></codeline>
<codeline lineno="709"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fada14c3503154c47fa98ac835983a5581" kindref="member">TxValidationResult::TX_RECONSIDERABLE</ref>,<sp/></highlight><highlight class="stringliteral">&quot;mempool<sp/>min<sp/>fee<sp/>not<sp/>met&quot;</highlight><highlight class="normal">,<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;%d<sp/>&lt;<sp/>%d&quot;</highlight><highlight class="normal">,<sp/>package_fee,<sp/>mempoolRejectFee));</highlight></codeline>
<codeline lineno="710"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="711"><highlight class="normal"></highlight></codeline>
<codeline lineno="712"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(package_fee<sp/>&lt;<sp/>m_pool.m_opts.min_relay_feerate.GetFee(package_size))<sp/>{</highlight></codeline>
<codeline lineno="713"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fada14c3503154c47fa98ac835983a5581" kindref="member">TxValidationResult::TX_RECONSIDERABLE</ref>,<sp/></highlight><highlight class="stringliteral">&quot;min<sp/>relay<sp/>fee<sp/>not<sp/>met&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="714"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;%d<sp/>&lt;<sp/>%d&quot;</highlight><highlight class="normal">,<sp/>package_fee,<sp/>m_pool.m_opts.min_relay_feerate.GetFee(package_size)));</highlight></codeline>
<codeline lineno="715"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="716"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="717"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="718"><highlight class="normal"></highlight></codeline>
<codeline lineno="719"><highlight class="normal"><sp/><sp/><sp/><sp/>ValidationCache&amp;<sp/>GetValidationCache()</highlight></codeline>
<codeline lineno="720"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="721"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>m_active_chainstate.m_chainman.m_validation_cache;</highlight></codeline>
<codeline lineno="722"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="723"><highlight class="normal"></highlight></codeline>
<codeline lineno="724"><highlight class="normal"></highlight><highlight class="keyword">private</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="725"><highlight class="normal"><sp/><sp/><sp/><sp/>CTxMemPool&amp;<sp/>m_pool;</highlight></codeline>
<codeline lineno="726"><highlight class="normal"></highlight></codeline>
<codeline lineno="738"><highlight class="normal"><sp/><sp/><sp/><sp/>CCoinsViewCache<sp/>m_view;</highlight></codeline>
<codeline lineno="739"><highlight class="normal"></highlight></codeline>
<codeline lineno="740"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>These<sp/>are<sp/>the<sp/>two<sp/>possible<sp/>backends<sp/>for<sp/>m_view.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="743"><highlight class="normal"><sp/><sp/><sp/><sp/>CCoinsViewMemPool<sp/>m_viewmempool;</highlight></codeline>
<codeline lineno="747"><highlight class="normal"><sp/><sp/><sp/><sp/>CCoinsView<sp/>m_dummy;</highlight></codeline>
<codeline lineno="748"><highlight class="normal"></highlight></codeline>
<codeline lineno="749"><highlight class="normal"><sp/><sp/><sp/><sp/>Chainstate&amp;<sp/>m_active_chainstate;</highlight></codeline>
<codeline lineno="750"><highlight class="normal"></highlight></codeline>
<codeline lineno="751"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Fields<sp/>below<sp/>are<sp/>per<sp/>*sub*package<sp/>state<sp/>and<sp/>must<sp/>be<sp/>reset<sp/>prior<sp/>to<sp/>subsequent</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="752"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>AcceptSingleTransaction<sp/>and<sp/>AcceptMultipleTransactions<sp/>invocations</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="753"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">SubPackageState<sp/>{</highlight></codeline>
<codeline lineno="755"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/>m_total_modified_fees{0};</highlight></codeline>
<codeline lineno="757"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int64_t<sp/>m_total_vsize{0};</highlight></codeline>
<codeline lineno="758"><highlight class="normal"></highlight></codeline>
<codeline lineno="759"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>RBF-related<sp/>members</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="762"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_rbf{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="764"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::list&lt;CTransactionRef&gt;<sp/>m_replaced_transactions;</highlight></codeline>
<codeline lineno="765"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Changeset<sp/>representing<sp/>adding<sp/>transactions<sp/>and<sp/>removing<sp/>their<sp/>conflicts.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="766"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::unique_ptr&lt;CTxMemPool::ChangeSet&gt;<sp/>m_changeset;</highlight></codeline>
<codeline lineno="767"><highlight class="normal"></highlight></codeline>
<codeline lineno="769"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/>m_conflicting_fees{0};</highlight></codeline>
<codeline lineno="771"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>m_conflicting_size{0};</highlight></codeline>
<codeline lineno="772"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="773"><highlight class="normal"></highlight></codeline>
<codeline lineno="774"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">SubPackageState<sp/>m_subpackage;</highlight></codeline>
<codeline lineno="775"><highlight class="normal"></highlight></codeline>
<codeline lineno="777"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ClearSubPackageState()<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>m_pool.cs)</highlight></codeline>
<codeline lineno="778"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="779"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_subpackage<sp/>=<sp/>SubPackageState{};</highlight></codeline>
<codeline lineno="780"><highlight class="normal"></highlight></codeline>
<codeline lineno="781"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>And<sp/>clean<sp/>coins<sp/>while<sp/>at<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="782"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CleanupTemporaryCoins();</highlight></codeline>
<codeline lineno="783"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="784"><highlight class="normal">};</highlight></codeline>
<codeline lineno="785"><highlight class="normal"></highlight></codeline>
<codeline lineno="786"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>MemPoolAccept::PreChecks(ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>,<sp/>Workspace&amp;<sp/>ws)</highlight></codeline>
<codeline lineno="787"><highlight class="normal">{</highlight></codeline>
<codeline lineno="788"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="789"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(m_pool.<ref refid="class_c_tx_mem_pool_1ab322659c2acf98d3bb6e877e69414281" kindref="member">cs</ref>);</highlight></codeline>
<codeline lineno="790"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref>&amp;<sp/>ptx<sp/>=<sp/>ws.m_ptx;</highlight></codeline>
<codeline lineno="791"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CTransaction&amp;<sp/>tx<sp/>=<sp/>*ws.m_ptx;</highlight></codeline>
<codeline lineno="792"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="transaction__identifier_8h_1ac4bb3c35b94889843d632be4de4b223c" kindref="member">Txid</ref>&amp;<sp/>hash<sp/>=<sp/>ws.m_hash;</highlight></codeline>
<codeline lineno="793"><highlight class="normal"></highlight></codeline>
<codeline lineno="794"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Copy/alias<sp/>what<sp/>we<sp/>need<sp/>out<sp/>of<sp/>args</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="795"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>int64_t<sp/>nAcceptTime<sp/>=<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_accept_time;</highlight></codeline>
<codeline lineno="796"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>bypass_limits<sp/>=<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_bypass_limits;</highlight></codeline>
<codeline lineno="797"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;COutPoint&gt;&amp;<sp/>coins_to_uncache<sp/>=<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_coins_to_uncache;</highlight></codeline>
<codeline lineno="798"><highlight class="normal"></highlight></codeline>
<codeline lineno="799"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Alias<sp/>what<sp/>we<sp/>need<sp/>out<sp/>of<sp/>ws</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="800"><highlight class="normal"><sp/><sp/><sp/><sp/>TxValidationState&amp;<sp/>state<sp/>=<sp/>ws.m_state;</highlight></codeline>
<codeline lineno="801"><highlight class="normal"></highlight></codeline>
<codeline lineno="802"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="tx__check_8cpp_1ac015dec2b8cac7f01b1f53b78a80d854" kindref="member">CheckTransaction</ref>(tx,<sp/>state))<sp/>{</highlight></codeline>
<codeline lineno="803"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>state<sp/>filled<sp/>in<sp/>by<sp/>CheckTransaction</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="804"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="805"><highlight class="normal"></highlight></codeline>
<codeline lineno="806"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Coinbase<sp/>is<sp/>only<sp/>valid<sp/>in<sp/>a<sp/>block,<sp/>not<sp/>as<sp/>a<sp/>loose<sp/>transaction</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="807"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tx.<ref refid="class_c_transaction_1a6b4def31a0a2fbc975d0087ad2d4391a" kindref="member">IsCoinBase</ref>())</highlight></codeline>
<codeline lineno="808"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fad623c6a3361887cbd2cf1fe3c2bfb261" kindref="member">TxValidationResult::TX_CONSENSUS</ref>,<sp/></highlight><highlight class="stringliteral">&quot;coinbase&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="809"><highlight class="normal"></highlight></codeline>
<codeline lineno="810"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Rather<sp/>not<sp/>work<sp/>on<sp/>nonstandard<sp/>transactions<sp/>(unless<sp/>-testnet/-regtest)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="811"><highlight class="normal"><sp/><sp/><sp/><sp/>std::string<sp/>reason;</highlight></codeline>
<codeline lineno="812"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1a9c745fcc8a902365ed061502bfd9ead4" kindref="member">require_standard</ref><sp/>&amp;&amp;<sp/>!<ref refid="policy_8cpp_1aadd0007b1969edf72c35e598fdadc4de" kindref="member">IsStandardTx</ref>(tx,<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1ad3928d8c43c7a8f76f022ea29a32dbca" kindref="member">max_datacarrier_bytes</ref>,<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1abc41ac368c3d07cb7b643311b4ce4985" kindref="member">permit_bare_multisig</ref>,<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1a74d2824c9989899d478845774c046ed6" kindref="member">dust_relay_feerate</ref>,<sp/>reason))<sp/>{</highlight></codeline>
<codeline lineno="813"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89faa87feca81b39bdb75c3fdf1af3895847" kindref="member">TxValidationResult::TX_NOT_STANDARD</ref>,<sp/>reason);</highlight></codeline>
<codeline lineno="814"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="815"><highlight class="normal"></highlight></codeline>
<codeline lineno="816"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Transactions<sp/>smaller<sp/>than<sp/>65<sp/>non-witness<sp/>bytes<sp/>are<sp/>not<sp/>relayed<sp/>to<sp/>mitigate<sp/>CVE-2017-12842.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="817"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="serialize_8h_1ac0154eb0a74cc852efc55684de85b1f5" kindref="member">::GetSerializeSize</ref>(TX_NO_WITNESS(tx))<sp/>&lt;<sp/>MIN_STANDARD_TX_NONWITNESS_SIZE)</highlight></codeline>
<codeline lineno="818"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89faa87feca81b39bdb75c3fdf1af3895847" kindref="member">TxValidationResult::TX_NOT_STANDARD</ref>,<sp/></highlight><highlight class="stringliteral">&quot;tx-size-small&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="819"><highlight class="normal"></highlight></codeline>
<codeline lineno="820"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>accept<sp/>nLockTime-using<sp/>transactions<sp/>that<sp/>can<sp/>be<sp/>mined<sp/>in<sp/>the<sp/>next</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="821"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>block;<sp/>we<sp/>don&apos;t<sp/>want<sp/>our<sp/>mempool<sp/>filled<sp/>up<sp/>with<sp/>transactions<sp/>that<sp/>can&apos;t</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="822"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>be<sp/>mined<sp/>yet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="823"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="validation_8cpp_1a3b90ca0d639cfea2208c7c0aa5118aaa" kindref="member">CheckFinalTxAtTip</ref>(*<ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(m_active_chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>()),<sp/>tx))<sp/>{</highlight></codeline>
<codeline lineno="824"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa4c15966c8a24612f3cd0214361ee04b9" kindref="member">TxValidationResult::TX_PREMATURE_SPEND</ref>,<sp/></highlight><highlight class="stringliteral">&quot;non-final&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="825"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="826"><highlight class="normal"></highlight></codeline>
<codeline lineno="827"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_pool.<ref refid="class_c_tx_mem_pool_1a4f1dcdad840ef946c9925b0f4a0f95b9" kindref="member">exists</ref>(tx.<ref refid="class_c_transaction_1a28dfe8fd260e515f71ec5b75630da11c" kindref="member">GetWitnessHash</ref>()))<sp/>{</highlight></codeline>
<codeline lineno="828"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Exact<sp/>transaction<sp/>already<sp/>exists<sp/>in<sp/>the<sp/>mempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="829"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa90e46dc7656bfd1beccba4ba1842c7aa" kindref="member">TxValidationResult::TX_CONFLICT</ref>,<sp/></highlight><highlight class="stringliteral">&quot;txn-already-in-mempool&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="830"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_pool.<ref refid="class_c_tx_mem_pool_1a4f1dcdad840ef946c9925b0f4a0f95b9" kindref="member">exists</ref>(tx.<ref refid="class_c_transaction_1a919ff1093793433f4717d74fb751423b" kindref="member">GetHash</ref>()))<sp/>{</highlight></codeline>
<codeline lineno="831"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Transaction<sp/>with<sp/>the<sp/>same<sp/>non-witness<sp/>data<sp/>but<sp/>different<sp/>witness<sp/>(same<sp/>txid,<sp/>different</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="832"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>wtxid)<sp/>already<sp/>exists<sp/>in<sp/>the<sp/>mempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="833"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa90e46dc7656bfd1beccba4ba1842c7aa" kindref="member">TxValidationResult::TX_CONFLICT</ref>,<sp/></highlight><highlight class="stringliteral">&quot;txn-same-nonwitness-data-in-mempool&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="834"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="835"><highlight class="normal"></highlight></codeline>
<codeline lineno="836"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>for<sp/>conflicts<sp/>with<sp/>in-memory<sp/>transactions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="837"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CTxIn<sp/>&amp;txin<sp/>:<sp/>tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>)</highlight></codeline>
<codeline lineno="838"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="839"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CTransaction*<sp/>ptxConflicting<sp/>=<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a795fa65f17897485303cd15a711acc6c" kindref="member">GetConflictTx</ref>(txin.<ref refid="class_c_tx_in_1a1c567359e133d98c72b5e9a928ffd41a" kindref="member">prevout</ref>);</highlight></codeline>
<codeline lineno="840"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ptxConflicting)<sp/>{</highlight></codeline>
<codeline lineno="841"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_allow_replacement)<sp/>{</highlight></codeline>
<codeline lineno="842"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Transaction<sp/>conflicts<sp/>with<sp/>a<sp/>mempool<sp/>tx,<sp/>but<sp/>we&apos;re<sp/>not<sp/>allowing<sp/>replacements<sp/>in<sp/>this<sp/>context.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="843"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa2dbed613ade117d8c58d8d230618efe4" kindref="member">TxValidationResult::TX_MEMPOOL_POLICY</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bip125-replacement-disallowed&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="844"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="845"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ws.m_conflicts.insert(ptxConflicting-&gt;<ref refid="class_c_transaction_1a919ff1093793433f4717d74fb751423b" kindref="member">GetHash</ref>());</highlight></codeline>
<codeline lineno="846"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="847"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="848"><highlight class="normal"></highlight></codeline>
<codeline lineno="849"><highlight class="normal"><sp/><sp/><sp/><sp/>m_view.<ref refid="class_c_coins_view_backed_1a92d89d686195319f0bbc4f57ada1c6c2" kindref="member">SetBackend</ref>(m_viewmempool);</highlight></codeline>
<codeline lineno="850"><highlight class="normal"></highlight></codeline>
<codeline lineno="851"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CCoinsViewCache&amp;<sp/>coins_cache<sp/>=<sp/>m_active_chainstate.<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>();</highlight></codeline>
<codeline lineno="852"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>do<sp/>all<sp/>inputs<sp/>exist?</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="853"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CTxIn&amp;<sp/>txin<sp/>:<sp/>tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>)<sp/>{</highlight></codeline>
<codeline lineno="854"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!coins_cache.<ref refid="class_c_coins_view_cache_1a546edde7d3db81c9fa65e8ad55195f7e" kindref="member">HaveCoinInCache</ref>(txin.<ref refid="class_c_tx_in_1a1c567359e133d98c72b5e9a928ffd41a" kindref="member">prevout</ref>))<sp/>{</highlight></codeline>
<codeline lineno="855"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_to_uncache.push_back(txin.<ref refid="class_c_tx_in_1a1c567359e133d98c72b5e9a928ffd41a" kindref="member">prevout</ref>);</highlight></codeline>
<codeline lineno="856"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="857"><highlight class="normal"></highlight></codeline>
<codeline lineno="858"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note:<sp/>this<sp/>call<sp/>may<sp/>add<sp/>txin.prevout<sp/>to<sp/>the<sp/>coins<sp/>cache</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="859"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(coins_cache.cacheCoins)<sp/>by<sp/>way<sp/>of<sp/>FetchCoin().<sp/>It<sp/>should<sp/>be<sp/>removed</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="860"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>later<sp/>(via<sp/>coins_to_uncache)<sp/>if<sp/>this<sp/>tx<sp/>turns<sp/>out<sp/>to<sp/>be<sp/>invalid.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="861"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_view.<ref refid="class_c_coins_view_cache_1a57c7063d0b2cb3900509d8a9e91a8459" kindref="member">HaveCoin</ref>(txin.<ref refid="class_c_tx_in_1a1c567359e133d98c72b5e9a928ffd41a" kindref="member">prevout</ref>))<sp/>{</highlight></codeline>
<codeline lineno="862"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Are<sp/>inputs<sp/>missing<sp/>because<sp/>we<sp/>already<sp/>have<sp/>the<sp/>tx?</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="863"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>out<sp/>=<sp/>0;<sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref><sp/>&lt;<sp/>tx.<ref refid="class_c_transaction_1ab6db6ccb0e8e9a2442296af044a29d56" kindref="member">vout</ref>.size();<sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>++)<sp/>{</highlight></codeline>
<codeline lineno="864"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Optimistically<sp/>just<sp/>do<sp/>efficient<sp/>check<sp/>of<sp/>cache<sp/>for<sp/>outputs</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="865"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(coins_cache.<ref refid="class_c_coins_view_cache_1a546edde7d3db81c9fa65e8ad55195f7e" kindref="member">HaveCoinInCache</ref>(COutPoint(hash,<sp/>out)))<sp/>{</highlight></codeline>
<codeline lineno="866"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa90e46dc7656bfd1beccba4ba1842c7aa" kindref="member">TxValidationResult::TX_CONFLICT</ref>,<sp/></highlight><highlight class="stringliteral">&quot;txn-already-known&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="867"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="868"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="869"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Otherwise<sp/>assume<sp/>this<sp/>might<sp/>be<sp/>an<sp/>orphan<sp/>tx<sp/>for<sp/>which<sp/>we<sp/>just<sp/>haven&apos;t<sp/>seen<sp/>parents<sp/>yet</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="870"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa16d3efb22890f6c8dd36c8e0e81dd796" kindref="member">TxValidationResult::TX_MISSING_INPUTS</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-txns-inputs-missingorspent&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="871"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="872"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="873"><highlight class="normal"></highlight></codeline>
<codeline lineno="874"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>is<sp/>const,<sp/>but<sp/>calls<sp/>into<sp/>the<sp/>back<sp/>end<sp/>CoinsViews.<sp/>The<sp/>CCoinsViewDB<sp/>at<sp/>the<sp/>bottom<sp/>of<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="875"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>hierarchy<sp/>brings<sp/>the<sp/>best<sp/>block<sp/>into<sp/>scope.<sp/>See<sp/>CCoinsViewDB::GetBestBlock().</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="876"><highlight class="normal"><sp/><sp/><sp/><sp/>m_view.<ref refid="class_c_coins_view_cache_1a357197e89d0c22e33f9e58b3dac685ff" kindref="member">GetBestBlock</ref>();</highlight></codeline>
<codeline lineno="877"><highlight class="normal"></highlight></codeline>
<codeline lineno="878"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>have<sp/>all<sp/>inputs<sp/>cached<sp/>now,<sp/>so<sp/>switch<sp/>back<sp/>to<sp/>dummy<sp/>(to<sp/>protect</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="879"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>against<sp/>bugs<sp/>where<sp/>we<sp/>pull<sp/>more<sp/>inputs<sp/>from<sp/>disk<sp/>that<sp/>miss<sp/>being<sp/>added</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="880"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>coins_to_uncache)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="881"><highlight class="normal"><sp/><sp/><sp/><sp/>m_view.<ref refid="class_c_coins_view_backed_1a92d89d686195319f0bbc4f57ada1c6c2" kindref="member">SetBackend</ref>(m_dummy);</highlight></codeline>
<codeline lineno="882"><highlight class="normal"></highlight></codeline>
<codeline lineno="883"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(m_active_chainstate.<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1a87eab19fb1a7e025715c13377ebfd356" kindref="member">LookupBlockIndex</ref>(m_view.<ref refid="class_c_coins_view_cache_1a357197e89d0c22e33f9e58b3dac685ff" kindref="member">GetBestBlock</ref>())<sp/>==<sp/>m_active_chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>());</highlight></codeline>
<codeline lineno="884"><highlight class="normal"></highlight></codeline>
<codeline lineno="885"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>accept<sp/>BIP68<sp/>sequence<sp/>locked<sp/>transactions<sp/>that<sp/>can<sp/>be<sp/>mined<sp/>in<sp/>the<sp/>next</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="886"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>block;<sp/>we<sp/>don&apos;t<sp/>want<sp/>our<sp/>mempool<sp/>filled<sp/>up<sp/>with<sp/>transactions<sp/>that<sp/>can&apos;t</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="887"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>be<sp/>mined<sp/>yet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="888"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Pass<sp/>in<sp/>m_view<sp/>which<sp/>has<sp/>all<sp/>of<sp/>the<sp/>relevant<sp/>inputs<sp/>cached.<sp/>Note<sp/>that,<sp/>since<sp/>m_view&apos;s</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="889"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>backend<sp/>was<sp/>removed,<sp/>it<sp/>no<sp/>longer<sp/>pulls<sp/>coins<sp/>from<sp/>the<sp/>mempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="890"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::optional&lt;LockPoints&gt;<sp/>lock_points{<ref refid="validation_8h_1a32144d8c77b444fd1bacffc7de991a8a" kindref="member">CalculateLockPointsAtTip</ref>(m_active_chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>(),<sp/>m_view,<sp/>tx)};</highlight></codeline>
<codeline lineno="891"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!lock_points.has_value()<sp/>||<sp/>!<ref refid="validation_8cpp_1a4bb60528a48d01c047a4b004e13136ff" kindref="member">CheckSequenceLocksAtTip</ref>(m_active_chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>(),<sp/>*lock_points))<sp/>{</highlight></codeline>
<codeline lineno="892"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa4c15966c8a24612f3cd0214361ee04b9" kindref="member">TxValidationResult::TX_PREMATURE_SPEND</ref>,<sp/></highlight><highlight class="stringliteral">&quot;non-BIP68-final&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="893"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="894"><highlight class="normal"></highlight></codeline>
<codeline lineno="895"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>mempool<sp/>holds<sp/>txs<sp/>for<sp/>the<sp/>next<sp/>block,<sp/>so<sp/>pass<sp/>height+1<sp/>to<sp/>CheckTxInputs</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="896"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="namespace_consensus_1a3dc747e8073036ed753fd2f53d5d1015" kindref="member">Consensus::CheckTxInputs</ref>(tx,<sp/>state,<sp/>m_view,<sp/>m_active_chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>()<sp/>+<sp/>1,<sp/>ws.m_base_fees))<sp/>{</highlight></codeline>
<codeline lineno="897"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>state<sp/>filled<sp/>in<sp/>by<sp/>CheckTxInputs</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="898"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="899"><highlight class="normal"></highlight></codeline>
<codeline lineno="900"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1a9c745fcc8a902365ed061502bfd9ead4" kindref="member">require_standard</ref><sp/>&amp;&amp;<sp/>!<ref refid="policy_8cpp_1a791e33e18bea9861e449e6ebcfce8890" kindref="member">AreInputsStandard</ref>(tx,<sp/>m_view))<sp/>{</highlight></codeline>
<codeline lineno="901"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa73a40891d562a317762127a2d0b3ed1c" kindref="member">TxValidationResult::TX_INPUTS_NOT_STANDARD</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-txns-nonstandard-inputs&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="902"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="903"><highlight class="normal"></highlight></codeline>
<codeline lineno="904"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>for<sp/>non-standard<sp/>witnesses.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="905"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tx.<ref refid="class_c_transaction_1a084eb52f31fb8d373a622fcc0c66b206" kindref="member">HasWitness</ref>()<sp/>&amp;&amp;<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1a9c745fcc8a902365ed061502bfd9ead4" kindref="member">require_standard</ref><sp/>&amp;&amp;<sp/>!<ref refid="policy_8cpp_1a8a73d04fc7e2d36b2acc4d6eb0cc2993" kindref="member">IsWitnessStandard</ref>(tx,<sp/>m_view))<sp/>{</highlight></codeline>
<codeline lineno="906"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fabd05fa801151b35239c6276029d1496c" kindref="member">TxValidationResult::TX_WITNESS_MUTATED</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-witness-nonstandard&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="907"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="908"><highlight class="normal"></highlight></codeline>
<codeline lineno="909"><highlight class="normal"><sp/><sp/><sp/><sp/>int64_t<sp/>nSigOpsCost<sp/>=<sp/><ref refid="tx__verify_8cpp_1ac1e236f29c0fd2b8ecee5a2846122151" kindref="member">GetTransactionSigOpCost</ref>(tx,<sp/>m_view,<sp/>STANDARD_SCRIPT_VERIFY_FLAGS);</highlight></codeline>
<codeline lineno="910"><highlight class="normal"></highlight></codeline>
<codeline lineno="911"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Keep<sp/>track<sp/>of<sp/>transactions<sp/>that<sp/>spend<sp/>a<sp/>coinbase,<sp/>which<sp/>we<sp/>re-scan</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="912"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>during<sp/>reorgs<sp/>to<sp/>ensure<sp/>COINBASE_MATURITY<sp/>is<sp/>still<sp/>met.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="913"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fSpendsCoinbase<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="914"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CTxIn<sp/>&amp;txin<sp/>:<sp/>tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>)<sp/>{</highlight></codeline>
<codeline lineno="915"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Coin<sp/>&amp;coin<sp/>=<sp/>m_view.<ref refid="class_c_coins_view_cache_1a87f1f2449e10859291ddbdc1d090cba3" kindref="member">AccessCoin</ref>(txin.<ref refid="class_c_tx_in_1a1c567359e133d98c72b5e9a928ffd41a" kindref="member">prevout</ref>);</highlight></codeline>
<codeline lineno="916"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(coin.<ref refid="class_coin_1a6b4def31a0a2fbc975d0087ad2d4391a" kindref="member">IsCoinBase</ref>())<sp/>{</highlight></codeline>
<codeline lineno="917"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fSpendsCoinbase<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="918"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="919"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="920"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="921"><highlight class="normal"></highlight></codeline>
<codeline lineno="922"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Set<sp/>entry_sequence<sp/>to<sp/>0<sp/>when<sp/>bypass_limits<sp/>is<sp/>used;<sp/>this<sp/>allows<sp/>txs<sp/>from<sp/>a<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="923"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>reorg<sp/>to<sp/>be<sp/>marked<sp/>earlier<sp/>than<sp/>any<sp/>child<sp/>txs<sp/>that<sp/>were<sp/>already<sp/>in<sp/>the<sp/>mempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="924"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>entry_sequence<sp/>=<sp/>bypass_limits<sp/>?<sp/>0<sp/>:<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a5c168b6f87d8b12617ed813ba79a0863" kindref="member">GetSequence</ref>();</highlight></codeline>
<codeline lineno="925"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_subpackage.m_changeset)<sp/>{</highlight></codeline>
<codeline lineno="926"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_subpackage.m_changeset<sp/>=<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a73f1a871ee46b6a104bd6489441eb87b" kindref="member">GetChangeSet</ref>();</highlight></codeline>
<codeline lineno="927"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="928"><highlight class="normal"><sp/><sp/><sp/><sp/>ws.m_tx_handle<sp/>=<sp/>m_subpackage.m_changeset-&gt;StageAddition(ptx,<sp/>ws.m_base_fees,<sp/>nAcceptTime,<sp/>m_active_chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>(),<sp/>entry_sequence,<sp/>fSpendsCoinbase,<sp/>nSigOpsCost,<sp/>lock_points.value());</highlight></codeline>
<codeline lineno="929"><highlight class="normal"></highlight></codeline>
<codeline lineno="930"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ws.m_modified_fees<sp/>includes<sp/>any<sp/>fee<sp/>deltas<sp/>from<sp/>PrioritiseTransaction</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="931"><highlight class="normal"><sp/><sp/><sp/><sp/>ws.m_modified_fees<sp/>=<sp/>ws.m_tx_handle-&gt;GetModifiedFee();</highlight></codeline>
<codeline lineno="932"><highlight class="normal"></highlight></codeline>
<codeline lineno="933"><highlight class="normal"><sp/><sp/><sp/><sp/>ws.m_vsize<sp/>=<sp/>ws.m_tx_handle-&gt;GetTxSize();</highlight></codeline>
<codeline lineno="934"><highlight class="normal"></highlight></codeline>
<codeline lineno="935"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Enforces<sp/>0-fee<sp/>for<sp/>dust<sp/>transactions,<sp/>no<sp/>incentive<sp/>to<sp/>be<sp/>mined<sp/>alone</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="936"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1a9c745fcc8a902365ed061502bfd9ead4" kindref="member">require_standard</ref>)<sp/>{</highlight></codeline>
<codeline lineno="937"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="ephemeral__policy_8cpp_1adde5d12df12eda5917d9a8ce710320d2" kindref="member">PreCheckEphemeralTx</ref>(*ptx,<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1a74d2824c9989899d478845774c046ed6" kindref="member">dust_relay_feerate</ref>,<sp/>ws.m_base_fees,<sp/>ws.m_modified_fees,<sp/>state))<sp/>{</highlight></codeline>
<codeline lineno="938"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>state<sp/>filled<sp/>in<sp/>by<sp/>PreCheckEphemeralTx</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="939"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="940"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="941"><highlight class="normal"></highlight></codeline>
<codeline lineno="942"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nSigOpsCost<sp/>&gt;<sp/>MAX_STANDARD_TX_SIGOPS_COST)</highlight></codeline>
<codeline lineno="943"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89faa87feca81b39bdb75c3fdf1af3895847" kindref="member">TxValidationResult::TX_NOT_STANDARD</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-txns-too-many-sigops&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="944"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;%d&quot;</highlight><highlight class="normal">,<sp/>nSigOpsCost));</highlight></codeline>
<codeline lineno="945"><highlight class="normal"></highlight></codeline>
<codeline lineno="946"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>No<sp/>individual<sp/>transactions<sp/>are<sp/>allowed<sp/>below<sp/>the<sp/>min<sp/>relay<sp/>feerate<sp/>except<sp/>from<sp/>disconnected<sp/>blocks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="947"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>requirement,<sp/>unlike<sp/>CheckFeeRate,<sp/>cannot<sp/>be<sp/>bypassed<sp/>using<sp/>m_package_feerates<sp/>because,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="948"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>while<sp/>a<sp/>tx<sp/>could<sp/>be<sp/>package<sp/>CPFP&apos;d<sp/>when<sp/>entering<sp/>the<sp/>mempool,<sp/>we<sp/>do<sp/>not<sp/>have<sp/>a<sp/>DoS-resistant</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="949"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>method<sp/>of<sp/>ensuring<sp/>the<sp/>tx<sp/>remains<sp/>bumped.<sp/>For<sp/>example,<sp/>the<sp/>fee-bumping<sp/>child<sp/>could<sp/>disappear</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="950"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>due<sp/>to<sp/>a<sp/>replacement.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="951"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>only<sp/>exception<sp/>is<sp/>TRUC<sp/>transactions.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="952"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!bypass_limits<sp/>&amp;&amp;<sp/>ws.m_ptx-&gt;version<sp/>!=<sp/>TRUC_VERSION<sp/>&amp;&amp;<sp/>ws.m_modified_fees<sp/>&lt;<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1ad0f673994f163981d3b563b4e80b2d53" kindref="member">min_relay_feerate</ref>.<ref refid="class_c_fee_rate_1a48858bde2b68fc9bd54f5ae34b45f371" kindref="member">GetFee</ref>(ws.m_vsize))<sp/>{</highlight></codeline>
<codeline lineno="953"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Even<sp/>though<sp/>this<sp/>is<sp/>a<sp/>fee-related<sp/>failure,<sp/>this<sp/>result<sp/>is<sp/>TX_MEMPOOL_POLICY,<sp/>not</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="954"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>TX_RECONSIDERABLE,<sp/>because<sp/>it<sp/>cannot<sp/>be<sp/>bypassed<sp/>using<sp/>package<sp/>validation.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="955"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa2dbed613ade117d8c58d8d230618efe4" kindref="member">TxValidationResult::TX_MEMPOOL_POLICY</ref>,<sp/></highlight><highlight class="stringliteral">&quot;min<sp/>relay<sp/>fee<sp/>not<sp/>met&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="956"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;%d<sp/>&lt;<sp/>%d&quot;</highlight><highlight class="normal">,<sp/>ws.m_modified_fees,<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1ad0f673994f163981d3b563b4e80b2d53" kindref="member">min_relay_feerate</ref>.<ref refid="class_c_fee_rate_1a48858bde2b68fc9bd54f5ae34b45f371" kindref="member">GetFee</ref>(ws.m_vsize)));</highlight></codeline>
<codeline lineno="957"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="958"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>No<sp/>individual<sp/>transactions<sp/>are<sp/>allowed<sp/>below<sp/>the<sp/>mempool<sp/>min<sp/>feerate<sp/>except<sp/>from<sp/>disconnected</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="959"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>blocks<sp/>and<sp/>transactions<sp/>in<sp/>a<sp/>package.<sp/>Package<sp/>transactions<sp/>will<sp/>be<sp/>checked<sp/>using<sp/>package</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="960"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>feerate<sp/>later.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="961"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!bypass_limits<sp/>&amp;&amp;<sp/>!<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_package_feerates<sp/>&amp;&amp;<sp/>!CheckFeeRate(ws.m_vsize,<sp/>ws.m_modified_fees,<sp/>state))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="962"><highlight class="normal"></highlight></codeline>
<codeline lineno="963"><highlight class="normal"><sp/><sp/><sp/><sp/>ws.m_iters_conflicting<sp/>=<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a8960da66f5e997b29b78c3ebe025a6ab" kindref="member">GetIterSet</ref>(ws.m_conflicts);</highlight></codeline>
<codeline lineno="964"><highlight class="normal"></highlight></codeline>
<codeline lineno="965"><highlight class="normal"><sp/><sp/><sp/><sp/>ws.m_parents<sp/>=<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1ad67bc54113b9b07ec253b7e306b4ea95" kindref="member">GetParents</ref>(*ws.m_tx_handle);</highlight></codeline>
<codeline lineno="966"><highlight class="normal"></highlight></codeline>
<codeline lineno="967"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_bypass_limits)<sp/>{</highlight></codeline>
<codeline lineno="968"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Perform<sp/>the<sp/>TRUC<sp/>checks,<sp/>using<sp/>the<sp/>in-mempool<sp/>parents.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="969"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>err{<ref refid="truc__policy_8cpp_1a58ab48db1646c729c1e075417a3d0efd" kindref="member">SingleTRUCChecks</ref>(m_pool,<sp/>ws.m_ptx,<sp/>ws.m_parents,<sp/>ws.m_conflicts,<sp/>ws.m_vsize)})<sp/>{</highlight></codeline>
<codeline lineno="970"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Single<sp/>transaction<sp/>contexts<sp/>only.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="971"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_allow_sibling_eviction<sp/>&amp;&amp;<sp/>err-&gt;second<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="972"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>should<sp/>only<sp/>be<sp/>considering<sp/>where<sp/>replacement<sp/>is<sp/>considered<sp/>valid<sp/>as<sp/>well.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="973"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_allow_replacement);</highlight></codeline>
<codeline lineno="974"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Potential<sp/>sibling<sp/>eviction.<sp/>Add<sp/>the<sp/>sibling<sp/>to<sp/>our<sp/>list<sp/>of<sp/>mempool<sp/>conflicts<sp/>to<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="975"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>included<sp/>in<sp/>RBF<sp/>checks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="976"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ws.m_conflicts.insert(err-&gt;second-&gt;GetHash());</highlight></codeline>
<codeline lineno="977"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Adding<sp/>the<sp/>sibling<sp/>to<sp/>m_iters_conflicting<sp/>here<sp/>means<sp/>that<sp/>it<sp/>doesn&apos;t<sp/>count<sp/>towards</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="978"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>RBF<sp/>Carve<sp/>Out<sp/>above.<sp/>This<sp/>is<sp/>correct,<sp/>since<sp/>removing<sp/>to-be-replaced<sp/>transactions<sp/>from</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="979"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>descendant<sp/>count<sp/>is<sp/>done<sp/>separately<sp/>in<sp/>SingleTRUCChecks<sp/>for<sp/>TRUC<sp/>transactions.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="980"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ws.m_iters_conflicting.insert(m_pool.<ref refid="class_c_tx_mem_pool_1ae2097b56302767d8ec0fb585bce77490" kindref="member">GetIter</ref>(err-&gt;second-&gt;GetHash()).value());</highlight></codeline>
<codeline lineno="981"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ws.m_sibling_eviction<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="982"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>sibling<sp/>will<sp/>be<sp/>treated<sp/>as<sp/>part<sp/>of<sp/>the<sp/>to-be-replaced<sp/>set<sp/>in<sp/>ReplacementChecks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="983"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note<sp/>that<sp/>we<sp/>are<sp/>not<sp/>checking<sp/>whether<sp/>it<sp/>opts<sp/>in<sp/>to<sp/>replaceability<sp/>via<sp/>BIP125<sp/>or<sp/>TRUC</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="984"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(which<sp/>is<sp/>normally<sp/>done<sp/>in<sp/>PreChecks).<sp/>However,<sp/>the<sp/>only<sp/>way<sp/>a<sp/>TRUC<sp/>transaction<sp/>can</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="985"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>have<sp/>a<sp/>non-TRUC<sp/>and<sp/>non-BIP125<sp/>descendant<sp/>is<sp/>due<sp/>to<sp/>a<sp/>reorg.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="986"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="987"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa2dbed613ade117d8c58d8d230618efe4" kindref="member">TxValidationResult::TX_MEMPOOL_POLICY</ref>,<sp/></highlight><highlight class="stringliteral">&quot;TRUC-violation&quot;</highlight><highlight class="normal">,<sp/>err-&gt;first);</highlight></codeline>
<codeline lineno="988"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="989"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="990"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="991"><highlight class="normal"></highlight></codeline>
<codeline lineno="992"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>want<sp/>to<sp/>detect<sp/>conflicts<sp/>in<sp/>any<sp/>tx<sp/>in<sp/>a<sp/>package<sp/>to<sp/>trigger<sp/>package<sp/>RBF<sp/>logic</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="993"><highlight class="normal"><sp/><sp/><sp/><sp/>m_subpackage.m_rbf<sp/>|=<sp/>!ws.m_conflicts.empty();</highlight></codeline>
<codeline lineno="994"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="995"><highlight class="normal">}</highlight></codeline>
<codeline lineno="996"><highlight class="normal"></highlight></codeline>
<codeline lineno="997"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>MemPoolAccept::ReplacementChecks(Workspace&amp;<sp/>ws)</highlight></codeline>
<codeline lineno="998"><highlight class="normal">{</highlight></codeline>
<codeline lineno="999"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1000"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(m_pool.<ref refid="class_c_tx_mem_pool_1ab322659c2acf98d3bb6e877e69414281" kindref="member">cs</ref>);</highlight></codeline>
<codeline lineno="1001"><highlight class="normal"></highlight></codeline>
<codeline lineno="1002"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CTransaction&amp;<sp/>tx<sp/>=<sp/>*ws.m_ptx;</highlight></codeline>
<codeline lineno="1003"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="transaction__identifier_8h_1ac4bb3c35b94889843d632be4de4b223c" kindref="member">Txid</ref>&amp;<sp/>hash<sp/>=<sp/>ws.m_hash;</highlight></codeline>
<codeline lineno="1004"><highlight class="normal"><sp/><sp/><sp/><sp/>TxValidationState&amp;<sp/>state<sp/>=<sp/>ws.m_state;</highlight></codeline>
<codeline lineno="1005"><highlight class="normal"></highlight></codeline>
<codeline lineno="1006"><highlight class="normal"><sp/><sp/><sp/><sp/>CFeeRate<sp/>newFeeRate(ws.m_modified_fees,<sp/>ws.m_vsize);</highlight></codeline>
<codeline lineno="1007"><highlight class="normal"></highlight></codeline>
<codeline lineno="1008"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_tx_mem_pool_1aa8f69e66acbab7cc883b13876a49766a" kindref="member">CTxMemPool::setEntries</ref><sp/>all_conflicts;</highlight></codeline>
<codeline lineno="1009"><highlight class="normal"></highlight></codeline>
<codeline lineno="1010"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Calculate<sp/>all<sp/>conflicting<sp/>entries<sp/>and<sp/>enforce<sp/>Rule<sp/>#5.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1011"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>err_string{<ref refid="policy_2rbf_8cpp_1aff72d993cabe4197acdf58571fdd588d" kindref="member">GetEntriesForConflicts</ref>(tx,<sp/>m_pool,<sp/>ws.m_iters_conflicting,<sp/>all_conflicts)})<sp/>{</highlight></codeline>
<codeline lineno="1012"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa2dbed613ade117d8c58d8d230618efe4" kindref="member">TxValidationResult::TX_MEMPOOL_POLICY</ref>,</highlight></codeline>
<codeline lineno="1013"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;too<sp/>many<sp/>potential<sp/>replacements%s&quot;</highlight><highlight class="normal">,<sp/>ws.m_sibling_eviction<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;<sp/>(including<sp/>sibling<sp/>eviction)&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">),<sp/>*err_string);</highlight></codeline>
<codeline lineno="1014"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1015"><highlight class="normal"></highlight></codeline>
<codeline lineno="1016"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>if<sp/>it&apos;s<sp/>economically<sp/>rational<sp/>to<sp/>mine<sp/>this<sp/>transaction<sp/>rather<sp/>than<sp/>the<sp/>ones<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1017"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>replaces<sp/>and<sp/>pays<sp/>for<sp/>its<sp/>own<sp/>relay<sp/>fees.<sp/>Enforce<sp/>Rules<sp/>#3<sp/>and<sp/>#4.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1018"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(<ref refid="class_c_tx_mem_pool_1abd8c1d2efe4dbb1d8eb1c86646dd4b00" kindref="member">CTxMemPool::txiter</ref><sp/>it<sp/>:<sp/>all_conflicts)<sp/>{</highlight></codeline>
<codeline lineno="1019"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_subpackage.m_conflicting_fees<sp/>+=<sp/>it-&gt;GetModifiedFee();</highlight></codeline>
<codeline lineno="1020"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_subpackage.m_conflicting_size<sp/>+=<sp/>it-&gt;GetTxSize();</highlight></codeline>
<codeline lineno="1021"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1022"><highlight class="normal"></highlight></codeline>
<codeline lineno="1023"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>err_string{<ref refid="policy_2rbf_8cpp_1a96e243683f646a5bc2a53eca61b4d1e9" kindref="member">PaysForRBF</ref>(m_subpackage.m_conflicting_fees,<sp/>ws.m_modified_fees,<sp/>ws.m_vsize,</highlight></codeline>
<codeline lineno="1024"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1a5a2333ca521fc7a9717b7aeee546dbf2" kindref="member">incremental_relay_feerate</ref>,<sp/>hash)})<sp/>{</highlight></codeline>
<codeline lineno="1025"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Result<sp/>may<sp/>change<sp/>in<sp/>a<sp/>package<sp/>context</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1026"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fada14c3503154c47fa98ac835983a5581" kindref="member">TxValidationResult::TX_RECONSIDERABLE</ref>,</highlight></codeline>
<codeline lineno="1027"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;insufficient<sp/>fee%s&quot;</highlight><highlight class="normal">,<sp/>ws.m_sibling_eviction<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;<sp/>(including<sp/>sibling<sp/>eviction)&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">),<sp/>*err_string);</highlight></codeline>
<codeline lineno="1028"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1029"><highlight class="normal"></highlight></codeline>
<codeline lineno="1030"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Add<sp/>all<sp/>the<sp/>to-be-removed<sp/>transactions<sp/>to<sp/>the<sp/>changeset.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1031"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it<sp/>:<sp/>all_conflicts)<sp/>{</highlight></codeline>
<codeline lineno="1032"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_subpackage.m_changeset-&gt;StageRemoval(it);</highlight></codeline>
<codeline lineno="1033"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1034"><highlight class="normal"></highlight></codeline>
<codeline lineno="1035"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Run<sp/>cluster<sp/>size<sp/>limit<sp/>checks<sp/>and<sp/>fail<sp/>if<sp/>we<sp/>exceed<sp/>them.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1036"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_subpackage.m_changeset-&gt;CheckMemPoolPolicyLimits())<sp/>{</highlight></codeline>
<codeline lineno="1037"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa2dbed613ade117d8c58d8d230618efe4" kindref="member">TxValidationResult::TX_MEMPOOL_POLICY</ref>,<sp/></highlight><highlight class="stringliteral">&quot;too-large-cluster&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1038"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1039"><highlight class="normal"></highlight></codeline>
<codeline lineno="1040"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>err_string{<ref refid="policy_2rbf_8cpp_1a2d2f7e53b191b3f5423576a727b2f8e1" kindref="member">ImprovesFeerateDiagram</ref>(*m_subpackage.m_changeset)})<sp/>{</highlight></codeline>
<codeline lineno="1041"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>checked<sp/>above<sp/>for<sp/>the<sp/>cluster<sp/>size<sp/>limits<sp/>being<sp/>respected,<sp/>so<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1042"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>failure<sp/>here<sp/>can<sp/>only<sp/>be<sp/>due<sp/>to<sp/>an<sp/>insufficient<sp/>fee.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1043"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(err_string-&gt;first<sp/>==<sp/><ref refid="policy_2rbf_8h_1ae9597f9d7719b814f7f0e748048b20a0a36fc6065a3e970bc3e6b2e59da52bf2a" kindref="member">DiagramCheckError::FAILURE</ref>);</highlight></codeline>
<codeline lineno="1044"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fada14c3503154c47fa98ac835983a5581" kindref="member">TxValidationResult::TX_RECONSIDERABLE</ref>,<sp/></highlight><highlight class="stringliteral">&quot;replacement-failed&quot;</highlight><highlight class="normal">,<sp/>err_string-&gt;second);</highlight></codeline>
<codeline lineno="1045"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1046"><highlight class="normal"></highlight></codeline>
<codeline lineno="1047"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1048"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1049"><highlight class="normal"></highlight></codeline>
<codeline lineno="1050"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>MemPoolAccept::PackageMempoolChecks(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;CTransactionRef&gt;&amp;<sp/>txns,</highlight></codeline>
<codeline lineno="1051"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;Workspace&gt;&amp;<sp/>workspaces,</highlight></codeline>
<codeline lineno="1052"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>int64_t<sp/>total_vsize,</highlight></codeline>
<codeline lineno="1053"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PackageValidationState&amp;<sp/>package_state)</highlight></codeline>
<codeline lineno="1054"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1055"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1056"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(m_pool.<ref refid="class_c_tx_mem_pool_1ab322659c2acf98d3bb6e877e69414281" kindref="member">cs</ref>);</highlight></codeline>
<codeline lineno="1057"><highlight class="normal"></highlight></codeline>
<codeline lineno="1058"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(std::all_of(txns.cbegin(),<sp/>txns.cend(),<sp/>[</highlight><highlight class="keyword">this</highlight><highlight class="normal">](</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tx)</highlight></codeline>
<codeline lineno="1059"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{<sp/>return<sp/>!m_pool.exists(tx-&gt;GetHash());}));</highlight></codeline>
<codeline lineno="1060"><highlight class="normal"></highlight></codeline>
<codeline lineno="1061"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(txns.size()<sp/>==<sp/>workspaces.size());</highlight></codeline>
<codeline lineno="1062"><highlight class="normal"></highlight></codeline>
<codeline lineno="1063"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>No<sp/>conflicts<sp/>means<sp/>we&apos;re<sp/>finished.<sp/>Further<sp/>checks<sp/>are<sp/>all<sp/>RBF-only.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1064"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_subpackage.m_rbf)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1065"><highlight class="normal"></highlight></codeline>
<codeline lineno="1066"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We&apos;re<sp/>in<sp/>package<sp/>RBF<sp/>context;<sp/>replacement<sp/>proposal<sp/>must<sp/>be<sp/>size<sp/>2</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1067"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(workspaces.size()<sp/>!=<sp/>2<sp/>||<sp/>!<ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(<ref refid="packages_8cpp_1a0959b9a8f47d5ab16f0df8b80b0b488a" kindref="member">IsChildWithParents</ref>(txns)))<sp/>{</highlight></codeline>
<codeline lineno="1068"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>package_state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284a87a19a0e7858be85913a6cff1b1eab4e" kindref="member">PackageValidationResult::PCKG_POLICY</ref>,<sp/></highlight><highlight class="stringliteral">&quot;package<sp/>RBF<sp/>failed:<sp/>package<sp/>must<sp/>be<sp/>1-parent-1-child&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1069"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1070"><highlight class="normal"></highlight></codeline>
<codeline lineno="1071"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>package<sp/>has<sp/>in-mempool<sp/>parents,<sp/>we<sp/>won&apos;t<sp/>consider<sp/>a<sp/>package<sp/>RBF</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1072"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>since<sp/>it<sp/>would<sp/>result<sp/>in<sp/>a<sp/>cluster<sp/>larger<sp/>than<sp/>2.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1073"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>N.B.<sp/>To<sp/>relax<sp/>this<sp/>constraint<sp/>we<sp/>will<sp/>need<sp/>to<sp/>revisit<sp/>how<sp/>CCoinsViewMemPool::PackageAddTransaction</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1074"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>is<sp/>being<sp/>used<sp/>inside<sp/>AcceptMultipleTransactions<sp/>to<sp/>track<sp/>available<sp/>inputs<sp/>while<sp/>processing<sp/>a<sp/>package.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1075"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Specifically<sp/>we<sp/>would<sp/>need<sp/>to<sp/>check<sp/>that<sp/>the<sp/>ancestors<sp/>of<sp/>the<sp/>new</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1076"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transactions<sp/>don&apos;t<sp/>intersect<sp/>with<sp/>the<sp/>set<sp/>of<sp/>transactions<sp/>to<sp/>be<sp/>removed</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1077"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>due<sp/>to<sp/>RBF,<sp/>which<sp/>is<sp/>not<sp/>checked<sp/>at<sp/>all<sp/>in<sp/>the<sp/>package<sp/>acceptance</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1078"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>context.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1079"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>ws<sp/>:<sp/>workspaces)<sp/>{</highlight></codeline>
<codeline lineno="1080"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!ws.m_parents.empty())<sp/>{</highlight></codeline>
<codeline lineno="1081"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>package_state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284a87a19a0e7858be85913a6cff1b1eab4e" kindref="member">PackageValidationResult::PCKG_POLICY</ref>,<sp/></highlight><highlight class="stringliteral">&quot;package<sp/>RBF<sp/>failed:<sp/>new<sp/>transaction<sp/>cannot<sp/>have<sp/>mempool<sp/>ancestors&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1082"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1083"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1084"><highlight class="normal"></highlight></codeline>
<codeline lineno="1085"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Aggregate<sp/>all<sp/>conflicts<sp/>into<sp/>one<sp/>set.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1086"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_tx_mem_pool_1aa8f69e66acbab7cc883b13876a49766a" kindref="member">CTxMemPool::setEntries</ref><sp/>direct_conflict_iters;</highlight></codeline>
<codeline lineno="1087"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(Workspace&amp;<sp/>ws<sp/>:<sp/>workspaces)<sp/>{</highlight></codeline>
<codeline lineno="1088"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Aggregate<sp/>all<sp/>conflicts<sp/>into<sp/>one<sp/>set.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1089"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>direct_conflict_iters.merge(ws.m_iters_conflicting);</highlight></codeline>
<codeline lineno="1090"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1091"><highlight class="normal"></highlight></codeline>
<codeline lineno="1092"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>parent_ws<sp/>=<sp/>workspaces[0];</highlight></codeline>
<codeline lineno="1093"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>child_ws<sp/>=<sp/>workspaces[1];</highlight></codeline>
<codeline lineno="1094"><highlight class="normal"></highlight></codeline>
<codeline lineno="1095"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Don&apos;t<sp/>consider<sp/>replacements<sp/>that<sp/>would<sp/>cause<sp/>us<sp/>to<sp/>remove<sp/>a<sp/>large<sp/>number<sp/>of<sp/>mempool<sp/>entries.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1096"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>limit<sp/>is<sp/>not<sp/>increased<sp/>in<sp/>a<sp/>package<sp/>RBF.<sp/>Use<sp/>the<sp/>aggregate<sp/>number<sp/>of<sp/>transactions.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1097"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_tx_mem_pool_1aa8f69e66acbab7cc883b13876a49766a" kindref="member">CTxMemPool::setEntries</ref><sp/>all_conflicts;</highlight></codeline>
<codeline lineno="1098"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>err_string{<ref refid="policy_2rbf_8cpp_1aff72d993cabe4197acdf58571fdd588d" kindref="member">GetEntriesForConflicts</ref>(*child_ws.m_ptx,<sp/>m_pool,<sp/>direct_conflict_iters,</highlight></codeline>
<codeline lineno="1099"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>all_conflicts)})<sp/>{</highlight></codeline>
<codeline lineno="1100"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>package_state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284a87a19a0e7858be85913a6cff1b1eab4e" kindref="member">PackageValidationResult::PCKG_POLICY</ref>,</highlight></codeline>
<codeline lineno="1101"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;package<sp/>RBF<sp/>failed:<sp/>too<sp/>many<sp/>potential<sp/>replacements&quot;</highlight><highlight class="normal">,<sp/>*err_string);</highlight></codeline>
<codeline lineno="1102"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1103"><highlight class="normal"></highlight></codeline>
<codeline lineno="1104"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(<ref refid="class_c_tx_mem_pool_1abd8c1d2efe4dbb1d8eb1c86646dd4b00" kindref="member">CTxMemPool::txiter</ref><sp/>it<sp/>:<sp/>all_conflicts)<sp/>{</highlight></codeline>
<codeline lineno="1105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_subpackage.m_changeset-&gt;StageRemoval(it);</highlight></codeline>
<codeline lineno="1106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_subpackage.m_conflicting_fees<sp/>+=<sp/>it-&gt;GetModifiedFee();</highlight></codeline>
<codeline lineno="1107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_subpackage.m_conflicting_size<sp/>+=<sp/>it-&gt;GetTxSize();</highlight></codeline>
<codeline lineno="1108"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1109"><highlight class="normal"></highlight></codeline>
<codeline lineno="1110"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Use<sp/>the<sp/>child<sp/>as<sp/>the<sp/>transaction<sp/>for<sp/>attributing<sp/>errors<sp/>to.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1111"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="transaction__identifier_8h_1ac4bb3c35b94889843d632be4de4b223c" kindref="member">Txid</ref>&amp;<sp/>child_hash<sp/>=<sp/>child_ws.m_ptx-&gt;GetHash();</highlight></codeline>
<codeline lineno="1112"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>err_string{<ref refid="policy_2rbf_8cpp_1a96e243683f646a5bc2a53eca61b4d1e9" kindref="member">PaysForRBF</ref>(</highlight><highlight class="comment">/*original_fees=*/</highlight><highlight class="normal">m_subpackage.m_conflicting_fees,</highlight></codeline>
<codeline lineno="1113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*replacement_fees=*/</highlight><highlight class="normal">m_subpackage.m_total_modified_fees,</highlight></codeline>
<codeline lineno="1114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*replacement_vsize=*/</highlight><highlight class="normal">m_subpackage.m_total_vsize,</highlight></codeline>
<codeline lineno="1115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1a5a2333ca521fc7a9717b7aeee546dbf2" kindref="member">incremental_relay_feerate</ref>,<sp/>child_hash)})<sp/>{</highlight></codeline>
<codeline lineno="1116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>package_state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284a87a19a0e7858be85913a6cff1b1eab4e" kindref="member">PackageValidationResult::PCKG_POLICY</ref>,</highlight></codeline>
<codeline lineno="1117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;package<sp/>RBF<sp/>failed:<sp/>insufficient<sp/>anti-DoS<sp/>fees&quot;</highlight><highlight class="normal">,<sp/>*err_string);</highlight></codeline>
<codeline lineno="1118"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1119"><highlight class="normal"></highlight></codeline>
<codeline lineno="1120"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ensure<sp/>this<sp/>two<sp/>transaction<sp/>package<sp/>is<sp/>a<sp/>&quot;chunk&quot;<sp/>on<sp/>its<sp/>own;<sp/>we<sp/>don&apos;t<sp/>want<sp/>the<sp/>child</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1121"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>be<sp/>only<sp/>paying<sp/>anti-DoS<sp/>fees</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1122"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CFeeRate<sp/>parent_feerate(parent_ws.m_modified_fees,<sp/>parent_ws.m_vsize);</highlight></codeline>
<codeline lineno="1123"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CFeeRate<sp/>package_feerate(m_subpackage.m_total_modified_fees,<sp/>m_subpackage.m_total_vsize);</highlight></codeline>
<codeline lineno="1124"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(package_feerate<sp/>&lt;=<sp/>parent_feerate)<sp/>{</highlight></codeline>
<codeline lineno="1125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>package_state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284a87a19a0e7858be85913a6cff1b1eab4e" kindref="member">PackageValidationResult::PCKG_POLICY</ref>,</highlight></codeline>
<codeline lineno="1126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;package<sp/>RBF<sp/>failed:<sp/>package<sp/>feerate<sp/>is<sp/>less<sp/>than<sp/>or<sp/>equal<sp/>to<sp/>parent<sp/>feerate&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;package<sp/>feerate<sp/>%s<sp/>&lt;=<sp/>parent<sp/>feerate<sp/>is<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>package_feerate.ToString(),<sp/>parent_feerate.ToString()));</highlight></codeline>
<codeline lineno="1128"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1129"><highlight class="normal"></highlight></codeline>
<codeline lineno="1130"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Run<sp/>cluster<sp/>size<sp/>limit<sp/>checks<sp/>and<sp/>fail<sp/>if<sp/>we<sp/>exceed<sp/>them.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1131"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_subpackage.m_changeset-&gt;CheckMemPoolPolicyLimits())<sp/>{</highlight></codeline>
<codeline lineno="1132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>package_state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284a87a19a0e7858be85913a6cff1b1eab4e" kindref="member">PackageValidationResult::PCKG_POLICY</ref>,<sp/></highlight><highlight class="stringliteral">&quot;too-large-cluster&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1133"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1134"><highlight class="normal"></highlight></codeline>
<codeline lineno="1135"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>if<sp/>it&apos;s<sp/>economically<sp/>rational<sp/>to<sp/>mine<sp/>this<sp/>package<sp/>rather<sp/>than<sp/>the<sp/>ones<sp/>it<sp/>replaces.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1136"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>err_tup{<ref refid="policy_2rbf_8cpp_1a2d2f7e53b191b3f5423576a727b2f8e1" kindref="member">ImprovesFeerateDiagram</ref>(*m_subpackage.m_changeset)})<sp/>{</highlight></codeline>
<codeline lineno="1137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(err_tup-&gt;first<sp/>==<sp/><ref refid="policy_2rbf_8h_1ae9597f9d7719b814f7f0e748048b20a0a36fc6065a3e970bc3e6b2e59da52bf2a" kindref="member">DiagramCheckError::FAILURE</ref>);</highlight></codeline>
<codeline lineno="1138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>package_state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284a87a19a0e7858be85913a6cff1b1eab4e" kindref="member">PackageValidationResult::PCKG_POLICY</ref>,</highlight></codeline>
<codeline lineno="1139"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;package<sp/>RBF<sp/>failed:<sp/>&quot;</highlight><highlight class="normal"><sp/>+<sp/>err_tup.value().second,<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1140"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1141"><highlight class="normal"></highlight></codeline>
<codeline lineno="1142"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395aeb418caf082e910fc5ab0d298fb6a8ac" kindref="member">BCLog::TXPACKAGES</ref>,<sp/></highlight><highlight class="stringliteral">&quot;package<sp/>RBF<sp/>checks<sp/>passed:<sp/>parent<sp/>%s<sp/>(wtxid=%s),<sp/>child<sp/>%s<sp/>(wtxid=%s),<sp/>package<sp/>hash<sp/>(%s)\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1143"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>txns.front()-&gt;GetHash().ToString(),<sp/>txns.front()-&gt;GetWitnessHash().ToString(),</highlight></codeline>
<codeline lineno="1144"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>txns.back()-&gt;GetHash().ToString(),<sp/>txns.back()-&gt;GetWitnessHash().ToString(),</highlight></codeline>
<codeline lineno="1145"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="packages_8cpp_1ab2640b3a916f8801f16731e8d1f0798f" kindref="member">GetPackageHash</ref>(txns).<ref refid="bitcoin-cli_8cpp_1aec2c30b1707eac00ff7e4fb5b3f7a92d" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="1146"><highlight class="normal"></highlight></codeline>
<codeline lineno="1147"><highlight class="normal"></highlight></codeline>
<codeline lineno="1148"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1149"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1150"><highlight class="normal"></highlight></codeline>
<codeline lineno="1151"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>MemPoolAccept::PolicyScriptChecks(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>,<sp/>Workspace&amp;<sp/>ws)</highlight></codeline>
<codeline lineno="1152"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1153"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1154"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(m_pool.<ref refid="class_c_tx_mem_pool_1ab322659c2acf98d3bb6e877e69414281" kindref="member">cs</ref>);</highlight></codeline>
<codeline lineno="1155"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CTransaction&amp;<sp/>tx<sp/>=<sp/>*ws.m_ptx;</highlight></codeline>
<codeline lineno="1156"><highlight class="normal"><sp/><sp/><sp/><sp/>TxValidationState&amp;<sp/>state<sp/>=<sp/>ws.m_state;</highlight></codeline>
<codeline lineno="1157"><highlight class="normal"></highlight></codeline>
<codeline lineno="1158"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>script_verify_flags<sp/>scriptVerifyFlags<sp/>=<sp/>STANDARD_SCRIPT_VERIFY_FLAGS;</highlight></codeline>
<codeline lineno="1159"><highlight class="normal"></highlight></codeline>
<codeline lineno="1160"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>input<sp/>scripts<sp/>and<sp/>signatures.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1161"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>is<sp/>done<sp/>last<sp/>to<sp/>help<sp/>prevent<sp/>CPU<sp/>exhaustion<sp/>denial-of-service<sp/>attacks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1162"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="txvalidationcache__tests_8cpp_1a97d6169ac38d1dc06811732fda310b8c" kindref="member">CheckInputScripts</ref>(tx,<sp/>state,<sp/>m_view,<sp/>scriptVerifyFlags,<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">,<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">,<sp/>ws.m_precomputed_txdata,<sp/>GetValidationCache()))<sp/>{</highlight></codeline>
<codeline lineno="1163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Detect<sp/>a<sp/>failure<sp/>due<sp/>to<sp/>a<sp/>missing<sp/>witness<sp/>so<sp/>that<sp/>p2p<sp/>code<sp/>can<sp/>handle<sp/>rejection<sp/>caching<sp/>appropriately.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tx.<ref refid="class_c_transaction_1a084eb52f31fb8d373a622fcc0c66b206" kindref="member">HasWitness</ref>()<sp/>&amp;&amp;<sp/><ref refid="policy_8cpp_1a63d1c42b964069822fdc1687465a6a15" kindref="member">SpendsNonAnchorWitnessProg</ref>(tx,<sp/>m_view))<sp/>{</highlight></codeline>
<codeline lineno="1165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa7d22472f2e6c5609db513454c8b8426f" kindref="member">TxValidationResult::TX_WITNESS_STRIPPED</ref>,</highlight></codeline>
<codeline lineno="1166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.<ref refid="class_validation_state_1a5fef80db1db0007a9082aa7d104e2933" kindref="member">GetRejectReason</ref>(),<sp/>state.<ref refid="class_validation_state_1ac444b5235f12cdc04292ab64fe44226b" kindref="member">GetDebugMessage</ref>());</highlight></codeline>
<codeline lineno="1167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>state<sp/>filled<sp/>in<sp/>by<sp/>CheckInputScripts</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1169"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1170"><highlight class="normal"></highlight></codeline>
<codeline lineno="1171"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1172"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1173"><highlight class="normal"></highlight></codeline>
<codeline lineno="1174"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>MemPoolAccept::ConsensusScriptChecks(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>,<sp/>Workspace&amp;<sp/>ws)</highlight></codeline>
<codeline lineno="1175"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1176"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1177"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(m_pool.<ref refid="class_c_tx_mem_pool_1ab322659c2acf98d3bb6e877e69414281" kindref="member">cs</ref>);</highlight></codeline>
<codeline lineno="1178"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CTransaction&amp;<sp/>tx<sp/>=<sp/>*ws.m_ptx;</highlight></codeline>
<codeline lineno="1179"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="transaction__identifier_8h_1ac4bb3c35b94889843d632be4de4b223c" kindref="member">Txid</ref>&amp;<sp/>hash<sp/>=<sp/>ws.m_hash;</highlight></codeline>
<codeline lineno="1180"><highlight class="normal"><sp/><sp/><sp/><sp/>TxValidationState&amp;<sp/>state<sp/>=<sp/>ws.m_state;</highlight></codeline>
<codeline lineno="1181"><highlight class="normal"></highlight></codeline>
<codeline lineno="1182"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>again<sp/>against<sp/>the<sp/>current<sp/>block<sp/>tip&apos;s<sp/>script<sp/>verification</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1183"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>flags<sp/>to<sp/>cache<sp/>our<sp/>script<sp/>execution<sp/>flags.<sp/>This<sp/>is,<sp/>of<sp/>course,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1184"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>useless<sp/>if<sp/>the<sp/>next<sp/>block<sp/>has<sp/>different<sp/>script<sp/>flags<sp/>from<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1185"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>previous<sp/>one,<sp/>but<sp/>because<sp/>the<sp/>cache<sp/>tracks<sp/>script<sp/>flags<sp/>for<sp/>us<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1186"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>will<sp/>auto-invalidate<sp/>and<sp/>we&apos;ll<sp/>just<sp/>have<sp/>a<sp/>few<sp/>blocks<sp/>of<sp/>extra</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1187"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>misses<sp/>on<sp/>soft-fork<sp/>activation.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1188"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1189"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>is<sp/>also<sp/>useful<sp/>in<sp/>case<sp/>of<sp/>bugs<sp/>in<sp/>the<sp/>standard<sp/>flags<sp/>that<sp/>cause</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1190"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transactions<sp/>to<sp/>pass<sp/>as<sp/>valid<sp/>when<sp/>they&apos;re<sp/>actually<sp/>invalid.<sp/>For</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1191"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>instance<sp/>the<sp/>STRICTENC<sp/>flag<sp/>was<sp/>incorrectly<sp/>allowing<sp/>certain</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1192"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>CHECKSIG<sp/>NOT<sp/>scripts<sp/>to<sp/>pass,<sp/>even<sp/>though<sp/>they<sp/>were<sp/>invalid.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1193"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1194"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>There<sp/>is<sp/>a<sp/>similar<sp/>check<sp/>in<sp/>CreateNewBlock()<sp/>to<sp/>prevent<sp/>creating</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1195"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>invalid<sp/>blocks<sp/>(using<sp/>TestBlockValidity),<sp/>however<sp/>allowing<sp/>such</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1196"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transactions<sp/>into<sp/>the<sp/>mempool<sp/>can<sp/>be<sp/>exploited<sp/>as<sp/>a<sp/>DoS<sp/>attack.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1197"><highlight class="normal"><sp/><sp/><sp/><sp/>script_verify_flags<sp/>currentBlockScriptVerifyFlags{<ref refid="validation_8cpp_1a1c5c1cc0abaf193cde025de8c0827b50" kindref="member">GetBlockScriptFlags</ref>(*m_active_chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>(),<sp/>m_active_chainstate.<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>)};</highlight></codeline>
<codeline lineno="1198"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!CheckInputsFromMempoolAndCache(tx,<sp/>state,<sp/>m_view,<sp/>m_pool,<sp/>currentBlockScriptVerifyFlags,</highlight></codeline>
<codeline lineno="1199"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ws.m_precomputed_txdata,<sp/>m_active_chainstate.<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>(),<sp/>GetValidationCache()))<sp/>{</highlight></codeline>
<codeline lineno="1200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;BUG!<sp/>PLEASE<sp/>REPORT<sp/>THIS!<sp/>CheckInputScripts<sp/>failed<sp/>against<sp/>latest-block<sp/>but<sp/>not<sp/>STANDARD<sp/>flags<sp/>%s,<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>hash.<ref refid="classtransaction__identifier_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>(),<sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="1201"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(</highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1202"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1203"><highlight class="normal"></highlight></codeline>
<codeline lineno="1204"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1205"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1206"><highlight class="normal"></highlight></codeline>
<codeline lineno="1207"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>MemPoolAccept::FinalizeSubpackage(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>)</highlight></codeline>
<codeline lineno="1208"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1209"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1210"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(m_pool.<ref refid="class_c_tx_mem_pool_1ab322659c2acf98d3bb6e877e69414281" kindref="member">cs</ref>);</highlight></codeline>
<codeline lineno="1211"><highlight class="normal"></highlight></codeline>
<codeline lineno="1212"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_subpackage.m_changeset-&gt;GetRemovals().empty())<sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_allow_replacement);</highlight></codeline>
<codeline lineno="1213"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Remove<sp/>conflicting<sp/>transactions<sp/>from<sp/>the<sp/>mempool</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1214"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(<ref refid="class_c_tx_mem_pool_1abd8c1d2efe4dbb1d8eb1c86646dd4b00" kindref="member">CTxMemPool::txiter</ref><sp/>it<sp/>:<sp/>m_subpackage.m_changeset-&gt;GetRemovals())</highlight></codeline>
<codeline lineno="1215"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="1216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::string<sp/>log_string<sp/>=<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;replacing<sp/>mempool<sp/>tx<sp/>%s<sp/>(wtxid=%s,<sp/>fees=%s,<sp/>vsize=%s).<sp/>&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1217"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>it-&gt;GetTx().GetHash().ToString(),</highlight></codeline>
<codeline lineno="1218"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>it-&gt;GetTx().GetWitnessHash().ToString(),</highlight></codeline>
<codeline lineno="1219"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>it-&gt;GetFee(),</highlight></codeline>
<codeline lineno="1220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>it-&gt;GetTxSize());</highlight></codeline>
<codeline lineno="1221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>FeeFrac<sp/>feerate{m_subpackage.m_total_modified_fees,<sp/>int32_t(m_subpackage.m_total_vsize)};</highlight></codeline>
<codeline lineno="1222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint256<sp/>tx_or_package_hash{};</highlight></codeline>
<codeline lineno="1223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>replaced_with_tx{m_subpackage.m_changeset-&gt;GetTxCount()<sp/>==<sp/>1};</highlight></codeline>
<codeline lineno="1224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(replaced_with_tx)<sp/>{</highlight></codeline>
<codeline lineno="1225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CTransaction&amp;<sp/>tx<sp/>=<sp/>m_subpackage.m_changeset-&gt;GetAddedTxn(0);</highlight></codeline>
<codeline lineno="1226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_or_package_hash<sp/>=<sp/>tx.<ref refid="class_c_transaction_1a919ff1093793433f4717d74fb751423b" kindref="member">GetHash</ref>().<ref refid="classtransaction__identifier_1a1cb411c7b8bb6c9024bc1a87b6d367ba" kindref="member">ToUint256</ref>();</highlight></codeline>
<codeline lineno="1227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>log_string<sp/>+=<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;New<sp/>tx<sp/>%s<sp/>(wtxid=%s,<sp/>fees=%s,<sp/>vsize=%s)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx.<ref refid="class_c_transaction_1a919ff1093793433f4717d74fb751423b" kindref="member">GetHash</ref>().<ref refid="classtransaction__identifier_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>(),</highlight></codeline>
<codeline lineno="1229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx.<ref refid="class_c_transaction_1a28dfe8fd260e515f71ec5b75630da11c" kindref="member">GetWitnessHash</ref>().<ref refid="classtransaction__identifier_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>(),</highlight></codeline>
<codeline lineno="1230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feerate.<ref refid="struct_fee_frac_1a6c6b1afb7a3ce84aa1ff3890e731b3d3" kindref="member">fee</ref>,</highlight></codeline>
<codeline lineno="1231"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feerate.<ref refid="struct_fee_frac_1af8fd9ce16b371c8a3bf5e0b37a69419f" kindref="member">size</ref>);</highlight></codeline>
<codeline lineno="1232"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_or_package_hash<sp/>=<sp/><ref refid="packages_8cpp_1ab2640b3a916f8801f16731e8d1f0798f" kindref="member">GetPackageHash</ref>(m_subpackage.m_changeset-&gt;GetAddedTxns());</highlight></codeline>
<codeline lineno="1234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>log_string<sp/>+=<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;New<sp/>package<sp/>%s<sp/>with<sp/>%lu<sp/>txs,<sp/>fees=%s,<sp/>vsize=%s&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_or_package_hash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),</highlight></codeline>
<codeline lineno="1236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_subpackage.m_changeset-&gt;GetTxCount(),</highlight></codeline>
<codeline lineno="1237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feerate.<ref refid="struct_fee_frac_1a6c6b1afb7a3ce84aa1ff3890e731b3d3" kindref="member">fee</ref>,</highlight></codeline>
<codeline lineno="1238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feerate.<ref refid="struct_fee_frac_1af8fd9ce16b371c8a3bf5e0b37a69419f" kindref="member">size</ref>);</highlight></codeline>
<codeline lineno="1239"><highlight class="normal"></highlight></codeline>
<codeline lineno="1240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395afb374f9d778e803545f3af036ca147a0" kindref="member">BCLog::MEMPOOL</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s\n&quot;</highlight><highlight class="normal">,<sp/>log_string);</highlight></codeline>
<codeline lineno="1242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="trace_8h_1ae7d4767c75c045d7e4d4b840fb4a8e5f" kindref="member">TRACEPOINT</ref>(mempool,<sp/>replaced,</highlight></codeline>
<codeline lineno="1243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>it-&gt;GetTx().GetHash().data(),</highlight></codeline>
<codeline lineno="1244"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>it-&gt;GetTxSize(),</highlight></codeline>
<codeline lineno="1245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>it-&gt;GetFee(),</highlight></codeline>
<codeline lineno="1246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::chrono::duration_cast&lt;std::chrono::duration&lt;std::uint64_t&gt;&gt;(it-&gt;GetTime()).count(),</highlight></codeline>
<codeline lineno="1247"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_or_package_hash.<ref refid="classbase__blob_1ad33ec60b8fc9ad7eef168e57aa6c5fb9" kindref="member">data</ref>(),</highlight></codeline>
<codeline lineno="1248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feerate.<ref refid="struct_fee_frac_1af8fd9ce16b371c8a3bf5e0b37a69419f" kindref="member">size</ref>,</highlight></codeline>
<codeline lineno="1249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feerate.<ref refid="struct_fee_frac_1a6c6b1afb7a3ce84aa1ff3890e731b3d3" kindref="member">fee</ref>,</highlight></codeline>
<codeline lineno="1250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>replaced_with_tx</highlight></codeline>
<codeline lineno="1251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="1252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_subpackage.m_replaced_transactions.push_back(it-&gt;GetSharedTx());</highlight></codeline>
<codeline lineno="1253"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1254"><highlight class="normal"><sp/><sp/><sp/><sp/>m_subpackage.m_changeset-&gt;Apply();</highlight></codeline>
<codeline lineno="1255"><highlight class="normal"><sp/><sp/><sp/><sp/>m_subpackage.m_changeset.reset();</highlight></codeline>
<codeline lineno="1256"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1257"><highlight class="normal"></highlight></codeline>
<codeline lineno="1258"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>MemPoolAccept::SubmitPackage(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>,<sp/>std::vector&lt;Workspace&gt;&amp;<sp/>workspaces,</highlight></codeline>
<codeline lineno="1259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PackageValidationState&amp;<sp/>package_state,</highlight></codeline>
<codeline lineno="1260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::map&lt;Wtxid,<sp/>MempoolAcceptResult&gt;&amp;<sp/>results)</highlight></codeline>
<codeline lineno="1261"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1262"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1263"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(m_pool.<ref refid="class_c_tx_mem_pool_1ab322659c2acf98d3bb6e877e69414281" kindref="member">cs</ref>);</highlight></codeline>
<codeline lineno="1264"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Sanity<sp/>check:<sp/>none<sp/>of<sp/>the<sp/>transactions<sp/>should<sp/>be<sp/>in<sp/>the<sp/>mempool,<sp/>and<sp/>none<sp/>of<sp/>the<sp/>transactions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1265"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>should<sp/>have<sp/>a<sp/>same-txid-different-witness<sp/>equivalent<sp/>in<sp/>the<sp/>mempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1266"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(std::all_of(workspaces.cbegin(),<sp/>workspaces.cend(),<sp/>[</highlight><highlight class="keyword">this</highlight><highlight class="normal">](</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>ws)<sp/>{<sp/>return<sp/>!m_pool.exists(ws.m_ptx-&gt;GetHash());<sp/>}));</highlight></codeline>
<codeline lineno="1267"><highlight class="normal"></highlight></codeline>
<codeline lineno="1268"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>all_submitted<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1269"><highlight class="normal"><sp/><sp/><sp/><sp/>FinalizeSubpackage(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>);</highlight></codeline>
<codeline lineno="1270"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ConsensusScriptChecks<sp/>adds<sp/>to<sp/>the<sp/>script<sp/>cache<sp/>and<sp/>is<sp/>therefore<sp/>consensus-critical;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1271"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>CheckInputsFromMempoolAndCache<sp/>asserts<sp/>that<sp/>transactions<sp/>only<sp/>spend<sp/>coins<sp/>available<sp/>from<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1272"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>mempool<sp/>or<sp/>UTXO<sp/>set.<sp/>Submit<sp/>each<sp/>transaction<sp/>to<sp/>the<sp/>mempool<sp/>immediately<sp/>after<sp/>calling</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1273"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ConsensusScriptChecks<sp/>to<sp/>make<sp/>the<sp/>outputs<sp/>available<sp/>for<sp/>subsequent<sp/>transactions.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1274"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(Workspace&amp;<sp/>ws<sp/>:<sp/>workspaces)<sp/>{</highlight></codeline>
<codeline lineno="1275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!ConsensusScriptChecks(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>,<sp/>ws))<sp/>{</highlight></codeline>
<codeline lineno="1276"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>results.emplace(ws.m_ptx-&gt;GetWitnessHash(),<sp/><ref refid="struct_mempool_accept_result_1af068e8d0ef73ea6eb79c045cc100558c" kindref="member">MempoolAcceptResult::Failure</ref>(ws.m_state));</highlight></codeline>
<codeline lineno="1277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Since<sp/>PolicyScriptChecks()<sp/>passed,<sp/>this<sp/>should<sp/>never<sp/>fail.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(</highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>all_submitted<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>package_state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284acf51fdc18ab5c01c46605acc539f705b" kindref="member">PackageValidationResult::PCKG_MEMPOOL_ERROR</ref>,</highlight></codeline>
<codeline lineno="1281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;BUG!<sp/>PolicyScriptChecks<sp/>succeeded<sp/>but<sp/>ConsensusScriptChecks<sp/>failed:<sp/>%s&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ws.m_ptx-&gt;GetHash().ToString()));</highlight></codeline>
<codeline lineno="1283"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Remove<sp/>the<sp/>transaction<sp/>from<sp/>the<sp/>mempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_subpackage.m_changeset)<sp/>m_subpackage.m_changeset<sp/>=<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a73f1a871ee46b6a104bd6489441eb87b" kindref="member">GetChangeSet</ref>();</highlight></codeline>
<codeline lineno="1285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_subpackage.m_changeset-&gt;StageRemoval(m_pool.<ref refid="class_c_tx_mem_pool_1ae2097b56302767d8ec0fb585bce77490" kindref="member">GetIter</ref>(ws.m_ptx-&gt;GetHash()).value());</highlight></codeline>
<codeline lineno="1286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1287"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1288"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!all_submitted)<sp/>{</highlight></codeline>
<codeline lineno="1289"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(m_subpackage.m_changeset);</highlight></codeline>
<codeline lineno="1290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>code<sp/>should<sp/>be<sp/>unreachable;<sp/>it&apos;s<sp/>here<sp/>as<sp/>belt-and-suspenders</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>try<sp/>to<sp/>ensure<sp/>we<sp/>have<sp/>no<sp/>consensus-invalid<sp/>transactions<sp/>in<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>mempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_subpackage.m_changeset-&gt;Apply();</highlight></codeline>
<codeline lineno="1294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_subpackage.m_changeset.reset();</highlight></codeline>
<codeline lineno="1295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1296"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1297"><highlight class="normal"></highlight></codeline>
<codeline lineno="1298"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;Wtxid&gt;<sp/>all_package_wtxids;</highlight></codeline>
<codeline lineno="1299"><highlight class="normal"><sp/><sp/><sp/><sp/>all_package_wtxids.reserve(workspaces.size());</highlight></codeline>
<codeline lineno="1300"><highlight class="normal"><sp/><sp/><sp/><sp/>std::transform(workspaces.cbegin(),<sp/>workspaces.cend(),<sp/>std::back_inserter(all_package_wtxids),</highlight></codeline>
<codeline lineno="1301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[](</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>ws)<sp/>{<sp/>return<sp/>ws.m_ptx-&gt;GetWitnessHash();<sp/>});</highlight></codeline>
<codeline lineno="1302"><highlight class="normal"></highlight></codeline>
<codeline lineno="1303"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_subpackage.m_replaced_transactions.empty())<sp/>{</highlight></codeline>
<codeline lineno="1304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395afb374f9d778e803545f3af036ca147a0" kindref="member">BCLog::MEMPOOL</ref>,<sp/></highlight><highlight class="stringliteral">&quot;replaced<sp/>%u<sp/>mempool<sp/>transactions<sp/>with<sp/>%u<sp/>new<sp/>one(s)<sp/>for<sp/>%s<sp/>additional<sp/>fees,<sp/>%d<sp/>delta<sp/>bytes\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_subpackage.m_replaced_transactions.size(),<sp/>workspaces.size(),</highlight></codeline>
<codeline lineno="1306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_subpackage.m_total_modified_fees<sp/>-<sp/>m_subpackage.m_conflicting_fees,</highlight></codeline>
<codeline lineno="1307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_subpackage.m_total_vsize<sp/>-<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">int</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(m_subpackage.m_conflicting_size));</highlight></codeline>
<codeline lineno="1308"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1309"><highlight class="normal"></highlight></codeline>
<codeline lineno="1310"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Add<sp/>successful<sp/>results.<sp/>The<sp/>returned<sp/>results<sp/>may<sp/>change<sp/>later<sp/>if<sp/>LimitMempoolSize()<sp/>evicts<sp/>them.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1311"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(Workspace&amp;<sp/>ws<sp/>:<sp/>workspaces)<sp/>{</highlight></codeline>
<codeline lineno="1312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>iter<sp/>=<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1ae2097b56302767d8ec0fb585bce77490" kindref="member">GetIter</ref>(ws.m_ptx-&gt;GetHash());</highlight></codeline>
<codeline lineno="1313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(iter.has_value());</highlight></codeline>
<codeline lineno="1314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>effective_feerate<sp/>=<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_package_feerates<sp/>?<sp/>ws.m_package_feerate<sp/>:</highlight></codeline>
<codeline lineno="1315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CFeeRate{ws.m_modified_fees,<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="normal">int32_t</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(ws.m_vsize)};</highlight></codeline>
<codeline lineno="1316"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>effective_feerate_wtxids<sp/>=<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_package_feerates<sp/>?<sp/>all_package_wtxids<sp/>:</highlight></codeline>
<codeline lineno="1317"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;Wtxid&gt;{ws.m_ptx-&gt;GetWitnessHash()};</highlight></codeline>
<codeline lineno="1318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>results.emplace(ws.m_ptx-&gt;GetWitnessHash(),</highlight></codeline>
<codeline lineno="1319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_mempool_accept_result_1ae8bd22448958950d717420133c2074f4" kindref="member">MempoolAcceptResult::Success</ref>(std::move(m_subpackage.m_replaced_transactions),<sp/>ws.m_vsize,</highlight></codeline>
<codeline lineno="1320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ws.m_base_fees,<sp/>effective_feerate,<sp/>effective_feerate_wtxids));</highlight></codeline>
<codeline lineno="1321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1a08c1845611020458495472ea71190a4c" kindref="member">signals</ref>)<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CTransaction&amp;<sp/>tx<sp/>=<sp/>*ws.m_ptx;</highlight></codeline>
<codeline lineno="1323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>tx_info<sp/>=<sp/>NewMempoolTransactionInfo(ws.m_ptx,<sp/>ws.m_base_fees,</highlight></codeline>
<codeline lineno="1324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ws.m_vsize,<sp/>(*iter)-&gt;GetHeight(),</highlight></codeline>
<codeline lineno="1325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_bypass_limits,<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_package_submission,</highlight></codeline>
<codeline lineno="1326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>IsCurrentForFeeEstimation(m_active_chainstate),</highlight></codeline>
<codeline lineno="1327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a759a72decf76f3d5ee1855c68e064336" kindref="member">HasNoInputsOf</ref>(tx));</highlight></codeline>
<codeline lineno="1328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1a08c1845611020458495472ea71190a4c" kindref="member">signals</ref>-&gt;<ref refid="class_validation_signals_1ac89cfc9809a6c4d4b68af1cf3fdc3fc9" kindref="member">TransactionAddedToMempool</ref>(tx_info,<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a2720ea12b86320ed18e584725ea3cf76" kindref="member">GetAndIncrementSequence</ref>());</highlight></codeline>
<codeline lineno="1329"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1330"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>all_submitted;</highlight></codeline>
<codeline lineno="1331"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1332"><highlight class="normal"></highlight></codeline>
<codeline lineno="1333"><highlight class="normal">MempoolAcceptResult<sp/>MemPoolAccept::AcceptSingleTransactionInternal(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref>&amp;<sp/>ptx,<sp/>ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>)</highlight></codeline>
<codeline lineno="1334"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1335"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1336"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(m_pool.<ref refid="class_c_tx_mem_pool_1ab322659c2acf98d3bb6e877e69414281" kindref="member">cs</ref>);</highlight></codeline>
<codeline lineno="1337"><highlight class="normal"></highlight></codeline>
<codeline lineno="1338"><highlight class="normal"><sp/><sp/><sp/><sp/>Workspace<sp/>ws(ptx);</highlight></codeline>
<codeline lineno="1339"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;Wtxid&gt;<sp/>single_wtxid{ws.m_ptx-&gt;GetWitnessHash()};</highlight></codeline>
<codeline lineno="1340"><highlight class="normal"></highlight></codeline>
<codeline lineno="1341"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!PreChecks(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>,<sp/>ws))<sp/>{</highlight></codeline>
<codeline lineno="1342"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ws.m_state.GetResult()<sp/>==<sp/><ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fada14c3503154c47fa98ac835983a5581" kindref="member">TxValidationResult::TX_RECONSIDERABLE</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Failed<sp/>for<sp/>fee<sp/>reasons.<sp/>Provide<sp/>the<sp/>effective<sp/>feerate<sp/>and<sp/>which<sp/>tx<sp/>was<sp/>included.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_mempool_accept_result_1a6fbe5db652a0290ae352d7c03964e6de" kindref="member">MempoolAcceptResult::FeeFailure</ref>(ws.m_state,<sp/>CFeeRate(ws.m_modified_fees,<sp/>ws.m_vsize),<sp/>single_wtxid);</highlight></codeline>
<codeline lineno="1345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_mempool_accept_result_1af068e8d0ef73ea6eb79c045cc100558c" kindref="member">MempoolAcceptResult::Failure</ref>(ws.m_state);</highlight></codeline>
<codeline lineno="1347"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1348"><highlight class="normal"></highlight></codeline>
<codeline lineno="1349"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_subpackage.m_rbf<sp/>&amp;&amp;<sp/>!ReplacementChecks(ws))<sp/>{</highlight></codeline>
<codeline lineno="1350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ws.m_state.GetResult()<sp/>==<sp/><ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fada14c3503154c47fa98ac835983a5581" kindref="member">TxValidationResult::TX_RECONSIDERABLE</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1351"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Failed<sp/>for<sp/>incentives-based<sp/>fee<sp/>reasons.<sp/>Provide<sp/>the<sp/>effective<sp/>feerate<sp/>and<sp/>which<sp/>tx<sp/>was<sp/>included.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1352"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_mempool_accept_result_1a6fbe5db652a0290ae352d7c03964e6de" kindref="member">MempoolAcceptResult::FeeFailure</ref>(ws.m_state,<sp/>CFeeRate(ws.m_modified_fees,<sp/>ws.m_vsize),<sp/>single_wtxid);</highlight></codeline>
<codeline lineno="1353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_mempool_accept_result_1af068e8d0ef73ea6eb79c045cc100558c" kindref="member">MempoolAcceptResult::Failure</ref>(ws.m_state);</highlight></codeline>
<codeline lineno="1355"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1356"><highlight class="normal"></highlight></codeline>
<codeline lineno="1357"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>if<sp/>the<sp/>transaction<sp/>would<sp/>exceed<sp/>the<sp/>cluster<sp/>size<sp/>limit.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1358"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_subpackage.m_changeset-&gt;CheckMemPoolPolicyLimits())<sp/>{</highlight></codeline>
<codeline lineno="1359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ws.m_state.Invalid(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa2dbed613ade117d8c58d8d230618efe4" kindref="member">TxValidationResult::TX_MEMPOOL_POLICY</ref>,<sp/></highlight><highlight class="stringliteral">&quot;too-large-cluster&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_mempool_accept_result_1af068e8d0ef73ea6eb79c045cc100558c" kindref="member">MempoolAcceptResult::Failure</ref>(ws.m_state);</highlight></codeline>
<codeline lineno="1361"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1362"><highlight class="normal"></highlight></codeline>
<codeline lineno="1363"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Now<sp/>that<sp/>we&apos;ve<sp/>verified<sp/>the<sp/>cluster<sp/>limit<sp/>is<sp/>respected,<sp/>we<sp/>can<sp/>perform</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1364"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>calculations<sp/>involving<sp/>the<sp/>full<sp/>ancestors<sp/>of<sp/>the<sp/>tx.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1365"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ws.m_conflicts.size())<sp/>{</highlight></codeline>
<codeline lineno="1366"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>ancestors<sp/>=<sp/>m_subpackage.m_changeset-&gt;CalculateMemPoolAncestors(ws.m_tx_handle);</highlight></codeline>
<codeline lineno="1367"><highlight class="normal"></highlight></codeline>
<codeline lineno="1368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>A<sp/>transaction<sp/>that<sp/>spends<sp/>outputs<sp/>that<sp/>would<sp/>be<sp/>replaced<sp/>by<sp/>it<sp/>is<sp/>invalid.<sp/>Now</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1369"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>that<sp/>we<sp/>have<sp/>the<sp/>set<sp/>of<sp/>all<sp/>ancestors<sp/>we<sp/>can<sp/>detect<sp/>this</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1370"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>pathological<sp/>case<sp/>by<sp/>making<sp/>sure<sp/>ws.m_conflicts<sp/>and<sp/>this<sp/>tx&apos;s<sp/>ancestors<sp/>don&apos;t</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1371"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>intersect.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>err_string{<ref refid="policy_2rbf_8cpp_1aefb8bb2b6c313b8f80c5dd8247c96460" kindref="member">EntriesAndTxidsDisjoint</ref>(ancestors,<sp/>ws.m_conflicts,<sp/>ptx-&gt;GetHash())})<sp/>{</highlight></codeline>
<codeline lineno="1373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>classify<sp/>this<sp/>as<sp/>a<sp/>consensus<sp/>error<sp/>because<sp/>a<sp/>transaction<sp/>depending<sp/>on<sp/>something<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>conflicts<sp/>with<sp/>would<sp/>be<sp/>inconsistent.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1375"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ws.m_state.Invalid(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fad623c6a3361887cbd2cf1fe3c2bfb261" kindref="member">TxValidationResult::TX_CONSENSUS</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-txns-spends-conflicting-tx&quot;</highlight><highlight class="normal">,<sp/>*err_string);</highlight></codeline>
<codeline lineno="1376"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_mempool_accept_result_1af068e8d0ef73ea6eb79c045cc100558c" kindref="member">MempoolAcceptResult::Failure</ref>(ws.m_state);</highlight></codeline>
<codeline lineno="1377"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1378"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1379"><highlight class="normal"></highlight></codeline>
<codeline lineno="1380"><highlight class="normal"><sp/><sp/><sp/><sp/>m_subpackage.m_total_vsize<sp/>=<sp/>ws.m_vsize;</highlight></codeline>
<codeline lineno="1381"><highlight class="normal"><sp/><sp/><sp/><sp/>m_subpackage.m_total_modified_fees<sp/>=<sp/>ws.m_modified_fees;</highlight></codeline>
<codeline lineno="1382"><highlight class="normal"></highlight></codeline>
<codeline lineno="1383"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Individual<sp/>modified<sp/>feerate<sp/>exceeded<sp/>caller-defined<sp/>max;<sp/>abort</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1384"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_client_maxfeerate<sp/>&amp;&amp;<sp/>CFeeRate(ws.m_modified_fees,<sp/>ws.m_vsize)<sp/>&gt;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_client_maxfeerate.value())<sp/>{</highlight></codeline>
<codeline lineno="1385"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ws.m_state.Invalid(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa2dbed613ade117d8c58d8d230618efe4" kindref="member">TxValidationResult::TX_MEMPOOL_POLICY</ref>,<sp/></highlight><highlight class="stringliteral">&quot;max<sp/>feerate<sp/>exceeded&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_mempool_accept_result_1af068e8d0ef73ea6eb79c045cc100558c" kindref="member">MempoolAcceptResult::Failure</ref>(ws.m_state);</highlight></codeline>
<codeline lineno="1387"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1388"><highlight class="normal"></highlight></codeline>
<codeline lineno="1389"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1a9c745fcc8a902365ed061502bfd9ead4" kindref="member">require_standard</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1390"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="transaction__identifier_8h_1a23364c1312d4dffbbf549b4440333fd9" kindref="member">Wtxid</ref><sp/>dummy_wtxid;</highlight></codeline>
<codeline lineno="1391"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="ephemeral__policy_8cpp_1a36520c63ad736ab372a46a44d24cd004" kindref="member">CheckEphemeralSpends</ref>(</highlight><highlight class="comment">/*package=*/</highlight><highlight class="normal">{ptx},<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1a74d2824c9989899d478845774c046ed6" kindref="member">dust_relay_feerate</ref>,<sp/>m_pool,<sp/>ws.m_state,<sp/>dummy_wtxid))<sp/>{</highlight></codeline>
<codeline lineno="1392"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_mempool_accept_result_1af068e8d0ef73ea6eb79c045cc100558c" kindref="member">MempoolAcceptResult::Failure</ref>(ws.m_state);</highlight></codeline>
<codeline lineno="1393"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1394"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1395"><highlight class="normal"></highlight></codeline>
<codeline lineno="1396"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Perform<sp/>the<sp/>inexpensive<sp/>checks<sp/>first<sp/>and<sp/>avoid<sp/>hashing<sp/>and<sp/>signature<sp/>verification<sp/>unless</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1397"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>those<sp/>checks<sp/>pass,<sp/>to<sp/>mitigate<sp/>CPU<sp/>exhaustion<sp/>denial-of-service<sp/>attacks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1398"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!PolicyScriptChecks(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>,<sp/>ws))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_mempool_accept_result_1af068e8d0ef73ea6eb79c045cc100558c" kindref="member">MempoolAcceptResult::Failure</ref>(ws.m_state);</highlight></codeline>
<codeline lineno="1399"><highlight class="normal"></highlight></codeline>
<codeline lineno="1400"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!ConsensusScriptChecks(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>,<sp/>ws))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_mempool_accept_result_1af068e8d0ef73ea6eb79c045cc100558c" kindref="member">MempoolAcceptResult::Failure</ref>(ws.m_state);</highlight></codeline>
<codeline lineno="1401"><highlight class="normal"></highlight></codeline>
<codeline lineno="1402"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CFeeRate<sp/>effective_feerate{ws.m_modified_fees,<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="normal">int32_t</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(ws.m_vsize)};</highlight></codeline>
<codeline lineno="1403"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Tx<sp/>was<sp/>accepted,<sp/>but<sp/>not<sp/>added</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1404"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_test_accept)<sp/>{</highlight></codeline>
<codeline lineno="1405"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_mempool_accept_result_1ae8bd22448958950d717420133c2074f4" kindref="member">MempoolAcceptResult::Success</ref>(std::move(m_subpackage.m_replaced_transactions),<sp/>ws.m_vsize,</highlight></codeline>
<codeline lineno="1406"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ws.m_base_fees,<sp/>effective_feerate,<sp/>single_wtxid);</highlight></codeline>
<codeline lineno="1407"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1408"><highlight class="normal"></highlight></codeline>
<codeline lineno="1409"><highlight class="normal"><sp/><sp/><sp/><sp/>FinalizeSubpackage(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>);</highlight></codeline>
<codeline lineno="1410"><highlight class="normal"></highlight></codeline>
<codeline lineno="1411"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Limit<sp/>the<sp/>mempool,<sp/>if<sp/>appropriate.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1412"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_package_submission<sp/>&amp;&amp;<sp/>!<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_bypass_limits)<sp/>{</highlight></codeline>
<codeline lineno="1413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LimitMempoolSize(m_pool,<sp/>m_active_chainstate.<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>());</highlight></codeline>
<codeline lineno="1414"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>mempool<sp/>contents<sp/>change,<sp/>then<sp/>the<sp/>m_view<sp/>cache<sp/>is<sp/>dirty.<sp/>Given<sp/>this<sp/>isn&apos;t<sp/>a<sp/>package</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>submission,<sp/>we<sp/>won&apos;t<sp/>be<sp/>using<sp/>the<sp/>cache<sp/>anymore,<sp/>but<sp/>clear<sp/>it<sp/>anyway<sp/>for<sp/>clarity.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1416"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CleanupTemporaryCoins();</highlight></codeline>
<codeline lineno="1417"><highlight class="normal"></highlight></codeline>
<codeline lineno="1418"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_pool.<ref refid="class_c_tx_mem_pool_1a4f1dcdad840ef946c9925b0f4a0f95b9" kindref="member">exists</ref>(ws.m_hash))<sp/>{</highlight></codeline>
<codeline lineno="1419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>tx<sp/>no<sp/>longer<sp/>meets<sp/>our<sp/>(new)<sp/>mempool<sp/>minimum<sp/>feerate<sp/>but<sp/>could<sp/>be<sp/>reconsidered<sp/>in<sp/>a<sp/>package.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ws.m_state.Invalid(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fada14c3503154c47fa98ac835983a5581" kindref="member">TxValidationResult::TX_RECONSIDERABLE</ref>,<sp/></highlight><highlight class="stringliteral">&quot;mempool<sp/>full&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1421"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_mempool_accept_result_1a6fbe5db652a0290ae352d7c03964e6de" kindref="member">MempoolAcceptResult::FeeFailure</ref>(ws.m_state,<sp/>CFeeRate(ws.m_modified_fees,<sp/>ws.m_vsize),<sp/>{ws.m_ptx-&gt;GetWitnessHash()});</highlight></codeline>
<codeline lineno="1422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1423"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1424"><highlight class="normal"></highlight></codeline>
<codeline lineno="1425"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1a08c1845611020458495472ea71190a4c" kindref="member">signals</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1426"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CTransaction&amp;<sp/>tx<sp/>=<sp/>*ws.m_ptx;</highlight></codeline>
<codeline lineno="1427"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>iter<sp/>=<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1ae2097b56302767d8ec0fb585bce77490" kindref="member">GetIter</ref>(tx.<ref refid="class_c_transaction_1a919ff1093793433f4717d74fb751423b" kindref="member">GetHash</ref>());</highlight></codeline>
<codeline lineno="1428"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(iter.has_value());</highlight></codeline>
<codeline lineno="1429"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>tx_info<sp/>=<sp/>NewMempoolTransactionInfo(ws.m_ptx,<sp/>ws.m_base_fees,</highlight></codeline>
<codeline lineno="1430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ws.m_vsize,<sp/>(*iter)-&gt;GetHeight(),</highlight></codeline>
<codeline lineno="1431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_bypass_limits,<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_package_submission,</highlight></codeline>
<codeline lineno="1432"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>IsCurrentForFeeEstimation(m_active_chainstate),</highlight></codeline>
<codeline lineno="1433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a759a72decf76f3d5ee1855c68e064336" kindref="member">HasNoInputsOf</ref>(tx));</highlight></codeline>
<codeline lineno="1434"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1a08c1845611020458495472ea71190a4c" kindref="member">signals</ref>-&gt;<ref refid="class_validation_signals_1ac89cfc9809a6c4d4b68af1cf3fdc3fc9" kindref="member">TransactionAddedToMempool</ref>(tx_info,<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a2720ea12b86320ed18e584725ea3cf76" kindref="member">GetAndIncrementSequence</ref>());</highlight></codeline>
<codeline lineno="1435"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1436"><highlight class="normal"></highlight></codeline>
<codeline lineno="1437"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_subpackage.m_replaced_transactions.empty())<sp/>{</highlight></codeline>
<codeline lineno="1438"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395afb374f9d778e803545f3af036ca147a0" kindref="member">BCLog::MEMPOOL</ref>,<sp/></highlight><highlight class="stringliteral">&quot;replaced<sp/>%u<sp/>mempool<sp/>transactions<sp/>with<sp/>1<sp/>new<sp/>transaction<sp/>for<sp/>%s<sp/>additional<sp/>fees,<sp/>%d<sp/>delta<sp/>bytes\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1439"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_subpackage.m_replaced_transactions.size(),</highlight></codeline>
<codeline lineno="1440"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ws.m_modified_fees<sp/>-<sp/>m_subpackage.m_conflicting_fees,</highlight></codeline>
<codeline lineno="1441"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ws.m_vsize<sp/>-<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">int</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(m_subpackage.m_conflicting_size));</highlight></codeline>
<codeline lineno="1442"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1443"><highlight class="normal"></highlight></codeline>
<codeline lineno="1444"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_mempool_accept_result_1ae8bd22448958950d717420133c2074f4" kindref="member">MempoolAcceptResult::Success</ref>(std::move(m_subpackage.m_replaced_transactions),<sp/>ws.m_vsize,<sp/>ws.m_base_fees,</highlight></codeline>
<codeline lineno="1445"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>effective_feerate,<sp/>single_wtxid);</highlight></codeline>
<codeline lineno="1446"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1447"><highlight class="normal"></highlight></codeline>
<codeline lineno="1448"><highlight class="normal">PackageMempoolAcceptResult<sp/>MemPoolAccept::AcceptMultipleTransactionsInternal(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;CTransactionRef&gt;&amp;<sp/>txns,<sp/>ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>)</highlight></codeline>
<codeline lineno="1449"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1450"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1451"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(m_pool.<ref refid="class_c_tx_mem_pool_1ab322659c2acf98d3bb6e877e69414281" kindref="member">cs</ref>);</highlight></codeline>
<codeline lineno="1452"><highlight class="normal"></highlight></codeline>
<codeline lineno="1453"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>These<sp/>context-free<sp/>package<sp/>limits<sp/>can<sp/>be<sp/>done<sp/>before<sp/>taking<sp/>the<sp/>mempool<sp/>lock.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1454"><highlight class="normal"><sp/><sp/><sp/><sp/>PackageValidationState<sp/>package_state;</highlight></codeline>
<codeline lineno="1455"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="packages_8cpp_1a50f9cda6e16fa7ee7dff89e989948635" kindref="member">IsWellFormedPackage</ref>(txns,<sp/>package_state,<sp/></highlight><highlight class="comment">/*require_sorted=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>PackageMempoolAcceptResult(package_state,<sp/>{});</highlight></codeline>
<codeline lineno="1456"><highlight class="normal"></highlight></codeline>
<codeline lineno="1457"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;Workspace&gt;<sp/>workspaces{};</highlight></codeline>
<codeline lineno="1458"><highlight class="normal"><sp/><sp/><sp/><sp/>workspaces.reserve(txns.size());</highlight></codeline>
<codeline lineno="1459"><highlight class="normal"><sp/><sp/><sp/><sp/>std::transform(txns.cbegin(),<sp/>txns.cend(),<sp/>std::back_inserter(workspaces),</highlight></codeline>
<codeline lineno="1460"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[](</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tx)<sp/>{<sp/>return<sp/>Workspace(tx);<sp/>});</highlight></codeline>
<codeline lineno="1461"><highlight class="normal"><sp/><sp/><sp/><sp/>std::map&lt;Wtxid,<sp/>MempoolAcceptResult&gt;<sp/>results;</highlight></codeline>
<codeline lineno="1462"><highlight class="normal"></highlight></codeline>
<codeline lineno="1463"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Do<sp/>all<sp/>PreChecks<sp/>first<sp/>and<sp/>fail<sp/>fast<sp/>to<sp/>avoid<sp/>running<sp/>expensive<sp/>script<sp/>checks<sp/>when<sp/>unnecessary.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1464"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(Workspace&amp;<sp/>ws<sp/>:<sp/>workspaces)<sp/>{</highlight></codeline>
<codeline lineno="1465"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!PreChecks(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>,<sp/>ws))<sp/>{</highlight></codeline>
<codeline lineno="1466"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>package_state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284adeacea0c39c3a371628a2be46457c1e3" kindref="member">PackageValidationResult::PCKG_TX</ref>,<sp/></highlight><highlight class="stringliteral">&quot;transaction<sp/>failed&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1467"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Exit<sp/>early<sp/>to<sp/>avoid<sp/>doing<sp/>pointless<sp/>work.<sp/>Update<sp/>the<sp/>failed<sp/>tx<sp/>result;<sp/>the<sp/>rest<sp/>are<sp/>unfinished.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1468"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>results.emplace(ws.m_ptx-&gt;GetWitnessHash(),<sp/><ref refid="struct_mempool_accept_result_1af068e8d0ef73ea6eb79c045cc100558c" kindref="member">MempoolAcceptResult::Failure</ref>(ws.m_state));</highlight></codeline>
<codeline lineno="1469"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>PackageMempoolAcceptResult(package_state,<sp/>std::move(results));</highlight></codeline>
<codeline lineno="1470"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1471"><highlight class="normal"></highlight></codeline>
<codeline lineno="1472"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Individual<sp/>modified<sp/>feerate<sp/>exceeded<sp/>caller-defined<sp/>max;<sp/>abort</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1473"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>N.B.<sp/>this<sp/>doesn&apos;t<sp/>take<sp/>into<sp/>account<sp/>CPFPs.<sp/>Chunk-aware<sp/>validation<sp/>may<sp/>be<sp/>more<sp/>robust.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1474"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_client_maxfeerate<sp/>&amp;&amp;<sp/>CFeeRate(ws.m_modified_fees,<sp/>ws.m_vsize)<sp/>&gt;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_client_maxfeerate.value())<sp/>{</highlight></codeline>
<codeline lineno="1475"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Need<sp/>to<sp/>set<sp/>failure<sp/>here<sp/>both<sp/>individually<sp/>and<sp/>at<sp/>package<sp/>level</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1476"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ws.m_state.Invalid(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa2dbed613ade117d8c58d8d230618efe4" kindref="member">TxValidationResult::TX_MEMPOOL_POLICY</ref>,<sp/></highlight><highlight class="stringliteral">&quot;max<sp/>feerate<sp/>exceeded&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1477"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>package_state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284adeacea0c39c3a371628a2be46457c1e3" kindref="member">PackageValidationResult::PCKG_TX</ref>,<sp/></highlight><highlight class="stringliteral">&quot;transaction<sp/>failed&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1478"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Exit<sp/>early<sp/>to<sp/>avoid<sp/>doing<sp/>pointless<sp/>work.<sp/>Update<sp/>the<sp/>failed<sp/>tx<sp/>result;<sp/>the<sp/>rest<sp/>are<sp/>unfinished.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1479"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>results.emplace(ws.m_ptx-&gt;GetWitnessHash(),<sp/><ref refid="struct_mempool_accept_result_1af068e8d0ef73ea6eb79c045cc100558c" kindref="member">MempoolAcceptResult::Failure</ref>(ws.m_state));</highlight></codeline>
<codeline lineno="1480"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>PackageMempoolAcceptResult(package_state,<sp/>std::move(results));</highlight></codeline>
<codeline lineno="1481"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1482"><highlight class="normal"></highlight></codeline>
<codeline lineno="1483"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Make<sp/>the<sp/>coins<sp/>created<sp/>by<sp/>this<sp/>transaction<sp/>available<sp/>for<sp/>subsequent<sp/>transactions<sp/>in<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1484"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>package<sp/>to<sp/>spend.<sp/>If<sp/>there<sp/>are<sp/>no<sp/>conflicts<sp/>within<sp/>the<sp/>package,<sp/>no<sp/>transaction<sp/>can<sp/>spend<sp/>a<sp/>coin</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1485"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>needed<sp/>by<sp/>another<sp/>transaction<sp/>in<sp/>the<sp/>package.<sp/>We<sp/>also<sp/>need<sp/>to<sp/>make<sp/>sure<sp/>that<sp/>no<sp/>package</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1486"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>tx<sp/>replaces<sp/>(or<sp/>replaces<sp/>the<sp/>ancestor<sp/>of)<sp/>the<sp/>parent<sp/>of<sp/>another<sp/>package<sp/>tx.<sp/>As<sp/>long<sp/>as<sp/>we</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1487"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>check<sp/>these<sp/>two<sp/>things,<sp/>we<sp/>don&apos;t<sp/>need<sp/>to<sp/>track<sp/>the<sp/>coins<sp/>spent.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1488"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>a<sp/>package<sp/>tx<sp/>conflicts<sp/>with<sp/>a<sp/>mempool<sp/>tx,<sp/>PackageMempoolChecks()<sp/>ensures<sp/>later<sp/>that<sp/>any<sp/>package<sp/>RBF<sp/>attempt</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1489"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>has<sp/>*no*<sp/>in-mempool<sp/>ancestors,<sp/>so<sp/>we<sp/>don&apos;t<sp/>have<sp/>to<sp/>worry<sp/>about<sp/>subsequent<sp/>transactions<sp/>in</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>same<sp/>package<sp/>spending<sp/>the<sp/>same<sp/>in-mempool<sp/>outpoints.<sp/>This<sp/>needs<sp/>to<sp/>be<sp/>revisited<sp/>for<sp/>general</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1491"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>package<sp/>RBF.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_viewmempool.<ref refid="class_c_coins_view_mem_pool_1ac87b57e566d3dca1d7e968ecb5c71305" kindref="member">PackageAddTransaction</ref>(ws.m_ptx);</highlight></codeline>
<codeline lineno="1493"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1494"><highlight class="normal"></highlight></codeline>
<codeline lineno="1495"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>At<sp/>this<sp/>point<sp/>we<sp/>have<sp/>all<sp/>in-mempool<sp/>parents,<sp/>and<sp/>we<sp/>know<sp/>every<sp/>transaction&apos;s<sp/>vsize.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1496"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Run<sp/>the<sp/>TRUC<sp/>checks<sp/>on<sp/>the<sp/>package.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1497"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(Workspace&amp;<sp/>ws<sp/>:<sp/>workspaces)<sp/>{</highlight></codeline>
<codeline lineno="1498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>err{<ref refid="truc__policy_8cpp_1afe77a5703a3621b3c82c2a1490fbe305" kindref="member">PackageTRUCChecks</ref>(m_pool,<sp/>ws.m_ptx,<sp/>ws.m_vsize,<sp/>txns,<sp/>ws.m_parents)})<sp/>{</highlight></codeline>
<codeline lineno="1499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>package_state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284a87a19a0e7858be85913a6cff1b1eab4e" kindref="member">PackageValidationResult::PCKG_POLICY</ref>,<sp/></highlight><highlight class="stringliteral">&quot;TRUC-violation&quot;</highlight><highlight class="normal">,<sp/>err.value());</highlight></codeline>
<codeline lineno="1500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>PackageMempoolAcceptResult(package_state,<sp/>{});</highlight></codeline>
<codeline lineno="1501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1502"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1503"><highlight class="normal"></highlight></codeline>
<codeline lineno="1504"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Transactions<sp/>must<sp/>meet<sp/>two<sp/>minimum<sp/>feerates:<sp/>the<sp/>mempool<sp/>minimum<sp/>fee<sp/>and<sp/>min<sp/>relay<sp/>fee.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1505"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>For<sp/>transactions<sp/>consisting<sp/>of<sp/>exactly<sp/>one<sp/>child<sp/>and<sp/>its<sp/>parents,<sp/>it<sp/>suffices<sp/>to<sp/>use<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1506"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>package<sp/>feerate<sp/>(total<sp/>modified<sp/>fees<sp/>/<sp/>total<sp/>virtual<sp/>size)<sp/>to<sp/>check<sp/>this<sp/>requirement.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1507"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note<sp/>that<sp/>this<sp/>is<sp/>an<sp/>aggregate<sp/>feerate;<sp/>this<sp/>function<sp/>has<sp/>not<sp/>checked<sp/>that<sp/>there<sp/>are<sp/>transactions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1508"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>too<sp/>low<sp/>feerate<sp/>to<sp/>pay<sp/>for<sp/>themselves,<sp/>or<sp/>that<sp/>the<sp/>child<sp/>transactions<sp/>are<sp/>higher<sp/>feerate<sp/>than</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1509"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>their<sp/>parents.<sp/>Using<sp/>aggregate<sp/>feerate<sp/>may<sp/>allow<sp/>&quot;parents<sp/>pay<sp/>for<sp/>child&quot;<sp/>behavior<sp/>and<sp/>permit</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1510"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>a<sp/>child<sp/>that<sp/>is<sp/>below<sp/>mempool<sp/>minimum<sp/>feerate.<sp/>To<sp/>avoid<sp/>these<sp/>behaviors,<sp/>callers<sp/>of</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1511"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>AcceptMultipleTransactions<sp/>need<sp/>to<sp/>restrict<sp/>txns<sp/>topology<sp/>(e.g.<sp/>to<sp/>ancestor<sp/>sets)<sp/>and<sp/>check</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1512"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>feerates<sp/>of<sp/>individuals<sp/>and<sp/>subsets.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1513"><highlight class="normal"><sp/><sp/><sp/><sp/>m_subpackage.m_total_vsize<sp/>=<sp/>std::accumulate(workspaces.cbegin(),<sp/>workspaces.cend(),<sp/>int64_t{0},</highlight></codeline>
<codeline lineno="1514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[](int64_t<sp/><ref refid="examples_8cpp_1a936f4b586a8f869a9d0d197cc5110653" kindref="member">sum</ref>,<sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>ws)<sp/>{<sp/>return<sp/>sum<sp/>+<sp/>ws.m_vsize;<sp/>});</highlight></codeline>
<codeline lineno="1515"><highlight class="normal"><sp/><sp/><sp/><sp/>m_subpackage.m_total_modified_fees<sp/>=<sp/>std::accumulate(workspaces.cbegin(),<sp/>workspaces.cend(),<sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref>{0},</highlight></codeline>
<codeline lineno="1516"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[](<ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/><ref refid="examples_8cpp_1a936f4b586a8f869a9d0d197cc5110653" kindref="member">sum</ref>,<sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>ws)<sp/>{<sp/>return<sp/>sum<sp/>+<sp/>ws.m_modified_fees;<sp/>});</highlight></codeline>
<codeline lineno="1517"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CFeeRate<sp/>package_feerate(m_subpackage.m_total_modified_fees,<sp/>m_subpackage.m_total_vsize);</highlight></codeline>
<codeline lineno="1518"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;Wtxid&gt;<sp/>all_package_wtxids;</highlight></codeline>
<codeline lineno="1519"><highlight class="normal"><sp/><sp/><sp/><sp/>all_package_wtxids.reserve(workspaces.size());</highlight></codeline>
<codeline lineno="1520"><highlight class="normal"><sp/><sp/><sp/><sp/>std::transform(workspaces.cbegin(),<sp/>workspaces.cend(),<sp/>std::back_inserter(all_package_wtxids),</highlight></codeline>
<codeline lineno="1521"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[](</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>ws)<sp/>{<sp/>return<sp/>ws.m_ptx-&gt;GetWitnessHash();<sp/>});</highlight></codeline>
<codeline lineno="1522"><highlight class="normal"><sp/><sp/><sp/><sp/>TxValidationState<sp/>placeholder_state;</highlight></codeline>
<codeline lineno="1523"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_package_feerates<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="1524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!CheckFeeRate(m_subpackage.m_total_vsize,<sp/>m_subpackage.m_total_modified_fees,<sp/>placeholder_state))<sp/>{</highlight></codeline>
<codeline lineno="1525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>package_state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284adeacea0c39c3a371628a2be46457c1e3" kindref="member">PackageValidationResult::PCKG_TX</ref>,<sp/></highlight><highlight class="stringliteral">&quot;transaction<sp/>failed&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1526"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>PackageMempoolAcceptResult(package_state,<sp/>{{workspaces.back().m_ptx-&gt;GetWitnessHash(),</highlight></codeline>
<codeline lineno="1527"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_mempool_accept_result_1a6fbe5db652a0290ae352d7c03964e6de" kindref="member">MempoolAcceptResult::FeeFailure</ref>(placeholder_state,<sp/>CFeeRate(m_subpackage.m_total_modified_fees,<sp/>m_subpackage.m_total_vsize),<sp/>all_package_wtxids)}});</highlight></codeline>
<codeline lineno="1528"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1529"><highlight class="normal"></highlight></codeline>
<codeline lineno="1530"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Apply<sp/>package<sp/>mempool<sp/>RBF<sp/>checks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1531"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!PackageMempoolChecks(txns,<sp/>workspaces,<sp/>m_subpackage.m_total_vsize,<sp/>package_state))<sp/>{</highlight></codeline>
<codeline lineno="1532"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>PackageMempoolAcceptResult(package_state,<sp/>std::move(results));</highlight></codeline>
<codeline lineno="1533"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1534"><highlight class="normal"></highlight></codeline>
<codeline lineno="1535"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>if<sp/>the<sp/>transactions<sp/>would<sp/>exceed<sp/>the<sp/>cluster<sp/>size<sp/>limit.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1536"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_subpackage.m_changeset-&gt;CheckMemPoolPolicyLimits())<sp/>{</highlight></codeline>
<codeline lineno="1537"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>package_state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284a87a19a0e7858be85913a6cff1b1eab4e" kindref="member">PackageValidationResult::PCKG_POLICY</ref>,<sp/></highlight><highlight class="stringliteral">&quot;too-large-cluster&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1538"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>PackageMempoolAcceptResult(package_state,<sp/>std::move(results));</highlight></codeline>
<codeline lineno="1539"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1540"><highlight class="normal"></highlight></codeline>
<codeline lineno="1541"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Now<sp/>that<sp/>we&apos;ve<sp/>bounded<sp/>the<sp/>resulting<sp/>possible<sp/>ancestry<sp/>count,<sp/>check<sp/>package<sp/>for<sp/>dust<sp/>spends</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1542"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1a9c745fcc8a902365ed061502bfd9ead4" kindref="member">require_standard</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1543"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>TxValidationState<sp/>child_state;</highlight></codeline>
<codeline lineno="1544"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="transaction__identifier_8h_1a23364c1312d4dffbbf549b4440333fd9" kindref="member">Wtxid</ref><sp/>child_wtxid;</highlight></codeline>
<codeline lineno="1545"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="ephemeral__policy_8cpp_1a36520c63ad736ab372a46a44d24cd004" kindref="member">CheckEphemeralSpends</ref>(txns,<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1a74d2824c9989899d478845774c046ed6" kindref="member">dust_relay_feerate</ref>,<sp/>m_pool,<sp/>child_state,<sp/>child_wtxid))<sp/>{</highlight></codeline>
<codeline lineno="1546"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>package_state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284adeacea0c39c3a371628a2be46457c1e3" kindref="member">PackageValidationResult::PCKG_TX</ref>,<sp/></highlight><highlight class="stringliteral">&quot;unspent-dust&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1547"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>results.emplace(child_wtxid,<sp/><ref refid="struct_mempool_accept_result_1af068e8d0ef73ea6eb79c045cc100558c" kindref="member">MempoolAcceptResult::Failure</ref>(child_state));</highlight></codeline>
<codeline lineno="1548"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>PackageMempoolAcceptResult(package_state,<sp/>std::move(results));</highlight></codeline>
<codeline lineno="1549"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1550"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1551"><highlight class="normal"></highlight></codeline>
<codeline lineno="1552"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(Workspace&amp;<sp/>ws<sp/>:<sp/>workspaces)<sp/>{</highlight></codeline>
<codeline lineno="1553"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ws.m_package_feerate<sp/>=<sp/>package_feerate;</highlight></codeline>
<codeline lineno="1554"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!PolicyScriptChecks(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>,<sp/>ws))<sp/>{</highlight></codeline>
<codeline lineno="1555"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Exit<sp/>early<sp/>to<sp/>avoid<sp/>doing<sp/>pointless<sp/>work.<sp/>Update<sp/>the<sp/>failed<sp/>tx<sp/>result;<sp/>the<sp/>rest<sp/>are<sp/>unfinished.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1556"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>package_state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284adeacea0c39c3a371628a2be46457c1e3" kindref="member">PackageValidationResult::PCKG_TX</ref>,<sp/></highlight><highlight class="stringliteral">&quot;transaction<sp/>failed&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1557"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>results.emplace(ws.m_ptx-&gt;GetWitnessHash(),<sp/><ref refid="struct_mempool_accept_result_1af068e8d0ef73ea6eb79c045cc100558c" kindref="member">MempoolAcceptResult::Failure</ref>(ws.m_state));</highlight></codeline>
<codeline lineno="1558"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>PackageMempoolAcceptResult(package_state,<sp/>std::move(results));</highlight></codeline>
<codeline lineno="1559"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1560"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_test_accept)<sp/>{</highlight></codeline>
<codeline lineno="1561"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>effective_feerate<sp/>=<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_package_feerates<sp/>?<sp/>ws.m_package_feerate<sp/>:</highlight></codeline>
<codeline lineno="1562"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CFeeRate{ws.m_modified_fees,<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="normal">int32_t</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(ws.m_vsize)};</highlight></codeline>
<codeline lineno="1563"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>effective_feerate_wtxids<sp/>=<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_package_feerates<sp/>?<sp/>all_package_wtxids<sp/>:</highlight></codeline>
<codeline lineno="1564"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;Wtxid&gt;{ws.m_ptx-&gt;GetWitnessHash()};</highlight></codeline>
<codeline lineno="1565"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>results.emplace(ws.m_ptx-&gt;GetWitnessHash(),</highlight></codeline>
<codeline lineno="1566"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_mempool_accept_result_1ae8bd22448958950d717420133c2074f4" kindref="member">MempoolAcceptResult::Success</ref>(std::move(m_subpackage.m_replaced_transactions),</highlight></codeline>
<codeline lineno="1567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ws.m_vsize,<sp/>ws.m_base_fees,<sp/>effective_feerate,</highlight></codeline>
<codeline lineno="1568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>effective_feerate_wtxids));</highlight></codeline>
<codeline lineno="1569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1570"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1571"><highlight class="normal"></highlight></codeline>
<codeline lineno="1572"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>.m_test_accept)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>PackageMempoolAcceptResult(package_state,<sp/>std::move(results));</highlight></codeline>
<codeline lineno="1573"><highlight class="normal"></highlight></codeline>
<codeline lineno="1574"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!SubmitPackage(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>,<sp/>workspaces,<sp/>package_state,<sp/>results))<sp/>{</highlight></codeline>
<codeline lineno="1575"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>PackageValidationState<sp/>filled<sp/>in<sp/>by<sp/>SubmitPackage().</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1576"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>PackageMempoolAcceptResult(package_state,<sp/>std::move(results));</highlight></codeline>
<codeline lineno="1577"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1578"><highlight class="normal"></highlight></codeline>
<codeline lineno="1579"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>PackageMempoolAcceptResult(package_state,<sp/>std::move(results));</highlight></codeline>
<codeline lineno="1580"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1581"><highlight class="normal"></highlight></codeline>
<codeline lineno="1582"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>MemPoolAccept::CleanupTemporaryCoins()</highlight></codeline>
<codeline lineno="1583"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1584"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>There<sp/>are<sp/>3<sp/>kinds<sp/>of<sp/>coins<sp/>in<sp/>m_view:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1585"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(1)<sp/>Temporary<sp/>coins<sp/>from<sp/>the<sp/>transactions<sp/>in<sp/>subpackage,<sp/>constructed<sp/>by<sp/>m_viewmempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1586"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(2)<sp/>Mempool<sp/>coins<sp/>from<sp/>transactions<sp/>in<sp/>the<sp/>mempool,<sp/>constructed<sp/>by<sp/>m_viewmempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1587"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(3)<sp/>Confirmed<sp/>coins<sp/>fetched<sp/>from<sp/>our<sp/>current<sp/>UTXO<sp/>set.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1588"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1589"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(1)<sp/>Temporary<sp/>coins<sp/>need<sp/>to<sp/>be<sp/>removed,<sp/>regardless<sp/>of<sp/>whether<sp/>the<sp/>transaction<sp/>was<sp/>submitted.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1590"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>transaction<sp/>was<sp/>submitted<sp/>to<sp/>the<sp/>mempool,<sp/>m_viewmempool<sp/>will<sp/>be<sp/>able<sp/>to<sp/>fetch<sp/>them<sp/>from</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1591"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>there.<sp/>If<sp/>it<sp/>wasn&apos;t<sp/>submitted<sp/>to<sp/>mempool,<sp/>it<sp/>is<sp/>incorrect<sp/>to<sp/>keep<sp/>them<sp/>-<sp/>future<sp/>calls<sp/>may<sp/>try</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1592"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>spend<sp/>those<sp/>coins<sp/>that<sp/>don&apos;t<sp/>actually<sp/>exist.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1593"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(2)<sp/>Mempool<sp/>coins<sp/>also<sp/>need<sp/>to<sp/>be<sp/>removed.<sp/>If<sp/>the<sp/>mempool<sp/>contents<sp/>have<sp/>changed<sp/>as<sp/>a<sp/>result</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1594"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>of<sp/>submitting<sp/>or<sp/>replacing<sp/>transactions,<sp/>coins<sp/>previously<sp/>fetched<sp/>from<sp/>mempool<sp/>may<sp/>now<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1595"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>spent<sp/>or<sp/>nonexistent.<sp/>Those<sp/>coins<sp/>need<sp/>to<sp/>be<sp/>deleted<sp/>from<sp/>m_view.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1596"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(3)<sp/>Confirmed<sp/>coins<sp/>don&apos;t<sp/>need<sp/>to<sp/>be<sp/>removed.<sp/>The<sp/>chainstate<sp/>has<sp/>not<sp/>changed<sp/>(we<sp/>are</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1597"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>holding<sp/>cs_main<sp/>and<sp/>no<sp/>blocks<sp/>have<sp/>been<sp/>processed)<sp/>so<sp/>the<sp/>confirmed<sp/>tx<sp/>cannot<sp/>disappear<sp/>like</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1598"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>a<sp/>mempool<sp/>tx<sp/>can.<sp/>The<sp/>coin<sp/>may<sp/>now<sp/>be<sp/>spent<sp/>after<sp/>we<sp/>submitted<sp/>a<sp/>tx<sp/>to<sp/>mempool,<sp/>but</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1599"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>have<sp/>already<sp/>checked<sp/>that<sp/>the<sp/>package<sp/>does<sp/>not<sp/>have<sp/>2<sp/>transactions<sp/>spending<sp/>the<sp/>same<sp/>coin</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1600"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>we<sp/>check<sp/>whether<sp/>a<sp/>mempool<sp/>transaction<sp/>spends<sp/>conflicting<sp/>coins<sp/>(CTxMemPool::GetConflictTx).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1601"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Keeping<sp/>them<sp/>in<sp/>m_view<sp/>is<sp/>an<sp/>optimization<sp/>to<sp/>not<sp/>re-fetch<sp/>confirmed<sp/>coins<sp/>if<sp/>we<sp/>later<sp/>look<sp/>up</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1602"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>inputs<sp/>for<sp/>this<sp/>transaction<sp/>again.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1603"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>outpoint<sp/>:<sp/>m_viewmempool.<ref refid="class_c_coins_view_mem_pool_1aa7efd60fceff20119579f8d11d53d764" kindref="member">GetNonBaseCoins</ref>())<sp/>{</highlight></codeline>
<codeline lineno="1604"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>In<sp/>addition<sp/>to<sp/>resetting<sp/>m_viewmempool,<sp/>we<sp/>also<sp/>need<sp/>to<sp/>manually<sp/>delete<sp/>these<sp/>coins<sp/>from</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1605"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>m_view<sp/>because<sp/>it<sp/>caches<sp/>copies<sp/>of<sp/>the<sp/>coins<sp/>it<sp/>fetched<sp/>from<sp/>m_viewmempool<sp/>previously.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1606"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_view.<ref refid="class_c_coins_view_cache_1ad79839a8f70a58de19104ac6bfbb5ae8" kindref="member">Uncache</ref>(outpoint);</highlight></codeline>
<codeline lineno="1607"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1608"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>deletes<sp/>the<sp/>temporary<sp/>and<sp/>mempool<sp/>coins.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1609"><highlight class="normal"><sp/><sp/><sp/><sp/>m_viewmempool.<ref refid="class_c_coins_view_mem_pool_1a372de693ad40b3f42839c8ec6ac845f4" kindref="member">Reset</ref>();</highlight></codeline>
<codeline lineno="1610"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1611"><highlight class="normal"></highlight></codeline>
<codeline lineno="1612"><highlight class="normal">PackageMempoolAcceptResult<sp/>MemPoolAccept::AcceptSubPackage(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;CTransactionRef&gt;&amp;<sp/>subpackage,<sp/>ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>)</highlight></codeline>
<codeline lineno="1613"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1614"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="1615"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(m_pool.<ref refid="class_c_tx_mem_pool_1ab322659c2acf98d3bb6e877e69414281" kindref="member">cs</ref>);</highlight></codeline>
<codeline lineno="1616"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>result<sp/>=<sp/>[&amp;]()<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>,<sp/>m_pool.<ref refid="class_c_tx_mem_pool_1ab322659c2acf98d3bb6e877e69414281" kindref="member">cs</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1617"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(subpackage.size()<sp/>&gt;<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="1618"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>AcceptMultipleTransactionsInternal(subpackage,<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>);</highlight></codeline>
<codeline lineno="1619"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1620"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tx<sp/>=<sp/>subpackage.front();</highlight></codeline>
<codeline lineno="1621"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ATMPArgs<sp/>single_args<sp/>=<sp/>ATMPArgs::SingleInPackageAccept(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>);</highlight></codeline>
<codeline lineno="1622"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>single_res<sp/>=<sp/>AcceptSingleTransactionInternal(tx,<sp/>single_args);</highlight></codeline>
<codeline lineno="1623"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PackageValidationState<sp/>package_state_wrapped;</highlight></codeline>
<codeline lineno="1624"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(single_res.m_result_type<sp/>!=<sp/><ref refid="struct_mempool_accept_result_1aa71b5fc2a82d29a91db3a734ff892a49ac9f1a6384b1c466d4612f513bd8e13ea" kindref="member">MempoolAcceptResult::ResultType::VALID</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1625"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>package_state_wrapped.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284adeacea0c39c3a371628a2be46457c1e3" kindref="member">PackageValidationResult::PCKG_TX</ref>,<sp/></highlight><highlight class="stringliteral">&quot;transaction<sp/>failed&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1626"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1627"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>PackageMempoolAcceptResult(package_state_wrapped,<sp/>{{tx-&gt;<ref refid="class_c_transaction_1a28dfe8fd260e515f71ec5b75630da11c" kindref="member">GetWitnessHash</ref>(),<sp/>single_res}});</highlight></codeline>
<codeline lineno="1628"><highlight class="normal"><sp/><sp/><sp/><sp/>}();</highlight></codeline>
<codeline lineno="1629"><highlight class="normal"></highlight></codeline>
<codeline lineno="1630"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Clean<sp/>up<sp/>m_view<sp/>and<sp/>m_viewmempool<sp/>so<sp/>that<sp/>other<sp/>subpackage<sp/>evaluations<sp/>don&apos;t<sp/>have<sp/>access<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1631"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>coins<sp/>they<sp/>shouldn&apos;t.<sp/>Keep<sp/>some<sp/>coins<sp/>in<sp/>order<sp/>to<sp/>minimize<sp/>re-fetching<sp/>coins<sp/>from<sp/>the<sp/>UTXO<sp/>set.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1632"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Clean<sp/>up<sp/>package<sp/>feerate<sp/>and<sp/>rbf<sp/>calculations</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1633"><highlight class="normal"><sp/><sp/><sp/><sp/>ClearSubPackageState();</highlight></codeline>
<codeline lineno="1634"><highlight class="normal"></highlight></codeline>
<codeline lineno="1635"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>result;</highlight></codeline>
<codeline lineno="1636"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1637"><highlight class="normal"></highlight></codeline>
<codeline lineno="1638"><highlight class="normal">PackageMempoolAcceptResult<sp/>MemPoolAccept::AcceptPackage(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="packages_8h_1a138b5dbe56c4869308e2bc7a28b51d9c" kindref="member">Package</ref>&amp;<sp/>package,<sp/>ATMPArgs&amp;<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>)</highlight></codeline>
<codeline lineno="1639"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1640"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(!package.empty());</highlight></codeline>
<codeline lineno="1641"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1642"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Used<sp/>if<sp/>returning<sp/>a<sp/>PackageMempoolAcceptResult<sp/>directly<sp/>from<sp/>this<sp/>function.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1643"><highlight class="normal"><sp/><sp/><sp/><sp/>PackageValidationState<sp/>package_state_quit_early;</highlight></codeline>
<codeline lineno="1644"><highlight class="normal"></highlight></codeline>
<codeline lineno="1645"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>There<sp/>are<sp/>two<sp/>topologies<sp/>we<sp/>are<sp/>able<sp/>to<sp/>handle<sp/>through<sp/>this<sp/>function:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1646"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(1)<sp/>A<sp/>single<sp/>transaction</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1647"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(2)<sp/>A<sp/>child-with-parents<sp/>package.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1648"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>that<sp/>the<sp/>package<sp/>is<sp/>well-formed.<sp/>If<sp/>it<sp/>isn&apos;t,<sp/>we<sp/>won&apos;t<sp/>try<sp/>to<sp/>validate<sp/>any<sp/>of<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1649"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transactions<sp/>and<sp/>thus<sp/>won&apos;t<sp/>return<sp/>any<sp/>MempoolAcceptResults,<sp/>just<sp/>a<sp/>package-wide<sp/>error.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1650"><highlight class="normal"></highlight></codeline>
<codeline lineno="1651"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Context-free<sp/>package<sp/>checks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1652"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="packages_8cpp_1a50f9cda6e16fa7ee7dff89e989948635" kindref="member">IsWellFormedPackage</ref>(package,<sp/>package_state_quit_early,<sp/></highlight><highlight class="comment">/*require_sorted=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="1653"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>PackageMempoolAcceptResult(package_state_quit_early,<sp/>{});</highlight></codeline>
<codeline lineno="1654"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1655"><highlight class="normal"></highlight></codeline>
<codeline lineno="1656"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(package.size()<sp/>&gt;<sp/>1<sp/>&amp;&amp;<sp/>!<ref refid="packages_8cpp_1a0959b9a8f47d5ab16f0df8b80b0b488a" kindref="member">IsChildWithParents</ref>(package))<sp/>{</highlight></codeline>
<codeline lineno="1657"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>All<sp/>transactions<sp/>in<sp/>the<sp/>package<sp/>must<sp/>be<sp/>a<sp/>parent<sp/>of<sp/>the<sp/>last<sp/>transaction.<sp/>This<sp/>is<sp/>just<sp/>an</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1658"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>opportunity<sp/>for<sp/>us<sp/>to<sp/>fail<sp/>fast<sp/>on<sp/>a<sp/>context-free<sp/>check<sp/>without<sp/>taking<sp/>the<sp/>mempool<sp/>lock.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1659"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>package_state_quit_early.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284a87a19a0e7858be85913a6cff1b1eab4e" kindref="member">PackageValidationResult::PCKG_POLICY</ref>,<sp/></highlight><highlight class="stringliteral">&quot;package-not-child-with-parents&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1660"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>PackageMempoolAcceptResult(package_state_quit_early,<sp/>{});</highlight></codeline>
<codeline lineno="1661"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1662"><highlight class="normal"></highlight></codeline>
<codeline lineno="1663"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_pool.<ref refid="class_c_tx_mem_pool_1ab322659c2acf98d3bb6e877e69414281" kindref="member">cs</ref>);</highlight></codeline>
<codeline lineno="1664"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Stores<sp/>results<sp/>from<sp/>which<sp/>we<sp/>will<sp/>create<sp/>the<sp/>returned<sp/>PackageMempoolAcceptResult.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1665"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>A<sp/>result<sp/>may<sp/>be<sp/>changed<sp/>if<sp/>a<sp/>mempool<sp/>transaction<sp/>is<sp/>evicted<sp/>later<sp/>due<sp/>to<sp/>LimitMempoolSize().</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1666"><highlight class="normal"><sp/><sp/><sp/><sp/>std::map&lt;Wtxid,<sp/>MempoolAcceptResult&gt;<sp/>results_final;</highlight></codeline>
<codeline lineno="1667"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Results<sp/>from<sp/>individual<sp/>validation<sp/>which<sp/>will<sp/>be<sp/>returned<sp/>if<sp/>no<sp/>other<sp/>result<sp/>is<sp/>available<sp/>for</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1668"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>this<sp/>transaction.<sp/>&quot;Nonfinal&quot;<sp/>because<sp/>if<sp/>a<sp/>transaction<sp/>fails<sp/>by<sp/>itself<sp/>but<sp/>succeeds<sp/>later</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1669"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(i.e.<sp/>when<sp/>evaluated<sp/>with<sp/>a<sp/>fee-bumping<sp/>child),<sp/>the<sp/>result<sp/>in<sp/>this<sp/>map<sp/>may<sp/>be<sp/>discarded.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1670"><highlight class="normal"><sp/><sp/><sp/><sp/>std::map&lt;Wtxid,<sp/>MempoolAcceptResult&gt;<sp/>individual_results_nonfinal;</highlight></codeline>
<codeline lineno="1671"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Tracks<sp/>whether<sp/>we<sp/>think<sp/>package<sp/>submission<sp/>could<sp/>result<sp/>in<sp/>successful<sp/>entry<sp/>to<sp/>the<sp/>mempool</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1672"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>quit_early{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="1673"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;CTransactionRef&gt;<sp/>txns_package_eval;</highlight></codeline>
<codeline lineno="1674"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tx<sp/>:<sp/>package)<sp/>{</highlight></codeline>
<codeline lineno="1675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>wtxid<sp/>=<sp/>tx-&gt;<ref refid="class_c_transaction_1a28dfe8fd260e515f71ec5b75630da11c" kindref="member">GetWitnessHash</ref>();</highlight></codeline>
<codeline lineno="1676"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>txid<sp/>=<sp/>tx-&gt;<ref refid="class_c_transaction_1a919ff1093793433f4717d74fb751423b" kindref="member">GetHash</ref>();</highlight></codeline>
<codeline lineno="1677"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>There<sp/>are<sp/>3<sp/>possibilities:<sp/>already<sp/>in<sp/>mempool,<sp/>same-txid-diff-wtxid<sp/>already<sp/>in<sp/>mempool,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1678"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>or<sp/>not<sp/>in<sp/>mempool.<sp/>An<sp/>already<sp/>confirmed<sp/>tx<sp/>is<sp/>treated<sp/>as<sp/>one<sp/>not<sp/>in<sp/>mempool,<sp/>because<sp/>all</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1679"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>know<sp/>is<sp/>that<sp/>the<sp/>inputs<sp/>aren&apos;t<sp/>available.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1680"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_pool.<ref refid="class_c_tx_mem_pool_1a4f1dcdad840ef946c9925b0f4a0f95b9" kindref="member">exists</ref>(wtxid))<sp/>{</highlight></codeline>
<codeline lineno="1681"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Exact<sp/>transaction<sp/>already<sp/>exists<sp/>in<sp/>the<sp/>mempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1682"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Node<sp/>operators<sp/>are<sp/>free<sp/>to<sp/>set<sp/>their<sp/>mempool<sp/>policies<sp/>however<sp/>they<sp/>please,<sp/>nodes<sp/>may<sp/>receive</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1683"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transactions<sp/>in<sp/>different<sp/>orders,<sp/>and<sp/>malicious<sp/>counterparties<sp/>may<sp/>try<sp/>to<sp/>take<sp/>advantage<sp/>of</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1684"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>policy<sp/>differences<sp/>to<sp/>pin<sp/>or<sp/>delay<sp/>propagation<sp/>of<sp/>transactions.<sp/>As<sp/>such,<sp/>it&apos;s<sp/>possible<sp/>for</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1685"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>some<sp/>package<sp/>transaction(s)<sp/>to<sp/>already<sp/>be<sp/>in<sp/>the<sp/>mempool,<sp/>and<sp/>we<sp/>don&apos;t<sp/>want<sp/>to<sp/>reject<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1686"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>entire<sp/>package<sp/>in<sp/>that<sp/>case<sp/>(as<sp/>that<sp/>could<sp/>be<sp/>a<sp/>censorship<sp/>vector).<sp/>De-duplicate<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1687"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transactions<sp/>that<sp/>are<sp/>already<sp/>in<sp/>the<sp/>mempool,<sp/>and<sp/>only<sp/>call<sp/>AcceptMultipleTransactions()<sp/>with</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1688"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>new<sp/>transactions.<sp/>This<sp/>ensures<sp/>we<sp/>don&apos;t<sp/>double-count<sp/>transaction<sp/>counts<sp/>and<sp/>sizes<sp/>when</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1689"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>checking<sp/>ancestor/descendant<sp/>limits,<sp/>or<sp/>double-count<sp/>transaction<sp/>fees<sp/>for<sp/>fee-related<sp/>policy.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1690"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>entry{*<ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(m_pool.<ref refid="class_c_tx_mem_pool_1af88c474ce801f62208a5b1f320ba138c" kindref="member">GetEntry</ref>(txid))};</highlight></codeline>
<codeline lineno="1691"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>results_final.emplace(wtxid,<sp/><ref refid="struct_mempool_accept_result_1ab628f26518da6c78aa755a1afaa417ef" kindref="member">MempoolAcceptResult::MempoolTx</ref>(entry.GetTxSize(),<sp/>entry.GetFee()));</highlight></codeline>
<codeline lineno="1692"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_pool.<ref refid="class_c_tx_mem_pool_1a4f1dcdad840ef946c9925b0f4a0f95b9" kindref="member">exists</ref>(txid))<sp/>{</highlight></codeline>
<codeline lineno="1693"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Transaction<sp/>with<sp/>the<sp/>same<sp/>non-witness<sp/>data<sp/>but<sp/>different<sp/>witness<sp/>(same<sp/>txid,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1694"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>different<sp/>wtxid)<sp/>already<sp/>exists<sp/>in<sp/>the<sp/>mempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1695"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1696"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>don&apos;t<sp/>allow<sp/>replacement<sp/>transactions<sp/>right<sp/>now,<sp/>so<sp/>just<sp/>swap<sp/>the<sp/>package</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1697"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transaction<sp/>for<sp/>the<sp/>mempool<sp/>one.<sp/>Note<sp/>that<sp/>we<sp/>are<sp/>ignoring<sp/>the<sp/>validity<sp/>of<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1698"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>package<sp/>transaction<sp/>passed<sp/>in.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1699"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>TODO:<sp/>allow<sp/>witness<sp/>replacement<sp/>in<sp/>packages.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1700"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>entry{*<ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(m_pool.<ref refid="class_c_tx_mem_pool_1af88c474ce801f62208a5b1f320ba138c" kindref="member">GetEntry</ref>(txid))};</highlight></codeline>
<codeline lineno="1701"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Provide<sp/>the<sp/>wtxid<sp/>of<sp/>the<sp/>mempool<sp/>tx<sp/>so<sp/>that<sp/>the<sp/>caller<sp/>can<sp/>look<sp/>it<sp/>up<sp/>in<sp/>the<sp/>mempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1702"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>results_final.emplace(wtxid,<sp/><ref refid="struct_mempool_accept_result_1aaf92f247b94bd5a8914b2c927efc30f5" kindref="member">MempoolAcceptResult::MempoolTxDifferentWitness</ref>(entry.GetTx().GetWitnessHash()));</highlight></codeline>
<codeline lineno="1703"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1704"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Transaction<sp/>does<sp/>not<sp/>already<sp/>exist<sp/>in<sp/>the<sp/>mempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1705"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Try<sp/>submitting<sp/>the<sp/>transaction<sp/>on<sp/>its<sp/>own.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1706"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>single_package_res<sp/>=<sp/>AcceptSubPackage({tx},<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>);</highlight></codeline>
<codeline lineno="1707"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>single_res<sp/>=<sp/>single_package_res.m_tx_results.at(wtxid);</highlight></codeline>
<codeline lineno="1708"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(single_res.m_result_type<sp/>==<sp/><ref refid="struct_mempool_accept_result_1aa71b5fc2a82d29a91db3a734ff892a49ac9f1a6384b1c466d4612f513bd8e13ea" kindref="member">MempoolAcceptResult::ResultType::VALID</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1709"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>transaction<sp/>succeeded<sp/>on<sp/>its<sp/>own<sp/>and<sp/>is<sp/>now<sp/>in<sp/>the<sp/>mempool.<sp/>Don&apos;t<sp/>include<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1710"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>in<sp/>package<sp/>validation,<sp/>because<sp/>its<sp/>fees<sp/>should<sp/>only<sp/>be<sp/>&quot;used&quot;<sp/>once.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1711"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(m_pool.<ref refid="class_c_tx_mem_pool_1a4f1dcdad840ef946c9925b0f4a0f95b9" kindref="member">exists</ref>(wtxid));</highlight></codeline>
<codeline lineno="1712"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>results_final.emplace(wtxid,<sp/>single_res);</highlight></codeline>
<codeline lineno="1713"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(package.size()<sp/>==<sp/>1<sp/>||<sp/></highlight><highlight class="comment">//<sp/>If<sp/>there<sp/>is<sp/>only<sp/>one<sp/>transaction,<sp/>no<sp/>need<sp/>to<sp/>retry<sp/>it<sp/>&quot;as<sp/>a<sp/>package&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1714"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(single_res.m_state.GetResult()<sp/>!=<sp/><ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fada14c3503154c47fa98ac835983a5581" kindref="member">TxValidationResult::TX_RECONSIDERABLE</ref><sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="1715"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>single_res.m_state.GetResult()<sp/>!=<sp/><ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa16d3efb22890f6c8dd36c8e0e81dd796" kindref="member">TxValidationResult::TX_MISSING_INPUTS</ref>))<sp/>{</highlight></codeline>
<codeline lineno="1716"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Package<sp/>validation<sp/>policy<sp/>only<sp/>differs<sp/>from<sp/>individual<sp/>policy<sp/>in<sp/>its<sp/>evaluation</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1717"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>of<sp/>feerate.<sp/>For<sp/>example,<sp/>if<sp/>a<sp/>transaction<sp/>fails<sp/>here<sp/>due<sp/>to<sp/>violation<sp/>of<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1718"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>consensus<sp/>rule,<sp/>the<sp/>result<sp/>will<sp/>not<sp/>change<sp/>when<sp/>it<sp/>is<sp/>submitted<sp/>as<sp/>part<sp/>of<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1719"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>package.<sp/>To<sp/>minimize<sp/>the<sp/>amount<sp/>of<sp/>repeated<sp/>work,<sp/>unless<sp/>the<sp/>transaction<sp/>fails</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1720"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>due<sp/>to<sp/>feerate<sp/>or<sp/>missing<sp/>inputs<sp/>(its<sp/>parent<sp/>is<sp/>a<sp/>previous<sp/>transaction<sp/>in<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1721"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>package<sp/>that<sp/>failed<sp/>due<sp/>to<sp/>feerate),<sp/>don&apos;t<sp/>run<sp/>package<sp/>validation.<sp/>Note<sp/>that<sp/>this</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1722"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>decision<sp/>might<sp/>not<sp/>make<sp/>sense<sp/>if<sp/>different<sp/>types<sp/>of<sp/>packages<sp/>are<sp/>allowed<sp/>in<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1723"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>future.<sp/><sp/>Continue<sp/>individually<sp/>validating<sp/>the<sp/>rest<sp/>of<sp/>the<sp/>transactions,<sp/>because</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1724"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>some<sp/>of<sp/>them<sp/>may<sp/>still<sp/>be<sp/>valid.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1725"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>quit_early<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1726"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>package_state_quit_early.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284adeacea0c39c3a371628a2be46457c1e3" kindref="member">PackageValidationResult::PCKG_TX</ref>,<sp/></highlight><highlight class="stringliteral">&quot;transaction<sp/>failed&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1727"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>individual_results_nonfinal.emplace(wtxid,<sp/>single_res);</highlight></codeline>
<codeline lineno="1728"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1729"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>individual_results_nonfinal.emplace(wtxid,<sp/>single_res);</highlight></codeline>
<codeline lineno="1730"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>txns_package_eval.push_back(tx);</highlight></codeline>
<codeline lineno="1731"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1732"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1733"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1734"><highlight class="normal"></highlight></codeline>
<codeline lineno="1735"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>multi_submission_result<sp/>=<sp/>quit_early<sp/>||<sp/>txns_package_eval.empty()<sp/>?<sp/>PackageMempoolAcceptResult(package_state_quit_early,<sp/>{})<sp/>:</highlight></codeline>
<codeline lineno="1736"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>AcceptSubPackage(txns_package_eval,<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>);</highlight></codeline>
<codeline lineno="1737"><highlight class="normal"><sp/><sp/><sp/><sp/>PackageValidationState&amp;<sp/>package_state_final<sp/>=<sp/>multi_submission_result.m_state;</highlight></codeline>
<codeline lineno="1738"><highlight class="normal"></highlight></codeline>
<codeline lineno="1739"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>is<sp/>invoked<sp/>by<sp/>AcceptSubPackage()<sp/>already,<sp/>so<sp/>this<sp/>is<sp/>just<sp/>here<sp/>for</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1740"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>clarity<sp/>(since<sp/>it&apos;s<sp/>not<sp/>permitted<sp/>to<sp/>invoke<sp/>LimitMempoolSize()<sp/>while<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1741"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>changeset<sp/>is<sp/>outstanding).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1742"><highlight class="normal"><sp/><sp/><sp/><sp/>ClearSubPackageState();</highlight></codeline>
<codeline lineno="1743"><highlight class="normal"></highlight></codeline>
<codeline lineno="1744"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Make<sp/>sure<sp/>we<sp/>haven&apos;t<sp/>exceeded<sp/>max<sp/>mempool<sp/>size.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1745"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Package<sp/>transactions<sp/>that<sp/>were<sp/>submitted<sp/>to<sp/>mempool<sp/>or<sp/>already<sp/>in<sp/>mempool<sp/>may<sp/>be<sp/>evicted.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1746"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>mempool<sp/>contents<sp/>change,<sp/>then<sp/>the<sp/>m_view<sp/>cache<sp/>is<sp/>dirty.<sp/>It<sp/>has<sp/>already<sp/>been<sp/>cleared<sp/>above.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1747"><highlight class="normal"><sp/><sp/><sp/><sp/>LimitMempoolSize(m_pool,<sp/>m_active_chainstate.<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>());</highlight></codeline>
<codeline lineno="1748"><highlight class="normal"></highlight></codeline>
<codeline lineno="1749"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tx<sp/>:<sp/>package)<sp/>{</highlight></codeline>
<codeline lineno="1750"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>wtxid<sp/>=<sp/>tx-&gt;<ref refid="class_c_transaction_1a28dfe8fd260e515f71ec5b75630da11c" kindref="member">GetWitnessHash</ref>();</highlight></codeline>
<codeline lineno="1751"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(multi_submission_result.m_tx_results.contains(wtxid))<sp/>{</highlight></codeline>
<codeline lineno="1752"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>shouldn&apos;t<sp/>have<sp/>re-submitted<sp/>if<sp/>the<sp/>tx<sp/>result<sp/>was<sp/>already<sp/>in<sp/>results_final.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1753"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(!results_final.contains(wtxid));</highlight></codeline>
<codeline lineno="1754"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>it<sp/>was<sp/>submitted,<sp/>check<sp/>to<sp/>see<sp/>if<sp/>the<sp/>tx<sp/>is<sp/>still<sp/>in<sp/>the<sp/>mempool.<sp/>It<sp/>could<sp/>have</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1755"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>been<sp/>evicted<sp/>due<sp/>to<sp/>LimitMempoolSize()<sp/>above.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1756"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>txresult<sp/>=<sp/>multi_submission_result.m_tx_results.at(wtxid);</highlight></codeline>
<codeline lineno="1757"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(txresult.m_result_type<sp/>==<sp/><ref refid="struct_mempool_accept_result_1aa71b5fc2a82d29a91db3a734ff892a49ac9f1a6384b1c466d4612f513bd8e13ea" kindref="member">MempoolAcceptResult::ResultType::VALID</ref><sp/>&amp;&amp;<sp/>!m_pool.<ref refid="class_c_tx_mem_pool_1a4f1dcdad840ef946c9925b0f4a0f95b9" kindref="member">exists</ref>(wtxid))<sp/>{</highlight></codeline>
<codeline lineno="1758"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>package_state_final.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284adeacea0c39c3a371628a2be46457c1e3" kindref="member">PackageValidationResult::PCKG_TX</ref>,<sp/></highlight><highlight class="stringliteral">&quot;transaction<sp/>failed&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1759"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>TxValidationState<sp/>mempool_full_state;</highlight></codeline>
<codeline lineno="1760"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mempool_full_state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa2dbed613ade117d8c58d8d230618efe4" kindref="member">TxValidationResult::TX_MEMPOOL_POLICY</ref>,<sp/></highlight><highlight class="stringliteral">&quot;mempool<sp/>full&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1761"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>results_final.emplace(wtxid,<sp/><ref refid="struct_mempool_accept_result_1af068e8d0ef73ea6eb79c045cc100558c" kindref="member">MempoolAcceptResult::Failure</ref>(mempool_full_state));</highlight></codeline>
<codeline lineno="1762"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1763"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>results_final.emplace(wtxid,<sp/>txresult);</highlight></codeline>
<codeline lineno="1764"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1765"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it{results_final.find(wtxid)};<sp/>it<sp/>!=<sp/>results_final.end())<sp/>{</highlight></codeline>
<codeline lineno="1766"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Already-in-mempool<sp/>transaction.<sp/>Check<sp/>to<sp/>see<sp/>if<sp/>it&apos;s<sp/>still<sp/>there,<sp/>as<sp/>it<sp/>could<sp/>have</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1767"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>been<sp/>evicted<sp/>when<sp/>LimitMempoolSize()<sp/>was<sp/>called.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1768"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(it-&gt;second.m_result_type<sp/>!=<sp/><ref refid="struct_mempool_accept_result_1aa71b5fc2a82d29a91db3a734ff892a49accc0377a8afbf50e7094f5c23a8af223" kindref="member">MempoolAcceptResult::ResultType::INVALID</ref>);</highlight></codeline>
<codeline lineno="1769"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(!individual_results_nonfinal.contains(wtxid));</highlight></codeline>
<codeline lineno="1770"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Query<sp/>by<sp/>txid<sp/>to<sp/>include<sp/>the<sp/>same-txid-different-witness<sp/>ones.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1771"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_pool.<ref refid="class_c_tx_mem_pool_1a4f1dcdad840ef946c9925b0f4a0f95b9" kindref="member">exists</ref>(tx-&gt;<ref refid="class_c_transaction_1a919ff1093793433f4717d74fb751423b" kindref="member">GetHash</ref>()))<sp/>{</highlight></codeline>
<codeline lineno="1772"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>package_state_final.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="packages_8h_1ae4232e3b34bac2d3729f3b4a7b274284adeacea0c39c3a371628a2be46457c1e3" kindref="member">PackageValidationResult::PCKG_TX</ref>,<sp/></highlight><highlight class="stringliteral">&quot;transaction<sp/>failed&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1773"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>TxValidationState<sp/>mempool_full_state;</highlight></codeline>
<codeline lineno="1774"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mempool_full_state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa2dbed613ade117d8c58d8d230618efe4" kindref="member">TxValidationResult::TX_MEMPOOL_POLICY</ref>,<sp/></highlight><highlight class="stringliteral">&quot;mempool<sp/>full&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1775"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Replace<sp/>the<sp/>previous<sp/>result.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1776"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>results_final.erase(wtxid);</highlight></codeline>
<codeline lineno="1777"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>results_final.emplace(wtxid,<sp/><ref refid="struct_mempool_accept_result_1af068e8d0ef73ea6eb79c045cc100558c" kindref="member">MempoolAcceptResult::Failure</ref>(mempool_full_state));</highlight></codeline>
<codeline lineno="1778"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1779"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it{individual_results_nonfinal.find(wtxid)};<sp/>it<sp/>!=<sp/>individual_results_nonfinal.end())<sp/>{</highlight></codeline>
<codeline lineno="1780"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(it-&gt;second.m_result_type<sp/>==<sp/><ref refid="struct_mempool_accept_result_1aa71b5fc2a82d29a91db3a734ff892a49accc0377a8afbf50e7094f5c23a8af223" kindref="member">MempoolAcceptResult::ResultType::INVALID</ref>);</highlight></codeline>
<codeline lineno="1781"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Interesting<sp/>result<sp/>from<sp/>previous<sp/>processing.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1782"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>results_final.emplace(wtxid,<sp/>it-&gt;second);</highlight></codeline>
<codeline lineno="1783"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1784"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1785"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(results_final.size()<sp/>==<sp/>package.size());</highlight></codeline>
<codeline lineno="1786"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>PackageMempoolAcceptResult(package_state_final,<sp/>std::move(results_final));</highlight></codeline>
<codeline lineno="1787"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1788"><highlight class="normal"></highlight></codeline>
<codeline lineno="1789"><highlight class="normal">}<sp/></highlight><highlight class="comment">//<sp/>anon<sp/>namespace</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1790"><highlight class="normal"></highlight></codeline>
<codeline lineno="1791"><highlight class="normal">MempoolAcceptResult<sp/><ref refid="validation_8cpp_1a400e902384ac40a640a3a2dd0dba312a" kindref="member">AcceptToMemoryPool</ref>(Chainstate&amp;<sp/>active_chainstate,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref>&amp;<sp/>tx,</highlight></codeline>
<codeline lineno="1792"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int64_t<sp/>accept_time,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>bypass_limits,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>test_accept)</highlight></codeline>
<codeline lineno="1793"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1794"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="1795"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CChainParams&amp;<sp/>chainparams{active_chainstate.<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.<ref refid="class_chainstate_manager_1a9fc4893dda46aba09dbcd01e3387ca6f" kindref="member">GetParams</ref>()};</highlight></codeline>
<codeline lineno="1796"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(active_chainstate.<ref refid="class_chainstate_1ac2dc9bde2175dbfb05382c6e8033db28" kindref="member">GetMempool</ref>()<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1797"><highlight class="normal"><sp/><sp/><sp/><sp/>CTxMemPool&amp;<sp/>pool{*active_chainstate.<ref refid="class_chainstate_1ac2dc9bde2175dbfb05382c6e8033db28" kindref="member">GetMempool</ref>()};</highlight></codeline>
<codeline lineno="1798"><highlight class="normal"></highlight></codeline>
<codeline lineno="1799"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;COutPoint&gt;<sp/>coins_to_uncache;</highlight></codeline>
<codeline lineno="1800"><highlight class="normal"></highlight></codeline>
<codeline lineno="1801"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref><sp/>=<sp/>MemPoolAccept::ATMPArgs::SingleAccept(chainparams,<sp/>accept_time,<sp/>bypass_limits,<sp/>coins_to_uncache,<sp/>test_accept);</highlight></codeline>
<codeline lineno="1802"><highlight class="normal"><sp/><sp/><sp/><sp/>MempoolAcceptResult<sp/>result<sp/>=<sp/>MemPoolAccept(pool,<sp/>active_chainstate).AcceptSingleTransactionAndCleanup(tx,<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>);</highlight></codeline>
<codeline lineno="1803"><highlight class="normal"></highlight></codeline>
<codeline lineno="1804"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(result.<ref refid="struct_mempool_accept_result_1af8017e4319a28c0cac9c61662b1d7565" kindref="member">m_result_type</ref><sp/>!=<sp/><ref refid="struct_mempool_accept_result_1aa71b5fc2a82d29a91db3a734ff892a49ac9f1a6384b1c466d4612f513bd8e13ea" kindref="member">MempoolAcceptResult::ResultType::VALID</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1805"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Remove<sp/>coins<sp/>that<sp/>were<sp/>not<sp/>present<sp/>in<sp/>the<sp/>coins<sp/>cache<sp/>before<sp/>calling</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1806"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>AcceptSingleTransaction();<sp/>this<sp/>is<sp/>to<sp/>prevent<sp/>memory<sp/>DoS<sp/>in<sp/>case<sp/>we<sp/>receive<sp/>a<sp/>large</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1807"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>number<sp/>of<sp/>invalid<sp/>transactions<sp/>that<sp/>attempt<sp/>to<sp/>overrun<sp/>the<sp/>in-memory<sp/>coins<sp/>cache</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1808"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(`CCoinsViewCache::cacheCoins`).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1809"><highlight class="normal"></highlight></codeline>
<codeline lineno="1810"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>COutPoint&amp;<sp/>hashTx<sp/>:<sp/>coins_to_uncache)</highlight></codeline>
<codeline lineno="1811"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>active_chainstate.<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>().<ref refid="class_c_coins_view_cache_1ad79839a8f70a58de19104ac6bfbb5ae8" kindref="member">Uncache</ref>(hashTx);</highlight></codeline>
<codeline lineno="1812"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="trace_8h_1ae7d4767c75c045d7e4d4b840fb4a8e5f" kindref="member">TRACEPOINT</ref>(mempool,<sp/>rejected,</highlight></codeline>
<codeline lineno="1813"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx-&gt;GetHash().data(),</highlight></codeline>
<codeline lineno="1814"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result.<ref refid="struct_mempool_accept_result_1a5d8238ae23efa4592916ffc81d18cd4d" kindref="member">m_state</ref>.<ref refid="class_validation_state_1a5fef80db1db0007a9082aa7d104e2933" kindref="member">GetRejectReason</ref>().c_str()</highlight></codeline>
<codeline lineno="1815"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="1816"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1817"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>After<sp/>we&apos;ve<sp/>(potentially)<sp/>uncached<sp/>entries,<sp/>ensure<sp/>our<sp/>coins<sp/>cache<sp/>is<sp/>still<sp/>within<sp/>its<sp/>size<sp/>limits</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1818"><highlight class="normal"><sp/><sp/><sp/><sp/>BlockValidationState<sp/>state_dummy;</highlight></codeline>
<codeline lineno="1819"><highlight class="normal"><sp/><sp/><sp/><sp/>active_chainstate.<ref refid="class_chainstate_1a0f9f0cdb703638cb9818a9b41158ac6a" kindref="member">FlushStateToDisk</ref>(state_dummy,<sp/><ref refid="validation_8h_1ab30a99e75e9dc44356d1ad6bdd184ae0ad9d83fc826ae0d42075af007a477e2c9" kindref="member">FlushStateMode::PERIODIC</ref>);</highlight></codeline>
<codeline lineno="1820"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>result;</highlight></codeline>
<codeline lineno="1821"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1822"><highlight class="normal"></highlight></codeline>
<codeline lineno="1823"><highlight class="normal">PackageMempoolAcceptResult<sp/><ref refid="validation_8cpp_1a050f5f1343cc094282474bf0aff8e07f" kindref="member">ProcessNewPackage</ref>(Chainstate&amp;<sp/>active_chainstate,<sp/>CTxMemPool&amp;<sp/>pool,</highlight></codeline>
<codeline lineno="1824"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="packages_8h_1a138b5dbe56c4869308e2bc7a28b51d9c" kindref="member">Package</ref>&amp;<sp/>package,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>test_accept,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::optional&lt;CFeeRate&gt;&amp;<sp/>client_maxfeerate)</highlight></codeline>
<codeline lineno="1825"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1826"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1827"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!package.empty());</highlight></codeline>
<codeline lineno="1828"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(std::all_of(package.cbegin(),<sp/>package.cend(),<sp/>[](</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tx){return<sp/>tx<sp/>!=<sp/>nullptr;}));</highlight></codeline>
<codeline lineno="1829"><highlight class="normal"></highlight></codeline>
<codeline lineno="1830"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;COutPoint&gt;<sp/>coins_to_uncache;</highlight></codeline>
<codeline lineno="1831"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CChainParams&amp;<sp/>chainparams<sp/>=<sp/>active_chainstate.<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.<ref refid="class_chainstate_manager_1a9fc4893dda46aba09dbcd01e3387ca6f" kindref="member">GetParams</ref>();</highlight></codeline>
<codeline lineno="1832"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>result<sp/>=<sp/>[&amp;]()<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1833"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1834"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(test_accept)<sp/>{</highlight></codeline>
<codeline lineno="1835"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref><sp/>=<sp/>MemPoolAccept::ATMPArgs::PackageTestAccept(chainparams,<sp/><ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime</ref>(),<sp/>coins_to_uncache);</highlight></codeline>
<codeline lineno="1836"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>MemPoolAccept(pool,<sp/>active_chainstate).AcceptMultipleTransactionsAndCleanup(package,<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>);</highlight></codeline>
<codeline lineno="1837"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1838"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref><sp/>=<sp/>MemPoolAccept::ATMPArgs::PackageChildWithParents(chainparams,<sp/><ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime</ref>(),<sp/>coins_to_uncache,<sp/>client_maxfeerate);</highlight></codeline>
<codeline lineno="1839"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>MemPoolAccept(pool,<sp/>active_chainstate).AcceptPackage(package,<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>);</highlight></codeline>
<codeline lineno="1840"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1841"><highlight class="normal"><sp/><sp/><sp/><sp/>}();</highlight></codeline>
<codeline lineno="1842"><highlight class="normal"></highlight></codeline>
<codeline lineno="1843"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Uncache<sp/>coins<sp/>pertaining<sp/>to<sp/>transactions<sp/>that<sp/>were<sp/>not<sp/>submitted<sp/>to<sp/>the<sp/>mempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1844"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(test_accept<sp/>||<sp/>result.<ref refid="struct_mempool_accept_result_1a5d8238ae23efa4592916ffc81d18cd4d" kindref="member">m_state</ref>.<ref refid="class_validation_state_1a6c1f27c9de7ff98356fa712e4b796a1a" kindref="member">IsInvalid</ref>())<sp/>{</highlight></codeline>
<codeline lineno="1845"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>COutPoint&amp;<sp/>hashTx<sp/>:<sp/>coins_to_uncache)<sp/>{</highlight></codeline>
<codeline lineno="1846"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>active_chainstate.<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>().<ref refid="class_c_coins_view_cache_1ad79839a8f70a58de19104ac6bfbb5ae8" kindref="member">Uncache</ref>(hashTx);</highlight></codeline>
<codeline lineno="1847"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1848"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1849"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ensure<sp/>the<sp/>coins<sp/>cache<sp/>is<sp/>still<sp/>within<sp/>limits.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1850"><highlight class="normal"><sp/><sp/><sp/><sp/>BlockValidationState<sp/>state_dummy;</highlight></codeline>
<codeline lineno="1851"><highlight class="normal"><sp/><sp/><sp/><sp/>active_chainstate.<ref refid="class_chainstate_1a0f9f0cdb703638cb9818a9b41158ac6a" kindref="member">FlushStateToDisk</ref>(state_dummy,<sp/><ref refid="validation_8h_1ab30a99e75e9dc44356d1ad6bdd184ae0ad9d83fc826ae0d42075af007a477e2c9" kindref="member">FlushStateMode::PERIODIC</ref>);</highlight></codeline>
<codeline lineno="1852"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>result;</highlight></codeline>
<codeline lineno="1853"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1854"><highlight class="normal"></highlight></codeline>
<codeline lineno="1855"><highlight class="normal"><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/><ref refid="validation_8cpp_1a3e7cb06e156ad8400b9214479e946187" kindref="member">GetBlockSubsidy</ref>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref>,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Consensus::Params&amp;<sp/>consensusParams)</highlight></codeline>
<codeline lineno="1856"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1857"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>halvings<sp/>=<sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref><sp/>/<sp/>consensusParams.<ref refid="struct_consensus_1_1_params_1a229c4c0c785003723d4f01b4dfcb7cfe" kindref="member">nSubsidyHalvingInterval</ref>;</highlight></codeline>
<codeline lineno="1858"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Force<sp/>block<sp/>reward<sp/>to<sp/>zero<sp/>when<sp/>right<sp/>shift<sp/>is<sp/>undefined.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1859"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(halvings<sp/>&gt;=<sp/>64)</highlight></codeline>
<codeline lineno="1860"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="1861"><highlight class="normal"></highlight></codeline>
<codeline lineno="1862"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/>nSubsidy<sp/>=<sp/>50<sp/>*<sp/>COIN;</highlight></codeline>
<codeline lineno="1863"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Subsidy<sp/>is<sp/>cut<sp/>in<sp/>half<sp/>every<sp/>210,000<sp/>blocks<sp/>which<sp/>will<sp/>occur<sp/>approximately<sp/>every<sp/>4<sp/>years.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1864"><highlight class="normal"><sp/><sp/><sp/><sp/>nSubsidy<sp/>&gt;&gt;=<sp/>halvings;</highlight></codeline>
<codeline lineno="1865"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>nSubsidy;</highlight></codeline>
<codeline lineno="1866"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1867"><highlight class="normal"></highlight></codeline>
<codeline lineno="1868"><highlight class="normal"><ref refid="class_coins_views_1afd016b03b0ba85d2b63841bb4f6ae7d6" kindref="member">CoinsViews::CoinsViews</ref>(DBParams<sp/>db_params,<sp/>CoinsViewOptions<sp/>options)</highlight></codeline>
<codeline lineno="1869"><highlight class="normal"><sp/><sp/><sp/><sp/>:<sp/>m_dbview{std::move(db_params),<sp/>std::move(options)},</highlight></codeline>
<codeline lineno="1870"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_catcherview(&amp;m_dbview)<sp/>{}</highlight></codeline>
<codeline lineno="1871"><highlight class="normal"></highlight></codeline>
<codeline lineno="1872"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>CoinsViews::InitCache()</highlight></codeline>
<codeline lineno="1873"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1874"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="1875"><highlight class="normal"><sp/><sp/><sp/><sp/>m_cacheview<sp/>=<sp/>std::make_unique&lt;CCoinsViewCache&gt;(&amp;m_catcherview);</highlight></codeline>
<codeline lineno="1876"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1877"><highlight class="normal"></highlight></codeline>
<codeline lineno="1878"><highlight class="normal"><ref refid="class_chainstate_1a70b163a8bca70b51736e75cf3f6282f0" kindref="member">Chainstate::Chainstate</ref>(</highlight></codeline>
<codeline lineno="1879"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_tx_mem_pool" kindref="compound">CTxMemPool</ref>*<sp/>mempool,</highlight></codeline>
<codeline lineno="1880"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classnode_1_1_block_manager" kindref="compound">BlockManager</ref>&amp;<sp/>blockman,</highlight></codeline>
<codeline lineno="1881"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager" kindref="compound">ChainstateManager</ref>&amp;<sp/>chainman,</highlight></codeline>
<codeline lineno="1882"><highlight class="normal"><sp/><sp/><sp/><sp/>std::optional&lt;uint256&gt;<sp/>from_snapshot_blockhash)</highlight></codeline>
<codeline lineno="1883"><highlight class="normal"><sp/><sp/><sp/><sp/>:<sp/>m_mempool(mempool),</highlight></codeline>
<codeline lineno="1884"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_blockman(blockman),</highlight></codeline>
<codeline lineno="1885"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_chainman(chainman),</highlight></codeline>
<codeline lineno="1886"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_assumeutxo(from_snapshot_blockhash<sp/>?<sp/><ref refid="validation_8h_1a6b7ed8f1aa31880e0db11fd5d379152d" kindref="member">Assumeutxo</ref>::<ref refid="validation_8h_1a6b7ed8f1aa31880e0db11fd5d379152daa7e559db9fd6ffeed9432ba2987a830d" kindref="member">UNVALIDATED</ref><sp/>:<sp/><ref refid="validation_8h_1a6b7ed8f1aa31880e0db11fd5d379152d" kindref="member">Assumeutxo</ref>::<ref refid="validation_8h_1a6b7ed8f1aa31880e0db11fd5d379152da4d6154fe02ac9bf42fd2aacfa49310b0" kindref="member">VALIDATED</ref>),</highlight></codeline>
<codeline lineno="1887"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_from_snapshot_blockhash(from_snapshot_blockhash)<sp/>{}</highlight></codeline>
<codeline lineno="1888"><highlight class="normal"></highlight></codeline>
<codeline lineno="1889"><highlight class="normal">fs::path<sp/><ref refid="class_chainstate_1a4afdb9493bd2ee94b23c7b5dd6c51bbc" kindref="member">Chainstate::StoragePath</ref>()</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="1890"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="1891"><highlight class="normal"><sp/><sp/><sp/><sp/>fs::path<sp/>path{<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.datadir<sp/>/<sp/></highlight><highlight class="stringliteral">&quot;chainstate&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="1892"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a37f0e70024a7d2d694ae27d34609de0e" kindref="member">m_from_snapshot_blockhash</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1893"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>path<sp/>+=<sp/><ref refid="namespacenode_1afefb365ea639adf55cb1729e630c3f0f" kindref="member">node::SNAPSHOT_CHAINSTATE_SUFFIX</ref>;</highlight></codeline>
<codeline lineno="1894"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1895"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>path;</highlight></codeline>
<codeline lineno="1896"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1897"><highlight class="normal"></highlight></codeline>
<codeline lineno="1898"><highlight class="normal"></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>Chainstate::SnapshotBase()</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="1899"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="1900"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1a37f0e70024a7d2d694ae27d34609de0e" kindref="member">m_from_snapshot_blockhash</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1901"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_cached_snapshot_base)<sp/>m_cached_snapshot_base<sp/>=<sp/><ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_blockman.LookupBlockIndex(*<ref refid="class_chainstate_1a37f0e70024a7d2d694ae27d34609de0e" kindref="member">m_from_snapshot_blockhash</ref>));</highlight></codeline>
<codeline lineno="1902"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>m_cached_snapshot_base;</highlight></codeline>
<codeline lineno="1903"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1904"><highlight class="normal"></highlight></codeline>
<codeline lineno="1905"><highlight class="normal"></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>Chainstate::TargetBlock()</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="1906"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="1907"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_target_blockhash)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1908"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_cached_target_block)<sp/>m_cached_target_block<sp/>=<sp/><ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_blockman.LookupBlockIndex(*m_target_blockhash));</highlight></codeline>
<codeline lineno="1909"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>m_cached_target_block;</highlight></codeline>
<codeline lineno="1910"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1911"><highlight class="normal"></highlight></codeline>
<codeline lineno="1912"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>Chainstate::SetTargetBlock(<ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>block)</highlight></codeline>
<codeline lineno="1913"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1914"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(block)<sp/>{</highlight></codeline>
<codeline lineno="1915"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_target_blockhash<sp/>=<sp/>block-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>();</highlight></codeline>
<codeline lineno="1916"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1917"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_target_blockhash.reset();</highlight></codeline>
<codeline lineno="1918"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1919"><highlight class="normal"><sp/><sp/><sp/><sp/>m_cached_target_block<sp/>=<sp/>block;</highlight></codeline>
<codeline lineno="1920"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1921"><highlight class="normal"></highlight></codeline>
<codeline lineno="1922"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>Chainstate::SetTargetBlockHash(<ref refid="classuint256" kindref="compound">uint256</ref><sp/>block_hash)</highlight></codeline>
<codeline lineno="1923"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1924"><highlight class="normal"><sp/><sp/><sp/><sp/>m_target_blockhash<sp/>=<sp/>block_hash;</highlight></codeline>
<codeline lineno="1925"><highlight class="normal"><sp/><sp/><sp/><sp/>m_cached_target_block<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1926"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1927"><highlight class="normal"></highlight></codeline>
<codeline lineno="1928"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1a870d55495c6a85e99afda4b4788d77e7" kindref="member">Chainstate::InitCoinsDB</ref>(</highlight></codeline>
<codeline lineno="1929"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>cache_size_bytes,</highlight></codeline>
<codeline lineno="1930"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>in_memory,</highlight></codeline>
<codeline lineno="1931"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>should_wipe)</highlight></codeline>
<codeline lineno="1932"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1933"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a33c67fb1b900add3e05efd125faaae85" kindref="member">m_coins_views</ref><sp/>=<sp/>std::make_unique&lt;CoinsViews&gt;(</highlight></codeline>
<codeline lineno="1934"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DBParams{</highlight></codeline>
<codeline lineno="1935"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.path<sp/>=<sp/><ref refid="class_chainstate_1a4afdb9493bd2ee94b23c7b5dd6c51bbc" kindref="member">StoragePath</ref>(),</highlight></codeline>
<codeline lineno="1936"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.cache_bytes<sp/>=<sp/>cache_size_bytes,</highlight></codeline>
<codeline lineno="1937"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.memory_only<sp/>=<sp/>in_memory,</highlight></codeline>
<codeline lineno="1938"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.wipe_data<sp/>=<sp/>should_wipe,</highlight></codeline>
<codeline lineno="1939"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.obfuscate<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1940"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.options<sp/>=<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.coins_db},</highlight></codeline>
<codeline lineno="1941"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.coins_view);</highlight></codeline>
<codeline lineno="1942"><highlight class="normal"></highlight></codeline>
<codeline lineno="1943"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a209fef4fed4aee7188492631ecc6a782" kindref="member">m_coinsdb_cache_size_bytes</ref><sp/>=<sp/>cache_size_bytes;</highlight></codeline>
<codeline lineno="1944"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1945"><highlight class="normal"></highlight></codeline>
<codeline lineno="1946"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>Chainstate::InitCoinsCache(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>cache_size_bytes)</highlight></codeline>
<codeline lineno="1947"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1948"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="1949"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(<ref refid="class_chainstate_1a33c67fb1b900add3e05efd125faaae85" kindref="member">m_coins_views</ref><sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1950"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a9f27f82f81429b6be783bb2ba38a7383" kindref="member">m_coinstip_cache_size_bytes</ref><sp/>=<sp/>cache_size_bytes;</highlight></codeline>
<codeline lineno="1951"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a33c67fb1b900add3e05efd125faaae85" kindref="member">m_coins_views</ref>-&gt;InitCache();</highlight></codeline>
<codeline lineno="1952"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1953"><highlight class="normal"></highlight></codeline>
<codeline lineno="1954"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Note<sp/>that<sp/>though<sp/>this<sp/>is<sp/>marked<sp/>const,<sp/>we<sp/>may<sp/>end<sp/>up<sp/>modifying<sp/>`m_cached_finished_ibd`,<sp/>which</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1955"><highlight class="normal"></highlight><highlight class="comment">//<sp/>is<sp/>a<sp/>performance-related<sp/>implementation<sp/>detail.<sp/>This<sp/>function<sp/>must<sp/>be<sp/>marked</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1956"><highlight class="normal"></highlight><highlight class="comment">//<sp/>`const`<sp/>so<sp/>that<sp/>`CValidationInterface`<sp/>clients<sp/>(which<sp/>are<sp/>given<sp/>a<sp/>`const<sp/>Chainstate*`)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1957"><highlight class="normal"></highlight><highlight class="comment">//<sp/>can<sp/>call<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1958"><highlight class="normal"></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1959"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager_1a312bb1a2008bae3205f4699b90880d66" kindref="member">ChainstateManager::IsInitialBlockDownload</ref>()</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="1960"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="1961"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Optimization:<sp/>pre-test<sp/>latch<sp/>before<sp/>taking<sp/>the<sp/>lock.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1962"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_manager_1aeef634a7b2cca41e9465fb47ea4a4e5e" kindref="member">m_cached_finished_ibd</ref>.load(std::memory_order_relaxed))</highlight></codeline>
<codeline lineno="1963"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1964"><highlight class="normal"></highlight></codeline>
<codeline lineno="1965"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1966"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_manager_1aeef634a7b2cca41e9465fb47ea4a4e5e" kindref="member">m_cached_finished_ibd</ref>.load(std::memory_order_relaxed))</highlight></codeline>
<codeline lineno="1967"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1968"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.LoadingBlocks())<sp/>{</highlight></codeline>
<codeline lineno="1969"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1970"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1971"><highlight class="normal"><sp/><sp/><sp/><sp/>CChain&amp;<sp/>chain{<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>()};</highlight></codeline>
<codeline lineno="1972"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(chain.<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>()<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="1973"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1974"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1975"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(chain.<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>()-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&lt;<sp/><ref refid="class_chainstate_manager_1af6689b42eea6a15ba7e5409ea374cdb4" kindref="member">MinimumChainWork</ref>())<sp/>{</highlight></codeline>
<codeline lineno="1976"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1977"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1978"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(chain.<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>()-&gt;<ref refid="class_c_block_index_1a9ddce75b363526132a7d7fc78e8630d4" kindref="member">Time</ref>()<sp/>&lt;<sp/><ref refid="util_2time_8h_1a7a4e7e09a41ff922cf1eb6fdaae4b3ba" kindref="member">Now&lt;NodeSeconds&gt;</ref>()<sp/>-<sp/><ref refid="class_chainstate_manager_1a012c0463bd17a2be6045a0d62e8b0fd4" kindref="member">m_options</ref>.max_tip_age)<sp/>{</highlight></codeline>
<codeline lineno="1979"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1980"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1981"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Leaving<sp/>InitialBlockDownload<sp/>(latching<sp/>to<sp/>false)&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1982"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1aeef634a7b2cca41e9465fb47ea4a4e5e" kindref="member">m_cached_finished_ibd</ref>.store(</highlight><highlight class="keyword">true</highlight><highlight class="normal">,<sp/>std::memory_order_relaxed);</highlight></codeline>
<codeline lineno="1983"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1984"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1985"><highlight class="normal"></highlight></codeline>
<codeline lineno="1986"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1a7d3637ae43c319b91b55b43ff1dc0a37" kindref="member">Chainstate::CheckForkWarningConditions</ref>()</highlight></codeline>
<codeline lineno="1987"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1988"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1989"><highlight class="normal"></highlight></codeline>
<codeline lineno="1990"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(this-&gt;GetRole().historical)<sp/>{</highlight></codeline>
<codeline lineno="1991"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1992"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1993"><highlight class="normal"></highlight></codeline>
<codeline lineno="1994"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_invalid<sp/>&amp;&amp;<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_invalid-&gt;nChainWork<sp/>&gt;<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip()-&gt;nChainWork<sp/>+<sp/>(<ref refid="chain_8cpp_1a334aa8015cc7185f7fdf484783e40f38" kindref="member">GetBlockProof</ref>(*<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip())<sp/>*<sp/>6))<sp/>{</highlight></codeline>
<codeline lineno="1995"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;Found<sp/>invalid<sp/>chain<sp/>more<sp/>than<sp/>6<sp/>blocks<sp/>longer<sp/>than<sp/>our<sp/>best<sp/>chain.<sp/>This<sp/>could<sp/>be<sp/>due<sp/>to<sp/>database<sp/>corruption<sp/>or<sp/>consensus<sp/>incompatibility<sp/>with<sp/>peers.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1996"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetNotifications().warningSet(</highlight></codeline>
<codeline lineno="1997"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacekernel_1af6ea07812363481c623a23ea26fbf8edae104a308028adbc17b3eb003bb1b21f3" kindref="member">kernel::Warning::LARGE_WORK_INVALID_CHAIN</ref>,</highlight></codeline>
<codeline lineno="1998"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight><highlight class="stringliteral">&quot;Warning:<sp/>Found<sp/>invalid<sp/>chain<sp/>more<sp/>than<sp/>6<sp/>blocks<sp/>longer<sp/>than<sp/>our<sp/>best<sp/>chain.<sp/>This<sp/>could<sp/>be<sp/>due<sp/>to<sp/>database<sp/>corruption<sp/>or<sp/>consensus<sp/>incompatibility<sp/>with<sp/>peers.&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="1999"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2000"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetNotifications().warningUnset(<ref refid="namespacekernel_1af6ea07812363481c623a23ea26fbf8edae104a308028adbc17b3eb003bb1b21f3" kindref="member">kernel::Warning::LARGE_WORK_INVALID_CHAIN</ref>);</highlight></codeline>
<codeline lineno="2001"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2002"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2003"><highlight class="normal"></highlight></codeline>
<codeline lineno="2004"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Called<sp/>both<sp/>upon<sp/>regular<sp/>invalid<sp/>block<sp/>discovery<sp/>*and*<sp/>InvalidateBlock</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2005"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1acd1f6fc8d7b53d55405ed6107ef693ad" kindref="member">Chainstate::InvalidChainFound</ref>(<ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>pindexNew)</highlight></codeline>
<codeline lineno="2006"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2007"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="2008"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_invalid<sp/>||<sp/>pindexNew-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&gt;<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_invalid-&gt;nChainWork)<sp/>{</highlight></codeline>
<codeline lineno="2009"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_invalid<sp/>=<sp/>pindexNew;</highlight></codeline>
<codeline lineno="2010"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2011"><highlight class="normal"><sp/><sp/><sp/><sp/>SetBlockFailureFlags(pindexNew);</highlight></codeline>
<codeline lineno="2012"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_header<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_header-&gt;GetAncestor(pindexNew-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>)<sp/>==<sp/>pindexNew)<sp/>{</highlight></codeline>
<codeline lineno="2013"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.RecalculateBestHeader();</highlight></codeline>
<codeline lineno="2014"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2015"><highlight class="normal"></highlight></codeline>
<codeline lineno="2016"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;%s:<sp/>invalid<sp/>block=%s<sp/><sp/>height=%d<sp/><sp/>log2_work=%f<sp/><sp/>date=%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__,</highlight></codeline>
<codeline lineno="2017"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>pindexNew-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>pindexNew-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,</highlight></codeline>
<codeline lineno="2018"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>log(pindexNew-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref>.<ref refid="classbase__uint_1a1418943fdda813b9f539d49d9da68241" kindref="member">getdouble</ref>())/log(2.0),<sp/><ref refid="util_2time_8cpp_1ae5186b218f085a0a48b08bcdb0fffed1" kindref="member">FormatISO8601DateTime</ref>(pindexNew-&gt;<ref refid="class_c_block_index_1a7aea61ae131a8b7b934f8b3a758d9490" kindref="member">GetBlockTime</ref>()));</highlight></codeline>
<codeline lineno="2019"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockIndex<sp/>*tip<sp/>=<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip();</highlight></codeline>
<codeline lineno="2020"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref><sp/>(tip);</highlight></codeline>
<codeline lineno="2021"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;%s:<sp/><sp/>current<sp/>best=%s<sp/><sp/>height=%d<sp/><sp/>log2_work=%f<sp/><sp/>date=%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__,</highlight></codeline>
<codeline lineno="2022"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>tip-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Height(),<sp/>log(tip-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref>.<ref refid="classbase__uint_1a1418943fdda813b9f539d49d9da68241" kindref="member">getdouble</ref>())/log(2.0),</highlight></codeline>
<codeline lineno="2023"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8cpp_1ae5186b218f085a0a48b08bcdb0fffed1" kindref="member">FormatISO8601DateTime</ref>(tip-&gt;<ref refid="class_c_block_index_1a7aea61ae131a8b7b934f8b3a758d9490" kindref="member">GetBlockTime</ref>()));</highlight></codeline>
<codeline lineno="2024"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a7d3637ae43c319b91b55b43ff1dc0a37" kindref="member">CheckForkWarningConditions</ref>();</highlight></codeline>
<codeline lineno="2025"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2026"><highlight class="normal"></highlight></codeline>
<codeline lineno="2027"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Same<sp/>as<sp/>InvalidChainFound,<sp/>above,<sp/>except<sp/>not<sp/>called<sp/>directly<sp/>from<sp/>InvalidateBlock,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2028"><highlight class="normal"></highlight><highlight class="comment">//<sp/>which<sp/>does<sp/>its<sp/>own<sp/>setBlockIndexCandidates<sp/>management.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2029"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1a9c5078a4a04331cc35d986500a8b30b1" kindref="member">Chainstate::InvalidBlockFound</ref>(<ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>pindex,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref>&amp;<sp/>state)</highlight></codeline>
<codeline lineno="2030"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2031"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="2032"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.<ref refid="class_validation_state_1a1b98c7dab961aab90e13b3f3f9fcf52d" kindref="member">GetResult</ref>()<sp/>!=<sp/><ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580aa74bec7838a1da98fe1e6e0620d31170" kindref="member">BlockValidationResult::BLOCK_MUTATED</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2033"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex-&gt;nStatus<sp/>|=<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93adab3f668fe41faf909922945b37b25ec2d" kindref="member">BLOCK_FAILED_VALID</ref>;</highlight></codeline>
<codeline lineno="2034"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_dirty_blockindex.insert(pindex);</highlight></codeline>
<codeline lineno="2035"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.erase(pindex);</highlight></codeline>
<codeline lineno="2036"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1acd1f6fc8d7b53d55405ed6107ef693ad" kindref="member">InvalidChainFound</ref>(pindex);</highlight></codeline>
<codeline lineno="2037"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2038"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2039"><highlight class="normal"></highlight></codeline>
<codeline lineno="2040"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="validation_8cpp_1a76ffac026788c8c1e6d55fb1beae0962" kindref="member">UpdateCoins</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_transaction" kindref="compound">CTransaction</ref>&amp;<sp/>tx,<sp/><ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref>&amp;<sp/>inputs,<sp/><ref refid="class_c_tx_undo" kindref="compound">CTxUndo</ref><sp/>&amp;txundo,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref>)</highlight></codeline>
<codeline lineno="2041"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2042"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>mark<sp/>inputs<sp/>spent</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2043"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tx.<ref refid="class_c_transaction_1a6b4def31a0a2fbc975d0087ad2d4391a" kindref="member">IsCoinBase</ref>())<sp/>{</highlight></codeline>
<codeline lineno="2044"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>txundo.<ref refid="class_c_tx_undo_1a60d1b1864658cd68a134218c2226d140" kindref="member">vprevout</ref>.reserve(tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>.size());</highlight></codeline>
<codeline lineno="2045"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_tx_in" kindref="compound">CTxIn</ref><sp/>&amp;txin<sp/>:<sp/>tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2046"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>txundo.<ref refid="class_c_tx_undo_1a60d1b1864658cd68a134218c2226d140" kindref="member">vprevout</ref>.emplace_back();</highlight></codeline>
<codeline lineno="2047"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>is_spent<sp/>=<sp/>inputs.<ref refid="class_c_coins_view_cache_1af5547d7b4e71fcf9319ab7a12f7f20e0" kindref="member">SpendCoin</ref>(txin.<ref refid="class_c_tx_in_1a1c567359e133d98c72b5e9a928ffd41a" kindref="member">prevout</ref>,<sp/>&amp;txundo.<ref refid="class_c_tx_undo_1a60d1b1864658cd68a134218c2226d140" kindref="member">vprevout</ref>.back());</highlight></codeline>
<codeline lineno="2048"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(is_spent);</highlight></codeline>
<codeline lineno="2049"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2050"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2051"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>add<sp/>outputs</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2052"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="coins_8cpp_1ae4190d2c27c3c27c7fb6ad026ca11beb" kindref="member">AddCoins</ref>(inputs,<sp/>tx,<sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref>);</highlight></codeline>
<codeline lineno="2053"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2054"><highlight class="normal"></highlight></codeline>
<codeline lineno="2055"><highlight class="normal">std::optional&lt;std::pair&lt;ScriptError,<sp/>std::string&gt;&gt;<sp/><ref refid="class_c_script_check_1aaf375969f824048a25936a2d380d1f0e" kindref="member">CScriptCheck::operator()</ref>()<sp/>{</highlight></codeline>
<codeline lineno="2056"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CScript<sp/>&amp;scriptSig<sp/>=<sp/>ptxTo-&gt;vin[nIn].scriptSig;</highlight></codeline>
<codeline lineno="2057"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CScriptWitness<sp/>*witness<sp/>=<sp/>&amp;ptxTo-&gt;vin[nIn].scriptWitness;</highlight></codeline>
<codeline lineno="2058"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="script__error_8h_1a1453a82c0adda9b334edde231c762f31" kindref="member">ScriptError</ref><sp/>error{<ref refid="script__error_8h_1a3150eb7362e5d1e0732dd10c973a0eb5a44bdc1542fe92fe5fca8135b66eebb65" kindref="member">SCRIPT_ERR_UNKNOWN_ERROR</ref>};</highlight></codeline>
<codeline lineno="2059"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="interpreter_8cpp_1acdeac884f2fbcea533277458e8097e87" kindref="member">VerifyScript</ref>(scriptSig,<sp/>m_tx_out.scriptPubKey,<sp/>witness,<sp/>m_flags,<sp/>CachingTransactionSignatureChecker(ptxTo,<sp/>nIn,<sp/>m_tx_out.nValue,<sp/>cacheStore,<sp/>*m_signature_cache,<sp/>*txdata),<sp/>&amp;error))<sp/>{</highlight></codeline>
<codeline lineno="2060"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::nullopt;</highlight></codeline>
<codeline lineno="2061"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2062"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>debug_str<sp/>=<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;input<sp/>%i<sp/>of<sp/>%s<sp/>(wtxid<sp/>%s),<sp/>spending<sp/>%s:%i&quot;</highlight><highlight class="normal">,<sp/>nIn,<sp/>ptxTo-&gt;GetHash().ToString(),<sp/>ptxTo-&gt;GetWitnessHash().ToString(),<sp/>ptxTo-&gt;vin[nIn].prevout.hash.ToString(),<sp/>ptxTo-&gt;vin[nIn].prevout.n);</highlight></codeline>
<codeline lineno="2063"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::make_pair(error,<sp/>std::move(debug_str));</highlight></codeline>
<codeline lineno="2064"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2065"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2066"><highlight class="normal"></highlight></codeline>
<codeline lineno="2067"><highlight class="normal"><ref refid="class_validation_cache_1ae97e9f6e3c90a3191b30331b8bfcad39" kindref="member">ValidationCache::ValidationCache</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>script_execution_cache_bytes,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>signature_cache_bytes)</highlight></codeline>
<codeline lineno="2068"><highlight class="normal"><sp/><sp/><sp/><sp/>:<sp/>m_signature_cache{signature_cache_bytes}</highlight></codeline>
<codeline lineno="2069"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2070"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Setup<sp/>the<sp/>salted<sp/>hasher</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2071"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classuint256" kindref="compound">uint256</ref><sp/><ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref><sp/>=<sp/><ref refid="random_8h_1a88672f91432a247654f2c06298dd58ee" kindref="member">GetRandHash</ref>();</highlight></codeline>
<codeline lineno="2072"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>want<sp/>the<sp/>nonce<sp/>to<sp/>be<sp/>64<sp/>bytes<sp/>long<sp/>to<sp/>force<sp/>the<sp/>hasher<sp/>to<sp/>process</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2073"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>this<sp/>chunk,<sp/>which<sp/>makes<sp/>later<sp/>hash<sp/>computations<sp/>more<sp/>efficient.<sp/>We</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2074"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>just<sp/>write<sp/>our<sp/>32-byte<sp/>entropy<sp/>twice<sp/>to<sp/>fill<sp/>the<sp/>64<sp/>bytes.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2075"><highlight class="normal"><sp/><sp/><sp/><sp/>m_script_execution_cache_hasher.Write(<ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref>.begin(),<sp/>32);</highlight></codeline>
<codeline lineno="2076"><highlight class="normal"><sp/><sp/><sp/><sp/>m_script_execution_cache_hasher.Write(<ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref>.begin(),<sp/>32);</highlight></codeline>
<codeline lineno="2077"><highlight class="normal"></highlight></codeline>
<codeline lineno="2078"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>[num_elems,<sp/>approx_size_bytes]<sp/>=<sp/>m_script_execution_cache.setup_bytes(script_execution_cache_bytes);</highlight></codeline>
<codeline lineno="2079"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Using<sp/>%zu<sp/>MiB<sp/>out<sp/>of<sp/>%zu<sp/>MiB<sp/>requested<sp/>for<sp/>script<sp/>execution<sp/>cache,<sp/>able<sp/>to<sp/>store<sp/>%zu<sp/>elements&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2080"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>approx_size_bytes<sp/>&gt;&gt;<sp/>20,<sp/>script_execution_cache_bytes<sp/>&gt;&gt;<sp/>20,<sp/>num_elems);</highlight></codeline>
<codeline lineno="2081"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2082"><highlight class="normal"></highlight></codeline>
<codeline lineno="2102"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="validation_8cpp_1af9f454ea56c86078990a64f3fe8e72e2" kindref="member">CheckInputScripts</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_transaction" kindref="compound">CTransaction</ref>&amp;<sp/>tx,<sp/><ref refid="class_tx_validation_state" kindref="compound">TxValidationState</ref>&amp;<sp/>state,</highlight></codeline>
<codeline lineno="2103"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref>&amp;<sp/>inputs,<sp/><ref refid="classscript__verify__flags" kindref="compound">script_verify_flags</ref><sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref>,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>cacheSigStore,</highlight></codeline>
<codeline lineno="2104"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>cacheFullScriptStore,<sp/><ref refid="struct_precomputed_transaction_data" kindref="compound">PrecomputedTransactionData</ref>&amp;<sp/>txdata,</highlight></codeline>
<codeline lineno="2105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_validation_cache" kindref="compound">ValidationCache</ref>&amp;<sp/>validation_cache,</highlight></codeline>
<codeline lineno="2106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CScriptCheck&gt;*<sp/>pvChecks)</highlight></codeline>
<codeline lineno="2107"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2108"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tx.<ref refid="class_c_transaction_1a6b4def31a0a2fbc975d0087ad2d4391a" kindref="member">IsCoinBase</ref>())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2109"><highlight class="normal"></highlight></codeline>
<codeline lineno="2110"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pvChecks)<sp/>{</highlight></codeline>
<codeline lineno="2111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pvChecks-&gt;reserve(tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>.size());</highlight></codeline>
<codeline lineno="2112"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2113"><highlight class="normal"></highlight></codeline>
<codeline lineno="2114"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>First<sp/>check<sp/>if<sp/>script<sp/>executions<sp/>have<sp/>been<sp/>cached<sp/>with<sp/>the<sp/>same</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2115"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>flags.<sp/>Note<sp/>that<sp/>this<sp/>assumes<sp/>that<sp/>the<sp/>inputs<sp/>provided<sp/>are</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2116"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>correct<sp/>(ie<sp/>that<sp/>the<sp/>transaction<sp/>hash<sp/>which<sp/>is<sp/>in<sp/>tx&apos;s<sp/>prevouts</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2117"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>properly<sp/>commits<sp/>to<sp/>the<sp/>scriptPubKey<sp/>in<sp/>the<sp/>inputs<sp/>view<sp/>of<sp/>that</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2118"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transaction).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2119"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classuint256" kindref="compound">uint256</ref><sp/>hashCacheEntry;</highlight></codeline>
<codeline lineno="2120"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_s_h_a256" kindref="compound">CSHA256</ref><sp/>hasher<sp/>=<sp/>validation_cache.<ref refid="class_validation_cache_1a1fda9184359e9ce24c487bd353a5cf62" kindref="member">ScriptExecutionCacheHasher</ref>();</highlight></codeline>
<codeline lineno="2121"><highlight class="normal"><sp/><sp/><sp/><sp/>hasher.<ref refid="class_c_s_h_a256_1a36953c9fcede4b2b750b3c71878109d0" kindref="member">Write</ref>(<ref refid="span_8h_1ad150fa0b59e38198809cfce8d0d5d11d" kindref="member">UCharCast</ref>(tx.<ref refid="class_c_transaction_1a28dfe8fd260e515f71ec5b75630da11c" kindref="member">GetWitnessHash</ref>().<ref refid="classtransaction__identifier_1a85610f231512ed555307399a10fcbdd2" kindref="member">begin</ref>()),<sp/>32).<ref refid="class_c_s_h_a256_1a36953c9fcede4b2b750b3c71878109d0" kindref="member">Write</ref>((</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*)&amp;<ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref>,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(<ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref>)).<ref refid="class_c_s_h_a256_1af6e6a590efea94f2eef2ec1bce72963f" kindref="member">Finalize</ref>(hashCacheEntry.<ref refid="classbase__blob_1a899a629fc7846994a3bbd28ba2777243" kindref="member">begin</ref>());</highlight></codeline>
<codeline lineno="2122"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);<sp/></highlight><highlight class="comment">//TODO:<sp/>Remove<sp/>this<sp/>requirement<sp/>by<sp/>making<sp/>CuckooCache<sp/>not<sp/>require<sp/>external<sp/>locks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2123"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(validation_cache.<ref refid="class_validation_cache_1a71db16486be5a83b5264bdce2bd1a249" kindref="member">m_script_execution_cache</ref>.<ref refid="class_cuckoo_cache_1_1cache_1a0c6c8da8f3b8de3c38a99ed23d92099e" kindref="member">contains</ref>(hashCacheEntry,<sp/>!cacheFullScriptStore))<sp/>{</highlight></codeline>
<codeline lineno="2124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2125"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2126"><highlight class="normal"></highlight></codeline>
<codeline lineno="2127"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!txdata.<ref refid="struct_precomputed_transaction_data_1a1e39b4a3b14c958b7d35aaa3cd1a60f4" kindref="member">m_spent_outputs_ready</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CTxOut&gt;<sp/>spent_outputs;</highlight></codeline>
<codeline lineno="2129"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>spent_outputs.reserve(tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>.size());</highlight></codeline>
<codeline lineno="2130"><highlight class="normal"></highlight></codeline>
<codeline lineno="2131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>txin<sp/>:<sp/>tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_out_point" kindref="compound">COutPoint</ref>&amp;<sp/>prevout<sp/>=<sp/>txin.<ref refid="class_c_tx_in_1a1c567359e133d98c72b5e9a928ffd41a" kindref="member">prevout</ref>;</highlight></codeline>
<codeline lineno="2133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_coin" kindref="compound">Coin</ref>&amp;<sp/>coin<sp/>=<sp/>inputs.<ref refid="class_c_coins_view_cache_1a87f1f2449e10859291ddbdc1d090cba3" kindref="member">AccessCoin</ref>(prevout);</highlight></codeline>
<codeline lineno="2134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!coin.<ref refid="class_coin_1ae0032141d9e76130a91e97e19eaad1ec" kindref="member">IsSpent</ref>());</highlight></codeline>
<codeline lineno="2135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>spent_outputs.emplace_back(coin.<ref refid="class_coin_1adafe93fbab174bb8f09c8a3b9df178fa" kindref="member">out</ref>);</highlight></codeline>
<codeline lineno="2136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>txdata.<ref refid="struct_precomputed_transaction_data_1a9d8d06b4401f04ceb58d7e5a21425a6f" kindref="member">Init</ref>(tx,<sp/>std::move(spent_outputs));</highlight></codeline>
<codeline lineno="2138"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2139"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(txdata.<ref refid="struct_precomputed_transaction_data_1a69c7e9afc511c9e3baab8658d6144b26" kindref="member">m_spent_outputs</ref>.size()<sp/>==<sp/>tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>.size());</highlight></codeline>
<codeline lineno="2140"><highlight class="normal"></highlight></codeline>
<codeline lineno="2141"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>.size();<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="2142"><highlight class="normal"></highlight></codeline>
<codeline lineno="2143"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>very<sp/>carefully<sp/>only<sp/>pass<sp/>in<sp/>things<sp/>to<sp/>CScriptCheck<sp/>which</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2144"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>are<sp/>clearly<sp/>committed<sp/>to<sp/>by<sp/>tx&apos;<sp/>witness<sp/>hash.<sp/>This<sp/>provides</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2145"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>a<sp/>sanity<sp/>check<sp/>that<sp/>our<sp/>caching<sp/>is<sp/>not<sp/>introducing<sp/>consensus</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2146"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>failures<sp/>through<sp/>additional<sp/>data<sp/>in,<sp/>eg,<sp/>the<sp/>coins<sp/>being</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2147"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>spent<sp/>being<sp/>checked<sp/>as<sp/>a<sp/>part<sp/>of<sp/>CScriptCheck.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2148"><highlight class="normal"></highlight></codeline>
<codeline lineno="2149"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>signature</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2150"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_script_check" kindref="compound">CScriptCheck</ref><sp/><ref refid="namespacebtck_1abbc228d429757789d4b14e3de3a71220" kindref="member">check</ref>(txdata.<ref refid="struct_precomputed_transaction_data_1a69c7e9afc511c9e3baab8658d6144b26" kindref="member">m_spent_outputs</ref>[i],<sp/>tx,<sp/>validation_cache.<ref refid="class_validation_cache_1ac1736fb8ed22560923d6a9da5208f715" kindref="member">m_signature_cache</ref>,<sp/>i,<sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref>,<sp/>cacheSigStore,<sp/>&amp;txdata);</highlight></codeline>
<codeline lineno="2151"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pvChecks)<sp/>{</highlight></codeline>
<codeline lineno="2152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pvChecks-&gt;emplace_back(std::move(check));</highlight></codeline>
<codeline lineno="2153"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>result<sp/>=<sp/><ref refid="namespacebtck_1abbc228d429757789d4b14e3de3a71220" kindref="member">check</ref>();<sp/>result.has_value())<sp/>{</highlight></codeline>
<codeline lineno="2154"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Tx<sp/>failures<sp/>never<sp/>trigger<sp/>disconnections/bans.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2155"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>is<sp/>so<sp/>that<sp/>network<sp/>splits<sp/>aren&apos;t<sp/>triggered</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2156"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>either<sp/>due<sp/>to<sp/>non-consensus<sp/>relay<sp/>policies<sp/>(such<sp/>as</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2157"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>non-standard<sp/>DER<sp/>encodings<sp/>or<sp/>non-null<sp/>dummy</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2158"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>arguments)<sp/>or<sp/>due<sp/>to<sp/>new<sp/>consensus<sp/>rules<sp/>introduced<sp/>in</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>soft<sp/>forks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2160"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref><sp/>&amp;<sp/>STANDARD_NOT_MANDATORY_VERIFY_FLAGS)<sp/>{</highlight></codeline>
<codeline lineno="2161"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89faa87feca81b39bdb75c3fdf1af3895847" kindref="member">TxValidationResult::TX_NOT_STANDARD</ref>,<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;mempool-script-verify-flag-failed<sp/>(%s)&quot;</highlight><highlight class="normal">,<sp/><ref refid="script__error_8cpp_1a6f3546ccbe6a83df56ed8791543e2ff5" kindref="member">ScriptErrorString</ref>(result-&gt;first)),<sp/>result-&gt;second);</highlight></codeline>
<codeline lineno="2162"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fad623c6a3361887cbd2cf1fe3c2bfb261" kindref="member">TxValidationResult::TX_CONSENSUS</ref>,<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;block-script-verify-flag-failed<sp/>(%s)&quot;</highlight><highlight class="normal">,<sp/><ref refid="script__error_8cpp_1a6f3546ccbe6a83df56ed8791543e2ff5" kindref="member">ScriptErrorString</ref>(result-&gt;first)),<sp/>result-&gt;second);</highlight></codeline>
<codeline lineno="2164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2166"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2167"><highlight class="normal"></highlight></codeline>
<codeline lineno="2168"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cacheFullScriptStore<sp/>&amp;&amp;<sp/>!pvChecks)<sp/>{</highlight></codeline>
<codeline lineno="2169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>executed<sp/>all<sp/>of<sp/>the<sp/>provided<sp/>scripts,<sp/>and<sp/>were<sp/>told<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>cache<sp/>the<sp/>result.<sp/>Do<sp/>so<sp/>now.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>validation_cache.<ref refid="class_validation_cache_1a71db16486be5a83b5264bdce2bd1a249" kindref="member">m_script_execution_cache</ref>.<ref refid="class_cuckoo_cache_1_1cache_1ad890f3cd4e0725ea56d7e4a3305a3487" kindref="member">insert</ref>(hashCacheEntry);</highlight></codeline>
<codeline lineno="2172"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2173"><highlight class="normal"></highlight></codeline>
<codeline lineno="2174"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2175"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2176"><highlight class="normal"></highlight></codeline>
<codeline lineno="2177"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="validation_8cpp_1a497b8df01226639187a706653e88fe50" kindref="member">FatalError</ref>(<ref refid="classkernel_1_1_notifications" kindref="compound">Notifications</ref>&amp;<sp/>notifications,<sp/><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref>&amp;<sp/>state,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structbilingual__str" kindref="compound">bilingual_str</ref>&amp;<sp/>message)</highlight></codeline>
<codeline lineno="2178"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2179"><highlight class="normal"><sp/><sp/><sp/><sp/>notifications.<ref refid="classkernel_1_1_notifications_1a2998f041aae2f227bb4bba3d9cb7a292" kindref="member">fatalError</ref>(message);</highlight></codeline>
<codeline lineno="2180"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a9d886f26067de6ec090eb37e26b8f510" kindref="member">Error</ref>(message.<ref refid="structbilingual__str_1ab9617c9d0390836c14d40e0aa6e84ab3" kindref="member">original</ref>);</highlight></codeline>
<codeline lineno="2181"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2182"><highlight class="normal"></highlight></codeline>
<codeline lineno="2190"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="validation_8cpp_1a492da8f7add38097a8e55f3445a9c83b" kindref="member">ApplyTxInUndo</ref>(<ref refid="class_coin" kindref="compound">Coin</ref>&amp;&amp;<sp/>undo,<sp/><ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref>&amp;<sp/>view,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_out_point" kindref="compound">COutPoint</ref>&amp;<sp/>out)</highlight></codeline>
<codeline lineno="2191"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2192"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fClean<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2193"><highlight class="normal"></highlight></codeline>
<codeline lineno="2194"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(view.<ref refid="class_c_coins_view_cache_1a57c7063d0b2cb3900509d8a9e91a8459" kindref="member">HaveCoin</ref>(out))<sp/>fClean<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>overwriting<sp/>transaction<sp/>output</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2195"><highlight class="normal"></highlight></codeline>
<codeline lineno="2196"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(undo.nHeight<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2197"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Missing<sp/>undo<sp/>metadata<sp/>(height<sp/>and<sp/>coinbase).<sp/>Older<sp/>versions<sp/>included<sp/>this</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>information<sp/>only<sp/>in<sp/>undo<sp/>records<sp/>for<sp/>the<sp/>last<sp/>spend<sp/>of<sp/>a<sp/>transactions&apos;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2199"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>outputs.<sp/>This<sp/>implies<sp/>that<sp/>it<sp/>must<sp/>be<sp/>present<sp/>for<sp/>some<sp/>other<sp/>output<sp/>of<sp/>the<sp/>same<sp/>tx.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_coin" kindref="compound">Coin</ref>&amp;<sp/>alternate<sp/>=<sp/><ref refid="coins_8cpp_1ae1198ec42f88d653cdc627aabbdb1ff9" kindref="member">AccessByTxid</ref>(view,<sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>.hash);</highlight></codeline>
<codeline lineno="2201"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!alternate.<ref refid="class_coin_1ae0032141d9e76130a91e97e19eaad1ec" kindref="member">IsSpent</ref>())<sp/>{</highlight></codeline>
<codeline lineno="2202"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>undo.nHeight<sp/>=<sp/>alternate.<ref refid="class_coin_1a83c6e5c63b15b7acaec51e3bb857fe16" kindref="member">nHeight</ref>;</highlight></codeline>
<codeline lineno="2203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>undo.fCoinBase<sp/>=<sp/>alternate.<ref refid="class_coin_1a4a6552fb2742742dcf3f4671ff961683" kindref="member">fCoinBase</ref>;</highlight></codeline>
<codeline lineno="2204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1aeaef80b01ee5387f474a63ed23c9cc50a4b6c24922aff8a510f83333397b4c9b3" kindref="member">DISCONNECT_FAILED</ref>;<sp/></highlight><highlight class="comment">//<sp/>adding<sp/>output<sp/>for<sp/>transaction<sp/>without<sp/>known<sp/>metadata</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2206"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2207"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2208"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>coin<sp/>already<sp/>exists<sp/>as<sp/>an<sp/>unspent<sp/>coin<sp/>in<sp/>the<sp/>cache,<sp/>then<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2209"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>possible_overwrite<sp/>parameter<sp/>to<sp/>AddCoin<sp/>must<sp/>be<sp/>set<sp/>to<sp/>true.<sp/>We<sp/>have</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2210"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>already<sp/>checked<sp/>whether<sp/>an<sp/>unspent<sp/>coin<sp/>exists<sp/>above<sp/>using<sp/>HaveCoin,<sp/>so</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2211"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>don&apos;t<sp/>need<sp/>to<sp/>guess.<sp/>When<sp/>fClean<sp/>is<sp/>false,<sp/>an<sp/>unspent<sp/>coin<sp/>already</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2212"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>existed<sp/>and<sp/>it<sp/>is<sp/>an<sp/>overwrite.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2213"><highlight class="normal"><sp/><sp/><sp/><sp/>view.<ref refid="class_c_coins_view_cache_1a0fe5f056188a32c5ae94aa19e1351698" kindref="member">AddCoin</ref>(out,<sp/>std::move(undo),<sp/>!fClean);</highlight></codeline>
<codeline lineno="2214"><highlight class="normal"></highlight></codeline>
<codeline lineno="2215"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>fClean<sp/>?<sp/><ref refid="validation_8h_1aeaef80b01ee5387f474a63ed23c9cc50af732a362dae37684d825e000781628c4" kindref="member">DISCONNECT_OK</ref><sp/>:<sp/><ref refid="validation_8h_1aeaef80b01ee5387f474a63ed23c9cc50a538a133d18fdc8786c4b0f0e6662f6c5" kindref="member">DISCONNECT_UNCLEAN</ref>;</highlight></codeline>
<codeline lineno="2216"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2217"><highlight class="normal"></highlight></codeline>
<codeline lineno="2220"><highlight class="normal"><ref refid="validation_8h_1aeaef80b01ee5387f474a63ed23c9cc50" kindref="member">DisconnectResult</ref><sp/>Chainstate::DisconnectBlock(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block" kindref="compound">CBlock</ref>&amp;<sp/>block,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>pindex,<sp/><ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref>&amp;<sp/>view)</highlight></codeline>
<codeline lineno="2221"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2222"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="2223"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fClean<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2224"><highlight class="normal"></highlight></codeline>
<codeline lineno="2225"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockUndo<sp/>blockUndo;</highlight></codeline>
<codeline lineno="2226"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.ReadBlockUndo(blockUndo,<sp/>*pindex))<sp/>{</highlight></codeline>
<codeline lineno="2227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;DisconnectBlock():<sp/>failure<sp/>reading<sp/>undo<sp/>data\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1aeaef80b01ee5387f474a63ed23c9cc50a4b6c24922aff8a510f83333397b4c9b3" kindref="member">DISCONNECT_FAILED</ref>;</highlight></codeline>
<codeline lineno="2229"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2230"><highlight class="normal"></highlight></codeline>
<codeline lineno="2231"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(blockUndo.<ref refid="class_c_block_undo_1aa41af4345ed377886c20b22014974183" kindref="member">vtxundo</ref>.size()<sp/>+<sp/>1<sp/>!=<sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>.size())<sp/>{</highlight></codeline>
<codeline lineno="2232"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;DisconnectBlock():<sp/>block<sp/>and<sp/>undo<sp/>data<sp/>inconsistent\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1aeaef80b01ee5387f474a63ed23c9cc50a4b6c24922aff8a510f83333397b4c9b3" kindref="member">DISCONNECT_FAILED</ref>;</highlight></codeline>
<codeline lineno="2234"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2235"><highlight class="normal"></highlight></codeline>
<codeline lineno="2236"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ignore<sp/>blocks<sp/>that<sp/>contain<sp/>transactions<sp/>which<sp/>are<sp/>&apos;overwritten&apos;<sp/>by<sp/>later<sp/>transactions,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2237"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>unless<sp/>those<sp/>are<sp/>already<sp/>completely<sp/>spent.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2238"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>See<sp/>https://github.com/bitcoin/bitcoin/issues/22596<sp/>for<sp/>additional<sp/>information.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2239"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note:<sp/>the<sp/>blocks<sp/>specified<sp/>here<sp/>are<sp/>different<sp/>than<sp/>the<sp/>ones<sp/>used<sp/>in<sp/>ConnectBlock<sp/>because<sp/>DisconnectBlock</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2240"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>unwinds<sp/>the<sp/>blocks<sp/>in<sp/>reverse.<sp/>As<sp/>a<sp/>result,<sp/>the<sp/>inconsistency<sp/>is<sp/>not<sp/>discovered<sp/>until<sp/>the<sp/>earlier</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2241"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>blocks<sp/>with<sp/>the<sp/>duplicate<sp/>coinbase<sp/>transactions<sp/>are<sp/>disconnected.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2242"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fEnforceBIP30<sp/>=<sp/>!((pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>==91722<sp/>&amp;&amp;<sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>()<sp/>==<sp/>uint256{</highlight><highlight class="stringliteral">&quot;00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e&quot;</highlight><highlight class="normal">})<sp/>||</highlight></codeline>
<codeline lineno="2243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>==91812<sp/>&amp;&amp;<sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>()<sp/>==<sp/>uint256{</highlight><highlight class="stringliteral">&quot;00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f&quot;</highlight><highlight class="normal">}));</highlight></codeline>
<codeline lineno="2244"><highlight class="normal"></highlight></codeline>
<codeline lineno="2245"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>undo<sp/>transactions<sp/>in<sp/>reverse<sp/>order</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2246"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>.size()<sp/>-<sp/>1;<sp/>i<sp/>&gt;=<sp/>0;<sp/>i--)<sp/>{</highlight></codeline>
<codeline lineno="2247"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CTransaction<sp/>&amp;tx<sp/>=<sp/>*(block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>[i]);</highlight></codeline>
<codeline lineno="2248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="transaction__identifier_8h_1ac4bb3c35b94889843d632be4de4b223c" kindref="member">Txid</ref><sp/>hash<sp/>=<sp/>tx.<ref refid="class_c_transaction_1a919ff1093793433f4717d74fb751423b" kindref="member">GetHash</ref>();</highlight></codeline>
<codeline lineno="2249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>is_coinbase<sp/>=<sp/>tx.<ref refid="class_c_transaction_1a6b4def31a0a2fbc975d0087ad2d4391a" kindref="member">IsCoinBase</ref>();</highlight></codeline>
<codeline lineno="2250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>is_bip30_exception<sp/>=<sp/>(is_coinbase<sp/>&amp;&amp;<sp/>!fEnforceBIP30);</highlight></codeline>
<codeline lineno="2251"><highlight class="normal"></highlight></codeline>
<codeline lineno="2252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>that<sp/>all<sp/>outputs<sp/>are<sp/>available<sp/>and<sp/>match<sp/>the<sp/>outputs<sp/>in<sp/>the<sp/>block<sp/>itself</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>exactly.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>o<sp/>=<sp/>0;<sp/>o<sp/>&lt;<sp/>tx.<ref refid="class_c_transaction_1ab6db6ccb0e8e9a2442296af044a29d56" kindref="member">vout</ref>.size();<sp/>o++)<sp/>{</highlight></codeline>
<codeline lineno="2255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tx.<ref refid="class_c_transaction_1ab6db6ccb0e8e9a2442296af044a29d56" kindref="member">vout</ref>[o].scriptPubKey.IsUnspendable())<sp/>{</highlight></codeline>
<codeline lineno="2256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>COutPoint<sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>(hash,<sp/>o);</highlight></codeline>
<codeline lineno="2257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Coin<sp/>coin;</highlight></codeline>
<codeline lineno="2258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>is_spent<sp/>=<sp/>view.<ref refid="class_c_coins_view_cache_1af5547d7b4e71fcf9319ab7a12f7f20e0" kindref="member">SpendCoin</ref>(out,<sp/>&amp;coin);</highlight></codeline>
<codeline lineno="2259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!is_spent<sp/>||<sp/>tx.<ref refid="class_c_transaction_1ab6db6ccb0e8e9a2442296af044a29d56" kindref="member">vout</ref>[o]<sp/>!=<sp/>coin.<ref refid="class_coin_1adafe93fbab174bb8f09c8a3b9df178fa" kindref="member">out</ref><sp/>||<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>!=<sp/>coin.<ref refid="class_coin_1a83c6e5c63b15b7acaec51e3bb857fe16" kindref="member">nHeight</ref><sp/>||<sp/>is_coinbase<sp/>!=<sp/>coin.<ref refid="class_coin_1a4a6552fb2742742dcf3f4671ff961683" kindref="member">fCoinBase</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!is_bip30_exception)<sp/>{</highlight></codeline>
<codeline lineno="2261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fClean<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>transaction<sp/>output<sp/>mismatch</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2262"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2263"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2264"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2265"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2266"><highlight class="normal"></highlight></codeline>
<codeline lineno="2267"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>restore<sp/>inputs</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(i<sp/>&gt;<sp/>0)<sp/>{<sp/></highlight><highlight class="comment">//<sp/>not<sp/>coinbases</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CTxUndo<sp/>&amp;txundo<sp/>=<sp/>blockUndo.<ref refid="class_c_block_undo_1aa41af4345ed377886c20b22014974183" kindref="member">vtxundo</ref>[i-1];</highlight></codeline>
<codeline lineno="2270"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(txundo.<ref refid="class_c_tx_undo_1a60d1b1864658cd68a134218c2226d140" kindref="member">vprevout</ref>.size()<sp/>!=<sp/>tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>.size())<sp/>{</highlight></codeline>
<codeline lineno="2271"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;DisconnectBlock():<sp/>transaction<sp/>and<sp/>undo<sp/>data<sp/>inconsistent\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1aeaef80b01ee5387f474a63ed23c9cc50a4b6c24922aff8a510f83333397b4c9b3" kindref="member">DISCONNECT_FAILED</ref>;</highlight></codeline>
<codeline lineno="2273"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>j<sp/>=<sp/>tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>.size();<sp/>j<sp/>&gt;<sp/>0;)<sp/>{</highlight></codeline>
<codeline lineno="2275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--j;</highlight></codeline>
<codeline lineno="2276"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>COutPoint&amp;<sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref><sp/>=<sp/>tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>[j].prevout;</highlight></codeline>
<codeline lineno="2277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>res<sp/>=<sp/><ref refid="coins__tests_8cpp_1a492da8f7add38097a8e55f3445a9c83b" kindref="member">ApplyTxInUndo</ref>(std::move(txundo.<ref refid="class_c_tx_undo_1a60d1b1864658cd68a134218c2226d140" kindref="member">vprevout</ref>[j]),<sp/>view,<sp/>out);</highlight></codeline>
<codeline lineno="2278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>==<sp/><ref refid="validation_8h_1aeaef80b01ee5387f474a63ed23c9cc50a4b6c24922aff8a510f83333397b4c9b3" kindref="member">DISCONNECT_FAILED</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1aeaef80b01ee5387f474a63ed23c9cc50a4b6c24922aff8a510f83333397b4c9b3" kindref="member">DISCONNECT_FAILED</ref>;</highlight></codeline>
<codeline lineno="2279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fClean<sp/>=<sp/>fClean<sp/>&amp;&amp;<sp/>res<sp/>!=<sp/><ref refid="validation_8h_1aeaef80b01ee5387f474a63ed23c9cc50a538a133d18fdc8786c4b0f0e6662f6c5" kindref="member">DISCONNECT_UNCLEAN</ref>;</highlight></codeline>
<codeline lineno="2280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>At<sp/>this<sp/>point,<sp/>all<sp/>of<sp/>txundo.vprevout<sp/>should<sp/>have<sp/>been<sp/>moved<sp/>out.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2283"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2284"><highlight class="normal"></highlight></codeline>
<codeline lineno="2285"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>move<sp/>best<sp/>block<sp/>pointer<sp/>to<sp/>prevout<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2286"><highlight class="normal"><sp/><sp/><sp/><sp/>view.<ref refid="class_c_coins_view_cache_1ae3eca32d352e35141dee0a90d5d29b09" kindref="member">SetBestBlock</ref>(pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>());</highlight></codeline>
<codeline lineno="2287"><highlight class="normal"></highlight></codeline>
<codeline lineno="2288"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>fClean<sp/>?<sp/><ref refid="validation_8h_1aeaef80b01ee5387f474a63ed23c9cc50af732a362dae37684d825e000781628c4" kindref="member">DISCONNECT_OK</ref><sp/>:<sp/><ref refid="validation_8h_1aeaef80b01ee5387f474a63ed23c9cc50a538a133d18fdc8786c4b0f0e6662f6c5" kindref="member">DISCONNECT_UNCLEAN</ref>;</highlight></codeline>
<codeline lineno="2289"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2290"><highlight class="normal"></highlight></codeline>
<codeline lineno="2291"><highlight class="normal"><ref refid="classscript__verify__flags" kindref="compound">script_verify_flags</ref><sp/><ref refid="validation_8cpp_1a1c5c1cc0abaf193cde025de8c0827b50" kindref="member">GetBlockScriptFlags</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>&amp;<sp/>block_index,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager" kindref="compound">ChainstateManager</ref>&amp;<sp/>chainman)</highlight></codeline>
<codeline lineno="2292"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2293"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_consensus_1_1_params" kindref="compound">Consensus::Params</ref>&amp;<sp/>consensusparams<sp/>=<sp/>chainman.<ref refid="class_chainstate_manager_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>();</highlight></codeline>
<codeline lineno="2294"><highlight class="normal"></highlight></codeline>
<codeline lineno="2295"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>BIP16<sp/>didn&apos;t<sp/>become<sp/>active<sp/>until<sp/>Apr<sp/>1<sp/>2012<sp/>(on<sp/>mainnet,<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2296"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>retroactively<sp/>applied<sp/>to<sp/>testnet)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2297"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>However,<sp/>only<sp/>one<sp/>historical<sp/>block<sp/>violated<sp/>the<sp/>P2SH<sp/>rules<sp/>(on<sp/>both</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2298"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>mainnet<sp/>and<sp/>testnet).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2299"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Similarly,<sp/>only<sp/>one<sp/>historical<sp/>block<sp/>violated<sp/>the<sp/>TAPROOT<sp/>rules<sp/>on</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2300"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>mainnet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2301"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>For<sp/>simplicity,<sp/>always<sp/>leave<sp/>P2SH+WITNESS+TAPROOT<sp/>on<sp/>except<sp/>for<sp/>the<sp/>two</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2302"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>violating<sp/>blocks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2303"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classscript__verify__flags" kindref="compound">script_verify_flags</ref><sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref>{<ref refid="interpreter_8h_1adfb2695ade741a5e62728f3586ec1637aeb9561bbd06f9c457e9a44535a261134" kindref="member">SCRIPT_VERIFY_P2SH</ref><sp/>|<sp/><ref refid="interpreter_8h_1adfb2695ade741a5e62728f3586ec1637a41693a201df8f796c932d407b22da9b2" kindref="member">SCRIPT_VERIFY_WITNESS</ref><sp/>|<sp/><ref refid="interpreter_8h_1adfb2695ade741a5e62728f3586ec1637a2b10f642a96e43bb3dd3c8c0f51c433f" kindref="member">SCRIPT_VERIFY_TAPROOT</ref>};</highlight></codeline>
<codeline lineno="2304"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it{consensusparams.<ref refid="struct_consensus_1_1_params_1a0c848f77914a58378808b6a58634df1e" kindref="member">script_flag_exceptions</ref>.find(*<ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(block_index.<ref refid="class_c_block_index_1a8459b1786042d3faba1396a4f86d8eb5" kindref="member">phashBlock</ref>))};</highlight></codeline>
<codeline lineno="2305"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>!=<sp/>consensusparams.<ref refid="struct_consensus_1_1_params_1a0c848f77914a58378808b6a58634df1e" kindref="member">script_flag_exceptions</ref>.end())<sp/>{</highlight></codeline>
<codeline lineno="2306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref><sp/>=<sp/>it-&gt;second;</highlight></codeline>
<codeline lineno="2307"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2308"><highlight class="normal"></highlight></codeline>
<codeline lineno="2309"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Enforce<sp/>the<sp/>DERSIG<sp/>(BIP66)<sp/>rule</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2310"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="deploymentstatus_8h_1af313e9a747786adc5b5f3fc8e4e1a3fe" kindref="member">DeploymentActiveAt</ref>(block_index,<sp/>chainman,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dba9b198a4567631e6d680f681323e5f570" kindref="member">Consensus::DEPLOYMENT_DERSIG</ref>))<sp/>{</highlight></codeline>
<codeline lineno="2311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref><sp/>|=<sp/><ref refid="interpreter_8h_1adfb2695ade741a5e62728f3586ec1637a683b906961d0b296bd1d590777aab12a" kindref="member">SCRIPT_VERIFY_DERSIG</ref>;</highlight></codeline>
<codeline lineno="2312"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2313"><highlight class="normal"></highlight></codeline>
<codeline lineno="2314"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Enforce<sp/>CHECKLOCKTIMEVERIFY<sp/>(BIP65)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2315"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="deploymentstatus_8h_1af313e9a747786adc5b5f3fc8e4e1a3fe" kindref="member">DeploymentActiveAt</ref>(block_index,<sp/>chainman,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dbab075214b98f7a132f0d5a1eba5c7532a" kindref="member">Consensus::DEPLOYMENT_CLTV</ref>))<sp/>{</highlight></codeline>
<codeline lineno="2316"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref><sp/>|=<sp/><ref refid="interpreter_8h_1adfb2695ade741a5e62728f3586ec1637a2fb7c2ee28fb2a70eb4401a347641a8e" kindref="member">SCRIPT_VERIFY_CHECKLOCKTIMEVERIFY</ref>;</highlight></codeline>
<codeline lineno="2317"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2318"><highlight class="normal"></highlight></codeline>
<codeline lineno="2319"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Enforce<sp/>CHECKSEQUENCEVERIFY<sp/>(BIP112)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2320"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="deploymentstatus_8h_1af313e9a747786adc5b5f3fc8e4e1a3fe" kindref="member">DeploymentActiveAt</ref>(block_index,<sp/>chainman,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dba16355a4f6631092993cd03be7f3d036e" kindref="member">Consensus::DEPLOYMENT_CSV</ref>))<sp/>{</highlight></codeline>
<codeline lineno="2321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref><sp/>|=<sp/><ref refid="interpreter_8h_1adfb2695ade741a5e62728f3586ec1637a2b8db46985788749ca121e3ea5df8ef9" kindref="member">SCRIPT_VERIFY_CHECKSEQUENCEVERIFY</ref>;</highlight></codeline>
<codeline lineno="2322"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2323"><highlight class="normal"></highlight></codeline>
<codeline lineno="2324"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Enforce<sp/>BIP147<sp/>NULLDUMMY<sp/>(activated<sp/>simultaneously<sp/>with<sp/>segwit)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2325"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="deploymentstatus_8h_1af313e9a747786adc5b5f3fc8e4e1a3fe" kindref="member">DeploymentActiveAt</ref>(block_index,<sp/>chainman,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dbac12a10e827db62556122f2b1a9b0431b" kindref="member">Consensus::DEPLOYMENT_SEGWIT</ref>))<sp/>{</highlight></codeline>
<codeline lineno="2326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref><sp/>|=<sp/><ref refid="interpreter_8h_1adfb2695ade741a5e62728f3586ec1637a0ab11c20d71a618fb3e4920acd4b8bd3" kindref="member">SCRIPT_VERIFY_NULLDUMMY</ref>;</highlight></codeline>
<codeline lineno="2327"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2328"><highlight class="normal"></highlight></codeline>
<codeline lineno="2329"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref>;</highlight></codeline>
<codeline lineno="2330"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2331"><highlight class="normal"></highlight></codeline>
<codeline lineno="2332"><highlight class="normal"></highlight></codeline>
<codeline lineno="2336"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1a0487c7fe4cdc89e309556f86c2988c80" kindref="member">Chainstate::ConnectBlock</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block" kindref="compound">CBlock</ref>&amp;<sp/>block,<sp/><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref>&amp;<sp/>state,<sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>pindex,</highlight></codeline>
<codeline lineno="2337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref>&amp;<sp/>view,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fJustCheck)</highlight></codeline>
<codeline lineno="2338"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2339"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="2340"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindex);</highlight></codeline>
<codeline lineno="2341"><highlight class="normal"></highlight></codeline>
<codeline lineno="2342"><highlight class="normal"><sp/><sp/><sp/><sp/>uint256<sp/>block_hash{block.<ref refid="class_c_block_header_1a6df30b63c4634d52dfeaadb46d60d0f5" kindref="member">GetHash</ref>()};</highlight></codeline>
<codeline lineno="2343"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(*pindex-&gt;<ref refid="class_c_block_index_1a8459b1786042d3faba1396a4f86d8eb5" kindref="member">phashBlock</ref><sp/>==<sp/>block_hash);</highlight></codeline>
<codeline lineno="2344"><highlight class="normal"></highlight></codeline>
<codeline lineno="2345"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>time_start{SteadyClock::now()};</highlight></codeline>
<codeline lineno="2346"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CChainParams&amp;<sp/>params{<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetParams()};</highlight></codeline>
<codeline lineno="2347"><highlight class="normal"></highlight></codeline>
<codeline lineno="2348"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>it<sp/>again<sp/>in<sp/>case<sp/>a<sp/>previous<sp/>version<sp/>let<sp/>a<sp/>bad<sp/>block<sp/>in</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2349"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>NOTE:<sp/>We<sp/>don&apos;t<sp/>currently<sp/>(re-)invoke<sp/>ContextualCheckBlock()<sp/>or</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2350"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ContextualCheckBlockHeader()<sp/>here.<sp/>This<sp/>means<sp/>that<sp/>if<sp/>we<sp/>add<sp/>a<sp/>new</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2351"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>consensus<sp/>rule<sp/>that<sp/>is<sp/>enforced<sp/>in<sp/>one<sp/>of<sp/>those<sp/>two<sp/>functions,<sp/>then<sp/>we</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2352"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>may<sp/>have<sp/>let<sp/>in<sp/>a<sp/>block<sp/>that<sp/>violates<sp/>the<sp/>rule<sp/>prior<sp/>to<sp/>updating<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2353"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>software,<sp/>and<sp/>we<sp/>would<sp/>NOT<sp/>be<sp/>enforcing<sp/>the<sp/>rule<sp/>here.<sp/>Fully<sp/>solving</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2354"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>upgrade<sp/>from<sp/>one<sp/>software<sp/>version<sp/>to<sp/>the<sp/>next<sp/>after<sp/>a<sp/>consensus<sp/>rule</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2355"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>change<sp/>is<sp/>potentially<sp/>tricky<sp/>and<sp/>issue-specific<sp/>(see<sp/>NeedsRedownload()</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2356"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>for<sp/>one<sp/>approach<sp/>that<sp/>was<sp/>used<sp/>for<sp/>BIP<sp/>141<sp/>deployment).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2357"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Also,<sp/>currently<sp/>the<sp/>rule<sp/>against<sp/>blocks<sp/>more<sp/>than<sp/>2<sp/>hours<sp/>in<sp/>the<sp/>future</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2358"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>is<sp/>enforced<sp/>in<sp/>ContextualCheckBlockHeader();<sp/>we<sp/>wouldn&apos;t<sp/>want<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2359"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>re-enforce<sp/>that<sp/>rule<sp/>here<sp/>(at<sp/>least<sp/>until<sp/>we<sp/>make<sp/>it<sp/>impossible<sp/>for</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2360"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>clock<sp/>to<sp/>go<sp/>backward).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2361"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="validation_8h_1a9d72a901e6237b2e81465a7425f4112c" kindref="member">CheckBlock</ref>(block,<sp/>state,<sp/>params.<ref refid="class_c_chain_params_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>(),<sp/>!fJustCheck,<sp/>!fJustCheck))<sp/>{</highlight></codeline>
<codeline lineno="2362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.<ref refid="class_validation_state_1a1b98c7dab961aab90e13b3f3f9fcf52d" kindref="member">GetResult</ref>()<sp/>==<sp/><ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580aa74bec7838a1da98fe1e6e0620d31170" kindref="member">BlockValidationResult::BLOCK_MUTATED</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>don&apos;t<sp/>write<sp/>down<sp/>blocks<sp/>to<sp/>disk<sp/>if<sp/>they<sp/>may<sp/>have<sp/>been</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>corrupted,<sp/>so<sp/>this<sp/>should<sp/>be<sp/>impossible<sp/>unless<sp/>we&apos;re<sp/>having<sp/>hardware</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>problems.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2366"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a5a516dcd32726994512c2dfe67439ba2" kindref="member">FatalError</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetNotifications(),<sp/>state,<sp/><ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight><highlight class="stringliteral">&quot;Corrupt<sp/>block<sp/>found<sp/>indicating<sp/>potential<sp/>hardware<sp/>failure.&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="2367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;%s:<sp/>Consensus::CheckBlock:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="2369"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2370"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2371"><highlight class="normal"></highlight></codeline>
<codeline lineno="2372"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>verify<sp/>that<sp/>the<sp/>view&apos;s<sp/>current<sp/>state<sp/>corresponds<sp/>to<sp/>the<sp/>previous<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2373"><highlight class="normal"><sp/><sp/><sp/><sp/>uint256<sp/>hashPrevBlock<sp/>=<sp/>pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>?<sp/>uint256()<sp/>:<sp/>pindex-&gt;pprev-&gt;GetBlockHash();</highlight></codeline>
<codeline lineno="2374"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(hashPrevBlock<sp/>==<sp/>view.<ref refid="class_c_coins_view_cache_1a357197e89d0c22e33f9e58b3dac685ff" kindref="member">GetBestBlock</ref>());</highlight></codeline>
<codeline lineno="2375"><highlight class="normal"></highlight></codeline>
<codeline lineno="2376"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.num_blocks_total++;</highlight></codeline>
<codeline lineno="2377"><highlight class="normal"></highlight></codeline>
<codeline lineno="2378"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Special<sp/>case<sp/>for<sp/>the<sp/>genesis<sp/>block,<sp/>skipping<sp/>connection<sp/>of<sp/>its<sp/>transactions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2379"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(its<sp/>coinbase<sp/>is<sp/>unspendable)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2380"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(block_hash<sp/>==<sp/>params.<ref refid="class_c_chain_params_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>().<ref refid="struct_consensus_1_1_params_1a73ddcb7f11d0a36fe155d1139e667069" kindref="member">hashGenesisBlock</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2381"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!fJustCheck)</highlight></codeline>
<codeline lineno="2382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>view.<ref refid="class_c_coins_view_cache_1ae3eca32d352e35141dee0a90d5d29b09" kindref="member">SetBestBlock</ref>(pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>());</highlight></codeline>
<codeline lineno="2383"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2384"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2385"><highlight class="normal"></highlight></codeline>
<codeline lineno="2386"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*<sp/>script_check_reason;</highlight></codeline>
<codeline lineno="2387"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.AssumedValidBlock().IsNull())<sp/>{</highlight></codeline>
<codeline lineno="2388"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>script_check_reason<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;assumevalid=0<sp/>(always<sp/>verify)&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2389"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2390"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>int64_t<sp/>TWO_WEEKS_IN_SECONDS{60<sp/>*<sp/>60<sp/>*<sp/>24<sp/>*<sp/>7<sp/>*<sp/>2};</highlight></codeline>
<codeline lineno="2391"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We&apos;ve<sp/>been<sp/>configured<sp/>with<sp/>the<sp/>hash<sp/>of<sp/>a<sp/>block<sp/>which<sp/>has<sp/>been<sp/>externally<sp/>verified<sp/>to<sp/>have<sp/>a<sp/>valid<sp/>history.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2392"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>A<sp/>suitable<sp/>default<sp/>value<sp/>is<sp/>included<sp/>with<sp/>the<sp/>software<sp/>and<sp/>updated<sp/>from<sp/>time<sp/>to<sp/>time.<sp/><sp/>Because<sp/>validity</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2393"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/>relative<sp/>to<sp/>a<sp/>piece<sp/>of<sp/>software<sp/>is<sp/>an<sp/>objective<sp/>fact<sp/>these<sp/>defaults<sp/>can<sp/>be<sp/>easily<sp/>reviewed.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2394"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>setting<sp/>doesn&apos;t<sp/>force<sp/>the<sp/>selection<sp/>of<sp/>any<sp/>particular<sp/>chain<sp/>but<sp/>makes<sp/>validating<sp/>some<sp/>faster<sp/>by</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2395"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/>effectively<sp/>caching<sp/>the<sp/>result<sp/>of<sp/>part<sp/>of<sp/>the<sp/>verification.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2396"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BlockMap::const_iterator<sp/>it{<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_block_index.find(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.AssumedValidBlock())};</highlight></codeline>
<codeline lineno="2397"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>==<sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_block_index.end())<sp/>{</highlight></codeline>
<codeline lineno="2398"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>script_check_reason<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;assumevalid<sp/>hash<sp/>not<sp/>in<sp/>headers&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2399"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it-&gt;second.GetAncestor(pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>)<sp/>!=<sp/>pindex)<sp/>{</highlight></codeline>
<codeline lineno="2400"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>script_check_reason<sp/>=<sp/>(pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>&gt;<sp/>it-&gt;second.nHeight)<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;block<sp/>height<sp/>above<sp/>assumevalid<sp/>height&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;block<sp/>not<sp/>in<sp/>assumevalid<sp/>chain&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2401"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_header-&gt;GetAncestor(pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>)<sp/>!=<sp/>pindex)<sp/>{</highlight></codeline>
<codeline lineno="2402"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>script_check_reason<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;block<sp/>not<sp/>in<sp/>best<sp/>header<sp/>chain&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2403"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_header-&gt;nChainWork<sp/>&lt;<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.MinimumChainWork())<sp/>{</highlight></codeline>
<codeline lineno="2404"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>script_check_reason<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;best<sp/>header<sp/>chainwork<sp/>below<sp/>minimumchainwork&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2405"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="chain_8cpp_1abe314b9d901829ab0166322b67cffd70" kindref="member">GetBlockProofEquivalentTime</ref>(*<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_header,<sp/>*pindex,<sp/>*<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_header,<sp/>params.<ref refid="class_c_chain_params_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>())<sp/>&lt;=<sp/>TWO_WEEKS_IN_SECONDS)<sp/>{</highlight></codeline>
<codeline lineno="2406"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>script_check_reason<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;block<sp/>too<sp/>recent<sp/>relative<sp/>to<sp/>best<sp/>header&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2407"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2408"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>block<sp/>is<sp/>a<sp/>member<sp/>of<sp/>the<sp/>assumed<sp/>verified<sp/>chain<sp/>and<sp/>an<sp/>ancestor<sp/>of<sp/>the<sp/>best<sp/>header.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2409"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Script<sp/>verification<sp/>is<sp/>skipped<sp/>when<sp/>connecting<sp/>blocks<sp/>under<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2410"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/>assumevalid<sp/>block.<sp/>Assuming<sp/>the<sp/>assumevalid<sp/>block<sp/>is<sp/>valid<sp/>this</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/>is<sp/>safe<sp/>because<sp/>block<sp/>merkle<sp/>hashes<sp/>are<sp/>still<sp/>computed<sp/>and<sp/>checked,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2412"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Of<sp/>course,<sp/>if<sp/>an<sp/>assumed<sp/>valid<sp/>block<sp/>is<sp/>invalid<sp/>due<sp/>to<sp/>false<sp/>scriptSigs</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/>this<sp/>optimization<sp/>would<sp/>allow<sp/>an<sp/>invalid<sp/>chain<sp/>to<sp/>be<sp/>accepted.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2414"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>equivalent<sp/>time<sp/>check<sp/>discourages<sp/>hash<sp/>power<sp/>from<sp/>extorting<sp/>the<sp/>network<sp/>via<sp/>DOS<sp/>attack</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/>into<sp/>accepting<sp/>an<sp/>invalid<sp/>block<sp/>through<sp/>telling<sp/>users<sp/>they<sp/>must<sp/>manually<sp/>set<sp/>assumevalid.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2416"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/>Requiring<sp/>a<sp/>software<sp/>change<sp/>or<sp/>burying<sp/>the<sp/>invalid<sp/>block,<sp/>regardless<sp/>of<sp/>the<sp/>setting,<sp/>makes</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2417"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/>it<sp/>hard<sp/>to<sp/>hide<sp/>the<sp/>implication<sp/>of<sp/>the<sp/>demand.<sp/>This<sp/>also<sp/>avoids<sp/>having<sp/>release<sp/>candidates</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2418"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/>that<sp/>are<sp/>hardly<sp/>doing<sp/>any<sp/>signature<sp/>verification<sp/>at<sp/>all<sp/>in<sp/>testing<sp/>without<sp/>having<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/>artificially<sp/>set<sp/>the<sp/>default<sp/>assumed<sp/>verified<sp/>block<sp/>further<sp/>back.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>test<sp/>against<sp/>the<sp/>minimum<sp/>chain<sp/>work<sp/>prevents<sp/>the<sp/>skipping<sp/>when<sp/>denied<sp/>access<sp/>to<sp/>any<sp/>chain<sp/>at</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2421"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/>least<sp/>as<sp/>good<sp/>as<sp/>the<sp/>expected<sp/>chain.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>script_check_reason<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2423"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2424"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2425"><highlight class="normal"></highlight></codeline>
<codeline lineno="2426"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>time_1{SteadyClock::now()};</highlight></codeline>
<codeline lineno="2427"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_check<sp/>+=<sp/>time_1<sp/>-<sp/>time_start;</highlight></codeline>
<codeline lineno="2428"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>,<sp/></highlight><highlight class="stringliteral">&quot;<sp/><sp/><sp/><sp/>-<sp/>Sanity<sp/>checks:<sp/>%.2fms<sp/>[%.2fs<sp/>(%.2fms/blk)]\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2429"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(time_1<sp/>-<sp/>time_start),</highlight></codeline>
<codeline lineno="2430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;SecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_check),</highlight></codeline>
<codeline lineno="2431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_check)<sp/>/<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.num_blocks_total);</highlight></codeline>
<codeline lineno="2432"><highlight class="normal"></highlight></codeline>
<codeline lineno="2433"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Do<sp/>not<sp/>allow<sp/>blocks<sp/>that<sp/>contain<sp/>transactions<sp/>which<sp/>&apos;overwrite&apos;<sp/>older<sp/>transactions,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2434"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>unless<sp/>those<sp/>are<sp/>already<sp/>completely<sp/>spent.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2435"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>such<sp/>overwrites<sp/>are<sp/>allowed,<sp/>coinbases<sp/>and<sp/>transactions<sp/>depending<sp/>upon<sp/>those</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2436"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>can<sp/>be<sp/>duplicated<sp/>to<sp/>remove<sp/>the<sp/>ability<sp/>to<sp/>spend<sp/>the<sp/>first<sp/>instance<sp/>--<sp/>even<sp/>after</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2437"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>being<sp/>sent<sp/>to<sp/>another<sp/>address.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2438"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>See<sp/>BIP30,<sp/>CVE-2012-1909,<sp/>and<sp/>https://r6.ca/blog/20120206T005236Z.html<sp/>for<sp/>more<sp/>information.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2439"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>rule<sp/>was<sp/>originally<sp/>applied<sp/>to<sp/>all<sp/>blocks<sp/>with<sp/>a<sp/>timestamp<sp/>after<sp/>March<sp/>15,<sp/>2012,<sp/>0:00<sp/>UTC.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2440"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Now<sp/>that<sp/>the<sp/>whole<sp/>chain<sp/>is<sp/>irreversibly<sp/>beyond<sp/>that<sp/>time<sp/>it<sp/>is<sp/>applied<sp/>to<sp/>all<sp/>blocks<sp/>except<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2441"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>two<sp/>in<sp/>the<sp/>chain<sp/>that<sp/>violate<sp/>it.<sp/>This<sp/>prevents<sp/>exploiting<sp/>the<sp/>issue<sp/>against<sp/>nodes<sp/>during<sp/>their</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2442"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>initial<sp/>block<sp/>download.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2443"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fEnforceBIP30<sp/>=<sp/>!<ref refid="validation_8h_1ad2cf17561482ed386ab70ddaa9b6b7a1" kindref="member">IsBIP30Repeat</ref>(*pindex);</highlight></codeline>
<codeline lineno="2444"><highlight class="normal"></highlight></codeline>
<codeline lineno="2445"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Once<sp/>BIP34<sp/>activated<sp/>it<sp/>was<sp/>not<sp/>possible<sp/>to<sp/>create<sp/>new<sp/>duplicate<sp/>coinbases<sp/>and<sp/>thus<sp/>other<sp/>than<sp/>starting</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2446"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>with<sp/>the<sp/>2<sp/>existing<sp/>duplicate<sp/>coinbase<sp/>pairs,<sp/>not<sp/>possible<sp/>to<sp/>create<sp/>overwriting<sp/>txs.<sp/><sp/>But<sp/>by<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2447"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>time<sp/>BIP34<sp/>activated,<sp/>in<sp/>each<sp/>of<sp/>the<sp/>existing<sp/>pairs<sp/>the<sp/>duplicate<sp/>coinbase<sp/>had<sp/>overwritten<sp/>the<sp/>first</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2448"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>before<sp/>the<sp/>first<sp/>had<sp/>been<sp/>spent.<sp/><sp/>Since<sp/>those<sp/>coinbases<sp/>are<sp/>sufficiently<sp/>buried<sp/>it&apos;s<sp/>no<sp/>longer<sp/>possible<sp/>to<sp/>create<sp/>further</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2449"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>duplicate<sp/>transactions<sp/>descending<sp/>from<sp/>the<sp/>known<sp/>pairs<sp/>either.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2450"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we&apos;re<sp/>on<sp/>the<sp/>known<sp/>chain<sp/>at<sp/>height<sp/>greater<sp/>than<sp/>where<sp/>BIP34<sp/>activated,<sp/>we<sp/>can<sp/>save<sp/>the<sp/>db<sp/>accesses<sp/>needed<sp/>for<sp/>the<sp/>BIP30<sp/>check.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2451"><highlight class="normal"></highlight></codeline>
<codeline lineno="2452"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>BIP34<sp/>requires<sp/>that<sp/>a<sp/>block<sp/>at<sp/>height<sp/>X<sp/>(block<sp/>X)<sp/>has<sp/>its<sp/>coinbase</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2453"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>scriptSig<sp/>start<sp/>with<sp/>a<sp/>CScriptNum<sp/>of<sp/>X<sp/>(indicated<sp/>height<sp/>X).<sp/><sp/>The<sp/>above</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2454"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>logic<sp/>of<sp/>no<sp/>longer<sp/>requiring<sp/>BIP30<sp/>once<sp/>BIP34<sp/>activates<sp/>is<sp/>flawed<sp/>in<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2455"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>case<sp/>that<sp/>there<sp/>is<sp/>a<sp/>block<sp/>X<sp/>before<sp/>the<sp/>BIP34<sp/>height<sp/>of<sp/>227,931<sp/>which<sp/>has</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2456"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>an<sp/>indicated<sp/>height<sp/>Y<sp/>where<sp/>Y<sp/>is<sp/>greater<sp/>than<sp/>X.<sp/><sp/>The<sp/>coinbase<sp/>for<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2457"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>X<sp/>would<sp/>also<sp/>be<sp/>a<sp/>valid<sp/>coinbase<sp/>for<sp/>block<sp/>Y,<sp/>which<sp/>could<sp/>be<sp/>a<sp/>BIP30</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2458"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>violation.<sp/><sp/>An<sp/>exhaustive<sp/>search<sp/>of<sp/>all<sp/>mainnet<sp/>coinbases<sp/>before<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2459"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>BIP34<sp/>height<sp/>which<sp/>have<sp/>an<sp/>indicated<sp/>height<sp/>greater<sp/>than<sp/>the<sp/>block<sp/>height</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2460"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>reveals<sp/>many<sp/>occurrences.<sp/>The<sp/>3<sp/>lowest<sp/>indicated<sp/>heights<sp/>found<sp/>are</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2461"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>209,921,<sp/>490,897,<sp/>and<sp/>1,983,702<sp/>and<sp/>thus<sp/>coinbases<sp/>for<sp/>blocks<sp/>at<sp/>these<sp/>3</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2462"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>heights<sp/>would<sp/>be<sp/>the<sp/>first<sp/>opportunity<sp/>for<sp/>BIP30<sp/>to<sp/>be<sp/>violated.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2463"><highlight class="normal"></highlight></codeline>
<codeline lineno="2464"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>search<sp/>reveals<sp/>a<sp/>great<sp/>many<sp/>blocks<sp/>which<sp/>have<sp/>an<sp/>indicated<sp/>height</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2465"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>greater<sp/>than<sp/>1,983,702,<sp/>so<sp/>we<sp/>simply<sp/>remove<sp/>the<sp/>optimization<sp/>to<sp/>skip</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2466"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>BIP30<sp/>checking<sp/>for<sp/>blocks<sp/>at<sp/>height<sp/>1,983,702<sp/>or<sp/>higher.<sp/><sp/>Before<sp/>we<sp/>reach</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2467"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>that<sp/>block<sp/>in<sp/>another<sp/>25<sp/>years<sp/>or<sp/>so,<sp/>we<sp/>should<sp/>take<sp/>advantage<sp/>of<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2468"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>future<sp/>consensus<sp/>change<sp/>to<sp/>do<sp/>a<sp/>new<sp/>and<sp/>improved<sp/>version<sp/>of<sp/>BIP34<sp/>that</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2469"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>will<sp/>actually<sp/>prevent<sp/>ever<sp/>creating<sp/>any<sp/>duplicate<sp/>coinbases<sp/>in<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2470"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>future.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2471"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>BIP34_IMPLIES_BIP30_LIMIT<sp/>=<sp/>1983702;</highlight></codeline>
<codeline lineno="2472"><highlight class="normal"></highlight></codeline>
<codeline lineno="2473"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>There<sp/>is<sp/>no<sp/>potential<sp/>to<sp/>create<sp/>a<sp/>duplicate<sp/>coinbase<sp/>at<sp/>block<sp/>209,921</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2474"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>because<sp/>this<sp/>is<sp/>still<sp/>before<sp/>the<sp/>BIP34<sp/>height<sp/>and<sp/>so<sp/>explicit<sp/>BIP30</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2475"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>checking<sp/>is<sp/>still<sp/>active.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2476"><highlight class="normal"></highlight></codeline>
<codeline lineno="2477"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>final<sp/>case<sp/>is<sp/>block<sp/>176,684<sp/>which<sp/>has<sp/>an<sp/>indicated<sp/>height<sp/>of</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2478"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>490,897.<sp/>Unfortunately,<sp/>this<sp/>issue<sp/>was<sp/>not<sp/>discovered<sp/>until<sp/>about<sp/>2<sp/>weeks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2479"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>before<sp/>block<sp/>490,897<sp/>so<sp/>there<sp/>was<sp/>not<sp/>much<sp/>opportunity<sp/>to<sp/>address<sp/>this</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2480"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>case<sp/>other<sp/>than<sp/>to<sp/>carefully<sp/>analyze<sp/>it<sp/>and<sp/>determine<sp/>it<sp/>would<sp/>not<sp/>be<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2481"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>problem.<sp/>Block<sp/>490,897<sp/>was,<sp/>in<sp/>fact,<sp/>mined<sp/>with<sp/>a<sp/>different<sp/>coinbase<sp/>than</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2482"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>block<sp/>176,684,<sp/>but<sp/>it<sp/>is<sp/>important<sp/>to<sp/>note<sp/>that<sp/>even<sp/>if<sp/>it<sp/>hadn&apos;t<sp/>been<sp/>or</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2483"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>is<sp/>remined<sp/>on<sp/>an<sp/>alternate<sp/>fork<sp/>with<sp/>a<sp/>duplicate<sp/>coinbase,<sp/>we<sp/>would<sp/>still</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2484"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>not<sp/>run<sp/>into<sp/>a<sp/>BIP30<sp/>violation.<sp/><sp/>This<sp/>is<sp/>because<sp/>the<sp/>coinbase<sp/>for<sp/>176,684</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2485"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>is<sp/>spent<sp/>in<sp/>block<sp/>185,956<sp/>in<sp/>transaction</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2486"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>d4f7fbbf92f4a3014a230b2dc70b8058d02eb36ac06b4a0736d9d60eaa9e8781.<sp/><sp/>This</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2487"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>spending<sp/>transaction<sp/>can&apos;t<sp/>be<sp/>duplicated<sp/>because<sp/>it<sp/>also<sp/>spends<sp/>coinbase</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2488"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>0328dd85c331237f18e781d692c92de57649529bd5edf1d01036daea32ffde29.<sp/><sp/>This</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2489"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>coinbase<sp/>has<sp/>an<sp/>indicated<sp/>height<sp/>of<sp/>over<sp/>4.2<sp/>billion,<sp/>and<sp/>wouldn&apos;t<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2490"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>duplicatable<sp/>until<sp/>that<sp/>height,<sp/>and<sp/>it&apos;s<sp/>currently<sp/>impossible<sp/>to<sp/>create<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2491"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>chain<sp/>that<sp/>long.<sp/>Nevertheless<sp/>we<sp/>may<sp/>wish<sp/>to<sp/>consider<sp/>a<sp/>future<sp/>soft<sp/>fork</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2492"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>which<sp/>retroactively<sp/>prevents<sp/>block<sp/>490,897<sp/>from<sp/>creating<sp/>a<sp/>duplicate</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2493"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>coinbase.<sp/>The<sp/>two<sp/>historical<sp/>BIP30<sp/>violations<sp/>often<sp/>provide<sp/>a<sp/>confusing</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2494"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>edge<sp/>case<sp/>when<sp/>manipulating<sp/>the<sp/>UTXO<sp/>and<sp/>it<sp/>would<sp/>be<sp/>simpler<sp/>not<sp/>to<sp/>have</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2495"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>another<sp/>edge<sp/>case<sp/>to<sp/>deal<sp/>with.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2496"><highlight class="normal"></highlight></codeline>
<codeline lineno="2497"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>testnet3<sp/>has<sp/>no<sp/>blocks<sp/>before<sp/>the<sp/>BIP34<sp/>height<sp/>with<sp/>indicated<sp/>heights</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2498"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>post<sp/>BIP34<sp/>before<sp/>approximately<sp/>height<sp/>486,000,000.<sp/>After<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2499"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>1,983,702<sp/>testnet3<sp/>starts<sp/>doing<sp/>unnecessary<sp/>BIP30<sp/>checking<sp/>again.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2500"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>);</highlight></codeline>
<codeline lineno="2501"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>pindexBIP34height<sp/>=<sp/>pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>-&gt;<ref refid="class_c_block_index_1ac20120d6b64792647a63d216b26e4b53" kindref="member">GetAncestor</ref>(params.<ref refid="class_c_chain_params_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>().<ref refid="struct_consensus_1_1_params_1a72f1c9efce63fdf202cf53cacc852c06" kindref="member">BIP34Height</ref>);</highlight></codeline>
<codeline lineno="2502"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//Only<sp/>continue<sp/>to<sp/>enforce<sp/>if<sp/>we&apos;re<sp/>below<sp/>BIP34<sp/>activation<sp/>height<sp/>or<sp/>the<sp/>block<sp/>hash<sp/>at<sp/>that<sp/>height<sp/>doesn&apos;t<sp/>correspond.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2503"><highlight class="normal"><sp/><sp/><sp/><sp/>fEnforceBIP30<sp/>=<sp/>fEnforceBIP30<sp/>&amp;&amp;<sp/>(!pindexBIP34height<sp/>||<sp/>!(pindexBIP34height-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>()<sp/>==<sp/>params.<ref refid="class_c_chain_params_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>().<ref refid="struct_consensus_1_1_params_1ab29f6c1d73ad62016b133d9e2a0cab4b" kindref="member">BIP34Hash</ref>));</highlight></codeline>
<codeline lineno="2504"><highlight class="normal"></highlight></codeline>
<codeline lineno="2505"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>TODO:<sp/>Remove<sp/>BIP30<sp/>checking<sp/>from<sp/>block<sp/>height<sp/>1,983,702<sp/>on,<sp/>once<sp/>we<sp/>have<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2506"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>consensus<sp/>change<sp/>that<sp/>ensures<sp/>coinbases<sp/>at<sp/>those<sp/>heights<sp/>cannot</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2507"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>duplicate<sp/>earlier<sp/>coinbases.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2508"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fEnforceBIP30<sp/>||<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>&gt;=<sp/>BIP34_IMPLIES_BIP30_LIMIT)<sp/>{</highlight></codeline>
<codeline lineno="2509"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tx<sp/>:<sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>o<sp/>=<sp/>0;<sp/>o<sp/>&lt;<sp/>tx-&gt;<ref refid="class_c_transaction_1ab6db6ccb0e8e9a2442296af044a29d56" kindref="member">vout</ref>.size();<sp/>o++)<sp/>{</highlight></codeline>
<codeline lineno="2511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(view.<ref refid="class_c_coins_view_cache_1a57c7063d0b2cb3900509d8a9e91a8459" kindref="member">HaveCoin</ref>(COutPoint(tx-&gt;<ref refid="class_c_transaction_1a919ff1093793433f4717d74fb751423b" kindref="member">GetHash</ref>(),<sp/>o)))<sp/>{</highlight></codeline>
<codeline lineno="2512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a6d95354aa8213c32922ccc6fa949befb" kindref="member">BlockValidationResult::BLOCK_CONSENSUS</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-txns-BIP30&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2513"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;tried<sp/>to<sp/>overwrite<sp/>transaction&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2515"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2516"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2517"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2518"><highlight class="normal"></highlight></codeline>
<codeline lineno="2519"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Enforce<sp/>BIP68<sp/>(sequence<sp/>locks)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2520"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nLockTimeFlags<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="2521"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="validation_8h_1ac799f78d8f44b330f7990a7eeb3071d2" kindref="member">DeploymentActiveAt</ref>(*pindex,<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dba16355a4f6631092993cd03be7f3d036e" kindref="member">Consensus::DEPLOYMENT_CSV</ref>))<sp/>{</highlight></codeline>
<codeline lineno="2522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nLockTimeFlags<sp/>|=<sp/>LOCKTIME_VERIFY_SEQUENCE;</highlight></codeline>
<codeline lineno="2523"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2524"><highlight class="normal"></highlight></codeline>
<codeline lineno="2525"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Get<sp/>the<sp/>script<sp/>flags<sp/>for<sp/>this<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2526"><highlight class="normal"><sp/><sp/><sp/><sp/>script_verify_flags<sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref>{<ref refid="validation_8h_1a1c5c1cc0abaf193cde025de8c0827b50" kindref="member">GetBlockScriptFlags</ref>(*pindex,<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>)};</highlight></codeline>
<codeline lineno="2527"><highlight class="normal"></highlight></codeline>
<codeline lineno="2528"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>time_2{SteadyClock::now()};</highlight></codeline>
<codeline lineno="2529"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_forks<sp/>+=<sp/>time_2<sp/>-<sp/>time_1;</highlight></codeline>
<codeline lineno="2530"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>,<sp/></highlight><highlight class="stringliteral">&quot;<sp/><sp/><sp/><sp/>-<sp/>Fork<sp/>checks:<sp/>%.2fms<sp/>[%.2fs<sp/>(%.2fms/blk)]\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2531"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(time_2<sp/>-<sp/>time_1),</highlight></codeline>
<codeline lineno="2532"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;SecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_forks),</highlight></codeline>
<codeline lineno="2533"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_forks)<sp/>/<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.num_blocks_total);</highlight></codeline>
<codeline lineno="2534"><highlight class="normal"></highlight></codeline>
<codeline lineno="2535"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fScriptChecks{!!script_check_reason};</highlight></codeline>
<codeline lineno="2536"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>kernel::ChainstateRole<sp/>role{GetRole()};</highlight></codeline>
<codeline lineno="2537"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(script_check_reason<sp/>!=<sp/>m_last_script_check_reason_logged<sp/>&amp;&amp;<sp/>role.<ref refid="structkernel_1_1_chainstate_role_1a42f105c7ce8a5cfea86276bc4bf1e29b" kindref="member">validated</ref><sp/>&amp;&amp;<sp/>!role.<ref refid="structkernel_1_1_chainstate_role_1aba104d5a59781b2939c4b924c7d8e008" kindref="member">historical</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2538"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fScriptChecks)<sp/>{</highlight></codeline>
<codeline lineno="2539"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Enabling<sp/>script<sp/>verification<sp/>at<sp/>block<sp/>#%d<sp/>(%s):<sp/>%s.&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2540"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>block_hash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>script_check_reason);</highlight></codeline>
<codeline lineno="2541"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2542"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Disabling<sp/>script<sp/>verification<sp/>at<sp/>block<sp/>#%d<sp/>(%s).&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2543"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>block_hash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="2544"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2545"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_last_script_check_reason_logged<sp/>=<sp/>script_check_reason;</highlight></codeline>
<codeline lineno="2546"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2547"><highlight class="normal"></highlight></codeline>
<codeline lineno="2548"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockUndo<sp/>blockundo;</highlight></codeline>
<codeline lineno="2549"><highlight class="normal"></highlight></codeline>
<codeline lineno="2550"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Precomputed<sp/>transaction<sp/>data<sp/>pointers<sp/>must<sp/>not<sp/>be<sp/>invalidated</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2551"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>until<sp/>after<sp/>`control`<sp/>has<sp/>run<sp/>the<sp/>script<sp/>checks<sp/>(potentially</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2552"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>in<sp/>multiple<sp/>threads).<sp/>Preallocate<sp/>the<sp/>vector<sp/>size<sp/>so<sp/>a<sp/>new<sp/>allocation</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2553"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>doesn&apos;t<sp/>invalidate<sp/>pointers<sp/>into<sp/>the<sp/>vector,<sp/>and<sp/>keep<sp/>txsdata<sp/>in<sp/>scope</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2554"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>for<sp/>as<sp/>long<sp/>as<sp/>`control`.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2555"><highlight class="normal"><sp/><sp/><sp/><sp/>std::optional&lt;CCheckQueueControl&lt;CScriptCheck&gt;&gt;<sp/>control;</highlight></codeline>
<codeline lineno="2556"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>queue<sp/>=<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetCheckQueue();<sp/>queue.HasThreads()<sp/>&amp;&amp;<sp/>fScriptChecks)<sp/>control.emplace(queue);</highlight></codeline>
<codeline lineno="2557"><highlight class="normal"></highlight></codeline>
<codeline lineno="2558"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;PrecomputedTransactionData&gt;<sp/>txsdata(block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>.size());</highlight></codeline>
<codeline lineno="2559"><highlight class="normal"></highlight></codeline>
<codeline lineno="2560"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;int&gt;<sp/>prevheights;</highlight></codeline>
<codeline lineno="2561"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/>nFees<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="2562"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nInputs<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="2563"><highlight class="normal"><sp/><sp/><sp/><sp/>int64_t<sp/>nSigOpsCost<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="2564"><highlight class="normal"><sp/><sp/><sp/><sp/>blockundo.<ref refid="class_c_block_undo_1aa41af4345ed377886c20b22014974183" kindref="member">vtxundo</ref>.reserve(block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>.size()<sp/>-<sp/>1);</highlight></codeline>
<codeline lineno="2565"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>.size();<sp/>i++)</highlight></codeline>
<codeline lineno="2566"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!state.<ref refid="class_validation_state_1ac532c4b500b1a85ea22217f2c65a70ed" kindref="member">IsValid</ref>())<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CTransaction<sp/>&amp;tx<sp/>=<sp/>*(block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>[i]);</highlight></codeline>
<codeline lineno="2569"><highlight class="normal"></highlight></codeline>
<codeline lineno="2570"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nInputs<sp/>+=<sp/>tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>.size();</highlight></codeline>
<codeline lineno="2571"><highlight class="normal"></highlight></codeline>
<codeline lineno="2572"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tx.<ref refid="class_c_transaction_1a6b4def31a0a2fbc975d0087ad2d4391a" kindref="member">IsCoinBase</ref>())</highlight></codeline>
<codeline lineno="2573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2574"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/>txfee<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="2575"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>TxValidationState<sp/>tx_state;</highlight></codeline>
<codeline lineno="2576"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="namespace_consensus_1a3dc747e8073036ed753fd2f53d5d1015" kindref="member">Consensus::CheckTxInputs</ref>(tx,<sp/>tx_state,<sp/>view,<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>txfee))<sp/>{</highlight></codeline>
<codeline lineno="2577"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Any<sp/>transaction<sp/>validation<sp/>failure<sp/>in<sp/>ConnectBlock<sp/>is<sp/>a<sp/>block<sp/>consensus<sp/>failure</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2578"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a6d95354aa8213c32922ccc6fa949befb" kindref="member">BlockValidationResult::BLOCK_CONSENSUS</ref>,</highlight></codeline>
<codeline lineno="2579"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_state.<ref refid="class_validation_state_1a5fef80db1db0007a9082aa7d104e2933" kindref="member">GetRejectReason</ref>(),</highlight></codeline>
<codeline lineno="2580"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_state.<ref refid="class_validation_state_1ac444b5235f12cdc04292ab64fe44226b" kindref="member">GetDebugMessage</ref>()<sp/>+<sp/></highlight><highlight class="stringliteral">&quot;<sp/>in<sp/>transaction<sp/>&quot;</highlight><highlight class="normal"><sp/>+<sp/>tx.<ref refid="class_c_transaction_1a919ff1093793433f4717d74fb751423b" kindref="member">GetHash</ref>().<ref refid="classtransaction__identifier_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="2581"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2582"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2583"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nFees<sp/>+=<sp/>txfee;</highlight></codeline>
<codeline lineno="2584"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="amount_8h_1a12db56a9a1c931941f0943ecbb278aae" kindref="member">MoneyRange</ref>(nFees))<sp/>{</highlight></codeline>
<codeline lineno="2585"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a6d95354aa8213c32922ccc6fa949befb" kindref="member">BlockValidationResult::BLOCK_CONSENSUS</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-txns-accumulated-fee-outofrange&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2586"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;accumulated<sp/>fee<sp/>in<sp/>the<sp/>block<sp/>out<sp/>of<sp/>range&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2587"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2588"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2589"><highlight class="normal"></highlight></codeline>
<codeline lineno="2590"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>that<sp/>transaction<sp/>is<sp/>BIP68<sp/>final</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2591"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>BIP68<sp/>lock<sp/>checks<sp/>(as<sp/>opposed<sp/>to<sp/>nLockTime<sp/>checks)<sp/>must</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2592"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>be<sp/>in<sp/>ConnectBlock<sp/>because<sp/>they<sp/>require<sp/>the<sp/>UTXO<sp/>set</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2593"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prevheights.resize(tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>.size());</highlight></codeline>
<codeline lineno="2594"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>.size();<sp/>j++)<sp/>{</highlight></codeline>
<codeline lineno="2595"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prevheights[j]<sp/>=<sp/>view.<ref refid="class_c_coins_view_cache_1a87f1f2449e10859291ddbdc1d090cba3" kindref="member">AccessCoin</ref>(tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>[j].prevout).<ref refid="class_coin_1a83c6e5c63b15b7acaec51e3bb857fe16" kindref="member">nHeight</ref>;</highlight></codeline>
<codeline lineno="2596"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2597"><highlight class="normal"></highlight></codeline>
<codeline lineno="2598"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="tx__verify_8cpp_1ad5b7bf644ada0a55c6aac8cfa89ed14a" kindref="member">SequenceLocks</ref>(tx,<sp/>nLockTimeFlags,<sp/>prevheights,<sp/>*pindex))<sp/>{</highlight></codeline>
<codeline lineno="2599"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a6d95354aa8213c32922ccc6fa949befb" kindref="member">BlockValidationResult::BLOCK_CONSENSUS</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-txns-nonfinal&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2600"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;contains<sp/>a<sp/>non-BIP68-final<sp/>transaction<sp/>&quot;</highlight><highlight class="normal"><sp/>+<sp/>tx.<ref refid="class_c_transaction_1a919ff1093793433f4717d74fb751423b" kindref="member">GetHash</ref>().<ref refid="classtransaction__identifier_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="2601"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2602"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2603"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2604"><highlight class="normal"></highlight></codeline>
<codeline lineno="2605"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>GetTransactionSigOpCost<sp/>counts<sp/>3<sp/>types<sp/>of<sp/>sigops:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2606"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>*<sp/>legacy<sp/>(always)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2607"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>*<sp/>p2sh<sp/>(when<sp/>P2SH<sp/>enabled<sp/>in<sp/>flags<sp/>and<sp/>excludes<sp/>coinbase)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2608"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>*<sp/>witness<sp/>(when<sp/>witness<sp/>enabled<sp/>in<sp/>flags<sp/>and<sp/>excludes<sp/>coinbase)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2609"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nSigOpsCost<sp/>+=<sp/><ref refid="tx__verify_8cpp_1ac1e236f29c0fd2b8ecee5a2846122151" kindref="member">GetTransactionSigOpCost</ref>(tx,<sp/>view,<sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref>);</highlight></codeline>
<codeline lineno="2610"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nSigOpsCost<sp/>&gt;<sp/>MAX_BLOCK_SIGOPS_COST)<sp/>{</highlight></codeline>
<codeline lineno="2611"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a6d95354aa8213c32922ccc6fa949befb" kindref="member">BlockValidationResult::BLOCK_CONSENSUS</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-blk-sigops&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;too<sp/>many<sp/>sigops&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2612"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2613"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2614"><highlight class="normal"></highlight></codeline>
<codeline lineno="2615"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tx.<ref refid="class_c_transaction_1a6b4def31a0a2fbc975d0087ad2d4391a" kindref="member">IsCoinBase</ref>()<sp/>&amp;&amp;<sp/>fScriptChecks)</highlight></codeline>
<codeline lineno="2616"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2617"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fCacheResults<sp/>=<sp/>fJustCheck;<sp/></highlight><highlight class="comment">/*<sp/>Don&apos;t<sp/>cache<sp/>results<sp/>if<sp/>we&apos;re<sp/>actually<sp/>connecting<sp/>blocks<sp/>(still<sp/>consult<sp/>the<sp/>cache,<sp/>though)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2618"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>tx_ok;</highlight></codeline>
<codeline lineno="2619"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>TxValidationState<sp/>tx_state;</highlight></codeline>
<codeline lineno="2620"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>CheckInputScripts<sp/>is<sp/>called<sp/>with<sp/>a<sp/>pointer<sp/>to<sp/>a<sp/>checks<sp/>vector,<sp/>the<sp/>resulting<sp/>checks<sp/>are<sp/>appended<sp/>to<sp/>it.<sp/>In<sp/>that<sp/>case</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2621"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>they<sp/>need<sp/>to<sp/>be<sp/>added<sp/>to<sp/>control<sp/>which<sp/>runs<sp/>them<sp/>asynchronously.<sp/>Otherwise,<sp/>CheckInputScripts<sp/>runs<sp/>the<sp/>checks<sp/>before<sp/>returning.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2622"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(control)<sp/>{</highlight></codeline>
<codeline lineno="2623"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CScriptCheck&gt;<sp/>vChecks;</highlight></codeline>
<codeline lineno="2624"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_ok<sp/>=<sp/><ref refid="txvalidationcache__tests_8cpp_1a97d6169ac38d1dc06811732fda310b8c" kindref="member">CheckInputScripts</ref>(tx,<sp/>tx_state,<sp/>view,<sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref>,<sp/>fCacheResults,<sp/>fCacheResults,<sp/>txsdata[i],<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_validation_cache,<sp/>&amp;vChecks);</highlight></codeline>
<codeline lineno="2625"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tx_ok)<sp/>control-&gt;Add(std::move(vChecks));</highlight></codeline>
<codeline lineno="2626"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2627"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_ok<sp/>=<sp/><ref refid="txvalidationcache__tests_8cpp_1a97d6169ac38d1dc06811732fda310b8c" kindref="member">CheckInputScripts</ref>(tx,<sp/>tx_state,<sp/>view,<sp/><ref refid="bitcoin-tx_8cpp_1ac8bf36fe0577cba66bccda3a6f7e80a4" kindref="member">flags</ref>,<sp/>fCacheResults,<sp/>fCacheResults,<sp/>txsdata[i],<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_validation_cache);</highlight></codeline>
<codeline lineno="2628"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2629"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tx_ok)<sp/>{</highlight></codeline>
<codeline lineno="2630"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Any<sp/>transaction<sp/>validation<sp/>failure<sp/>in<sp/>ConnectBlock<sp/>is<sp/>a<sp/>block<sp/>consensus<sp/>failure</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2631"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a6d95354aa8213c32922ccc6fa949befb" kindref="member">BlockValidationResult::BLOCK_CONSENSUS</ref>,</highlight></codeline>
<codeline lineno="2632"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_state.<ref refid="class_validation_state_1a5fef80db1db0007a9082aa7d104e2933" kindref="member">GetRejectReason</ref>(),<sp/>tx_state.<ref refid="class_validation_state_1ac444b5235f12cdc04292ab64fe44226b" kindref="member">GetDebugMessage</ref>());</highlight></codeline>
<codeline lineno="2633"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2634"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2635"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2636"><highlight class="normal"></highlight></codeline>
<codeline lineno="2637"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CTxUndo<sp/>undoDummy;</highlight></codeline>
<codeline lineno="2638"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(i<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2639"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blockundo.<ref refid="class_c_block_undo_1aa41af4345ed377886c20b22014974183" kindref="member">vtxundo</ref>.emplace_back();</highlight></codeline>
<codeline lineno="2640"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2641"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="coins__tests_8cpp_1a76ffac026788c8c1e6d55fb1beae0962" kindref="member">UpdateCoins</ref>(tx,<sp/>view,<sp/>i<sp/>==<sp/>0<sp/>?<sp/>undoDummy<sp/>:<sp/>blockundo.<ref refid="class_c_block_undo_1aa41af4345ed377886c20b22014974183" kindref="member">vtxundo</ref>.back(),<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>);</highlight></codeline>
<codeline lineno="2642"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2643"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>time_3{SteadyClock::now()};</highlight></codeline>
<codeline lineno="2644"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_connect<sp/>+=<sp/>time_3<sp/>-<sp/>time_2;</highlight></codeline>
<codeline lineno="2645"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>,<sp/></highlight><highlight class="stringliteral">&quot;<sp/><sp/><sp/><sp/><sp/><sp/>-<sp/>Connect<sp/>%u<sp/>transactions:<sp/>%.2fms<sp/>(%.3fms/tx,<sp/>%.3fms/txin)<sp/>[%.2fs<sp/>(%.2fms/blk)]\n&quot;</highlight><highlight class="normal">,<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal">)block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>.size(),</highlight></codeline>
<codeline lineno="2646"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(time_3<sp/>-<sp/>time_2),<sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(time_3<sp/>-<sp/>time_2)<sp/>/<sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>.size(),</highlight></codeline>
<codeline lineno="2647"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nInputs<sp/>&lt;=<sp/>1<sp/>?<sp/>0<sp/>:<sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(time_3<sp/>-<sp/>time_2)<sp/>/<sp/>(nInputs<sp/>-<sp/>1),</highlight></codeline>
<codeline lineno="2648"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;SecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_connect),</highlight></codeline>
<codeline lineno="2649"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_connect)<sp/>/<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.num_blocks_total);</highlight></codeline>
<codeline lineno="2650"><highlight class="normal"></highlight></codeline>
<codeline lineno="2651"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/>blockReward<sp/>=<sp/>nFees<sp/>+<sp/><ref refid="validation_8h_1a3e7cb06e156ad8400b9214479e946187" kindref="member">GetBlockSubsidy</ref>(pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>params.<ref refid="class_c_chain_params_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>());</highlight></codeline>
<codeline lineno="2652"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>[0]-&gt;GetValueOut()<sp/>&gt;<sp/>blockReward<sp/>&amp;&amp;<sp/>state.<ref refid="class_validation_state_1ac532c4b500b1a85ea22217f2c65a70ed" kindref="member">IsValid</ref>())<sp/>{</highlight></codeline>
<codeline lineno="2653"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a6d95354aa8213c32922ccc6fa949befb" kindref="member">BlockValidationResult::BLOCK_CONSENSUS</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-cb-amount&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2654"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;coinbase<sp/>pays<sp/>too<sp/>much<sp/>(actual=%d<sp/>vs<sp/>limit=%d)&quot;</highlight><highlight class="normal">,<sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>[0]-&gt;GetValueOut(),<sp/>blockReward));</highlight></codeline>
<codeline lineno="2655"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2656"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(control)<sp/>{</highlight></codeline>
<codeline lineno="2657"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>parallel_result<sp/>=<sp/>control-&gt;Complete();</highlight></codeline>
<codeline lineno="2658"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(parallel_result.has_value()<sp/>&amp;&amp;<sp/>state.<ref refid="class_validation_state_1ac532c4b500b1a85ea22217f2c65a70ed" kindref="member">IsValid</ref>())<sp/>{</highlight></codeline>
<codeline lineno="2659"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a6d95354aa8213c32922ccc6fa949befb" kindref="member">BlockValidationResult::BLOCK_CONSENSUS</ref>,<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;block-script-verify-flag-failed<sp/>(%s)&quot;</highlight><highlight class="normal">,<sp/><ref refid="script__error_8cpp_1a6f3546ccbe6a83df56ed8791543e2ff5" kindref="member">ScriptErrorString</ref>(parallel_result-&gt;first)),<sp/>parallel_result-&gt;second);</highlight></codeline>
<codeline lineno="2660"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2661"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2662"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!state.<ref refid="class_validation_state_1ac532c4b500b1a85ea22217f2c65a70ed" kindref="member">IsValid</ref>())<sp/>{</highlight></codeline>
<codeline lineno="2663"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Block<sp/>validation<sp/>error:<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="2664"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2665"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2666"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>time_4{SteadyClock::now()};</highlight></codeline>
<codeline lineno="2667"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_verify<sp/>+=<sp/>time_4<sp/>-<sp/>time_2;</highlight></codeline>
<codeline lineno="2668"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>,<sp/></highlight><highlight class="stringliteral">&quot;<sp/><sp/><sp/><sp/>-<sp/>Verify<sp/>%u<sp/>txins:<sp/>%.2fms<sp/>(%.3fms/txin)<sp/>[%.2fs<sp/>(%.2fms/blk)]\n&quot;</highlight><highlight class="normal">,<sp/>nInputs<sp/>-<sp/>1,</highlight></codeline>
<codeline lineno="2669"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(time_4<sp/>-<sp/>time_2),</highlight></codeline>
<codeline lineno="2670"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nInputs<sp/>&lt;=<sp/>1<sp/>?<sp/>0<sp/>:<sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(time_4<sp/>-<sp/>time_2)<sp/>/<sp/>(nInputs<sp/>-<sp/>1),</highlight></codeline>
<codeline lineno="2671"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;SecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_verify),</highlight></codeline>
<codeline lineno="2672"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_verify)<sp/>/<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.num_blocks_total);</highlight></codeline>
<codeline lineno="2673"><highlight class="normal"></highlight></codeline>
<codeline lineno="2674"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fJustCheck)<sp/>{</highlight></codeline>
<codeline lineno="2675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2676"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2677"><highlight class="normal"></highlight></codeline>
<codeline lineno="2678"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.WriteBlockUndo(blockundo,<sp/>state,<sp/>*pindex))<sp/>{</highlight></codeline>
<codeline lineno="2679"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2680"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2681"><highlight class="normal"></highlight></codeline>
<codeline lineno="2682"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>time_5{SteadyClock::now()};</highlight></codeline>
<codeline lineno="2683"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_undo<sp/>+=<sp/>time_5<sp/>-<sp/>time_4;</highlight></codeline>
<codeline lineno="2684"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>,<sp/></highlight><highlight class="stringliteral">&quot;<sp/><sp/><sp/><sp/>-<sp/>Write<sp/>undo<sp/>data:<sp/>%.2fms<sp/>[%.2fs<sp/>(%.2fms/blk)]\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2685"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(time_5<sp/>-<sp/>time_4),</highlight></codeline>
<codeline lineno="2686"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;SecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_undo),</highlight></codeline>
<codeline lineno="2687"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_undo)<sp/>/<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.num_blocks_total);</highlight></codeline>
<codeline lineno="2688"><highlight class="normal"></highlight></codeline>
<codeline lineno="2689"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pindex-&gt;<ref refid="class_c_block_index_1a1b5a636925d1c416b9d59eb0392a7a62" kindref="member">IsValid</ref>(<ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada47b28fca76b64d094ddca0a3aa8da230" kindref="member">BLOCK_VALID_SCRIPTS</ref>))<sp/>{</highlight></codeline>
<codeline lineno="2690"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex-&gt;<ref refid="class_c_block_index_1a983fa688e7f3390832583f64fa36c319" kindref="member">RaiseValidity</ref>(<ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada47b28fca76b64d094ddca0a3aa8da230" kindref="member">BLOCK_VALID_SCRIPTS</ref>);</highlight></codeline>
<codeline lineno="2691"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_dirty_blockindex.insert(pindex);</highlight></codeline>
<codeline lineno="2692"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2693"><highlight class="normal"></highlight></codeline>
<codeline lineno="2694"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>add<sp/>this<sp/>block<sp/>to<sp/>the<sp/>view&apos;s<sp/>block<sp/>chain</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2695"><highlight class="normal"><sp/><sp/><sp/><sp/>view.<ref refid="class_c_coins_view_cache_1ae3eca32d352e35141dee0a90d5d29b09" kindref="member">SetBestBlock</ref>(pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>());</highlight></codeline>
<codeline lineno="2696"><highlight class="normal"></highlight></codeline>
<codeline lineno="2697"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>time_6{SteadyClock::now()};</highlight></codeline>
<codeline lineno="2698"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_index<sp/>+=<sp/>time_6<sp/>-<sp/>time_5;</highlight></codeline>
<codeline lineno="2699"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>,<sp/></highlight><highlight class="stringliteral">&quot;<sp/><sp/><sp/><sp/>-<sp/>Index<sp/>writing:<sp/>%.2fms<sp/>[%.2fs<sp/>(%.2fms/blk)]\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2700"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(time_6<sp/>-<sp/>time_5),</highlight></codeline>
<codeline lineno="2701"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;SecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_index),</highlight></codeline>
<codeline lineno="2702"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_index)<sp/>/<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.num_blocks_total);</highlight></codeline>
<codeline lineno="2703"><highlight class="normal"></highlight></codeline>
<codeline lineno="2704"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="trace_8h_1ae7d4767c75c045d7e4d4b840fb4a8e5f" kindref="member">TRACEPOINT</ref>(validation,<sp/>block_connected,</highlight></codeline>
<codeline lineno="2705"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>block_hash.<ref refid="classbase__blob_1ad33ec60b8fc9ad7eef168e57aa6c5fb9" kindref="member">data</ref>(),</highlight></codeline>
<codeline lineno="2706"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,</highlight></codeline>
<codeline lineno="2707"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>.size(),</highlight></codeline>
<codeline lineno="2708"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nInputs,</highlight></codeline>
<codeline lineno="2709"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nSigOpsCost,</highlight></codeline>
<codeline lineno="2710"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;std::chrono::nanoseconds&gt;</ref>(time_5<sp/>-<sp/>time_start)</highlight></codeline>
<codeline lineno="2711"><highlight class="normal"><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="2712"><highlight class="normal"></highlight></codeline>
<codeline lineno="2713"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2714"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2715"><highlight class="normal"></highlight></codeline>
<codeline lineno="2716"><highlight class="normal"><ref refid="validation_8h_1ab8482b5889c2dd7bcef2c3a0523d3def" kindref="member">CoinsCacheSizeState</ref><sp/>Chainstate::GetCoinsCacheSizeState()</highlight></codeline>
<codeline lineno="2717"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2718"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="2719"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>this-&gt;GetCoinsCacheSizeState(</highlight></codeline>
<codeline lineno="2720"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a9f27f82f81429b6be783bb2ba38a7383" kindref="member">m_coinstip_cache_size_bytes</ref>,</highlight></codeline>
<codeline lineno="2721"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref><sp/>?<sp/><ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>-&gt;m_opts.max_size_bytes<sp/>:<sp/>0);</highlight></codeline>
<codeline lineno="2722"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2723"><highlight class="normal"></highlight></codeline>
<codeline lineno="2724"><highlight class="normal"><ref refid="validation_8h_1ab8482b5889c2dd7bcef2c3a0523d3def" kindref="member">CoinsCacheSizeState</ref><sp/>Chainstate::GetCoinsCacheSizeState(</highlight></codeline>
<codeline lineno="2725"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>max_coins_cache_size_bytes,</highlight></codeline>
<codeline lineno="2726"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>max_mempool_size_bytes)</highlight></codeline>
<codeline lineno="2727"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2728"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="2729"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>int64_t<sp/>nMempoolUsage<sp/>=<sp/><ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref><sp/>?<sp/><ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>-&gt;DynamicMemoryUsage()<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="2730"><highlight class="normal"><sp/><sp/><sp/><sp/>int64_t<sp/>cacheSize<sp/>=<sp/><ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>().<ref refid="class_c_coins_view_cache_1afcc22204abc15aeefd5d1f7396e909a4" kindref="member">DynamicMemoryUsage</ref>();</highlight></codeline>
<codeline lineno="2731"><highlight class="normal"><sp/><sp/><sp/><sp/>int64_t<sp/>nTotalSpace<sp/>=</highlight></codeline>
<codeline lineno="2732"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_coins_cache_size_bytes<sp/>+<sp/>std::max&lt;int64_t&gt;(int64_t(max_mempool_size_bytes)<sp/>-<sp/>nMempoolUsage,<sp/>0);</highlight></codeline>
<codeline lineno="2733"><highlight class="normal"></highlight></codeline>
<codeline lineno="2734"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cacheSize<sp/>&gt;<sp/>nTotalSpace)<sp/>{</highlight></codeline>
<codeline lineno="2735"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Cache<sp/>size<sp/>(%s)<sp/>exceeds<sp/>total<sp/>space<sp/>(%s)\n&quot;</highlight><highlight class="normal">,<sp/>cacheSize,<sp/>nTotalSpace);</highlight></codeline>
<codeline lineno="2736"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1ab8482b5889c2dd7bcef2c3a0523d3defa99cd1c61610c76a57cb8d10d6df6b870" kindref="member">CoinsCacheSizeState::CRITICAL</ref>;</highlight></codeline>
<codeline lineno="2737"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cacheSize<sp/>&gt;<sp/><ref refid="validation_8h_1a801a358b935aafb7dcb4d94e292a23c1" kindref="member">LargeCoinsCacheThreshold</ref>(nTotalSpace))<sp/>{</highlight></codeline>
<codeline lineno="2738"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1ab8482b5889c2dd7bcef2c3a0523d3defa71726adf0ff60cd03eaf3c515883eeb8" kindref="member">CoinsCacheSizeState::LARGE</ref>;</highlight></codeline>
<codeline lineno="2739"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2740"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1ab8482b5889c2dd7bcef2c3a0523d3defae0aa021e21dddbd6d8cecec71e9cf564" kindref="member">CoinsCacheSizeState::OK</ref>;</highlight></codeline>
<codeline lineno="2741"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2742"><highlight class="normal"></highlight></codeline>
<codeline lineno="2743"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1a0f9f0cdb703638cb9818a9b41158ac6a" kindref="member">Chainstate::FlushStateToDisk</ref>(</highlight></codeline>
<codeline lineno="2744"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref><sp/>&amp;state,</highlight></codeline>
<codeline lineno="2745"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8h_1ab30a99e75e9dc44356d1ad6bdd184ae0" kindref="member">FlushStateMode</ref><sp/>mode,</highlight></codeline>
<codeline lineno="2746"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nManualPruneHeight)</highlight></codeline>
<codeline lineno="2747"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2748"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="2749"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(this-&gt;<ref refid="class_chainstate_1a0d01ef96f22f8aaf273e8e03d993e30a" kindref="member">CanFlushToDisk</ref>());</highlight></codeline>
<codeline lineno="2750"><highlight class="normal"><sp/><sp/><sp/><sp/>std::set&lt;int&gt;<sp/>setFilesToPrune;</highlight></codeline>
<codeline lineno="2751"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>full_flush_completed<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2752"><highlight class="normal"></highlight></codeline>
<codeline lineno="2753"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>coins_count<sp/>=<sp/><ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>().<ref refid="class_c_coins_view_cache_1af787027ef08bdf3db72110265cc4f055" kindref="member">GetCacheSize</ref>();</highlight></codeline>
<codeline lineno="2754"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>coins_mem_usage<sp/>=<sp/><ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>().<ref refid="class_c_coins_view_cache_1afcc22204abc15aeefd5d1f7396e909a4" kindref="member">DynamicMemoryUsage</ref>();</highlight></codeline>
<codeline lineno="2755"><highlight class="normal"></highlight></codeline>
<codeline lineno="2756"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2757"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2758"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fFlushForPrune<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2759"><highlight class="normal"></highlight></codeline>
<codeline lineno="2760"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8h_1ab8482b5889c2dd7bcef2c3a0523d3def" kindref="member">CoinsCacheSizeState</ref><sp/>cache_state<sp/>=<sp/>GetCoinsCacheSizeState();</highlight></codeline>
<codeline lineno="2761"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.cs_LastBlockFile);</highlight></codeline>
<codeline lineno="2762"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.IsPruneMode()<sp/>&amp;&amp;<sp/>(<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_check_for_pruning<sp/>||<sp/>nManualPruneHeight<sp/>&gt;<sp/>0)<sp/>&amp;&amp;<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_blockman.m_blockfiles_indexed)<sp/>{</highlight></codeline>
<codeline lineno="2763"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>make<sp/>sure<sp/>we<sp/>don&apos;t<sp/>prune<sp/>above<sp/>any<sp/>of<sp/>the<sp/>prune<sp/>locks<sp/>bestblocks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2764"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>pruning<sp/>is<sp/>height-based</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2765"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>last_prune{<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Height()};<sp/></highlight><highlight class="comment">//<sp/>last<sp/>height<sp/>we<sp/>can<sp/>prune</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2766"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::optional&lt;std::string&gt;<sp/>limiting_lock;<sp/></highlight><highlight class="comment">//<sp/>prune<sp/>lock<sp/>that<sp/>actually<sp/>was<sp/>the<sp/>limiting<sp/>factor,<sp/>only<sp/>used<sp/>for<sp/>logging</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2767"><highlight class="normal"></highlight></codeline>
<codeline lineno="2768"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>prune_lock<sp/>:<sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_prune_locks)<sp/>{</highlight></codeline>
<codeline lineno="2769"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(prune_lock.second.height_first<sp/>==<sp/>std::numeric_limits&lt;int&gt;::max())<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2770"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Remove<sp/>the<sp/>buffer<sp/>and<sp/>one<sp/>additional<sp/>block<sp/>here<sp/>to<sp/>get<sp/>actual<sp/>height<sp/>that<sp/>is<sp/>outside<sp/>of<sp/>the<sp/>buffer</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2771"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>lock_height{prune_lock.second.height_first<sp/>-<sp/>PRUNE_LOCK_BUFFER<sp/>-<sp/>1};</highlight></codeline>
<codeline lineno="2772"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>last_prune<sp/>=<sp/>std::max(1,<sp/>std::min(last_prune,<sp/>lock_height));</highlight></codeline>
<codeline lineno="2773"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(last_prune<sp/>==<sp/>lock_height)<sp/>{</highlight></codeline>
<codeline lineno="2774"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>limiting_lock<sp/>=<sp/>prune_lock.first;</highlight></codeline>
<codeline lineno="2775"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2776"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2777"><highlight class="normal"></highlight></codeline>
<codeline lineno="2778"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(limiting_lock)<sp/>{</highlight></codeline>
<codeline lineno="2779"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395ae0c537e2982c70834d3646569e3b3453" kindref="member">BCLog::PRUNE</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s<sp/>limited<sp/>pruning<sp/>to<sp/>height<sp/>%d\n&quot;</highlight><highlight class="normal">,<sp/>limiting_lock.value(),<sp/>last_prune);</highlight></codeline>
<codeline lineno="2780"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2781"><highlight class="normal"></highlight></codeline>
<codeline lineno="2782"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nManualPruneHeight<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2783"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="timer_8h_1a2815cc5ded8c23c6638f587a2e3f6277" kindref="member">LOG_TIME_MILLIS_WITH_CATEGORY</ref>(</highlight><highlight class="stringliteral">&quot;find<sp/>files<sp/>to<sp/>prune<sp/>(manual)&quot;</highlight><highlight class="normal">,<sp/><ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>);</highlight></codeline>
<codeline lineno="2784"><highlight class="normal"></highlight></codeline>
<codeline lineno="2785"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.FindFilesToPruneManual(</highlight></codeline>
<codeline lineno="2786"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>setFilesToPrune,</highlight></codeline>
<codeline lineno="2787"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::min(last_prune,<sp/>nManualPruneHeight),</highlight></codeline>
<codeline lineno="2788"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*</highlight><highlight class="keyword">this</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2789"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2790"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="timer_8h_1a2815cc5ded8c23c6638f587a2e3f6277" kindref="member">LOG_TIME_MILLIS_WITH_CATEGORY</ref>(</highlight><highlight class="stringliteral">&quot;find<sp/>files<sp/>to<sp/>prune&quot;</highlight><highlight class="normal">,<sp/><ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>);</highlight></codeline>
<codeline lineno="2791"><highlight class="normal"></highlight></codeline>
<codeline lineno="2792"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.FindFilesToPrune(setFilesToPrune,<sp/>last_prune,<sp/>*</highlight><highlight class="keyword">this</highlight><highlight class="normal">,<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>);</highlight></codeline>
<codeline lineno="2793"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_check_for_pruning<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2794"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2795"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!setFilesToPrune.empty())<sp/>{</highlight></codeline>
<codeline lineno="2796"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fFlushForPrune<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2797"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_have_pruned)<sp/>{</highlight></codeline>
<codeline lineno="2798"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_block_tree_db-&gt;WriteFlag(</highlight><highlight class="stringliteral">&quot;prunedblockfiles&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2799"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_have_pruned<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2800"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2801"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2802"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2803"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>nNow{<ref refid="struct_node_clock_1a1be2fa9903731211253f2e36b5f3b584" kindref="member">NodeClock::now</ref>()};</highlight></codeline>
<codeline lineno="2804"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>cache<sp/>is<sp/>large<sp/>and<sp/>we&apos;re<sp/>within<sp/>10%<sp/>and<sp/>10<sp/>MiB<sp/>of<sp/>the<sp/>limit,<sp/>but<sp/>we<sp/>have<sp/>time<sp/>now<sp/>(not<sp/>in<sp/>the<sp/>middle<sp/>of<sp/>a<sp/>block<sp/>processing).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2805"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fCacheLarge<sp/>=<sp/>mode<sp/>==<sp/><ref refid="validation_8h_1ab30a99e75e9dc44356d1ad6bdd184ae0ad9d83fc826ae0d42075af007a477e2c9" kindref="member">FlushStateMode::PERIODIC</ref><sp/>&amp;&amp;<sp/>cache_state<sp/>&gt;=<sp/><ref refid="validation_8h_1ab8482b5889c2dd7bcef2c3a0523d3defa71726adf0ff60cd03eaf3c515883eeb8" kindref="member">CoinsCacheSizeState::LARGE</ref>;</highlight></codeline>
<codeline lineno="2806"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>cache<sp/>is<sp/>over<sp/>the<sp/>limit,<sp/>we<sp/>have<sp/>to<sp/>write<sp/>now.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2807"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fCacheCritical<sp/>=<sp/>mode<sp/>==<sp/><ref refid="validation_8h_1ab30a99e75e9dc44356d1ad6bdd184ae0a2382c561ef224fb0ab277eca39c90654" kindref="member">FlushStateMode::IF_NEEDED</ref><sp/>&amp;&amp;<sp/>cache_state<sp/>&gt;=<sp/><ref refid="validation_8h_1ab8482b5889c2dd7bcef2c3a0523d3defa99cd1c61610c76a57cb8d10d6df6b870" kindref="member">CoinsCacheSizeState::CRITICAL</ref>;</highlight></codeline>
<codeline lineno="2808"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>It&apos;s<sp/>been<sp/>a<sp/>while<sp/>since<sp/>we<sp/>wrote<sp/>the<sp/>block<sp/>index<sp/>and<sp/>chain<sp/>state<sp/>to<sp/>disk.<sp/>Do<sp/>this<sp/>frequently,<sp/>so<sp/>we<sp/>don&apos;t<sp/>need<sp/>to<sp/>redownload<sp/>or<sp/>reindex<sp/>after<sp/>a<sp/>crash.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2809"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fPeriodicWrite<sp/>=<sp/>mode<sp/>==<sp/><ref refid="validation_8h_1ab30a99e75e9dc44356d1ad6bdd184ae0ad9d83fc826ae0d42075af007a477e2c9" kindref="member">FlushStateMode::PERIODIC</ref><sp/>&amp;&amp;<sp/>nNow<sp/>&gt;=<sp/><ref refid="class_chainstate_1abb0a9547287e409bbd307dd312b87651" kindref="member">m_next_write</ref>;</highlight></codeline>
<codeline lineno="2810"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Combine<sp/>all<sp/>conditions<sp/>that<sp/>result<sp/>in<sp/>a<sp/>write<sp/>to<sp/>disk.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2811"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>should_write<sp/>=<sp/>(mode<sp/>==<sp/><ref refid="validation_8h_1ab30a99e75e9dc44356d1ad6bdd184ae0af3fc827ade4b968e50406496907ef962" kindref="member">FlushStateMode::ALWAYS</ref>)<sp/>||<sp/>fCacheLarge<sp/>||<sp/>fCacheCritical<sp/>||<sp/>fPeriodicWrite<sp/>||<sp/>fFlushForPrune;</highlight></codeline>
<codeline lineno="2812"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Write<sp/>blocks,<sp/>block<sp/>index<sp/>and<sp/>best<sp/>chain<sp/>related<sp/>state<sp/>to<sp/>disk.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2813"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(should_write)<sp/>{</highlight></codeline>
<codeline lineno="2814"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a278f52bd5b9e7d640210ad2e8326c2f7" kindref="member">BCLog::COINDB</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Writing<sp/>chainstate<sp/>to<sp/>disk:<sp/>flush<sp/>mode=%s,<sp/>prune=%d,<sp/>large=%d,<sp/>critical=%d,<sp/>periodic=%d&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2815"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8h_1a6d7628b24cf7e6a13bcdafa178560e58" kindref="member">FlushStateModeNames</ref>[</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal">(mode)],<sp/>fFlushForPrune,<sp/>fCacheLarge,<sp/>fCacheCritical,<sp/>fPeriodicWrite);</highlight></codeline>
<codeline lineno="2816"><highlight class="normal"></highlight></codeline>
<codeline lineno="2817"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ensure<sp/>we<sp/>can<sp/>write<sp/>block<sp/>index</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2818"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="fs__helpers_8cpp_1aafef764388e19a399584b65ef3d97b99" kindref="member">CheckDiskSpace</ref>(<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_opts.blocks_dir))<sp/>{</highlight></codeline>
<codeline lineno="2819"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a5a516dcd32726994512c2dfe67439ba2" kindref="member">FatalError</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetNotifications(),<sp/>state,<sp/><ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight><highlight class="stringliteral">&quot;Disk<sp/>space<sp/>is<sp/>too<sp/>low!&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="2820"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2821"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2822"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="timer_8h_1a2815cc5ded8c23c6638f587a2e3f6277" kindref="member">LOG_TIME_MILLIS_WITH_CATEGORY</ref>(</highlight><highlight class="stringliteral">&quot;write<sp/>block<sp/>and<sp/>undo<sp/>data<sp/>to<sp/>disk&quot;</highlight><highlight class="normal">,<sp/><ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>);</highlight></codeline>
<codeline lineno="2823"><highlight class="normal"></highlight></codeline>
<codeline lineno="2824"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>First<sp/>make<sp/>sure<sp/>all<sp/>block<sp/>and<sp/>undo<sp/>data<sp/>is<sp/>flushed<sp/>to<sp/>disk.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2825"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>TODO:<sp/>Handle<sp/>return<sp/>error,<sp/>or<sp/>add<sp/>detailed<sp/>comment<sp/>why<sp/>it<sp/>is</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2826"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>safe<sp/>to<sp/>not<sp/>return<sp/>an<sp/>error<sp/>upon<sp/>failure.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2827"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.FlushChainstateBlockFile(<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Height()))<sp/>{</highlight></codeline>
<codeline lineno="2828"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;%s:<sp/>Failed<sp/>to<sp/>flush<sp/>block<sp/>file.\n&quot;</highlight><highlight class="normal">,<sp/>__func__);</highlight></codeline>
<codeline lineno="2829"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2830"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2831"><highlight class="normal"></highlight></codeline>
<codeline lineno="2832"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Then<sp/>update<sp/>all<sp/>block<sp/>file<sp/>information<sp/>(which<sp/>may<sp/>refer<sp/>to<sp/>block<sp/>and<sp/>undo<sp/>files).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2833"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2834"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="timer_8h_1a2815cc5ded8c23c6638f587a2e3f6277" kindref="member">LOG_TIME_MILLIS_WITH_CATEGORY</ref>(</highlight><highlight class="stringliteral">&quot;write<sp/>block<sp/>index<sp/>to<sp/>disk&quot;</highlight><highlight class="normal">,<sp/><ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>);</highlight></codeline>
<codeline lineno="2835"><highlight class="normal"></highlight></codeline>
<codeline lineno="2836"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.WriteBlockIndexDB();</highlight></codeline>
<codeline lineno="2837"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2838"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Finally<sp/>remove<sp/>any<sp/>pruned<sp/>files</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2839"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fFlushForPrune)<sp/>{</highlight></codeline>
<codeline lineno="2840"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="timer_8h_1a2815cc5ded8c23c6638f587a2e3f6277" kindref="member">LOG_TIME_MILLIS_WITH_CATEGORY</ref>(</highlight><highlight class="stringliteral">&quot;unlink<sp/>pruned<sp/>files&quot;</highlight><highlight class="normal">,<sp/><ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>);</highlight></codeline>
<codeline lineno="2841"><highlight class="normal"></highlight></codeline>
<codeline lineno="2842"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.UnlinkPrunedFiles(setFilesToPrune);</highlight></codeline>
<codeline lineno="2843"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2844"><highlight class="normal"></highlight></codeline>
<codeline lineno="2845"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>().GetBestBlock().IsNull())<sp/>{</highlight></codeline>
<codeline lineno="2846"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(coins_mem_usage<sp/>&gt;=<sp/>WARN_FLUSH_COINS_SIZE)<sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;Flushing<sp/>large<sp/>(%d<sp/>GiB)<sp/>UTXO<sp/>set<sp/>to<sp/>disk,<sp/>it<sp/>may<sp/>take<sp/>several<sp/>minutes&quot;</highlight><highlight class="normal">,<sp/>coins_mem_usage<sp/>&gt;&gt;<sp/>30);</highlight></codeline>
<codeline lineno="2847"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="timer_8h_1a2815cc5ded8c23c6638f587a2e3f6277" kindref="member">LOG_TIME_MILLIS_WITH_CATEGORY</ref>(<ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;write<sp/>coins<sp/>cache<sp/>to<sp/>disk<sp/>(%d<sp/>coins,<sp/>%.2fKiB)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2848"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_count,<sp/>coins_mem_usage<sp/>&gt;&gt;<sp/>10),<sp/><ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>);</highlight></codeline>
<codeline lineno="2849"><highlight class="normal"></highlight></codeline>
<codeline lineno="2850"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Typical<sp/>Coin<sp/>structures<sp/>on<sp/>disk<sp/>are<sp/>around<sp/>48<sp/>bytes<sp/>in<sp/>size.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2851"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Pushing<sp/>a<sp/>new<sp/>one<sp/>to<sp/>the<sp/>database<sp/>can<sp/>cause<sp/>it<sp/>to<sp/>be<sp/>written</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2852"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>twice<sp/>(once<sp/>in<sp/>the<sp/>log,<sp/>and<sp/>once<sp/>in<sp/>the<sp/>tables).<sp/>This<sp/>is<sp/>already</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2853"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>an<sp/>overestimation,<sp/>as<sp/>most<sp/>will<sp/>delete<sp/>an<sp/>existing<sp/>entry<sp/>or</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2854"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>overwrite<sp/>one.<sp/>Still,<sp/>use<sp/>a<sp/>conservative<sp/>safety<sp/>factor<sp/>of<sp/>2.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2855"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="fs__helpers_8cpp_1aafef764388e19a399584b65ef3d97b99" kindref="member">CheckDiskSpace</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.datadir,<sp/>48<sp/>*<sp/>2<sp/>*<sp/>2<sp/>*<sp/><ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>().GetCacheSize()))<sp/>{</highlight></codeline>
<codeline lineno="2856"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a5a516dcd32726994512c2dfe67439ba2" kindref="member">FatalError</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetNotifications(),<sp/>state,<sp/><ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight><highlight class="stringliteral">&quot;Disk<sp/>space<sp/>is<sp/>too<sp/>low!&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="2857"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2858"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Flush<sp/>the<sp/>chainstate<sp/>(which<sp/>may<sp/>refer<sp/>to<sp/>block<sp/>index<sp/>entries).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2859"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>empty_cache{(mode<sp/>==<sp/><ref refid="validation_8h_1ab30a99e75e9dc44356d1ad6bdd184ae0af3fc827ade4b968e50406496907ef962" kindref="member">FlushStateMode::ALWAYS</ref>)<sp/>||<sp/>fCacheLarge<sp/>||<sp/>fCacheCritical};</highlight></codeline>
<codeline lineno="2860"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(empty_cache<sp/>?<sp/>!<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>().Flush()<sp/>:<sp/>!<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>().Sync())<sp/>{</highlight></codeline>
<codeline lineno="2861"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a5a516dcd32726994512c2dfe67439ba2" kindref="member">FatalError</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetNotifications(),<sp/>state,<sp/><ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>write<sp/>to<sp/>coin<sp/>database.&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="2862"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2863"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>full_flush_completed<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2864"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="trace_8h_1ae7d4767c75c045d7e4d4b840fb4a8e5f" kindref="member">TRACEPOINT</ref>(utxocache,<sp/>flush,</highlight></codeline>
<codeline lineno="2865"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int64_t{<ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;std::chrono::microseconds&gt;</ref>(<ref refid="struct_node_clock_1a1be2fa9903731211253f2e36b5f3b584" kindref="member">NodeClock::now</ref>()<sp/>-<sp/>nNow)},</highlight></codeline>
<codeline lineno="2866"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(uint32_t)mode,</highlight></codeline>
<codeline lineno="2867"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(uint64_t)coins_count,</highlight></codeline>
<codeline lineno="2868"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(uint64_t)coins_mem_usage,</highlight></codeline>
<codeline lineno="2869"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(bool)fFlushForPrune);</highlight></codeline>
<codeline lineno="2870"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2871"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2872"><highlight class="normal"></highlight></codeline>
<codeline lineno="2873"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(should_write<sp/>||<sp/><ref refid="class_chainstate_1abb0a9547287e409bbd307dd312b87651" kindref="member">m_next_write</ref><sp/>==<sp/>NodeClock::time_point::max())<sp/>{</highlight></codeline>
<codeline lineno="2874"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>range{DATABASE_WRITE_INTERVAL_MAX<sp/>-<sp/>DATABASE_WRITE_INTERVAL_MIN};</highlight></codeline>
<codeline lineno="2875"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1abb0a9547287e409bbd307dd312b87651" kindref="member">m_next_write</ref><sp/>=<sp/>FastRandomContext().rand_uniform_delay(<ref refid="struct_node_clock_1a1be2fa9903731211253f2e36b5f3b584" kindref="member">NodeClock::now</ref>()<sp/>+<sp/>DATABASE_WRITE_INTERVAL_MIN,<sp/>range);</highlight></codeline>
<codeline lineno="2876"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2877"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2878"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(full_flush_completed<sp/>&amp;&amp;<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.signals)<sp/>{</highlight></codeline>
<codeline lineno="2879"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Update<sp/>best<sp/>block<sp/>in<sp/>wallet<sp/>(so<sp/>we<sp/>can<sp/>detect<sp/>restored<sp/>wallets).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2880"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.signals-&gt;ChainStateFlushed(this-&gt;GetRole(),<sp/><ref refid="chain_8cpp_1a6f7cb8de33a43e97b3dd7517998379bc" kindref="member">GetLocator</ref>(<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip()));</highlight></codeline>
<codeline lineno="2881"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2882"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::runtime_error&amp;<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="2883"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a5a516dcd32726994512c2dfe67439ba2" kindref="member">FatalError</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetNotifications(),<sp/>state,<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(<ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight><highlight class="stringliteral">&quot;System<sp/>error<sp/>while<sp/>flushing:<sp/>%s&quot;</highlight><highlight class="normal">),<sp/>e.what()));</highlight></codeline>
<codeline lineno="2884"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2885"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2886"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2887"><highlight class="normal"></highlight></codeline>
<codeline lineno="2888"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1a7c77d9ae490826de80fea16e44c5e97f" kindref="member">Chainstate::ForceFlushStateToDisk</ref>()</highlight></codeline>
<codeline lineno="2889"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2890"><highlight class="normal"><sp/><sp/><sp/><sp/>BlockValidationState<sp/>state;</highlight></codeline>
<codeline lineno="2891"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!this-&gt;<ref refid="class_chainstate_1a0f9f0cdb703638cb9818a9b41158ac6a" kindref="member">FlushStateToDisk</ref>(state,<sp/><ref refid="validation_8h_1ab30a99e75e9dc44356d1ad6bdd184ae0af3fc827ade4b968e50406496907ef962" kindref="member">FlushStateMode::ALWAYS</ref>))<sp/>{</highlight></codeline>
<codeline lineno="2892"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>force<sp/>flush<sp/>state<sp/>(%s)&quot;</highlight><highlight class="normal">,<sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="2893"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2894"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2895"><highlight class="normal"></highlight></codeline>
<codeline lineno="2896"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1afccc404d3f648d7834ee7522ca348b41" kindref="member">Chainstate::PruneAndFlush</ref>()</highlight></codeline>
<codeline lineno="2897"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2898"><highlight class="normal"><sp/><sp/><sp/><sp/>BlockValidationState<sp/>state;</highlight></codeline>
<codeline lineno="2899"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_check_for_pruning<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2900"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!this-&gt;<ref refid="class_chainstate_1a0f9f0cdb703638cb9818a9b41158ac6a" kindref="member">FlushStateToDisk</ref>(state,<sp/><ref refid="validation_8h_1ab30a99e75e9dc44356d1ad6bdd184ae0ab50339a10e1de285ac99d4c3990b8693" kindref="member">FlushStateMode::NONE</ref>))<sp/>{</highlight></codeline>
<codeline lineno="2901"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>flush<sp/>state<sp/>(%s)&quot;</highlight><highlight class="normal">,<sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="2902"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2903"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2904"><highlight class="normal"></highlight></codeline>
<codeline lineno="2905"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>UpdateTipLog(</highlight></codeline>
<codeline lineno="2906"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager" kindref="compound">ChainstateManager</ref>&amp;<sp/>chainman,</highlight></codeline>
<codeline lineno="2907"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref>&amp;<sp/>coins_tip,</highlight></codeline>
<codeline lineno="2908"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>tip,</highlight></codeline>
<codeline lineno="2909"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::string&amp;<sp/>func_name,</highlight></codeline>
<codeline lineno="2910"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::string&amp;<sp/><ref refid="rest_8cpp_1a5b41c5ae4505891e6c53e26df197e02b" kindref="member">prefix</ref>,</highlight></codeline>
<codeline lineno="2911"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::string&amp;<sp/>warning_messages)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>)</highlight></codeline>
<codeline lineno="2912"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2913"><highlight class="normal"></highlight></codeline>
<codeline lineno="2914"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="2915"><highlight class="normal"></highlight></codeline>
<codeline lineno="2916"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Disable<sp/>rate<sp/>limiting<sp/>in<sp/>LogPrintLevel_<sp/>so<sp/>this<sp/>source<sp/>location<sp/>may<sp/>log<sp/>during<sp/>IBD.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2917"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a29339c6ed20edeb5fdde1f0a5c2c076b" kindref="member">LogPrintLevel_</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395ab1d5eac4b1dca480c8056eaea7663b7a" kindref="member">BCLog::LogFlags::ALL</ref>,<sp/><ref refid="namespace_b_c_log_1a221b779e6bb7b8d40677d7642bfefac5a4059b0251f66a18cb56f544728796875" kindref="member">BCLog::Level::Info</ref>,<sp/></highlight><highlight class="comment">/*should_ratelimit=*/</highlight><highlight class="keyword">false</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;%s%s:<sp/>new<sp/>best=%s<sp/>height=%d<sp/>version=0x%08x<sp/>log2_work=%f<sp/>tx=%lu<sp/>date=&apos;%s&apos;<sp/>progress=%f<sp/>cache=%.1fMiB(%utxo)%s\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2918"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="rest_8cpp_1a5b41c5ae4505891e6c53e26df197e02b" kindref="member">prefix</ref>,<sp/>func_name,</highlight></codeline>
<codeline lineno="2919"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tip-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>tip-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>tip-&gt;<ref refid="class_c_block_index_1ac783e91ed47adc28b2a27ffea4b7f484" kindref="member">nVersion</ref>,</highlight></codeline>
<codeline lineno="2920"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>log(tip-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref>.<ref refid="classbase__uint_1a1418943fdda813b9f539d49d9da68241" kindref="member">getdouble</ref>())<sp/>/<sp/>log(2.0),<sp/>tip-&gt;<ref refid="class_c_block_index_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref>,</highlight></codeline>
<codeline lineno="2921"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8cpp_1ae5186b218f085a0a48b08bcdb0fffed1" kindref="member">FormatISO8601DateTime</ref>(tip-&gt;<ref refid="class_c_block_index_1a7aea61ae131a8b7b934f8b3a758d9490" kindref="member">GetBlockTime</ref>()),</highlight></codeline>
<codeline lineno="2922"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>chainman.<ref refid="class_chainstate_manager_1ab95b248ecacf42357d9d4ea19e696ff7" kindref="member">GuessVerificationProgress</ref>(tip),</highlight></codeline>
<codeline lineno="2923"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_tip.DynamicMemoryUsage()<sp/>*<sp/>(1.0<sp/>/<sp/>(1<sp/>&lt;&lt;<sp/>20)),</highlight></codeline>
<codeline lineno="2924"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_tip.GetCacheSize(),</highlight></codeline>
<codeline lineno="2925"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!warning_messages.empty()<sp/>?<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;<sp/>warning=&apos;%s&apos;&quot;</highlight><highlight class="normal">,<sp/>warning_messages)<sp/>:<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2926"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2927"><highlight class="normal"></highlight></codeline>
<codeline lineno="2928"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>Chainstate::UpdateTip(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>pindexNew)</highlight></codeline>
<codeline lineno="2929"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2930"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="2931"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>coins_tip<sp/>=<sp/>this-&gt;<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>();</highlight></codeline>
<codeline lineno="2932"><highlight class="normal"></highlight></codeline>
<codeline lineno="2933"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>remainder<sp/>of<sp/>the<sp/>function<sp/>isn&apos;t<sp/>relevant<sp/>if<sp/>we<sp/>are<sp/>not<sp/>acting<sp/>on</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2934"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>active<sp/>chainstate,<sp/>so<sp/>return<sp/>if<sp/>need<sp/>be.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2935"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">this</highlight><highlight class="normal"><sp/>!=<sp/>&amp;<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.ActiveChainstate())<sp/>{</highlight></codeline>
<codeline lineno="2936"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>log<sp/>every<sp/>so<sp/>often<sp/>so<sp/>that<sp/>we<sp/>don&apos;t<sp/>bury<sp/>log<sp/>messages<sp/>at<sp/>the<sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2937"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>BACKGROUND_LOG_INTERVAL<sp/>=<sp/>2000;</highlight></codeline>
<codeline lineno="2938"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexNew-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>%<sp/>BACKGROUND_LOG_INTERVAL<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2939"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>UpdateTipLog(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>,<sp/>coins_tip,<sp/>pindexNew,<sp/>__func__,<sp/></highlight><highlight class="stringliteral">&quot;[background<sp/>validation]<sp/>&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2940"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2941"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2942"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2943"><highlight class="normal"></highlight></codeline>
<codeline lineno="2944"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>New<sp/>best<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2945"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2946"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>-&gt;AddTransactionsUpdated(1);</highlight></codeline>
<codeline lineno="2947"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2948"><highlight class="normal"></highlight></codeline>
<codeline lineno="2949"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;bilingual_str&gt;<sp/>warning_messages;</highlight></codeline>
<codeline lineno="2950"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.IsInitialBlockDownload())<sp/>{</highlight></codeline>
<codeline lineno="2951"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>bits<sp/>=<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_versionbitscache.CheckUnknownActivations(pindexNew,<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetParams());</highlight></codeline>
<codeline lineno="2952"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>[bit,<sp/>active]<sp/>:<sp/>bits)<sp/>{</highlight></codeline>
<codeline lineno="2953"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>bilingual_str<sp/>warning<sp/>=<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(<ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight><highlight class="stringliteral">&quot;Unknown<sp/>new<sp/>rules<sp/>activated<sp/>(versionbit<sp/>%i)&quot;</highlight><highlight class="normal">),<sp/>bit);</highlight></codeline>
<codeline lineno="2954"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(active)<sp/>{</highlight></codeline>
<codeline lineno="2955"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetNotifications().warningSet(<ref refid="namespacekernel_1af6ea07812363481c623a23ea26fbf8eda2a4ba0672b8751622fa177d738c33407" kindref="member">kernel::Warning::UNKNOWN_NEW_RULES_ACTIVATED</ref>,<sp/>warning);</highlight></codeline>
<codeline lineno="2956"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2957"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>warning_messages.push_back(warning);</highlight></codeline>
<codeline lineno="2958"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2959"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2960"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2961"><highlight class="normal"><sp/><sp/><sp/><sp/>UpdateTipLog(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>,<sp/>coins_tip,<sp/>pindexNew,<sp/>__func__,<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2962"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespaceutil_1aff2a33f4c8a8ebd77cf6e0630bd1dbe3" kindref="member">util::Join</ref>(warning_messages,<sp/><ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(</highlight><highlight class="stringliteral">&quot;,<sp/>&quot;</highlight><highlight class="normal">)).original);</highlight></codeline>
<codeline lineno="2963"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2964"><highlight class="normal"></highlight></codeline>
<codeline lineno="2975"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1a5286c896c77d30226698c47b3f2dfc33" kindref="member">Chainstate::DisconnectTip</ref>(<ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref>&amp;<sp/>state,<sp/><ref refid="class_disconnected_block_transactions" kindref="compound">DisconnectedBlockTransactions</ref>*<sp/>disconnectpool)</highlight></codeline>
<codeline lineno="2976"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2977"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="2978"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>)<sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>-&gt;cs);</highlight></codeline>
<codeline lineno="2979"><highlight class="normal"></highlight></codeline>
<codeline lineno="2980"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockIndex<sp/>*pindexDelete<sp/>=<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip();</highlight></codeline>
<codeline lineno="2981"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindexDelete);</highlight></codeline>
<codeline lineno="2982"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindexDelete-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>);</highlight></codeline>
<codeline lineno="2983"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Read<sp/>block<sp/>from<sp/>disk.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2984"><highlight class="normal"><sp/><sp/><sp/><sp/>std::shared_ptr&lt;CBlock&gt;<sp/>pblock<sp/>=<sp/>std::make_shared&lt;CBlock&gt;();</highlight></codeline>
<codeline lineno="2985"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlock&amp;<sp/>block<sp/>=<sp/>*pblock;</highlight></codeline>
<codeline lineno="2986"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.ReadBlock(block,<sp/>*pindexDelete))<sp/>{</highlight></codeline>
<codeline lineno="2987"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;DisconnectTip():<sp/>Failed<sp/>to<sp/>read<sp/>block\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2988"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2989"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2990"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Apply<sp/>the<sp/>block<sp/>atomically<sp/>to<sp/>the<sp/>chain<sp/>state.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2991"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>time_start{SteadyClock::now()};</highlight></codeline>
<codeline lineno="2992"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2993"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CCoinsViewCache<sp/>view(&amp;<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>());</highlight></codeline>
<codeline lineno="2994"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(view.<ref refid="class_c_coins_view_cache_1a357197e89d0c22e33f9e58b3dac685ff" kindref="member">GetBestBlock</ref>()<sp/>==<sp/>pindexDelete-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>());</highlight></codeline>
<codeline lineno="2995"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(DisconnectBlock(block,<sp/>pindexDelete,<sp/>view)<sp/>!=<sp/><ref refid="validation_8h_1aeaef80b01ee5387f474a63ed23c9cc50af732a362dae37684d825e000781628c4" kindref="member">DISCONNECT_OK</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2996"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;DisconnectTip():<sp/>DisconnectBlock<sp/>%s<sp/>failed\n&quot;</highlight><highlight class="normal">,<sp/>pindexDelete-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="2997"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2998"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2999"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>flushed<sp/>=<sp/>view.<ref refid="class_c_coins_view_cache_1a166e3b1951caaaf582e7b67c5be762ce" kindref="member">Flush</ref>(</highlight><highlight class="comment">/*will_reuse_cache=*/</highlight><highlight class="keyword">false</highlight><highlight class="normal">);<sp/></highlight><highlight class="comment">//<sp/>local<sp/>CCoinsViewCache<sp/>goes<sp/>out<sp/>of<sp/>scope</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3000"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(flushed);</highlight></codeline>
<codeline lineno="3001"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3002"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>,<sp/></highlight><highlight class="stringliteral">&quot;-<sp/>Disconnect<sp/>block:<sp/>%.2fms\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3003"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(SteadyClock::now()<sp/>-<sp/>time_start));</highlight></codeline>
<codeline lineno="3004"><highlight class="normal"></highlight></codeline>
<codeline lineno="3005"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3006"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Prune<sp/>locks<sp/>that<sp/>began<sp/>at<sp/>or<sp/>after<sp/>the<sp/>tip<sp/>should<sp/>be<sp/>moved<sp/>backward<sp/>so<sp/>they<sp/>get<sp/>a<sp/>chance<sp/>to<sp/>reorg</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3007"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>max_height_first{pindexDelete-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>-<sp/>1};</highlight></codeline>
<codeline lineno="3008"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>prune_lock<sp/>:<sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_prune_locks)<sp/>{</highlight></codeline>
<codeline lineno="3009"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(prune_lock.second.height_first<sp/>&lt;=<sp/>max_height_first)<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3010"><highlight class="normal"></highlight></codeline>
<codeline lineno="3011"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prune_lock.second.height_first<sp/>=<sp/>max_height_first;</highlight></codeline>
<codeline lineno="3012"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395ae0c537e2982c70834d3646569e3b3453" kindref="member">BCLog::PRUNE</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s<sp/>prune<sp/>lock<sp/>moved<sp/>back<sp/>to<sp/>%d\n&quot;</highlight><highlight class="normal">,<sp/>prune_lock.first,<sp/>max_height_first);</highlight></codeline>
<codeline lineno="3013"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3014"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3015"><highlight class="normal"></highlight></codeline>
<codeline lineno="3016"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Write<sp/>the<sp/>chain<sp/>state<sp/>to<sp/>disk,<sp/>if<sp/>necessary.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3017"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1a0f9f0cdb703638cb9818a9b41158ac6a" kindref="member">FlushStateToDisk</ref>(state,<sp/><ref refid="validation_8h_1ab30a99e75e9dc44356d1ad6bdd184ae0a2382c561ef224fb0ab277eca39c90654" kindref="member">FlushStateMode::IF_NEEDED</ref>))<sp/>{</highlight></codeline>
<codeline lineno="3018"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3019"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3020"><highlight class="normal"></highlight></codeline>
<codeline lineno="3021"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(disconnectpool<sp/>&amp;&amp;<sp/><ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3022"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Save<sp/>transactions<sp/>to<sp/>re-add<sp/>to<sp/>mempool<sp/>at<sp/>end<sp/>of<sp/>reorg.<sp/>If<sp/>any<sp/>entries<sp/>are<sp/>evicted<sp/>for</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3023"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>exceeding<sp/>memory<sp/>limits,<sp/>remove<sp/>them<sp/>and<sp/>their<sp/>descendants<sp/>from<sp/>the<sp/>mempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3024"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;&amp;<sp/>evicted_tx<sp/>:<sp/>disconnectpool-&gt;<ref refid="class_disconnected_block_transactions_1a00c7a433e2c25308bca9255e5cf4b0eb" kindref="member">AddTransactionsFromBlock</ref>(block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>))<sp/>{</highlight></codeline>
<codeline lineno="3025"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>-&gt;removeRecursive(*evicted_tx,<sp/><ref refid="mempool__removal__reason_8h_1a2bc6653552b5871101b6cbefdbaf251fae8dd7fa48e6491a8929b38fa835dd1c6" kindref="member">MemPoolRemovalReason::REORG</ref>);</highlight></codeline>
<codeline lineno="3026"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3027"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3028"><highlight class="normal"></highlight></codeline>
<codeline lineno="3029"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.SetTip(*pindexDelete-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>);</highlight></codeline>
<codeline lineno="3030"><highlight class="normal"></highlight></codeline>
<codeline lineno="3031"><highlight class="normal"><sp/><sp/><sp/><sp/>UpdateTip(pindexDelete-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>);</highlight></codeline>
<codeline lineno="3032"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Let<sp/>wallets<sp/>know<sp/>transactions<sp/>went<sp/>from<sp/>1-confirmed<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3033"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>0-confirmed<sp/>or<sp/>conflicted:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3034"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.signals)<sp/>{</highlight></codeline>
<codeline lineno="3035"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.signals-&gt;BlockDisconnected(pblock,<sp/>pindexDelete);</highlight></codeline>
<codeline lineno="3036"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3037"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3038"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3039"><highlight class="normal"></highlight></codeline>
<codeline lineno="3040" refid="struct_per_block_connect_trace" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="struct_per_block_connect_trace_1a9472dc81efe9e19acd60408aefd2e1aa" kindref="member">PerBlockConnectTrace</ref><sp/>{</highlight></codeline>
<codeline lineno="3041"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/><ref refid="struct_per_block_connect_trace_1afc619311480e52d0fc8dddc8c352340b" kindref="member">pindex</ref><sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3042"><highlight class="normal"><sp/><sp/><sp/><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;<sp/><ref refid="struct_per_block_connect_trace_1a77b971a01beb96564bb4dc049165b180" kindref="member">pblock</ref>;</highlight></codeline>
<codeline lineno="3043"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_per_block_connect_trace_1a9472dc81efe9e19acd60408aefd2e1aa" kindref="member">PerBlockConnectTrace</ref>()<sp/>=<sp/></highlight><highlight class="keywordflow">default</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3044"><highlight class="normal">};</highlight></codeline>
<codeline lineno="3052" refid="class_connect_trace" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="class_connect_trace_1a8028604c4cc727764caa93de3a2d209e" kindref="member">ConnectTrace</ref><sp/>{</highlight></codeline>
<codeline lineno="3053"><highlight class="normal"></highlight><highlight class="keyword">private</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="3054"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;PerBlockConnectTrace&gt;<sp/>blocksConnected;</highlight></codeline>
<codeline lineno="3055"><highlight class="normal"></highlight></codeline>
<codeline lineno="3056"><highlight class="normal"></highlight><highlight class="keyword">public</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="3057"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">explicit</highlight><highlight class="normal"><sp/><ref refid="class_connect_trace_1a8028604c4cc727764caa93de3a2d209e" kindref="member">ConnectTrace</ref>()<sp/>:<sp/>blocksConnected(1)<sp/>{}</highlight></codeline>
<codeline lineno="3058"><highlight class="normal"></highlight></codeline>
<codeline lineno="3059"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_connect_trace_1ab5630889e78ca5235a9575884a726efb" kindref="member">BlockConnected</ref>(<ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>pindex,<sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;<sp/>pblock)<sp/>{</highlight></codeline>
<codeline lineno="3060"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!blocksConnected.back().pindex);</highlight></codeline>
<codeline lineno="3061"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindex);</highlight></codeline>
<codeline lineno="3062"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pblock);</highlight></codeline>
<codeline lineno="3063"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocksConnected.back().pindex<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="3064"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocksConnected.back().pblock<sp/>=<sp/>std::move(pblock);</highlight></codeline>
<codeline lineno="3065"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocksConnected.emplace_back();</highlight></codeline>
<codeline lineno="3066"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3067"><highlight class="normal"></highlight></codeline>
<codeline lineno="3068"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;PerBlockConnectTrace&gt;&amp;<sp/><ref refid="class_connect_trace_1a2a34e5eddac4461fdb0357a743c1f8e9" kindref="member">GetBlocksConnected</ref>()<sp/>{</highlight></codeline>
<codeline lineno="3069"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>always<sp/>keep<sp/>one<sp/>extra<sp/>block<sp/>at<sp/>the<sp/>end<sp/>of<sp/>our<sp/>list<sp/>because</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3070"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>blocks<sp/>are<sp/>added<sp/>after<sp/>all<sp/>the<sp/>conflicted<sp/>transactions<sp/>have</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3071"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>been<sp/>filled<sp/>in.<sp/>Thus,<sp/>the<sp/>last<sp/>entry<sp/>should<sp/>always<sp/>be<sp/>an<sp/>empty</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3072"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>one<sp/>waiting<sp/>for<sp/>the<sp/>transactions<sp/>from<sp/>the<sp/>next<sp/>block.<sp/>We<sp/>pop</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3073"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>last<sp/>entry<sp/>here<sp/>to<sp/>make<sp/>sure<sp/>the<sp/>list<sp/>we<sp/>return<sp/>is<sp/>sane.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3074"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!blocksConnected.back().pindex);</highlight></codeline>
<codeline lineno="3075"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocksConnected.pop_back();</highlight></codeline>
<codeline lineno="3076"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>blocksConnected;</highlight></codeline>
<codeline lineno="3077"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3078"><highlight class="normal">};</highlight></codeline>
<codeline lineno="3079"><highlight class="normal"></highlight></codeline>
<codeline lineno="3086"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1a5d8f3346d9afde7670582ba7270f65c0" kindref="member">Chainstate::ConnectTip</ref>(</highlight></codeline>
<codeline lineno="3087"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref>&amp;<sp/>state,</highlight></codeline>
<codeline lineno="3088"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>pindexNew,</highlight></codeline>
<codeline lineno="3089"><highlight class="normal"><sp/><sp/><sp/><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;<sp/>block_to_connect,</highlight></codeline>
<codeline lineno="3090"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_connect_trace" kindref="compound">ConnectTrace</ref>&amp;<sp/>connectTrace,</highlight></codeline>
<codeline lineno="3091"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_disconnected_block_transactions" kindref="compound">DisconnectedBlockTransactions</ref>&amp;<sp/>disconnectpool)</highlight></codeline>
<codeline lineno="3092"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3093"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="3094"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>)<sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>-&gt;<ref refid="class_c_tx_mem_pool_1ab322659c2acf98d3bb6e877e69414281" kindref="member">cs</ref>);</highlight></codeline>
<codeline lineno="3095"><highlight class="normal"></highlight></codeline>
<codeline lineno="3096"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindexNew-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>==<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>());</highlight></codeline>
<codeline lineno="3097"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Read<sp/>block<sp/>from<sp/>disk.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3098"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>time_1{SteadyClock::now()};</highlight></codeline>
<codeline lineno="3099"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!block_to_connect)<sp/>{</highlight></codeline>
<codeline lineno="3100"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::shared_ptr&lt;CBlock&gt;<sp/>pblockNew<sp/>=<sp/>std::make_shared&lt;CBlock&gt;();</highlight></codeline>
<codeline lineno="3101"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.ReadBlock(*pblockNew,<sp/>*pindexNew))<sp/>{</highlight></codeline>
<codeline lineno="3102"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a5a516dcd32726994512c2dfe67439ba2" kindref="member">FatalError</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetNotifications(),<sp/>state,<sp/><ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>read<sp/>block.&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="3103"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3104"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>block_to_connect<sp/>=<sp/>std::move(pblockNew);</highlight></codeline>
<codeline lineno="3105"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>,<sp/></highlight><highlight class="stringliteral">&quot;<sp/><sp/>-<sp/>Using<sp/>cached<sp/>block\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3107"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3108"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Apply<sp/>the<sp/>block<sp/>atomically<sp/>to<sp/>the<sp/>chain<sp/>state.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3109"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>time_2{SteadyClock::now()};</highlight></codeline>
<codeline lineno="3110"><highlight class="normal"><sp/><sp/><sp/><sp/>SteadyClock::time_point<sp/>time_3;</highlight></codeline>
<codeline lineno="3111"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When<sp/>adding<sp/>aggregate<sp/>statistics<sp/>in<sp/>the<sp/>future,<sp/>keep<sp/>in<sp/>mind<sp/>that</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3112"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>num_blocks_total<sp/>may<sp/>be<sp/>zero<sp/>until<sp/>the<sp/>ConnectBlock()<sp/>call<sp/>below.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3113"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>,<sp/></highlight><highlight class="stringliteral">&quot;<sp/><sp/>-<sp/>Load<sp/>block<sp/>from<sp/>disk:<sp/>%.2fms\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(time_2<sp/>-<sp/>time_1));</highlight></codeline>
<codeline lineno="3115"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CCoinsViewCache<sp/>view(&amp;<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>());</highlight></codeline>
<codeline lineno="3117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>rv<sp/>=<sp/><ref refid="class_chainstate_1a0487c7fe4cdc89e309556f86c2988c80" kindref="member">ConnectBlock</ref>(*block_to_connect,<sp/>state,<sp/>pindexNew,<sp/>view);</highlight></codeline>
<codeline lineno="3118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.signals)<sp/>{</highlight></codeline>
<codeline lineno="3119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.signals-&gt;BlockChecked(block_to_connect,<sp/>state);</highlight></codeline>
<codeline lineno="3120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!rv)<sp/>{</highlight></codeline>
<codeline lineno="3122"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.<ref refid="class_validation_state_1a6c1f27c9de7ff98356fa712e4b796a1a" kindref="member">IsInvalid</ref>())</highlight></codeline>
<codeline lineno="3123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a9c5078a4a04331cc35d986500a8b30b1" kindref="member">InvalidBlockFound</ref>(pindexNew,<sp/>state);</highlight></codeline>
<codeline lineno="3124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;%s:<sp/>ConnectBlock<sp/>%s<sp/>failed,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>pindexNew-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="3125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>time_3<sp/>=<sp/>SteadyClock::now();</highlight></codeline>
<codeline lineno="3128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_connect_total<sp/>+=<sp/>time_3<sp/>-<sp/>time_2;</highlight></codeline>
<codeline lineno="3129"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.num_blocks_total<sp/>&gt;<sp/>0);</highlight></codeline>
<codeline lineno="3130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>,<sp/></highlight><highlight class="stringliteral">&quot;<sp/><sp/>-<sp/>Connect<sp/>total:<sp/>%.2fms<sp/>[%.2fs<sp/>(%.2fms/blk)]\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(time_3<sp/>-<sp/>time_2),</highlight></codeline>
<codeline lineno="3132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;SecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_connect_total),</highlight></codeline>
<codeline lineno="3133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_connect_total)<sp/>/<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.num_blocks_total);</highlight></codeline>
<codeline lineno="3134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>flushed<sp/>=<sp/>view.<ref refid="class_c_coins_view_cache_1a166e3b1951caaaf582e7b67c5be762ce" kindref="member">Flush</ref>(</highlight><highlight class="comment">/*will_reuse_cache=*/</highlight><highlight class="keyword">false</highlight><highlight class="normal">);<sp/></highlight><highlight class="comment">//<sp/>local<sp/>CCoinsViewCache<sp/>goes<sp/>out<sp/>of<sp/>scope</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(flushed);</highlight></codeline>
<codeline lineno="3136"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3137"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>time_4{SteadyClock::now()};</highlight></codeline>
<codeline lineno="3138"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_flush<sp/>+=<sp/>time_4<sp/>-<sp/>time_3;</highlight></codeline>
<codeline lineno="3139"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>,<sp/></highlight><highlight class="stringliteral">&quot;<sp/><sp/>-<sp/>Flush:<sp/>%.2fms<sp/>[%.2fs<sp/>(%.2fms/blk)]\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3140"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(time_4<sp/>-<sp/>time_3),</highlight></codeline>
<codeline lineno="3141"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;SecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_flush),</highlight></codeline>
<codeline lineno="3142"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_flush)<sp/>/<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.num_blocks_total);</highlight></codeline>
<codeline lineno="3143"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Write<sp/>the<sp/>chain<sp/>state<sp/>to<sp/>disk,<sp/>if<sp/>necessary.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3144"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1a0f9f0cdb703638cb9818a9b41158ac6a" kindref="member">FlushStateToDisk</ref>(state,<sp/><ref refid="validation_8h_1ab30a99e75e9dc44356d1ad6bdd184ae0a2382c561ef224fb0ab277eca39c90654" kindref="member">FlushStateMode::IF_NEEDED</ref>))<sp/>{</highlight></codeline>
<codeline lineno="3145"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3146"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3147"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>time_5{SteadyClock::now()};</highlight></codeline>
<codeline lineno="3148"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_chainstate<sp/>+=<sp/>time_5<sp/>-<sp/>time_4;</highlight></codeline>
<codeline lineno="3149"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>,<sp/></highlight><highlight class="stringliteral">&quot;<sp/><sp/>-<sp/>Writing<sp/>chainstate:<sp/>%.2fms<sp/>[%.2fs<sp/>(%.2fms/blk)]\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3150"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(time_5<sp/>-<sp/>time_4),</highlight></codeline>
<codeline lineno="3151"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;SecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_chainstate),</highlight></codeline>
<codeline lineno="3152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_chainstate)<sp/>/<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.num_blocks_total);</highlight></codeline>
<codeline lineno="3153"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Remove<sp/>conflicting<sp/>transactions<sp/>from<sp/>the<sp/>mempool.;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3154"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3155"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>-&gt;removeForBlock(block_to_connect-&gt;vtx,<sp/>pindexNew-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>);</highlight></codeline>
<codeline lineno="3156"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>disconnectpool.<ref refid="class_disconnected_block_transactions_1a27f308ba123752de7162c1fb47613227" kindref="member">removeForBlock</ref>(block_to_connect-&gt;vtx);</highlight></codeline>
<codeline lineno="3157"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3158"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Update<sp/>m_chain<sp/>&amp;<sp/>related<sp/>variables.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3159"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.SetTip(*pindexNew);</highlight></codeline>
<codeline lineno="3160"><highlight class="normal"><sp/><sp/><sp/><sp/>UpdateTip(pindexNew);</highlight></codeline>
<codeline lineno="3161"><highlight class="normal"></highlight></codeline>
<codeline lineno="3162"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>time_6{SteadyClock::now()};</highlight></codeline>
<codeline lineno="3163"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_post_connect<sp/>+=<sp/>time_6<sp/>-<sp/>time_5;</highlight></codeline>
<codeline lineno="3164"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_total<sp/>+=<sp/>time_6<sp/>-<sp/>time_1;</highlight></codeline>
<codeline lineno="3165"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>,<sp/></highlight><highlight class="stringliteral">&quot;<sp/><sp/>-<sp/>Connect<sp/>postprocess:<sp/>%.2fms<sp/>[%.2fs<sp/>(%.2fms/blk)]\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(time_6<sp/>-<sp/>time_5),</highlight></codeline>
<codeline lineno="3167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;SecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_post_connect),</highlight></codeline>
<codeline lineno="3168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_post_connect)<sp/>/<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.num_blocks_total);</highlight></codeline>
<codeline lineno="3169"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a39a2e7946aef57ccda126d7441531f88" kindref="member">BCLog::BENCH</ref>,<sp/></highlight><highlight class="stringliteral">&quot;-<sp/>Connect<sp/>block:<sp/>%.2fms<sp/>[%.2fs<sp/>(%.2fms/blk)]\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(time_6<sp/>-<sp/>time_1),</highlight></codeline>
<codeline lineno="3171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;SecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_total),</highlight></codeline>
<codeline lineno="3172"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;MillisecondsDouble&gt;</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.time_total)<sp/>/<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.num_blocks_total);</highlight></codeline>
<codeline lineno="3173"><highlight class="normal"></highlight></codeline>
<codeline lineno="3174"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>See<sp/>if<sp/>this<sp/>chainstate<sp/>has<sp/>reached<sp/>a<sp/>target<sp/>block<sp/>and<sp/>can<sp/>be<sp/>used<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3175"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>validate<sp/>an<sp/>assumeutxo<sp/>snapshot.<sp/>If<sp/>it<sp/>can,<sp/>hashing<sp/>the<sp/>UTXO<sp/>database</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3176"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>will<sp/>be<sp/>slow,<sp/>and<sp/>cs_main<sp/>could<sp/>remain<sp/>locked<sp/>here<sp/>for<sp/>several<sp/>minutes.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3177"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>snapshot<sp/>is<sp/>validated,<sp/>the<sp/>UTXO<sp/>hash<sp/>will<sp/>be<sp/>saved<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3178"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>this-&gt;m_target_utxohash,<sp/>causing<sp/>HistoricalChainstate()<sp/>to<sp/>return<sp/>null</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3179"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>this<sp/>chainstate<sp/>to<sp/>no<sp/>longer<sp/>be<sp/>used.<sp/>ActivateBestChain()<sp/>will<sp/>also</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3180"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>stop<sp/>connecting<sp/>blocks<sp/>to<sp/>this<sp/>chainstate<sp/>because<sp/>this-&gt;ReachedTarget()</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3181"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>will<sp/>be<sp/>true<sp/>and<sp/>this-&gt;setBlockIndexCandidates<sp/>will<sp/>not<sp/>have<sp/>additional</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3182"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>blocks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3183"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a70b163a8bca70b51736e75cf3f6282f0" kindref="member">Chainstate</ref>&amp;<sp/>current_cs{<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.CurrentChainstate()};</highlight></codeline>
<codeline lineno="3184"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.MaybeValidateSnapshot(*</highlight><highlight class="keyword">this</highlight><highlight class="normal">,<sp/>current_cs);</highlight></codeline>
<codeline lineno="3185"><highlight class="normal"></highlight></codeline>
<codeline lineno="3186"><highlight class="normal"><sp/><sp/><sp/><sp/>connectTrace.<ref refid="class_connect_trace_1ab5630889e78ca5235a9575884a726efb" kindref="member">BlockConnected</ref>(pindexNew,<sp/>std::move(block_to_connect));</highlight></codeline>
<codeline lineno="3187"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3188"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3189"><highlight class="normal"></highlight></codeline>
<codeline lineno="3194"><highlight class="normal"><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/><ref refid="class_chainstate_1aa9ca3194eec690da7453dfb54549f554" kindref="member">Chainstate::FindMostWorkChain</ref>()</highlight></codeline>
<codeline lineno="3195"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3196"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="3197"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">do</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockIndex<sp/>*pindexNew<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3199"><highlight class="normal"></highlight></codeline>
<codeline lineno="3200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Find<sp/>the<sp/>best<sp/>candidate<sp/>header.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3201"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3202"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::set&lt;CBlockIndex*,<sp/>CBlockIndexWorkComparator&gt;::reverse_iterator<sp/>it<sp/>=<sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.rbegin();</highlight></codeline>
<codeline lineno="3203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>==<sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.rend())</highlight></codeline>
<codeline lineno="3204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexNew<sp/>=<sp/>*it;</highlight></codeline>
<codeline lineno="3206"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3207"><highlight class="normal"></highlight></codeline>
<codeline lineno="3208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>whether<sp/>all<sp/>blocks<sp/>on<sp/>the<sp/>path<sp/>between<sp/>the<sp/>currently<sp/>active<sp/>chain<sp/>and<sp/>the<sp/>candidate<sp/>are<sp/>valid.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Just<sp/>going<sp/>until<sp/>the<sp/>active<sp/>chain<sp/>is<sp/>an<sp/>optimization,<sp/>as<sp/>we<sp/>know<sp/>all<sp/>blocks<sp/>in<sp/>it<sp/>are<sp/>valid<sp/>already.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockIndex<sp/>*pindexTest<sp/>=<sp/>pindexNew;</highlight></codeline>
<codeline lineno="3211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fInvalidAncestor<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3212"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(pindexTest<sp/>&amp;&amp;<sp/>!<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Contains(pindexTest))<sp/>{</highlight></codeline>
<codeline lineno="3213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindexTest-&gt;<ref refid="class_c_block_index_1ae804dd1f9a78669920c2bc21dc7a9812" kindref="member">HaveNumChainTxs</ref>()<sp/>||<sp/>pindexTest-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>==<sp/>0);</highlight></codeline>
<codeline lineno="3214"><highlight class="normal"></highlight></codeline>
<codeline lineno="3215"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Pruned<sp/>nodes<sp/>may<sp/>have<sp/>entries<sp/>in<sp/>setBlockIndexCandidates<sp/>for</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>which<sp/>block<sp/>files<sp/>have<sp/>been<sp/>deleted.<sp/><sp/>Remove<sp/>those<sp/>as<sp/>candidates</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3217"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>for<sp/>the<sp/>most<sp/>work<sp/>chain<sp/>if<sp/>we<sp/>come<sp/>across<sp/>them;<sp/>we<sp/>can&apos;t<sp/>switch</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3218"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>a<sp/>chain<sp/>unless<sp/>we<sp/>have<sp/>all<sp/>the<sp/>non-active-chain<sp/>parent<sp/>blocks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3219"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fFailedChain<sp/>=<sp/>pindexTest-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada88df51e92f2f675baff60e0a5bd170ef" kindref="member">BLOCK_FAILED_MASK</ref>;</highlight></codeline>
<codeline lineno="3220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fMissingData<sp/>=<sp/>!(pindexTest-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15" kindref="member">BLOCK_HAVE_DATA</ref>);</highlight></codeline>
<codeline lineno="3221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fFailedChain<sp/>||<sp/>fMissingData)<sp/>{</highlight></codeline>
<codeline lineno="3222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Candidate<sp/>chain<sp/>is<sp/>not<sp/>usable<sp/>(either<sp/>invalid<sp/>or<sp/>missing<sp/>data)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fFailedChain<sp/>&amp;&amp;<sp/>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_invalid<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>||<sp/>pindexNew-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&gt;<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_invalid-&gt;nChainWork))<sp/>{</highlight></codeline>
<codeline lineno="3224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_invalid<sp/>=<sp/>pindexNew;</highlight></codeline>
<codeline lineno="3225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockIndex<sp/>*pindexFailed<sp/>=<sp/>pindexNew;</highlight></codeline>
<codeline lineno="3227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Remove<sp/>the<sp/>entire<sp/>chain<sp/>from<sp/>the<sp/>set.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(pindexTest<sp/>!=<sp/>pindexFailed)<sp/>{</highlight></codeline>
<codeline lineno="3229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fFailedChain)<sp/>{</highlight></codeline>
<codeline lineno="3230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexFailed-&gt;nStatus<sp/>|=<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada8653dc31c354a84e6fd0be105889262f" kindref="member">BLOCK_FAILED_CHILD</ref>;</highlight></codeline>
<codeline lineno="3231"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_dirty_blockindex.insert(pindexFailed);</highlight></codeline>
<codeline lineno="3232"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fMissingData)<sp/>{</highlight></codeline>
<codeline lineno="3233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we&apos;re<sp/>missing<sp/>data,<sp/>then<sp/>add<sp/>back<sp/>to<sp/>m_blocks_unlinked,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>so<sp/>that<sp/>if<sp/>the<sp/>block<sp/>arrives<sp/>in<sp/>the<sp/>future<sp/>we<sp/>can<sp/>try<sp/>adding</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>setBlockIndexCandidates<sp/>again.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_blocks_unlinked.insert(</highlight></codeline>
<codeline lineno="3237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::make_pair(pindexFailed-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>,<sp/>pindexFailed));</highlight></codeline>
<codeline lineno="3238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.erase(pindexFailed);</highlight></codeline>
<codeline lineno="3240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexFailed<sp/>=<sp/>pindexFailed-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>;</highlight></codeline>
<codeline lineno="3241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.erase(pindexTest);</highlight></codeline>
<codeline lineno="3243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fInvalidAncestor<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3244"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexTest<sp/>=<sp/>pindexTest-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>;</highlight></codeline>
<codeline lineno="3247"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!fInvalidAncestor)</highlight></codeline>
<codeline lineno="3249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>pindexNew;</highlight></codeline>
<codeline lineno="3250"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal">(</highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3251"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3252"><highlight class="normal"></highlight></codeline>
<codeline lineno="3254"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1ab1a46f0614b890eb2be89745e2526b7c" kindref="member">Chainstate::PruneBlockIndexCandidates</ref>()<sp/>{</highlight></codeline>
<codeline lineno="3255"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note<sp/>that<sp/>we<sp/>can&apos;t<sp/>delete<sp/>the<sp/>current<sp/>block<sp/>itself,<sp/>as<sp/>we<sp/>may<sp/>need<sp/>to<sp/>return<sp/>to<sp/>it<sp/>later<sp/>in<sp/>case<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3256"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>reorganization<sp/>to<sp/>a<sp/>better<sp/>block<sp/>fails.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3257"><highlight class="normal"><sp/><sp/><sp/><sp/>std::set&lt;CBlockIndex*,<sp/>CBlockIndexWorkComparator&gt;::iterator<sp/>it<sp/>=<sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.begin();</highlight></codeline>
<codeline lineno="3258"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(it<sp/>!=<sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.end()<sp/>&amp;&amp;<sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.value_comp()(*it,<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip()))<sp/>{</highlight></codeline>
<codeline lineno="3259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.erase(it++);</highlight></codeline>
<codeline lineno="3260"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3261"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Either<sp/>the<sp/>current<sp/>tip<sp/>or<sp/>a<sp/>successor<sp/>of<sp/>it<sp/>we&apos;re<sp/>working<sp/>towards<sp/>is<sp/>left<sp/>in<sp/>setBlockIndexCandidates.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3262"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!<ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.empty());</highlight></codeline>
<codeline lineno="3263"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3264"><highlight class="normal"></highlight></codeline>
<codeline lineno="3271"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1a3c22f6ca5579e8366c312e116064b283" kindref="member">Chainstate::ActivateBestChainStep</ref>(<ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref>&amp;<sp/>state,<sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>pindexMostWork,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;&amp;<sp/>pblock,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal">&amp;<sp/>fInvalidFound,<sp/><ref refid="class_connect_trace" kindref="compound">ConnectTrace</ref>&amp;<sp/>connectTrace)</highlight></codeline>
<codeline lineno="3272"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3273"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="3274"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>)<sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>-&gt;cs);</highlight></codeline>
<codeline lineno="3275"><highlight class="normal"></highlight></codeline>
<codeline lineno="3276"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindexOldTip<sp/>=<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip();</highlight></codeline>
<codeline lineno="3277"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindexFork<sp/>=<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.FindFork(pindexMostWork);</highlight></codeline>
<codeline lineno="3278"><highlight class="normal"></highlight></codeline>
<codeline lineno="3279"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Disconnect<sp/>active<sp/>blocks<sp/>which<sp/>are<sp/>no<sp/>longer<sp/>in<sp/>the<sp/>best<sp/>chain.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3280"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fBlocksDisconnected<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3281"><highlight class="normal"><sp/><sp/><sp/><sp/>DisconnectedBlockTransactions<sp/>disconnectpool{MAX_DISCONNECTED_TX_POOL_BYTES};</highlight></codeline>
<codeline lineno="3282"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip()<sp/>&amp;&amp;<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip()<sp/>!=<sp/>pindexFork)<sp/>{</highlight></codeline>
<codeline lineno="3283"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1a5286c896c77d30226698c47b3f2dfc33" kindref="member">DisconnectTip</ref>(state,<sp/>&amp;disconnectpool))<sp/>{</highlight></codeline>
<codeline lineno="3284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>is<sp/>likely<sp/>a<sp/>fatal<sp/>error,<sp/>but<sp/>keep<sp/>the<sp/>mempool<sp/>consistent,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>just<sp/>in<sp/>case.<sp/>Only<sp/>remove<sp/>from<sp/>the<sp/>mempool<sp/>in<sp/>this<sp/>case.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a6382a5c89f0cc48c00603fdfb6426caa" kindref="member">MaybeUpdateMempoolForReorg</ref>(disconnectpool,<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3287"><highlight class="normal"></highlight></codeline>
<codeline lineno="3288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we&apos;re<sp/>unable<sp/>to<sp/>disconnect<sp/>a<sp/>block<sp/>during<sp/>normal<sp/>operation,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3289"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>then<sp/>that<sp/>is<sp/>a<sp/>failure<sp/>of<sp/>our<sp/>local<sp/>system<sp/>--<sp/>we<sp/>should<sp/>abort</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>rather<sp/>than<sp/>stay<sp/>on<sp/>a<sp/>less<sp/>work<sp/>chain.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8h_1a5a516dcd32726994512c2dfe67439ba2" kindref="member">FatalError</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetNotifications(),<sp/>state,<sp/><ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>disconnect<sp/>block.&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="3292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fBlocksDisconnected<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3295"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3296"><highlight class="normal"></highlight></codeline>
<codeline lineno="3297"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Build<sp/>list<sp/>of<sp/>new<sp/>blocks<sp/>to<sp/>connect<sp/>(in<sp/>descending<sp/>height<sp/>order).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3298"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;CBlockIndex*&gt;<sp/>vpindexToConnect;</highlight></codeline>
<codeline lineno="3299"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fContinue<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3300"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref><sp/>=<sp/>pindexFork<sp/>?<sp/>pindexFork-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>:<sp/>-1;</highlight></codeline>
<codeline lineno="3301"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(fContinue<sp/>&amp;&amp;<sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref><sp/>!=<sp/>pindexMostWork-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Don&apos;t<sp/>iterate<sp/>the<sp/>entire<sp/>list<sp/>of<sp/>potential<sp/>improvements<sp/>toward<sp/>the<sp/>best<sp/>tip,<sp/>as<sp/>we<sp/>likely<sp/>only<sp/>need</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>a<sp/>few<sp/>blocks<sp/>along<sp/>the<sp/>way.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nTargetHeight<sp/>=<sp/>std::min(<ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref><sp/>+<sp/>32,<sp/>pindexMostWork-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>);</highlight></codeline>
<codeline lineno="3305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vpindexToConnect.clear();</highlight></codeline>
<codeline lineno="3306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vpindexToConnect.reserve(nTargetHeight<sp/>-<sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref>);</highlight></codeline>
<codeline lineno="3307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>pindexIter<sp/>=<sp/>pindexMostWork-&gt;<ref refid="class_c_block_index_1ac20120d6b64792647a63d216b26e4b53" kindref="member">GetAncestor</ref>(nTargetHeight);</highlight></codeline>
<codeline lineno="3308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(pindexIter<sp/>&amp;&amp;<sp/>pindexIter-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>!=<sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vpindexToConnect.push_back(pindexIter);</highlight></codeline>
<codeline lineno="3310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexIter<sp/>=<sp/>pindexIter-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>;</highlight></codeline>
<codeline lineno="3311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref><sp/>=<sp/>nTargetHeight;</highlight></codeline>
<codeline lineno="3313"><highlight class="normal"></highlight></codeline>
<codeline lineno="3314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Connect<sp/>new<sp/>blocks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(CBlockIndex*<sp/>pindexConnect<sp/>:<sp/>vpindexToConnect<sp/>|<sp/>std::views::reverse)<sp/>{</highlight></codeline>
<codeline lineno="3316"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1a5d8f3346d9afde7670582ba7270f65c0" kindref="member">ConnectTip</ref>(state,<sp/>pindexConnect,<sp/>pindexConnect<sp/>==<sp/>pindexMostWork<sp/>?<sp/>pblock<sp/>:<sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;(),<sp/>connectTrace,<sp/>disconnectpool))<sp/>{</highlight></codeline>
<codeline lineno="3317"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.<ref refid="class_validation_state_1a6c1f27c9de7ff98356fa712e4b796a1a" kindref="member">IsInvalid</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>block<sp/>violates<sp/>a<sp/>consensus<sp/>rule.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.<ref refid="class_validation_state_1a1b98c7dab961aab90e13b3f3f9fcf52d" kindref="member">GetResult</ref>()<sp/>!=<sp/><ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580aa74bec7838a1da98fe1e6e0620d31170" kindref="member">BlockValidationResult::BLOCK_MUTATED</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1acd1f6fc8d7b53d55405ed6107ef693ad" kindref="member">InvalidChainFound</ref>(vpindexToConnect.front());</highlight></codeline>
<codeline lineno="3321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state<sp/>=<sp/>BlockValidationState();</highlight></codeline>
<codeline lineno="3323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fInvalidFound<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fContinue<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>A<sp/>system<sp/>error<sp/>occurred<sp/>(disk<sp/>space,<sp/>database<sp/>error,<sp/>...).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Make<sp/>the<sp/>mempool<sp/>consistent<sp/>with<sp/>the<sp/>current<sp/>tip,<sp/>just<sp/>in<sp/>case</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>any<sp/>observers<sp/>try<sp/>to<sp/>use<sp/>it<sp/>before<sp/>shutdown.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a6382a5c89f0cc48c00603fdfb6426caa" kindref="member">MaybeUpdateMempoolForReorg</ref>(disconnectpool,<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3334"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab1a46f0614b890eb2be89745e2526b7c" kindref="member">PruneBlockIndexCandidates</ref>();</highlight></codeline>
<codeline lineno="3335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pindexOldTip<sp/>||<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip()-&gt;nChainWork<sp/>&gt;<sp/>pindexOldTip-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We&apos;re<sp/>in<sp/>a<sp/>better<sp/>position<sp/>than<sp/>we<sp/>were.<sp/>Return<sp/>temporarily<sp/>to<sp/>release<sp/>the<sp/>lock.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fContinue<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3340"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3342"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3343"><highlight class="normal"></highlight></codeline>
<codeline lineno="3344"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fBlocksDisconnected)<sp/>{</highlight></codeline>
<codeline lineno="3345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>any<sp/>blocks<sp/>were<sp/>disconnected,<sp/>disconnectpool<sp/>may<sp/>be<sp/>non<sp/>empty.<sp/><sp/>Add</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>any<sp/>disconnected<sp/>transactions<sp/>back<sp/>to<sp/>the<sp/>mempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a6382a5c89f0cc48c00603fdfb6426caa" kindref="member">MaybeUpdateMempoolForReorg</ref>(disconnectpool,<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3348"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3349"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>)<sp/><ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>-&gt;check(this-&gt;<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>(),<sp/>this-&gt;<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Height()<sp/>+<sp/>1);</highlight></codeline>
<codeline lineno="3350"><highlight class="normal"></highlight></codeline>
<codeline lineno="3351"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a7d3637ae43c319b91b55b43ff1dc0a37" kindref="member">CheckForkWarningConditions</ref>();</highlight></codeline>
<codeline lineno="3352"><highlight class="normal"></highlight></codeline>
<codeline lineno="3353"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3354"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3355"><highlight class="normal"></highlight></codeline>
<codeline lineno="3356"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a6c3c8e6370214538a00a221a568b5219" kindref="member">SynchronizationState</ref><sp/>GetSynchronizationState(</highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="namespaceinit" kindref="compound">init</ref>,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>blockfiles_indexed)</highlight></codeline>
<codeline lineno="3357"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3358"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="namespaceinit" kindref="compound">init</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a6c3c8e6370214538a00a221a568b5219a90420c85ac74ebe4793694a7c4680b12" kindref="member">SynchronizationState::POST_INIT</ref>;</highlight></codeline>
<codeline lineno="3359"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!blockfiles_indexed)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a6c3c8e6370214538a00a221a568b5219aed5f7c41f40d80cfb4805fc2a823aaa5" kindref="member">SynchronizationState::INIT_REINDEX</ref>;</highlight></codeline>
<codeline lineno="3360"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a6c3c8e6370214538a00a221a568b5219a8ad7ae4642d6220dcc79dfe93a5a3b25" kindref="member">SynchronizationState::INIT_DOWNLOAD</ref>;</highlight></codeline>
<codeline lineno="3361"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3362"><highlight class="normal"></highlight></codeline>
<codeline lineno="3363"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>ChainstateManager::NotifyHeaderTip()</highlight></codeline>
<codeline lineno="3364"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3365"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fNotify<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3366"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fInitialBlockDownload<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3367"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>pindexHeader<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3368"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3369"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="class_chainstate_manager_1af99ab8783b483abe3fef8ab596a3e6b6" kindref="member">GetMutex</ref>());</highlight></codeline>
<codeline lineno="3370"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexHeader<sp/>=<sp/>m_best_header;</highlight></codeline>
<codeline lineno="3371"><highlight class="normal"></highlight></codeline>
<codeline lineno="3372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexHeader<sp/>!=<sp/>m_last_notified_header)<sp/>{</highlight></codeline>
<codeline lineno="3373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fNotify<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fInitialBlockDownload<sp/>=<sp/><ref refid="class_chainstate_manager_1a312bb1a2008bae3205f4699b90880d66" kindref="member">IsInitialBlockDownload</ref>();</highlight></codeline>
<codeline lineno="3375"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_last_notified_header<sp/>=<sp/>pindexHeader;</highlight></codeline>
<codeline lineno="3376"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3377"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3378"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Send<sp/>block<sp/>tip<sp/>changed<sp/>notifications<sp/>without<sp/>the<sp/>lock<sp/>held</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3379"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fNotify)<sp/>{</highlight></codeline>
<codeline lineno="3380"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a30d910c43e6619c9596c077fd1e5518d" kindref="member">GetNotifications</ref>().<ref refid="classkernel_1_1_notifications_1af27b750e4abb85337ce880c56a10aa88" kindref="member">headerTip</ref>(GetSynchronizationState(fInitialBlockDownload,<sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_blockfiles_indexed),<sp/>pindexHeader-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>pindexHeader-&gt;<ref refid="class_c_block_index_1aa8f69813eff5f5d147bbb76bdaf46005" kindref="member">nTime</ref>,<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3381"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3382"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>fNotify;</highlight></codeline>
<codeline lineno="3383"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3384"><highlight class="normal"></highlight></codeline>
<codeline lineno="3385"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>LimitValidationInterfaceQueue(<ref refid="class_validation_signals" kindref="compound">ValidationSignals</ref>&amp;<sp/>signals)<sp/><ref refid="thread__annotations_8h_1a6bb97382864d0bd2cd4dd5191bb03f6c" kindref="member">LOCKS_EXCLUDED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3386"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="3387"><highlight class="normal"></highlight></codeline>
<codeline lineno="3388"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(signals.CallbacksPending()<sp/>&gt;<sp/>10)<sp/>{</highlight></codeline>
<codeline lineno="3389"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>signals.SyncWithValidationInterfaceQueue();</highlight></codeline>
<codeline lineno="3390"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3391"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3392"><highlight class="normal"></highlight></codeline>
<codeline lineno="3393"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>Chainstate::ActivateBestChain(<ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref>&amp;<sp/>state,<sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;<sp/>pblock)</highlight></codeline>
<codeline lineno="3394"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3395"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(<ref refid="class_chainstate_1a395a52bbdb9bd9589970a6b5c574eb1e" kindref="member">m_chainstate_mutex</ref>);</highlight></codeline>
<codeline lineno="3396"><highlight class="normal"></highlight></codeline>
<codeline lineno="3397"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note<sp/>that<sp/>while<sp/>we&apos;re<sp/>often<sp/>called<sp/>here<sp/>from<sp/>ProcessNewBlock,<sp/>this<sp/>is</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3398"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>far<sp/>from<sp/>a<sp/>guarantee.<sp/>Things<sp/>in<sp/>the<sp/>P2P/RPC<sp/>will<sp/>often<sp/>end<sp/>up<sp/>calling</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3399"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>us<sp/>in<sp/>the<sp/>middle<sp/>of<sp/>ProcessNewBlock<sp/>-<sp/>do<sp/>not<sp/>assume<sp/>pblock<sp/>is<sp/>set</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3400"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>sanely<sp/>for<sp/>performance<sp/>or<sp/>correctness!</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3401"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="3402"><highlight class="normal"></highlight></codeline>
<codeline lineno="3403"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ABC<sp/>maintains<sp/>a<sp/>fair<sp/>degree<sp/>of<sp/>expensive-to-calculate<sp/>internal<sp/>state</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3404"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>because<sp/>this<sp/>function<sp/>periodically<sp/>releases<sp/>cs_main<sp/>so<sp/>that<sp/>it<sp/>does<sp/>not<sp/>lock<sp/>up<sp/>other<sp/>threads<sp/>for<sp/>too<sp/>long</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3405"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>during<sp/>large<sp/>connects<sp/>-<sp/>and<sp/>to<sp/>allow<sp/>for<sp/>e.g.<sp/>the<sp/>callback<sp/>queue<sp/>to<sp/>drain</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3406"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>use<sp/>m_chainstate_mutex<sp/>to<sp/>enforce<sp/>mutual<sp/>exclusion<sp/>so<sp/>that<sp/>only<sp/>one<sp/>caller<sp/>may<sp/>execute<sp/>this<sp/>function<sp/>at<sp/>a<sp/>time</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3407"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="class_chainstate_1a395a52bbdb9bd9589970a6b5c574eb1e" kindref="member">m_chainstate_mutex</ref>);</highlight></codeline>
<codeline lineno="3408"><highlight class="normal"></highlight></codeline>
<codeline lineno="3409"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Belt-and-suspenders<sp/>check<sp/>that<sp/>we<sp/>aren&apos;t<sp/>attempting<sp/>to<sp/>advance<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3410"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>chainstate<sp/>past<sp/>the<sp/>target<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3411"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>,<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>m_target_utxohash))<sp/>{</highlight></codeline>
<codeline lineno="3412"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;%s&quot;</highlight><highlight class="normal">,<sp/><ref refid="check_8h_1addf5dbcbeb39d6e72b103d4252a12267" kindref="member">STR_INTERNAL_BUG</ref>(</highlight><highlight class="stringliteral">&quot;m_target_utxohash<sp/>is<sp/>set<sp/>-<sp/>this<sp/>chainstate<sp/>should<sp/>not<sp/>be<sp/>in<sp/>operation.&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="3413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(</highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3414"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3415"><highlight class="normal"></highlight></codeline>
<codeline lineno="3416"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockIndex<sp/>*pindexMostWork<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3417"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockIndex<sp/>*pindexNewTip<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3418"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>exited_ibd{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="3419"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">do</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Block<sp/>until<sp/>the<sp/>validation<sp/>queue<sp/>drains.<sp/>This<sp/>should<sp/>largely</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3421"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>never<sp/>happen<sp/>in<sp/>normal<sp/>operation,<sp/>however<sp/>may<sp/>happen<sp/>during</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>reindex,<sp/>causing<sp/>memory<sp/>blowup<sp/>if<sp/>we<sp/>run<sp/>too<sp/>far<sp/>ahead.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3423"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note<sp/>that<sp/>if<sp/>a<sp/>validationinterface<sp/>callback<sp/>ends<sp/>up<sp/>calling</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3424"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ActivateBestChain<sp/>this<sp/>may<sp/>lead<sp/>to<sp/>a<sp/>deadlock!<sp/>We<sp/>should</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3425"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>probably<sp/>have<sp/>a<sp/>DEBUG_LOCKORDER<sp/>test<sp/>for<sp/>this<sp/>in<sp/>the<sp/>future.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3426"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.signals)<sp/>LimitValidationInterfaceQueue(*<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.signals);</highlight></codeline>
<codeline lineno="3427"><highlight class="normal"></highlight></codeline>
<codeline lineno="3428"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3429"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="3430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Lock<sp/>transaction<sp/>pool<sp/>for<sp/>at<sp/>least<sp/>as<sp/>long<sp/>as<sp/>it<sp/>takes<sp/>for<sp/>connectTrace<sp/>to<sp/>be<sp/>consumed</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3432"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="class_chainstate_1a52cbd849b01fb79124389f885da05779" kindref="member">MempoolMutex</ref>());</highlight></codeline>
<codeline lineno="3433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>was_in_ibd<sp/>=<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.IsInitialBlockDownload();</highlight></codeline>
<codeline lineno="3434"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>starting_tip<sp/>=<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip();</highlight></codeline>
<codeline lineno="3435"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>blocks_connected<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3436"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">do</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3437"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>absolutely<sp/>may<sp/>not<sp/>unlock<sp/>cs_main<sp/>until<sp/>we&apos;ve<sp/>made<sp/>forward<sp/>progress</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3438"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(with<sp/>the<sp/>exception<sp/>of<sp/>shutdown<sp/>due<sp/>to<sp/>hardware<sp/>issues,<sp/>low<sp/>disk<sp/>space,<sp/>etc).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3439"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ConnectTrace<sp/>connectTrace;<sp/></highlight><highlight class="comment">//<sp/>Destructed<sp/>before<sp/>cs_main<sp/>is<sp/>unlocked</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3440"><highlight class="normal"></highlight></codeline>
<codeline lineno="3441"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexMostWork<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="3442"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexMostWork<sp/>=<sp/><ref refid="class_chainstate_1aa9ca3194eec690da7453dfb54549f554" kindref="member">FindMostWorkChain</ref>();</highlight></codeline>
<codeline lineno="3443"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3444"><highlight class="normal"></highlight></codeline>
<codeline lineno="3445"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Whether<sp/>we<sp/>have<sp/>anything<sp/>to<sp/>do<sp/>at<sp/>all.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3446"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexMostWork<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>||<sp/>pindexMostWork<sp/>==<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip())<sp/>{</highlight></codeline>
<codeline lineno="3447"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3448"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3449"><highlight class="normal"></highlight></codeline>
<codeline lineno="3450"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fInvalidFound<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;<sp/>nullBlockPtr;</highlight></codeline>
<codeline lineno="3452"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>BlockConnected<sp/>signals<sp/>must<sp/>be<sp/>sent<sp/>for<sp/>the<sp/>original<sp/>role;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3453"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>in<sp/>case<sp/>snapshot<sp/>validation<sp/>is<sp/>completed<sp/>during<sp/>ActivateBestChainStep,<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>result<sp/>of<sp/>GetRole()<sp/>changes<sp/>from<sp/>BACKGROUND<sp/>to<sp/>NORMAL.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3455"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>ChainstateRole<sp/>chainstate_role{this-&gt;GetRole()};</highlight></codeline>
<codeline lineno="3456"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1a3c22f6ca5579e8366c312e116064b283" kindref="member">ActivateBestChainStep</ref>(state,<sp/>pindexMostWork,<sp/>pblock<sp/>&amp;&amp;<sp/>pblock-&gt;GetHash()<sp/>==<sp/>pindexMostWork-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>()<sp/>?<sp/>pblock<sp/>:<sp/>nullBlockPtr,<sp/>fInvalidFound,<sp/>connectTrace))<sp/>{</highlight></codeline>
<codeline lineno="3457"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>A<sp/>system<sp/>error<sp/>occurred</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3458"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3459"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3460"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks_connected<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3461"><highlight class="normal"></highlight></codeline>
<codeline lineno="3462"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fInvalidFound)<sp/>{</highlight></codeline>
<codeline lineno="3463"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Wipe<sp/>cache,<sp/>we<sp/>may<sp/>need<sp/>another<sp/>branch<sp/>now.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3464"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexMostWork<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3465"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3466"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexNewTip<sp/>=<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip();</highlight></codeline>
<codeline lineno="3467"><highlight class="normal"></highlight></codeline>
<codeline lineno="3468"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>PerBlockConnectTrace&amp;<sp/>trace<sp/>:<sp/>connectTrace.<ref refid="class_connect_trace_1a2a34e5eddac4461fdb0357a743c1f8e9" kindref="member">GetBlocksConnected</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3469"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(trace.pblock<sp/>&amp;&amp;<sp/>trace.pindex);</highlight></codeline>
<codeline lineno="3470"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.signals)<sp/>{</highlight></codeline>
<codeline lineno="3471"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.signals-&gt;BlockConnected(chainstate_role,<sp/>trace.pblock,<sp/>trace.pindex);</highlight></codeline>
<codeline lineno="3472"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3473"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3474"><highlight class="normal"></highlight></codeline>
<codeline lineno="3475"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Break<sp/>this<sp/>do-while<sp/>to<sp/>ensure<sp/>we<sp/>don&apos;t<sp/>advance<sp/>past<sp/>the<sp/>target<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3476"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a13f930c315cbf69ccbac5e6187ea5150" kindref="member">ReachedTarget</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3477"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3478"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3479"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip()<sp/>||<sp/>(starting_tip<sp/>&amp;&amp;<sp/>CBlockIndexWorkComparator()(<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip(),<sp/>starting_tip)));</highlight></codeline>
<codeline lineno="3480"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!blocks_connected)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3481"><highlight class="normal"></highlight></codeline>
<codeline lineno="3482"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindexFork<sp/>=<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.FindFork(starting_tip);</highlight></codeline>
<codeline lineno="3483"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>still_in_ibd<sp/>=<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.IsInitialBlockDownload();</highlight></codeline>
<codeline lineno="3484"><highlight class="normal"></highlight></codeline>
<codeline lineno="3485"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(was_in_ibd<sp/>&amp;&amp;<sp/>!still_in_ibd)<sp/>{</highlight></codeline>
<codeline lineno="3486"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Active<sp/>chainstate<sp/>has<sp/>exited<sp/>IBD.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3487"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>exited_ibd<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3488"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3489"><highlight class="normal"></highlight></codeline>
<codeline lineno="3490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Notify<sp/>external<sp/>listeners<sp/>about<sp/>the<sp/>new<sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3491"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Enqueue<sp/>while<sp/>holding<sp/>cs_main<sp/>to<sp/>ensure<sp/>that<sp/>UpdatedBlockTip<sp/>is<sp/>called<sp/>in<sp/>the<sp/>order<sp/>in<sp/>which<sp/>blocks<sp/>are<sp/>connected</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">this</highlight><highlight class="normal"><sp/>==<sp/>&amp;<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.ActiveChainstate()<sp/>&amp;&amp;<sp/>pindexFork<sp/>!=<sp/>pindexNewTip)<sp/>{</highlight></codeline>
<codeline lineno="3493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Notify<sp/>ValidationInterface<sp/>subscribers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.signals)<sp/>{</highlight></codeline>
<codeline lineno="3495"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.signals-&gt;UpdatedBlockTip(pindexNewTip,<sp/>pindexFork,<sp/>still_in_ibd);</highlight></codeline>
<codeline lineno="3496"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3497"><highlight class="normal"></highlight></codeline>
<codeline lineno="3498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="namespacekernel_1a7ef2c1ed3713a62176568424326f9aba" kindref="member">kernel::IsInterrupted</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetNotifications().blockTip(</highlight></codeline>
<codeline lineno="3499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*state=*/</highlight><highlight class="normal">GetSynchronizationState(still_in_ibd,<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_blockman.m_blockfiles_indexed),</highlight></codeline>
<codeline lineno="3500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*index=*/</highlight><highlight class="normal">*pindexNewTip,</highlight></codeline>
<codeline lineno="3501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*verification_progress=*/</highlight><highlight class="normal"><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GuessVerificationProgress(pindexNewTip))))</highlight></codeline>
<codeline lineno="3502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3503"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Just<sp/>breaking<sp/>and<sp/>returning<sp/>success<sp/>for<sp/>now.<sp/>This<sp/>could</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3504"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>be<sp/>changed<sp/>to<sp/>bubble<sp/>up<sp/>the<sp/>kernel::Interrupted<sp/>value<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>caller<sp/>so<sp/>the<sp/>caller<sp/>could<sp/>distinguish<sp/>between</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>completed<sp/>and<sp/>interrupted<sp/>operations.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3508"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3509"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>release<sp/>MempoolMutex</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Notify<sp/>external<sp/>listeners<sp/>about<sp/>the<sp/>new<sp/>tip,<sp/>even<sp/>if<sp/>pindexFork<sp/>==<sp/>pindexNewTip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.signals<sp/>&amp;&amp;<sp/></highlight><highlight class="keyword">this</highlight><highlight class="normal"><sp/>==<sp/>&amp;<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.ActiveChainstate())<sp/>{</highlight></codeline>
<codeline lineno="3513"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.signals-&gt;ActiveTipChange(*<ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(pindexNewTip),<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.IsInitialBlockDownload());</highlight></codeline>
<codeline lineno="3514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3515"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>release<sp/>cs_main</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3516"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When<sp/>we<sp/>reach<sp/>this<sp/>point,<sp/>we<sp/>switched<sp/>to<sp/>a<sp/>new<sp/>tip<sp/>(stored<sp/>in<sp/>pindexNewTip).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3517"><highlight class="normal"></highlight></codeline>
<codeline lineno="3518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>reached_target;</highlight></codeline>
<codeline lineno="3519"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3520"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetMutex());</highlight></codeline>
<codeline lineno="3521"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(exited_ibd)<sp/>{</highlight></codeline>
<codeline lineno="3522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>a<sp/>background<sp/>chainstate<sp/>is<sp/>in<sp/>use,<sp/>we<sp/>may<sp/>need<sp/>to<sp/>rebalance<sp/>our</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3523"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>allocation<sp/>of<sp/>caches<sp/>once<sp/>a<sp/>chainstate<sp/>exits<sp/>initial<sp/>block<sp/>download.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.MaybeRebalanceCaches();</highlight></codeline>
<codeline lineno="3525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3526"><highlight class="normal"></highlight></codeline>
<codeline lineno="3527"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Write<sp/>changes<sp/>periodically<sp/>to<sp/>disk,<sp/>after<sp/>relay.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3528"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1a0f9f0cdb703638cb9818a9b41158ac6a" kindref="member">FlushStateToDisk</ref>(state,<sp/><ref refid="validation_8h_1ab30a99e75e9dc44356d1ad6bdd184ae0ad9d83fc826ae0d42075af007a477e2c9" kindref="member">FlushStateMode::PERIODIC</ref>))<sp/>{</highlight></codeline>
<codeline lineno="3529"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3530"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3531"><highlight class="normal"></highlight></codeline>
<codeline lineno="3532"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reached_target<sp/>=<sp/><ref refid="class_chainstate_1a13f930c315cbf69ccbac5e6187ea5150" kindref="member">ReachedTarget</ref>();</highlight></codeline>
<codeline lineno="3533"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3534"><highlight class="normal"></highlight></codeline>
<codeline lineno="3535"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(reached_target)<sp/>{</highlight></codeline>
<codeline lineno="3536"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Chainstate<sp/>has<sp/>reached<sp/>the<sp/>target<sp/>block,<sp/>so<sp/>exit.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3537"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3538"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Restart<sp/>indexes<sp/>so<sp/>indexes<sp/>can<sp/>resync<sp/>and<sp/>index<sp/>new<sp/>blocks<sp/>after</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3539"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>target<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3540"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3541"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>cannot<sp/>be<sp/>done<sp/>while<sp/>holding<sp/>cs_main<sp/>(within</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3542"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>MaybeValidateSnapshot)<sp/>or<sp/>a<sp/>cs_main<sp/>deadlock<sp/>will<sp/>occur.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3543"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.snapshot_download_completed)<sp/>{</highlight></codeline>
<codeline lineno="3544"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.snapshot_download_completed();</highlight></codeline>
<codeline lineno="3545"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3546"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3547"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3548"><highlight class="normal"></highlight></codeline>
<codeline lineno="3549"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>check<sp/>interrupt<sp/>only<sp/>after<sp/>giving<sp/>ActivateBestChainStep<sp/>a<sp/>chance<sp/>to<sp/>run<sp/>once<sp/>so<sp/>that<sp/>we</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3550"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>never<sp/>interrupt<sp/>before<sp/>connecting<sp/>the<sp/>genesis<sp/>block<sp/>during<sp/>LoadChainTip().<sp/>Previously<sp/>this</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3551"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>caused<sp/>an<sp/>assert()<sp/>failure<sp/>during<sp/>interrupt<sp/>in<sp/>such<sp/>cases<sp/>as<sp/>the<sp/>UTXO<sp/>DB<sp/>flushing<sp/>checks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3552"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>that<sp/>the<sp/>best<sp/>block<sp/>hash<sp/>is<sp/>non-null.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3553"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_interrupt)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3554"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(pindexNewTip<sp/>!=<sp/>pindexMostWork);</highlight></codeline>
<codeline lineno="3555"><highlight class="normal"></highlight></codeline>
<codeline lineno="3556"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.CheckBlockIndex();</highlight></codeline>
<codeline lineno="3557"><highlight class="normal"></highlight></codeline>
<codeline lineno="3558"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3559"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3560"><highlight class="normal"></highlight></codeline>
<codeline lineno="3561"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>Chainstate::PreciousBlock(<ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref>&amp;<sp/>state,<sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>pindex)</highlight></codeline>
<codeline lineno="3562"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3563"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(<ref refid="class_chainstate_1a395a52bbdb9bd9589970a6b5c574eb1e" kindref="member">m_chainstate_mutex</ref>);</highlight></codeline>
<codeline lineno="3564"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="3565"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3566"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="3567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&lt;<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip()-&gt;nChainWork)<sp/>{</highlight></codeline>
<codeline lineno="3568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Nothing<sp/>to<sp/>do,<sp/>this<sp/>block<sp/>is<sp/>not<sp/>at<sp/>the<sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3570"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3571"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip()-&gt;nChainWork<sp/>&gt;<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.nLastPreciousChainwork)<sp/>{</highlight></codeline>
<codeline lineno="3572"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>chain<sp/>has<sp/>been<sp/>extended<sp/>since<sp/>the<sp/>last<sp/>call,<sp/>reset<sp/>the<sp/>counter.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.nBlockReverseSequenceId<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="3574"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3575"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.nLastPreciousChainwork<sp/>=<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip()-&gt;nChainWork;</highlight></codeline>
<codeline lineno="3576"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.erase(pindex);</highlight></codeline>
<codeline lineno="3577"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex-&gt;<ref refid="class_c_block_index_1af095a0efd0b6a7cd78057bbb023a01f7" kindref="member">nSequenceId</ref><sp/>=<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.nBlockReverseSequenceId;</highlight></codeline>
<codeline lineno="3578"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.nBlockReverseSequenceId<sp/>&gt;<sp/>std::numeric_limits&lt;int32_t&gt;::min())<sp/>{</highlight></codeline>
<codeline lineno="3579"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>can&apos;t<sp/>keep<sp/>reducing<sp/>the<sp/>counter<sp/>if<sp/>somebody<sp/>really<sp/>wants<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3580"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>call<sp/>preciousblock<sp/>2**31-1<sp/>times<sp/>on<sp/>the<sp/>same<sp/>set<sp/>of<sp/>tips...</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3581"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.nBlockReverseSequenceId--;</highlight></codeline>
<codeline lineno="3582"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3583"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1a1b5a636925d1c416b9d59eb0392a7a62" kindref="member">IsValid</ref>(<ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada3eef30f876594ac79b888b7d1ff6c66c" kindref="member">BLOCK_VALID_TRANSACTIONS</ref>)<sp/>&amp;&amp;<sp/>pindex-&gt;<ref refid="class_c_block_index_1ae804dd1f9a78669920c2bc21dc7a9812" kindref="member">HaveNumChainTxs</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3584"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.insert(pindex);</highlight></codeline>
<codeline lineno="3585"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab1a46f0614b890eb2be89745e2526b7c" kindref="member">PruneBlockIndexCandidates</ref>();</highlight></codeline>
<codeline lineno="3586"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3587"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3588"><highlight class="normal"></highlight></codeline>
<codeline lineno="3589"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ActivateBestChain(state,<sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;());</highlight></codeline>
<codeline lineno="3590"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3591"><highlight class="normal"></highlight></codeline>
<codeline lineno="3592"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>Chainstate::InvalidateBlock(<ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref>&amp;<sp/>state,<sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>pindex)</highlight></codeline>
<codeline lineno="3593"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3594"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(<ref refid="class_chainstate_1a395a52bbdb9bd9589970a6b5c574eb1e" kindref="member">m_chainstate_mutex</ref>);</highlight></codeline>
<codeline lineno="3595"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="3596"><highlight class="normal"></highlight></codeline>
<codeline lineno="3597"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Genesis<sp/>block<sp/>can&apos;t<sp/>be<sp/>invalidated</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3598"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindex);</highlight></codeline>
<codeline lineno="3599"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3600"><highlight class="normal"></highlight></codeline>
<codeline lineno="3601"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>to_mark_failed<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="3602"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>pindex_was_in_chain<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3603"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>disconnected<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="3604"><highlight class="normal"></highlight></codeline>
<codeline lineno="3605"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>do<sp/>not<sp/>allow<sp/>ActivateBestChain()<sp/>to<sp/>run<sp/>while<sp/>InvalidateBlock()<sp/>is</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3606"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>running,<sp/>as<sp/>that<sp/>could<sp/>cause<sp/>the<sp/>tip<sp/>to<sp/>change<sp/>while<sp/>we<sp/>disconnect</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3607"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>blocks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3608"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="class_chainstate_1a395a52bbdb9bd9589970a6b5c574eb1e" kindref="member">m_chainstate_mutex</ref>);</highlight></codeline>
<codeline lineno="3609"><highlight class="normal"></highlight></codeline>
<codeline lineno="3610"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We&apos;ll<sp/>be<sp/>acquiring<sp/>and<sp/>releasing<sp/>cs_main<sp/>below,<sp/>to<sp/>allow<sp/>the<sp/>validation</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3611"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>callbacks<sp/>to<sp/>run.<sp/>However,<sp/>we<sp/>should<sp/>keep<sp/>the<sp/>block<sp/>index<sp/>in<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3612"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>consistent<sp/>state<sp/>as<sp/>we<sp/>disconnect<sp/>blocks<sp/>--<sp/>in<sp/>particular<sp/>we<sp/>need<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3613"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>add<sp/>equal-work<sp/>blocks<sp/>to<sp/>setBlockIndexCandidates<sp/>as<sp/>we<sp/>disconnect.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3614"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>To<sp/>avoid<sp/>walking<sp/>the<sp/>block<sp/>index<sp/>repeatedly<sp/>in<sp/>search<sp/>of<sp/>candidates,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3615"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>build<sp/>a<sp/>map<sp/>once<sp/>so<sp/>that<sp/>we<sp/>can<sp/>look<sp/>up<sp/>candidate<sp/>blocks<sp/>by<sp/>chain</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3616"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>work<sp/>as<sp/>we<sp/>go.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3617"><highlight class="normal"><sp/><sp/><sp/><sp/>std::multimap&lt;const<sp/>arith_uint256,<sp/>CBlockIndex*&gt;<sp/>highpow_outofchain_headers;</highlight></codeline>
<codeline lineno="3618"><highlight class="normal"></highlight></codeline>
<codeline lineno="3619"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3620"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="3621"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>entry<sp/>:<sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_block_index)<sp/>{</highlight></codeline>
<codeline lineno="3622"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>candidate<sp/>=<sp/>&amp;entry.second;</highlight></codeline>
<codeline lineno="3623"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>don&apos;t<sp/>need<sp/>to<sp/>put<sp/>anything<sp/>in<sp/>our<sp/>active<sp/>chain<sp/>into<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3624"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>multimap,<sp/>because<sp/>those<sp/>candidates<sp/>will<sp/>be<sp/>found<sp/>and<sp/>considered</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3625"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>as<sp/>we<sp/>disconnect.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3626"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Instead,<sp/>consider<sp/>only<sp/>non-active-chain<sp/>blocks<sp/>that<sp/>score</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3627"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>at<sp/>least<sp/>as<sp/>good<sp/>with<sp/>CBlockIndexWorkComparator<sp/>as<sp/>the<sp/>new<sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3628"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Contains(candidate)<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="3629"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!CBlockIndexWorkComparator()(candidate,<sp/>pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>)<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="3630"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!(candidate-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada88df51e92f2f675baff60e0a5bd170ef" kindref="member">BLOCK_FAILED_MASK</ref>))<sp/>{</highlight></codeline>
<codeline lineno="3631"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>highpow_outofchain_headers.insert({candidate-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref>,<sp/>candidate});</highlight></codeline>
<codeline lineno="3632"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3633"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3634"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3635"><highlight class="normal"></highlight></codeline>
<codeline lineno="3636"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Disconnect<sp/>(descendants<sp/>of)<sp/>pindex,<sp/>and<sp/>mark<sp/>them<sp/>invalid.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3637"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">true</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="3638"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_interrupt)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3639"><highlight class="normal"></highlight></codeline>
<codeline lineno="3640"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Make<sp/>sure<sp/>the<sp/>queue<sp/>of<sp/>validation<sp/>callbacks<sp/>doesn&apos;t<sp/>grow<sp/>unboundedly.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3641"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.signals)<sp/>LimitValidationInterfaceQueue(*<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.signals);</highlight></codeline>
<codeline lineno="3642"><highlight class="normal"></highlight></codeline>
<codeline lineno="3643"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="3644"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Lock<sp/>for<sp/>as<sp/>long<sp/>as<sp/>disconnectpool<sp/>is<sp/>in<sp/>scope<sp/>to<sp/>make<sp/>sure<sp/>MaybeUpdateMempoolForReorg<sp/>is</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3645"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>called<sp/>after<sp/>DisconnectTip<sp/>without<sp/>unlocking<sp/>in<sp/>between</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3646"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="class_chainstate_1a52cbd849b01fb79124389f885da05779" kindref="member">MempoolMutex</ref>());</highlight></codeline>
<codeline lineno="3647"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Contains(pindex))<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3648"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex_was_in_chain<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3649"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockIndex<sp/>*invalid_walk_tip<sp/>=<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip();</highlight></codeline>
<codeline lineno="3650"><highlight class="normal"></highlight></codeline>
<codeline lineno="3651"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ActivateBestChain<sp/>considers<sp/>blocks<sp/>already<sp/>in<sp/>m_chain</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3652"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>unconditionally<sp/>valid<sp/>already,<sp/>so<sp/>force<sp/>disconnect<sp/>away<sp/>from<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3653"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DisconnectedBlockTransactions<sp/>disconnectpool{MAX_DISCONNECTED_TX_POOL_BYTES};</highlight></codeline>
<codeline lineno="3654"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref><sp/>=<sp/><ref refid="class_chainstate_1a5286c896c77d30226698c47b3f2dfc33" kindref="member">DisconnectTip</ref>(state,<sp/>&amp;disconnectpool);</highlight></codeline>
<codeline lineno="3655"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>DisconnectTip<sp/>will<sp/>add<sp/>transactions<sp/>to<sp/>disconnectpool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3656"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Adjust<sp/>the<sp/>mempool<sp/>to<sp/>be<sp/>consistent<sp/>with<sp/>the<sp/>new<sp/>tip,<sp/>adding</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3657"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transactions<sp/>back<sp/>to<sp/>the<sp/>mempool<sp/>if<sp/>disconnecting<sp/>was<sp/>successful,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3658"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>we&apos;re<sp/>not<sp/>doing<sp/>a<sp/>very<sp/>deep<sp/>invalidation<sp/>(in<sp/>which<sp/>case</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3659"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>keeping<sp/>the<sp/>mempool<sp/>up<sp/>to<sp/>date<sp/>is<sp/>probably<sp/>futile<sp/>anyway).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3660"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a6382a5c89f0cc48c00603fdfb6426caa" kindref="member">MaybeUpdateMempoolForReorg</ref>(disconnectpool,<sp/></highlight><highlight class="comment">/*<sp/>fAddToMempool<sp/>=<sp/>*/</highlight><highlight class="normal"><sp/>(++disconnected<sp/>&lt;=<sp/>10)<sp/>&amp;&amp;<sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>);</highlight></codeline>
<codeline lineno="3661"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3662"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(invalid_walk_tip-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>==<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip());</highlight></codeline>
<codeline lineno="3663"><highlight class="normal"></highlight></codeline>
<codeline lineno="3664"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>immediately<sp/>mark<sp/>the<sp/>disconnected<sp/>blocks<sp/>as<sp/>invalid.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3665"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>prevents<sp/>a<sp/>case<sp/>where<sp/>pruned<sp/>nodes<sp/>may<sp/>fail<sp/>to<sp/>invalidateblock</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3666"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>be<sp/>left<sp/>unable<sp/>to<sp/>start<sp/>as<sp/>they<sp/>have<sp/>no<sp/>tip<sp/>candidates<sp/>(as<sp/>there</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3667"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>are<sp/>no<sp/>blocks<sp/>that<sp/>meet<sp/>the<sp/>&quot;have<sp/>data<sp/>and<sp/>are<sp/>not<sp/>invalid<sp/>per</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3668"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>nStatus&quot;<sp/>criteria<sp/>for<sp/>inclusion<sp/>in<sp/>setBlockIndexCandidates).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3669"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>invalid_walk_tip-&gt;nStatus<sp/>|=<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93adab3f668fe41faf909922945b37b25ec2d" kindref="member">BLOCK_FAILED_VALID</ref>;</highlight></codeline>
<codeline lineno="3670"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_dirty_blockindex.insert(invalid_walk_tip);</highlight></codeline>
<codeline lineno="3671"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.erase(invalid_walk_tip);</highlight></codeline>
<codeline lineno="3672"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.insert(invalid_walk_tip-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>);</highlight></codeline>
<codeline lineno="3673"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(invalid_walk_tip<sp/>==<sp/>to_mark_failed-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>&amp;&amp;<sp/>(to_mark_failed-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93adab3f668fe41faf909922945b37b25ec2d" kindref="member">BLOCK_FAILED_VALID</ref>))<sp/>{</highlight></codeline>
<codeline lineno="3674"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>only<sp/>want<sp/>to<sp/>mark<sp/>the<sp/>last<sp/>disconnected<sp/>block<sp/>as<sp/>BLOCK_FAILED_VALID;<sp/>its<sp/>children</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>need<sp/>to<sp/>be<sp/>BLOCK_FAILED_CHILD<sp/>instead.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3676"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>to_mark_failed-&gt;nStatus<sp/>=<sp/>(to_mark_failed-&gt;nStatus<sp/>^<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93adab3f668fe41faf909922945b37b25ec2d" kindref="member">BLOCK_FAILED_VALID</ref>)<sp/>|<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada8653dc31c354a84e6fd0be105889262f" kindref="member">BLOCK_FAILED_CHILD</ref>;</highlight></codeline>
<codeline lineno="3677"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_dirty_blockindex.insert(to_mark_failed);</highlight></codeline>
<codeline lineno="3678"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3679"><highlight class="normal"></highlight></codeline>
<codeline lineno="3680"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Mark<sp/>out-of-chain<sp/>descendants<sp/>of<sp/>the<sp/>invalidated<sp/>block<sp/>as<sp/>invalid</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3681"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(possibly<sp/>replacing<sp/>a<sp/>pre-existing<sp/>BLOCK_FAILED_VALID<sp/>with<sp/>BLOCK_FAILED_CHILD)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3682"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Add<sp/>any<sp/>equal<sp/>or<sp/>more<sp/>work<sp/>headers<sp/>that<sp/>are<sp/>not<sp/>invalidated<sp/>to<sp/>setBlockIndexCandidates</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3683"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Recalculate<sp/>m_best_header<sp/>if<sp/>it<sp/>became<sp/>invalid.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3684"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>candidate_it<sp/>=<sp/>highpow_outofchain_headers.lower_bound(invalid_walk_tip-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref>);</highlight></codeline>
<codeline lineno="3685"><highlight class="normal"></highlight></codeline>
<codeline lineno="3686"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>best_header_needs_update{<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_header-&gt;GetAncestor(invalid_walk_tip-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>)<sp/>==<sp/>invalid_walk_tip};</highlight></codeline>
<codeline lineno="3687"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(best_header_needs_update)<sp/>{</highlight></codeline>
<codeline lineno="3688"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>pprev<sp/>is<sp/>definitely<sp/>still<sp/>valid<sp/>at<sp/>this<sp/>point,<sp/>but<sp/>there<sp/>may<sp/>be<sp/>better<sp/>ones</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3689"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_header<sp/>=<sp/>invalid_walk_tip-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>;</highlight></codeline>
<codeline lineno="3690"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3691"><highlight class="normal"></highlight></codeline>
<codeline lineno="3692"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(candidate_it<sp/>!=<sp/>highpow_outofchain_headers.end())<sp/>{</highlight></codeline>
<codeline lineno="3693"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>candidate{candidate_it-&gt;second};</highlight></codeline>
<codeline lineno="3694"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(candidate-&gt;<ref refid="class_c_block_index_1ac20120d6b64792647a63d216b26e4b53" kindref="member">GetAncestor</ref>(invalid_walk_tip-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>)<sp/>==<sp/>invalid_walk_tip)<sp/>{</highlight></codeline>
<codeline lineno="3695"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Children<sp/>of<sp/>failed<sp/>blocks<sp/>should<sp/>be<sp/>marked<sp/>as<sp/>BLOCK_FAILED_CHILD<sp/>instead.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3696"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>candidate-&gt;nStatus<sp/>&amp;=<sp/>~BLOCK_FAILED_VALID;</highlight></codeline>
<codeline lineno="3697"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>candidate-&gt;nStatus<sp/>|=<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada8653dc31c354a84e6fd0be105889262f" kindref="member">BLOCK_FAILED_CHILD</ref>;</highlight></codeline>
<codeline lineno="3698"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_dirty_blockindex.insert(candidate);</highlight></codeline>
<codeline lineno="3699"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>invalidated,<sp/>the<sp/>block<sp/>is<sp/>irrelevant<sp/>for<sp/>setBlockIndexCandidates</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3700"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>for<sp/>m_best_header<sp/>and<sp/>can<sp/>be<sp/>removed<sp/>from<sp/>the<sp/>cache.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3701"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>candidate_it<sp/>=<sp/>highpow_outofchain_headers.erase(candidate_it);</highlight></codeline>
<codeline lineno="3702"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3703"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3704"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!CBlockIndexWorkComparator()(candidate,<sp/>invalid_walk_tip-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>)<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="3705"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>candidate-&gt;<ref refid="class_c_block_index_1a1b5a636925d1c416b9d59eb0392a7a62" kindref="member">IsValid</ref>(<ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada3eef30f876594ac79b888b7d1ff6c66c" kindref="member">BLOCK_VALID_TRANSACTIONS</ref>)<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="3706"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>candidate-&gt;<ref refid="class_c_block_index_1ae804dd1f9a78669920c2bc21dc7a9812" kindref="member">HaveNumChainTxs</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3707"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.insert(candidate);</highlight></codeline>
<codeline lineno="3708"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Do<sp/>not<sp/>remove<sp/>candidate<sp/>from<sp/>the<sp/>highpow_outofchain_headers<sp/>cache,<sp/>because<sp/>it<sp/>might<sp/>be<sp/>a<sp/>descendant<sp/>of<sp/>the<sp/>block<sp/>being<sp/>invalidated</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3709"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>which<sp/>needs<sp/>to<sp/>be<sp/>marked<sp/>failed<sp/>later.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3710"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3711"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(best_header_needs_update<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="3712"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_header-&gt;nChainWork<sp/>&lt;<sp/>candidate-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3713"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_header<sp/>=<sp/>candidate;</highlight></codeline>
<codeline lineno="3714"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3715"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++candidate_it;</highlight></codeline>
<codeline lineno="3716"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3717"><highlight class="normal"></highlight></codeline>
<codeline lineno="3718"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Track<sp/>the<sp/>last<sp/>disconnected<sp/>block,<sp/>so<sp/>we<sp/>can<sp/>correct<sp/>its<sp/>BLOCK_FAILED_CHILD<sp/>status<sp/>in<sp/>future</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3719"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>iterations,<sp/>or,<sp/>if<sp/>it&apos;s<sp/>the<sp/>last<sp/>one,<sp/>call<sp/>InvalidChainFound<sp/>on<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3720"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>to_mark_failed<sp/>=<sp/>invalid_walk_tip;</highlight></codeline>
<codeline lineno="3721"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3722"><highlight class="normal"></highlight></codeline>
<codeline lineno="3723"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.CheckBlockIndex();</highlight></codeline>
<codeline lineno="3724"><highlight class="normal"></highlight></codeline>
<codeline lineno="3725"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3726"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="3727"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Contains(to_mark_failed))<sp/>{</highlight></codeline>
<codeline lineno="3728"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>to-be-marked<sp/>invalid<sp/>block<sp/>is<sp/>in<sp/>the<sp/>active<sp/>chain,<sp/>something<sp/>is<sp/>interfering<sp/>and<sp/>we<sp/>can&apos;t<sp/>proceed.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3729"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3730"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3731"><highlight class="normal"></highlight></codeline>
<codeline lineno="3732"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Mark<sp/>pindex<sp/>as<sp/>invalid<sp/>if<sp/>it<sp/>never<sp/>was<sp/>in<sp/>the<sp/>main<sp/>chain</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3733"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pindex_was_in_chain<sp/>&amp;&amp;<sp/>!(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada88df51e92f2f675baff60e0a5bd170ef" kindref="member">BLOCK_FAILED_MASK</ref>))<sp/>{</highlight></codeline>
<codeline lineno="3734"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex-&gt;nStatus<sp/>|=<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93adab3f668fe41faf909922945b37b25ec2d" kindref="member">BLOCK_FAILED_VALID</ref>;</highlight></codeline>
<codeline lineno="3735"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_dirty_blockindex.insert(pindex);</highlight></codeline>
<codeline lineno="3736"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.erase(pindex);</highlight></codeline>
<codeline lineno="3737"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3738"><highlight class="normal"></highlight></codeline>
<codeline lineno="3739"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>any<sp/>new<sp/>blocks<sp/>somehow<sp/>arrived<sp/>while<sp/>we<sp/>were<sp/>disconnecting</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3740"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(above),<sp/>then<sp/>the<sp/>pre-calculation<sp/>of<sp/>what<sp/>should<sp/>go<sp/>into</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3741"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>setBlockIndexCandidates<sp/>may<sp/>have<sp/>missed<sp/>entries.<sp/>This<sp/>would</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3742"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>technically<sp/>be<sp/>an<sp/>inconsistency<sp/>in<sp/>the<sp/>block<sp/>index,<sp/>but<sp/>if<sp/>we<sp/>clean</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3743"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>it<sp/>up<sp/>here,<sp/>this<sp/>should<sp/>be<sp/>an<sp/>essentially<sp/>unobservable<sp/>error.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3744"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Loop<sp/>back<sp/>over<sp/>all<sp/>block<sp/>index<sp/>entries<sp/>and<sp/>add<sp/>any<sp/>missing<sp/>entries</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3745"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>setBlockIndexCandidates.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3746"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>[<ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>,<sp/>block_index]<sp/>:<sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_block_index)<sp/>{</highlight></codeline>
<codeline lineno="3747"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(block_index.<ref refid="class_c_block_index_1a1b5a636925d1c416b9d59eb0392a7a62" kindref="member">IsValid</ref>(<ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada3eef30f876594ac79b888b7d1ff6c66c" kindref="member">BLOCK_VALID_TRANSACTIONS</ref>)<sp/>&amp;&amp;<sp/>block_index.<ref refid="class_c_block_index_1ae804dd1f9a78669920c2bc21dc7a9812" kindref="member">HaveNumChainTxs</ref>()<sp/>&amp;&amp;<sp/>!<ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.value_comp()(&amp;block_index,<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip()))<sp/>{</highlight></codeline>
<codeline lineno="3748"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.insert(&amp;block_index);</highlight></codeline>
<codeline lineno="3749"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3750"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3751"><highlight class="normal"></highlight></codeline>
<codeline lineno="3752"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1acd1f6fc8d7b53d55405ed6107ef693ad" kindref="member">InvalidChainFound</ref>(to_mark_failed);</highlight></codeline>
<codeline lineno="3753"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3754"><highlight class="normal"></highlight></codeline>
<codeline lineno="3755"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>notify<sp/>about<sp/>a<sp/>new<sp/>block<sp/>tip<sp/>if<sp/>the<sp/>active<sp/>chain<sp/>was<sp/>modified.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3756"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex_was_in_chain)<sp/>{</highlight></codeline>
<codeline lineno="3757"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ignoring<sp/>return<sp/>value<sp/>for<sp/>now,<sp/>this<sp/>could<sp/>be<sp/>changed<sp/>to<sp/>bubble<sp/>up</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3758"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>kernel::Interrupted<sp/>value<sp/>to<sp/>the<sp/>caller<sp/>so<sp/>the<sp/>caller<sp/>could</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3759"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>distinguish<sp/>between<sp/>completed<sp/>and<sp/>interrupted<sp/>operations.<sp/>It<sp/>might</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3760"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>also<sp/>make<sp/>sense<sp/>for<sp/>the<sp/>blockTip<sp/>notification<sp/>to<sp/>have<sp/>an<sp/>enum</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3761"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>parameter<sp/>indicating<sp/>the<sp/>source<sp/>of<sp/>the<sp/>tip<sp/>change<sp/>so<sp/>hooks<sp/>can</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3762"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>distinguish<sp/>user-initiated<sp/>invalidateblock<sp/>changes<sp/>from<sp/>other</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3763"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>changes.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3764"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(void)<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetNotifications().blockTip(</highlight></codeline>
<codeline lineno="3765"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*state=*/</highlight><highlight class="normal">GetSynchronizationState(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.IsInitialBlockDownload(),<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_blockman.m_blockfiles_indexed),</highlight></codeline>
<codeline lineno="3766"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*index=*/</highlight><highlight class="normal">*to_mark_failed-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>,</highlight></codeline>
<codeline lineno="3767"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*verification_progress=*/</highlight><highlight class="normal"><ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetMutex(),<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GuessVerificationProgress(to_mark_failed-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>)));</highlight></codeline>
<codeline lineno="3768"><highlight class="normal"></highlight></codeline>
<codeline lineno="3769"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Fire<sp/>ActiveTipChange<sp/>now<sp/>for<sp/>the<sp/>current<sp/>chain<sp/>tip<sp/>to<sp/>make<sp/>sure<sp/>clients<sp/>are<sp/>notified.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3770"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ActivateBestChain<sp/>may<sp/>call<sp/>this<sp/>as<sp/>well,<sp/>but<sp/>not<sp/>necessarily.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3771"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.signals)<sp/>{</highlight></codeline>
<codeline lineno="3772"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_options.signals-&gt;ActiveTipChange(*<ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip()),<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.IsInitialBlockDownload());</highlight></codeline>
<codeline lineno="3773"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3774"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3775"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3776"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3777"><highlight class="normal"></highlight></codeline>
<codeline lineno="3778"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>Chainstate::SetBlockFailureFlags(<ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>invalid_block)</highlight></codeline>
<codeline lineno="3779"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3780"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="3781"><highlight class="normal"></highlight></codeline>
<codeline lineno="3782"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>[<ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>,<sp/>block_index]<sp/>:<sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_block_index)<sp/>{</highlight></codeline>
<codeline lineno="3783"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(invalid_block<sp/>!=<sp/>&amp;block_index<sp/>&amp;&amp;<sp/>block_index.<ref refid="class_c_block_index_1ac20120d6b64792647a63d216b26e4b53" kindref="member">GetAncestor</ref>(invalid_block-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>)<sp/>==<sp/>invalid_block)<sp/>{</highlight></codeline>
<codeline lineno="3784"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>block_index.nStatus<sp/>=<sp/>(block_index.nStatus<sp/>&amp;<sp/>~BLOCK_FAILED_VALID)<sp/>|<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada8653dc31c354a84e6fd0be105889262f" kindref="member">BLOCK_FAILED_CHILD</ref>;</highlight></codeline>
<codeline lineno="3785"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_dirty_blockindex.insert(&amp;block_index);</highlight></codeline>
<codeline lineno="3786"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3787"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3788"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3789"><highlight class="normal"></highlight></codeline>
<codeline lineno="3790"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1aaa64fbfbe0e25889388c2782592a42ba" kindref="member">Chainstate::ResetBlockFailureFlags</ref>(<ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref><sp/>*pindex)<sp/>{</highlight></codeline>
<codeline lineno="3791"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="3792"><highlight class="normal"></highlight></codeline>
<codeline lineno="3793"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref><sp/>=<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>;</highlight></codeline>
<codeline lineno="3794"><highlight class="normal"></highlight></codeline>
<codeline lineno="3795"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Remove<sp/>the<sp/>invalidity<sp/>flag<sp/>from<sp/>this<sp/>block<sp/>and<sp/>all<sp/>its<sp/>descendants<sp/>and<sp/>ancestors.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3796"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>[<ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>,<sp/>block_index]<sp/>:<sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_block_index)<sp/>{</highlight></codeline>
<codeline lineno="3797"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((block_index.nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada88df51e92f2f675baff60e0a5bd170ef" kindref="member">BLOCK_FAILED_MASK</ref>)<sp/>&amp;&amp;<sp/>(block_index.<ref refid="class_c_block_index_1ac20120d6b64792647a63d216b26e4b53" kindref="member">GetAncestor</ref>(<ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref>)<sp/>==<sp/>pindex<sp/>||<sp/>pindex-&gt;<ref refid="class_c_block_index_1ac20120d6b64792647a63d216b26e4b53" kindref="member">GetAncestor</ref>(block_index.<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>)<sp/>==<sp/>&amp;block_index))<sp/>{</highlight></codeline>
<codeline lineno="3798"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>block_index.nStatus<sp/>&amp;=<sp/>~BLOCK_FAILED_MASK;</highlight></codeline>
<codeline lineno="3799"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_dirty_blockindex.insert(&amp;block_index);</highlight></codeline>
<codeline lineno="3800"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(block_index.<ref refid="class_c_block_index_1a1b5a636925d1c416b9d59eb0392a7a62" kindref="member">IsValid</ref>(<ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada3eef30f876594ac79b888b7d1ff6c66c" kindref="member">BLOCK_VALID_TRANSACTIONS</ref>)<sp/>&amp;&amp;<sp/>block_index.<ref refid="class_c_block_index_1ae804dd1f9a78669920c2bc21dc7a9812" kindref="member">HaveNumChainTxs</ref>()<sp/>&amp;&amp;<sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.value_comp()(<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip(),<sp/>&amp;block_index))<sp/>{</highlight></codeline>
<codeline lineno="3801"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.insert(&amp;block_index);</highlight></codeline>
<codeline lineno="3802"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3803"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(&amp;block_index<sp/>==<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_invalid)<sp/>{</highlight></codeline>
<codeline lineno="3804"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Reset<sp/>invalid<sp/>block<sp/>marker<sp/>if<sp/>it<sp/>was<sp/>pointing<sp/>to<sp/>one<sp/>of<sp/>those.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3805"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_invalid<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3806"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3807"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3808"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3809"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3810"><highlight class="normal"></highlight></codeline>
<codeline lineno="3811"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1ab86ef2ab974ae064997b910e161c4849" kindref="member">Chainstate::TryAddBlockIndexCandidate</ref>(<ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>pindex)</highlight></codeline>
<codeline lineno="3812"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3813"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="3814"><highlight class="normal"></highlight></codeline>
<codeline lineno="3815"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Do<sp/>not<sp/>continue<sp/>building<sp/>a<sp/>chainstate<sp/>that<sp/>is<sp/>based<sp/>on<sp/>an<sp/>invalid</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3816"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>snapshot.<sp/>This<sp/>is<sp/>a<sp/>belt-and-suspenders<sp/>type<sp/>of<sp/>check<sp/>because<sp/>if<sp/>an</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3817"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>invalid<sp/>snapshot<sp/>is<sp/>loaded,<sp/>the<sp/>node<sp/>will<sp/>shut<sp/>down<sp/>to<sp/>force<sp/>a<sp/>manual</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3818"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>intervention.<sp/>But<sp/>it<sp/>is<sp/>good<sp/>to<sp/>handle<sp/>this<sp/>case<sp/>correctly<sp/>regardless.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3819"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_assumeutxo<sp/>==<sp/><ref refid="validation_8h_1a6b7ed8f1aa31880e0db11fd5d379152daccc0377a8afbf50e7094f5c23a8af223" kindref="member">Assumeutxo::INVALID</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3820"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3821"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3822"><highlight class="normal"></highlight></codeline>
<codeline lineno="3823"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>block<sp/>only<sp/>is<sp/>a<sp/>candidate<sp/>for<sp/>the<sp/>most-work-chain<sp/>if<sp/>it<sp/>has<sp/>the<sp/>same</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3824"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>or<sp/>more<sp/>work<sp/>than<sp/>our<sp/>current<sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3825"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip()<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.value_comp()(pindex,<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip()))<sp/>{</highlight></codeline>
<codeline lineno="3826"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3827"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3828"><highlight class="normal"></highlight></codeline>
<codeline lineno="3829"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>target_block{TargetBlock()};</highlight></codeline>
<codeline lineno="3830"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!target_block)<sp/>{</highlight></codeline>
<codeline lineno="3831"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>no<sp/>specific<sp/>target<sp/>block,<sp/>add<sp/>all<sp/>entries<sp/>that<sp/>have<sp/>more</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3832"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>work<sp/>than<sp/>the<sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3833"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.insert(pindex);</highlight></codeline>
<codeline lineno="3834"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3835"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>there<sp/>is<sp/>a<sp/>target<sp/>block,<sp/>only<sp/>consider<sp/>connecting<sp/>blocks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3836"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>towards<sp/>the<sp/>target<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3837"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(target_block-&gt;<ref refid="class_c_block_index_1ac20120d6b64792647a63d216b26e4b53" kindref="member">GetAncestor</ref>(pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>)<sp/>==<sp/>pindex)<sp/>{</highlight></codeline>
<codeline lineno="3838"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.insert(pindex);</highlight></codeline>
<codeline lineno="3839"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3840"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3841"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3842"><highlight class="normal"></highlight></codeline>
<codeline lineno="3844"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager_1aacf45b730328d8aa968302758c45adf0" kindref="member">ChainstateManager::ReceivedBlockTransactions</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block" kindref="compound">CBlock</ref>&amp;<sp/>block,<sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>pindexNew,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_flat_file_pos" kindref="compound">FlatFilePos</ref>&amp;<sp/>pos)</highlight></codeline>
<codeline lineno="3845"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3846"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="3847"><highlight class="normal"><sp/><sp/><sp/><sp/>pindexNew-&gt;<ref refid="class_c_block_index_1aee88ed2678dfb8c29dbb1ad986c87bf4" kindref="member">nTx</ref><sp/>=<sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>.size();</highlight></codeline>
<codeline lineno="3848"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Typically<sp/>m_chain_tx_count<sp/>will<sp/>be<sp/>0<sp/>at<sp/>this<sp/>point,<sp/>but<sp/>it<sp/>can<sp/>be<sp/>nonzero<sp/>if<sp/>this</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3849"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>is<sp/>a<sp/>pruned<sp/>block<sp/>which<sp/>is<sp/>being<sp/>downloaded<sp/>again,<sp/>or<sp/>if<sp/>this<sp/>is<sp/>an</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3850"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>assumeutxo<sp/>snapshot<sp/>block<sp/>which<sp/>has<sp/>a<sp/>hardcoded<sp/>m_chain_tx_count<sp/>value<sp/>from<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3851"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>snapshot<sp/>metadata.<sp/>If<sp/>the<sp/>pindex<sp/>is<sp/>not<sp/>the<sp/>snapshot<sp/>block<sp/>and<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3852"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>m_chain_tx_count<sp/>value<sp/>is<sp/>not<sp/>zero,<sp/>assert<sp/>that<sp/>value<sp/>is<sp/>actually<sp/>correct.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3853"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>prev_tx_sum<sp/>=<sp/>[](CBlockIndex&amp;<sp/>block)<sp/>{<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>block.nTx<sp/>+<sp/>(block.pprev<sp/>?<sp/>block.pprev-&gt;m_chain_tx_count<sp/>:<sp/>0);<sp/>};</highlight></codeline>
<codeline lineno="3854"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(pindexNew-&gt;<ref refid="class_c_block_index_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref><sp/>==<sp/>0<sp/>||<sp/>pindexNew-&gt;<ref refid="class_c_block_index_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref><sp/>==<sp/>prev_tx_sum(*pindexNew)<sp/>||</highlight></codeline>
<codeline lineno="3855"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::ranges::any_of(m_chainstates,<sp/>[&amp;](</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/><ref refid="bench_2blockencodings_8cpp_1afe32161d594aa100f0733ae7096461ad" kindref="member">cs</ref>)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>)<sp/>{<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="bench_2blockencodings_8cpp_1afe32161d594aa100f0733ae7096461ad" kindref="member">cs</ref>-&gt;SnapshotBase()<sp/>==<sp/>pindexNew;<sp/>})))<sp/>{</highlight></codeline>
<codeline lineno="3856"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;Internal<sp/>bug<sp/>detected:<sp/>block<sp/>%d<sp/>has<sp/>unexpected<sp/>m_chain_tx_count<sp/>%i<sp/>that<sp/>should<sp/>be<sp/>%i<sp/>(%s<sp/>%s).<sp/>Please<sp/>report<sp/>this<sp/>issue<sp/>here:<sp/>%s\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3857"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexNew-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>pindexNew-&gt;<ref refid="class_c_block_index_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref>,<sp/>prev_tx_sum(*pindexNew),<sp/>CLIENT_NAME,<sp/><ref refid="clientversion_8cpp_1ac3e3098552063f228d9deac38a8b9848" kindref="member">FormatFullVersion</ref>(),<sp/>CLIENT_BUGREPORT);</highlight></codeline>
<codeline lineno="3858"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexNew-&gt;<ref refid="class_c_block_index_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="3859"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3860"><highlight class="normal"><sp/><sp/><sp/><sp/>pindexNew-&gt;nFile<sp/>=<sp/>pos.<ref refid="struct_flat_file_pos_1a2483833b586f09ac9ff431212bc85482" kindref="member">nFile</ref>;</highlight></codeline>
<codeline lineno="3861"><highlight class="normal"><sp/><sp/><sp/><sp/>pindexNew-&gt;nDataPos<sp/>=<sp/>pos.<ref refid="struct_flat_file_pos_1abb880bcadb3846a397e2420c4ee27d39" kindref="member">nPos</ref>;</highlight></codeline>
<codeline lineno="3862"><highlight class="normal"><sp/><sp/><sp/><sp/>pindexNew-&gt;nUndoPos<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="3863"><highlight class="normal"><sp/><sp/><sp/><sp/>pindexNew-&gt;nStatus<sp/>|=<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15" kindref="member">BLOCK_HAVE_DATA</ref>;</highlight></codeline>
<codeline lineno="3864"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="validation_8h_1ac799f78d8f44b330f7990a7eeb3071d2" kindref="member">DeploymentActiveAt</ref>(*pindexNew,<sp/>*</highlight><highlight class="keyword">this</highlight><highlight class="normal">,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dbac12a10e827db62556122f2b1a9b0431b" kindref="member">Consensus::DEPLOYMENT_SEGWIT</ref>))<sp/>{</highlight></codeline>
<codeline lineno="3865"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexNew-&gt;nStatus<sp/>|=<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93adabb5ecf540d50ee9d9f1846609d59caf5" kindref="member">BLOCK_OPT_WITNESS</ref>;</highlight></codeline>
<codeline lineno="3866"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3867"><highlight class="normal"><sp/><sp/><sp/><sp/>pindexNew-&gt;<ref refid="class_c_block_index_1a983fa688e7f3390832583f64fa36c319" kindref="member">RaiseValidity</ref>(<ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada3eef30f876594ac79b888b7d1ff6c66c" kindref="member">BLOCK_VALID_TRANSACTIONS</ref>);</highlight></codeline>
<codeline lineno="3868"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_dirty_blockindex.insert(pindexNew);</highlight></codeline>
<codeline lineno="3869"><highlight class="normal"></highlight></codeline>
<codeline lineno="3870"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexNew-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>||<sp/>pindexNew-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>-&gt;<ref refid="class_c_block_index_1ae804dd1f9a78669920c2bc21dc7a9812" kindref="member">HaveNumChainTxs</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3871"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>pindexNew<sp/>is<sp/>the<sp/>genesis<sp/>block<sp/>or<sp/>all<sp/>parents<sp/>are<sp/>BLOCK_VALID_TRANSACTIONS.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3872"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::deque&lt;CBlockIndex*&gt;<sp/>queue;</highlight></codeline>
<codeline lineno="3873"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>queue.push_back(pindexNew);</highlight></codeline>
<codeline lineno="3874"><highlight class="normal"></highlight></codeline>
<codeline lineno="3875"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Recursively<sp/>process<sp/>any<sp/>descendant<sp/>blocks<sp/>that<sp/>now<sp/>may<sp/>be<sp/>eligible<sp/>to<sp/>be<sp/>connected.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3876"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(!queue.empty())<sp/>{</highlight></codeline>
<codeline lineno="3877"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockIndex<sp/>*pindex<sp/>=<sp/>queue.front();</highlight></codeline>
<codeline lineno="3878"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>queue.pop_front();</highlight></codeline>
<codeline lineno="3879"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Before<sp/>setting<sp/>m_chain_tx_count,<sp/>assert<sp/>that<sp/>it<sp/>is<sp/>0<sp/>or<sp/>already<sp/>set<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3880"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>correct<sp/>value.<sp/>This<sp/>assert<sp/>will<sp/>fail<sp/>after<sp/>receiving<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3881"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>assumeutxo<sp/>snapshot<sp/>block<sp/>if<sp/>assumeutxo<sp/>snapshot<sp/>metadata<sp/>has<sp/>an</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3882"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>incorrect<sp/>hardcoded<sp/>AssumeutxoData::m_chain_tx_count<sp/>value.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3883"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(pindex-&gt;<ref refid="class_c_block_index_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref><sp/>==<sp/>0<sp/>||<sp/>pindex-&gt;<ref refid="class_c_block_index_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref><sp/>==<sp/>prev_tx_sum(*pindex)))<sp/>{</highlight></codeline>
<codeline lineno="3884"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;Internal<sp/>bug<sp/>detected:<sp/>block<sp/>%d<sp/>has<sp/>unexpected<sp/>m_chain_tx_count<sp/>%i<sp/>that<sp/>should<sp/>be<sp/>%i<sp/>(%s<sp/>%s).<sp/>Please<sp/>report<sp/>this<sp/>issue<sp/>here:<sp/>%s\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3885"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>pindex-&gt;<ref refid="class_c_block_index_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref>,<sp/>prev_tx_sum(*pindex),<sp/>CLIENT_NAME,<sp/><ref refid="clientversion_8cpp_1ac3e3098552063f228d9deac38a8b9848" kindref="member">FormatFullVersion</ref>(),<sp/>CLIENT_BUGREPORT);</highlight></codeline>
<codeline lineno="3886"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3887"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex-&gt;<ref refid="class_c_block_index_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref><sp/>=<sp/>prev_tx_sum(*pindex);</highlight></codeline>
<codeline lineno="3888"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex-&gt;<ref refid="class_c_block_index_1af095a0efd0b6a7cd78057bbb023a01f7" kindref="member">nSequenceId</ref><sp/>=<sp/>nBlockSequenceId++;</highlight></codeline>
<codeline lineno="3889"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>c<sp/>:<sp/>m_chainstates)<sp/>{</highlight></codeline>
<codeline lineno="3890"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>c-&gt;TryAddBlockIndexCandidate(pindex);</highlight></codeline>
<codeline lineno="3891"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3892"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::pair&lt;std::multimap&lt;CBlockIndex*,<sp/>CBlockIndex*&gt;::iterator,<sp/>std::multimap&lt;CBlockIndex*,<sp/>CBlockIndex*&gt;::iterator&gt;<sp/>range<sp/>=<sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_blocks_unlinked.equal_range(pindex);</highlight></codeline>
<codeline lineno="3893"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(range.first<sp/>!=<sp/>range.second)<sp/>{</highlight></codeline>
<codeline lineno="3894"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::multimap&lt;CBlockIndex*,<sp/>CBlockIndex*&gt;::iterator<sp/>it<sp/>=<sp/>range.first;</highlight></codeline>
<codeline lineno="3895"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>queue.push_back(it-&gt;second);</highlight></codeline>
<codeline lineno="3896"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>range.first++;</highlight></codeline>
<codeline lineno="3897"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_blocks_unlinked.erase(it);</highlight></codeline>
<codeline lineno="3898"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3899"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3900"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3901"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexNew-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>&amp;&amp;<sp/>pindexNew-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>-&gt;<ref refid="class_c_block_index_1a1b5a636925d1c416b9d59eb0392a7a62" kindref="member">IsValid</ref>(<ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada67f3a88eeb793cc62f427f87ae830573" kindref="member">BLOCK_VALID_TREE</ref>))<sp/>{</highlight></codeline>
<codeline lineno="3902"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_blocks_unlinked.insert(std::make_pair(pindexNew-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>,<sp/>pindexNew));</highlight></codeline>
<codeline lineno="3903"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3904"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3905"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3906"><highlight class="normal"></highlight></codeline>
<codeline lineno="3907"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CheckBlockHeader(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_header" kindref="compound">CBlockHeader</ref>&amp;<sp/>block,<sp/><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref>&amp;<sp/>state,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_consensus_1_1_params" kindref="compound">Consensus::Params</ref>&amp;<sp/>consensusParams,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fCheckPOW<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="3908"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3909"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>proof<sp/>of<sp/>work<sp/>matches<sp/>claimed<sp/>amount</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3910"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fCheckPOW<sp/>&amp;&amp;<sp/>!<ref refid="pow_8cpp_1a4e1129d7ab72643eb7e830f7f72953d7" kindref="member">CheckProofOfWork</ref>(block.<ref refid="class_c_block_header_1a6df30b63c4634d52dfeaadb46d60d0f5" kindref="member">GetHash</ref>(),<sp/>block.<ref refid="class_c_block_header_1a4c6ccf86c3f1822b41462dfdd9e4d927" kindref="member">nBits</ref>,<sp/>consensusParams))</highlight></codeline>
<codeline lineno="3911"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a5ba8236eb864c026cf09cd1d7d145bb9" kindref="member">BlockValidationResult::BLOCK_INVALID_HEADER</ref>,<sp/></highlight><highlight class="stringliteral">&quot;high-hash&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;proof<sp/>of<sp/>work<sp/>failed&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3912"><highlight class="normal"></highlight></codeline>
<codeline lineno="3913"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3914"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3915"><highlight class="normal"></highlight></codeline>
<codeline lineno="3916"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CheckMerkleRoot(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block" kindref="compound">CBlock</ref>&amp;<sp/>block,<sp/><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref>&amp;<sp/>state)</highlight></codeline>
<codeline lineno="3917"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3918"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(block.<ref refid="class_c_block_1afc2ec8c624b3a0d24f6e2a2849b683ea" kindref="member">m_checked_merkle_root</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3919"><highlight class="normal"></highlight></codeline>
<codeline lineno="3920"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>mutated;</highlight></codeline>
<codeline lineno="3921"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classuint256" kindref="compound">uint256</ref><sp/>merkle_root<sp/>=<sp/><ref refid="consensus_2merkle_8cpp_1aa6eda15268d7ec708195aed9b5d9eab3" kindref="member">BlockMerkleRoot</ref>(block,<sp/>&amp;mutated);</highlight></codeline>
<codeline lineno="3922"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(block.<ref refid="class_c_block_header_1ad808b8aaa74a38861020cfff705e2627" kindref="member">hashMerkleRoot</ref><sp/>!=<sp/>merkle_root)<sp/>{</highlight></codeline>
<codeline lineno="3923"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(</highlight></codeline>
<codeline lineno="3924"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*result=*/</highlight><highlight class="normal"><ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580aa74bec7838a1da98fe1e6e0620d31170" kindref="member">BlockValidationResult::BLOCK_MUTATED</ref>,</highlight></codeline>
<codeline lineno="3925"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*reject_reason=*/</highlight><highlight class="stringliteral">&quot;bad-txnmrklroot&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3926"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*debug_message=*/</highlight><highlight class="stringliteral">&quot;hashMerkleRoot<sp/>mismatch&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3927"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3928"><highlight class="normal"></highlight></codeline>
<codeline lineno="3929"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>for<sp/>merkle<sp/>tree<sp/>malleability<sp/>(CVE-2012-2459):<sp/>repeating<sp/>sequences</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3930"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>of<sp/>transactions<sp/>in<sp/>a<sp/>block<sp/>without<sp/>affecting<sp/>the<sp/>merkle<sp/>root<sp/>of<sp/>a<sp/>block,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3931"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>while<sp/>still<sp/>invalidating<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3932"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(mutated)<sp/>{</highlight></codeline>
<codeline lineno="3933"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(</highlight></codeline>
<codeline lineno="3934"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*result=*/</highlight><highlight class="normal"><ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580aa74bec7838a1da98fe1e6e0620d31170" kindref="member">BlockValidationResult::BLOCK_MUTATED</ref>,</highlight></codeline>
<codeline lineno="3935"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*reject_reason=*/</highlight><highlight class="stringliteral">&quot;bad-txns-duplicate&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3936"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*debug_message=*/</highlight><highlight class="stringliteral">&quot;duplicate<sp/>transaction&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3937"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3938"><highlight class="normal"></highlight></codeline>
<codeline lineno="3939"><highlight class="normal"><sp/><sp/><sp/><sp/>block.<ref refid="class_c_block_1afc2ec8c624b3a0d24f6e2a2849b683ea" kindref="member">m_checked_merkle_root</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3940"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3941"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3942"><highlight class="normal"></highlight></codeline>
<codeline lineno="3949"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CheckWitnessMalleation(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block" kindref="compound">CBlock</ref>&amp;<sp/>block,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>expect_witness_commitment,<sp/><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref>&amp;<sp/>state)</highlight></codeline>
<codeline lineno="3950"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3951"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(expect_witness_commitment)<sp/>{</highlight></codeline>
<codeline lineno="3952"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(block.<ref refid="class_c_block_1a407ab32f4d2cebb3da403e8c6729ac4d" kindref="member">m_checked_witness_commitment</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3953"><highlight class="normal"></highlight></codeline>
<codeline lineno="3954"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>commitpos<sp/>=<sp/><ref refid="consensus_2validation_8h_1ab56bfb1e9e2f9bf10d2595f6c85b3d2e" kindref="member">GetWitnessCommitmentIndex</ref>(block);</highlight></codeline>
<codeline lineno="3955"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(commitpos<sp/>!=<sp/>NO_WITNESS_COMMITMENT)<sp/>{</highlight></codeline>
<codeline lineno="3956"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>.empty()<sp/>&amp;&amp;<sp/>!block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>[0]-&gt;vin.empty());</highlight></codeline>
<codeline lineno="3957"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>witness_stack{block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>[0]-&gt;vin[0].scriptWitness.stack};</highlight></codeline>
<codeline lineno="3958"><highlight class="normal"></highlight></codeline>
<codeline lineno="3959"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(witness_stack.size()<sp/>!=<sp/>1<sp/>||<sp/>witness_stack[0].size()<sp/>!=<sp/>32)<sp/>{</highlight></codeline>
<codeline lineno="3960"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(</highlight></codeline>
<codeline lineno="3961"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*result=*/</highlight><highlight class="normal"><ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580aa74bec7838a1da98fe1e6e0620d31170" kindref="member">BlockValidationResult::BLOCK_MUTATED</ref>,</highlight></codeline>
<codeline lineno="3962"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*reject_reason=*/</highlight><highlight class="stringliteral">&quot;bad-witness-nonce-size&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3963"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*debug_message=*/</highlight><highlight class="normal"><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;%s<sp/>:<sp/>invalid<sp/>witness<sp/>reserved<sp/>value<sp/>size&quot;</highlight><highlight class="normal">,<sp/>__func__));</highlight></codeline>
<codeline lineno="3964"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3965"><highlight class="normal"></highlight></codeline>
<codeline lineno="3966"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>malleation<sp/>check<sp/>is<sp/>ignored;<sp/>as<sp/>the<sp/>transaction<sp/>tree<sp/>itself</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3967"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>already<sp/>does<sp/>not<sp/>permit<sp/>it,<sp/>it<sp/>is<sp/>impossible<sp/>to<sp/>trigger<sp/>in<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3968"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>witness<sp/>tree.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3969"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classuint256" kindref="compound">uint256</ref><sp/>hash_witness<sp/>=<sp/><ref refid="consensus_2merkle_8cpp_1afe9a0d574527f31931f7fb22402a3a6e" kindref="member">BlockWitnessMerkleRoot</ref>(block);</highlight></codeline>
<codeline lineno="3970"><highlight class="normal"></highlight></codeline>
<codeline lineno="3971"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_hash256" kindref="compound">CHash256</ref>().<ref refid="class_c_hash256_1a55ce1f7e95944f7201ea72eed67474fb" kindref="member">Write</ref>(hash_witness).<ref refid="class_c_hash256_1a55ce1f7e95944f7201ea72eed67474fb" kindref="member">Write</ref>(witness_stack[0]).<ref refid="class_c_hash256_1ac50f37df3204884174d0fccbdcbc7d1c" kindref="member">Finalize</ref>(hash_witness);</highlight></codeline>
<codeline lineno="3972"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(memcmp(hash_witness.<ref refid="classbase__blob_1a899a629fc7846994a3bbd28ba2777243" kindref="member">begin</ref>(),<sp/>&amp;block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>[0]-&gt;vout[commitpos].scriptPubKey[6],<sp/>32))<sp/>{</highlight></codeline>
<codeline lineno="3973"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(</highlight></codeline>
<codeline lineno="3974"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*result=*/</highlight><highlight class="normal"><ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580aa74bec7838a1da98fe1e6e0620d31170" kindref="member">BlockValidationResult::BLOCK_MUTATED</ref>,</highlight></codeline>
<codeline lineno="3975"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*reject_reason=*/</highlight><highlight class="stringliteral">&quot;bad-witness-merkle-match&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3976"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*debug_message=*/</highlight><highlight class="normal"><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;%s<sp/>:<sp/>witness<sp/>merkle<sp/>commitment<sp/>mismatch&quot;</highlight><highlight class="normal">,<sp/>__func__));</highlight></codeline>
<codeline lineno="3977"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3978"><highlight class="normal"></highlight></codeline>
<codeline lineno="3979"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>block.<ref refid="class_c_block_1a407ab32f4d2cebb3da403e8c6729ac4d" kindref="member">m_checked_witness_commitment</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3980"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3981"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3982"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3983"><highlight class="normal"></highlight></codeline>
<codeline lineno="3984"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>No<sp/>witness<sp/>data<sp/>is<sp/>allowed<sp/>in<sp/>blocks<sp/>that<sp/>don&apos;t<sp/>commit<sp/>to<sp/>witness<sp/>data,<sp/>as<sp/>this<sp/>would<sp/>otherwise<sp/>leave<sp/>room<sp/>for<sp/>spam</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3985"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tx<sp/>:<sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3986"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tx-&gt;<ref refid="class_c_transaction_1a084eb52f31fb8d373a622fcc0c66b206" kindref="member">HasWitness</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3987"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(</highlight></codeline>
<codeline lineno="3988"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*result=*/</highlight><highlight class="normal"><ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580aa74bec7838a1da98fe1e6e0620d31170" kindref="member">BlockValidationResult::BLOCK_MUTATED</ref>,</highlight></codeline>
<codeline lineno="3989"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*reject_reason=*/</highlight><highlight class="stringliteral">&quot;unexpected-witness&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3990"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*debug_message=*/</highlight><highlight class="normal"><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;%s<sp/>:<sp/>unexpected<sp/>witness<sp/>data<sp/>found&quot;</highlight><highlight class="normal">,<sp/>__func__));</highlight></codeline>
<codeline lineno="3991"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3992"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3993"><highlight class="normal"></highlight></codeline>
<codeline lineno="3994"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3995"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3996"><highlight class="normal"></highlight></codeline>
<codeline lineno="3997"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="validation_8cpp_1aac26467a10843087935711c71e43e184" kindref="member">CheckBlock</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block" kindref="compound">CBlock</ref>&amp;<sp/>block,<sp/><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref>&amp;<sp/>state,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_consensus_1_1_params" kindref="compound">Consensus::Params</ref>&amp;<sp/>consensusParams,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fCheckPOW,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fCheckMerkleRoot)</highlight></codeline>
<codeline lineno="3998"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3999"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>These<sp/>are<sp/>checks<sp/>that<sp/>are<sp/>independent<sp/>of<sp/>context.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4000"><highlight class="normal"></highlight></codeline>
<codeline lineno="4001"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(block.<ref refid="class_c_block_1ae9c4cf89ad31a48f097289b3660e3ddf" kindref="member">fChecked</ref>)</highlight></codeline>
<codeline lineno="4002"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4003"><highlight class="normal"></highlight></codeline>
<codeline lineno="4004"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>that<sp/>the<sp/>header<sp/>is<sp/>valid<sp/>(particularly<sp/>PoW).<sp/><sp/>This<sp/>is<sp/>mostly</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4005"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>redundant<sp/>with<sp/>the<sp/>call<sp/>in<sp/>AcceptBlockHeader.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4006"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!CheckBlockHeader(block,<sp/>state,<sp/>consensusParams,<sp/>fCheckPOW))</highlight></codeline>
<codeline lineno="4007"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4008"><highlight class="normal"></highlight></codeline>
<codeline lineno="4009"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Signet<sp/>only:<sp/>check<sp/>block<sp/>solution</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4010"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(consensusParams.<ref refid="struct_consensus_1_1_params_1aea567df1581667231d94add19504cb9f" kindref="member">signet_blocks</ref><sp/>&amp;&amp;<sp/>fCheckPOW<sp/>&amp;&amp;<sp/>!<ref refid="signet_8cpp_1a4cf8a2eba8b12de65e1d1e7e869b2f41" kindref="member">CheckSignetBlockSolution</ref>(block,<sp/>consensusParams))<sp/>{</highlight></codeline>
<codeline lineno="4011"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a6d95354aa8213c32922ccc6fa949befb" kindref="member">BlockValidationResult::BLOCK_CONSENSUS</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-signet-blksig&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;signet<sp/>block<sp/>signature<sp/>validation<sp/>failure&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4012"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4013"><highlight class="normal"></highlight></codeline>
<codeline lineno="4014"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>the<sp/>merkle<sp/>root.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4015"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fCheckMerkleRoot<sp/>&amp;&amp;<sp/>!CheckMerkleRoot(block,<sp/>state))<sp/>{</highlight></codeline>
<codeline lineno="4016"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4017"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4018"><highlight class="normal"></highlight></codeline>
<codeline lineno="4019"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>All<sp/>potential-corruption<sp/>validation<sp/>must<sp/>be<sp/>done<sp/>before<sp/>we<sp/>do<sp/>any</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4020"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transaction<sp/>validation,<sp/>as<sp/>otherwise<sp/>we<sp/>may<sp/>mark<sp/>the<sp/>header<sp/>as<sp/>invalid</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4021"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>because<sp/>we<sp/>receive<sp/>the<sp/>wrong<sp/>transactions<sp/>for<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4022"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note<sp/>that<sp/>witness<sp/>malleability<sp/>is<sp/>checked<sp/>in<sp/>ContextualCheckBlock,<sp/>so<sp/>no</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4023"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>checks<sp/>that<sp/>use<sp/>witness<sp/>data<sp/>may<sp/>be<sp/>performed<sp/>here.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4024"><highlight class="normal"></highlight></codeline>
<codeline lineno="4025"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Size<sp/>limits</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4026"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>.empty()<sp/>||<sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>.size()<sp/>*<sp/>WITNESS_SCALE_FACTOR<sp/>&gt;<sp/>MAX_BLOCK_WEIGHT<sp/>||<sp/><ref refid="serialize_8h_1ac0154eb0a74cc852efc55684de85b1f5" kindref="member">::GetSerializeSize</ref>(TX_NO_WITNESS(block))<sp/>*<sp/>WITNESS_SCALE_FACTOR<sp/>&gt;<sp/>MAX_BLOCK_WEIGHT)</highlight></codeline>
<codeline lineno="4027"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a6d95354aa8213c32922ccc6fa949befb" kindref="member">BlockValidationResult::BLOCK_CONSENSUS</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-blk-length&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;size<sp/>limits<sp/>failed&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4028"><highlight class="normal"></highlight></codeline>
<codeline lineno="4029"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>First<sp/>transaction<sp/>must<sp/>be<sp/>coinbase,<sp/>the<sp/>rest<sp/>must<sp/>not<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4030"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>.empty()<sp/>||<sp/>!block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>[0]-&gt;IsCoinBase())</highlight></codeline>
<codeline lineno="4031"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a6d95354aa8213c32922ccc6fa949befb" kindref="member">BlockValidationResult::BLOCK_CONSENSUS</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-cb-missing&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;first<sp/>tx<sp/>is<sp/>not<sp/>coinbase&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4032"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>1;<sp/>i<sp/>&lt;<sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>.size();<sp/>i++)</highlight></codeline>
<codeline lineno="4033"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>[i]-&gt;IsCoinBase())</highlight></codeline>
<codeline lineno="4034"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a6d95354aa8213c32922ccc6fa949befb" kindref="member">BlockValidationResult::BLOCK_CONSENSUS</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-cb-multiple&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;more<sp/>than<sp/>one<sp/>coinbase&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4035"><highlight class="normal"></highlight></codeline>
<codeline lineno="4036"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>transactions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4037"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Must<sp/>check<sp/>for<sp/>duplicate<sp/>inputs<sp/>(see<sp/>CVE-2018-17144)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4038"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tx<sp/>:<sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4039"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_tx_validation_state" kindref="compound">TxValidationState</ref><sp/>tx_state;</highlight></codeline>
<codeline lineno="4040"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="tx__check_8cpp_1ac015dec2b8cac7f01b1f53b78a80d854" kindref="member">CheckTransaction</ref>(*tx,<sp/>tx_state))<sp/>{</highlight></codeline>
<codeline lineno="4041"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>CheckBlock()<sp/>does<sp/>context-free<sp/>validation<sp/>checks.<sp/>The<sp/>only</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4042"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>possible<sp/>failures<sp/>are<sp/>consensus<sp/>failures.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4043"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(tx_state.<ref refid="class_validation_state_1a1b98c7dab961aab90e13b3f3f9fcf52d" kindref="member">GetResult</ref>()<sp/>==<sp/><ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fad623c6a3361887cbd2cf1fe3c2bfb261" kindref="member">TxValidationResult::TX_CONSENSUS</ref>);</highlight></codeline>
<codeline lineno="4044"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a6d95354aa8213c32922ccc6fa949befb" kindref="member">BlockValidationResult::BLOCK_CONSENSUS</ref>,<sp/>tx_state.<ref refid="class_validation_state_1a5fef80db1db0007a9082aa7d104e2933" kindref="member">GetRejectReason</ref>(),</highlight></codeline>
<codeline lineno="4045"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;Transaction<sp/>check<sp/>failed<sp/>(tx<sp/>hash<sp/>%s)<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>tx-&gt;<ref refid="class_c_transaction_1a919ff1093793433f4717d74fb751423b" kindref="member">GetHash</ref>().<ref refid="classtransaction__identifier_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>(),<sp/>tx_state.<ref refid="class_validation_state_1ac444b5235f12cdc04292ab64fe44226b" kindref="member">GetDebugMessage</ref>()));</highlight></codeline>
<codeline lineno="4046"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4047"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4048"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>underestimates<sp/>the<sp/>number<sp/>of<sp/>sigops,<sp/>because<sp/>unlike<sp/>ConnectBlock<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4049"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>does<sp/>not<sp/>count<sp/>witness<sp/>and<sp/>p2sh<sp/>sigops.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4050"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nSigOps<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="4051"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tx<sp/>:<sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>)</highlight></codeline>
<codeline lineno="4052"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4053"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nSigOps<sp/>+=<sp/><ref refid="tx__verify_8cpp_1ad2eaf4f8542c12ea9ee1183609cc6d1a" kindref="member">GetLegacySigOpCount</ref>(*tx);</highlight></codeline>
<codeline lineno="4054"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4055"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nSigOps<sp/>*<sp/>WITNESS_SCALE_FACTOR<sp/>&gt;<sp/>MAX_BLOCK_SIGOPS_COST)</highlight></codeline>
<codeline lineno="4056"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a6d95354aa8213c32922ccc6fa949befb" kindref="member">BlockValidationResult::BLOCK_CONSENSUS</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-blk-sigops&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;out-of-bounds<sp/>SigOpCount&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4057"><highlight class="normal"></highlight></codeline>
<codeline lineno="4058"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fCheckPOW<sp/>&amp;&amp;<sp/>fCheckMerkleRoot)</highlight></codeline>
<codeline lineno="4059"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>block.<ref refid="class_c_block_1ae9c4cf89ad31a48f097289b3660e3ddf" kindref="member">fChecked</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4060"><highlight class="normal"></highlight></codeline>
<codeline lineno="4061"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4062"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4063"><highlight class="normal"></highlight></codeline>
<codeline lineno="4064"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager_1ab221269ee84206666a6cf6d27a9c25fc" kindref="member">ChainstateManager::UpdateUncommittedBlockStructures</ref>(<ref refid="class_c_block" kindref="compound">CBlock</ref>&amp;<sp/>block,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>pindexPrev)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="4065"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="4066"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>commitpos<sp/>=<sp/><ref refid="consensus_2validation_8h_1ab56bfb1e9e2f9bf10d2595f6c85b3d2e" kindref="member">GetWitnessCommitmentIndex</ref>(block);</highlight></codeline>
<codeline lineno="4067"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;unsigned<sp/>char&gt;<sp/><ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref>(32,<sp/>0x00);</highlight></codeline>
<codeline lineno="4068"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(commitpos<sp/>!=<sp/>NO_WITNESS_COMMITMENT<sp/>&amp;&amp;<sp/><ref refid="validation_8h_1a617ed441b6101875308a8fb4e0806877" kindref="member">DeploymentActiveAfter</ref>(pindexPrev,<sp/>*</highlight><highlight class="keyword">this</highlight><highlight class="normal">,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dbac12a10e827db62556122f2b1a9b0431b" kindref="member">Consensus::DEPLOYMENT_SEGWIT</ref>)<sp/>&amp;&amp;<sp/>!block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>[0]-&gt;HasWitness())<sp/>{</highlight></codeline>
<codeline lineno="4069"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CMutableTransaction<sp/>tx(*block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>[0]);</highlight></codeline>
<codeline lineno="4070"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>[0].scriptWitness.stack.resize(1);</highlight></codeline>
<codeline lineno="4071"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx.<ref refid="class_c_transaction_1aaed1b4913ffce3eaaf4c5e13aa09d27f" kindref="member">vin</ref>[0].scriptWitness.stack[0]<sp/>=<sp/><ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref>;</highlight></codeline>
<codeline lineno="4072"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>[0]<sp/>=<sp/>MakeTransactionRef(std::move(tx));</highlight></codeline>
<codeline lineno="4073"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4074"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4075"><highlight class="normal"></highlight></codeline>
<codeline lineno="4076"><highlight class="normal">std::vector&lt;unsigned<sp/>char&gt;<sp/><ref refid="class_chainstate_manager_1a4f87fc79002ca74320f13bcc7b709f3b" kindref="member">ChainstateManager::GenerateCoinbaseCommitment</ref>(<ref refid="class_c_block" kindref="compound">CBlock</ref>&amp;<sp/>block,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>pindexPrev)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="4077"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="4078"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;unsigned<sp/>char&gt;<sp/>commitment;</highlight></codeline>
<codeline lineno="4079"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>commitpos<sp/>=<sp/><ref refid="consensus_2validation_8h_1ab56bfb1e9e2f9bf10d2595f6c85b3d2e" kindref="member">GetWitnessCommitmentIndex</ref>(block);</highlight></codeline>
<codeline lineno="4080"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;unsigned<sp/>char&gt;<sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>(32,<sp/>0x00);</highlight></codeline>
<codeline lineno="4081"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(commitpos<sp/>==<sp/>NO_WITNESS_COMMITMENT)<sp/>{</highlight></codeline>
<codeline lineno="4082"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint256<sp/>witnessroot<sp/>=<sp/><ref refid="consensus_2merkle_8cpp_1afe9a0d574527f31931f7fb22402a3a6e" kindref="member">BlockWitnessMerkleRoot</ref>(block);</highlight></codeline>
<codeline lineno="4083"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CHash256().Write(witnessroot).Write(<ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>).Finalize(witnessroot);</highlight></codeline>
<codeline lineno="4084"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CTxOut<sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>;</highlight></codeline>
<codeline lineno="4085"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>.nValue<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="4086"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>.scriptPubKey.resize(MINIMUM_WITNESS_COMMITMENT);</highlight></codeline>
<codeline lineno="4087"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>.scriptPubKey[0]<sp/>=<sp/><ref refid="script_2script_8h_1a63e349a6089a54da9fe09a3d858648bdad436c18b194473f5ec64c28b774e41b3" kindref="member">OP_RETURN</ref>;</highlight></codeline>
<codeline lineno="4088"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>.scriptPubKey[1]<sp/>=<sp/>0x24;</highlight></codeline>
<codeline lineno="4089"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>.scriptPubKey[2]<sp/>=<sp/>0xaa;</highlight></codeline>
<codeline lineno="4090"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>.scriptPubKey[3]<sp/>=<sp/>0x21;</highlight></codeline>
<codeline lineno="4091"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>.scriptPubKey[4]<sp/>=<sp/>0xa9;</highlight></codeline>
<codeline lineno="4092"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>.scriptPubKey[5]<sp/>=<sp/>0xed;</highlight></codeline>
<codeline lineno="4093"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>memcpy(&amp;<ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>.scriptPubKey[6],<sp/>witnessroot.<ref refid="classbase__blob_1a899a629fc7846994a3bbd28ba2777243" kindref="member">begin</ref>(),<sp/>32);</highlight></codeline>
<codeline lineno="4094"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>commitment<sp/>=<sp/>std::vector&lt;unsigned<sp/>char&gt;(<ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>.scriptPubKey.begin(),<sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a4402d36d1c85ad1e0bdccb05af4d417f" kindref="member">out</ref>.scriptPubKey.end());</highlight></codeline>
<codeline lineno="4095"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CMutableTransaction<sp/>tx(*block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>[0]);</highlight></codeline>
<codeline lineno="4096"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx.<ref refid="class_c_transaction_1ab6db6ccb0e8e9a2442296af044a29d56" kindref="member">vout</ref>.push_back(out);</highlight></codeline>
<codeline lineno="4097"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>[0]<sp/>=<sp/>MakeTransactionRef(std::move(tx));</highlight></codeline>
<codeline lineno="4098"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4099"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1ab221269ee84206666a6cf6d27a9c25fc" kindref="member">UpdateUncommittedBlockStructures</ref>(block,<sp/>pindexPrev);</highlight></codeline>
<codeline lineno="4100"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>commitment;</highlight></codeline>
<codeline lineno="4101"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4102"><highlight class="normal"></highlight></codeline>
<codeline lineno="4103"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="validation_8cpp_1a600cde3b7d04dc488eec00d290931db7" kindref="member">HasValidProofOfWork</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;CBlockHeader&gt;&amp;<sp/>headers,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_consensus_1_1_params" kindref="compound">Consensus::Params</ref>&amp;<sp/>consensusParams)</highlight></codeline>
<codeline lineno="4104"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4105"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::all_of(headers.cbegin(),<sp/>headers.cend(),</highlight></codeline>
<codeline lineno="4106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[&amp;](</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>header)<sp/>{<sp/>return<sp/>CheckProofOfWork(header.GetHash(),<sp/>header.nBits,<sp/>consensusParams);});</highlight></codeline>
<codeline lineno="4107"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4108"><highlight class="normal"></highlight></codeline>
<codeline lineno="4109"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="validation_8cpp_1a10bb051c7f669d2bea4c37e6b6d3ed5c" kindref="member">IsBlockMutated</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block" kindref="compound">CBlock</ref>&amp;<sp/>block,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>check_witness_root)</highlight></codeline>
<codeline lineno="4110"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4111"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref><sp/>state;</highlight></codeline>
<codeline lineno="4112"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!CheckMerkleRoot(block,<sp/>state))<sp/>{</highlight></codeline>
<codeline lineno="4113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a7721bbfbdf88038c07a667176e9ab22c" kindref="member">BCLog::VALIDATION</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Block<sp/>mutated:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4115"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4116"><highlight class="normal"></highlight></codeline>
<codeline lineno="4117"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>.empty()<sp/>||<sp/>!block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>[0]-&gt;IsCoinBase())<sp/>{</highlight></codeline>
<codeline lineno="4118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Consider<sp/>the<sp/>block<sp/>mutated<sp/>if<sp/>any<sp/>transaction<sp/>is<sp/>64<sp/>bytes<sp/>in<sp/>size<sp/>(see<sp/>3.1</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>in<sp/>&quot;Weaknesses<sp/>in<sp/>Bitcoins<sp/>Merkle<sp/>Root<sp/>Construction&quot;:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>https://lists.linuxfoundation.org/pipermail/bitcoin-dev/attachments/20190225/a27d8837/attachment-0001.pdf).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4122"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note:<sp/>This<sp/>is<sp/>not<sp/>a<sp/>consensus<sp/>change<sp/>as<sp/>this<sp/>only<sp/>applies<sp/>to<sp/>blocks<sp/>that</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>don&apos;t<sp/>have<sp/>a<sp/>coinbase<sp/>transaction<sp/>and<sp/>would<sp/>therefore<sp/>already<sp/>be<sp/>invalid.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::any_of(block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>.begin(),<sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>.end(),</highlight></codeline>
<codeline lineno="4125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[](</highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tx)<sp/>{<sp/>return<sp/>GetSerializeSize(TX_NO_WITNESS(tx))<sp/>==<sp/>64;<sp/>});</highlight></codeline>
<codeline lineno="4126"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Theoretically<sp/>it<sp/>is<sp/>still<sp/>possible<sp/>for<sp/>a<sp/>block<sp/>with<sp/>a<sp/>64<sp/>byte</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>coinbase<sp/>transaction<sp/>to<sp/>be<sp/>mutated<sp/>but<sp/>we<sp/>neglect<sp/>that<sp/>possibility</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4129"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>here<sp/>as<sp/>it<sp/>requires<sp/>at<sp/>least<sp/>224<sp/>bits<sp/>of<sp/>work.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4130"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4131"><highlight class="normal"></highlight></codeline>
<codeline lineno="4132"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!CheckWitnessMalleation(block,<sp/>check_witness_root,<sp/>state))<sp/>{</highlight></codeline>
<codeline lineno="4133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a7721bbfbdf88038c07a667176e9ab22c" kindref="member">BCLog::VALIDATION</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Block<sp/>mutated:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4135"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4136"><highlight class="normal"></highlight></codeline>
<codeline lineno="4137"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4138"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4139"><highlight class="normal"></highlight></codeline>
<codeline lineno="4140"><highlight class="normal"><ref refid="classarith__uint256" kindref="compound">arith_uint256</ref><sp/><ref refid="validation_8cpp_1a805faf00f329288736b407376d6edb7a" kindref="member">CalculateClaimedHeadersWork</ref>(std::span&lt;const<sp/>CBlockHeader&gt;<sp/>headers)</highlight></codeline>
<codeline lineno="4141"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4142"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classarith__uint256" kindref="compound">arith_uint256</ref><sp/>total_work{0};</highlight></codeline>
<codeline lineno="4143"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_header" kindref="compound">CBlockHeader</ref>&amp;<sp/>header<sp/>:<sp/>headers)<sp/>{</highlight></codeline>
<codeline lineno="4144"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref><sp/>dummy(header);</highlight></codeline>
<codeline lineno="4145"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>total_work<sp/>+=<sp/><ref refid="chain_8cpp_1a334aa8015cc7185f7fdf484783e40f38" kindref="member">GetBlockProof</ref>(dummy);</highlight></codeline>
<codeline lineno="4146"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4147"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>total_work;</highlight></codeline>
<codeline lineno="4148"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4149"><highlight class="normal"></highlight></codeline>
<codeline lineno="4163"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>ContextualCheckBlockHeader(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_header" kindref="compound">CBlockHeader</ref>&amp;<sp/>block,<sp/><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref>&amp;<sp/>state,<sp/><ref refid="classnode_1_1_block_manager" kindref="compound">BlockManager</ref>&amp;<sp/>blockman,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager" kindref="compound">ChainstateManager</ref>&amp;<sp/>chainman,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>pindexPrev)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>)</highlight></codeline>
<codeline lineno="4164"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4165"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="4166"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindexPrev<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4167"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref><sp/>=<sp/>pindexPrev-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="4168"><highlight class="normal"></highlight></codeline>
<codeline lineno="4169"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>proof<sp/>of<sp/>work</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4170"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_consensus_1_1_params" kindref="compound">Consensus::Params</ref>&amp;<sp/>consensusParams<sp/>=<sp/>chainman.<ref refid="class_chainstate_manager_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>();</highlight></codeline>
<codeline lineno="4171"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(block.<ref refid="class_c_block_header_1a4c6ccf86c3f1822b41462dfdd9e4d927" kindref="member">nBits</ref><sp/>!=<sp/><ref refid="pow_8cpp_1a444323ddc75c2b90f484fa9b9da31dc8" kindref="member">GetNextWorkRequired</ref>(pindexPrev,<sp/>&amp;block,<sp/>consensusParams))</highlight></codeline>
<codeline lineno="4172"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a5ba8236eb864c026cf09cd1d7d145bb9" kindref="member">BlockValidationResult::BLOCK_INVALID_HEADER</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-diffbits&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;incorrect<sp/>proof<sp/>of<sp/>work&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4173"><highlight class="normal"></highlight></codeline>
<codeline lineno="4174"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>timestamp<sp/>against<sp/>prev</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4175"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(block.<ref refid="class_c_block_header_1a7aea61ae131a8b7b934f8b3a758d9490" kindref="member">GetBlockTime</ref>()<sp/>&lt;=<sp/>pindexPrev-&gt;<ref refid="class_c_block_index_1a11dfc5fcb174cc0d9fab58f7106abcfb" kindref="member">GetMedianTimePast</ref>())</highlight></codeline>
<codeline lineno="4176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a5ba8236eb864c026cf09cd1d7d145bb9" kindref="member">BlockValidationResult::BLOCK_INVALID_HEADER</ref>,<sp/></highlight><highlight class="stringliteral">&quot;time-too-old&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;block&apos;s<sp/>timestamp<sp/>is<sp/>too<sp/>early&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4177"><highlight class="normal"></highlight></codeline>
<codeline lineno="4178"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Testnet4<sp/>and<sp/>regtest<sp/>only:<sp/>Check<sp/>timestamp<sp/>against<sp/>prev<sp/>for<sp/>difficulty-adjustment</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4179"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>blocks<sp/>to<sp/>prevent<sp/>timewarp<sp/>attacks<sp/>(see<sp/>https://github.com/bitcoin/bitcoin/pull/15482).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4180"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(consensusParams.<ref refid="struct_consensus_1_1_params_1aa977cde66242567006060a24bfdd0872" kindref="member">enforce_BIP94</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4181"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>timestamp<sp/>for<sp/>the<sp/>first<sp/>block<sp/>of<sp/>each<sp/>difficulty<sp/>adjustment</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4182"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>interval,<sp/>except<sp/>the<sp/>genesis<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4183"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref><sp/>%<sp/>consensusParams.<ref refid="struct_consensus_1_1_params_1a81edb4d1117f29766ecdcba679b4528a" kindref="member">DifficultyAdjustmentInterval</ref>()<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="4184"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(block.<ref refid="class_c_block_header_1a7aea61ae131a8b7b934f8b3a758d9490" kindref="member">GetBlockTime</ref>()<sp/>&lt;<sp/>pindexPrev-&gt;<ref refid="class_c_block_index_1a7aea61ae131a8b7b934f8b3a758d9490" kindref="member">GetBlockTime</ref>()<sp/>-<sp/>MAX_TIMEWARP)<sp/>{</highlight></codeline>
<codeline lineno="4185"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a5ba8236eb864c026cf09cd1d7d145bb9" kindref="member">BlockValidationResult::BLOCK_INVALID_HEADER</ref>,<sp/></highlight><highlight class="stringliteral">&quot;time-timewarp-attack&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;block&apos;s<sp/>timestamp<sp/>is<sp/>too<sp/>early<sp/>on<sp/>diff<sp/>adjustment<sp/>block&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4188"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4189"><highlight class="normal"></highlight></codeline>
<codeline lineno="4190"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>timestamp</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4191"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(block.<ref refid="class_c_block_header_1a9ddce75b363526132a7d7fc78e8630d4" kindref="member">Time</ref>()<sp/>&gt;<sp/><ref refid="struct_node_clock_1a1be2fa9903731211253f2e36b5f3b584" kindref="member">NodeClock::now</ref>()<sp/>+<sp/>std::chrono::seconds{MAX_FUTURE_BLOCK_TIME})<sp/>{</highlight></codeline>
<codeline lineno="4192"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580aaec42241441df64f66774cd2cc142830" kindref="member">BlockValidationResult::BLOCK_TIME_FUTURE</ref>,<sp/></highlight><highlight class="stringliteral">&quot;time-too-new&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;block<sp/>timestamp<sp/>too<sp/>far<sp/>in<sp/>the<sp/>future&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4193"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4194"><highlight class="normal"></highlight></codeline>
<codeline lineno="4195"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Reject<sp/>blocks<sp/>with<sp/>outdated<sp/>version</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4196"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((block.<ref refid="class_c_block_header_1ac783e91ed47adc28b2a27ffea4b7f484" kindref="member">nVersion</ref><sp/>&lt;<sp/>2<sp/>&amp;&amp;<sp/><ref refid="deploymentstatus_8h_1a0f9c7fc832b34b673ebfeadaffc86182" kindref="member">DeploymentActiveAfter</ref>(pindexPrev,<sp/>chainman,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dba99997a58f5d1d2f6f03d2384ce423eaa" kindref="member">Consensus::DEPLOYMENT_HEIGHTINCB</ref>))<sp/>||</highlight></codeline>
<codeline lineno="4197"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(block.<ref refid="class_c_block_header_1ac783e91ed47adc28b2a27ffea4b7f484" kindref="member">nVersion</ref><sp/>&lt;<sp/>3<sp/>&amp;&amp;<sp/><ref refid="deploymentstatus_8h_1a0f9c7fc832b34b673ebfeadaffc86182" kindref="member">DeploymentActiveAfter</ref>(pindexPrev,<sp/>chainman,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dba9b198a4567631e6d680f681323e5f570" kindref="member">Consensus::DEPLOYMENT_DERSIG</ref>))<sp/>||</highlight></codeline>
<codeline lineno="4198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(block.<ref refid="class_c_block_header_1ac783e91ed47adc28b2a27ffea4b7f484" kindref="member">nVersion</ref><sp/>&lt;<sp/>4<sp/>&amp;&amp;<sp/><ref refid="deploymentstatus_8h_1a0f9c7fc832b34b673ebfeadaffc86182" kindref="member">DeploymentActiveAfter</ref>(pindexPrev,<sp/>chainman,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dbab075214b98f7a132f0d5a1eba5c7532a" kindref="member">Consensus::DEPLOYMENT_CLTV</ref>)))<sp/>{</highlight></codeline>
<codeline lineno="4199"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a5ba8236eb864c026cf09cd1d7d145bb9" kindref="member">BlockValidationResult::BLOCK_INVALID_HEADER</ref>,<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;bad-version(0x%08x)&quot;</highlight><highlight class="normal">,<sp/>block.<ref refid="class_c_block_header_1ac783e91ed47adc28b2a27ffea4b7f484" kindref="member">nVersion</ref>),</highlight></codeline>
<codeline lineno="4200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;rejected<sp/>nVersion=0x%08x<sp/>block&quot;</highlight><highlight class="normal">,<sp/>block.<ref refid="class_c_block_header_1ac783e91ed47adc28b2a27ffea4b7f484" kindref="member">nVersion</ref>));</highlight></codeline>
<codeline lineno="4201"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4202"><highlight class="normal"></highlight></codeline>
<codeline lineno="4203"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4204"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4205"><highlight class="normal"></highlight></codeline>
<codeline lineno="4212"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>ContextualCheckBlock(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block" kindref="compound">CBlock</ref>&amp;<sp/>block,<sp/><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref>&amp;<sp/>state,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager" kindref="compound">ChainstateManager</ref>&amp;<sp/>chainman,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>pindexPrev)</highlight></codeline>
<codeline lineno="4213"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4214"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref><sp/>=<sp/>pindexPrev<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>?<sp/>0<sp/>:<sp/>pindexPrev-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="4215"><highlight class="normal"></highlight></codeline>
<codeline lineno="4216"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Enforce<sp/>BIP113<sp/>(Median<sp/>Time<sp/>Past).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4217"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>enforce_locktime_median_time_past{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="4218"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="deploymentstatus_8h_1a0f9c7fc832b34b673ebfeadaffc86182" kindref="member">DeploymentActiveAfter</ref>(pindexPrev,<sp/>chainman,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dba16355a4f6631092993cd03be7f3d036e" kindref="member">Consensus::DEPLOYMENT_CSV</ref>))<sp/>{</highlight></codeline>
<codeline lineno="4219"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindexPrev<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>enforce_locktime_median_time_past<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4221"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4222"><highlight class="normal"></highlight></codeline>
<codeline lineno="4223"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>int64_t<sp/>nLockTimeCutoff{enforce_locktime_median_time_past<sp/>?</highlight></codeline>
<codeline lineno="4224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexPrev-&gt;<ref refid="class_c_block_index_1a11dfc5fcb174cc0d9fab58f7106abcfb" kindref="member">GetMedianTimePast</ref>()<sp/>:</highlight></codeline>
<codeline lineno="4225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>block.<ref refid="class_c_block_header_1a7aea61ae131a8b7b934f8b3a758d9490" kindref="member">GetBlockTime</ref>()};</highlight></codeline>
<codeline lineno="4226"><highlight class="normal"></highlight></codeline>
<codeline lineno="4227"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>that<sp/>all<sp/>transactions<sp/>are<sp/>finalized</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4228"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tx<sp/>:<sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="tx__verify_8cpp_1adc332cd7ac94e639bb4239618341be19" kindref="member">IsFinalTx</ref>(*tx,<sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref>,<sp/>nLockTimeCutoff))<sp/>{</highlight></codeline>
<codeline lineno="4230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a6d95354aa8213c32922ccc6fa949befb" kindref="member">BlockValidationResult::BLOCK_CONSENSUS</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-txns-nonfinal&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;non-final<sp/>transaction&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4231"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4232"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4233"><highlight class="normal"></highlight></codeline>
<codeline lineno="4234"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Enforce<sp/>rule<sp/>that<sp/>the<sp/>coinbase<sp/>starts<sp/>with<sp/>serialized<sp/>block<sp/>height</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4235"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="deploymentstatus_8h_1a0f9c7fc832b34b673ebfeadaffc86182" kindref="member">DeploymentActiveAfter</ref>(pindexPrev,<sp/>chainman,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dba99997a58f5d1d2f6f03d2384ce423eaa" kindref="member">Consensus::DEPLOYMENT_HEIGHTINCB</ref>))</highlight></codeline>
<codeline lineno="4236"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_script" kindref="compound">CScript</ref><sp/><ref refid="univalue__read_8cpp_1a60f00f16962a44ea92afc6460168986c" kindref="member">expect</ref><sp/>=<sp/><ref refid="class_c_script" kindref="compound">CScript</ref>()<sp/>&lt;&lt;<sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref>;</highlight></codeline>
<codeline lineno="4238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>[0]-&gt;vin[0].scriptSig.size()<sp/>&lt;<sp/><ref refid="univalue__read_8cpp_1a60f00f16962a44ea92afc6460168986c" kindref="member">expect</ref>.size()<sp/>||</highlight></codeline>
<codeline lineno="4239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!std::equal(<ref refid="univalue__read_8cpp_1a60f00f16962a44ea92afc6460168986c" kindref="member">expect</ref>.begin(),<sp/><ref refid="univalue__read_8cpp_1a60f00f16962a44ea92afc6460168986c" kindref="member">expect</ref>.end(),<sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>[0]-&gt;vin[0].scriptSig.begin()))<sp/>{</highlight></codeline>
<codeline lineno="4240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a6d95354aa8213c32922ccc6fa949befb" kindref="member">BlockValidationResult::BLOCK_CONSENSUS</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-cb-height&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;block<sp/>height<sp/>mismatch<sp/>in<sp/>coinbase&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4242"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4243"><highlight class="normal"></highlight></codeline>
<codeline lineno="4244"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Validation<sp/>for<sp/>witness<sp/>commitments.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4245"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>*<sp/>We<sp/>compute<sp/>the<sp/>witness<sp/>hash<sp/>(which<sp/>is<sp/>the<sp/>hash<sp/>including<sp/>witnesses)<sp/>of<sp/>all<sp/>the<sp/>block&apos;s<sp/>transactions,<sp/>except<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4246"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>coinbase<sp/>(where<sp/>0x0000....0000<sp/>is<sp/>used<sp/>instead).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4247"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>*<sp/>The<sp/>coinbase<sp/>scriptWitness<sp/>is<sp/>a<sp/>stack<sp/>of<sp/>a<sp/>single<sp/>32-byte<sp/>vector,<sp/>containing<sp/>a<sp/>witness<sp/>reserved<sp/>value<sp/>(unconstrained).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4248"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>*<sp/>We<sp/>build<sp/>a<sp/>merkle<sp/>tree<sp/>with<sp/>all<sp/>those<sp/>witness<sp/>hashes<sp/>as<sp/>leaves<sp/>(similar<sp/>to<sp/>the<sp/>hashMerkleRoot<sp/>in<sp/>the<sp/>block<sp/>header).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4249"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>*<sp/>There<sp/>must<sp/>be<sp/>at<sp/>least<sp/>one<sp/>output<sp/>whose<sp/>scriptPubKey<sp/>is<sp/>a<sp/>single<sp/>36-byte<sp/>push,<sp/>the<sp/>first<sp/>4<sp/>bytes<sp/>of<sp/>which<sp/>are</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4250"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>{0xaa,<sp/>0x21,<sp/>0xa9,<sp/>0xed},<sp/>and<sp/>the<sp/>following<sp/>32<sp/>bytes<sp/>are<sp/>SHA256^2(witness<sp/>root,<sp/>witness<sp/>reserved<sp/>value).<sp/>In<sp/>case<sp/>there<sp/>are</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4251"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>multiple,<sp/>the<sp/>last<sp/>one<sp/>is<sp/>used.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4252"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!CheckWitnessMalleation(block,<sp/><ref refid="deploymentstatus_8h_1a0f9c7fc832b34b673ebfeadaffc86182" kindref="member">DeploymentActiveAfter</ref>(pindexPrev,<sp/>chainman,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dbac12a10e827db62556122f2b1a9b0431b" kindref="member">Consensus::DEPLOYMENT_SEGWIT</ref>),<sp/>state))<sp/>{</highlight></codeline>
<codeline lineno="4253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4254"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4255"><highlight class="normal"></highlight></codeline>
<codeline lineno="4256"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>After<sp/>the<sp/>coinbase<sp/>witness<sp/>reserved<sp/>value<sp/>and<sp/>commitment<sp/>are<sp/>verified,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4257"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>can<sp/>check<sp/>if<sp/>the<sp/>block<sp/>weight<sp/>passes<sp/>(before<sp/>we&apos;ve<sp/>checked<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4258"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>coinbase<sp/>witness,<sp/>it<sp/>would<sp/>be<sp/>possible<sp/>for<sp/>the<sp/>weight<sp/>to<sp/>be<sp/>too</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4259"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>large<sp/>by<sp/>filling<sp/>up<sp/>the<sp/>coinbase<sp/>witness,<sp/>which<sp/>doesn&apos;t<sp/>change</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4260"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>block<sp/>hash,<sp/>so<sp/>we<sp/>couldn&apos;t<sp/>mark<sp/>the<sp/>block<sp/>as<sp/>permanently</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4261"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>failed).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4262"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(GetBlockWeight(block)<sp/>&gt;<sp/>MAX_BLOCK_WEIGHT)<sp/>{</highlight></codeline>
<codeline lineno="4263"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a6d95354aa8213c32922ccc6fa949befb" kindref="member">BlockValidationResult::BLOCK_CONSENSUS</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-blk-weight&quot;</highlight><highlight class="normal">,<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;%s<sp/>:<sp/>weight<sp/>limit<sp/>failed&quot;</highlight><highlight class="normal">,<sp/>__func__));</highlight></codeline>
<codeline lineno="4264"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4265"><highlight class="normal"></highlight></codeline>
<codeline lineno="4266"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4267"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4268"><highlight class="normal"></highlight></codeline>
<codeline lineno="4269"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>ChainstateManager::AcceptBlockHeader(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_header" kindref="compound">CBlockHeader</ref>&amp;<sp/>block,<sp/><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref>&amp;<sp/>state,<sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>**<sp/>ppindex,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>min_pow_checked)</highlight></codeline>
<codeline lineno="4270"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4271"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4272"><highlight class="normal"></highlight></codeline>
<codeline lineno="4273"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>for<sp/>duplicate</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4274"><highlight class="normal"><sp/><sp/><sp/><sp/>uint256<sp/>hash<sp/>=<sp/>block.<ref refid="class_c_block_header_1a6df30b63c4634d52dfeaadb46d60d0f5" kindref="member">GetHash</ref>();</highlight></codeline>
<codeline lineno="4275"><highlight class="normal"><sp/><sp/><sp/><sp/>BlockMap::iterator<sp/>miSelf{<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_block_index.find(hash)};</highlight></codeline>
<codeline lineno="4276"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(hash<sp/>!=<sp/><ref refid="class_chainstate_manager_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>().hashGenesisBlock)<sp/>{</highlight></codeline>
<codeline lineno="4277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(miSelf<sp/>!=<sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_block_index.end())<sp/>{</highlight></codeline>
<codeline lineno="4278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Block<sp/>header<sp/>is<sp/>already<sp/>known.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>pindex<sp/>=<sp/>&amp;(miSelf-&gt;second);</highlight></codeline>
<codeline lineno="4280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ppindex)</highlight></codeline>
<codeline lineno="4281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*ppindex<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="4282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada88df51e92f2f675baff60e0a5bd170ef" kindref="member">BLOCK_FAILED_MASK</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4283"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a7721bbfbdf88038c07a667176e9ab22c" kindref="member">BCLog::VALIDATION</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s:<sp/>block<sp/>%s<sp/>is<sp/>marked<sp/>invalid\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>hash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a66107f1a16fc14f7b8dff8becdf353b8" kindref="member">BlockValidationResult::BLOCK_CACHED_INVALID</ref>,<sp/></highlight><highlight class="stringliteral">&quot;duplicate-invalid&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="4285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;block<sp/>%s<sp/>was<sp/>previously<sp/>marked<sp/>invalid&quot;</highlight><highlight class="normal">,<sp/>hash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>()));</highlight></codeline>
<codeline lineno="4286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4289"><highlight class="normal"></highlight></codeline>
<codeline lineno="4290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!CheckBlockHeader(block,<sp/>state,<sp/><ref refid="class_chainstate_manager_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>()))<sp/>{</highlight></codeline>
<codeline lineno="4291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a7721bbfbdf88038c07a667176e9ab22c" kindref="member">BCLog::VALIDATION</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s:<sp/>Consensus::CheckBlockHeader:<sp/>%s,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>hash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4294"><highlight class="normal"></highlight></codeline>
<codeline lineno="4295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Get<sp/>prev<sp/>block<sp/>index</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4296"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>pindexPrev<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4297"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BlockMap::iterator<sp/>mi{<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_block_index.find(block.<ref refid="class_c_block_header_1a96c46394fa2ffef51517b645bcabcb5e" kindref="member">hashPrevBlock</ref>)};</highlight></codeline>
<codeline lineno="4298"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(mi<sp/>==<sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_block_index.end())<sp/>{</highlight></codeline>
<codeline lineno="4299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a7721bbfbdf88038c07a667176e9ab22c" kindref="member">BCLog::VALIDATION</ref>,<sp/></highlight><highlight class="stringliteral">&quot;header<sp/>%s<sp/>has<sp/>prev<sp/>block<sp/>not<sp/>found:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>hash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>block.<ref refid="class_c_block_header_1a96c46394fa2ffef51517b645bcabcb5e" kindref="member">hashPrevBlock</ref>.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a75fe58bb96b5b8a9992cfc163cd38435" kindref="member">BlockValidationResult::BLOCK_MISSING_PREV</ref>,<sp/></highlight><highlight class="stringliteral">&quot;prev-blk-not-found&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexPrev<sp/>=<sp/>&amp;((*mi).second);</highlight></codeline>
<codeline lineno="4303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexPrev-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada88df51e92f2f675baff60e0a5bd170ef" kindref="member">BLOCK_FAILED_MASK</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a7721bbfbdf88038c07a667176e9ab22c" kindref="member">BCLog::VALIDATION</ref>,<sp/></highlight><highlight class="stringliteral">&quot;header<sp/>%s<sp/>has<sp/>prev<sp/>block<sp/>invalid:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>hash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>block.<ref refid="class_c_block_header_1a96c46394fa2ffef51517b645bcabcb5e" kindref="member">hashPrevBlock</ref>.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a9bd09980f054effc42d4dac919472ead" kindref="member">BlockValidationResult::BLOCK_INVALID_PREV</ref>,<sp/></highlight><highlight class="stringliteral">&quot;bad-prevblk&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!ContextualCheckBlockHeader(block,<sp/>state,<sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>,<sp/>*</highlight><highlight class="keyword">this</highlight><highlight class="normal">,<sp/>pindexPrev))<sp/>{</highlight></codeline>
<codeline lineno="4308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a7721bbfbdf88038c07a667176e9ab22c" kindref="member">BCLog::VALIDATION</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s:<sp/>Consensus::ContextualCheckBlockHeader:<sp/>%s,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>hash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4311"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4312"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!min_pow_checked)<sp/>{</highlight></codeline>
<codeline lineno="4313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a7721bbfbdf88038c07a667176e9ab22c" kindref="member">BCLog::VALIDATION</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s:<sp/>not<sp/>adding<sp/>new<sp/>block<sp/>header<sp/>%s,<sp/>missing<sp/>anti-dos<sp/>proof-of-work<sp/>validation\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>hash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a5a70bd865d41ac7d01f874abc5124e99" kindref="member">BlockValidationResult::BLOCK_HEADER_LOW_WORK</ref>,<sp/></highlight><highlight class="stringliteral">&quot;too-little-chainwork&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4315"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4316"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>pindex{<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.AddToBlockIndex(block,<sp/>m_best_header)};</highlight></codeline>
<codeline lineno="4317"><highlight class="normal"></highlight></codeline>
<codeline lineno="4318"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ppindex)</highlight></codeline>
<codeline lineno="4319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*ppindex<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="4320"><highlight class="normal"></highlight></codeline>
<codeline lineno="4321"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4322"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4323"><highlight class="normal"></highlight></codeline>
<codeline lineno="4324"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Exposed<sp/>wrapper<sp/>for<sp/>AcceptBlockHeader</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4325"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager_1ae76ff7fc56e3342ba5a97ca33ec5aa37" kindref="member">ChainstateManager::ProcessNewBlockHeaders</ref>(std::span&lt;const<sp/>CBlockHeader&gt;<sp/>headers,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>min_pow_checked,<sp/><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref>&amp;<sp/>state,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>**<sp/>ppindex)</highlight></codeline>
<codeline lineno="4326"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4327"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4328"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockHeader&amp;<sp/>header<sp/>:<sp/>headers)<sp/>{</highlight></codeline>
<codeline lineno="4331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockIndex<sp/>*pindex<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>Use<sp/>a<sp/>temp<sp/>pindex<sp/>instead<sp/>of<sp/>ppindex<sp/>to<sp/>avoid<sp/>a<sp/>const_cast</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>accepted{AcceptBlockHeader(header,<sp/>state,<sp/>&amp;pindex,<sp/>min_pow_checked)};</highlight></codeline>
<codeline lineno="4333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1abcf4d55acb00543c3d57d5fb532bc8f6" kindref="member">CheckBlockIndex</ref>();</highlight></codeline>
<codeline lineno="4334"><highlight class="normal"></highlight></codeline>
<codeline lineno="4335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!accepted)<sp/>{</highlight></codeline>
<codeline lineno="4336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ppindex)<sp/>{</highlight></codeline>
<codeline lineno="4339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*ppindex<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="4340"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4342"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4343"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(NotifyHeaderTip())<sp/>{</highlight></codeline>
<codeline lineno="4344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_manager_1a312bb1a2008bae3205f4699b90880d66" kindref="member">IsInitialBlockDownload</ref>()<sp/>&amp;&amp;<sp/>ppindex<sp/>&amp;&amp;<sp/>*ppindex)<sp/>{</highlight></codeline>
<codeline lineno="4345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex&amp;<sp/>last_accepted{**ppindex};</highlight></codeline>
<codeline lineno="4346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int64_t<sp/>blocks_left{(<ref refid="struct_node_clock_1a1be2fa9903731211253f2e36b5f3b584" kindref="member">NodeClock::now</ref>()<sp/>-<sp/>last_accepted.<ref refid="class_c_block_index_1a9ddce75b363526132a7d7fc78e8630d4" kindref="member">Time</ref>())<sp/>/<sp/><ref refid="class_chainstate_manager_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>().<ref refid="struct_consensus_1_1_params_1afe253b15cfdb8a85a8139522ed89e9ea" kindref="member">PowTargetSpacing</ref>()};</highlight></codeline>
<codeline lineno="4347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks_left<sp/>=<sp/>std::max&lt;int64_t&gt;(0,<sp/>blocks_left);</highlight></codeline>
<codeline lineno="4348"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>progress{100.0<sp/>*<sp/>last_accepted.<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>/<sp/>(last_accepted.<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>+<sp/>blocks_left)};</highlight></codeline>
<codeline lineno="4349"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Synchronizing<sp/>blockheaders,<sp/>height:<sp/>%d<sp/>(~%.2f%%)\n&quot;</highlight><highlight class="normal">,<sp/>last_accepted.<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>progress);</highlight></codeline>
<codeline lineno="4350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4351"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4352"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4353"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4354"><highlight class="normal"></highlight></codeline>
<codeline lineno="4355"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager_1afbdf3e3590aa0d6082ea2105a70bd91e" kindref="member">ChainstateManager::ReportHeadersPresync</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classarith__uint256" kindref="compound">arith_uint256</ref>&amp;<sp/>work,<sp/>int64_t<sp/>height,<sp/>int64_t<sp/>timestamp)</highlight></codeline>
<codeline lineno="4356"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4357"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(<ref refid="class_chainstate_manager_1af99ab8783b483abe3fef8ab596a3e6b6" kindref="member">GetMutex</ref>());</highlight></codeline>
<codeline lineno="4358"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="class_chainstate_manager_1af99ab8783b483abe3fef8ab596a3e6b6" kindref="member">GetMutex</ref>());</highlight></codeline>
<codeline lineno="4360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Don&apos;t<sp/>report<sp/>headers<sp/>presync<sp/>progress<sp/>if<sp/>we<sp/>already<sp/>have<sp/>a<sp/>post-minchainwork<sp/>header<sp/>chain.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>means<sp/>we<sp/>lose<sp/>reporting<sp/>for<sp/>potentially<sp/>legitimate,<sp/>but<sp/>unlikely,<sp/>deep<sp/>reorgs,<sp/>but</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>prevent<sp/>attackers<sp/>that<sp/>spam<sp/>low-work<sp/>headers<sp/>from<sp/>filling<sp/>our<sp/>logs.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_best_header-&gt;nChainWork<sp/>&gt;=<sp/><ref refid="arith__uint256_8cpp_1a6a6e0e2e41ba7e31c4a741eb2426a516" kindref="member">UintToArith256</ref>(<ref refid="class_chainstate_manager_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>().nMinimumChainWork))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Rate<sp/>limit<sp/>headers<sp/>presync<sp/>updates<sp/>to<sp/>4<sp/>per<sp/>second,<sp/>as<sp/>these<sp/>are<sp/>not<sp/>subject<sp/>to<sp/>DoS</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>protection.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4366"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>now<sp/>=<sp/><ref refid="struct_mockable_steady_clock_1adffd6475a6c9d2db2eb802508626e900" kindref="member">MockableSteadyClock::now</ref>();</highlight></codeline>
<codeline lineno="4367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(now<sp/>&lt;<sp/>m_last_presync_update<sp/>+<sp/>std::chrono::milliseconds{250})<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_last_presync_update<sp/>=<sp/>now;</highlight></codeline>
<codeline lineno="4369"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4370"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>initial_download<sp/>=<sp/><ref refid="class_chainstate_manager_1a312bb1a2008bae3205f4699b90880d66" kindref="member">IsInitialBlockDownload</ref>();</highlight></codeline>
<codeline lineno="4371"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a30d910c43e6619c9596c077fd1e5518d" kindref="member">GetNotifications</ref>().<ref refid="classkernel_1_1_notifications_1af27b750e4abb85337ce880c56a10aa88" kindref="member">headerTip</ref>(GetSynchronizationState(initial_download,<sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_blockfiles_indexed),<sp/>height,<sp/>timestamp,<sp/></highlight><highlight class="comment">/*presync=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4372"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(initial_download)<sp/>{</highlight></codeline>
<codeline lineno="4373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int64_t<sp/>blocks_left{(<ref refid="struct_node_clock_1a1be2fa9903731211253f2e36b5f3b584" kindref="member">NodeClock::now</ref>()<sp/>-<sp/><ref refid="util_2time_8h_1a8f3f2401a7990dfdbcf694471e95fb1e" kindref="member">NodeSeconds</ref>{std::chrono::seconds{timestamp}})<sp/>/<sp/><ref refid="class_chainstate_manager_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>().<ref refid="struct_consensus_1_1_params_1afe253b15cfdb8a85a8139522ed89e9ea" kindref="member">PowTargetSpacing</ref>()};</highlight></codeline>
<codeline lineno="4374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks_left<sp/>=<sp/>std::max&lt;int64_t&gt;(0,<sp/>blocks_left);</highlight></codeline>
<codeline lineno="4375"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>progress{100.0<sp/>*<sp/>height<sp/>/<sp/>(height<sp/>+<sp/>blocks_left)};</highlight></codeline>
<codeline lineno="4376"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Pre-synchronizing<sp/>blockheaders,<sp/>height:<sp/>%d<sp/>(~%.2f%%)\n&quot;</highlight><highlight class="normal">,<sp/>height,<sp/>progress);</highlight></codeline>
<codeline lineno="4377"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4378"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4379"><highlight class="normal"></highlight></codeline>
<codeline lineno="4381"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager_1a27cda33d02b54068c879b5889f6557f3" kindref="member">ChainstateManager::AcceptBlock</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;&amp;<sp/>pblock,<sp/><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref>&amp;<sp/>state,<sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>**<sp/>ppindex,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fRequested,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_flat_file_pos" kindref="compound">FlatFilePos</ref>*<sp/>dbp,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal">*<sp/>fNewBlock,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>min_pow_checked)</highlight></codeline>
<codeline lineno="4382"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4383"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlock&amp;<sp/>block<sp/>=<sp/>*pblock;</highlight></codeline>
<codeline lineno="4384"><highlight class="normal"></highlight></codeline>
<codeline lineno="4385"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fNewBlock)<sp/>*fNewBlock<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4386"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4387"><highlight class="normal"></highlight></codeline>
<codeline lineno="4388"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockIndex<sp/>*pindexDummy<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4389"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockIndex<sp/>*&amp;pindex<sp/>=<sp/>ppindex<sp/>?<sp/>*ppindex<sp/>:<sp/>pindexDummy;</highlight></codeline>
<codeline lineno="4390"><highlight class="normal"></highlight></codeline>
<codeline lineno="4391"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>accepted_header{AcceptBlockHeader(block,<sp/>state,<sp/>&amp;pindex,<sp/>min_pow_checked)};</highlight></codeline>
<codeline lineno="4392"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1abcf4d55acb00543c3d57d5fb532bc8f6" kindref="member">CheckBlockIndex</ref>();</highlight></codeline>
<codeline lineno="4393"><highlight class="normal"></highlight></codeline>
<codeline lineno="4394"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!accepted_header)</highlight></codeline>
<codeline lineno="4395"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4396"><highlight class="normal"></highlight></codeline>
<codeline lineno="4397"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>all<sp/>requested<sp/>blocks<sp/>that<sp/>we<sp/>do<sp/>not<sp/>already<sp/>have<sp/>for<sp/>validity<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4398"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>save<sp/>them<sp/>to<sp/>disk.<sp/>Skip<sp/>processing<sp/>of<sp/>unrequested<sp/>blocks<sp/>as<sp/>an<sp/>anti-DoS</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4399"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>measure,<sp/>unless<sp/>the<sp/>blocks<sp/>have<sp/>more<sp/>work<sp/>than<sp/>the<sp/>active<sp/>chain<sp/>tip,<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4400"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>aren&apos;t<sp/>too<sp/>far<sp/>ahead<sp/>of<sp/>it,<sp/>so<sp/>are<sp/>likely<sp/>to<sp/>be<sp/>attached<sp/>soon.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4401"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fAlreadyHave<sp/>=<sp/>pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15" kindref="member">BLOCK_HAVE_DATA</ref>;</highlight></codeline>
<codeline lineno="4402"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fHasMoreOrSameWork<sp/>=<sp/>(<ref refid="class_chainstate_manager_1ac8dc81d17ce18093b02ef600686870b3" kindref="member">ActiveTip</ref>()<sp/>?<sp/>pindex-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&gt;=<sp/><ref refid="class_chainstate_manager_1ac8dc81d17ce18093b02ef600686870b3" kindref="member">ActiveTip</ref>()-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>:<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4403"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Blocks<sp/>that<sp/>are<sp/>too<sp/>out-of-order<sp/>needlessly<sp/>limit<sp/>the<sp/>effectiveness<sp/>of</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4404"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>pruning,<sp/>because<sp/>pruning<sp/>will<sp/>not<sp/>delete<sp/>block<sp/>files<sp/>that<sp/>contain<sp/>any</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4405"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>blocks<sp/>which<sp/>are<sp/>too<sp/>close<sp/>in<sp/>height<sp/>to<sp/>the<sp/>tip.<sp/><sp/>Apply<sp/>this<sp/>test</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4406"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>regardless<sp/>of<sp/>whether<sp/>pruning<sp/>is<sp/>enabled;<sp/>it<sp/>should<sp/>generally<sp/>be<sp/>safe<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4407"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>not<sp/>process<sp/>unrequested<sp/>blocks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4408"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fTooFarAhead{pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>&gt;<sp/><ref refid="class_chainstate_manager_1a02754cb19c22c28f3092a18a70d9dec4" kindref="member">ActiveHeight</ref>()<sp/>+<sp/>int(MIN_BLOCKS_TO_KEEP)};</highlight></codeline>
<codeline lineno="4409"><highlight class="normal"></highlight></codeline>
<codeline lineno="4410"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>TODO:<sp/>Decouple<sp/>this<sp/>function<sp/>from<sp/>the<sp/>block<sp/>download<sp/>logic<sp/>by<sp/>removing<sp/>fRequested</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4411"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>requires<sp/>some<sp/>new<sp/>chain<sp/>data<sp/>structure<sp/>to<sp/>efficiently<sp/>look<sp/>up<sp/>if<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4412"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>block<sp/>is<sp/>in<sp/>a<sp/>chain<sp/>leading<sp/>to<sp/>a<sp/>candidate<sp/>for<sp/>best<sp/>tip,<sp/>despite<sp/>not</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4413"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>being<sp/>such<sp/>a<sp/>candidate<sp/>itself.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4414"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note<sp/>that<sp/>this<sp/>would<sp/>break<sp/>the<sp/>getblockfrompeer<sp/>RPC</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4415"><highlight class="normal"></highlight></codeline>
<codeline lineno="4416"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>TODO:<sp/>deal<sp/>better<sp/>with<sp/>return<sp/>value<sp/>and<sp/>error<sp/>conditions<sp/>for<sp/>duplicate</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4417"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>unrequested<sp/>blocks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4418"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fAlreadyHave)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4419"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!fRequested)<sp/>{<sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>didn&apos;t<sp/>ask<sp/>for<sp/>it:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1aee88ed2678dfb8c29dbb1ad986c87bf4" kindref="member">nTx</ref><sp/>!=<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;<sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>is<sp/>a<sp/>previously-processed<sp/>block<sp/>that<sp/>was<sp/>pruned</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4421"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!fHasMoreOrSameWork)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>Don&apos;t<sp/>process<sp/>less-work<sp/>chains</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fTooFarAhead)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Block<sp/>height<sp/>is<sp/>too<sp/>high</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4423"><highlight class="normal"></highlight></codeline>
<codeline lineno="4424"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Protect<sp/>against<sp/>DoS<sp/>attacks<sp/>from<sp/>low-work<sp/>chains.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4425"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>our<sp/>tip<sp/>is<sp/>behind,<sp/>a<sp/>peer<sp/>could<sp/>try<sp/>to<sp/>send<sp/>us</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4426"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>low-work<sp/>blocks<sp/>on<sp/>a<sp/>fake<sp/>chain<sp/>that<sp/>we<sp/>would<sp/>never</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4427"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>request;<sp/>don&apos;t<sp/>process<sp/>these.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4428"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&lt;<sp/><ref refid="class_chainstate_manager_1af6689b42eea6a15ba7e5409ea374cdb4" kindref="member">MinimumChainWork</ref>())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4429"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4430"><highlight class="normal"></highlight></codeline>
<codeline lineno="4431"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CChainParams&amp;<sp/>params{<ref refid="class_chainstate_manager_1a9fc4893dda46aba09dbcd01e3387ca6f" kindref="member">GetParams</ref>()};</highlight></codeline>
<codeline lineno="4432"><highlight class="normal"></highlight></codeline>
<codeline lineno="4433"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="validation_8h_1a9d72a901e6237b2e81465a7425f4112c" kindref="member">CheckBlock</ref>(block,<sp/>state,<sp/>params.<ref refid="class_c_chain_params_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>())<sp/>||</highlight></codeline>
<codeline lineno="4434"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!ContextualCheckBlock(block,<sp/>state,<sp/>*</highlight><highlight class="keyword">this</highlight><highlight class="normal">,<sp/>pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>))<sp/>{</highlight></codeline>
<codeline lineno="4435"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(state.<ref refid="class_validation_state_1a6c1f27c9de7ff98356fa712e4b796a1a" kindref="member">IsInvalid</ref>()))<sp/>{</highlight></codeline>
<codeline lineno="4436"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a0ed46908ea52e17d172f2fcc0ceb9964" kindref="member">ActiveChainstate</ref>().<ref refid="class_chainstate_1a9c5078a4a04331cc35d986500a8b30b1" kindref="member">InvalidBlockFound</ref>(pindex,<sp/>state);</highlight></codeline>
<codeline lineno="4437"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4438"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;%s:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4439"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4440"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4441"><highlight class="normal"></highlight></codeline>
<codeline lineno="4442"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Header<sp/>is<sp/>valid/has<sp/>work,<sp/>merkle<sp/>tree<sp/>and<sp/>segwit<sp/>merkle<sp/>tree<sp/>are<sp/>good...RELAY<sp/>NOW</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4443"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(but<sp/>if<sp/>it<sp/>does<sp/>not<sp/>build<sp/>on<sp/>our<sp/>best<sp/>tip,<sp/>let<sp/>the<sp/>SendMessages<sp/>loop<sp/>relay<sp/>it)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4444"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_manager_1a312bb1a2008bae3205f4699b90880d66" kindref="member">IsInitialBlockDownload</ref>()<sp/>&amp;&amp;<sp/><ref refid="class_chainstate_manager_1ac8dc81d17ce18093b02ef600686870b3" kindref="member">ActiveTip</ref>()<sp/>==<sp/>pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>&amp;&amp;<sp/><ref refid="class_chainstate_manager_1a012c0463bd17a2be6045a0d62e8b0fd4" kindref="member">m_options</ref>.signals)<sp/>{</highlight></codeline>
<codeline lineno="4445"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a012c0463bd17a2be6045a0d62e8b0fd4" kindref="member">m_options</ref>.signals-&gt;NewPoWValidBlock(pindex,<sp/>pblock);</highlight></codeline>
<codeline lineno="4446"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4447"><highlight class="normal"></highlight></codeline>
<codeline lineno="4448"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Write<sp/>block<sp/>to<sp/>history<sp/>file</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4449"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fNewBlock)<sp/>*fNewBlock<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4450"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>FlatFilePos<sp/>blockPos{};</highlight></codeline>
<codeline lineno="4452"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(dbp)<sp/>{</highlight></codeline>
<codeline lineno="4453"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blockPos<sp/>=<sp/>*dbp;</highlight></codeline>
<codeline lineno="4454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.UpdateBlockInfo(block,<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>blockPos);</highlight></codeline>
<codeline lineno="4455"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4456"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blockPos<sp/>=<sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.WriteBlock(block,<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>);</highlight></codeline>
<codeline lineno="4457"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(blockPos.<ref refid="struct_flat_file_pos_1ac4d637a0dec45d546495c1660c9f6047" kindref="member">IsNull</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4458"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.<ref refid="class_validation_state_1a9d886f26067de6ec090eb37e26b8f510" kindref="member">Error</ref>(<ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;%s:<sp/>Failed<sp/>to<sp/>find<sp/>position<sp/>to<sp/>write<sp/>new<sp/>block<sp/>to<sp/>disk&quot;</highlight><highlight class="normal">,<sp/>__func__));</highlight></codeline>
<codeline lineno="4459"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4460"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4461"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4462"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1aacf45b730328d8aa968302758c45adf0" kindref="member">ReceivedBlockTransactions</ref>(block,<sp/>pindex,<sp/>blockPos);</highlight></codeline>
<codeline lineno="4463"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::runtime_error&amp;<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="4464"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a5a516dcd32726994512c2dfe67439ba2" kindref="member">FatalError</ref>(<ref refid="class_chainstate_manager_1a30d910c43e6619c9596c077fd1e5518d" kindref="member">GetNotifications</ref>(),<sp/>state,<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(<ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight><highlight class="stringliteral">&quot;System<sp/>error<sp/>while<sp/>saving<sp/>block<sp/>to<sp/>disk:<sp/>%s&quot;</highlight><highlight class="normal">),<sp/>e.what()));</highlight></codeline>
<codeline lineno="4465"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4466"><highlight class="normal"></highlight></codeline>
<codeline lineno="4467"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>TODO:<sp/>FlushStateToDisk()<sp/>handles<sp/>flushing<sp/>of<sp/>both<sp/>block<sp/>and<sp/>chainstate</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4468"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>data,<sp/>so<sp/>we<sp/>should<sp/>move<sp/>this<sp/>to<sp/>ChainstateManager<sp/>so<sp/>that<sp/>we<sp/>can<sp/>be<sp/>more</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4469"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>intelligent<sp/>about<sp/>how<sp/>we<sp/>flush.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4470"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>For<sp/>now,<sp/>since<sp/>FlushStateMode::NONE<sp/>is<sp/>used,<sp/>all<sp/>that<sp/>can<sp/>happen<sp/>is<sp/>that</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4471"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>block<sp/>files<sp/>may<sp/>be<sp/>pruned,<sp/>so<sp/>we<sp/>can<sp/>just<sp/>call<sp/>this<sp/>on<sp/>one</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4472"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>chainstate<sp/>(particularly<sp/>if<sp/>we<sp/>haven&apos;t<sp/>implemented<sp/>pruning<sp/>with</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4473"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>background<sp/>validation<sp/>yet).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4474"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a0ed46908ea52e17d172f2fcc0ceb9964" kindref="member">ActiveChainstate</ref>().<ref refid="class_chainstate_1a0f9f0cdb703638cb9818a9b41158ac6a" kindref="member">FlushStateToDisk</ref>(state,<sp/><ref refid="validation_8h_1ab30a99e75e9dc44356d1ad6bdd184ae0ab50339a10e1de285ac99d4c3990b8693" kindref="member">FlushStateMode::NONE</ref>);</highlight></codeline>
<codeline lineno="4475"><highlight class="normal"></highlight></codeline>
<codeline lineno="4476"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1abcf4d55acb00543c3d57d5fb532bc8f6" kindref="member">CheckBlockIndex</ref>();</highlight></codeline>
<codeline lineno="4477"><highlight class="normal"></highlight></codeline>
<codeline lineno="4478"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4479"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4480"><highlight class="normal"></highlight></codeline>
<codeline lineno="4481"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager_1a1e0c145b7a823316fb026a73d305a049" kindref="member">ChainstateManager::ProcessNewBlock</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;&amp;<sp/>block,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>force_processing,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>min_pow_checked,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal">*<sp/>new_block)</highlight></codeline>
<codeline lineno="4482"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4483"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4484"><highlight class="normal"></highlight></codeline>
<codeline lineno="4485"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4486"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockIndex<sp/>*pindex<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4487"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(new_block)<sp/>*new_block<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4488"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BlockValidationState<sp/>state;</highlight></codeline>
<codeline lineno="4489"><highlight class="normal"></highlight></codeline>
<codeline lineno="4490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>CheckBlock()<sp/>does<sp/>not<sp/>support<sp/>multi-threaded<sp/>block<sp/>validation<sp/>because<sp/>CBlock::fChecked<sp/>can<sp/>cause<sp/>data<sp/>race.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4491"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Therefore,<sp/>the<sp/>following<sp/>critical<sp/>section<sp/>must<sp/>include<sp/>the<sp/>CheckBlock()<sp/>call<sp/>as<sp/>well.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4493"><highlight class="normal"></highlight></codeline>
<codeline lineno="4494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Skipping<sp/>AcceptBlock()<sp/>for<sp/>CheckBlock()<sp/>failures<sp/>means<sp/>that<sp/>we<sp/>will<sp/>never<sp/>mark<sp/>a<sp/>block<sp/>as<sp/>invalid<sp/>if</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4495"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>CheckBlock()<sp/>fails.<sp/><sp/>This<sp/>is<sp/>protective<sp/>against<sp/>consensus<sp/>failure<sp/>if<sp/>there<sp/>are<sp/>any<sp/>unknown<sp/>forms<sp/>of<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4496"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>malleability<sp/>that<sp/>cause<sp/>CheckBlock()<sp/>to<sp/>fail;<sp/>see<sp/>e.g.<sp/>CVE-2012-2459<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4497"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2019-February/016697.html.<sp/><sp/>Because<sp/>CheckBlock()<sp/>is</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>not<sp/>very<sp/>expensive,<sp/>the<sp/>anti-DoS<sp/>benefits<sp/>of<sp/>caching<sp/>failure<sp/>(of<sp/>a<sp/>definitely-invalid<sp/>block)<sp/>are<sp/>not<sp/>substantial.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref><sp/>=<sp/><ref refid="validation_8h_1a9d72a901e6237b2e81465a7425f4112c" kindref="member">CheckBlock</ref>(*block,<sp/>state,<sp/><ref refid="class_chainstate_manager_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>());</highlight></codeline>
<codeline lineno="4500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Store<sp/>to<sp/>disk</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref><sp/>=<sp/><ref refid="class_chainstate_manager_1a27cda33d02b54068c879b5889f6557f3" kindref="member">AcceptBlock</ref>(block,<sp/>state,<sp/>&amp;pindex,<sp/>force_processing,<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">,<sp/>new_block,<sp/>min_pow_checked);</highlight></codeline>
<codeline lineno="4503"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4504"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_manager_1a012c0463bd17a2be6045a0d62e8b0fd4" kindref="member">m_options</ref>.signals)<sp/>{</highlight></codeline>
<codeline lineno="4506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a012c0463bd17a2be6045a0d62e8b0fd4" kindref="member">m_options</ref>.signals-&gt;BlockChecked(block,<sp/>state);</highlight></codeline>
<codeline lineno="4507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4508"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;%s:<sp/>AcceptBlock<sp/>FAILED<sp/>(%s)\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4509"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4511"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4512"><highlight class="normal"></highlight></codeline>
<codeline lineno="4513"><highlight class="normal"><sp/><sp/><sp/><sp/>NotifyHeaderTip();</highlight></codeline>
<codeline lineno="4514"><highlight class="normal"></highlight></codeline>
<codeline lineno="4515"><highlight class="normal"><sp/><sp/><sp/><sp/>BlockValidationState<sp/>state;<sp/></highlight><highlight class="comment">//<sp/>Only<sp/>used<sp/>to<sp/>report<sp/>errors,<sp/>not<sp/>invalidity<sp/>-<sp/>ignore<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4516"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_manager_1a0ed46908ea52e17d172f2fcc0ceb9964" kindref="member">ActiveChainstate</ref>().ActivateBestChain(state,<sp/>block))<sp/>{</highlight></codeline>
<codeline lineno="4517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;%s:<sp/>ActivateBestChain<sp/>failed<sp/>(%s)\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4519"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4520"><highlight class="normal"></highlight></codeline>
<codeline lineno="4521"><highlight class="normal"><sp/><sp/><sp/><sp/>Chainstate*<sp/>bg_chain{<ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager_1a1140f6d8b807be5796827fc4f7be03d7" kindref="member">HistoricalChainstate</ref>())};</highlight></codeline>
<codeline lineno="4522"><highlight class="normal"><sp/><sp/><sp/><sp/>BlockValidationState<sp/>bg_state;</highlight></codeline>
<codeline lineno="4523"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(bg_chain<sp/>&amp;&amp;<sp/>!bg_chain-&gt;ActivateBestChain(bg_state,<sp/>block))<sp/>{</highlight></codeline>
<codeline lineno="4524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;%s:<sp/>[background]<sp/>ActivateBestChain<sp/>failed<sp/>(%s)\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>bg_state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4526"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4527"><highlight class="normal"></highlight></codeline>
<codeline lineno="4528"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4529"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4530"><highlight class="normal"></highlight></codeline>
<codeline lineno="4531"><highlight class="normal"><ref refid="struct_mempool_accept_result" kindref="compound">MempoolAcceptResult</ref><sp/><ref refid="class_chainstate_manager_1a9c7d6797a606a08696d722e7489b6d4d" kindref="member">ChainstateManager::ProcessTransaction</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref>&amp;<sp/>tx,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>test_accept)</highlight></codeline>
<codeline lineno="4532"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4533"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4534"><highlight class="normal"><sp/><sp/><sp/><sp/>Chainstate&amp;<sp/>active_chainstate<sp/>=<sp/><ref refid="class_chainstate_manager_1a0ed46908ea52e17d172f2fcc0ceb9964" kindref="member">ActiveChainstate</ref>();</highlight></codeline>
<codeline lineno="4535"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!active_chainstate.<ref refid="class_chainstate_1ac2dc9bde2175dbfb05382c6e8033db28" kindref="member">GetMempool</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4536"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>TxValidationState<sp/>state;</highlight></codeline>
<codeline lineno="4537"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>(<ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fabf7c24f91e2c3c9b6d53aee4ba84e5ca" kindref="member">TxValidationResult::TX_NO_MEMPOOL</ref>,<sp/></highlight><highlight class="stringliteral">&quot;no-mempool&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4538"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="struct_mempool_accept_result_1af068e8d0ef73ea6eb79c045cc100558c" kindref="member">MempoolAcceptResult::Failure</ref>(state);</highlight></codeline>
<codeline lineno="4539"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4540"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>result<sp/>=<sp/><ref refid="validation_8h_1a5f178a2bb141cae949283673ad12ca6b" kindref="member">AcceptToMemoryPool</ref>(active_chainstate,<sp/>tx,<sp/><ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime</ref>(),<sp/></highlight><highlight class="comment">/*bypass_limits=*/</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">,<sp/>test_accept);</highlight></codeline>
<codeline lineno="4541"><highlight class="normal"><sp/><sp/><sp/><sp/>active_chainstate.<ref refid="class_chainstate_1ac2dc9bde2175dbfb05382c6e8033db28" kindref="member">GetMempool</ref>()-&gt;check(active_chainstate.<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>(),<sp/>active_chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>()<sp/>+<sp/>1);</highlight></codeline>
<codeline lineno="4542"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>result;</highlight></codeline>
<codeline lineno="4543"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4544"><highlight class="normal"></highlight></codeline>
<codeline lineno="4545"><highlight class="normal"></highlight></codeline>
<codeline lineno="4546"><highlight class="normal"><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref><sp/><ref refid="validation_8cpp_1ac0610c85af2e020fe5284c21b47beb39" kindref="member">TestBlockValidity</ref>(</highlight></codeline>
<codeline lineno="4547"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate" kindref="compound">Chainstate</ref>&amp;<sp/>chainstate,</highlight></codeline>
<codeline lineno="4548"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block" kindref="compound">CBlock</ref>&amp;<sp/>block,</highlight></codeline>
<codeline lineno="4549"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>check_pow,</highlight></codeline>
<codeline lineno="4550"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>check_merkle_root)</highlight></codeline>
<codeline lineno="4551"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4552"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Lock<sp/>must<sp/>be<sp/>held<sp/>throughout<sp/>this<sp/>function<sp/>for<sp/>two<sp/>reasons:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4553"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>1.<sp/>We<sp/>don&apos;t<sp/>want<sp/>the<sp/>tip<sp/>to<sp/>change<sp/>during<sp/>several<sp/>of<sp/>the<sp/>validation<sp/>steps</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4554"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>2.<sp/>To<sp/>prevent<sp/>a<sp/>CheckBlock()<sp/>race<sp/>condition<sp/>for<sp/>fChecked,<sp/>see<sp/>ProcessNewBlock()</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4555"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(chainstate.<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.<ref refid="class_chainstate_manager_1af99ab8783b483abe3fef8ab596a3e6b6" kindref="member">GetMutex</ref>());</highlight></codeline>
<codeline lineno="4556"><highlight class="normal"></highlight></codeline>
<codeline lineno="4557"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref><sp/>state;</highlight></codeline>
<codeline lineno="4558"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>tip{<ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>())};</highlight></codeline>
<codeline lineno="4559"><highlight class="normal"></highlight></codeline>
<codeline lineno="4560"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(block.<ref refid="class_c_block_header_1a96c46394fa2ffef51517b645bcabcb5e" kindref="member">hashPrevBlock</ref><sp/>!=<sp/>*<ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(tip-&gt;<ref refid="class_c_block_index_1a8459b1786042d3faba1396a4f86d8eb5" kindref="member">phashBlock</ref>))<sp/>{</highlight></codeline>
<codeline lineno="4561"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.<ref refid="class_validation_state_1a738c8515139b5b4088c0fccc16978bb1" kindref="member">Invalid</ref>({},<sp/></highlight><highlight class="stringliteral">&quot;inconclusive-not-best-prevblk&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4562"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state;</highlight></codeline>
<codeline lineno="4563"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4564"><highlight class="normal"></highlight></codeline>
<codeline lineno="4565"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>For<sp/>signets<sp/>CheckBlock()<sp/>verifies<sp/>the<sp/>challenge<sp/>iff<sp/>fCheckPow<sp/>is<sp/>set.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4566"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="validation_8cpp_1aac26467a10843087935711c71e43e184" kindref="member">CheckBlock</ref>(block,<sp/>state,<sp/>chainstate.<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.<ref refid="class_chainstate_manager_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>(),<sp/></highlight><highlight class="comment">/*fCheckPow=*/</highlight><highlight class="normal">check_pow,<sp/></highlight><highlight class="comment">/*fCheckMerkleRoot=*/</highlight><highlight class="normal">check_merkle_root))<sp/>{</highlight></codeline>
<codeline lineno="4567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>should<sp/>never<sp/>happen,<sp/>but<sp/>belt-and-suspenders<sp/>don&apos;t<sp/>approve<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>block<sp/>if<sp/>it<sp/>does.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.<ref refid="class_validation_state_1ac532c4b500b1a85ea22217f2c65a70ed" kindref="member">IsValid</ref>())<sp/><ref refid="check_8h_1ac579efce97842056131de240c39e86fc" kindref="member">NONFATAL_UNREACHABLE</ref>();</highlight></codeline>
<codeline lineno="4570"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state;</highlight></codeline>
<codeline lineno="4571"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4572"><highlight class="normal"></highlight></codeline>
<codeline lineno="4587"><highlight class="normal"></highlight></codeline>
<codeline lineno="4588"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!ContextualCheckBlockHeader(block,<sp/>state,<sp/>chainstate.<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>,<sp/>chainstate.<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>,<sp/>tip))<sp/>{</highlight></codeline>
<codeline lineno="4589"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.<ref refid="class_validation_state_1ac532c4b500b1a85ea22217f2c65a70ed" kindref="member">IsValid</ref>())<sp/><ref refid="check_8h_1ac579efce97842056131de240c39e86fc" kindref="member">NONFATAL_UNREACHABLE</ref>();</highlight></codeline>
<codeline lineno="4590"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state;</highlight></codeline>
<codeline lineno="4591"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4592"><highlight class="normal"></highlight></codeline>
<codeline lineno="4593"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!ContextualCheckBlock(block,<sp/>state,<sp/>chainstate.<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>,<sp/>tip))<sp/>{</highlight></codeline>
<codeline lineno="4594"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.<ref refid="class_validation_state_1ac532c4b500b1a85ea22217f2c65a70ed" kindref="member">IsValid</ref>())<sp/><ref refid="check_8h_1ac579efce97842056131de240c39e86fc" kindref="member">NONFATAL_UNREACHABLE</ref>();</highlight></codeline>
<codeline lineno="4595"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state;</highlight></codeline>
<codeline lineno="4596"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4597"><highlight class="normal"></highlight></codeline>
<codeline lineno="4598"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>don&apos;t<sp/>want<sp/>ConnectBlock<sp/>to<sp/>update<sp/>the<sp/>actual<sp/>chainstate,<sp/>so<sp/>create</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4599"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>a<sp/>cache<sp/>on<sp/>top<sp/>of<sp/>it,<sp/>along<sp/>with<sp/>a<sp/>dummy<sp/>block<sp/>index.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4600"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref><sp/>index_dummy{block};</highlight></codeline>
<codeline lineno="4601"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classuint256" kindref="compound">uint256</ref><sp/>block_hash(block.<ref refid="class_c_block_header_1a6df30b63c4634d52dfeaadb46d60d0f5" kindref="member">GetHash</ref>());</highlight></codeline>
<codeline lineno="4602"><highlight class="normal"><sp/><sp/><sp/><sp/>index_dummy.<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>=<sp/>tip;</highlight></codeline>
<codeline lineno="4603"><highlight class="normal"><sp/><sp/><sp/><sp/>index_dummy.<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>=<sp/>tip-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="4604"><highlight class="normal"><sp/><sp/><sp/><sp/>index_dummy.<ref refid="class_c_block_index_1a8459b1786042d3faba1396a4f86d8eb5" kindref="member">phashBlock</ref><sp/>=<sp/>&amp;block_hash;</highlight></codeline>
<codeline lineno="4605"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref><sp/>view_dummy(&amp;chainstate.<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>());</highlight></codeline>
<codeline lineno="4606"><highlight class="normal"></highlight></codeline>
<codeline lineno="4607"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Set<sp/>fJustCheck<sp/>to<sp/>true<sp/>in<sp/>order<sp/>to<sp/>update,<sp/>and<sp/>not<sp/>clear,<sp/>validation<sp/>caches.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4608"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(!chainstate.<ref refid="class_chainstate_1a0487c7fe4cdc89e309556f86c2988c80" kindref="member">ConnectBlock</ref>(block,<sp/>state,<sp/>&amp;index_dummy,<sp/>view_dummy,<sp/></highlight><highlight class="comment">/*fJustCheck=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="4609"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.<ref refid="class_validation_state_1ac532c4b500b1a85ea22217f2c65a70ed" kindref="member">IsValid</ref>())<sp/><ref refid="check_8h_1ac579efce97842056131de240c39e86fc" kindref="member">NONFATAL_UNREACHABLE</ref>();</highlight></codeline>
<codeline lineno="4610"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state;</highlight></codeline>
<codeline lineno="4611"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4612"><highlight class="normal"></highlight></codeline>
<codeline lineno="4613"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ensure<sp/>no<sp/>check<sp/>returned<sp/>successfully<sp/>while<sp/>also<sp/>setting<sp/>an<sp/>invalid<sp/>state.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4614"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!state.<ref refid="class_validation_state_1ac532c4b500b1a85ea22217f2c65a70ed" kindref="member">IsValid</ref>())<sp/><ref refid="check_8h_1ac579efce97842056131de240c39e86fc" kindref="member">NONFATAL_UNREACHABLE</ref>();</highlight></codeline>
<codeline lineno="4615"><highlight class="normal"></highlight></codeline>
<codeline lineno="4616"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>state;</highlight></codeline>
<codeline lineno="4617"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4618"><highlight class="normal"></highlight></codeline>
<codeline lineno="4619"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>This<sp/>function<sp/>is<sp/>called<sp/>from<sp/>the<sp/>RPC<sp/>code<sp/>for<sp/>pruneblockchain<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4620"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="validation_8cpp_1ab256293c94a9e05d6d9a9ccb5d6b2c58" kindref="member">PruneBlockFilesManual</ref>(<ref refid="class_chainstate" kindref="compound">Chainstate</ref>&amp;<sp/>active_chainstate,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nManualPruneHeight)</highlight></codeline>
<codeline lineno="4621"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4622"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_block_validation_state" kindref="compound">BlockValidationState</ref><sp/>state;</highlight></codeline>
<codeline lineno="4623"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!active_chainstate.<ref refid="class_chainstate_1a0f9f0cdb703638cb9818a9b41158ac6a" kindref="member">FlushStateToDisk</ref>(</highlight></codeline>
<codeline lineno="4624"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state,<sp/><ref refid="validation_8h_1ab30a99e75e9dc44356d1ad6bdd184ae0ab50339a10e1de285ac99d4c3990b8693" kindref="member">FlushStateMode::NONE</ref>,<sp/>nManualPruneHeight))<sp/>{</highlight></codeline>
<codeline lineno="4625"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>flush<sp/>state<sp/>after<sp/>manual<sp/>prune<sp/>(%s)&quot;</highlight><highlight class="normal">,<sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4626"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4627"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4628"><highlight class="normal"></highlight></codeline>
<codeline lineno="4629"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1a1ea13869144ef7ef6c69114ce9834a70" kindref="member">Chainstate::LoadChainTip</ref>()</highlight></codeline>
<codeline lineno="4630"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4631"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4632"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CCoinsViewCache&amp;<sp/>coins_cache<sp/>=<sp/><ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>();</highlight></codeline>
<codeline lineno="4633"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!coins_cache.<ref refid="class_c_coins_view_cache_1a357197e89d0c22e33f9e58b3dac685ff" kindref="member">GetBestBlock</ref>().<ref refid="classbase__blob_1a067b44b9f2bd293d8a93401655e6476e" kindref="member">IsNull</ref>());<sp/></highlight><highlight class="comment">//<sp/>Never<sp/>called<sp/>when<sp/>the<sp/>coins<sp/>view<sp/>is<sp/>empty</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4634"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>tip<sp/>=<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip();</highlight></codeline>
<codeline lineno="4635"><highlight class="normal"></highlight></codeline>
<codeline lineno="4636"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tip<sp/>&amp;&amp;<sp/>tip-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>()<sp/>==<sp/>coins_cache.<ref refid="class_c_coins_view_cache_1a357197e89d0c22e33f9e58b3dac685ff" kindref="member">GetBestBlock</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4637"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4638"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4639"><highlight class="normal"></highlight></codeline>
<codeline lineno="4640"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Load<sp/>pointer<sp/>to<sp/>end<sp/>of<sp/>best<sp/>chain</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4641"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>pindex<sp/>=<sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.LookupBlockIndex(coins_cache.<ref refid="class_c_coins_view_cache_1a357197e89d0c22e33f9e58b3dac685ff" kindref="member">GetBestBlock</ref>());</highlight></codeline>
<codeline lineno="4642"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pindex)<sp/>{</highlight></codeline>
<codeline lineno="4643"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4644"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4645"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.SetTip(*pindex);</highlight></codeline>
<codeline lineno="4646"><highlight class="normal"><sp/><sp/><sp/><sp/>tip<sp/>=<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip();</highlight></codeline>
<codeline lineno="4647"><highlight class="normal"></highlight></codeline>
<codeline lineno="4648"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Make<sp/>sure<sp/>our<sp/>chain<sp/>tip<sp/>before<sp/>shutting<sp/>down<sp/>scores<sp/>better<sp/>than<sp/>any<sp/>other<sp/>candidate</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4649"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>maintain<sp/>a<sp/>consistent<sp/>best<sp/>tip<sp/>over<sp/>reboots<sp/>in<sp/>case<sp/>of<sp/>a<sp/>tie.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4650"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>target<sp/>=<sp/>tip;</highlight></codeline>
<codeline lineno="4651"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(target)<sp/>{</highlight></codeline>
<codeline lineno="4652"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>target-&gt;nSequenceId<sp/>=<sp/>SEQ_ID_BEST_CHAIN_FROM_DISK;</highlight></codeline>
<codeline lineno="4653"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>target<sp/>=<sp/>target-&gt;pprev;</highlight></codeline>
<codeline lineno="4654"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4655"><highlight class="normal"></highlight></codeline>
<codeline lineno="4656"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Block<sp/>index<sp/>candidates<sp/>are<sp/>loaded<sp/>before<sp/>the<sp/>chain<sp/>tip,<sp/>so<sp/>we<sp/>need<sp/>to<sp/>replace<sp/>this<sp/>entry</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4657"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Otherwise<sp/>the<sp/>scoring<sp/>will<sp/>be<sp/>based<sp/>on<sp/>the<sp/>memory<sp/>address<sp/>location<sp/>instead<sp/>of<sp/>the<sp/>nSequenceId</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4658"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.erase(tip);</highlight></codeline>
<codeline lineno="4659"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab86ef2ab974ae064997b910e161c4849" kindref="member">TryAddBlockIndexCandidate</ref>(tip);</highlight></codeline>
<codeline lineno="4660"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab1a46f0614b890eb2be89745e2526b7c" kindref="member">PruneBlockIndexCandidates</ref>();</highlight></codeline>
<codeline lineno="4661"><highlight class="normal"></highlight></codeline>
<codeline lineno="4662"><highlight class="normal"><sp/><sp/><sp/><sp/>tip<sp/>=<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip();</highlight></codeline>
<codeline lineno="4663"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Loaded<sp/>best<sp/>chain:<sp/>hashBestChain=%s<sp/>height=%d<sp/>date=%s<sp/>progress=%f&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="4664"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tip-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),</highlight></codeline>
<codeline lineno="4665"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Height(),</highlight></codeline>
<codeline lineno="4666"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8cpp_1ae5186b218f085a0a48b08bcdb0fffed1" kindref="member">FormatISO8601DateTime</ref>(tip-&gt;<ref refid="class_c_block_index_1a7aea61ae131a8b7b934f8b3a758d9490" kindref="member">GetBlockTime</ref>()),</highlight></codeline>
<codeline lineno="4667"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GuessVerificationProgress(tip));</highlight></codeline>
<codeline lineno="4668"><highlight class="normal"></highlight></codeline>
<codeline lineno="4669"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ensure<sp/>KernelNotifications<sp/>m_tip_block<sp/>is<sp/>set<sp/>even<sp/>if<sp/>no<sp/>new<sp/>block<sp/>arrives.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4670"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!this-&gt;GetRole().historical)<sp/>{</highlight></codeline>
<codeline lineno="4671"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ignoring<sp/>return<sp/>value<sp/>for<sp/>now.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4672"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(void)<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetNotifications().blockTip(</highlight></codeline>
<codeline lineno="4673"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*state=*/</highlight><highlight class="normal">GetSynchronizationState(</highlight><highlight class="comment">/*init=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">,<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_blockman.m_blockfiles_indexed),</highlight></codeline>
<codeline lineno="4674"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*index=*/</highlight><highlight class="normal">*pindex,</highlight></codeline>
<codeline lineno="4675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*verification_progress=*/</highlight><highlight class="normal"><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GuessVerificationProgress(tip));</highlight></codeline>
<codeline lineno="4676"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4677"><highlight class="normal"></highlight></codeline>
<codeline lineno="4678"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a7d3637ae43c319b91b55b43ff1dc0a37" kindref="member">CheckForkWarningConditions</ref>();</highlight></codeline>
<codeline lineno="4679"><highlight class="normal"></highlight></codeline>
<codeline lineno="4680"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4681"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4682"><highlight class="normal"></highlight></codeline>
<codeline lineno="4683"><highlight class="normal"><ref refid="class_c_verify_d_b_1a16e4f89e0b4916a9515f2e197e2df1d1" kindref="member">CVerifyDB::CVerifyDB</ref>(<ref refid="classkernel_1_1_notifications" kindref="compound">Notifications</ref>&amp;<sp/>notifications)</highlight></codeline>
<codeline lineno="4684"><highlight class="normal"><sp/><sp/><sp/><sp/>:<sp/>m_notifications{notifications}</highlight></codeline>
<codeline lineno="4685"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4686"><highlight class="normal"><sp/><sp/><sp/><sp/>m_notifications.<ref refid="classkernel_1_1_notifications_1aa72f67c17c259ba8e11ef8c0bc70193d" kindref="member">progress</ref>(<ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight><highlight class="stringliteral">&quot;Verifying<sp/>blocks&quot;</highlight><highlight class="normal">),<sp/>0,<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4687"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4688"><highlight class="normal"></highlight></codeline>
<codeline lineno="4689"><highlight class="normal"><ref refid="class_c_verify_d_b_1a20a9a2cfbe4a8f612aa54337a53a08e6" kindref="member">CVerifyDB::~CVerifyDB</ref>()</highlight></codeline>
<codeline lineno="4690"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4691"><highlight class="normal"><sp/><sp/><sp/><sp/>m_notifications.progress(bilingual_str{},<sp/>100,<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4692"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4693"><highlight class="normal"></highlight></codeline>
<codeline lineno="4694"><highlight class="normal"><ref refid="validation_8h_1a9a734f0900dfff66f62decfddec72a0d" kindref="member">VerifyDBResult</ref><sp/><ref refid="class_c_verify_d_b_1a71818d1d29011878e23b1f3e08e6cabc" kindref="member">CVerifyDB::VerifyDB</ref>(</highlight></codeline>
<codeline lineno="4695"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate" kindref="compound">Chainstate</ref>&amp;<sp/>chainstate,</highlight></codeline>
<codeline lineno="4696"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_consensus_1_1_params" kindref="compound">Consensus::Params</ref>&amp;<sp/>consensus_params,</highlight></codeline>
<codeline lineno="4697"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_coins_view" kindref="compound">CCoinsView</ref>&amp;<sp/>coinsview,</highlight></codeline>
<codeline lineno="4698"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nCheckLevel,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nCheckDepth)</highlight></codeline>
<codeline lineno="4699"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4700"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4701"><highlight class="normal"></highlight></codeline>
<codeline lineno="4702"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>()<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>||<sp/>chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>()-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="4703"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a9a734f0900dfff66f62decfddec72a0dad0749aaba8b833466dfcbb0428e4f89c" kindref="member">VerifyDBResult::SUCCESS</ref>;</highlight></codeline>
<codeline lineno="4704"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4705"><highlight class="normal"></highlight></codeline>
<codeline lineno="4706"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>blocks<sp/>in<sp/>the<sp/>best<sp/>chain</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4707"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nCheckDepth<sp/>&lt;=<sp/>0<sp/>||<sp/>nCheckDepth<sp/>&gt;<sp/>chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4708"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nCheckDepth<sp/>=<sp/>chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>();</highlight></codeline>
<codeline lineno="4709"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4710"><highlight class="normal"><sp/><sp/><sp/><sp/>nCheckLevel<sp/>=<sp/>std::max(0,<sp/>std::min(4,<sp/>nCheckLevel));</highlight></codeline>
<codeline lineno="4711"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Verifying<sp/>last<sp/>%i<sp/>blocks<sp/>at<sp/>level<sp/>%i&quot;</highlight><highlight class="normal">,<sp/>nCheckDepth,<sp/>nCheckLevel);</highlight></codeline>
<codeline lineno="4712"><highlight class="normal"><sp/><sp/><sp/><sp/>CCoinsViewCache<sp/>coins(&amp;coinsview);</highlight></codeline>
<codeline lineno="4713"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>pindex;</highlight></codeline>
<codeline lineno="4714"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>pindexFailure<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4715"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nGoodTransactions<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="4716"><highlight class="normal"><sp/><sp/><sp/><sp/>BlockValidationState<sp/>state;</highlight></codeline>
<codeline lineno="4717"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>reportDone<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="4718"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>skipped_no_block_data{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="4719"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>skipped_l3_checks{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="4720"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Verification<sp/>progress:<sp/>0%%&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4721"><highlight class="normal"></highlight></codeline>
<codeline lineno="4722"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>is_snapshot_cs{chainstate.<ref refid="class_chainstate_1a37f0e70024a7d2d694ae27d34609de0e" kindref="member">m_from_snapshot_blockhash</ref>};</highlight></codeline>
<codeline lineno="4723"><highlight class="normal"></highlight></codeline>
<codeline lineno="4724"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(pindex<sp/>=<sp/>chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>();<sp/>pindex<sp/>&amp;&amp;<sp/>pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>;<sp/>pindex<sp/>=<sp/>pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4725"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>percentageDone<sp/>=<sp/>std::max(1,<sp/>std::min(99,<sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)(((</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">)(chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>()<sp/>-<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>))<sp/>/<sp/>(</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">)nCheckDepth<sp/>*<sp/>(nCheckLevel<sp/>&gt;=<sp/>4<sp/>?<sp/>50<sp/>:<sp/>100))));</highlight></codeline>
<codeline lineno="4726"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(reportDone<sp/>&lt;<sp/>percentageDone<sp/>/<sp/>10)<sp/>{</highlight></codeline>
<codeline lineno="4727"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>report<sp/>every<sp/>10%<sp/>step</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4728"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Verification<sp/>progress:<sp/>%d%%&quot;</highlight><highlight class="normal">,<sp/>percentageDone);</highlight></codeline>
<codeline lineno="4729"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reportDone<sp/>=<sp/>percentageDone<sp/>/<sp/>10;</highlight></codeline>
<codeline lineno="4730"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4731"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_notifications.progress(<ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight><highlight class="stringliteral">&quot;Verifying<sp/>blocks&quot;</highlight><highlight class="normal">),<sp/>percentageDone,<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4732"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>&lt;=<sp/>chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>()<sp/>-<sp/>nCheckDepth)<sp/>{</highlight></codeline>
<codeline lineno="4733"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4734"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4735"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((chainstate.<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1ad03fd92fad95bb7f82ef78cc467cb12b" kindref="member">IsPruneMode</ref>()<sp/>||<sp/>is_snapshot_cs)<sp/>&amp;&amp;<sp/>!(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15" kindref="member">BLOCK_HAVE_DATA</ref>))<sp/>{</highlight></codeline>
<codeline lineno="4736"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>pruning<sp/>or<sp/>running<sp/>under<sp/>an<sp/>assumeutxo<sp/>snapshot,<sp/>only<sp/>go</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4737"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>back<sp/>as<sp/>far<sp/>as<sp/>we<sp/>have<sp/>data.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4738"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Block<sp/>verification<sp/>stopping<sp/>at<sp/>height<sp/>%d<sp/>(no<sp/>data).<sp/>This<sp/>could<sp/>be<sp/>due<sp/>to<sp/>pruning<sp/>or<sp/>use<sp/>of<sp/>an<sp/>assumeutxo<sp/>snapshot.&quot;</highlight><highlight class="normal">,<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>);</highlight></codeline>
<codeline lineno="4739"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>skipped_no_block_data<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4740"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4741"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4742"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlock<sp/>block;</highlight></codeline>
<codeline lineno="4743"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>check<sp/>level<sp/>0:<sp/>read<sp/>from<sp/>disk</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4744"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!chainstate.<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1ad59bbdccdaca9da495b6b6e80c481a1a" kindref="member">ReadBlock</ref>(block,<sp/>*pindex))<sp/>{</highlight></codeline>
<codeline lineno="4745"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;Verification<sp/>error:<sp/>ReadBlock<sp/>failed<sp/>at<sp/>%d,<sp/>hash=%s&quot;</highlight><highlight class="normal">,<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4746"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a9a734f0900dfff66f62decfddec72a0da0a5072778adedc1e60a44588f737b854" kindref="member">VerifyDBResult::CORRUPTED_BLOCK_DB</ref>;</highlight></codeline>
<codeline lineno="4747"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4748"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>check<sp/>level<sp/>1:<sp/>verify<sp/>block<sp/>validity</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4749"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nCheckLevel<sp/>&gt;=<sp/>1<sp/>&amp;&amp;<sp/>!<ref refid="validation_8h_1a9d72a901e6237b2e81465a7425f4112c" kindref="member">CheckBlock</ref>(block,<sp/>state,<sp/>consensus_params))<sp/>{</highlight></codeline>
<codeline lineno="4750"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;Verification<sp/>error:<sp/>found<sp/>bad<sp/>block<sp/>at<sp/>%d,<sp/>hash=%s<sp/>(%s)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="4751"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4752"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a9a734f0900dfff66f62decfddec72a0da0a5072778adedc1e60a44588f737b854" kindref="member">VerifyDBResult::CORRUPTED_BLOCK_DB</ref>;</highlight></codeline>
<codeline lineno="4753"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4754"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>check<sp/>level<sp/>2:<sp/>verify<sp/>undo<sp/>validity</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4755"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nCheckLevel<sp/>&gt;=<sp/>2<sp/>&amp;&amp;<sp/>pindex)<sp/>{</highlight></codeline>
<codeline lineno="4756"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockUndo<sp/>undo;</highlight></codeline>
<codeline lineno="4757"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pindex-&gt;<ref refid="class_c_block_index_1a37b29f13da5482bc75761efd78ef9002" kindref="member">GetUndoPos</ref>().<ref refid="struct_flat_file_pos_1ac4d637a0dec45d546495c1660c9f6047" kindref="member">IsNull</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4758"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!chainstate.<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1a054cbf50f4e5cb582fd744927f9ace7a" kindref="member">ReadBlockUndo</ref>(undo,<sp/>*pindex))<sp/>{</highlight></codeline>
<codeline lineno="4759"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;Verification<sp/>error:<sp/>found<sp/>bad<sp/>undo<sp/>data<sp/>at<sp/>%d,<sp/>hash=%s&quot;</highlight><highlight class="normal">,<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4760"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a9a734f0900dfff66f62decfddec72a0da0a5072778adedc1e60a44588f737b854" kindref="member">VerifyDBResult::CORRUPTED_BLOCK_DB</ref>;</highlight></codeline>
<codeline lineno="4761"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4762"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4763"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4764"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>check<sp/>level<sp/>3:<sp/>check<sp/>for<sp/>inconsistencies<sp/>during<sp/>memory-only<sp/>disconnect<sp/>of<sp/>tip<sp/>blocks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4765"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>curr_coins_usage<sp/>=<sp/>coins.DynamicMemoryUsage()<sp/>+<sp/>chainstate.<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>().<ref refid="class_c_coins_view_cache_1afcc22204abc15aeefd5d1f7396e909a4" kindref="member">DynamicMemoryUsage</ref>();</highlight></codeline>
<codeline lineno="4766"><highlight class="normal"></highlight></codeline>
<codeline lineno="4767"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nCheckLevel<sp/>&gt;=<sp/>3)<sp/>{</highlight></codeline>
<codeline lineno="4768"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(curr_coins_usage<sp/>&lt;=<sp/>chainstate.<ref refid="class_chainstate_1a9f27f82f81429b6be783bb2ba38a7383" kindref="member">m_coinstip_cache_size_bytes</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4769"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(coins.<ref refid="class_c_coins_view_1a32e48fb2d05ede4a1eb6d2709aa0436c" kindref="member">GetBestBlock</ref>()<sp/>==<sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>());</highlight></codeline>
<codeline lineno="4770"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8h_1aeaef80b01ee5387f474a63ed23c9cc50" kindref="member">DisconnectResult</ref><sp/>res<sp/>=<sp/>chainstate.DisconnectBlock(block,<sp/>pindex,<sp/>coins);</highlight></codeline>
<codeline lineno="4771"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>==<sp/><ref refid="validation_8h_1aeaef80b01ee5387f474a63ed23c9cc50a4b6c24922aff8a510f83333397b4c9b3" kindref="member">DISCONNECT_FAILED</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4772"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;Verification<sp/>error:<sp/>irrecoverable<sp/>inconsistency<sp/>in<sp/>block<sp/>data<sp/>at<sp/>%d,<sp/>hash=%s&quot;</highlight><highlight class="normal">,<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4773"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a9a734f0900dfff66f62decfddec72a0da0a5072778adedc1e60a44588f737b854" kindref="member">VerifyDBResult::CORRUPTED_BLOCK_DB</ref>;</highlight></codeline>
<codeline lineno="4774"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4775"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>==<sp/><ref refid="validation_8h_1aeaef80b01ee5387f474a63ed23c9cc50a538a133d18fdc8786c4b0f0e6662f6c5" kindref="member">DISCONNECT_UNCLEAN</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4776"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nGoodTransactions<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="4777"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexFailure<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="4778"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4779"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nGoodTransactions<sp/>+=<sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>.size();</highlight></codeline>
<codeline lineno="4780"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4781"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4782"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>skipped_l3_checks<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4783"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4784"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4785"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(chainstate.<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.<ref refid="class_chainstate_manager_1a2163d8ef789c585b196a3ec7f468244b" kindref="member">m_interrupt</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a9a734f0900dfff66f62decfddec72a0da658f2cadfdf09b6046246e9314f7cd43" kindref="member">VerifyDBResult::INTERRUPTED</ref>;</highlight></codeline>
<codeline lineno="4786"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4787"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexFailure)<sp/>{</highlight></codeline>
<codeline lineno="4788"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;Verification<sp/>error:<sp/>coin<sp/>database<sp/>inconsistencies<sp/>found<sp/>(last<sp/>%i<sp/>blocks,<sp/>%i<sp/>good<sp/>transactions<sp/>before<sp/>that)&quot;</highlight><highlight class="normal">,<sp/>chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>()<sp/>-<sp/>pindexFailure-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>+<sp/>1,<sp/>nGoodTransactions);</highlight></codeline>
<codeline lineno="4789"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a9a734f0900dfff66f62decfddec72a0da0a5072778adedc1e60a44588f737b854" kindref="member">VerifyDBResult::CORRUPTED_BLOCK_DB</ref>;</highlight></codeline>
<codeline lineno="4790"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4791"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(skipped_l3_checks)<sp/>{</highlight></codeline>
<codeline lineno="4792"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;Skipped<sp/>verification<sp/>of<sp/>level<sp/>&gt;=3<sp/>(insufficient<sp/>database<sp/>cache<sp/>size).<sp/>Consider<sp/>increasing<sp/>-dbcache.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4793"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4794"><highlight class="normal"></highlight></codeline>
<codeline lineno="4795"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>store<sp/>block<sp/>count<sp/>as<sp/>we<sp/>move<sp/>pindex<sp/>at<sp/>check<sp/>level<sp/>&gt;=<sp/>4</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4796"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>block_count<sp/>=<sp/>chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>()<sp/>-<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>;</highlight></codeline>
<codeline lineno="4797"><highlight class="normal"></highlight></codeline>
<codeline lineno="4798"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>check<sp/>level<sp/>4:<sp/>try<sp/>reconnecting<sp/>blocks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4799"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nCheckLevel<sp/>&gt;=<sp/>4<sp/>&amp;&amp;<sp/>!skipped_l3_checks)<sp/>{</highlight></codeline>
<codeline lineno="4800"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(pindex<sp/>!=<sp/>chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4801"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>percentageDone<sp/>=<sp/>std::max(1,<sp/>std::min(99,<sp/>100<sp/>-<sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)(((</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">)(chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>()<sp/>-<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>))<sp/>/<sp/>(</highlight><highlight class="keywordtype">double</highlight><highlight class="normal">)nCheckDepth<sp/>*<sp/>50)));</highlight></codeline>
<codeline lineno="4802"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(reportDone<sp/>&lt;<sp/>percentageDone<sp/>/<sp/>10)<sp/>{</highlight></codeline>
<codeline lineno="4803"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>report<sp/>every<sp/>10%<sp/>step</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4804"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Verification<sp/>progress:<sp/>%d%%&quot;</highlight><highlight class="normal">,<sp/>percentageDone);</highlight></codeline>
<codeline lineno="4805"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reportDone<sp/>=<sp/>percentageDone<sp/>/<sp/>10;</highlight></codeline>
<codeline lineno="4806"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4807"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_notifications.progress(<ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight><highlight class="stringliteral">&quot;Verifying<sp/>blocks&quot;</highlight><highlight class="normal">),<sp/>percentageDone,<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4808"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex<sp/>=<sp/>chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a17a69b4d98b0a7116058f3d6414dda3c" kindref="member">Next</ref>(pindex);</highlight></codeline>
<codeline lineno="4809"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlock<sp/>block;</highlight></codeline>
<codeline lineno="4810"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!chainstate.<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1ad59bbdccdaca9da495b6b6e80c481a1a" kindref="member">ReadBlock</ref>(block,<sp/>*pindex))<sp/>{</highlight></codeline>
<codeline lineno="4811"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;Verification<sp/>error:<sp/>ReadBlock<sp/>failed<sp/>at<sp/>%d,<sp/>hash=%s&quot;</highlight><highlight class="normal">,<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4812"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a9a734f0900dfff66f62decfddec72a0da0a5072778adedc1e60a44588f737b854" kindref="member">VerifyDBResult::CORRUPTED_BLOCK_DB</ref>;</highlight></codeline>
<codeline lineno="4813"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4814"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!chainstate.<ref refid="class_chainstate_1a0487c7fe4cdc89e309556f86c2988c80" kindref="member">ConnectBlock</ref>(block,<sp/>state,<sp/>pindex,<sp/>coins))<sp/>{</highlight></codeline>
<codeline lineno="4815"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;Verification<sp/>error:<sp/>found<sp/>unconnectable<sp/>block<sp/>at<sp/>%d,<sp/>hash=%s<sp/>(%s)&quot;</highlight><highlight class="normal">,<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4816"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a9a734f0900dfff66f62decfddec72a0da0a5072778adedc1e60a44588f737b854" kindref="member">VerifyDBResult::CORRUPTED_BLOCK_DB</ref>;</highlight></codeline>
<codeline lineno="4817"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4818"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(chainstate.<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.<ref refid="class_chainstate_manager_1a2163d8ef789c585b196a3ec7f468244b" kindref="member">m_interrupt</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a9a734f0900dfff66f62decfddec72a0da658f2cadfdf09b6046246e9314f7cd43" kindref="member">VerifyDBResult::INTERRUPTED</ref>;</highlight></codeline>
<codeline lineno="4819"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4820"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4821"><highlight class="normal"></highlight></codeline>
<codeline lineno="4822"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Verification:<sp/>No<sp/>coin<sp/>database<sp/>inconsistencies<sp/>in<sp/>last<sp/>%i<sp/>blocks<sp/>(%i<sp/>transactions)&quot;</highlight><highlight class="normal">,<sp/>block_count,<sp/>nGoodTransactions);</highlight></codeline>
<codeline lineno="4823"><highlight class="normal"></highlight></codeline>
<codeline lineno="4824"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(skipped_l3_checks)<sp/>{</highlight></codeline>
<codeline lineno="4825"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a9a734f0900dfff66f62decfddec72a0da9a7bd0f9f21b72949998b0fe80703361" kindref="member">VerifyDBResult::SKIPPED_L3_CHECKS</ref>;</highlight></codeline>
<codeline lineno="4826"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4827"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(skipped_no_block_data)<sp/>{</highlight></codeline>
<codeline lineno="4828"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a9a734f0900dfff66f62decfddec72a0da4d3c4b7041036a310df02b7d4ca6568d" kindref="member">VerifyDBResult::SKIPPED_MISSING_BLOCKS</ref>;</highlight></codeline>
<codeline lineno="4829"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4830"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a9a734f0900dfff66f62decfddec72a0dad0749aaba8b833466dfcbb0428e4f89c" kindref="member">VerifyDBResult::SUCCESS</ref>;</highlight></codeline>
<codeline lineno="4831"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4832"><highlight class="normal"></highlight></codeline>
<codeline lineno="4834"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1a3a178fcf153b41445571e1153d23707c" kindref="member">Chainstate::RollforwardBlock</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>pindex,<sp/><ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref>&amp;<sp/>inputs)</highlight></codeline>
<codeline lineno="4835"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4836"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4837"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>TODO:<sp/>merge<sp/>with<sp/>ConnectBlock</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4838"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlock<sp/>block;</highlight></codeline>
<codeline lineno="4839"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.ReadBlock(block,<sp/>*pindex))<sp/>{</highlight></codeline>
<codeline lineno="4840"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;ReplayBlock():<sp/>ReadBlock<sp/>failed<sp/>at<sp/>%d,<sp/>hash=%s\n&quot;</highlight><highlight class="normal">,<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4841"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4842"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4843"><highlight class="normal"></highlight></codeline>
<codeline lineno="4844"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref>&amp;<sp/>tx<sp/>:<sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4845"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tx-&gt;IsCoinBase())<sp/>{</highlight></codeline>
<codeline lineno="4846"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CTxIn<sp/>&amp;txin<sp/>:<sp/>tx-&gt;vin)<sp/>{</highlight></codeline>
<codeline lineno="4847"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>inputs.<ref refid="class_c_coins_view_cache_1af5547d7b4e71fcf9319ab7a12f7f20e0" kindref="member">SpendCoin</ref>(txin.<ref refid="class_c_tx_in_1a1c567359e133d98c72b5e9a928ffd41a" kindref="member">prevout</ref>);</highlight></codeline>
<codeline lineno="4848"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4849"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4850"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Pass<sp/>check<sp/>=<sp/>true<sp/>as<sp/>every<sp/>addition<sp/>may<sp/>be<sp/>an<sp/>overwrite.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4851"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="coins_8cpp_1ae4190d2c27c3c27c7fb6ad026ca11beb" kindref="member">AddCoins</ref>(inputs,<sp/>*tx,<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4852"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4853"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4854"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4855"><highlight class="normal"></highlight></codeline>
<codeline lineno="4856"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1abfebdf0f5e72069d4dfc2486fc590e08" kindref="member">Chainstate::ReplayBlocks</ref>()</highlight></codeline>
<codeline lineno="4857"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4858"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4859"><highlight class="normal"></highlight></codeline>
<codeline lineno="4860"><highlight class="normal"><sp/><sp/><sp/><sp/>CCoinsView&amp;<sp/>db<sp/>=<sp/>this-&gt;<ref refid="class_chainstate_1ad876ac510821396146002e921946e008" kindref="member">CoinsDB</ref>();</highlight></codeline>
<codeline lineno="4861"><highlight class="normal"><sp/><sp/><sp/><sp/>CCoinsViewCache<sp/>cache(&amp;db);</highlight></codeline>
<codeline lineno="4862"><highlight class="normal"></highlight></codeline>
<codeline lineno="4863"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;uint256&gt;<sp/>hashHeads<sp/>=<sp/>db.<ref refid="class_c_coins_view_1a0793beb40f9e77c408cd673ff38cbc8b" kindref="member">GetHeadBlocks</ref>();</highlight></codeline>
<codeline lineno="4864"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(hashHeads.empty())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>We&apos;re<sp/>already<sp/>in<sp/>a<sp/>consistent<sp/>state.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4865"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(hashHeads.size()<sp/>!=<sp/>2)<sp/>{</highlight></codeline>
<codeline lineno="4866"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;ReplayBlocks():<sp/>unknown<sp/>inconsistent<sp/>state\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4867"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4868"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4869"><highlight class="normal"></highlight></codeline>
<codeline lineno="4870"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetNotifications().progress(<ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight><highlight class="stringliteral">&quot;Replaying<sp/>blocks&quot;</highlight><highlight class="normal">),<sp/>0,<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4871"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Replaying<sp/>blocks&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4872"><highlight class="normal"></highlight></codeline>
<codeline lineno="4873"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindexOld<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;<sp/><sp/></highlight><highlight class="comment">//<sp/>Old<sp/>tip<sp/>during<sp/>the<sp/>interrupted<sp/>flush.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4874"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindexNew;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>New<sp/>tip<sp/>during<sp/>the<sp/>interrupted<sp/>flush.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4875"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindexFork<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>Latest<sp/>block<sp/>common<sp/>to<sp/>both<sp/>the<sp/>old<sp/>and<sp/>the<sp/>new<sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4876"><highlight class="normal"></highlight></codeline>
<codeline lineno="4877"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_block_index.contains(hashHeads[0]))<sp/>{</highlight></codeline>
<codeline lineno="4878"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;ReplayBlocks():<sp/>reorganization<sp/>to<sp/>unknown<sp/>block<sp/>requested\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4879"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4880"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4881"><highlight class="normal"><sp/><sp/><sp/><sp/>pindexNew<sp/>=<sp/>&amp;(<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_block_index[hashHeads[0]]);</highlight></codeline>
<codeline lineno="4882"><highlight class="normal"></highlight></codeline>
<codeline lineno="4883"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!hashHeads[1].IsNull())<sp/>{<sp/></highlight><highlight class="comment">//<sp/>The<sp/>old<sp/>tip<sp/>is<sp/>allowed<sp/>to<sp/>be<sp/>0,<sp/>indicating<sp/>it&apos;s<sp/>the<sp/>first<sp/>flush.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4884"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_block_index.contains(hashHeads[1]))<sp/>{</highlight></codeline>
<codeline lineno="4885"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;ReplayBlocks():<sp/>reorganization<sp/>from<sp/>unknown<sp/>block<sp/>requested\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4886"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4887"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4888"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexOld<sp/>=<sp/>&amp;(<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_block_index[hashHeads[1]]);</highlight></codeline>
<codeline lineno="4889"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexFork<sp/>=<sp/><ref refid="chain_8cpp_1add771d649e0005eaf353c1d04626df91" kindref="member">LastCommonAncestor</ref>(pindexOld,<sp/>pindexNew);</highlight></codeline>
<codeline lineno="4890"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindexFork<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4891"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4892"><highlight class="normal"></highlight></codeline>
<codeline lineno="4893"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Rollback<sp/>along<sp/>the<sp/>old<sp/>branch.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4894"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nForkHeight{pindexFork<sp/>?<sp/>pindexFork-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>:<sp/>0};</highlight></codeline>
<codeline lineno="4895"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexOld<sp/>!=<sp/>pindexFork)<sp/>{</highlight></codeline>
<codeline lineno="4896"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Rolling<sp/>back<sp/>from<sp/>%s<sp/>(%i<sp/>to<sp/>%i)&quot;</highlight><highlight class="normal">,<sp/>pindexOld-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>pindexOld-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>nForkHeight);</highlight></codeline>
<codeline lineno="4897"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(pindexOld<sp/>!=<sp/>pindexFork)<sp/>{</highlight></codeline>
<codeline lineno="4898"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexOld-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>&gt;<sp/>0)<sp/>{<sp/></highlight><highlight class="comment">//<sp/>Never<sp/>disconnect<sp/>the<sp/>genesis<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4899"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlock<sp/>block;</highlight></codeline>
<codeline lineno="4900"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.ReadBlock(block,<sp/>*pindexOld))<sp/>{</highlight></codeline>
<codeline lineno="4901"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;RollbackBlock():<sp/>ReadBlock()<sp/>failed<sp/>at<sp/>%d,<sp/>hash=%s\n&quot;</highlight><highlight class="normal">,<sp/>pindexOld-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>pindexOld-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4902"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4903"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4904"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexOld-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>%<sp/>10&apos;000<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="4905"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Rolling<sp/>back<sp/>%s<sp/>(%i)&quot;</highlight><highlight class="normal">,<sp/>pindexOld-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>pindexOld-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>);</highlight></codeline>
<codeline lineno="4906"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4907"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8h_1aeaef80b01ee5387f474a63ed23c9cc50" kindref="member">DisconnectResult</ref><sp/>res<sp/>=<sp/>DisconnectBlock(block,<sp/>pindexOld,<sp/>cache);</highlight></codeline>
<codeline lineno="4908"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(res<sp/>==<sp/><ref refid="validation_8h_1aeaef80b01ee5387f474a63ed23c9cc50a4b6c24922aff8a510f83333397b4c9b3" kindref="member">DISCONNECT_FAILED</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4909"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;RollbackBlock():<sp/>DisconnectBlock<sp/>failed<sp/>at<sp/>%d,<sp/>hash=%s\n&quot;</highlight><highlight class="normal">,<sp/>pindexOld-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>pindexOld-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4910"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4911"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4912"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>DISCONNECT_UNCLEAN<sp/>is<sp/>returned,<sp/>it<sp/>means<sp/>a<sp/>non-existing<sp/>UTXO<sp/>was<sp/>deleted,<sp/>or<sp/>an<sp/>existing<sp/>UTXO<sp/>was</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4913"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>overwritten.<sp/>It<sp/>corresponds<sp/>to<sp/>cases<sp/>where<sp/>the<sp/>block-to-be-disconnect<sp/>never<sp/>had<sp/>all<sp/>its<sp/>operations</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4914"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>applied<sp/>to<sp/>the<sp/>UTXO<sp/>set.<sp/>However,<sp/>as<sp/>both<sp/>writing<sp/>a<sp/>UTXO<sp/>and<sp/>deleting<sp/>a<sp/>UTXO<sp/>are<sp/>idempotent<sp/>operations,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4915"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>result<sp/>is<sp/>still<sp/>a<sp/>version<sp/>of<sp/>the<sp/>UTXO<sp/>set<sp/>with<sp/>the<sp/>effects<sp/>of<sp/>that<sp/>block<sp/>undone.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4916"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4917"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexOld<sp/>=<sp/>pindexOld-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>;</highlight></codeline>
<codeline lineno="4918"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4919"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Rolled<sp/>back<sp/>to<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>pindexFork-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4920"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4921"><highlight class="normal"></highlight></codeline>
<codeline lineno="4922"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Roll<sp/>forward<sp/>from<sp/>the<sp/>forking<sp/>point<sp/>to<sp/>the<sp/>new<sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4923"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nForkHeight<sp/>&lt;<sp/>pindexNew-&gt;<ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4924"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Rolling<sp/>forward<sp/>to<sp/>%s<sp/>(%i<sp/>to<sp/>%i)&quot;</highlight><highlight class="normal">,<sp/>pindexNew-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>nForkHeight,<sp/>pindexNew-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>);</highlight></codeline>
<codeline lineno="4925"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref><sp/>=<sp/>nForkHeight<sp/>+<sp/>1;<sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref><sp/>&lt;=<sp/>pindexNew-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>;<sp/>++<ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4926"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex&amp;<sp/>pindex{*<ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(pindexNew-&gt;<ref refid="class_c_block_index_1ac20120d6b64792647a63d216b26e4b53" kindref="member">GetAncestor</ref>(<ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref>))};</highlight></codeline>
<codeline lineno="4927"><highlight class="normal"></highlight></codeline>
<codeline lineno="4928"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref><sp/>%<sp/>10&apos;000<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="4929"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Rolling<sp/>forward<sp/>%s<sp/>(%i)&quot;</highlight><highlight class="normal">,<sp/>pindex.<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref>);</highlight></codeline>
<codeline lineno="4930"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4931"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetNotifications().progress(<ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight><highlight class="stringliteral">&quot;Replaying<sp/>blocks&quot;</highlight><highlight class="normal">),<sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)((<ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref><sp/>-<sp/>nForkHeight)<sp/>*<sp/>100.0<sp/>/<sp/>(pindexNew-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>-<sp/>nForkHeight)),<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4932"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_1a3a178fcf153b41445571e1153d23707c" kindref="member">RollforwardBlock</ref>(&amp;pindex,<sp/>cache))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4933"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4934"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Rolled<sp/>forward<sp/>to<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>pindexNew-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4935"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4936"><highlight class="normal"></highlight></codeline>
<codeline lineno="4937"><highlight class="normal"><sp/><sp/><sp/><sp/>cache.SetBestBlock(pindexNew-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>());</highlight></codeline>
<codeline lineno="4938"><highlight class="normal"><sp/><sp/><sp/><sp/>cache.Flush(</highlight><highlight class="comment">/*will_reuse_cache=*/</highlight><highlight class="keyword">false</highlight><highlight class="normal">);<sp/></highlight><highlight class="comment">//<sp/>local<sp/>CCoinsViewCache<sp/>goes<sp/>out<sp/>of<sp/>scope</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4939"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetNotifications().progress(bilingual_str{},<sp/>100,<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4940"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4941"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4942"><highlight class="normal"></highlight></codeline>
<codeline lineno="4943"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1a2e0fcf64c918330f1f0ca3be2a117da2" kindref="member">Chainstate::NeedsRedownload</ref>()</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="4944"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="4945"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4946"><highlight class="normal"></highlight></codeline>
<codeline lineno="4947"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>At<sp/>and<sp/>above<sp/>m_params.SegwitHeight,<sp/>segwit<sp/>consensus<sp/>rules<sp/>must<sp/>be<sp/>validated</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4948"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>block{<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip()};</highlight></codeline>
<codeline lineno="4949"><highlight class="normal"></highlight></codeline>
<codeline lineno="4950"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(block<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/><ref refid="validation_8h_1ac799f78d8f44b330f7990a7eeb3071d2" kindref="member">DeploymentActiveAt</ref>(*block,<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dbac12a10e827db62556122f2b1a9b0431b" kindref="member">Consensus::DEPLOYMENT_SEGWIT</ref>))<sp/>{</highlight></codeline>
<codeline lineno="4951"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!(block-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93adabb5ecf540d50ee9d9f1846609d59caf5" kindref="member">BLOCK_OPT_WITNESS</ref>))<sp/>{</highlight></codeline>
<codeline lineno="4952"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>block<sp/>is<sp/>insufficiently<sp/>validated<sp/>for<sp/>a<sp/>segwit<sp/>client</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4953"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4954"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4955"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>block<sp/>=<sp/>block-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>;</highlight></codeline>
<codeline lineno="4956"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4957"><highlight class="normal"></highlight></codeline>
<codeline lineno="4958"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4959"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4960"><highlight class="normal"></highlight></codeline>
<codeline lineno="4961"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>Chainstate::ClearBlockIndexCandidates()</highlight></codeline>
<codeline lineno="4962"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4963"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="4964"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.clear();</highlight></codeline>
<codeline lineno="4965"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4966"><highlight class="normal"></highlight></codeline>
<codeline lineno="4967"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager_1a665765220796597313f5ea2daa980354" kindref="member">ChainstateManager::LoadBlockIndex</ref>()</highlight></codeline>
<codeline lineno="4968"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4969"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4970"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Load<sp/>block<sp/>index<sp/>from<sp/>databases</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4971"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_blockfiles_indexed)<sp/>{</highlight></codeline>
<codeline lineno="4972"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>{<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.LoadBlockIndexDB(<ref refid="class_chainstate_manager_1a8d39d359e6ed774815dc8d31f326ff82" kindref="member">CurrentChainstate</ref>().m_from_snapshot_blockhash)};</highlight></codeline>
<codeline lineno="4973"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4974"><highlight class="normal"></highlight></codeline>
<codeline lineno="4975"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.ScanAndUnlinkAlreadyPrunedFiles();</highlight></codeline>
<codeline lineno="4976"><highlight class="normal"></highlight></codeline>
<codeline lineno="4977"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CBlockIndex*&gt;<sp/>vSortedByHeight{<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.GetAllBlockIndices()};</highlight></codeline>
<codeline lineno="4978"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::sort(vSortedByHeight.begin(),<sp/>vSortedByHeight.end(),</highlight></codeline>
<codeline lineno="4979"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockIndexHeightOnlyComparator());</highlight></codeline>
<codeline lineno="4980"><highlight class="normal"></highlight></codeline>
<codeline lineno="4981"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(CBlockIndex*<sp/>pindex<sp/>:<sp/>vSortedByHeight)<sp/>{</highlight></codeline>
<codeline lineno="4982"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_manager_1a2163d8ef789c585b196a3ec7f468244b" kindref="member">m_interrupt</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4983"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>have<sp/>an<sp/>assumeutxo-based<sp/>chainstate,<sp/>then<sp/>the<sp/>snapshot</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4984"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>block<sp/>will<sp/>be<sp/>a<sp/>candidate<sp/>for<sp/>the<sp/>tip,<sp/>but<sp/>it<sp/>may<sp/>not<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4985"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>VALID_TRANSACTIONS<sp/>(eg<sp/>if<sp/>we<sp/>haven&apos;t<sp/>yet<sp/>downloaded<sp/>the<sp/>block),</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4986"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>so<sp/>we<sp/>special-case<sp/>the<sp/>snapshot<sp/>block<sp/>as<sp/>a<sp/>potential<sp/>candidate</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4987"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>here.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4988"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex<sp/>==<sp/><ref refid="class_chainstate_manager_1a8d39d359e6ed774815dc8d31f326ff82" kindref="member">CurrentChainstate</ref>().SnapshotBase()<sp/>||</highlight></codeline>
<codeline lineno="4989"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(pindex-&gt;<ref refid="class_c_block_index_1a1b5a636925d1c416b9d59eb0392a7a62" kindref="member">IsValid</ref>(<ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada3eef30f876594ac79b888b7d1ff6c66c" kindref="member">BLOCK_VALID_TRANSACTIONS</ref>)<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="4990"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(pindex-&gt;<ref refid="class_c_block_index_1ae804dd1f9a78669920c2bc21dc7a9812" kindref="member">HaveNumChainTxs</ref>()<sp/>||<sp/>pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)))<sp/>{</highlight></codeline>
<codeline lineno="4991"><highlight class="normal"></highlight></codeline>
<codeline lineno="4992"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>chainstate<sp/>:<sp/>m_chainstates)<sp/>{</highlight></codeline>
<codeline lineno="4993"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>chainstate-&gt;<ref refid="class_chainstate_1ab86ef2ab974ae064997b910e161c4849" kindref="member">TryAddBlockIndexCandidate</ref>(pindex);</highlight></codeline>
<codeline lineno="4994"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4995"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4996"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada88df51e92f2f675baff60e0a5bd170ef" kindref="member">BLOCK_FAILED_MASK</ref><sp/>&amp;&amp;<sp/>(!m_best_invalid<sp/>||<sp/>pindex-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&gt;<sp/>m_best_invalid-&gt;nChainWork))<sp/>{</highlight></codeline>
<codeline lineno="4997"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_best_invalid<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="4998"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4999"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1a1b5a636925d1c416b9d59eb0392a7a62" kindref="member">IsValid</ref>(<ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada67f3a88eeb793cc62f427f87ae830573" kindref="member">BLOCK_VALID_TREE</ref>)<sp/>&amp;&amp;<sp/>(m_best_header<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>||<sp/>CBlockIndexWorkComparator()(m_best_header,<sp/>pindex)))</highlight></codeline>
<codeline lineno="5000"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_best_header<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="5001"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5002"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5003"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5004"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5005"><highlight class="normal"></highlight></codeline>
<codeline lineno="5006"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_1a1012305331357fcebb918b4e55b92448" kindref="member">Chainstate::LoadGenesisBlock</ref>()</highlight></codeline>
<codeline lineno="5007"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5008"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="5009"><highlight class="normal"></highlight></codeline>
<codeline lineno="5010"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CChainParams&amp;<sp/>params{<ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.GetParams()};</highlight></codeline>
<codeline lineno="5011"><highlight class="normal"></highlight></codeline>
<codeline lineno="5012"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>whether<sp/>we&apos;re<sp/>already<sp/>initialized<sp/>by<sp/>checking<sp/>for<sp/>genesis<sp/>in</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5013"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>m_blockman.m_block_index.<sp/>Note<sp/>that<sp/>we<sp/>can&apos;t<sp/>use<sp/>m_chain<sp/>here,<sp/>since<sp/>it<sp/>is</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5014"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>set<sp/>based<sp/>on<sp/>the<sp/>coins<sp/>db,<sp/>not<sp/>the<sp/>block<sp/>index<sp/>db,<sp/>which<sp/>is<sp/>the<sp/>only</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5015"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>thing<sp/>loaded<sp/>at<sp/>this<sp/>point.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5016"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.m_block_index.contains(params.<ref refid="class_c_chain_params_1a83a289ab24dc02bdaf7cd1d18ade0f9d" kindref="member">GenesisBlock</ref>().<ref refid="class_c_block_header_1a6df30b63c4634d52dfeaadb46d60d0f5" kindref="member">GetHash</ref>()))</highlight></codeline>
<codeline lineno="5017"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5018"><highlight class="normal"></highlight></codeline>
<codeline lineno="5019"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5020"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlock&amp;<sp/>block<sp/>=<sp/>params.<ref refid="class_c_chain_params_1a83a289ab24dc02bdaf7cd1d18ade0f9d" kindref="member">GenesisBlock</ref>();</highlight></codeline>
<codeline lineno="5021"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>FlatFilePos<sp/>blockPos{<ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.WriteBlock(block,<sp/>0)};</highlight></codeline>
<codeline lineno="5022"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(blockPos.<ref refid="struct_flat_file_pos_1ac4d637a0dec45d546495c1660c9f6047" kindref="member">IsNull</ref>())<sp/>{</highlight></codeline>
<codeline lineno="5023"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;%s:<sp/>writing<sp/>genesis<sp/>block<sp/>to<sp/>disk<sp/>failed\n&quot;</highlight><highlight class="normal">,<sp/>__func__);</highlight></codeline>
<codeline lineno="5024"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5025"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5026"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>pindex<sp/>=<sp/><ref refid="class_chainstate_1ae4a76e5b8e269dba63add5f28146fbee" kindref="member">m_blockman</ref>.AddToBlockIndex(block,<sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.m_best_header);</highlight></codeline>
<codeline lineno="5027"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a849eb656e60bb05783801b88ea02c020" kindref="member">m_chainman</ref>.ReceivedBlockTransactions(block,<sp/>pindex,<sp/>blockPos);</highlight></codeline>
<codeline lineno="5028"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::runtime_error&amp;<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="5029"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;%s:<sp/>failed<sp/>to<sp/>write<sp/>genesis<sp/>block:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>e.what());</highlight></codeline>
<codeline lineno="5030"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5031"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5032"><highlight class="normal"></highlight></codeline>
<codeline lineno="5033"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5034"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5035"><highlight class="normal"></highlight></codeline>
<codeline lineno="5036"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager_1a7fa295c24afe0ecd3e603b695fae303c" kindref="member">ChainstateManager::LoadExternalBlockFile</ref>(</highlight></codeline>
<codeline lineno="5037"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_auto_file" kindref="compound">AutoFile</ref>&amp;<sp/>file_in,</highlight></codeline>
<codeline lineno="5038"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_flat_file_pos" kindref="compound">FlatFilePos</ref>*<sp/>dbp,</highlight></codeline>
<codeline lineno="5039"><highlight class="normal"><sp/><sp/><sp/><sp/>std::multimap&lt;uint256,<sp/>FlatFilePos&gt;*<sp/>blocks_with_unknown_parent)</highlight></codeline>
<codeline lineno="5040"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5041"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Either<sp/>both<sp/>should<sp/>be<sp/>specified<sp/>(-reindex),<sp/>or<sp/>neither<sp/>(-loadblock).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5042"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!dbp<sp/>==<sp/>!blocks_with_unknown_parent);</highlight></codeline>
<codeline lineno="5043"><highlight class="normal"></highlight></codeline>
<codeline lineno="5044"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>start{SteadyClock::now()};</highlight></codeline>
<codeline lineno="5045"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CChainParams&amp;<sp/>params{<ref refid="class_chainstate_manager_1a9fc4893dda46aba09dbcd01e3387ca6f" kindref="member">GetParams</ref>()};</highlight></codeline>
<codeline lineno="5046"><highlight class="normal"></highlight></codeline>
<codeline lineno="5047"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nLoaded<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="5048"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5049"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BufferedFile<sp/>blkdat{file_in,<sp/>2<sp/>*<sp/>MAX_BLOCK_SERIALIZED_SIZE,<sp/>MAX_BLOCK_SERIALIZED_SIZE<sp/>+<sp/>8};</highlight></codeline>
<codeline lineno="5050"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>nRewind<sp/>indicates<sp/>where<sp/>to<sp/>resume<sp/>scanning<sp/>in<sp/>case<sp/>something<sp/>goes<sp/>wrong,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5051"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>such<sp/>as<sp/>a<sp/>block<sp/>fails<sp/>to<sp/>deserialize.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5052"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>nRewind<sp/>=<sp/>blkdat.<ref refid="class_buffered_file_1a778c4f86039affe888b393f21c9dd513" kindref="member">GetPos</ref>();</highlight></codeline>
<codeline lineno="5053"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(!blkdat.<ref refid="class_buffered_file_1af3418ac60d0d7a303478f29a387feb3c" kindref="member">eof</ref>())<sp/>{</highlight></codeline>
<codeline lineno="5054"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_manager_1a2163d8ef789c585b196a3ec7f468244b" kindref="member">m_interrupt</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5055"><highlight class="normal"></highlight></codeline>
<codeline lineno="5056"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blkdat.<ref refid="class_buffered_file_1a7c773de65b830cea519c98eec5f5cbd7" kindref="member">SetPos</ref>(nRewind);</highlight></codeline>
<codeline lineno="5057"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nRewind++;<sp/></highlight><highlight class="comment">//<sp/>start<sp/>one<sp/>byte<sp/>further<sp/>next<sp/>time,<sp/>in<sp/>case<sp/>of<sp/>failure</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5058"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blkdat.<ref refid="class_buffered_file_1a92fdace7fde421c0df0f831b778ed5b5" kindref="member">SetLimit</ref>();<sp/></highlight><highlight class="comment">//<sp/>remove<sp/>former<sp/>limit</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5059"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nSize<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="5060"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5061"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>locate<sp/>a<sp/>header</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5062"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="messagestartchars_8h_1a36e9a2b67a1635319b4fa1545597c60e" kindref="member">MessageStartChars</ref><sp/>buf;</highlight></codeline>
<codeline lineno="5063"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blkdat.<ref refid="class_buffered_file_1a87660863e6e21542cef2027e833b411c" kindref="member">FindByte</ref>(std::byte(params.<ref refid="class_c_chain_params_1a9e20d3bce808ed051e558e9661c6075b" kindref="member">MessageStart</ref>()[0]));</highlight></codeline>
<codeline lineno="5064"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nRewind<sp/>=<sp/>blkdat.<ref refid="class_buffered_file_1a778c4f86039affe888b393f21c9dd513" kindref="member">GetPos</ref>()<sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="5065"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blkdat<sp/>&gt;&gt;<sp/>buf;</highlight></codeline>
<codeline lineno="5066"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(buf<sp/>!=<sp/>params.<ref refid="class_c_chain_params_1a9e20d3bce808ed051e558e9661c6075b" kindref="member">MessageStart</ref>())<sp/>{</highlight></codeline>
<codeline lineno="5067"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5068"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5069"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>read<sp/>size</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5070"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blkdat<sp/>&gt;&gt;<sp/>nSize;</highlight></codeline>
<codeline lineno="5071"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nSize<sp/>&lt;<sp/>80<sp/>||<sp/>nSize<sp/>&gt;<sp/>MAX_BLOCK_SERIALIZED_SIZE)</highlight></codeline>
<codeline lineno="5072"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5073"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::exception&amp;)<sp/>{</highlight></codeline>
<codeline lineno="5074"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>no<sp/>valid<sp/>block<sp/>header<sp/>found;<sp/>don&apos;t<sp/>complain</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5075"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(this<sp/>happens<sp/>at<sp/>the<sp/>end<sp/>of<sp/>every<sp/>blk.dat<sp/>file)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5076"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5077"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5078"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5079"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>read<sp/>block<sp/>header</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5080"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>nBlockPos{blkdat.<ref refid="class_buffered_file_1a778c4f86039affe888b393f21c9dd513" kindref="member">GetPos</ref>()};</highlight></codeline>
<codeline lineno="5081"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(dbp)</highlight></codeline>
<codeline lineno="5082"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dbp-&gt;<ref refid="struct_flat_file_pos_1abb880bcadb3846a397e2420c4ee27d39" kindref="member">nPos</ref><sp/>=<sp/>nBlockPos;</highlight></codeline>
<codeline lineno="5083"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blkdat.<ref refid="class_buffered_file_1a92fdace7fde421c0df0f831b778ed5b5" kindref="member">SetLimit</ref>(nBlockPos<sp/>+<sp/>nSize);</highlight></codeline>
<codeline lineno="5084"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockHeader<sp/>header;</highlight></codeline>
<codeline lineno="5085"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blkdat<sp/>&gt;&gt;<sp/>header;</highlight></codeline>
<codeline lineno="5086"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256<sp/>hash{header.<ref refid="class_c_block_header_1a6df30b63c4634d52dfeaadb46d60d0f5" kindref="member">GetHash</ref>()};</highlight></codeline>
<codeline lineno="5087"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Skip<sp/>the<sp/>rest<sp/>of<sp/>this<sp/>block<sp/>(this<sp/>may<sp/>read<sp/>from<sp/>disk<sp/>into<sp/>memory);<sp/>position<sp/>to<sp/>the<sp/>marker<sp/>before<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5088"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>next<sp/>block,<sp/>but<sp/>it&apos;s<sp/>still<sp/>possible<sp/>to<sp/>rewind<sp/>to<sp/>the<sp/>start<sp/>of<sp/>the<sp/>current<sp/>block<sp/>(without<sp/>a<sp/>disk<sp/>read).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5089"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nRewind<sp/>=<sp/>nBlockPos<sp/>+<sp/>nSize;</highlight></codeline>
<codeline lineno="5090"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blkdat.<ref refid="class_buffered_file_1aef3adcd3794d24266de2a955c23d9341" kindref="member">SkipTo</ref>(nRewind);</highlight></codeline>
<codeline lineno="5091"><highlight class="normal"></highlight></codeline>
<codeline lineno="5092"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::shared_ptr&lt;CBlock&gt;<sp/>pblock{};<sp/></highlight><highlight class="comment">//<sp/>needs<sp/>to<sp/>remain<sp/>available<sp/>after<sp/>the<sp/>cs_main<sp/>lock<sp/>is<sp/>released<sp/>to<sp/>avoid<sp/>duplicate<sp/>reads<sp/>from<sp/>disk</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5093"><highlight class="normal"></highlight></codeline>
<codeline lineno="5094"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="5095"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="5096"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>detect<sp/>out<sp/>of<sp/>order<sp/>blocks,<sp/>and<sp/>store<sp/>them<sp/>for<sp/>later</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5097"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(hash<sp/>!=<sp/>params.<ref refid="class_c_chain_params_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>().<ref refid="struct_consensus_1_1_params_1a73ddcb7f11d0a36fe155d1139e667069" kindref="member">hashGenesisBlock</ref><sp/>&amp;&amp;<sp/>!<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.LookupBlockIndex(header.<ref refid="class_c_block_header_1a96c46394fa2ffef51517b645bcabcb5e" kindref="member">hashPrevBlock</ref>))<sp/>{</highlight></codeline>
<codeline lineno="5098"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a28e2c1d08fccde7fc5f1f6b3a6b6dc06" kindref="member">BCLog::REINDEX</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s:<sp/>Out<sp/>of<sp/>order<sp/>block<sp/>%s,<sp/>parent<sp/>%s<sp/>not<sp/>known\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>hash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),</highlight></codeline>
<codeline lineno="5099"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>header.<ref refid="class_c_block_header_1a96c46394fa2ffef51517b645bcabcb5e" kindref="member">hashPrevBlock</ref>.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="5100"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(dbp<sp/>&amp;&amp;<sp/>blocks_with_unknown_parent)<sp/>{</highlight></codeline>
<codeline lineno="5101"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks_with_unknown_parent-&gt;emplace(header.<ref refid="class_c_block_header_1a96c46394fa2ffef51517b645bcabcb5e" kindref="member">hashPrevBlock</ref>,<sp/>*dbp);</highlight></codeline>
<codeline lineno="5102"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5103"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5104"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5105"><highlight class="normal"></highlight></codeline>
<codeline lineno="5106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>process<sp/>in<sp/>case<sp/>the<sp/>block<sp/>isn&apos;t<sp/>known<sp/>yet</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindex<sp/>=<sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.LookupBlockIndex(hash);</highlight></codeline>
<codeline lineno="5108"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pindex<sp/>||<sp/>(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15" kindref="member">BLOCK_HAVE_DATA</ref>)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="5109"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>block<sp/>can<sp/>be<sp/>processed<sp/>immediately;<sp/>rewind<sp/>to<sp/>its<sp/>start,<sp/>read<sp/>and<sp/>deserialize<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blkdat.<ref refid="class_buffered_file_1a7c773de65b830cea519c98eec5f5cbd7" kindref="member">SetPos</ref>(nBlockPos);</highlight></codeline>
<codeline lineno="5111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pblock<sp/>=<sp/>std::make_shared&lt;CBlock&gt;();</highlight></codeline>
<codeline lineno="5112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blkdat<sp/>&gt;&gt;<sp/>TX_WITH_WITNESS(*pblock);</highlight></codeline>
<codeline lineno="5113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nRewind<sp/>=<sp/>blkdat.<ref refid="class_buffered_file_1a778c4f86039affe888b393f21c9dd513" kindref="member">GetPos</ref>();</highlight></codeline>
<codeline lineno="5114"><highlight class="normal"></highlight></codeline>
<codeline lineno="5115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BlockValidationState<sp/>state;</highlight></codeline>
<codeline lineno="5116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_manager_1a27cda33d02b54068c879b5889f6557f3" kindref="member">AcceptBlock</ref>(pblock,<sp/>state,<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">,<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">,<sp/>dbp,<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">,<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="5117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nLoaded++;</highlight></codeline>
<codeline lineno="5118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.<ref refid="class_validation_state_1aca1654c65182fe4e7d5fd45f556fcd57" kindref="member">IsError</ref>())<sp/>{</highlight></codeline>
<codeline lineno="5120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5122"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(hash<sp/>!=<sp/>params.<ref refid="class_c_chain_params_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>().<ref refid="struct_consensus_1_1_params_1a73ddcb7f11d0a36fe155d1139e667069" kindref="member">hashGenesisBlock</ref><sp/>&amp;&amp;<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>%<sp/>1000<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="5123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a28e2c1d08fccde7fc5f1f6b3a6b6dc06" kindref="member">BCLog::REINDEX</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Block<sp/>Import:<sp/>already<sp/>had<sp/>block<sp/>%s<sp/>at<sp/>height<sp/>%d\n&quot;</highlight><highlight class="normal">,<sp/>hash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>);</highlight></codeline>
<codeline lineno="5124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5126"><highlight class="normal"></highlight></codeline>
<codeline lineno="5127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Activate<sp/>the<sp/>genesis<sp/>block<sp/>so<sp/>normal<sp/>node<sp/>progress<sp/>can<sp/>continue</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>During<sp/>first<sp/>-reindex,<sp/>this<sp/>will<sp/>only<sp/>connect<sp/>Genesis<sp/>since</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5129"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ActivateBestChain<sp/>only<sp/>connects<sp/>blocks<sp/>which<sp/>are<sp/>in<sp/>the<sp/>block<sp/>tree<sp/>db,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>which<sp/>only<sp/>contains<sp/>blocks<sp/>whose<sp/>parents<sp/>are<sp/>in<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>But<sp/>do<sp/>this<sp/>only<sp/>if<sp/>genesis<sp/>isn&apos;t<sp/>activated<sp/>yet,<sp/>to<sp/>avoid<sp/>connecting<sp/>many<sp/>blocks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>without<sp/>assumevalid<sp/>in<sp/>the<sp/>case<sp/>of<sp/>a<sp/>continuation<sp/>of<sp/>a<sp/>reindex<sp/>that</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>was<sp/>interrupted<sp/>by<sp/>the<sp/>user.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(hash<sp/>==<sp/>params.<ref refid="class_c_chain_params_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>().<ref refid="struct_consensus_1_1_params_1a73ddcb7f11d0a36fe155d1139e667069" kindref="member">hashGenesisBlock</ref><sp/>&amp;&amp;<sp/><ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>,<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager_1a02754cb19c22c28f3092a18a70d9dec4" kindref="member">ActiveHeight</ref>())<sp/>==<sp/>-1)<sp/>{</highlight></codeline>
<codeline lineno="5135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BlockValidationState<sp/>state;</highlight></codeline>
<codeline lineno="5136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_manager_1a0ed46908ea52e17d172f2fcc0ceb9964" kindref="member">ActiveChainstate</ref>().ActivateBestChain(state,<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="5137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5139"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5140"><highlight class="normal"></highlight></codeline>
<codeline lineno="5141"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.IsPruneMode()<sp/>&amp;&amp;<sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_blockfiles_indexed<sp/>&amp;&amp;<sp/>pblock)<sp/>{</highlight></codeline>
<codeline lineno="5142"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>must<sp/>update<sp/>the<sp/>tip<sp/>for<sp/>pruning<sp/>to<sp/>work<sp/>while<sp/>importing<sp/>with<sp/>-loadblock.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5143"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>this<sp/>is<sp/>a<sp/>tradeoff<sp/>to<sp/>conserve<sp/>disk<sp/>space<sp/>at<sp/>the<sp/>expense<sp/>of<sp/>time</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5144"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>spent<sp/>updating<sp/>the<sp/>tip<sp/>to<sp/>be<sp/>able<sp/>to<sp/>prune.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5145"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>otherwise,<sp/>ActivateBestChain<sp/>won&apos;t<sp/>be<sp/>called<sp/>by<sp/>the<sp/>import<sp/>process</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5146"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>until<sp/>after<sp/>all<sp/>of<sp/>the<sp/>block<sp/>files<sp/>are<sp/>loaded.<sp/>ActivateBestChain<sp/>can<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5147"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>called<sp/>by<sp/>concurrent<sp/>network<sp/>message<sp/>processing.<sp/>but,<sp/>that<sp/>is<sp/>not</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5148"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>reliable<sp/>for<sp/>the<sp/>purpose<sp/>of<sp/>pruning<sp/>while<sp/>importing.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5149"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>result{ActivateBestChains()};<sp/>!result)<sp/>{</highlight></codeline>
<codeline lineno="5150"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a28e2c1d08fccde7fc5f1f6b3a6b6dc06" kindref="member">BCLog::REINDEX</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s\n&quot;</highlight><highlight class="normal">,<sp/><ref refid="namespaceutil_1adbcebd9741ba34de94c8384025e54825" kindref="member">util::ErrorString</ref>(result).original);</highlight></codeline>
<codeline lineno="5151"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5153"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5154"><highlight class="normal"></highlight></codeline>
<codeline lineno="5155"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>NotifyHeaderTip();</highlight></codeline>
<codeline lineno="5156"><highlight class="normal"></highlight></codeline>
<codeline lineno="5157"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!blocks_with_unknown_parent)<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5158"><highlight class="normal"></highlight></codeline>
<codeline lineno="5159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Recursively<sp/>process<sp/>earlier<sp/>encountered<sp/>successors<sp/>of<sp/>this<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5160"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::deque&lt;uint256&gt;<sp/>queue;</highlight></codeline>
<codeline lineno="5161"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>queue.push_back(hash);</highlight></codeline>
<codeline lineno="5162"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(!queue.empty())<sp/>{</highlight></codeline>
<codeline lineno="5163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint256<sp/>head<sp/>=<sp/>queue.front();</highlight></codeline>
<codeline lineno="5164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>queue.pop_front();</highlight></codeline>
<codeline lineno="5165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>range<sp/>=<sp/>blocks_with_unknown_parent-&gt;equal_range(head);</highlight></codeline>
<codeline lineno="5166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(range.first<sp/>!=<sp/>range.second)<sp/>{</highlight></codeline>
<codeline lineno="5167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::multimap&lt;uint256,<sp/>FlatFilePos&gt;::iterator<sp/>it<sp/>=<sp/>range.first;</highlight></codeline>
<codeline lineno="5168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::shared_ptr&lt;CBlock&gt;<sp/>pblockrecursive<sp/>=<sp/>std::make_shared&lt;CBlock&gt;();</highlight></codeline>
<codeline lineno="5169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.ReadBlock(*pblockrecursive,<sp/>it-&gt;second,<sp/>{}))<sp/>{</highlight></codeline>
<codeline lineno="5170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>block_hash{pblockrecursive-&gt;GetHash()};</highlight></codeline>
<codeline lineno="5171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a28e2c1d08fccde7fc5f1f6b3a6b6dc06" kindref="member">BCLog::REINDEX</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s:<sp/>Processing<sp/>out<sp/>of<sp/>order<sp/>child<sp/>%s<sp/>of<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>block_hash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>head.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="5172"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="5173"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BlockValidationState<sp/>dummy;</highlight></codeline>
<codeline lineno="5174"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_manager_1a27cda33d02b54068c879b5889f6557f3" kindref="member">AcceptBlock</ref>(pblockrecursive,<sp/>dummy,<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">,<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">,<sp/>&amp;it-&gt;second,<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">,<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="5175"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nLoaded++;</highlight></codeline>
<codeline lineno="5176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>queue.push_back(block_hash);</highlight></codeline>
<codeline lineno="5177"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5178"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5179"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>range.first++;</highlight></codeline>
<codeline lineno="5180"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks_with_unknown_parent-&gt;erase(it);</highlight></codeline>
<codeline lineno="5181"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>NotifyHeaderTip();</highlight></codeline>
<codeline lineno="5182"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5183"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5184"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::exception&amp;<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="5185"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>historical<sp/>bugs<sp/>added<sp/>extra<sp/>data<sp/>to<sp/>the<sp/>block<sp/>files<sp/>that<sp/>does<sp/>not<sp/>deserialize<sp/>cleanly.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>commonly<sp/>this<sp/>data<sp/>is<sp/>between<sp/>readable<sp/>blocks,<sp/>but<sp/>it<sp/>does<sp/>not<sp/>really<sp/>matter.<sp/>such<sp/>data<sp/>is<sp/>not<sp/>fatal<sp/>to<sp/>the<sp/>import<sp/>process.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>code<sp/>that<sp/>reads<sp/>the<sp/>block<sp/>files<sp/>deals<sp/>with<sp/>invalid<sp/>data<sp/>by<sp/>simply<sp/>ignoring<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>it<sp/>continues<sp/>to<sp/>search<sp/>for<sp/>the<sp/>next<sp/>{4<sp/>byte<sp/>magic<sp/>message<sp/>start<sp/>bytes<sp/>+<sp/>4<sp/>byte<sp/>length<sp/>+<sp/>block}<sp/>that<sp/>does<sp/>deserialize<sp/>cleanly</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>passes<sp/>all<sp/>of<sp/>the<sp/>other<sp/>block<sp/>validation<sp/>checks<sp/>dealing<sp/>with<sp/>POW<sp/>and<sp/>the<sp/>merkle<sp/>root,<sp/>etc...</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5190"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>merely<sp/>note<sp/>with<sp/>this<sp/>informational<sp/>log<sp/>message<sp/>when<sp/>unexpected<sp/>data<sp/>is<sp/>encountered.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5191"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>could<sp/>also<sp/>be<sp/>experiencing<sp/>a<sp/>storage<sp/>system<sp/>read<sp/>error,<sp/>or<sp/>a<sp/>read<sp/>of<sp/>a<sp/>previous<sp/>bad<sp/>write.<sp/>these<sp/>are<sp/>possible,<sp/>but</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5192"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>less<sp/>likely<sp/>scenarios.<sp/>we<sp/>don&apos;t<sp/>have<sp/>enough<sp/>information<sp/>to<sp/>tell<sp/>a<sp/>difference<sp/>here.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5193"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>reindex<sp/>process<sp/>is<sp/>not<sp/>the<sp/>place<sp/>to<sp/>attempt<sp/>to<sp/>clean<sp/>and/or<sp/>compact<sp/>the<sp/>block<sp/>files.<sp/>if<sp/>so<sp/>desired,<sp/>a<sp/>studious<sp/>node<sp/>operator</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5194"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>may<sp/>use<sp/>knowledge<sp/>of<sp/>the<sp/>fact<sp/>that<sp/>the<sp/>block<sp/>files<sp/>are<sp/>not<sp/>entirely<sp/>pristine<sp/>in<sp/>order<sp/>to<sp/>prepare<sp/>a<sp/>set<sp/>of<sp/>pristine,<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5195"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>perhaps<sp/>ordered,<sp/>block<sp/>files<sp/>for<sp/>later<sp/>reindexing.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a28e2c1d08fccde7fc5f1f6b3a6b6dc06" kindref="member">BCLog::REINDEX</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s:<sp/>unexpected<sp/>data<sp/>at<sp/>file<sp/>offset<sp/>0x%x<sp/>-<sp/>%s.<sp/>continuing\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>(nRewind<sp/>-<sp/>1),<sp/>e.what());</highlight></codeline>
<codeline lineno="5197"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5199"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::runtime_error&amp;<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="5200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a30d910c43e6619c9596c077fd1e5518d" kindref="member">GetNotifications</ref>().<ref refid="classkernel_1_1_notifications_1a2998f041aae2f227bb4bba3d9cb7a292" kindref="member">fatalError</ref>(<ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(<ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight><highlight class="stringliteral">&quot;System<sp/>error<sp/>while<sp/>loading<sp/>external<sp/>block<sp/>file:<sp/>%s&quot;</highlight><highlight class="normal">),<sp/>e.what()));</highlight></codeline>
<codeline lineno="5201"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5202"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Loaded<sp/>%i<sp/>blocks<sp/>from<sp/>external<sp/>file<sp/>in<sp/>%dms&quot;</highlight><highlight class="normal">,<sp/>nLoaded,<sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;std::chrono::milliseconds&gt;</ref>(SteadyClock::now()<sp/>-<sp/>start));</highlight></codeline>
<codeline lineno="5203"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5204"><highlight class="normal"></highlight></codeline>
<codeline lineno="5205"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager_1a7d9fee7d87790307d9de8daa34d0bb76" kindref="member">ChainstateManager::ShouldCheckBlockIndex</ref>()</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="5206"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="5207"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Assert<sp/>to<sp/>verify<sp/>Flatten()<sp/>has<sp/>been<sp/>called.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5208"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!*<ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(<ref refid="class_chainstate_manager_1a012c0463bd17a2be6045a0d62e8b0fd4" kindref="member">m_options</ref>.check_block_index))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5209"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(FastRandomContext().randrange(*<ref refid="class_chainstate_manager_1a012c0463bd17a2be6045a0d62e8b0fd4" kindref="member">m_options</ref>.check_block_index)<sp/>&gt;=<sp/>1)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5210"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5211"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5212"><highlight class="normal"></highlight></codeline>
<codeline lineno="5213"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager_1abcf4d55acb00543c3d57d5fb532bc8f6" kindref="member">ChainstateManager::CheckBlockIndex</ref>()</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="5214"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="5215"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_manager_1a7d9fee7d87790307d9de8daa34d0bb76" kindref="member">ShouldCheckBlockIndex</ref>())<sp/>{</highlight></codeline>
<codeline lineno="5216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5217"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5218"><highlight class="normal"></highlight></codeline>
<codeline lineno="5219"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="5220"><highlight class="normal"></highlight></codeline>
<codeline lineno="5221"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>During<sp/>a<sp/>reindex,<sp/>we<sp/>read<sp/>the<sp/>genesis<sp/>block<sp/>and<sp/>call<sp/>CheckBlockIndex<sp/>before<sp/>ActivateBestChain,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5222"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>so<sp/>we<sp/>have<sp/>the<sp/>genesis<sp/>block<sp/>in<sp/>m_blockman.m_block_index<sp/>but<sp/>no<sp/>active<sp/>chain.<sp/>(A<sp/>few<sp/>of<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5223"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>tests<sp/>when<sp/>iterating<sp/>the<sp/>block<sp/>tree<sp/>require<sp/>that<sp/>m_chain<sp/>has<sp/>been<sp/>initialized.)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5224"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().Height()<sp/>&lt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="5225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_block_index.size()<sp/>&lt;=<sp/>1);</highlight></codeline>
<codeline lineno="5226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5227"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5228"><highlight class="normal"></highlight></codeline>
<codeline lineno="5229"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Build<sp/>forward-pointing<sp/>data<sp/>structure<sp/>for<sp/>the<sp/>entire<sp/>block<sp/>tree.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5230"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>For<sp/>performance<sp/>reasons,<sp/>indexes<sp/>of<sp/>the<sp/>best<sp/>header<sp/>chain<sp/>are<sp/>stored<sp/>in<sp/>a<sp/>vector<sp/>(within<sp/>CChain).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5231"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>All<sp/>remaining<sp/>blocks<sp/>are<sp/>stored<sp/>in<sp/>a<sp/>multimap.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5232"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>best<sp/>header<sp/>chain<sp/>can<sp/>differ<sp/>from<sp/>the<sp/>active<sp/>chain:<sp/>E.g.<sp/>its<sp/>entries<sp/>may<sp/>belong<sp/>to<sp/>blocks<sp/>that</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5233"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>are<sp/>not<sp/>yet<sp/>validated.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5234"><highlight class="normal"><sp/><sp/><sp/><sp/>CChain<sp/>best_hdr_chain;</highlight></codeline>
<codeline lineno="5235"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(m_best_header);</highlight></codeline>
<codeline lineno="5236"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!(m_best_header-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada88df51e92f2f675baff60e0a5bd170ef" kindref="member">BLOCK_FAILED_MASK</ref>));</highlight></codeline>
<codeline lineno="5237"><highlight class="normal"><sp/><sp/><sp/><sp/>best_hdr_chain.<ref refid="class_c_chain_1a9180d6da00dc108a0689388f53542498" kindref="member">SetTip</ref>(*m_best_header);</highlight></codeline>
<codeline lineno="5238"><highlight class="normal"></highlight></codeline>
<codeline lineno="5239"><highlight class="normal"><sp/><sp/><sp/><sp/>std::multimap&lt;const<sp/>CBlockIndex*,<sp/>const<sp/>CBlockIndex*&gt;<sp/>forward;</highlight></codeline>
<codeline lineno="5240"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>[<ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>,<sp/>block_index]<sp/>:<sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_block_index)<sp/>{</highlight></codeline>
<codeline lineno="5241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>save<sp/>indexes<sp/>in<sp/>forward<sp/>that<sp/>are<sp/>not<sp/>part<sp/>of<sp/>the<sp/>best<sp/>header<sp/>chain.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!best_hdr_chain.<ref refid="class_c_chain_1a78c557b8d1209a61416487a99a7808a9" kindref="member">Contains</ref>(&amp;block_index))<sp/>{</highlight></codeline>
<codeline lineno="5243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>genesis,<sp/>which<sp/>must<sp/>be<sp/>part<sp/>of<sp/>the<sp/>best<sp/>header<sp/>chain,<sp/>can<sp/>have<sp/>a<sp/>nullptr<sp/>parent.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5244"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(block_index.<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>);</highlight></codeline>
<codeline lineno="5245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>forward.emplace(block_index.<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>,<sp/>&amp;block_index);</highlight></codeline>
<codeline lineno="5246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5247"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5248"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(forward.size()<sp/>+<sp/>best_hdr_chain.<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>()<sp/>+<sp/>1<sp/>==<sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_block_index.size());</highlight></codeline>
<codeline lineno="5249"><highlight class="normal"></highlight></codeline>
<codeline lineno="5250"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindex<sp/>=<sp/>best_hdr_chain[0];</highlight></codeline>
<codeline lineno="5251"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindex);</highlight></codeline>
<codeline lineno="5252"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Iterate<sp/>over<sp/>the<sp/>entire<sp/>block<sp/>tree,<sp/>using<sp/>depth-first<sp/>search.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5253"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Along<sp/>the<sp/>way,<sp/>remember<sp/>whether<sp/>there<sp/>are<sp/>blocks<sp/>on<sp/>the<sp/>path<sp/>from<sp/>genesis</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5254"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>block<sp/>being<sp/>explored<sp/>which<sp/>are<sp/>the<sp/>first<sp/>to<sp/>have<sp/>certain<sp/>properties.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5255"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>nNodes<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="5256"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="5257"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindexFirstInvalid<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Oldest<sp/>ancestor<sp/>of<sp/>pindex<sp/>which<sp/>is<sp/>invalid.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5258"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindexFirstMissing<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Oldest<sp/>ancestor<sp/>of<sp/>pindex<sp/>which<sp/>does<sp/>not<sp/>have<sp/>BLOCK_HAVE_DATA,<sp/>since<sp/>assumeutxo<sp/>snapshot<sp/>if<sp/>used.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5259"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindexFirstNeverProcessed<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;<sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Oldest<sp/>ancestor<sp/>of<sp/>pindex<sp/>for<sp/>which<sp/>nTx<sp/>==<sp/>0,<sp/>since<sp/>assumeutxo<sp/>snapshot<sp/>if<sp/>used.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5260"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindexFirstNotTreeValid<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Oldest<sp/>ancestor<sp/>of<sp/>pindex<sp/>which<sp/>does<sp/>not<sp/>have<sp/>BLOCK_VALID_TREE<sp/>(regardless<sp/>of<sp/>being<sp/>valid<sp/>or<sp/>not).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5261"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindexFirstNotTransactionsValid<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>Oldest<sp/>ancestor<sp/>of<sp/>pindex<sp/>which<sp/>does<sp/>not<sp/>have<sp/>BLOCK_VALID_TRANSACTIONS<sp/>(regardless<sp/>of<sp/>being<sp/>valid<sp/>or<sp/>not),<sp/>since<sp/>assumeutxo<sp/>snapshot<sp/>if<sp/>used.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5262"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindexFirstNotChainValid<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Oldest<sp/>ancestor<sp/>of<sp/>pindex<sp/>which<sp/>does<sp/>not<sp/>have<sp/>BLOCK_VALID_CHAIN<sp/>(regardless<sp/>of<sp/>being<sp/>valid<sp/>or<sp/>not),<sp/>since<sp/>assumeutxo<sp/>snapshot<sp/>if<sp/>used.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5263"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindexFirstNotScriptsValid<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;<sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Oldest<sp/>ancestor<sp/>of<sp/>pindex<sp/>which<sp/>does<sp/>not<sp/>have<sp/>BLOCK_VALID_SCRIPTS<sp/>(regardless<sp/>of<sp/>being<sp/>valid<sp/>or<sp/>not),<sp/>since<sp/>assumeutxo<sp/>snapshot<sp/>if<sp/>used.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5264"><highlight class="normal"></highlight></codeline>
<codeline lineno="5265"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>After<sp/>checking<sp/>an<sp/>assumeutxo<sp/>snapshot<sp/>block,<sp/>reset<sp/>pindexFirst<sp/>pointers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5266"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>earlier<sp/>blocks<sp/>that<sp/>have<sp/>not<sp/>been<sp/>downloaded<sp/>or<sp/>validated<sp/>yet,<sp/>so</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5267"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>checks<sp/>for<sp/>later<sp/>blocks<sp/>can<sp/>assume<sp/>the<sp/>earlier<sp/>blocks<sp/>were<sp/>validated<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5268"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>be<sp/>stricter,<sp/>testing<sp/>for<sp/>more<sp/>requirements.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5269"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>snap_base{<ref refid="class_chainstate_manager_1a8d39d359e6ed774815dc8d31f326ff82" kindref="member">CurrentChainstate</ref>().SnapshotBase()};</highlight></codeline>
<codeline lineno="5270"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex<sp/>*snap_first_missing{},<sp/>*snap_first_notx{},<sp/>*snap_first_notv{},<sp/>*snap_first_nocv{},<sp/>*snap_first_nosv{};</highlight></codeline>
<codeline lineno="5271"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>snap_update_firsts<sp/>=<sp/>[&amp;]<sp/>{</highlight></codeline>
<codeline lineno="5272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex<sp/>==<sp/>snap_base)<sp/>{</highlight></codeline>
<codeline lineno="5273"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::swap(snap_first_missing,<sp/>pindexFirstMissing);</highlight></codeline>
<codeline lineno="5274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::swap(snap_first_notx,<sp/>pindexFirstNeverProcessed);</highlight></codeline>
<codeline lineno="5275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::swap(snap_first_notv,<sp/>pindexFirstNotTransactionsValid);</highlight></codeline>
<codeline lineno="5276"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::swap(snap_first_nocv,<sp/>pindexFirstNotChainValid);</highlight></codeline>
<codeline lineno="5277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::swap(snap_first_nosv,<sp/>pindexFirstNotScriptsValid);</highlight></codeline>
<codeline lineno="5278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5279"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="5280"><highlight class="normal"></highlight></codeline>
<codeline lineno="5281"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(pindex<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="5282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nNodes++;</highlight></codeline>
<codeline lineno="5283"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexFirstInvalid<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93adab3f668fe41faf909922945b37b25ec2d" kindref="member">BLOCK_FAILED_VALID</ref>)<sp/>pindexFirstInvalid<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="5284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexFirstMissing<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>!(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15" kindref="member">BLOCK_HAVE_DATA</ref>))<sp/>{</highlight></codeline>
<codeline lineno="5285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexFirstMissing<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="5286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexFirstNeverProcessed<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>pindex-&gt;<ref refid="class_c_block_index_1aee88ed2678dfb8c29dbb1ad986c87bf4" kindref="member">nTx</ref><sp/>==<sp/>0)<sp/>pindexFirstNeverProcessed<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="5288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>pindexFirstNotTreeValid<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada1223c736f6157ad915dd31f6a1577846" kindref="member">BLOCK_VALID_MASK</ref>)<sp/>&lt;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada67f3a88eeb793cc62f427f87ae830573" kindref="member">BLOCK_VALID_TREE</ref>)<sp/>pindexFirstNotTreeValid<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="5289"><highlight class="normal"></highlight></codeline>
<codeline lineno="5290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="5291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexFirstNotTransactionsValid<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="5292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada1223c736f6157ad915dd31f6a1577846" kindref="member">BLOCK_VALID_MASK</ref>)<sp/>&lt;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada3eef30f876594ac79b888b7d1ff6c66c" kindref="member">BLOCK_VALID_TRANSACTIONS</ref>)<sp/>{</highlight></codeline>
<codeline lineno="5293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexFirstNotTransactionsValid<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="5294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5295"><highlight class="normal"></highlight></codeline>
<codeline lineno="5296"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexFirstNotChainValid<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="5297"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada1223c736f6157ad915dd31f6a1577846" kindref="member">BLOCK_VALID_MASK</ref>)<sp/>&lt;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada00332fcf52dbd55990d8ff86b616bc65" kindref="member">BLOCK_VALID_CHAIN</ref>)<sp/>{</highlight></codeline>
<codeline lineno="5298"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexFirstNotChainValid<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="5299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5300"><highlight class="normal"></highlight></codeline>
<codeline lineno="5301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexFirstNotScriptsValid<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="5302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada1223c736f6157ad915dd31f6a1577846" kindref="member">BLOCK_VALID_MASK</ref>)<sp/>&lt;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada47b28fca76b64d094ddca0a3aa8da230" kindref="member">BLOCK_VALID_SCRIPTS</ref>)<sp/>{</highlight></codeline>
<codeline lineno="5303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexFirstNotScriptsValid<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="5304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5306"><highlight class="normal"></highlight></codeline>
<codeline lineno="5307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Begin:<sp/>actual<sp/>consistency<sp/>checks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="5309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Genesis<sp/>block<sp/>checks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>()<sp/>==<sp/><ref refid="class_chainstate_manager_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>().hashGenesisBlock);<sp/></highlight><highlight class="comment">//<sp/>Genesis<sp/>block&apos;s<sp/>hash<sp/>must<sp/>match.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>c<sp/>:<sp/>m_chainstates)<sp/>{</highlight></codeline>
<codeline lineno="5312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c-&gt;m_chain.Genesis()<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="5313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindex<sp/>==<sp/>c-&gt;m_chain.Genesis());<sp/></highlight><highlight class="comment">//<sp/>The<sp/>chain&apos;s<sp/>genesis<sp/>block<sp/>must<sp/>be<sp/>this<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5316"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5317"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>nSequenceId<sp/>can&apos;t<sp/>be<sp/>set<sp/>higher<sp/>than<sp/>SEQ_ID_INIT_FROM_DISK{1}<sp/>for<sp/>blocks<sp/>that<sp/>aren&apos;t<sp/>linked</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(negative<sp/>is<sp/>used<sp/>for<sp/>preciousblock,<sp/>SEQ_ID_BEST_CHAIN_FROM_DISK{0}<sp/>for<sp/>active<sp/>chain<sp/>when<sp/>loaded<sp/>from<sp/>disk)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pindex-&gt;<ref refid="class_c_block_index_1ae804dd1f9a78669920c2bc21dc7a9812" kindref="member">HaveNumChainTxs</ref>())<sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindex-&gt;<ref refid="class_c_block_index_1af095a0efd0b6a7cd78057bbb023a01f7" kindref="member">nSequenceId</ref><sp/>&lt;=<sp/>SEQ_ID_INIT_FROM_DISK);</highlight></codeline>
<codeline lineno="5320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>VALID_TRANSACTIONS<sp/>is<sp/>equivalent<sp/>to<sp/>nTx<sp/>&gt;<sp/>0<sp/>for<sp/>all<sp/>nodes<sp/>(whether<sp/>or<sp/>not<sp/>pruning<sp/>has<sp/>occurred).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>HAVE_DATA<sp/>is<sp/>only<sp/>equivalent<sp/>to<sp/>nTx<sp/>&gt;<sp/>0<sp/>(or<sp/>VALID_TRANSACTIONS)<sp/>if<sp/>no<sp/>pruning<sp/>has<sp/>occurred.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_have_pruned)<sp/>{</highlight></codeline>
<codeline lineno="5323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we&apos;ve<sp/>never<sp/>pruned,<sp/>then<sp/>HAVE_DATA<sp/>should<sp/>be<sp/>equivalent<sp/>to<sp/>nTx<sp/>&gt;<sp/>0</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15" kindref="member">BLOCK_HAVE_DATA</ref>)<sp/>==<sp/>(pindex-&gt;<ref refid="class_c_block_index_1aee88ed2678dfb8c29dbb1ad986c87bf4" kindref="member">nTx</ref><sp/>==<sp/>0));</highlight></codeline>
<codeline lineno="5325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindexFirstMissing<sp/>==<sp/>pindexFirstNeverProcessed);</highlight></codeline>
<codeline lineno="5326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>have<sp/>pruned,<sp/>then<sp/>we<sp/>can<sp/>only<sp/>say<sp/>that<sp/>HAVE_DATA<sp/>implies<sp/>nTx<sp/>&gt;<sp/>0</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15" kindref="member">BLOCK_HAVE_DATA</ref>)<sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindex-&gt;<ref refid="class_c_block_index_1aee88ed2678dfb8c29dbb1ad986c87bf4" kindref="member">nTx</ref><sp/>&gt;<sp/>0);</highlight></codeline>
<codeline lineno="5329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada722a05d892a13ada5ffd4fcbbef837cd" kindref="member">BLOCK_HAVE_UNDO</ref>)<sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15" kindref="member">BLOCK_HAVE_DATA</ref>);</highlight></codeline>
<codeline lineno="5331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(snap_base<sp/>&amp;&amp;<sp/>snap_base-&gt;<ref refid="class_c_block_index_1ac20120d6b64792647a63d216b26e4b53" kindref="member">GetAncestor</ref>(pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>)<sp/>==<sp/>pindex)<sp/>{</highlight></codeline>
<codeline lineno="5332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Assumed-valid<sp/>blocks<sp/>should<sp/>connect<sp/>to<sp/>the<sp/>main<sp/>chain.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>((pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada1223c736f6157ad915dd31f6a1577846" kindref="member">BLOCK_VALID_MASK</ref>)<sp/>&gt;=<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada67f3a88eeb793cc62f427f87ae830573" kindref="member">BLOCK_VALID_TREE</ref>);</highlight></codeline>
<codeline lineno="5334"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>There<sp/>should<sp/>only<sp/>be<sp/>an<sp/>nTx<sp/>value<sp/>if<sp/>we<sp/>have</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>actually<sp/>seen<sp/>a<sp/>block&apos;s<sp/>transactions.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(((pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada1223c736f6157ad915dd31f6a1577846" kindref="member">BLOCK_VALID_MASK</ref>)<sp/>&gt;=<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada3eef30f876594ac79b888b7d1ff6c66c" kindref="member">BLOCK_VALID_TRANSACTIONS</ref>)<sp/>==<sp/>(pindex-&gt;<ref refid="class_c_block_index_1aee88ed2678dfb8c29dbb1ad986c87bf4" kindref="member">nTx</ref><sp/>&gt;<sp/>0));<sp/></highlight><highlight class="comment">//<sp/>This<sp/>is<sp/>pruning-independent.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>All<sp/>parents<sp/>having<sp/>had<sp/>data<sp/>(at<sp/>some<sp/>point)<sp/>is<sp/>equivalent<sp/>to<sp/>all<sp/>parents<sp/>being<sp/>VALID_TRANSACTIONS,<sp/>which<sp/>is<sp/>equivalent<sp/>to<sp/>HaveNumChainTxs().</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>HaveNumChainTxs<sp/>will<sp/>also<sp/>be<sp/>set<sp/>in<sp/>the<sp/>assumeutxo<sp/>snapshot<sp/>block<sp/>from<sp/>snapshot<sp/>metadata.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5340"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>((pindexFirstNeverProcessed<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>||<sp/>pindex<sp/>==<sp/>snap_base)<sp/>==<sp/>pindex-&gt;<ref refid="class_c_block_index_1ae804dd1f9a78669920c2bc21dc7a9812" kindref="member">HaveNumChainTxs</ref>());</highlight></codeline>
<codeline lineno="5341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>((pindexFirstNotTransactionsValid<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>||<sp/>pindex<sp/>==<sp/>snap_base)<sp/>==<sp/>pindex-&gt;<ref refid="class_c_block_index_1ae804dd1f9a78669920c2bc21dc7a9812" kindref="member">HaveNumChainTxs</ref>());</highlight></codeline>
<codeline lineno="5342"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>==<sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref>);<sp/></highlight><highlight class="comment">//<sp/>nHeight<sp/>must<sp/>be<sp/>consistent.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>||<sp/>pindex-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&gt;=<sp/>pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref>);<sp/></highlight><highlight class="comment">//<sp/>For<sp/>every<sp/>block<sp/>except<sp/>the<sp/>genesis<sp/>block,<sp/>the<sp/>chainwork<sp/>must<sp/>be<sp/>larger<sp/>than<sp/>the<sp/>parent&apos;s.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(<ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref><sp/>&lt;<sp/>2<sp/>||<sp/>(pindex-&gt;<ref refid="class_c_block_index_1a17b86168eb1179d18ca6daa8657eaa34" kindref="member">pskip</ref><sp/>&amp;&amp;<sp/>(pindex-&gt;<ref refid="class_c_block_index_1a17b86168eb1179d18ca6daa8657eaa34" kindref="member">pskip</ref>-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>&lt;<sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref>)));<sp/></highlight><highlight class="comment">//<sp/>The<sp/>pskip<sp/>pointer<sp/>must<sp/>point<sp/>back<sp/>for<sp/>all<sp/>but<sp/>the<sp/>first<sp/>2<sp/>blocks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindexFirstNotTreeValid<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);<sp/></highlight><highlight class="comment">//<sp/>All<sp/>m_blockman.m_block_index<sp/>entries<sp/>must<sp/>at<sp/>least<sp/>be<sp/>TREE<sp/>valid</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada1223c736f6157ad915dd31f6a1577846" kindref="member">BLOCK_VALID_MASK</ref>)<sp/>&gt;=<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada67f3a88eeb793cc62f427f87ae830573" kindref="member">BLOCK_VALID_TREE</ref>)<sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindexFirstNotTreeValid<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);<sp/></highlight><highlight class="comment">//<sp/>TREE<sp/>valid<sp/>implies<sp/>all<sp/>parents<sp/>are<sp/>TREE<sp/>valid</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada1223c736f6157ad915dd31f6a1577846" kindref="member">BLOCK_VALID_MASK</ref>)<sp/>&gt;=<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada00332fcf52dbd55990d8ff86b616bc65" kindref="member">BLOCK_VALID_CHAIN</ref>)<sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindexFirstNotChainValid<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);<sp/></highlight><highlight class="comment">//<sp/>CHAIN<sp/>valid<sp/>implies<sp/>all<sp/>parents<sp/>are<sp/>CHAIN<sp/>valid</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5348"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada1223c736f6157ad915dd31f6a1577846" kindref="member">BLOCK_VALID_MASK</ref>)<sp/>&gt;=<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada47b28fca76b64d094ddca0a3aa8da230" kindref="member">BLOCK_VALID_SCRIPTS</ref>)<sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindexFirstNotScriptsValid<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);<sp/></highlight><highlight class="comment">//<sp/>SCRIPTS<sp/>valid<sp/>implies<sp/>all<sp/>parents<sp/>are<sp/>SCRIPTS<sp/>valid</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5349"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexFirstInvalid<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="5350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Checks<sp/>for<sp/>not-invalid<sp/>blocks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5351"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>((pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada88df51e92f2f675baff60e0a5bd170ef" kindref="member">BLOCK_FAILED_MASK</ref>)<sp/>==<sp/>0);<sp/></highlight><highlight class="comment">//<sp/>The<sp/>failed<sp/>mask<sp/>cannot<sp/>be<sp/>set<sp/>for<sp/>blocks<sp/>without<sp/>invalid<sp/>parents.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5352"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada88df51e92f2f675baff60e0a5bd170ef" kindref="member">BLOCK_FAILED_MASK</ref>);<sp/></highlight><highlight class="comment">//<sp/>Invalid<sp/>blocks<sp/>and<sp/>their<sp/>descendants<sp/>must<sp/>be<sp/>marked<sp/>as<sp/>invalid</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5355"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Make<sp/>sure<sp/>m_chain_tx_count<sp/>sum<sp/>is<sp/>correctly<sp/>computed.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5356"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>)<sp/>{</highlight></codeline>
<codeline lineno="5357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>no<sp/>previous<sp/>block,<sp/>nTx<sp/>and<sp/>m_chain_tx_count<sp/>must<sp/>be<sp/>the<sp/>same.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5358"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindex-&gt;<ref refid="class_c_block_index_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref><sp/>==<sp/>pindex-&gt;<ref refid="class_c_block_index_1aee88ed2678dfb8c29dbb1ad986c87bf4" kindref="member">nTx</ref>);</highlight></codeline>
<codeline lineno="5359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>-&gt;<ref refid="class_c_block_index_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref><sp/>&gt;<sp/>0<sp/>&amp;&amp;<sp/>pindex-&gt;<ref refid="class_c_block_index_1aee88ed2678dfb8c29dbb1ad986c87bf4" kindref="member">nTx</ref><sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="5360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>previous<sp/>m_chain_tx_count<sp/>is<sp/>set<sp/>and<sp/>number<sp/>of<sp/>transactions<sp/>in<sp/>block<sp/>is<sp/>known,<sp/>sum<sp/>must<sp/>be<sp/>set.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindex-&gt;<ref refid="class_c_block_index_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref><sp/>==<sp/>pindex-&gt;<ref refid="class_c_block_index_1aee88ed2678dfb8c29dbb1ad986c87bf4" kindref="member">nTx</ref><sp/>+<sp/>pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>-&gt;<ref refid="class_c_block_index_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref>);</highlight></codeline>
<codeline lineno="5362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Otherwise<sp/>m_chain_tx_count<sp/>should<sp/>only<sp/>be<sp/>set<sp/>if<sp/>this<sp/>is<sp/>a<sp/>snapshot</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>block,<sp/>and<sp/>must<sp/>be<sp/>set<sp/>if<sp/>it<sp/>is.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>((pindex-&gt;<ref refid="class_c_block_index_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref><sp/>!=<sp/>0)<sp/>==<sp/>(pindex<sp/>==<sp/>snap_base));</highlight></codeline>
<codeline lineno="5366"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>There<sp/>should<sp/>be<sp/>no<sp/>block<sp/>with<sp/>more<sp/>work<sp/>than<sp/>m_best_header,<sp/>unless<sp/>it&apos;s<sp/>known<sp/>to<sp/>be<sp/>invalid</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>((pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada88df51e92f2f675baff60e0a5bd170ef" kindref="member">BLOCK_FAILED_MASK</ref>)<sp/>||<sp/>pindex-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&lt;=<sp/>m_best_header-&gt;nChainWork);</highlight></codeline>
<codeline lineno="5369"><highlight class="normal"></highlight></codeline>
<codeline lineno="5370"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Chainstate-specific<sp/>checks<sp/>on<sp/>setBlockIndexCandidates</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5371"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>c<sp/>:<sp/>m_chainstates)<sp/>{</highlight></codeline>
<codeline lineno="5372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(c-&gt;m_chain.Tip()<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Two<sp/>main<sp/>factors<sp/>determine<sp/>whether<sp/>pindex<sp/>is<sp/>a<sp/>candidate<sp/>in</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>setBlockIndexCandidates:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5375"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5376"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>If<sp/>pindex<sp/>has<sp/>less<sp/>work<sp/>than<sp/>the<sp/>chain<sp/>tip,<sp/>it<sp/>should<sp/>not<sp/>be<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5377"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>candidate,<sp/>and<sp/>this<sp/>will<sp/>be<sp/>asserted<sp/>below.<sp/>Otherwise<sp/>it<sp/>is<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5378"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>potential<sp/>candidate.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5379"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5380"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>If<sp/>pindex<sp/>or<sp/>one<sp/>of<sp/>its<sp/>parent<sp/>blocks<sp/>back<sp/>to<sp/>the<sp/>genesis<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5381"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>or<sp/>an<sp/>assumeutxo<sp/>snapshot<sp/>never<sp/>downloaded<sp/>transactions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>(pindexFirstNeverProcessed<sp/>is<sp/>non-null),<sp/>it<sp/>should<sp/>not<sp/>be<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5383"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>candidate,<sp/>and<sp/>this<sp/>will<sp/>be<sp/>asserted<sp/>below.<sp/>The<sp/>only<sp/>exception</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5384"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>is<sp/>if<sp/>pindex<sp/>itself<sp/>is<sp/>an<sp/>assumeutxo<sp/>snapshot<sp/>block.<sp/>Then<sp/>it<sp/>is</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5385"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>also<sp/>a<sp/>potential<sp/>candidate.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!CBlockIndexWorkComparator()(pindex,<sp/>c-&gt;m_chain.Tip())<sp/>&amp;&amp;<sp/>(pindexFirstNeverProcessed<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>||<sp/>pindex<sp/>==<sp/>snap_base))<sp/>{</highlight></codeline>
<codeline lineno="5387"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>pindex<sp/>was<sp/>detected<sp/>as<sp/>invalid<sp/>(pindexFirstInvalid<sp/>is</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5388"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>non-null),<sp/>it<sp/>is<sp/>not<sp/>required<sp/>to<sp/>be<sp/>in</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5389"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>setBlockIndexCandidates.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5390"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexFirstInvalid<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="5391"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>pindex<sp/>and<sp/>all<sp/>its<sp/>parents<sp/>back<sp/>to<sp/>the<sp/>genesis<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5392"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>or<sp/>an<sp/>assumeutxo<sp/>snapshot<sp/>block<sp/>downloaded<sp/>transactions,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5393"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>the<sp/>transactions<sp/>were<sp/>not<sp/>pruned<sp/>(pindexFirstMissing</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5394"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>is<sp/>null),<sp/>it<sp/>is<sp/>a<sp/>potential<sp/>candidate.<sp/>The<sp/>check</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5395"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>excludes<sp/>pruned<sp/>blocks,<sp/>because<sp/>if<sp/>any<sp/>blocks<sp/>were</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5396"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>pruned<sp/>between<sp/>pindex<sp/>and<sp/>the<sp/>current<sp/>chain<sp/>tip,<sp/>pindex<sp/>will</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5397"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>only<sp/>temporarily<sp/>be<sp/>added<sp/>to<sp/>setBlockIndexCandidates,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5398"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>before<sp/>being<sp/>moved<sp/>to<sp/>m_blocks_unlinked.<sp/>This<sp/>check</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5399"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>could<sp/>be<sp/>improved<sp/>to<sp/>verify<sp/>that<sp/>if<sp/>all<sp/>blocks<sp/>between</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5400"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>chain<sp/>tip<sp/>and<sp/>pindex<sp/>have<sp/>data,<sp/>pindex<sp/>must<sp/>be<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5401"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>candidate.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5402"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5403"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>pindex<sp/>is<sp/>the<sp/>chain<sp/>tip,<sp/>it<sp/>also<sp/>is<sp/>a<sp/>potential</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5404"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>candidate.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5405"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5406"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>chainstate<sp/>was<sp/>loaded<sp/>from<sp/>a<sp/>snapshot<sp/>and<sp/>pindex</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5407"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>is<sp/>the<sp/>base<sp/>of<sp/>the<sp/>snapshot,<sp/>pindex<sp/>is<sp/>also<sp/>a<sp/>potential</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5408"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>candidate.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5409"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexFirstMissing<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>||<sp/>pindex<sp/>==<sp/>c-&gt;m_chain.Tip()<sp/>||<sp/>pindex<sp/>==<sp/>c-&gt;SnapshotBase())<sp/>{</highlight></codeline>
<codeline lineno="5410"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>this<sp/>chainstate<sp/>is<sp/>not<sp/>a<sp/>historical<sp/>chainstate</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>targeting<sp/>a<sp/>specific<sp/>block,<sp/>pindex<sp/>must<sp/>be<sp/>in</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5412"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>setBlockIndexCandidates.<sp/>Otherwise,<sp/>pindex<sp/>only</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>needs<sp/>to<sp/>be<sp/>added<sp/>if<sp/>it<sp/>is<sp/>an<sp/>ancestor<sp/>of<sp/>the<sp/>target</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5414"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!c-&gt;TargetBlock()<sp/>||<sp/>c-&gt;TargetBlock()-&gt;GetAncestor(pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>)<sp/>==<sp/>pindex)<sp/>{</highlight></codeline>
<codeline lineno="5416"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(c-&gt;setBlockIndexCandidates.contains(</highlight><highlight class="keyword">const_cast&lt;</highlight><highlight class="normal">CBlockIndex*</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(pindex)));</highlight></codeline>
<codeline lineno="5417"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5418"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>some<sp/>parent<sp/>is<sp/>missing,<sp/>then<sp/>it<sp/>could<sp/>be<sp/>that<sp/>this<sp/>block<sp/>was<sp/>in</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>setBlockIndexCandidates<sp/>but<sp/>had<sp/>to<sp/>be<sp/>removed<sp/>because<sp/>of<sp/>the<sp/>missing<sp/>data.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5421"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>In<sp/>this<sp/>case<sp/>it<sp/>must<sp/>be<sp/>in<sp/>m_blocks_unlinked<sp/>--<sp/>see<sp/>test<sp/>below.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5423"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{<sp/></highlight><highlight class="comment">//<sp/>If<sp/>this<sp/>block<sp/>sorts<sp/>worse<sp/>than<sp/>the<sp/>current<sp/>tip<sp/>or<sp/>some<sp/>ancestor&apos;s<sp/>block<sp/>has<sp/>never<sp/>been<sp/>seen,<sp/>it<sp/>cannot<sp/>be<sp/>in<sp/>setBlockIndexCandidates.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5424"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!c-&gt;setBlockIndexCandidates.contains(</highlight><highlight class="keyword">const_cast&lt;</highlight><highlight class="normal">CBlockIndex*</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(pindex)));</highlight></codeline>
<codeline lineno="5425"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5426"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5427"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>whether<sp/>this<sp/>block<sp/>is<sp/>in<sp/>m_blocks_unlinked.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5428"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>rangeUnlinked{<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_blocks_unlinked.equal_range(pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>)};</highlight></codeline>
<codeline lineno="5429"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>foundInUnlinked<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(rangeUnlinked.first<sp/>!=<sp/>rangeUnlinked.second)<sp/>{</highlight></codeline>
<codeline lineno="5431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(rangeUnlinked.first-&gt;first<sp/>==<sp/>pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>);</highlight></codeline>
<codeline lineno="5432"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rangeUnlinked.first-&gt;second<sp/>==<sp/>pindex)<sp/>{</highlight></codeline>
<codeline lineno="5433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>foundInUnlinked<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5434"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5435"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5436"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rangeUnlinked.first++;</highlight></codeline>
<codeline lineno="5437"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5438"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>&amp;&amp;<sp/>(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15" kindref="member">BLOCK_HAVE_DATA</ref>)<sp/>&amp;&amp;<sp/>pindexFirstNeverProcessed<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>pindexFirstInvalid<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="5439"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>this<sp/>block<sp/>has<sp/>block<sp/>data<sp/>available,<sp/>some<sp/>parent<sp/>was<sp/>never<sp/>received,<sp/>and<sp/>has<sp/>no<sp/>invalid<sp/>parents,<sp/>it<sp/>must<sp/>be<sp/>in<sp/>m_blocks_unlinked.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5440"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(foundInUnlinked);</highlight></codeline>
<codeline lineno="5441"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5442"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15" kindref="member">BLOCK_HAVE_DATA</ref>))<sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!foundInUnlinked);<sp/></highlight><highlight class="comment">//<sp/>Can&apos;t<sp/>be<sp/>in<sp/>m_blocks_unlinked<sp/>if<sp/>we<sp/>don&apos;t<sp/>HAVE_DATA</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5443"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexFirstMissing<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!foundInUnlinked);<sp/></highlight><highlight class="comment">//<sp/>We<sp/>aren&apos;t<sp/>missing<sp/>data<sp/>for<sp/>any<sp/>parent<sp/>--<sp/>cannot<sp/>be<sp/>in<sp/>m_blocks_unlinked.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5444"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>&amp;&amp;<sp/>(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15" kindref="member">BLOCK_HAVE_DATA</ref>)<sp/>&amp;&amp;<sp/>pindexFirstNeverProcessed<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>pindexFirstMissing<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="5445"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>HAVE_DATA<sp/>for<sp/>this<sp/>block,<sp/>have<sp/>received<sp/>data<sp/>for<sp/>all<sp/>parents<sp/>at<sp/>some<sp/>point,<sp/>but<sp/>we&apos;re<sp/>currently<sp/>missing<sp/>data<sp/>for<sp/>some<sp/>parent.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5446"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_have_pruned);</highlight></codeline>
<codeline lineno="5447"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>block<sp/>may<sp/>have<sp/>entered<sp/>m_blocks_unlinked<sp/>if:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5448"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/>-<sp/>it<sp/>has<sp/>a<sp/>descendant<sp/>that<sp/>at<sp/>some<sp/>point<sp/>had<sp/>more<sp/>work<sp/>than<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5449"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/>tip,<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5450"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/>-<sp/>we<sp/>tried<sp/>switching<sp/>to<sp/>that<sp/>descendant<sp/>but<sp/>were<sp/>missing</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/>data<sp/>for<sp/>some<sp/>intermediate<sp/>block<sp/>between<sp/>m_chain<sp/>and<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5452"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5453"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>So<sp/>if<sp/>this<sp/>block<sp/>is<sp/>itself<sp/>better<sp/>than<sp/>any<sp/>m_chain.Tip()<sp/>and<sp/>it<sp/>wasn&apos;t<sp/>in</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>setBlockIndexCandidates,<sp/>then<sp/>it<sp/>must<sp/>be<sp/>in<sp/>m_blocks_unlinked.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5455"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>c<sp/>:<sp/>m_chainstates)<sp/>{</highlight></codeline>
<codeline lineno="5456"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!CBlockIndexWorkComparator()(pindex,<sp/>c-&gt;m_chain.Tip())<sp/>&amp;&amp;<sp/>!c-&gt;setBlockIndexCandidates.contains(</highlight><highlight class="keyword">const_cast&lt;</highlight><highlight class="normal">CBlockIndex*</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(pindex)))<sp/>{</highlight></codeline>
<codeline lineno="5457"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexFirstInvalid<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="5458"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!c-&gt;TargetBlock()<sp/>||<sp/>c-&gt;TargetBlock()-&gt;GetAncestor(pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>)<sp/>==<sp/>pindex)<sp/>{</highlight></codeline>
<codeline lineno="5459"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(foundInUnlinked);</highlight></codeline>
<codeline lineno="5460"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5461"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5462"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5463"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5464"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5465"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>assert(pindex-&gt;GetBlockHash()<sp/>==<sp/>pindex-&gt;GetBlockHeader().GetHash());<sp/>//<sp/>Perhaps<sp/>too<sp/>slow</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5466"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>End:<sp/>actual<sp/>consistency<sp/>checks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5467"><highlight class="normal"></highlight></codeline>
<codeline lineno="5468"><highlight class="normal"></highlight></codeline>
<codeline lineno="5469"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Try<sp/>descending<sp/>into<sp/>the<sp/>first<sp/>subnode.<sp/>Always<sp/>process<sp/>forks<sp/>first<sp/>and<sp/>the<sp/>best<sp/>header<sp/>chain<sp/>after.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5470"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snap_update_firsts();</highlight></codeline>
<codeline lineno="5471"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>range{forward.equal_range(pindex)};</highlight></codeline>
<codeline lineno="5472"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(range.first<sp/>!=<sp/>range.second)<sp/>{</highlight></codeline>
<codeline lineno="5473"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>A<sp/>subnode<sp/>not<sp/>part<sp/>of<sp/>the<sp/>best<sp/>header<sp/>chain<sp/>was<sp/>found.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5474"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex<sp/>=<sp/>range.first-&gt;second;</highlight></codeline>
<codeline lineno="5475"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref>++;</highlight></codeline>
<codeline lineno="5476"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5477"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(best_hdr_chain.<ref refid="class_c_chain_1a78c557b8d1209a61416487a99a7808a9" kindref="member">Contains</ref>(pindex))<sp/>{</highlight></codeline>
<codeline lineno="5478"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Descend<sp/>further<sp/>into<sp/>best<sp/>header<sp/>chain.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5479"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref>++;</highlight></codeline>
<codeline lineno="5480"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex<sp/>=<sp/>best_hdr_chain[<ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref>];</highlight></codeline>
<codeline lineno="5481"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pindex)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>we<sp/>are<sp/>finished,<sp/>since<sp/>the<sp/>best<sp/>header<sp/>chain<sp/>is<sp/>always<sp/>processed<sp/>last</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5482"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5483"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5484"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>is<sp/>a<sp/>leaf<sp/>node.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5485"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Move<sp/>upwards<sp/>until<sp/>we<sp/>reach<sp/>a<sp/>node<sp/>of<sp/>which<sp/>we<sp/>have<sp/>not<sp/>yet<sp/>visited<sp/>the<sp/>last<sp/>child.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5486"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(pindex)<sp/>{</highlight></codeline>
<codeline lineno="5487"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>are<sp/>going<sp/>to<sp/>either<sp/>move<sp/>to<sp/>a<sp/>parent<sp/>or<sp/>a<sp/>sibling<sp/>of<sp/>pindex.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5488"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snap_update_firsts();</highlight></codeline>
<codeline lineno="5489"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>pindex<sp/>was<sp/>the<sp/>first<sp/>with<sp/>a<sp/>certain<sp/>property,<sp/>unset<sp/>the<sp/>corresponding<sp/>variable.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex<sp/>==<sp/>pindexFirstInvalid)<sp/>pindexFirstInvalid<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5491"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex<sp/>==<sp/>pindexFirstMissing)<sp/>pindexFirstMissing<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex<sp/>==<sp/>pindexFirstNeverProcessed)<sp/>pindexFirstNeverProcessed<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex<sp/>==<sp/>pindexFirstNotTreeValid)<sp/>pindexFirstNotTreeValid<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex<sp/>==<sp/>pindexFirstNotTransactionsValid)<sp/>pindexFirstNotTransactionsValid<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5495"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex<sp/>==<sp/>pindexFirstNotChainValid)<sp/>pindexFirstNotChainValid<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5496"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex<sp/>==<sp/>pindexFirstNotScriptsValid)<sp/>pindexFirstNotScriptsValid<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5497"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Find<sp/>our<sp/>parent.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>pindexPar<sp/>=<sp/>pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>;</highlight></codeline>
<codeline lineno="5499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Find<sp/>which<sp/>child<sp/>we<sp/>just<sp/>visited.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>rangePar{forward.equal_range(pindexPar)};</highlight></codeline>
<codeline lineno="5501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(rangePar.first-&gt;second<sp/>!=<sp/>pindex)<sp/>{</highlight></codeline>
<codeline lineno="5502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(rangePar.first<sp/>!=<sp/>rangePar.second);<sp/></highlight><highlight class="comment">//<sp/>Our<sp/>parent<sp/>must<sp/>have<sp/>at<sp/>least<sp/>the<sp/>node<sp/>we&apos;re<sp/>coming<sp/>from<sp/>as<sp/>child.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5503"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rangePar.first++;</highlight></codeline>
<codeline lineno="5504"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Proceed<sp/>to<sp/>the<sp/>next<sp/>one.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rangePar.first++;</highlight></codeline>
<codeline lineno="5507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rangePar.first<sp/>!=<sp/>rangePar.second)<sp/>{</highlight></codeline>
<codeline lineno="5508"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Move<sp/>to<sp/>a<sp/>sibling<sp/>not<sp/>part<sp/>of<sp/>the<sp/>best<sp/>header<sp/>chain.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5509"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex<sp/>=<sp/>rangePar.first-&gt;second;</highlight></codeline>
<codeline lineno="5510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexPar<sp/>==<sp/>best_hdr_chain[<ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref><sp/>-<sp/>1])<sp/>{</highlight></codeline>
<codeline lineno="5512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Move<sp/>to<sp/>pindex&apos;s<sp/>sibling<sp/>on<sp/>the<sp/>best-chain,<sp/>if<sp/>it<sp/>has<sp/>one.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5513"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex<sp/>=<sp/>best_hdr_chain[<ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref>];</highlight></codeline>
<codeline lineno="5514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>There<sp/>will<sp/>not<sp/>be<sp/>a<sp/>next<sp/>block<sp/>if<sp/>(and<sp/>only<sp/>if)<sp/>parent<sp/>block<sp/>is<sp/>the<sp/>best<sp/>header.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5515"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>((pindex<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>==<sp/>(pindexPar<sp/>==<sp/>best_hdr_chain.<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>()));</highlight></codeline>
<codeline lineno="5516"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Move<sp/>up<sp/>further.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5519"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex<sp/>=<sp/>pindexPar;</highlight></codeline>
<codeline lineno="5520"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="mempool__ephemeral__spends_8cpp_1a2e4c6b811457a16b7033af6741cfb1db" kindref="member">nHeight</ref>--;</highlight></codeline>
<codeline lineno="5521"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5523"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5524"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5525"><highlight class="normal"></highlight></codeline>
<codeline lineno="5526"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>that<sp/>we<sp/>actually<sp/>traversed<sp/>the<sp/>entire<sp/>block<sp/>index.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5527"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(nNodes<sp/>==<sp/>forward.size()<sp/>+<sp/>best_hdr_chain.<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>()<sp/>+<sp/>1);</highlight></codeline>
<codeline lineno="5528"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5529"><highlight class="normal"></highlight></codeline>
<codeline lineno="5530"><highlight class="normal">std::string<sp/>Chainstate::ToString()</highlight></codeline>
<codeline lineno="5531"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5532"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="5533"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>tip<sp/>=<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Tip();</highlight></codeline>
<codeline lineno="5534"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;Chainstate<sp/>[%s]<sp/>@<sp/>height<sp/>%d<sp/>(%s)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5535"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a37f0e70024a7d2d694ae27d34609de0e" kindref="member">m_from_snapshot_blockhash</ref><sp/>?<sp/></highlight><highlight class="stringliteral">&quot;snapshot&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;ibd&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5536"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tip<sp/>?<sp/>tip-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>:<sp/>-1,<sp/>tip<sp/>?<sp/>tip-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>()<sp/>:<sp/></highlight><highlight class="stringliteral">&quot;null&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="5537"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5538"><highlight class="normal"></highlight></codeline>
<codeline lineno="5539"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>Chainstate::ResizeCoinsCaches(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>coinstip_size,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>coinsdb_size)</highlight></codeline>
<codeline lineno="5540"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5541"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="5542"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(coinstip_size<sp/>==<sp/><ref refid="class_chainstate_1a9f27f82f81429b6be783bb2ba38a7383" kindref="member">m_coinstip_cache_size_bytes</ref><sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="5543"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coinsdb_size<sp/>==<sp/><ref refid="class_chainstate_1a209fef4fed4aee7188492631ecc6a782" kindref="member">m_coinsdb_cache_size_bytes</ref>)<sp/>{</highlight></codeline>
<codeline lineno="5544"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Cache<sp/>sizes<sp/>are<sp/>unchanged,<sp/>no<sp/>need<sp/>to<sp/>continue.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5545"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5546"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5547"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>old_coinstip_size<sp/>=<sp/><ref refid="class_chainstate_1a9f27f82f81429b6be783bb2ba38a7383" kindref="member">m_coinstip_cache_size_bytes</ref>;</highlight></codeline>
<codeline lineno="5548"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a9f27f82f81429b6be783bb2ba38a7383" kindref="member">m_coinstip_cache_size_bytes</ref><sp/>=<sp/>coinstip_size;</highlight></codeline>
<codeline lineno="5549"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a209fef4fed4aee7188492631ecc6a782" kindref="member">m_coinsdb_cache_size_bytes</ref><sp/>=<sp/>coinsdb_size;</highlight></codeline>
<codeline lineno="5550"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1ad876ac510821396146002e921946e008" kindref="member">CoinsDB</ref>().<ref refid="class_c_coins_view_d_b_1a1e774d1abd7c539947ae3d53bb0b7f74" kindref="member">ResizeCache</ref>(coinsdb_size);</highlight></codeline>
<codeline lineno="5551"><highlight class="normal"></highlight></codeline>
<codeline lineno="5552"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;[%s]<sp/>resized<sp/>coinsdb<sp/>cache<sp/>to<sp/>%.1f<sp/>MiB&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5553"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>this-&gt;<ref refid="bitcoin-cli_8cpp_1aec2c30b1707eac00ff7e4fb5b3f7a92d" kindref="member">ToString</ref>(),<sp/>coinsdb_size<sp/>*<sp/>(1.0<sp/>/<sp/>1024<sp/>/<sp/>1024));</highlight></codeline>
<codeline lineno="5554"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;[%s]<sp/>resized<sp/>coinstip<sp/>cache<sp/>to<sp/>%.1f<sp/>MiB&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5555"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>this-&gt;<ref refid="bitcoin-cli_8cpp_1aec2c30b1707eac00ff7e4fb5b3f7a92d" kindref="member">ToString</ref>(),<sp/>coinstip_size<sp/>*<sp/>(1.0<sp/>/<sp/>1024<sp/>/<sp/>1024));</highlight></codeline>
<codeline lineno="5556"><highlight class="normal"></highlight></codeline>
<codeline lineno="5557"><highlight class="normal"><sp/><sp/><sp/><sp/>BlockValidationState<sp/>state;</highlight></codeline>
<codeline lineno="5558"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>;</highlight></codeline>
<codeline lineno="5559"><highlight class="normal"></highlight></codeline>
<codeline lineno="5560"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(coinstip_size<sp/>&gt;<sp/>old_coinstip_size)<sp/>{</highlight></codeline>
<codeline lineno="5561"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Likely<sp/>no<sp/>need<sp/>to<sp/>flush<sp/>if<sp/>cache<sp/>sizes<sp/>have<sp/>grown.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5562"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref><sp/>=<sp/><ref refid="class_chainstate_1a0f9f0cdb703638cb9818a9b41158ac6a" kindref="member">FlushStateToDisk</ref>(state,<sp/><ref refid="validation_8h_1ab30a99e75e9dc44356d1ad6bdd184ae0a2382c561ef224fb0ab277eca39c90654" kindref="member">FlushStateMode::IF_NEEDED</ref>);</highlight></codeline>
<codeline lineno="5563"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5564"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Otherwise,<sp/>flush<sp/>state<sp/>to<sp/>disk<sp/>and<sp/>deallocate<sp/>the<sp/>in-memory<sp/>coins<sp/>map.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5565"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref><sp/>=<sp/><ref refid="class_chainstate_1a0f9f0cdb703638cb9818a9b41158ac6a" kindref="member">FlushStateToDisk</ref>(state,<sp/><ref refid="validation_8h_1ab30a99e75e9dc44356d1ad6bdd184ae0af3fc827ade4b968e50406496907ef962" kindref="member">FlushStateMode::ALWAYS</ref>);</highlight></codeline>
<codeline lineno="5566"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5567"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>;</highlight></codeline>
<codeline lineno="5568"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5569"><highlight class="normal"></highlight></codeline>
<codeline lineno="5570"><highlight class="normal"></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager_1ab95b248ecacf42357d9d4ea19e696ff7" kindref="member">ChainstateManager::GuessVerificationProgress</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>*<sp/>pindex)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="5571"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="5572"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="class_chainstate_manager_1af99ab8783b483abe3fef8ab596a3e6b6" kindref="member">GetMutex</ref>());</highlight></codeline>
<codeline lineno="5573"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>ChainTxData&amp;<sp/><ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>{<ref refid="class_chainstate_manager_1a9fc4893dda46aba09dbcd01e3387ca6f" kindref="member">GetParams</ref>().<ref refid="class_c_chain_params_1a91e49e31c52fce02fc5c57740665be25" kindref="member">TxData</ref>()};</highlight></codeline>
<codeline lineno="5574"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="5575"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0.0;</highlight></codeline>
<codeline lineno="5576"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5577"><highlight class="normal"></highlight></codeline>
<codeline lineno="5578"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref><sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="5579"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a7721bbfbdf88038c07a667176e9ab22c" kindref="member">BCLog::VALIDATION</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Block<sp/>%d<sp/>has<sp/>unset<sp/>m_chain_tx_count.<sp/>Unable<sp/>to<sp/>estimate<sp/>verification<sp/>progress.\n&quot;</highlight><highlight class="normal">,<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>);</highlight></codeline>
<codeline lineno="5580"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0.0;</highlight></codeline>
<codeline lineno="5581"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5582"><highlight class="normal"></highlight></codeline>
<codeline lineno="5583"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>int64_t<sp/>nNow{<ref refid="util_2time_8h_1a4cece1006bbcfc11487e9e8bcd837d14" kindref="member">TicksSinceEpoch&lt;std::chrono::seconds&gt;</ref>(<ref refid="struct_node_clock_1a1be2fa9903731211253f2e36b5f3b584" kindref="member">NodeClock::now</ref>())};</highlight></codeline>
<codeline lineno="5584"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>block_time{</highlight></codeline>
<codeline lineno="5585"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(<ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(m_best_header)<sp/>&amp;&amp;<sp/>std::abs(nNow<sp/>-<sp/>pindex-&gt;<ref refid="class_c_block_index_1a7aea61ae131a8b7b934f8b3a758d9490" kindref="member">GetBlockTime</ref>())<sp/>&lt;=<sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;std::chrono::seconds&gt;</ref>(2h)<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="5586"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(m_best_header-&gt;nHeight<sp/>&gt;=<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>))<sp/>?</highlight></codeline>
<codeline lineno="5587"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When<sp/>the<sp/>header<sp/>is<sp/>known<sp/>to<sp/>be<sp/>recent,<sp/>switch<sp/>to<sp/>a<sp/>height-based</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5588"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>approach.<sp/>This<sp/>ensures<sp/>the<sp/>returned<sp/>value<sp/>is<sp/>quantized<sp/>when</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5589"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>close<sp/>to<sp/>&quot;1.0&quot;,<sp/>because<sp/>some<sp/>users<sp/>expect<sp/>it<sp/>to<sp/>be.<sp/>This<sp/>also</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5590"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>avoids<sp/>relying<sp/>too<sp/>much<sp/>on<sp/>the<sp/>exact<sp/>miner-set<sp/>timestamp,<sp/>which</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5591"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>may<sp/>be<sp/>off.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5592"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nNow<sp/>-<sp/>(m_best_header-&gt;nHeight<sp/>-<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>)<sp/>*<sp/><ref refid="class_chainstate_manager_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>().<ref refid="struct_consensus_1_1_params_1a096ffd2f2385b72c7bff4ba651f0bb51" kindref="member">nPowTargetSpacing</ref><sp/>:</highlight></codeline>
<codeline lineno="5593"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex-&gt;<ref refid="class_c_block_index_1a7aea61ae131a8b7b934f8b3a758d9490" kindref="member">GetBlockTime</ref>(),</highlight></codeline>
<codeline lineno="5594"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="5595"><highlight class="normal"></highlight></codeline>
<codeline lineno="5596"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>fTxTotal;</highlight></codeline>
<codeline lineno="5597"><highlight class="normal"></highlight></codeline>
<codeline lineno="5598"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref><sp/>&lt;=<sp/><ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>.tx_count)<sp/>{</highlight></codeline>
<codeline lineno="5599"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fTxTotal<sp/>=<sp/><ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>.tx_count<sp/>+<sp/>(nNow<sp/>-<sp/><ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>.nTime)<sp/>*<sp/><ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>.dTxRate;</highlight></codeline>
<codeline lineno="5600"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5601"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fTxTotal<sp/>=<sp/>pindex-&gt;<ref refid="class_c_block_index_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref><sp/>+<sp/>(nNow<sp/>-<sp/>block_time)<sp/>*<sp/><ref refid="namespacetest__vectors__musig2__generate_1a511ae0b1c13f95e5f08f1a0dd3da3d93" kindref="member">data</ref>.dTxRate;</highlight></codeline>
<codeline lineno="5602"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5603"><highlight class="normal"></highlight></codeline>
<codeline lineno="5604"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::min&lt;double&gt;(pindex-&gt;<ref refid="class_c_block_index_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref><sp/>/<sp/>fTxTotal,<sp/>1.0);</highlight></codeline>
<codeline lineno="5605"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5606"><highlight class="normal"></highlight></codeline>
<codeline lineno="5607"><highlight class="normal"><ref refid="class_chainstate" kindref="compound">Chainstate</ref>&amp;<sp/>ChainstateManager::InitializeChainstate(<ref refid="class_c_tx_mem_pool" kindref="compound">CTxMemPool</ref>*<sp/>mempool)</highlight></codeline>
<codeline lineno="5608"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5609"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="5610"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(m_chainstates.empty());</highlight></codeline>
<codeline lineno="5611"><highlight class="normal"><sp/><sp/><sp/><sp/>m_chainstates.emplace_back(std::make_unique&lt;Chainstate&gt;(mempool,<sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>,<sp/>*</highlight><highlight class="keyword">this</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="5612"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>*m_chainstates.back();</highlight></codeline>
<codeline lineno="5613"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5614"><highlight class="normal"></highlight></codeline>
<codeline lineno="5615"><highlight class="normal">[[nodiscard]]<sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>DeleteCoinsDBFromDisk(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::path<sp/>db_path,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>is_snapshot)</highlight></codeline>
<codeline lineno="5616"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>)</highlight></codeline>
<codeline lineno="5617"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5618"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="5619"><highlight class="normal"></highlight></codeline>
<codeline lineno="5620"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(is_snapshot)<sp/>{</highlight></codeline>
<codeline lineno="5621"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs::path<sp/>base_blockhash_path<sp/>=<sp/>db_path<sp/>/<sp/><ref refid="namespacenode_1ae40260991115210bae924c07e683ac91" kindref="member">node::SNAPSHOT_BLOCKHASH_FILENAME</ref>;</highlight></codeline>
<codeline lineno="5622"><highlight class="normal"></highlight></codeline>
<codeline lineno="5623"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5624"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>existed<sp/>=<sp/>fs::remove(base_blockhash_path);</highlight></codeline>
<codeline lineno="5625"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!existed)<sp/>{</highlight></codeline>
<codeline lineno="5626"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>snapshot<sp/>chainstate<sp/>dir<sp/>being<sp/>removed<sp/>lacks<sp/>%s<sp/>file&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5627"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs::PathToString(<ref refid="namespacenode_1ae40260991115210bae924c07e683ac91" kindref="member">node::SNAPSHOT_BLOCKHASH_FILENAME</ref>));</highlight></codeline>
<codeline lineno="5628"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5629"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::filesystem_error&amp;<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="5630"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>failed<sp/>to<sp/>remove<sp/>file<sp/>%s:<sp/>%s\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5631"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs::PathToString(base_blockhash_path),<sp/>e.code().message());</highlight></codeline>
<codeline lineno="5632"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5633"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5634"><highlight class="normal"></highlight></codeline>
<codeline lineno="5635"><highlight class="normal"><sp/><sp/><sp/><sp/>std::string<sp/>path_str<sp/>=<sp/>fs::PathToString(db_path);</highlight></codeline>
<codeline lineno="5636"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Removing<sp/>leveldb<sp/>dir<sp/>at<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>path_str);</highlight></codeline>
<codeline lineno="5637"><highlight class="normal"></highlight></codeline>
<codeline lineno="5638"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>have<sp/>to<sp/>destruct<sp/>before<sp/>this<sp/>call<sp/>leveldb::DB<sp/>in<sp/>order<sp/>to<sp/>release<sp/>the<sp/>db</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5639"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>lock,<sp/>otherwise<sp/>`DestroyDB`<sp/>will<sp/>fail.<sp/>See<sp/>`leveldb::~DBImpl()`.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5640"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>destroyed<sp/>=<sp/><ref refid="dbwrapper_8cpp_1a37efe0b9eac923c8ef4e78e015b62ca9" kindref="member">DestroyDB</ref>(path_str);</highlight></codeline>
<codeline lineno="5641"><highlight class="normal"></highlight></codeline>
<codeline lineno="5642"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!destroyed)<sp/>{</highlight></codeline>
<codeline lineno="5643"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;leveldb<sp/>DestroyDB<sp/>call<sp/>failed<sp/>on<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>path_str);</highlight></codeline>
<codeline lineno="5644"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5645"><highlight class="normal"></highlight></codeline>
<codeline lineno="5646"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Datadir<sp/>should<sp/>be<sp/>removed<sp/>from<sp/>filesystem;<sp/>otherwise<sp/>initialization<sp/>may<sp/>detect</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5647"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>it<sp/>on<sp/>subsequent<sp/>statups<sp/>and<sp/>get<sp/>confused.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5648"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5649"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>base_blockhash_path<sp/>removal<sp/>above<sp/>fails<sp/>in<sp/>the<sp/>case<sp/>of<sp/>snapshot</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5650"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>chainstates,<sp/>this<sp/>will<sp/>return<sp/>false<sp/>since<sp/>leveldb<sp/>won&apos;t<sp/>remove<sp/>a<sp/>non-empty</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5651"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>directory.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5652"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>destroyed<sp/>&amp;&amp;<sp/>!fs::exists(db_path);</highlight></codeline>
<codeline lineno="5653"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5654"><highlight class="normal"></highlight></codeline>
<codeline lineno="5655"><highlight class="normal"><ref refid="classutil_1_1_result" kindref="compound">util::Result&lt;CBlockIndex*&gt;</ref><sp/><ref refid="class_chainstate_manager_1ad1791e4f65d252d4163bca3d75e8e418" kindref="member">ChainstateManager::ActivateSnapshot</ref>(</highlight></codeline>
<codeline lineno="5656"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_auto_file" kindref="compound">AutoFile</ref>&amp;<sp/>coins_file,</highlight></codeline>
<codeline lineno="5657"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classnode_1_1_snapshot_metadata" kindref="compound">SnapshotMetadata</ref>&amp;<sp/>metadata,</highlight></codeline>
<codeline lineno="5658"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>in_memory)</highlight></codeline>
<codeline lineno="5659"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5660"><highlight class="normal"><sp/><sp/><sp/><sp/>uint256<sp/>base_blockhash<sp/>=<sp/>metadata.<ref refid="classnode_1_1_snapshot_metadata_1a98d7b7da08325ede72f0f80886dc079d" kindref="member">m_base_blockhash</ref>;</highlight></codeline>
<codeline lineno="5661"><highlight class="normal"></highlight></codeline>
<codeline lineno="5662"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>snapshot_start_block{};</highlight></codeline>
<codeline lineno="5663"><highlight class="normal"></highlight></codeline>
<codeline lineno="5664"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="5665"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="5666"><highlight class="normal"></highlight></codeline>
<codeline lineno="5667"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(this-&gt;<ref refid="class_chainstate_manager_1a8d39d359e6ed774815dc8d31f326ff82" kindref="member">CurrentChainstate</ref>().m_from_snapshot_blockhash)<sp/>{</highlight></codeline>
<codeline lineno="5668"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(</highlight><highlight class="stringliteral">&quot;Can&apos;t<sp/>activate<sp/>a<sp/>snapshot-based<sp/>chainstate<sp/>more<sp/>than<sp/>once&quot;</highlight><highlight class="normal">)};</highlight></codeline>
<codeline lineno="5669"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5670"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_chainstate_manager_1a9fc4893dda46aba09dbcd01e3387ca6f" kindref="member">GetParams</ref>().AssumeutxoForBlockhash(base_blockhash).has_value())<sp/>{</highlight></codeline>
<codeline lineno="5671"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>available_heights<sp/>=<sp/><ref refid="class_chainstate_manager_1a9fc4893dda46aba09dbcd01e3387ca6f" kindref="member">GetParams</ref>().<ref refid="class_c_chain_params_1a9cff7d07f577f33b64e4e4b5bc9c202e" kindref="member">GetAvailableSnapshotHeights</ref>();</highlight></codeline>
<codeline lineno="5672"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::string<sp/>heights_formatted<sp/>=<sp/><ref refid="namespaceutil_1aff2a33f4c8a8ebd77cf6e0630bd1dbe3" kindref="member">util::Join</ref>(available_heights,<sp/></highlight><highlight class="stringliteral">&quot;,<sp/>&quot;</highlight><highlight class="normal">,<sp/>[&amp;](</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>i)<sp/>{<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="namespaceutil_1aec2c30b1707eac00ff7e4fb5b3f7a92d" kindref="member">util::ToString</ref>(i);<sp/>});</highlight></codeline>
<codeline lineno="5673"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(<ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;assumeutxo<sp/>block<sp/>hash<sp/>in<sp/>snapshot<sp/>metadata<sp/>not<sp/>recognized<sp/>(hash:<sp/>%s).<sp/>The<sp/>following<sp/>snapshot<sp/>heights<sp/>are<sp/>available:<sp/>%s&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5674"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>base_blockhash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),</highlight></codeline>
<codeline lineno="5675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>heights_formatted))};</highlight></codeline>
<codeline lineno="5676"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5677"><highlight class="normal"></highlight></codeline>
<codeline lineno="5678"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snapshot_start_block<sp/>=<sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.LookupBlockIndex(base_blockhash);</highlight></codeline>
<codeline lineno="5679"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!snapshot_start_block)<sp/>{</highlight></codeline>
<codeline lineno="5680"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(<ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;The<sp/>base<sp/>block<sp/>header<sp/>(%s)<sp/>must<sp/>appear<sp/>in<sp/>the<sp/>headers<sp/>chain.<sp/>Make<sp/>sure<sp/>all<sp/>headers<sp/>are<sp/>syncing,<sp/>and<sp/>call<sp/>loadtxoutset<sp/>again&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5681"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>base_blockhash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>()))};</highlight></codeline>
<codeline lineno="5682"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5683"><highlight class="normal"></highlight></codeline>
<codeline lineno="5684"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>start_block_invalid<sp/>=<sp/>snapshot_start_block-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada88df51e92f2f675baff60e0a5bd170ef" kindref="member">BLOCK_FAILED_MASK</ref>;</highlight></codeline>
<codeline lineno="5685"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(start_block_invalid)<sp/>{</highlight></codeline>
<codeline lineno="5686"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(<ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;The<sp/>base<sp/>block<sp/>header<sp/>(%s)<sp/>is<sp/>part<sp/>of<sp/>an<sp/>invalid<sp/>chain&quot;</highlight><highlight class="normal">,<sp/>base_blockhash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>()))};</highlight></codeline>
<codeline lineno="5687"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5688"><highlight class="normal"></highlight></codeline>
<codeline lineno="5689"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_best_header<sp/>||<sp/>m_best_header-&gt;GetAncestor(snapshot_start_block-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>)<sp/>!=<sp/>snapshot_start_block)<sp/>{</highlight></codeline>
<codeline lineno="5690"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(</highlight><highlight class="stringliteral">&quot;A<sp/>forked<sp/>headers-chain<sp/>with<sp/>more<sp/>work<sp/>than<sp/>the<sp/>chain<sp/>with<sp/>the<sp/>snapshot<sp/>base<sp/>block<sp/>header<sp/>exists.<sp/>Please<sp/>proceed<sp/>to<sp/>sync<sp/>without<sp/>AssumeUtxo.&quot;</highlight><highlight class="normal">)};</highlight></codeline>
<codeline lineno="5691"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5692"><highlight class="normal"></highlight></codeline>
<codeline lineno="5693"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>mempool{<ref refid="class_chainstate_manager_1a8d39d359e6ed774815dc8d31f326ff82" kindref="member">CurrentChainstate</ref>().<ref refid="class_chainstate_1ac2dc9bde2175dbfb05382c6e8033db28" kindref="member">GetMempool</ref>()};</highlight></codeline>
<codeline lineno="5694"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(mempool<sp/>&amp;&amp;<sp/>mempool-&gt;<ref refid="class_c_tx_mem_pool_1af22b5286aa0191a7087a205f6d04b032" kindref="member">size</ref>()<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="5695"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(</highlight><highlight class="stringliteral">&quot;Can&apos;t<sp/>activate<sp/>a<sp/>snapshot<sp/>when<sp/>mempool<sp/>not<sp/>empty&quot;</highlight><highlight class="normal">)};</highlight></codeline>
<codeline lineno="5696"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5697"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5698"><highlight class="normal"></highlight></codeline>
<codeline lineno="5699"><highlight class="normal"><sp/><sp/><sp/><sp/>int64_t<sp/>current_coinsdb_cache_size{0};</highlight></codeline>
<codeline lineno="5700"><highlight class="normal"><sp/><sp/><sp/><sp/>int64_t<sp/>current_coinstip_cache_size{0};</highlight></codeline>
<codeline lineno="5701"><highlight class="normal"></highlight></codeline>
<codeline lineno="5702"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Cache<sp/>percentages<sp/>to<sp/>allocate<sp/>to<sp/>each<sp/>chainstate.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5703"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5704"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>These<sp/>particular<sp/>percentages<sp/>don&apos;t<sp/>matter<sp/>so<sp/>much<sp/>since<sp/>they<sp/>will<sp/>only<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5705"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>relevant<sp/>during<sp/>snapshot<sp/>activation;<sp/>caches<sp/>are<sp/>rebalanced<sp/>at<sp/>the<sp/>conclusion<sp/>of</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5706"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>this<sp/>function.<sp/>We<sp/>want<sp/>to<sp/>give<sp/>(essentially)<sp/>all<sp/>available<sp/>cache<sp/>capacity<sp/>to<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5707"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>snapshot<sp/>to<sp/>aid<sp/>the<sp/>bulk<sp/>load<sp/>later<sp/>in<sp/>this<sp/>function.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5708"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>IBD_CACHE_PERC<sp/>=<sp/>0.01;</highlight></codeline>
<codeline lineno="5709"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>SNAPSHOT_CACHE_PERC<sp/>=<sp/>0.99;</highlight></codeline>
<codeline lineno="5710"><highlight class="normal"></highlight></codeline>
<codeline lineno="5711"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="5712"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="5713"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Resize<sp/>the<sp/>coins<sp/>caches<sp/>to<sp/>ensure<sp/>we&apos;re<sp/>not<sp/>exceeding<sp/>memory<sp/>limits.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5714"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5715"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Allocate<sp/>the<sp/>majority<sp/>of<sp/>the<sp/>cache<sp/>to<sp/>the<sp/>incoming<sp/>snapshot<sp/>chainstate,<sp/>since</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5716"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(optimistically)<sp/>getting<sp/>to<sp/>its<sp/>tip<sp/>will<sp/>be<sp/>the<sp/>top<sp/>priority.<sp/>We&apos;ll<sp/>need<sp/>to<sp/>call</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5717"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>`MaybeRebalanceCaches()`<sp/>once<sp/>we&apos;re<sp/>done<sp/>with<sp/>this<sp/>function<sp/>to<sp/>ensure</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5718"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>right<sp/>allocation<sp/>(including<sp/>the<sp/>possibility<sp/>that<sp/>no<sp/>snapshot<sp/>was<sp/>activated</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5719"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>that<sp/>we<sp/>should<sp/>restore<sp/>the<sp/>active<sp/>chainstate<sp/>caches<sp/>to<sp/>their<sp/>original<sp/>size).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5720"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5721"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>current_coinsdb_cache_size<sp/>=<sp/>this-&gt;<ref refid="class_chainstate_manager_1a0ed46908ea52e17d172f2fcc0ceb9964" kindref="member">ActiveChainstate</ref>().<ref refid="class_chainstate_1a209fef4fed4aee7188492631ecc6a782" kindref="member">m_coinsdb_cache_size_bytes</ref>;</highlight></codeline>
<codeline lineno="5722"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>current_coinstip_cache_size<sp/>=<sp/>this-&gt;<ref refid="class_chainstate_manager_1a0ed46908ea52e17d172f2fcc0ceb9964" kindref="member">ActiveChainstate</ref>().<ref refid="class_chainstate_1a9f27f82f81429b6be783bb2ba38a7383" kindref="member">m_coinstip_cache_size_bytes</ref>;</highlight></codeline>
<codeline lineno="5723"><highlight class="normal"></highlight></codeline>
<codeline lineno="5724"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Temporarily<sp/>resize<sp/>the<sp/>active<sp/>coins<sp/>cache<sp/>to<sp/>make<sp/>room<sp/>for<sp/>the<sp/>newly-created</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5725"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>snapshot<sp/>chain.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5726"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>this-&gt;<ref refid="class_chainstate_manager_1a0ed46908ea52e17d172f2fcc0ceb9964" kindref="member">ActiveChainstate</ref>().ResizeCoinsCaches(</highlight></codeline>
<codeline lineno="5727"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">size_t</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(current_coinstip_cache_size<sp/>*<sp/>IBD_CACHE_PERC),</highlight></codeline>
<codeline lineno="5728"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">size_t</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(current_coinsdb_cache_size<sp/>*<sp/>IBD_CACHE_PERC));</highlight></codeline>
<codeline lineno="5729"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5730"><highlight class="normal"></highlight></codeline>
<codeline lineno="5731"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>snapshot_chainstate<sp/>=<sp/><ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>,</highlight></codeline>
<codeline lineno="5732"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::make_unique&lt;Chainstate&gt;(</highlight></codeline>
<codeline lineno="5733"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*mempool=*/</highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">,<sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>,<sp/>*</highlight><highlight class="keyword">this</highlight><highlight class="normal">,<sp/>base_blockhash));</highlight></codeline>
<codeline lineno="5734"><highlight class="normal"></highlight></codeline>
<codeline lineno="5735"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="5736"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="5737"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snapshot_chainstate-&gt;InitCoinsDB(</highlight></codeline>
<codeline lineno="5738"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">size_t</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(current_coinsdb_cache_size<sp/>*<sp/>SNAPSHOT_CACHE_PERC),</highlight></codeline>
<codeline lineno="5739"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>in_memory,<sp/></highlight><highlight class="comment">/*should_wipe=*/</highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="5740"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snapshot_chainstate-&gt;InitCoinsCache(</highlight></codeline>
<codeline lineno="5741"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">size_t</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(current_coinstip_cache_size<sp/>*<sp/>SNAPSHOT_CACHE_PERC));</highlight></codeline>
<codeline lineno="5742"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5743"><highlight class="normal"></highlight></codeline>
<codeline lineno="5744"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>cleanup_bad_snapshot<sp/>=<sp/>[&amp;](bilingual_str<sp/>reason)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>)<sp/>{</highlight></codeline>
<codeline lineno="5745"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>this-&gt;MaybeRebalanceCaches();</highlight></codeline>
<codeline lineno="5746"><highlight class="normal"></highlight></codeline>
<codeline lineno="5747"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>PopulateAndValidateSnapshot<sp/>can<sp/>return<sp/>(in<sp/>error)<sp/>before<sp/>the<sp/>leveldb<sp/>datadir</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5748"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>has<sp/>been<sp/>created,<sp/>so<sp/>only<sp/>attempt<sp/>removal<sp/>if<sp/>we<sp/>got<sp/>that<sp/>far.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5749"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>snapshot_datadir<sp/>=<sp/><ref refid="namespacenode_1a5b64fe45690872d3bd11de86a157c931" kindref="member">node::FindAssumeutxoChainstateDir</ref>(<ref refid="class_chainstate_manager_1a012c0463bd17a2be6045a0d62e8b0fd4" kindref="member">m_options</ref>.datadir))<sp/>{</highlight></codeline>
<codeline lineno="5750"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>have<sp/>to<sp/>destruct<sp/>leveldb::DB<sp/>in<sp/>order<sp/>to<sp/>release<sp/>the<sp/>db<sp/>lock,<sp/>otherwise</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5751"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>DestroyDB()<sp/>(in<sp/>DeleteCoinsDBFromDisk())<sp/>will<sp/>fail.<sp/>See<sp/>`leveldb::~DBImpl()`.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5752"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Destructing<sp/>the<sp/>chainstate<sp/>(and<sp/>so<sp/>resetting<sp/>the<sp/>coinsviews<sp/>object)<sp/>does<sp/>this.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5753"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snapshot_chainstate.reset();</highlight></codeline>
<codeline lineno="5754"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>removed<sp/>=<sp/>DeleteCoinsDBFromDisk(*snapshot_datadir,<sp/></highlight><highlight class="comment">/*is_snapshot=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="5755"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!removed)<sp/>{</highlight></codeline>
<codeline lineno="5756"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a30d910c43e6619c9596c077fd1e5518d" kindref="member">GetNotifications</ref>().<ref refid="classkernel_1_1_notifications_1a2998f041aae2f227bb4bba3d9cb7a292" kindref="member">fatalError</ref>(<ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(<ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>remove<sp/>snapshot<sp/>chainstate<sp/>dir<sp/>(%s).<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5757"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Manually<sp/>remove<sp/>it<sp/>before<sp/>restarting.\n&quot;</highlight><highlight class="normal">),<sp/>fs::PathToString(*snapshot_datadir)));</highlight></codeline>
<codeline lineno="5758"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5759"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5760"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{std::move(reason)};</highlight></codeline>
<codeline lineno="5761"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="5762"><highlight class="normal"></highlight></codeline>
<codeline lineno="5763"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>res{this-&gt;PopulateAndValidateSnapshot(*snapshot_chainstate,<sp/>coins_file,<sp/>metadata)};<sp/>!res)<sp/>{</highlight></codeline>
<codeline lineno="5764"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="5765"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>cleanup_bad_snapshot(<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(<ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;Population<sp/>failed:<sp/>%s&quot;</highlight><highlight class="normal">,<sp/><ref refid="namespaceutil_1adbcebd9741ba34de94c8384025e54825" kindref="member">util::ErrorString</ref>(res).original)));</highlight></codeline>
<codeline lineno="5766"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5767"><highlight class="normal"></highlight></codeline>
<codeline lineno="5768"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);<sp/><sp/></highlight><highlight class="comment">//<sp/>cs_main<sp/>required<sp/>for<sp/>rest<sp/>of<sp/>snapshot<sp/>activation.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5769"><highlight class="normal"></highlight></codeline>
<codeline lineno="5770"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Do<sp/>a<sp/>final<sp/>check<sp/>to<sp/>ensure<sp/>that<sp/>the<sp/>snapshot<sp/>chainstate<sp/>is<sp/>actually<sp/>a<sp/>more</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5771"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>work<sp/>chain<sp/>than<sp/>the<sp/>active<sp/>chainstate;<sp/>a<sp/>user<sp/>could<sp/>have<sp/>loaded<sp/>a<sp/>snapshot</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5772"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>very<sp/>late<sp/>in<sp/>the<sp/>IBD<sp/>process,<sp/>and<sp/>we<sp/>wouldn&apos;t<sp/>want<sp/>to<sp/>load<sp/>a<sp/>useless<sp/>chainstate.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5773"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!CBlockIndexWorkComparator()(<ref refid="class_chainstate_manager_1ac8dc81d17ce18093b02ef600686870b3" kindref="member">ActiveTip</ref>(),<sp/>snapshot_chainstate-&gt;m_chain.Tip()))<sp/>{</highlight></codeline>
<codeline lineno="5774"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>cleanup_bad_snapshot(<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(</highlight><highlight class="stringliteral">&quot;work<sp/>does<sp/>not<sp/>exceed<sp/>active<sp/>chainstate&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="5775"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5776"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>not<sp/>in-memory,<sp/>persist<sp/>the<sp/>base<sp/>blockhash<sp/>for<sp/>use<sp/>during<sp/>subsequent</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5777"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>initialization.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5778"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!in_memory)<sp/>{</highlight></codeline>
<codeline lineno="5779"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="namespacenode_1aa28134e14a9f1ba865d7ca064e0486dd" kindref="member">node::WriteSnapshotBaseBlockhash</ref>(*snapshot_chainstate))<sp/>{</highlight></codeline>
<codeline lineno="5780"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>cleanup_bad_snapshot(<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(</highlight><highlight class="stringliteral">&quot;could<sp/>not<sp/>write<sp/>base<sp/>blockhash&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="5781"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5782"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5783"><highlight class="normal"></highlight></codeline>
<codeline lineno="5784"><highlight class="normal"><sp/><sp/><sp/><sp/>Chainstate&amp;<sp/>chainstate{AddChainstate(std::move(snapshot_chainstate))};</highlight></codeline>
<codeline lineno="5785"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>chaintip_loaded{chainstate.<ref refid="class_chainstate_1a1ea13869144ef7ef6c69114ce9834a70" kindref="member">LoadChainTip</ref>()};</highlight></codeline>
<codeline lineno="5786"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(chaintip_loaded);</highlight></codeline>
<codeline lineno="5787"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_snapshot_height<sp/>=<sp/><ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(chainstate.SnapshotBase())-&gt;nHeight;</highlight></codeline>
<codeline lineno="5788"><highlight class="normal"></highlight></codeline>
<codeline lineno="5789"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>successfully<sp/>activated<sp/>snapshot<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>base_blockhash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="5790"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>(%.2f<sp/>MB)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5791"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>chainstate.<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>().<ref refid="class_c_coins_view_cache_1afcc22204abc15aeefd5d1f7396e909a4" kindref="member">DynamicMemoryUsage</ref>()<sp/>/<sp/>(1000<sp/>*<sp/>1000));</highlight></codeline>
<codeline lineno="5792"><highlight class="normal"></highlight></codeline>
<codeline lineno="5793"><highlight class="normal"><sp/><sp/><sp/><sp/>this-&gt;MaybeRebalanceCaches();</highlight></codeline>
<codeline lineno="5794"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>snapshot_start_block;</highlight></codeline>
<codeline lineno="5795"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5796"><highlight class="normal"></highlight></codeline>
<codeline lineno="5797"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>FlushSnapshotToDisk(<ref refid="class_c_coins_view_cache" kindref="compound">CCoinsViewCache</ref>&amp;<sp/>coins_cache,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>snapshot_loaded)</highlight></codeline>
<codeline lineno="5798"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5799"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="timer_8h_1a608d0d9402c29670f9240a9e66644d29" kindref="member">LOG_TIME_MILLIS_WITH_CATEGORY_MSG_ONCE</ref>(</highlight></codeline>
<codeline lineno="5800"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;%s<sp/>(%.2f<sp/>MB)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5801"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>snapshot_loaded<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;saving<sp/>snapshot<sp/>chainstate&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;flushing<sp/>coins<sp/>cache&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5802"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_cache.<ref refid="class_c_coins_view_cache_1afcc22204abc15aeefd5d1f7396e909a4" kindref="member">DynamicMemoryUsage</ref>()<sp/>/<sp/>(1000<sp/>*<sp/>1000)),</highlight></codeline>
<codeline lineno="5803"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395ab1d5eac4b1dca480c8056eaea7663b7a" kindref="member">BCLog::LogFlags::ALL</ref>);</highlight></codeline>
<codeline lineno="5804"><highlight class="normal"></highlight></codeline>
<codeline lineno="5805"><highlight class="normal"><sp/><sp/><sp/><sp/>coins_cache.<ref refid="class_c_coins_view_cache_1a166e3b1951caaaf582e7b67c5be762ce" kindref="member">Flush</ref>();</highlight></codeline>
<codeline lineno="5806"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5807"><highlight class="normal"></highlight></codeline>
<codeline lineno="5808" refid="struct_stop_hashing_exception" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal"><ref refid="struct_stop_hashing_exception" kindref="compound">StopHashingException</ref><sp/>:<sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/>std::exception</highlight></codeline>
<codeline lineno="5809"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5810"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*<sp/><ref refid="struct_stop_hashing_exception_1abf843cbb29dec939d0731e491bab6f70" kindref="member">what</ref>()<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">noexcept</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">override</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5811"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="5812"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;ComputeUTXOStats<sp/>interrupted.&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5813"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5814"><highlight class="normal">};</highlight></codeline>
<codeline lineno="5815"><highlight class="normal"></highlight></codeline>
<codeline lineno="5816"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>SnapshotUTXOHashBreakpoint(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classutil_1_1_signal_interrupt" kindref="compound">util::SignalInterrupt</ref>&amp;<sp/>interrupt)</highlight></codeline>
<codeline lineno="5817"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5818"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(interrupt)<sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/><ref refid="struct_stop_hashing_exception" kindref="compound">StopHashingException</ref>();</highlight></codeline>
<codeline lineno="5819"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5820"><highlight class="normal"></highlight></codeline>
<codeline lineno="5821"><highlight class="normal"><ref refid="classutil_1_1_result" kindref="compound">util::Result&lt;void&gt;</ref><sp/>ChainstateManager::PopulateAndValidateSnapshot(</highlight></codeline>
<codeline lineno="5822"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate" kindref="compound">Chainstate</ref>&amp;<sp/>snapshot_chainstate,</highlight></codeline>
<codeline lineno="5823"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_auto_file" kindref="compound">AutoFile</ref>&amp;<sp/>coins_file,</highlight></codeline>
<codeline lineno="5824"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classnode_1_1_snapshot_metadata" kindref="compound">SnapshotMetadata</ref>&amp;<sp/>metadata)</highlight></codeline>
<codeline lineno="5825"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5826"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>It&apos;s<sp/>okay<sp/>to<sp/>release<sp/>cs_main<sp/>before<sp/>we&apos;re<sp/>done<sp/>using<sp/>`coins_cache`<sp/>because<sp/>we<sp/>know</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5827"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>that<sp/>nothing<sp/>else<sp/>will<sp/>be<sp/>referencing<sp/>the<sp/>newly<sp/>created<sp/>snapshot_chainstate<sp/>yet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5828"><highlight class="normal"><sp/><sp/><sp/><sp/>CCoinsViewCache&amp;<sp/>coins_cache<sp/>=<sp/>*<ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>,<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>&amp;snapshot_chainstate.<ref refid="class_chainstate_1a9dce5b2ccab7cbd5ea485e13491bcdef" kindref="member">CoinsTip</ref>());</highlight></codeline>
<codeline lineno="5829"><highlight class="normal"></highlight></codeline>
<codeline lineno="5830"><highlight class="normal"><sp/><sp/><sp/><sp/>uint256<sp/>base_blockhash<sp/>=<sp/>metadata.<ref refid="classnode_1_1_snapshot_metadata_1a98d7b7da08325ede72f0f80886dc079d" kindref="member">m_base_blockhash</ref>;</highlight></codeline>
<codeline lineno="5831"><highlight class="normal"></highlight></codeline>
<codeline lineno="5832"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>snapshot_start_block<sp/>=<sp/><ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>,<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.LookupBlockIndex(base_blockhash));</highlight></codeline>
<codeline lineno="5833"><highlight class="normal"></highlight></codeline>
<codeline lineno="5834"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!snapshot_start_block)<sp/>{</highlight></codeline>
<codeline lineno="5835"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Needed<sp/>for<sp/>ComputeUTXOStats<sp/>to<sp/>determine<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5836"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>height<sp/>and<sp/>to<sp/>avoid<sp/>a<sp/>crash<sp/>when<sp/>base_blockhash.IsNull()</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5837"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(<ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;Did<sp/>not<sp/>find<sp/>snapshot<sp/>start<sp/>blockheader<sp/>%s&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5838"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>base_blockhash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>()))};</highlight></codeline>
<codeline lineno="5839"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5840"><highlight class="normal"></highlight></codeline>
<codeline lineno="5841"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>base_height<sp/>=<sp/>snapshot_start_block-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>;</highlight></codeline>
<codeline lineno="5842"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>maybe_au_data<sp/>=<sp/><ref refid="class_chainstate_manager_1a9fc4893dda46aba09dbcd01e3387ca6f" kindref="member">GetParams</ref>().<ref refid="class_c_chain_params_1a4f26e4cd31ad70a9563dcd567e6ea858" kindref="member">AssumeutxoForHeight</ref>(base_height);</highlight></codeline>
<codeline lineno="5843"><highlight class="normal"></highlight></codeline>
<codeline lineno="5844"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!maybe_au_data)<sp/>{</highlight></codeline>
<codeline lineno="5845"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(<ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;Assumeutxo<sp/>height<sp/>in<sp/>snapshot<sp/>metadata<sp/>not<sp/>recognized<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5846"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;(%d)<sp/>-<sp/>refusing<sp/>to<sp/>load<sp/>snapshot&quot;</highlight><highlight class="normal">,<sp/>base_height))};</highlight></codeline>
<codeline lineno="5847"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5848"><highlight class="normal"></highlight></codeline>
<codeline lineno="5849"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>AssumeutxoData&amp;<sp/>au_data<sp/>=<sp/>*maybe_au_data;</highlight></codeline>
<codeline lineno="5850"><highlight class="normal"></highlight></codeline>
<codeline lineno="5851"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>work<sp/>comparison<sp/>is<sp/>a<sp/>duplicate<sp/>check<sp/>with<sp/>the<sp/>one<sp/>performed<sp/>later<sp/>in</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5852"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ActivateSnapshot(),<sp/>but<sp/>is<sp/>done<sp/>so<sp/>that<sp/>we<sp/>avoid<sp/>doing<sp/>the<sp/>long<sp/>work<sp/>of<sp/>staging</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5853"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>a<sp/>snapshot<sp/>that<sp/>isn&apos;t<sp/>actually<sp/>usable.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5854"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>,<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>!CBlockIndexWorkComparator()(<ref refid="class_chainstate_manager_1ac8dc81d17ce18093b02ef600686870b3" kindref="member">ActiveTip</ref>(),<sp/>snapshot_start_block)))<sp/>{</highlight></codeline>
<codeline lineno="5855"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(</highlight><highlight class="stringliteral">&quot;Work<sp/>does<sp/>not<sp/>exceed<sp/>active<sp/>chainstate&quot;</highlight><highlight class="normal">)};</highlight></codeline>
<codeline lineno="5856"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5857"><highlight class="normal"></highlight></codeline>
<codeline lineno="5858"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>coins_count<sp/>=<sp/>metadata.<ref refid="classnode_1_1_snapshot_metadata_1a58b0a02ee902f2e9e83b2d01273703ff" kindref="member">m_coins_count</ref>;</highlight></codeline>
<codeline lineno="5859"><highlight class="normal"><sp/><sp/><sp/><sp/>uint64_t<sp/>coins_left<sp/>=<sp/>metadata.<ref refid="classnode_1_1_snapshot_metadata_1a58b0a02ee902f2e9e83b2d01273703ff" kindref="member">m_coins_count</ref>;</highlight></codeline>
<codeline lineno="5860"><highlight class="normal"></highlight></codeline>
<codeline lineno="5861"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>loading<sp/>%d<sp/>coins<sp/>from<sp/>snapshot<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>coins_left,<sp/>base_blockhash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="5862"><highlight class="normal"><sp/><sp/><sp/><sp/>int64_t<sp/>coins_processed{0};</highlight></codeline>
<codeline lineno="5863"><highlight class="normal"></highlight></codeline>
<codeline lineno="5864"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(coins_left<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="5865"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5866"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="transaction__identifier_8h_1ac4bb3c35b94889843d632be4de4b223c" kindref="member">Txid</ref><sp/>txid;</highlight></codeline>
<codeline lineno="5867"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_file<sp/>&gt;&gt;<sp/>txid;</highlight></codeline>
<codeline lineno="5868"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>coins_per_txid{0};</highlight></codeline>
<codeline lineno="5869"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_per_txid<sp/>=<sp/><ref refid="serialize_8h_1ab15e364a15e46bdbda4c90ee341d2129" kindref="member">ReadCompactSize</ref>(coins_file);</highlight></codeline>
<codeline lineno="5870"><highlight class="normal"></highlight></codeline>
<codeline lineno="5871"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(coins_per_txid<sp/>&gt;<sp/>coins_left)<sp/>{</highlight></codeline>
<codeline lineno="5872"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(</highlight><highlight class="stringliteral">&quot;Mismatch<sp/>in<sp/>coins<sp/>count<sp/>in<sp/>snapshot<sp/>metadata<sp/>and<sp/>actual<sp/>snapshot<sp/>data&quot;</highlight><highlight class="normal">)};</highlight></codeline>
<codeline lineno="5873"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5874"><highlight class="normal"></highlight></codeline>
<codeline lineno="5875"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>coins_per_txid;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="5876"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>COutPoint<sp/>outpoint;</highlight></codeline>
<codeline lineno="5877"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Coin<sp/>coin;</highlight></codeline>
<codeline lineno="5878"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>outpoint.<ref refid="class_c_out_point_1a3d8a9527a2ee4a7ebf59175650142e75" kindref="member">n</ref><sp/>=<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="normal">uint32_t</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(<ref refid="serialize_8h_1ab15e364a15e46bdbda4c90ee341d2129" kindref="member">ReadCompactSize</ref>(coins_file));</highlight></codeline>
<codeline lineno="5879"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>outpoint.<ref refid="class_c_out_point_1a021232319a9e2a4d04c8c9a95e66c96f" kindref="member">hash</ref><sp/>=<sp/>txid;</highlight></codeline>
<codeline lineno="5880"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_file<sp/>&gt;&gt;<sp/>coin;</highlight></codeline>
<codeline lineno="5881"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(coin.<ref refid="class_coin_1a83c6e5c63b15b7acaec51e3bb857fe16" kindref="member">nHeight</ref><sp/>&gt;<sp/>base_height<sp/>||</highlight></codeline>
<codeline lineno="5882"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>outpoint.<ref refid="class_c_out_point_1a3d8a9527a2ee4a7ebf59175650142e75" kindref="member">n</ref><sp/>&gt;=<sp/>std::numeric_limits&lt;</highlight><highlight class="keyword">decltype</highlight><highlight class="normal">(outpoint.<ref refid="class_c_out_point_1a3d8a9527a2ee4a7ebf59175650142e75" kindref="member">n</ref>)&gt;::max()<sp/></highlight><highlight class="comment">//<sp/>Avoid<sp/>integer<sp/>wrap-around<sp/>in<sp/>coinstats.cpp:ApplyHash</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5883"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)<sp/>{</highlight></codeline>
<codeline lineno="5884"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(<ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;Bad<sp/>snapshot<sp/>data<sp/>after<sp/>deserializing<sp/>%d<sp/>coins&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5885"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_count<sp/>-<sp/>coins_left))};</highlight></codeline>
<codeline lineno="5886"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5887"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="amount_8h_1a12db56a9a1c931941f0943ecbb278aae" kindref="member">MoneyRange</ref>(coin.<ref refid="class_coin_1adafe93fbab174bb8f09c8a3b9df178fa" kindref="member">out</ref>.<ref refid="class_c_tx_out_1a2565a2ff256ecf0a445d0fc53180fe07" kindref="member">nValue</ref>))<sp/>{</highlight></codeline>
<codeline lineno="5888"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(<ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;Bad<sp/>snapshot<sp/>data<sp/>after<sp/>deserializing<sp/>%d<sp/>coins<sp/>-<sp/>bad<sp/>tx<sp/>out<sp/>value&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5889"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_count<sp/>-<sp/>coins_left))};</highlight></codeline>
<codeline lineno="5890"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5891"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_cache.<ref refid="class_c_coins_view_cache_1afc256d69d7ad6be668f44626db665929" kindref="member">EmplaceCoinInternalDANGER</ref>(std::move(outpoint),<sp/>std::move(coin));</highlight></codeline>
<codeline lineno="5892"><highlight class="normal"></highlight></codeline>
<codeline lineno="5893"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--coins_left;</highlight></codeline>
<codeline lineno="5894"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++coins_processed;</highlight></codeline>
<codeline lineno="5895"><highlight class="normal"></highlight></codeline>
<codeline lineno="5896"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(coins_processed<sp/>%<sp/>1000000<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="5897"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>%d<sp/>coins<sp/>loaded<sp/>(%.2f%%,<sp/>%.2f<sp/>MB)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5898"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_processed,</highlight></codeline>
<codeline lineno="5899"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">float</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(coins_processed)<sp/>*<sp/>100<sp/>/<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">float</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(coins_count),</highlight></codeline>
<codeline lineno="5900"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_cache.<ref refid="class_c_coins_view_cache_1afcc22204abc15aeefd5d1f7396e909a4" kindref="member">DynamicMemoryUsage</ref>()<sp/>/<sp/>(1000<sp/>*<sp/>1000));</highlight></codeline>
<codeline lineno="5901"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5902"><highlight class="normal"></highlight></codeline>
<codeline lineno="5903"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Batch<sp/>write<sp/>and<sp/>flush<sp/>(if<sp/>we<sp/>need<sp/>to)<sp/>every<sp/>so<sp/>often.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5904"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5905"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>our<sp/>average<sp/>Coin<sp/>size<sp/>is<sp/>roughly<sp/>41<sp/>bytes,<sp/>checking<sp/>every<sp/>120,000<sp/>coins</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5906"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>means<sp/>&lt;5MB<sp/>of<sp/>memory<sp/>imprecision.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5907"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(coins_processed<sp/>%<sp/>120000<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="5908"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_manager_1a2163d8ef789c585b196a3ec7f468244b" kindref="member">m_interrupt</ref>)<sp/>{</highlight></codeline>
<codeline lineno="5909"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(</highlight><highlight class="stringliteral">&quot;Aborting<sp/>after<sp/>an<sp/>interrupt<sp/>was<sp/>requested&quot;</highlight><highlight class="normal">)};</highlight></codeline>
<codeline lineno="5910"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5911"><highlight class="normal"></highlight></codeline>
<codeline lineno="5912"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>snapshot_cache_state<sp/>=<sp/><ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>,</highlight></codeline>
<codeline lineno="5913"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>snapshot_chainstate.GetCoinsCacheSizeState());</highlight></codeline>
<codeline lineno="5914"><highlight class="normal"></highlight></codeline>
<codeline lineno="5915"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(snapshot_cache_state<sp/>&gt;=<sp/><ref refid="validation_8h_1ab8482b5889c2dd7bcef2c3a0523d3defa99cd1c61610c76a57cb8d10d6df6b870" kindref="member">CoinsCacheSizeState::CRITICAL</ref>)<sp/>{</highlight></codeline>
<codeline lineno="5916"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>is<sp/>a<sp/>hack<sp/>-<sp/>we<sp/>don&apos;t<sp/>know<sp/>what<sp/>the<sp/>actual<sp/>best<sp/>block<sp/>is,<sp/>but<sp/>that</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5917"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>doesn&apos;t<sp/>matter<sp/>for<sp/>the<sp/>purposes<sp/>of<sp/>flushing<sp/>the<sp/>cache<sp/>here.<sp/>We&apos;ll<sp/>set<sp/>this</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5918"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>its<sp/>correct<sp/>value<sp/>(`base_blockhash`)<sp/>below<sp/>after<sp/>the<sp/>coins<sp/>are<sp/>loaded.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5919"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_cache.<ref refid="class_c_coins_view_cache_1ae3eca32d352e35141dee0a90d5d29b09" kindref="member">SetBestBlock</ref>(<ref refid="random_8h_1a88672f91432a247654f2c06298dd58ee" kindref="member">GetRandHash</ref>());</highlight></codeline>
<codeline lineno="5920"><highlight class="normal"></highlight></codeline>
<codeline lineno="5921"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>No<sp/>need<sp/>to<sp/>acquire<sp/>cs_main<sp/>since<sp/>this<sp/>chainstate<sp/>isn&apos;t<sp/>being<sp/>used<sp/>yet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5922"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>FlushSnapshotToDisk(coins_cache,<sp/></highlight><highlight class="comment">/*snapshot_loaded=*/</highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="5923"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5924"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5925"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5926"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::ios_base::failure&amp;)<sp/>{</highlight></codeline>
<codeline lineno="5927"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(<ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;Bad<sp/>snapshot<sp/>format<sp/>or<sp/>truncated<sp/>snapshot<sp/>after<sp/>deserializing<sp/>%d<sp/>coins&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5928"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_processed))};</highlight></codeline>
<codeline lineno="5929"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5930"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5931"><highlight class="normal"></highlight></codeline>
<codeline lineno="5932"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Important<sp/>that<sp/>we<sp/>set<sp/>this.<sp/>This<sp/>and<sp/>the<sp/>coins_cache<sp/>accesses<sp/>above<sp/>are</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5933"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>sort<sp/>of<sp/>a<sp/>layer<sp/>violation,<sp/>but<sp/>either<sp/>we<sp/>reach<sp/>into<sp/>the<sp/>innards<sp/>of</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5934"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>CCoinsViewCache<sp/>here<sp/>or<sp/>we<sp/>have<sp/>to<sp/>invert<sp/>some<sp/>of<sp/>the<sp/>Chainstate<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5935"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>embed<sp/>them<sp/>in<sp/>a<sp/>snapshot-activation-specific<sp/>CCoinsViewCache<sp/>bulk<sp/>load</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5936"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>method.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5937"><highlight class="normal"><sp/><sp/><sp/><sp/>coins_cache.<ref refid="class_c_coins_view_cache_1ae3eca32d352e35141dee0a90d5d29b09" kindref="member">SetBestBlock</ref>(base_blockhash);</highlight></codeline>
<codeline lineno="5938"><highlight class="normal"></highlight></codeline>
<codeline lineno="5939"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>out_of_coins{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="5940"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5941"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::byte<sp/>left_over_byte;</highlight></codeline>
<codeline lineno="5942"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_file<sp/>&gt;&gt;<sp/>left_over_byte;</highlight></codeline>
<codeline lineno="5943"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::ios_base::failure&amp;)<sp/>{</highlight></codeline>
<codeline lineno="5944"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>expect<sp/>an<sp/>exception<sp/>since<sp/>we<sp/>should<sp/>be<sp/>out<sp/>of<sp/>coins.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5945"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>out_of_coins<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5946"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5947"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!out_of_coins)<sp/>{</highlight></codeline>
<codeline lineno="5948"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(<ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;Bad<sp/>snapshot<sp/>-<sp/>coins<sp/>left<sp/>over<sp/>after<sp/>deserializing<sp/>%d<sp/>coins&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5949"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_count))};</highlight></codeline>
<codeline lineno="5950"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5951"><highlight class="normal"></highlight></codeline>
<codeline lineno="5952"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>loaded<sp/>%d<sp/>(%.2f<sp/>MB)<sp/>coins<sp/>from<sp/>snapshot<sp/>%s&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5953"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_count,</highlight></codeline>
<codeline lineno="5954"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_cache.<ref refid="class_c_coins_view_cache_1afcc22204abc15aeefd5d1f7396e909a4" kindref="member">DynamicMemoryUsage</ref>()<sp/>/<sp/>(1000<sp/>*<sp/>1000),</highlight></codeline>
<codeline lineno="5955"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>base_blockhash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="5956"><highlight class="normal"></highlight></codeline>
<codeline lineno="5957"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>No<sp/>need<sp/>to<sp/>acquire<sp/>cs_main<sp/>since<sp/>this<sp/>chainstate<sp/>isn&apos;t<sp/>being<sp/>used<sp/>yet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5958"><highlight class="normal"><sp/><sp/><sp/><sp/>FlushSnapshotToDisk(coins_cache,<sp/></highlight><highlight class="comment">/*snapshot_loaded=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="5959"><highlight class="normal"></highlight></codeline>
<codeline lineno="5960"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(coins_cache.<ref refid="class_c_coins_view_cache_1a357197e89d0c22e33f9e58b3dac685ff" kindref="member">GetBestBlock</ref>()<sp/>==<sp/>base_blockhash);</highlight></codeline>
<codeline lineno="5961"><highlight class="normal"></highlight></codeline>
<codeline lineno="5962"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>As<sp/>above,<sp/>okay<sp/>to<sp/>immediately<sp/>release<sp/>cs_main<sp/>here<sp/>since<sp/>no<sp/>other<sp/>context<sp/>knows</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5963"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>about<sp/>the<sp/>snapshot_chainstate.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5964"><highlight class="normal"><sp/><sp/><sp/><sp/>CCoinsViewDB*<sp/>snapshot_coinsdb<sp/>=<sp/><ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>,<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>&amp;snapshot_chainstate.<ref refid="class_chainstate_1ad876ac510821396146002e921946e008" kindref="member">CoinsDB</ref>());</highlight></codeline>
<codeline lineno="5965"><highlight class="normal"></highlight></codeline>
<codeline lineno="5966"><highlight class="normal"><sp/><sp/><sp/><sp/>std::optional&lt;CCoinsStats&gt;<sp/>maybe_stats;</highlight></codeline>
<codeline lineno="5967"><highlight class="normal"></highlight></codeline>
<codeline lineno="5968"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5969"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>maybe_stats<sp/>=<sp/><ref refid="namespacekernel_1a1a4d18de82a65d8b85f694d369620c37" kindref="member">ComputeUTXOStats</ref>(</highlight></codeline>
<codeline lineno="5970"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacekernel_1a77fe3880fe4048d786e97a070552eca7a1fadef12e295ca4f0bff27a290d4b7e2" kindref="member">CoinStatsHashType::HASH_SERIALIZED</ref>,<sp/>snapshot_coinsdb,<sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>,<sp/>[&amp;interrupt<sp/>=<sp/><ref refid="class_chainstate_manager_1a2163d8ef789c585b196a3ec7f468244b" kindref="member">m_interrupt</ref>]<sp/>{<sp/>SnapshotUTXOHashBreakpoint(interrupt);<sp/>});</highlight></codeline>
<codeline lineno="5971"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(StopHashingException<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal">&amp;)<sp/>{</highlight></codeline>
<codeline lineno="5972"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(</highlight><highlight class="stringliteral">&quot;Aborting<sp/>after<sp/>an<sp/>interrupt<sp/>was<sp/>requested&quot;</highlight><highlight class="normal">)};</highlight></codeline>
<codeline lineno="5973"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5974"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!maybe_stats.has_value())<sp/>{</highlight></codeline>
<codeline lineno="5975"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>generate<sp/>coins<sp/>stats&quot;</highlight><highlight class="normal">)};</highlight></codeline>
<codeline lineno="5976"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5977"><highlight class="normal"></highlight></codeline>
<codeline lineno="5978"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Assert<sp/>that<sp/>the<sp/>deserialized<sp/>chainstate<sp/>contents<sp/>match<sp/>the<sp/>expected<sp/>assumeutxo<sp/>value.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5979"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(AssumeutxoHash{maybe_stats-&gt;hashSerialized}<sp/>!=<sp/>au_data.<ref refid="struct_assumeutxo_data_1acf6a6ada954e4b5ec29b766fdb1b0ca2" kindref="member">hash_serialized</ref>)<sp/>{</highlight></codeline>
<codeline lineno="5980"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(<ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;Bad<sp/>snapshot<sp/>content<sp/>hash:<sp/>expected<sp/>%s,<sp/>got<sp/>%s&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5981"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>au_data.<ref refid="struct_assumeutxo_data_1acf6a6ada954e4b5ec29b766fdb1b0ca2" kindref="member">hash_serialized</ref>.<ref refid="class_base_hash_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>(),<sp/>maybe_stats-&gt;hashSerialized.ToString()))};</highlight></codeline>
<codeline lineno="5982"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5983"><highlight class="normal"></highlight></codeline>
<codeline lineno="5984"><highlight class="normal"><sp/><sp/><sp/><sp/>snapshot_chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a9180d6da00dc108a0689388f53542498" kindref="member">SetTip</ref>(*snapshot_start_block);</highlight></codeline>
<codeline lineno="5985"><highlight class="normal"></highlight></codeline>
<codeline lineno="5986"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>remainder<sp/>of<sp/>this<sp/>function<sp/>requires<sp/>modifying<sp/>data<sp/>protected<sp/>by<sp/>cs_main.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5987"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="5988"><highlight class="normal"></highlight></codeline>
<codeline lineno="5989"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Fake<sp/>various<sp/>pieces<sp/>of<sp/>CBlockIndex<sp/>state:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5990"><highlight class="normal"><sp/><sp/><sp/><sp/>CBlockIndex*<sp/>index<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5991"><highlight class="normal"></highlight></codeline>
<codeline lineno="5992"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Don&apos;t<sp/>make<sp/>any<sp/>modifications<sp/>to<sp/>the<sp/>genesis<sp/>block<sp/>since<sp/>it<sp/>shouldn&apos;t<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5993"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>necessary,<sp/>and<sp/>since<sp/>the<sp/>genesis<sp/>block<sp/>doesn&apos;t<sp/>have<sp/>normal<sp/>flags<sp/>like</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5994"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>BLOCK_VALID_SCRIPTS<sp/>set.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5995"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>AFTER_GENESIS_START{1};</highlight></codeline>
<codeline lineno="5996"><highlight class="normal"></highlight></codeline>
<codeline lineno="5997"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>AFTER_GENESIS_START;<sp/>i<sp/>&lt;=<sp/>snapshot_chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>();<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="5998"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>index<sp/>=<sp/>snapshot_chainstate.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>[i];</highlight></codeline>
<codeline lineno="5999"><highlight class="normal"></highlight></codeline>
<codeline lineno="6000"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Fake<sp/>BLOCK_OPT_WITNESS<sp/>so<sp/>that<sp/>Chainstate::NeedsRedownload()</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6001"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>won&apos;t<sp/>ask<sp/>for<sp/>-reindex<sp/>on<sp/>startup.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6002"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="validation_8h_1ac799f78d8f44b330f7990a7eeb3071d2" kindref="member">DeploymentActiveAt</ref>(*index,<sp/>*</highlight><highlight class="keyword">this</highlight><highlight class="normal">,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dbac12a10e827db62556122f2b1a9b0431b" kindref="member">Consensus::DEPLOYMENT_SEGWIT</ref>))<sp/>{</highlight></codeline>
<codeline lineno="6003"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>index-&gt;nStatus<sp/>|=<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93adabb5ecf540d50ee9d9f1846609d59caf5" kindref="member">BLOCK_OPT_WITNESS</ref>;</highlight></codeline>
<codeline lineno="6004"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6005"><highlight class="normal"></highlight></codeline>
<codeline lineno="6006"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_dirty_blockindex.insert(index);</highlight></codeline>
<codeline lineno="6007"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Changes<sp/>to<sp/>the<sp/>block<sp/>index<sp/>will<sp/>be<sp/>flushed<sp/>to<sp/>disk<sp/>after<sp/>this<sp/>call</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6008"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>returns<sp/>in<sp/>`ActivateSnapshot()`,<sp/>when<sp/>`MaybeRebalanceCaches()`<sp/>is</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6009"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>called,<sp/>since<sp/>we&apos;ve<sp/>added<sp/>a<sp/>snapshot<sp/>chainstate<sp/>and<sp/>therefore<sp/>will</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6010"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>have<sp/>to<sp/>downsize<sp/>the<sp/>IBD<sp/>chainstate,<sp/>which<sp/>will<sp/>result<sp/>in<sp/>a<sp/>call<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6011"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>`FlushStateToDisk(ALWAYS)`.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6012"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6013"><highlight class="normal"></highlight></codeline>
<codeline lineno="6014"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(index);</highlight></codeline>
<codeline lineno="6015"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(index<sp/>==<sp/>snapshot_start_block);</highlight></codeline>
<codeline lineno="6016"><highlight class="normal"><sp/><sp/><sp/><sp/>index-&gt;<ref refid="class_c_block_index_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref><sp/>=<sp/>au_data.<ref refid="struct_assumeutxo_data_1adcda5b09f2e40d0ed8404453701a6ed4" kindref="member">m_chain_tx_count</ref>;</highlight></codeline>
<codeline lineno="6017"><highlight class="normal"><sp/><sp/><sp/><sp/>snapshot_chainstate.<ref refid="class_chainstate_1ab431e79e9a33a0a82cc611f3f8684917" kindref="member">setBlockIndexCandidates</ref>.insert(snapshot_start_block);</highlight></codeline>
<codeline lineno="6018"><highlight class="normal"></highlight></codeline>
<codeline lineno="6019"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>validated<sp/>snapshot<sp/>(%.2f<sp/>MB)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="6020"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>coins_cache.<ref refid="class_c_coins_view_cache_1afcc22204abc15aeefd5d1f7396e909a4" kindref="member">DynamicMemoryUsage</ref>()<sp/>/<sp/>(1000<sp/>*<sp/>1000));</highlight></codeline>
<codeline lineno="6021"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{};</highlight></codeline>
<codeline lineno="6022"><highlight class="normal">}</highlight></codeline>
<codeline lineno="6023"><highlight class="normal"></highlight></codeline>
<codeline lineno="6024"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Currently,<sp/>this<sp/>function<sp/>holds<sp/>cs_main<sp/>for<sp/>its<sp/>duration,<sp/>which<sp/>could<sp/>be<sp/>for</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6025"><highlight class="normal"></highlight><highlight class="comment">//<sp/>multiple<sp/>minutes<sp/>due<sp/>to<sp/>the<sp/>ComputeUTXOStats<sp/>call.<sp/>Holding<sp/>cs_main<sp/>used<sp/>to<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6026"><highlight class="normal"></highlight><highlight class="comment">//<sp/>necessary<sp/>(before<sp/>d43a1f1a2fa3)<sp/>to<sp/>avoid<sp/>advancing<sp/>validated_cs<sp/>farther<sp/>than</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6027"><highlight class="normal"></highlight><highlight class="comment">//<sp/>its<sp/>target<sp/>block.<sp/>Now<sp/>it<sp/>should<sp/>be<sp/>possible<sp/>to<sp/>avoid<sp/>this,<sp/>but<sp/>simply</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6028"><highlight class="normal"></highlight><highlight class="comment">//<sp/>releasing<sp/>cs_main<sp/>here<sp/>would<sp/>not<sp/>be<sp/>possible<sp/>because<sp/>this<sp/>function<sp/>is<sp/>invoked</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6029"><highlight class="normal"></highlight><highlight class="comment">//<sp/>by<sp/>ConnectTip<sp/>within<sp/>ActivateBestChain.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6030"><highlight class="normal"></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6031"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Eventually<sp/>(TODO)<sp/>it<sp/>would<sp/>be<sp/>better<sp/>to<sp/>call<sp/>this<sp/>function<sp/>outside<sp/>of</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6032"><highlight class="normal"></highlight><highlight class="comment">//<sp/>ActivateBestChain,<sp/>on<sp/>a<sp/>separate<sp/>thread<sp/>that<sp/>should<sp/>not<sp/>require<sp/>cs_main<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6033"><highlight class="normal"></highlight><highlight class="comment">//<sp/>hash,<sp/>because<sp/>the<sp/>UTXO<sp/>set<sp/>is<sp/>only<sp/>hashed<sp/>after<sp/>the<sp/>historical<sp/>chainstate</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6034"><highlight class="normal"></highlight><highlight class="comment">//<sp/>reaches<sp/>its<sp/>target<sp/>block<sp/>and<sp/>is<sp/>no<sp/>longer<sp/>changing.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6035"><highlight class="normal"><ref refid="validation_8h_1a64ee3ac35f0e5525364652f27fc0570e" kindref="member">SnapshotCompletionResult</ref><sp/>ChainstateManager::MaybeValidateSnapshot(<ref refid="class_chainstate" kindref="compound">Chainstate</ref>&amp;<sp/>validated_cs,<sp/><ref refid="class_chainstate" kindref="compound">Chainstate</ref>&amp;<sp/>unvalidated_cs)</highlight></codeline>
<codeline lineno="6036"><highlight class="normal">{</highlight></codeline>
<codeline lineno="6037"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="6038"><highlight class="normal"></highlight></codeline>
<codeline lineno="6039"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>snapshot<sp/>does<sp/>not<sp/>need<sp/>to<sp/>be<sp/>validated...</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6040"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(unvalidated_cs.m_assumeutxo<sp/>!=<sp/><ref refid="validation_8h_1a6b7ed8f1aa31880e0db11fd5d379152daa7e559db9fd6ffeed9432ba2987a830d" kindref="member">Assumeutxo::UNVALIDATED</ref><sp/>||</highlight></codeline>
<codeline lineno="6041"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Or<sp/>if<sp/>either<sp/>chainstate<sp/>is<sp/>unusable...</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6042"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!unvalidated_cs.<ref refid="class_chainstate_1a37f0e70024a7d2d694ae27d34609de0e" kindref="member">m_from_snapshot_blockhash</ref><sp/>||</highlight></codeline>
<codeline lineno="6043"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>validated_cs.m_assumeutxo<sp/>!=<sp/><ref refid="validation_8h_1a6b7ed8f1aa31880e0db11fd5d379152da4d6154fe02ac9bf42fd2aacfa49310b0" kindref="member">Assumeutxo::VALIDATED</ref><sp/>||</highlight></codeline>
<codeline lineno="6044"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!validated_cs.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>()<sp/>||</highlight></codeline>
<codeline lineno="6045"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Or<sp/>the<sp/>validated<sp/>chainstate<sp/>is<sp/>not<sp/>targeting<sp/>the<sp/>snapshot<sp/>block...</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6046"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!validated_cs.m_target_blockhash<sp/>||</highlight></codeline>
<codeline lineno="6047"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*validated_cs.m_target_blockhash<sp/>!=<sp/>*unvalidated_cs.<ref refid="class_chainstate_1a37f0e70024a7d2d694ae27d34609de0e" kindref="member">m_from_snapshot_blockhash</ref><sp/>||</highlight></codeline>
<codeline lineno="6048"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Or<sp/>the<sp/>validated<sp/>chainstate<sp/>has<sp/>not<sp/>reached<sp/>the<sp/>snapshot<sp/>block<sp/>yet...</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6049"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!validated_cs.<ref refid="class_chainstate_1a13f930c315cbf69ccbac5e6187ea5150" kindref="member">ReachedTarget</ref>())<sp/>{</highlight></codeline>
<codeline lineno="6050"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Then<sp/>the<sp/>snapshot<sp/>cannot<sp/>be<sp/>validated<sp/>and<sp/>there<sp/>is<sp/>nothing<sp/>to<sp/>do.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6051"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a64ee3ac35f0e5525364652f27fc0570ea203ec08f57cb105eeb2b121ba6503b52" kindref="member">SnapshotCompletionResult::SKIPPED</ref>;</highlight></codeline>
<codeline lineno="6052"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6053"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(validated_cs.TargetBlock()<sp/>==<sp/>validated_cs.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>());</highlight></codeline>
<codeline lineno="6054"><highlight class="normal"></highlight></codeline>
<codeline lineno="6055"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>handle_invalid_snapshot<sp/>=<sp/>[&amp;]()<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>)<sp/>{</highlight></codeline>
<codeline lineno="6056"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bilingual_str<sp/>user_error<sp/>=<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(<ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight></codeline>
<codeline lineno="6057"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;%s<sp/>failed<sp/>to<sp/>validate<sp/>the<sp/>-assumeutxo<sp/>snapshot<sp/>state.<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6058"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;This<sp/>indicates<sp/>a<sp/>hardware<sp/>problem,<sp/>or<sp/>a<sp/>bug<sp/>in<sp/>the<sp/>software,<sp/>or<sp/>a<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6059"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;bad<sp/>software<sp/>modification<sp/>that<sp/>allowed<sp/>an<sp/>invalid<sp/>snapshot<sp/>to<sp/>be<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6060"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;loaded.<sp/>As<sp/>a<sp/>result<sp/>of<sp/>this,<sp/>the<sp/>node<sp/>will<sp/>shut<sp/>down<sp/>and<sp/>stop<sp/>using<sp/>any<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6061"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;state<sp/>that<sp/>was<sp/>built<sp/>on<sp/>the<sp/>snapshot,<sp/>resetting<sp/>the<sp/>chain<sp/>height<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6062"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;from<sp/>%d<sp/>to<sp/>%d.<sp/>On<sp/>the<sp/>next<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6063"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;restart,<sp/>the<sp/>node<sp/>will<sp/>resume<sp/>syncing<sp/>from<sp/>%d<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6064"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;without<sp/>using<sp/>any<sp/>snapshot<sp/>data.<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6065"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Please<sp/>report<sp/>this<sp/>incident<sp/>to<sp/>%s,<sp/>including<sp/>how<sp/>you<sp/>obtained<sp/>the<sp/>snapshot.<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6066"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;The<sp/>invalid<sp/>snapshot<sp/>chainstate<sp/>will<sp/>be<sp/>left<sp/>on<sp/>disk<sp/>in<sp/>case<sp/>it<sp/>is<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6067"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;helpful<sp/>in<sp/>diagnosing<sp/>the<sp/>issue<sp/>that<sp/>caused<sp/>this<sp/>error.&quot;</highlight><highlight class="normal">),</highlight></codeline>
<codeline lineno="6068"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CLIENT_NAME,<sp/>unvalidated_cs.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>(),</highlight></codeline>
<codeline lineno="6069"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>validated_cs.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>(),</highlight></codeline>
<codeline lineno="6070"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>validated_cs.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>(),<sp/>CLIENT_BUGREPORT);</highlight></codeline>
<codeline lineno="6071"><highlight class="normal"></highlight></codeline>
<codeline lineno="6072"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>!!!<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>user_error.<ref refid="structbilingual__str_1ab9617c9d0390836c14d40e0aa6e84ab3" kindref="member">original</ref>);</highlight></codeline>
<codeline lineno="6073"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>deleting<sp/>snapshot,<sp/>reverting<sp/>to<sp/>validated<sp/>chain,<sp/>and<sp/>stopping<sp/>node\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="6074"><highlight class="normal"></highlight></codeline>
<codeline lineno="6075"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Reset<sp/>chainstate<sp/>target<sp/>to<sp/>network<sp/>tip<sp/>instead<sp/>of<sp/>snapshot<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6076"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>validated_cs.SetTargetBlock(</highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="6077"><highlight class="normal"></highlight></codeline>
<codeline lineno="6078"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>unvalidated_cs.m_assumeutxo<sp/>=<sp/><ref refid="validation_8h_1a6b7ed8f1aa31880e0db11fd5d379152daccc0377a8afbf50e7094f5c23a8af223" kindref="member">Assumeutxo::INVALID</ref>;</highlight></codeline>
<codeline lineno="6079"><highlight class="normal"></highlight></codeline>
<codeline lineno="6080"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>rename_result<sp/>=<sp/>unvalidated_cs.InvalidateCoinsDBOnDisk();</highlight></codeline>
<codeline lineno="6081"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!rename_result)<sp/>{</highlight></codeline>
<codeline lineno="6082"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>user_error<sp/>+=<sp/><ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(</highlight><highlight class="stringliteral">&quot;\n&quot;</highlight><highlight class="normal">)<sp/>+<sp/><ref refid="namespaceutil_1adbcebd9741ba34de94c8384025e54825" kindref="member">util::ErrorString</ref>(rename_result);</highlight></codeline>
<codeline lineno="6083"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6084"><highlight class="normal"></highlight></codeline>
<codeline lineno="6085"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a30d910c43e6619c9596c077fd1e5518d" kindref="member">GetNotifications</ref>().<ref refid="classkernel_1_1_notifications_1a2998f041aae2f227bb4bba3d9cb7a292" kindref="member">fatalError</ref>(user_error);</highlight></codeline>
<codeline lineno="6086"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="6087"><highlight class="normal"></highlight></codeline>
<codeline lineno="6088"><highlight class="normal"><sp/><sp/><sp/><sp/>CCoinsViewDB&amp;<sp/>validated_coins_db<sp/>=<sp/>validated_cs.<ref refid="class_chainstate_1ad876ac510821396146002e921946e008" kindref="member">CoinsDB</ref>();</highlight></codeline>
<codeline lineno="6089"><highlight class="normal"><sp/><sp/><sp/><sp/>validated_cs.<ref refid="class_chainstate_1a7c77d9ae490826de80fea16e44c5e97f" kindref="member">ForceFlushStateToDisk</ref>();</highlight></codeline>
<codeline lineno="6090"><highlight class="normal"></highlight></codeline>
<codeline lineno="6091"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>maybe_au_data<sp/>=<sp/><ref refid="class_chainstate_manager_1a012c0463bd17a2be6045a0d62e8b0fd4" kindref="member">m_options</ref>.chainparams.AssumeutxoForHeight(validated_cs.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>());</highlight></codeline>
<codeline lineno="6092"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!maybe_au_data)<sp/>{</highlight></codeline>
<codeline lineno="6093"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>assumeutxo<sp/>data<sp/>not<sp/>found<sp/>for<sp/>height<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6094"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;(%d)<sp/>-<sp/>refusing<sp/>to<sp/>validate<sp/>snapshot&quot;</highlight><highlight class="normal">,<sp/>validated_cs.<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>());</highlight></codeline>
<codeline lineno="6095"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>handle_invalid_snapshot();</highlight></codeline>
<codeline lineno="6096"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a64ee3ac35f0e5525364652f27fc0570ea1c396fecf97f85e5a30f259d93759327" kindref="member">SnapshotCompletionResult::MISSING_CHAINPARAMS</ref>;</highlight></codeline>
<codeline lineno="6097"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6098"><highlight class="normal"></highlight></codeline>
<codeline lineno="6099"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>AssumeutxoData&amp;<sp/>au_data<sp/>=<sp/>*maybe_au_data;</highlight></codeline>
<codeline lineno="6100"><highlight class="normal"><sp/><sp/><sp/><sp/>std::optional&lt;CCoinsStats&gt;<sp/>validated_cs_stats;</highlight></codeline>
<codeline lineno="6101"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>computing<sp/>UTXO<sp/>stats<sp/>for<sp/>background<sp/>chainstate<sp/>to<sp/>validate<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6102"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;snapshot<sp/>-<sp/>this<sp/>could<sp/>take<sp/>a<sp/>few<sp/>minutes&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="6103"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="6104"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>validated_cs_stats<sp/>=<sp/><ref refid="namespacekernel_1a1a4d18de82a65d8b85f694d369620c37" kindref="member">ComputeUTXOStats</ref>(</highlight></codeline>
<codeline lineno="6105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacekernel_1a77fe3880fe4048d786e97a070552eca7a1fadef12e295ca4f0bff27a290d4b7e2" kindref="member">CoinStatsHashType::HASH_SERIALIZED</ref>,</highlight></codeline>
<codeline lineno="6106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;validated_coins_db,</highlight></codeline>
<codeline lineno="6107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>,</highlight></codeline>
<codeline lineno="6108"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[&amp;interrupt<sp/>=<sp/><ref refid="class_chainstate_manager_1a2163d8ef789c585b196a3ec7f468244b" kindref="member">m_interrupt</ref>]<sp/>{<sp/>SnapshotUTXOHashBreakpoint(interrupt);<sp/>});</highlight></codeline>
<codeline lineno="6109"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(StopHashingException<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal">&amp;)<sp/>{</highlight></codeline>
<codeline lineno="6110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a64ee3ac35f0e5525364652f27fc0570eadefcaed57306356967a486cb93215554" kindref="member">SnapshotCompletionResult::STATS_FAILED</ref>;</highlight></codeline>
<codeline lineno="6111"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6112"><highlight class="normal"></highlight></codeline>
<codeline lineno="6113"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>XXX<sp/>note<sp/>that<sp/>this<sp/>function<sp/>is<sp/>slow<sp/>and<sp/>will<sp/>hold<sp/>cs_main<sp/>for<sp/>potentially<sp/>minutes.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6114"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!validated_cs_stats)<sp/>{</highlight></codeline>
<codeline lineno="6115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>failed<sp/>to<sp/>generate<sp/>stats<sp/>for<sp/>validation<sp/>coins<sp/>db&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="6116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>While<sp/>this<sp/>isn&apos;t<sp/>a<sp/>problem<sp/>with<sp/>the<sp/>snapshot<sp/>per<sp/>se,<sp/>this<sp/>condition</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>prevents<sp/>us<sp/>from<sp/>validating<sp/>the<sp/>snapshot,<sp/>so<sp/>we<sp/>should<sp/>shut<sp/>down<sp/>and<sp/>let<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>user<sp/>handle<sp/>the<sp/>issue<sp/>manually.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>handle_invalid_snapshot();</highlight></codeline>
<codeline lineno="6120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a64ee3ac35f0e5525364652f27fc0570eadefcaed57306356967a486cb93215554" kindref="member">SnapshotCompletionResult::STATS_FAILED</ref>;</highlight></codeline>
<codeline lineno="6121"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6122"><highlight class="normal"></highlight></codeline>
<codeline lineno="6123"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Compare<sp/>the<sp/>validated<sp/>chainstate&apos;s<sp/>UTXO<sp/>set<sp/>hash<sp/>against<sp/>the<sp/>hard-coded</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6124"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>assumeutxo<sp/>hash<sp/>we<sp/>expect.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6125"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6126"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>TODO:<sp/>For<sp/>belt-and-suspenders,<sp/>we<sp/>could<sp/>cache<sp/>the<sp/>UTXO<sp/>set</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6127"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>hash<sp/>for<sp/>the<sp/>snapshot<sp/>when<sp/>it&apos;s<sp/>loaded<sp/>in<sp/>its<sp/>chainstate&apos;s<sp/>leveldb.<sp/>We<sp/>could<sp/>then</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6128"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>reference<sp/>that<sp/>here<sp/>for<sp/>an<sp/>additional<sp/>check.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6129"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(AssumeutxoHash{validated_cs_stats-&gt;hashSerialized}<sp/>!=<sp/>au_data.<ref refid="struct_assumeutxo_data_1acf6a6ada954e4b5ec29b766fdb1b0ca2" kindref="member">hash_serialized</ref>)<sp/>{</highlight></codeline>
<codeline lineno="6130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>hash<sp/>mismatch:<sp/>actual=%s,<sp/>expected=%s&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="6131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>validated_cs_stats-&gt;hashSerialized.ToString(),</highlight></codeline>
<codeline lineno="6132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>au_data.<ref refid="struct_assumeutxo_data_1acf6a6ada954e4b5ec29b766fdb1b0ca2" kindref="member">hash_serialized</ref>.<ref refid="class_base_hash_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="6133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>handle_invalid_snapshot();</highlight></codeline>
<codeline lineno="6134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a64ee3ac35f0e5525364652f27fc0570eac93ebf8fbedbcb375e9368dcfde5e59d" kindref="member">SnapshotCompletionResult::HASH_MISMATCH</ref>;</highlight></codeline>
<codeline lineno="6135"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6136"><highlight class="normal"></highlight></codeline>
<codeline lineno="6137"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>snapshot<sp/>beginning<sp/>at<sp/>%s<sp/>has<sp/>been<sp/>fully<sp/>validated&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="6138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>unvalidated_cs.<ref refid="class_chainstate_1a37f0e70024a7d2d694ae27d34609de0e" kindref="member">m_from_snapshot_blockhash</ref>-&gt;ToString());</highlight></codeline>
<codeline lineno="6139"><highlight class="normal"></highlight></codeline>
<codeline lineno="6140"><highlight class="normal"><sp/><sp/><sp/><sp/>unvalidated_cs.m_assumeutxo<sp/>=<sp/><ref refid="validation_8h_1a6b7ed8f1aa31880e0db11fd5d379152da4d6154fe02ac9bf42fd2aacfa49310b0" kindref="member">Assumeutxo::VALIDATED</ref>;</highlight></codeline>
<codeline lineno="6141"><highlight class="normal"><sp/><sp/><sp/><sp/>validated_cs.m_target_utxohash<sp/>=<sp/>AssumeutxoHash{validated_cs_stats-&gt;hashSerialized};</highlight></codeline>
<codeline lineno="6142"><highlight class="normal"><sp/><sp/><sp/><sp/>this-&gt;MaybeRebalanceCaches();</highlight></codeline>
<codeline lineno="6143"><highlight class="normal"></highlight></codeline>
<codeline lineno="6144"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="validation_8h_1a64ee3ac35f0e5525364652f27fc0570ead0749aaba8b833466dfcbb0428e4f89c" kindref="member">SnapshotCompletionResult::SUCCESS</ref>;</highlight></codeline>
<codeline lineno="6145"><highlight class="normal">}</highlight></codeline>
<codeline lineno="6146"><highlight class="normal"></highlight></codeline>
<codeline lineno="6147"><highlight class="normal"><ref refid="class_chainstate" kindref="compound">Chainstate</ref>&amp;<sp/><ref refid="class_chainstate_manager_1a0ed46908ea52e17d172f2fcc0ceb9964" kindref="member">ChainstateManager::ActiveChainstate</ref>()</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="6148"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="6149"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="6150"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager_1a8d39d359e6ed774815dc8d31f326ff82" kindref="member">CurrentChainstate</ref>();</highlight></codeline>
<codeline lineno="6151"><highlight class="normal">}</highlight></codeline>
<codeline lineno="6152"><highlight class="normal"></highlight></codeline>
<codeline lineno="6153"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ChainstateManager::MaybeRebalanceCaches()</highlight></codeline>
<codeline lineno="6154"><highlight class="normal">{</highlight></codeline>
<codeline lineno="6155"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="6156"><highlight class="normal"><sp/><sp/><sp/><sp/>Chainstate&amp;<sp/>current_cs{<ref refid="class_chainstate_manager_1a8d39d359e6ed774815dc8d31f326ff82" kindref="member">CurrentChainstate</ref>()};</highlight></codeline>
<codeline lineno="6157"><highlight class="normal"><sp/><sp/><sp/><sp/>Chainstate*<sp/>historical_cs{<ref refid="class_chainstate_manager_1a1140f6d8b807be5796827fc4f7be03d7" kindref="member">HistoricalChainstate</ref>()};</highlight></codeline>
<codeline lineno="6158"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!historical_cs<sp/>&amp;&amp;<sp/>!current_cs.<ref refid="class_chainstate_1a37f0e70024a7d2d694ae27d34609de0e" kindref="member">m_from_snapshot_blockhash</ref>)<sp/>{</highlight></codeline>
<codeline lineno="6159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Allocate<sp/>everything<sp/>to<sp/>the<sp/>IBD<sp/>chainstate.<sp/>This<sp/>will<sp/>always<sp/>happen</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6160"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>when<sp/>we<sp/>are<sp/>not<sp/>using<sp/>a<sp/>snapshot.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6161"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>current_cs.ResizeCoinsCaches(<ref refid="class_chainstate_manager_1a1193672873da4f09b48291890d0b523a" kindref="member">m_total_coinstip_cache</ref>,<sp/><ref refid="class_chainstate_manager_1ab8e486d36525b789f3858281b2b142f7" kindref="member">m_total_coinsdb_cache</ref>);</highlight></codeline>
<codeline lineno="6162"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!historical_cs)<sp/>{</highlight></codeline>
<codeline lineno="6163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>background<sp/>validation<sp/>has<sp/>completed<sp/>and<sp/>snapshot<sp/>is<sp/>our<sp/>active<sp/>chain...</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>allocating<sp/>all<sp/>cache<sp/>to<sp/>the<sp/>snapshot<sp/>chainstate&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="6165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Allocate<sp/>everything<sp/>to<sp/>the<sp/>snapshot<sp/>chainstate.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>current_cs.ResizeCoinsCaches(<ref refid="class_chainstate_manager_1a1193672873da4f09b48291890d0b523a" kindref="member">m_total_coinstip_cache</ref>,<sp/><ref refid="class_chainstate_manager_1ab8e486d36525b789f3858281b2b142f7" kindref="member">m_total_coinsdb_cache</ref>);</highlight></codeline>
<codeline lineno="6167"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="6168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>both<sp/>chainstates<sp/>exist,<sp/>determine<sp/>who<sp/>needs<sp/>more<sp/>cache<sp/>based<sp/>on<sp/>IBD<sp/>status.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note:<sp/>shrink<sp/>caches<sp/>first<sp/>so<sp/>that<sp/>we<sp/>don&apos;t<sp/>inadvertently<sp/>overwhelm<sp/>available<sp/>memory.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_manager_1a312bb1a2008bae3205f4699b90880d66" kindref="member">IsInitialBlockDownload</ref>())<sp/>{</highlight></codeline>
<codeline lineno="6172"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>historical_cs-&gt;ResizeCoinsCaches(</highlight></codeline>
<codeline lineno="6173"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a1193672873da4f09b48291890d0b523a" kindref="member">m_total_coinstip_cache</ref><sp/>*<sp/>0.05,<sp/><ref refid="class_chainstate_manager_1ab8e486d36525b789f3858281b2b142f7" kindref="member">m_total_coinsdb_cache</ref><sp/>*<sp/>0.05);</highlight></codeline>
<codeline lineno="6174"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>current_cs.ResizeCoinsCaches(</highlight></codeline>
<codeline lineno="6175"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a1193672873da4f09b48291890d0b523a" kindref="member">m_total_coinstip_cache</ref><sp/>*<sp/>0.95,<sp/><ref refid="class_chainstate_manager_1ab8e486d36525b789f3858281b2b142f7" kindref="member">m_total_coinsdb_cache</ref><sp/>*<sp/>0.95);</highlight></codeline>
<codeline lineno="6176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="6177"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>current_cs.ResizeCoinsCaches(</highlight></codeline>
<codeline lineno="6178"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a1193672873da4f09b48291890d0b523a" kindref="member">m_total_coinstip_cache</ref><sp/>*<sp/>0.05,<sp/><ref refid="class_chainstate_manager_1ab8e486d36525b789f3858281b2b142f7" kindref="member">m_total_coinsdb_cache</ref><sp/>*<sp/>0.05);</highlight></codeline>
<codeline lineno="6179"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>historical_cs-&gt;ResizeCoinsCaches(</highlight></codeline>
<codeline lineno="6180"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a1193672873da4f09b48291890d0b523a" kindref="member">m_total_coinstip_cache</ref><sp/>*<sp/>0.95,<sp/><ref refid="class_chainstate_manager_1ab8e486d36525b789f3858281b2b142f7" kindref="member">m_total_coinsdb_cache</ref><sp/>*<sp/>0.95);</highlight></codeline>
<codeline lineno="6181"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6182"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6183"><highlight class="normal">}</highlight></codeline>
<codeline lineno="6184"><highlight class="normal"></highlight></codeline>
<codeline lineno="6185"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ChainstateManager::ResetChainstates()</highlight></codeline>
<codeline lineno="6186"><highlight class="normal">{</highlight></codeline>
<codeline lineno="6187"><highlight class="normal"><sp/><sp/><sp/><sp/>m_chainstates.clear();</highlight></codeline>
<codeline lineno="6188"><highlight class="normal">}</highlight></codeline>
<codeline lineno="6189"><highlight class="normal"></highlight></codeline>
<codeline lineno="6195"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/><ref refid="class_chainstate_manager_1a66bc0ee7102eaf1cbd62d3a9d7087e52" kindref="member">ChainstateManager::Options</ref>&amp;&amp;<sp/>Flatten(<ref refid="class_chainstate_manager_1a66bc0ee7102eaf1cbd62d3a9d7087e52" kindref="member">ChainstateManager::Options</ref>&amp;&amp;<sp/>opts)</highlight></codeline>
<codeline lineno="6196"><highlight class="normal">{</highlight></codeline>
<codeline lineno="6197"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!opts.check_block_index.has_value())<sp/>opts.check_block_index<sp/>=<sp/>opts.chainparams.DefaultConsistencyChecks();</highlight></codeline>
<codeline lineno="6198"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!opts.minimum_chain_work.has_value())<sp/>opts.minimum_chain_work<sp/>=<sp/><ref refid="arith__uint256_8cpp_1a6a6e0e2e41ba7e31c4a741eb2426a516" kindref="member">UintToArith256</ref>(opts.chainparams.GetConsensus().nMinimumChainWork);</highlight></codeline>
<codeline lineno="6199"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!opts.assumed_valid_block.has_value())<sp/>opts.assumed_valid_block<sp/>=<sp/>opts.chainparams.GetConsensus().defaultAssumeValid;</highlight></codeline>
<codeline lineno="6200"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::move(opts);</highlight></codeline>
<codeline lineno="6201"><highlight class="normal">}</highlight></codeline>
<codeline lineno="6202"><highlight class="normal"></highlight></codeline>
<codeline lineno="6203"><highlight class="normal"><ref refid="class_chainstate_manager_1abf64809b392636e77309f8ad9a1e633a" kindref="member">ChainstateManager::ChainstateManager</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classutil_1_1_signal_interrupt" kindref="compound">util::SignalInterrupt</ref>&amp;<sp/>interrupt,<sp/><ref refid="struct_options" kindref="compound">Options</ref><sp/>options,<sp/><ref refid="classnode_1_1_block_manager_1a9d388cded97cd9f86c06358bb29abfad" kindref="member">node::BlockManager::Options</ref><sp/>blockman_options)</highlight></codeline>
<codeline lineno="6204"><highlight class="normal"><sp/><sp/><sp/><sp/>:<sp/>m_script_check_queue{</highlight><highlight class="comment">/*batch_size=*/</highlight><highlight class="normal">128,<sp/><ref refid="namespacestd" kindref="compound">std</ref>::clamp(options.worker_threads_num,<sp/>0,<sp/>MAX_SCRIPTCHECK_THREADS)},</highlight></codeline>
<codeline lineno="6205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_interrupt{interrupt},</highlight></codeline>
<codeline lineno="6206"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_options{Flatten(<ref refid="namespacestd" kindref="compound">std</ref>::move(options))},</highlight></codeline>
<codeline lineno="6207"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_blockman{interrupt,<sp/><ref refid="namespacestd" kindref="compound">std</ref>::move(blockman_options)},</highlight></codeline>
<codeline lineno="6208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_validation_cache{m_options.script_execution_cache_bytes,<sp/>m_options.signature_cache_bytes}</highlight></codeline>
<codeline lineno="6209"><highlight class="normal">{</highlight></codeline>
<codeline lineno="6210"><highlight class="normal">}</highlight></codeline>
<codeline lineno="6211"><highlight class="normal"></highlight></codeline>
<codeline lineno="6212"><highlight class="normal"><ref refid="class_chainstate_manager_1a30c226700bb0b48363077aab63be6074" kindref="member">ChainstateManager::~ChainstateManager</ref>()</highlight></codeline>
<codeline lineno="6213"><highlight class="normal">{</highlight></codeline>
<codeline lineno="6214"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="6215"><highlight class="normal"></highlight></codeline>
<codeline lineno="6216"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1ad854ac2aa6fccfd247fabfdbd1a0b89b" kindref="member">m_versionbitscache</ref>.Clear();</highlight></codeline>
<codeline lineno="6217"><highlight class="normal">}</highlight></codeline>
<codeline lineno="6218"><highlight class="normal"></highlight></codeline>
<codeline lineno="6219"><highlight class="normal"><ref refid="class_chainstate" kindref="compound">Chainstate</ref>*<sp/>ChainstateManager::LoadAssumeutxoChainstate()</highlight></codeline>
<codeline lineno="6220"><highlight class="normal">{</highlight></codeline>
<codeline lineno="6221"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!<ref refid="class_chainstate_manager_1a8d39d359e6ed774815dc8d31f326ff82" kindref="member">CurrentChainstate</ref>().m_from_snapshot_blockhash);</highlight></codeline>
<codeline lineno="6222"><highlight class="normal"><sp/><sp/><sp/><sp/>std::optional&lt;fs::path&gt;<sp/>path<sp/>=<sp/><ref refid="namespacenode_1a5b64fe45690872d3bd11de86a157c931" kindref="member">node::FindAssumeutxoChainstateDir</ref>(<ref refid="class_chainstate_manager_1a012c0463bd17a2be6045a0d62e8b0fd4" kindref="member">m_options</ref>.datadir);</highlight></codeline>
<codeline lineno="6223"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!path)<sp/>{</highlight></codeline>
<codeline lineno="6224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="6225"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6226"><highlight class="normal"><sp/><sp/><sp/><sp/>std::optional&lt;uint256&gt;<sp/>base_blockhash<sp/>=<sp/><ref refid="namespacenode_1a4d2cd11f67bcd44c8e56621eeee89695" kindref="member">node::ReadSnapshotBaseBlockhash</ref>(*path);</highlight></codeline>
<codeline lineno="6227"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!base_blockhash)<sp/>{</highlight></codeline>
<codeline lineno="6228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="6229"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6230"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>detected<sp/>active<sp/>snapshot<sp/>chainstate<sp/>(%s)<sp/>-<sp/>loading&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="6231"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs::PathToString(*path));</highlight></codeline>
<codeline lineno="6232"><highlight class="normal"></highlight></codeline>
<codeline lineno="6233"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>snapshot_chainstate{std::make_unique&lt;Chainstate&gt;(</highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">,<sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>,<sp/>*</highlight><highlight class="keyword">this</highlight><highlight class="normal">,<sp/>base_blockhash)};</highlight></codeline>
<codeline lineno="6234"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>switching<sp/>active<sp/>chainstate<sp/>to<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>snapshot_chainstate-&gt;ToString());</highlight></codeline>
<codeline lineno="6235"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>&amp;this-&gt;AddChainstate(std::move(snapshot_chainstate));</highlight></codeline>
<codeline lineno="6236"><highlight class="normal">}</highlight></codeline>
<codeline lineno="6237"><highlight class="normal"></highlight></codeline>
<codeline lineno="6238"><highlight class="normal"><ref refid="class_chainstate" kindref="compound">Chainstate</ref>&amp;<sp/>ChainstateManager::AddChainstate(std::unique_ptr&lt;Chainstate&gt;<sp/>chainstate)</highlight></codeline>
<codeline lineno="6239"><highlight class="normal">{</highlight></codeline>
<codeline lineno="6240"><highlight class="normal"><sp/><sp/><sp/><sp/>Chainstate&amp;<sp/>prev_chainstate{<ref refid="class_chainstate_manager_1a8d39d359e6ed774815dc8d31f326ff82" kindref="member">CurrentChainstate</ref>()};</highlight></codeline>
<codeline lineno="6241"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(prev_chainstate.m_assumeutxo<sp/>==<sp/><ref refid="validation_8h_1a6b7ed8f1aa31880e0db11fd5d379152da4d6154fe02ac9bf42fd2aacfa49310b0" kindref="member">Assumeutxo::VALIDATED</ref>);</highlight></codeline>
<codeline lineno="6242"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Set<sp/>target<sp/>block<sp/>for<sp/>historical<sp/>chainstate<sp/>to<sp/>snapshot<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6243"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!prev_chainstate.m_target_blockhash);</highlight></codeline>
<codeline lineno="6244"><highlight class="normal"><sp/><sp/><sp/><sp/>prev_chainstate.m_target_blockhash<sp/>=<sp/>chainstate-&gt;<ref refid="class_chainstate_1a37f0e70024a7d2d694ae27d34609de0e" kindref="member">m_from_snapshot_blockhash</ref>;</highlight></codeline>
<codeline lineno="6245"><highlight class="normal"><sp/><sp/><sp/><sp/>m_chainstates.push_back(std::move(chainstate));</highlight></codeline>
<codeline lineno="6246"><highlight class="normal"><sp/><sp/><sp/><sp/>Chainstate&amp;<sp/>curr_chainstate{<ref refid="class_chainstate_manager_1a8d39d359e6ed774815dc8d31f326ff82" kindref="member">CurrentChainstate</ref>()};</highlight></codeline>
<codeline lineno="6247"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(&amp;curr_chainstate<sp/>==<sp/>m_chainstates.back().get());</highlight></codeline>
<codeline lineno="6248"><highlight class="normal"></highlight></codeline>
<codeline lineno="6249"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Transfer<sp/>possession<sp/>of<sp/>the<sp/>mempool<sp/>to<sp/>the<sp/>chainstate.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6250"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Mempool<sp/>is<sp/>empty<sp/>at<sp/>this<sp/>point<sp/>because<sp/>we&apos;re<sp/>still<sp/>in<sp/>IBD.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6251"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(prev_chainstate.<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>-&gt;<ref refid="class_c_tx_mem_pool_1af22b5286aa0191a7087a205f6d04b032" kindref="member">size</ref>()<sp/>==<sp/>0);</highlight></codeline>
<codeline lineno="6252"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!curr_chainstate.<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>);</highlight></codeline>
<codeline lineno="6253"><highlight class="normal"><sp/><sp/><sp/><sp/>std::swap(curr_chainstate.<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>,<sp/>prev_chainstate.<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>);</highlight></codeline>
<codeline lineno="6254"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>curr_chainstate;</highlight></codeline>
<codeline lineno="6255"><highlight class="normal">}</highlight></codeline>
<codeline lineno="6256"><highlight class="normal"></highlight></codeline>
<codeline lineno="6257"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="validation_8cpp_1ad2cf17561482ed386ab70ddaa9b6b7a1" kindref="member">IsBIP30Repeat</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_block_index" kindref="compound">CBlockIndex</ref>&amp;<sp/>block_index)</highlight></codeline>
<codeline lineno="6258"><highlight class="normal">{</highlight></codeline>
<codeline lineno="6259"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(block_index.<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>==91842<sp/>&amp;&amp;<sp/>block_index.<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>()<sp/>==<sp/><ref refid="classuint256" kindref="compound">uint256</ref>{</highlight><highlight class="stringliteral">&quot;00000000000a4d0a398161ffc163c503763b1f4360639393e0e4c8e300e0caec&quot;</highlight><highlight class="normal">})<sp/>||</highlight></codeline>
<codeline lineno="6260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(block_index.<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>==91880<sp/>&amp;&amp;<sp/>block_index.<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>()<sp/>==<sp/><ref refid="classuint256" kindref="compound">uint256</ref>{</highlight><highlight class="stringliteral">&quot;00000000000743f190a18c5577a3c2d2a1f610ae9601ac046a38084ccb7cd721&quot;</highlight><highlight class="normal">});</highlight></codeline>
<codeline lineno="6261"><highlight class="normal">}</highlight></codeline>
<codeline lineno="6262"><highlight class="normal"></highlight></codeline>
<codeline lineno="6263"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="validation_8cpp_1af3fd9113ad463595ffeac4bf813ceea4" kindref="member">IsBIP30Unspendable</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classuint256" kindref="compound">uint256</ref>&amp;<sp/>block_hash,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>block_height)</highlight></codeline>
<codeline lineno="6264"><highlight class="normal">{</highlight></codeline>
<codeline lineno="6265"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(block_height==91722<sp/>&amp;&amp;<sp/>block_hash<sp/>==<sp/><ref refid="classuint256" kindref="compound">uint256</ref>{</highlight><highlight class="stringliteral">&quot;00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e&quot;</highlight><highlight class="normal">})<sp/>||</highlight></codeline>
<codeline lineno="6266"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(block_height==91812<sp/>&amp;&amp;<sp/>block_hash<sp/>==<sp/><ref refid="classuint256" kindref="compound">uint256</ref>{</highlight><highlight class="stringliteral">&quot;00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f&quot;</highlight><highlight class="normal">});</highlight></codeline>
<codeline lineno="6267"><highlight class="normal">}</highlight></codeline>
<codeline lineno="6268"><highlight class="normal"></highlight></codeline>
<codeline lineno="6269"><highlight class="normal"><ref refid="classutil_1_1_result" kindref="compound">util::Result&lt;void&gt;</ref><sp/>Chainstate::InvalidateCoinsDBOnDisk()</highlight></codeline>
<codeline lineno="6270"><highlight class="normal">{</highlight></codeline>
<codeline lineno="6271"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Should<sp/>never<sp/>be<sp/>called<sp/>on<sp/>a<sp/>non-snapshot<sp/>chainstate.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6272"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(<ref refid="class_chainstate_1a37f0e70024a7d2d694ae27d34609de0e" kindref="member">m_from_snapshot_blockhash</ref>);</highlight></codeline>
<codeline lineno="6273"><highlight class="normal"></highlight></codeline>
<codeline lineno="6274"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Coins<sp/>views<sp/>no<sp/>longer<sp/>usable.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6275"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_chainstate_1a33c67fb1b900add3e05efd125faaae85" kindref="member">m_coins_views</ref>.reset();</highlight></codeline>
<codeline lineno="6276"><highlight class="normal"></highlight></codeline>
<codeline lineno="6277"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::path<sp/>db_path{<ref refid="class_chainstate_1a4afdb9493bd2ee94b23c7b5dd6c51bbc" kindref="member">StoragePath</ref>()};</highlight></codeline>
<codeline lineno="6278"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::path<sp/>invalid_path{db_path<sp/>+<sp/></highlight><highlight class="stringliteral">&quot;_INVALID&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="6279"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::string<sp/>db_path_str{fs::PathToString(db_path)};</highlight></codeline>
<codeline lineno="6280"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::string<sp/>invalid_path_str{fs::PathToString(invalid_path)};</highlight></codeline>
<codeline lineno="6281"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>renaming<sp/>snapshot<sp/>datadir<sp/>%s<sp/>to<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>db_path_str,<sp/>invalid_path_str);</highlight></codeline>
<codeline lineno="6282"><highlight class="normal"></highlight></codeline>
<codeline lineno="6283"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>invalid<sp/>storage<sp/>directory<sp/>is<sp/>simply<sp/>moved<sp/>and<sp/>not<sp/>deleted<sp/>because<sp/>we<sp/>may</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6284"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>want<sp/>to<sp/>do<sp/>forensics<sp/>later<sp/>during<sp/>issue<sp/>investigation.<sp/>The<sp/>user<sp/>is<sp/>instructed</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6285"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>accordingly<sp/>in<sp/>MaybeValidateSnapshot().</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6286"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="6287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs::rename(db_path,<sp/>invalid_path);</highlight></codeline>
<codeline lineno="6288"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::filesystem_error&amp;<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="6289"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;While<sp/>invalidating<sp/>the<sp/>coins<sp/>db:<sp/>Error<sp/>renaming<sp/>file<sp/>&apos;%s&apos;<sp/>-&gt;<sp/>&apos;%s&apos;:<sp/>%s&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="6290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>db_path_str,<sp/>invalid_path_str,<sp/>e.what());</highlight></codeline>
<codeline lineno="6291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(<ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight></codeline>
<codeline lineno="6292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Rename<sp/>of<sp/>&apos;%s&apos;<sp/>-&gt;<sp/>&apos;%s&apos;<sp/>failed.<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;You<sp/>should<sp/>resolve<sp/>this<sp/>by<sp/>manually<sp/>moving<sp/>or<sp/>deleting<sp/>the<sp/>invalid<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;snapshot<sp/>directory<sp/>%s,<sp/>otherwise<sp/>you<sp/>will<sp/>encounter<sp/>the<sp/>same<sp/>error<sp/>again<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;on<sp/>the<sp/>next<sp/>startup.&quot;</highlight><highlight class="normal">),</highlight></codeline>
<codeline lineno="6296"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>db_path_str,<sp/>invalid_path_str,<sp/>db_path_str)};</highlight></codeline>
<codeline lineno="6297"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6298"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{};</highlight></codeline>
<codeline lineno="6299"><highlight class="normal">}</highlight></codeline>
<codeline lineno="6300"><highlight class="normal"></highlight></codeline>
<codeline lineno="6301"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>ChainstateManager::DeleteChainstate(<ref refid="class_chainstate" kindref="compound">Chainstate</ref>&amp;<sp/>chainstate)</highlight></codeline>
<codeline lineno="6302"><highlight class="normal">{</highlight></codeline>
<codeline lineno="6303"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="6304"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!chainstate.<ref refid="class_chainstate_1a33c67fb1b900add3e05efd125faaae85" kindref="member">m_coins_views</ref>);</highlight></codeline>
<codeline lineno="6305"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::path<sp/>db_path{chainstate.<ref refid="class_chainstate_1a4afdb9493bd2ee94b23c7b5dd6c51bbc" kindref="member">StoragePath</ref>()};</highlight></codeline>
<codeline lineno="6306"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!DeleteCoinsDBFromDisk(db_path,<sp/></highlight><highlight class="comment">/*is_snapshot=*/</highlight><highlight class="keywordtype">bool</highlight><highlight class="normal">{chainstate.<ref refid="class_chainstate_1a37f0e70024a7d2d694ae27d34609de0e" kindref="member">m_from_snapshot_blockhash</ref>}))<sp/>{</highlight></codeline>
<codeline lineno="6307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;Deletion<sp/>of<sp/>%s<sp/>failed.<sp/>Please<sp/>remove<sp/>it<sp/>manually<sp/>to<sp/>continue<sp/>reindexing.&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="6308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs::PathToString(db_path));</highlight></codeline>
<codeline lineno="6309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="6310"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6311"><highlight class="normal"><sp/><sp/><sp/><sp/>std::unique_ptr&lt;Chainstate&gt;<sp/>prev_chainstate{<ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(<ref refid="class_chainstate_manager_1a3548c5d82213aaa9daaf0ac46482e8ce" kindref="member">RemoveChainstate</ref>(chainstate))};</highlight></codeline>
<codeline lineno="6312"><highlight class="normal"><sp/><sp/><sp/><sp/>Chainstate&amp;<sp/>curr_chainstate{<ref refid="class_chainstate_manager_1a8d39d359e6ed774815dc8d31f326ff82" kindref="member">CurrentChainstate</ref>()};</highlight></codeline>
<codeline lineno="6313"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(prev_chainstate-&gt;m_mempool-&gt;size()<sp/>==<sp/>0);</highlight></codeline>
<codeline lineno="6314"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(!curr_chainstate.<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>);</highlight></codeline>
<codeline lineno="6315"><highlight class="normal"><sp/><sp/><sp/><sp/>std::swap(curr_chainstate.<ref refid="class_chainstate_1a0391c777447c32c2e0d8cfc900a822ca" kindref="member">m_mempool</ref>,<sp/>prev_chainstate-&gt;m_mempool);</highlight></codeline>
<codeline lineno="6316"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="6317"><highlight class="normal">}</highlight></codeline>
<codeline lineno="6318"><highlight class="normal"></highlight></codeline>
<codeline lineno="6319"><highlight class="normal"><ref refid="structkernel_1_1_chainstate_role" kindref="compound">ChainstateRole</ref><sp/>Chainstate::GetRole()</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="6320"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="6321"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ChainstateRole{.validated<sp/>=<sp/>m_assumeutxo<sp/>==<sp/><ref refid="validation_8h_1a6b7ed8f1aa31880e0db11fd5d379152da4d6154fe02ac9bf42fd2aacfa49310b0" kindref="member">Assumeutxo::VALIDATED</ref>,<sp/>.historical<sp/>=<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal">{m_target_blockhash}};</highlight></codeline>
<codeline lineno="6322"><highlight class="normal">}</highlight></codeline>
<codeline lineno="6323"><highlight class="normal"></highlight></codeline>
<codeline lineno="6324"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ChainstateManager::RecalculateBestHeader()</highlight></codeline>
<codeline lineno="6325"><highlight class="normal">{</highlight></codeline>
<codeline lineno="6326"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="6327"><highlight class="normal"><sp/><sp/><sp/><sp/>m_best_header<sp/>=<sp/><ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>();</highlight></codeline>
<codeline lineno="6328"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>entry<sp/>:<sp/><ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.m_block_index)<sp/>{</highlight></codeline>
<codeline lineno="6329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!(entry.second.nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada88df51e92f2f675baff60e0a5bd170ef" kindref="member">BLOCK_FAILED_MASK</ref>)<sp/>&amp;&amp;<sp/>m_best_header-&gt;nChainWork<sp/>&lt;<sp/>entry.second.nChainWork)<sp/>{</highlight></codeline>
<codeline lineno="6330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_best_header<sp/>=<sp/>&amp;entry.second;</highlight></codeline>
<codeline lineno="6331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6332"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6333"><highlight class="normal">}</highlight></codeline>
<codeline lineno="6334"><highlight class="normal"></highlight></codeline>
<codeline lineno="6335"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>ChainstateManager::ValidatedSnapshotCleanup(<ref refid="class_chainstate" kindref="compound">Chainstate</ref>&amp;<sp/>validated_cs,<sp/><ref refid="class_chainstate" kindref="compound">Chainstate</ref>&amp;<sp/>unvalidated_cs)</highlight></codeline>
<codeline lineno="6336"><highlight class="normal">{</highlight></codeline>
<codeline lineno="6337"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="6338"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(unvalidated_cs.m_assumeutxo<sp/>!=<sp/><ref refid="validation_8h_1a6b7ed8f1aa31880e0db11fd5d379152da4d6154fe02ac9bf42fd2aacfa49310b0" kindref="member">Assumeutxo::VALIDATED</ref>)<sp/>{</highlight></codeline>
<codeline lineno="6339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>No<sp/>need<sp/>to<sp/>clean<sp/>up.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6340"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="6341"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6342"><highlight class="normal"></highlight></codeline>
<codeline lineno="6343"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::path<sp/>validated_path{validated_cs.<ref refid="class_chainstate_1a4afdb9493bd2ee94b23c7b5dd6c51bbc" kindref="member">StoragePath</ref>()};</highlight></codeline>
<codeline lineno="6344"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::path<sp/>assumed_valid_path{unvalidated_cs.<ref refid="class_chainstate_1a4afdb9493bd2ee94b23c7b5dd6c51bbc" kindref="member">StoragePath</ref>()};</highlight></codeline>
<codeline lineno="6345"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::path<sp/>delete_path{validated_path<sp/>+<sp/></highlight><highlight class="stringliteral">&quot;_todelete&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="6346"><highlight class="normal"></highlight></codeline>
<codeline lineno="6347"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Since<sp/>we&apos;re<sp/>going<sp/>to<sp/>be<sp/>moving<sp/>around<sp/>the<sp/>underlying<sp/>leveldb<sp/>filesystem<sp/>content</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6348"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>for<sp/>each<sp/>chainstate,<sp/>make<sp/>sure<sp/>that<sp/>the<sp/>chainstates<sp/>(and<sp/>their<sp/>constituent</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6349"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>CoinsViews<sp/>members)<sp/>have<sp/>been<sp/>destructed<sp/>first.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6350"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6351"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>caller<sp/>of<sp/>this<sp/>method<sp/>will<sp/>be<sp/>responsible<sp/>for<sp/>reinitializing<sp/>chainstates</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6352"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>they<sp/>want<sp/>to<sp/>continue<sp/>operation.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6353"><highlight class="normal"><sp/><sp/><sp/><sp/>this-&gt;ResetChainstates();</highlight></codeline>
<codeline lineno="6354"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(this-&gt;m_chainstates.size()<sp/>==<sp/>0);</highlight></codeline>
<codeline lineno="6355"><highlight class="normal"></highlight></codeline>
<codeline lineno="6356"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>deleting<sp/>background<sp/>chainstate<sp/>directory<sp/>(now<sp/>unnecessary)<sp/>(%s)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="6357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs::PathToString(validated_path));</highlight></codeline>
<codeline lineno="6358"><highlight class="normal"></highlight></codeline>
<codeline lineno="6359"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>rename_failed_abort<sp/>=<sp/>[</highlight><highlight class="keyword">this</highlight><highlight class="normal">](</highlight></codeline>
<codeline lineno="6360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs::path<sp/>p_old,</highlight></codeline>
<codeline lineno="6361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs::path<sp/>p_new,</highlight></codeline>
<codeline lineno="6362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::filesystem_error&amp;<sp/>err)<sp/>{</highlight></codeline>
<codeline lineno="6363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>Error<sp/>renaming<sp/>path<sp/>(%s)<sp/>-&gt;<sp/>(%s):<sp/>%s\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="6364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs::PathToString(p_old),<sp/>fs::PathToString(p_new),<sp/>err.what());</highlight></codeline>
<codeline lineno="6365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_chainstate_manager_1a30d910c43e6619c9596c077fd1e5518d" kindref="member">GetNotifications</ref>().<ref refid="classkernel_1_1_notifications_1a2998f041aae2f227bb4bba3d9cb7a292" kindref="member">fatalError</ref>(<ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(<ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>(</highlight></codeline>
<codeline lineno="6366"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Rename<sp/>of<sp/>&apos;%s&apos;<sp/>-&gt;<sp/>&apos;%s&apos;<sp/>failed.<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Cannot<sp/>clean<sp/>up<sp/>the<sp/>background<sp/>chainstate<sp/>leveldb<sp/>directory.&quot;</highlight><highlight class="normal">),</highlight></codeline>
<codeline lineno="6368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs::PathToString(p_old),<sp/>fs::PathToString(p_new)));</highlight></codeline>
<codeline lineno="6369"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="6370"><highlight class="normal"></highlight></codeline>
<codeline lineno="6371"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="6372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs::rename(validated_path,<sp/>delete_path);</highlight></codeline>
<codeline lineno="6373"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::filesystem_error&amp;<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="6374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rename_failed_abort(validated_path,<sp/>delete_path,<sp/>e);</highlight></codeline>
<codeline lineno="6375"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="6376"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6377"><highlight class="normal"></highlight></codeline>
<codeline lineno="6378"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>moving<sp/>snapshot<sp/>chainstate<sp/>(%s)<sp/>to<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6379"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;default<sp/>chainstate<sp/>directory<sp/>(%s)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="6380"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs::PathToString(assumed_valid_path),<sp/>fs::PathToString(validated_path));</highlight></codeline>
<codeline lineno="6381"><highlight class="normal"></highlight></codeline>
<codeline lineno="6382"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="6383"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs::rename(assumed_valid_path,<sp/>validated_path);</highlight></codeline>
<codeline lineno="6384"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::filesystem_error&amp;<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="6385"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rename_failed_abort(assumed_valid_path,<sp/>validated_path,<sp/>e);</highlight></codeline>
<codeline lineno="6386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="6387"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6388"><highlight class="normal"></highlight></codeline>
<codeline lineno="6389"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!DeleteCoinsDBFromDisk(delete_path,<sp/></highlight><highlight class="comment">/*is_snapshot=*/</highlight><highlight class="keyword">false</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="6390"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>No<sp/>need<sp/>to<sp/>FatalError<sp/>because<sp/>once<sp/>the<sp/>unneeded<sp/>bg<sp/>chainstate<sp/>data<sp/>is</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6391"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>moved,<sp/>it<sp/>will<sp/>not<sp/>interfere<sp/>with<sp/>subsequent<sp/>initialization.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6392"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;Deletion<sp/>of<sp/>%s<sp/>failed.<sp/>Please<sp/>remove<sp/>it<sp/>manually,<sp/>as<sp/>the<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6393"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;directory<sp/>is<sp/>now<sp/>unnecessary.&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="6394"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs::PathToString(delete_path));</highlight></codeline>
<codeline lineno="6395"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="6396"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;[snapshot]<sp/>deleted<sp/>background<sp/>chainstate<sp/>directory<sp/>(%s)&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="6397"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs::PathToString(validated_path));</highlight></codeline>
<codeline lineno="6398"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6399"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="6400"><highlight class="normal">}</highlight></codeline>
<codeline lineno="6401"><highlight class="normal"></highlight></codeline>
<codeline lineno="6402"><highlight class="normal">std::pair&lt;int,<sp/>int&gt;<sp/>Chainstate::GetPruneRange(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>last_height_can_prune)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="6403"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="6404"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Height()<sp/>&lt;=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="6405"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{0,<sp/>0};</highlight></codeline>
<codeline lineno="6406"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6407"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>prune_start{0};</highlight></codeline>
<codeline lineno="6408"><highlight class="normal"></highlight></codeline>
<codeline lineno="6409"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_chainstate_1a37f0e70024a7d2d694ae27d34609de0e" kindref="member">m_from_snapshot_blockhash</ref><sp/>&amp;&amp;<sp/>m_assumeutxo<sp/>!=<sp/><ref refid="validation_8h_1a6b7ed8f1aa31880e0db11fd5d379152da4d6154fe02ac9bf42fd2aacfa49310b0" kindref="member">Assumeutxo::VALIDATED</ref>)<sp/>{</highlight></codeline>
<codeline lineno="6410"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>prune<sp/>blocks<sp/>_after_<sp/>the<sp/>snapshot<sp/>if<sp/>this<sp/>is<sp/>a<sp/>snapshot<sp/>chain</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>that<sp/>has<sp/>not<sp/>been<sp/>fully<sp/>validated<sp/>yet.<sp/>The<sp/>earlier<sp/>blocks<sp/>need<sp/>to<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6412"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>kept<sp/>to<sp/>validate<sp/>the<sp/>snapshot</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prune_start<sp/>=<sp/><ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(SnapshotBase())-&gt;nHeight<sp/>+<sp/>1;</highlight></codeline>
<codeline lineno="6414"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6415"><highlight class="normal"></highlight></codeline>
<codeline lineno="6416"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>max_prune<sp/>=<sp/>std::max&lt;int&gt;(</highlight></codeline>
<codeline lineno="6417"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>0,<sp/><ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.Height()<sp/>-<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">int</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(MIN_BLOCKS_TO_KEEP));</highlight></codeline>
<codeline lineno="6418"><highlight class="normal"></highlight></codeline>
<codeline lineno="6419"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>last<sp/>block<sp/>to<sp/>prune<sp/>is<sp/>the<sp/>lesser<sp/>of<sp/>(caller-specified<sp/>height,<sp/>MIN_BLOCKS_TO_KEEP<sp/>from<sp/>the<sp/>tip)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6420"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6421"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>While<sp/>you<sp/>might<sp/>be<sp/>tempted<sp/>to<sp/>prune<sp/>the<sp/>background<sp/>chainstate<sp/>more</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6422"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>aggressively<sp/>(i.e.<sp/>fewer<sp/>MIN_BLOCKS_TO_KEEP),<sp/>this<sp/>won&apos;t<sp/>work<sp/>with<sp/>index</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6423"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>building<sp/>-<sp/>specifically<sp/>blockfilterindex<sp/>requires<sp/>undo<sp/>data,<sp/>and<sp/>if</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6424"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>don&apos;t<sp/>maintain<sp/>this<sp/>trailing<sp/>window,<sp/>we<sp/>hit<sp/>indexing<sp/>failures.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6425"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>prune_end<sp/>=<sp/>std::min(last_height_can_prune,<sp/>max_prune);</highlight></codeline>
<codeline lineno="6426"><highlight class="normal"></highlight></codeline>
<codeline lineno="6427"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{prune_start,<sp/>prune_end};</highlight></codeline>
<codeline lineno="6428"><highlight class="normal">}</highlight></codeline>
<codeline lineno="6429"><highlight class="normal"></highlight></codeline>
<codeline lineno="6430"><highlight class="normal">std::optional&lt;std::pair&lt;const<sp/>CBlockIndex*,<sp/>const<sp/>CBlockIndex*&gt;&gt;<sp/>ChainstateManager::GetHistoricalBlockRange()</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="6431"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="6432"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Chainstate*<sp/>chainstate{<ref refid="class_chainstate_manager_1a1140f6d8b807be5796827fc4f7be03d7" kindref="member">HistoricalChainstate</ref>()};</highlight></codeline>
<codeline lineno="6433"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!chainstate)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{};</highlight></codeline>
<codeline lineno="6434"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::make_pair(chainstate-&gt;<ref refid="class_chainstate_1ad041fc477f2d0f0774b264bf6f371810" kindref="member">m_chain</ref>.<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>(),<sp/>chainstate-&gt;TargetBlock());</highlight></codeline>
<codeline lineno="6435"><highlight class="normal">}</highlight></codeline>
<codeline lineno="6436"><highlight class="normal"></highlight></codeline>
<codeline lineno="6437"><highlight class="normal"><ref refid="classutil_1_1_result" kindref="compound">util::Result&lt;void&gt;</ref><sp/>ChainstateManager::ActivateBestChains()</highlight></codeline>
<codeline lineno="6438"><highlight class="normal">{</highlight></codeline>
<codeline lineno="6439"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>can&apos;t<sp/>hold<sp/>cs_main<sp/>during<sp/>ActivateBestChain<sp/>even<sp/>though<sp/>we&apos;re<sp/>accessing</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6440"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>chainman<sp/>unique_ptrs<sp/>since<sp/>ABC<sp/>requires<sp/>us<sp/>not<sp/>to<sp/>be<sp/>holding<sp/>cs_main,<sp/>so<sp/>retrieve</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6441"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>relevant<sp/>pointers<sp/>before<sp/>the<sp/>ABC<sp/>call.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6442"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="6443"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;Chainstate*&gt;<sp/>chainstates;</highlight></codeline>
<codeline lineno="6444"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="6445"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="class_chainstate_manager_1af99ab8783b483abe3fef8ab596a3e6b6" kindref="member">GetMutex</ref>());</highlight></codeline>
<codeline lineno="6446"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>chainstates.reserve(m_chainstates.size());</highlight></codeline>
<codeline lineno="6447"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>chainstate<sp/>:<sp/>m_chainstates)<sp/>{</highlight></codeline>
<codeline lineno="6448"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(chainstate<sp/>&amp;&amp;<sp/>chainstate-&gt;m_assumeutxo<sp/>!=<sp/><ref refid="validation_8h_1a6b7ed8f1aa31880e0db11fd5d379152daccc0377a8afbf50e7094f5c23a8af223" kindref="member">Assumeutxo::INVALID</ref><sp/>&amp;&amp;<sp/>!chainstate-&gt;m_target_utxohash)<sp/>{</highlight></codeline>
<codeline lineno="6449"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>chainstates.push_back(chainstate.get());</highlight></codeline>
<codeline lineno="6450"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6452"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6453"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(Chainstate*<sp/>chainstate<sp/>:<sp/>chainstates)<sp/>{</highlight></codeline>
<codeline lineno="6454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BlockValidationState<sp/>state;</highlight></codeline>
<codeline lineno="6455"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!chainstate-&gt;ActivateBestChain(state,<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="6456"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="class_chainstate_manager_1af99ab8783b483abe3fef8ab596a3e6b6" kindref="member">GetMutex</ref>());</highlight></codeline>
<codeline lineno="6457"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Error{<ref refid="translation_8h_1adff31aba0266455557bf721860f481b8" kindref="member">Untranslated</ref>(<ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;%s<sp/>Failed<sp/>to<sp/>connect<sp/>best<sp/>block<sp/>(%s)&quot;</highlight><highlight class="normal">,<sp/>chainstate-&gt;ToString(),<sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>()))};</highlight></codeline>
<codeline lineno="6458"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6459"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="6460"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{};</highlight></codeline>
<codeline lineno="6461"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="src/validation.cpp"/>
  </compounddef>
</doxygen>
