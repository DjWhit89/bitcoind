<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.15.0" xml:lang="en-US">
  <compounddef id="fs__helpers_8cpp" kind="file" language="C++">
    <compoundname>fs_helpers.cpp</compoundname>
    <includes refid="fs__helpers_8h" local="no">util/fs_helpers.h</includes>
    <includes local="no">bitcoin-build-config.h</includes>
    <includes local="no">logging.h</includes>
    <includes refid="sync_8h" local="no">sync.h</includes>
    <includes refid="fs_8h" local="no">util/fs.h</includes>
    <includes refid="syserror_8h" local="no">util/syserror.h</includes>
    <includes local="no">cerrno</includes>
    <includes local="no">fstream</includes>
    <includes local="no">map</includes>
    <includes local="no">memory</includes>
    <includes local="no">optional</includes>
    <includes local="no">string</includes>
    <includes local="no">system_error</includes>
    <includes local="no">utility</includes>
    <includes local="no">fcntl.h</includes>
    <includes local="no">sys/resource.h</includes>
    <includes local="no">unistd.h</includes>
    <incdepgraph>
      <node id="6">
        <label>attributes.h</label>
        <link refid="attributes_8h"/>
      </node>
      <node id="11">
        <label>span.h</label>
        <link refid="span_8h"/>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
      </node>
      <node id="36">
        <label>sync.h</label>
        <link refid="sync_8h"/>
        <childnode refid="37" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
      </node>
      <node id="37">
        <label>threadsafety.h</label>
        <link refid="threadsafety_8h"/>
        <childnode refid="38" relation="include">
        </childnode>
      </node>
      <node id="4">
        <label>tinyformat.h</label>
        <link refid="tinyformat_8h"/>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
      </node>
      <node id="3">
        <label>util/fs.h</label>
        <link refid="fs_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
      </node>
      <node id="1">
        <label>src/util/fs_helpers.cpp</label>
        <link refid="fs__helpers_8cpp"/>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="46" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
      </node>
      <node id="2">
        <label>util/fs_helpers.h</label>
        <link refid="fs__helpers_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="31" relation="include">
        </childnode>
        <childnode refid="32" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
      </node>
      <node id="39">
        <label>util/macros.h</label>
        <link refid="macros_8h"/>
      </node>
      <node id="10">
        <label>util/string.h</label>
        <link refid="string_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
      </node>
      <node id="42">
        <label>util/syserror.h</label>
        <link refid="syserror_8h"/>
        <childnode refid="21" relation="include">
        </childnode>
      </node>
      <node id="5">
        <label>algorithm</label>
      </node>
      <node id="17">
        <label>array</label>
      </node>
      <node id="34">
        <label>bitcoin-build-config.h</label>
      </node>
      <node id="12">
        <label>cassert</label>
      </node>
      <node id="43">
        <label>cerrno</label>
      </node>
      <node id="40">
        <label>condition_variable</label>
      </node>
      <node id="13">
        <label>cstddef</label>
      </node>
      <node id="18">
        <label>cstdint</label>
      </node>
      <node id="24">
        <label>cstdio</label>
      </node>
      <node id="19">
        <label>cstring</label>
      </node>
      <node id="47">
        <label>fcntl.h</label>
      </node>
      <node id="25">
        <label>filesystem</label>
      </node>
      <node id="44">
        <label>fstream</label>
      </node>
      <node id="26">
        <label>functional</label>
      </node>
      <node id="27">
        <label>iomanip</label>
      </node>
      <node id="28">
        <label>ios</label>
      </node>
      <node id="31">
        <label>iosfwd</label>
      </node>
      <node id="7">
        <label>iostream</label>
      </node>
      <node id="32">
        <label>limits</label>
      </node>
      <node id="20">
        <label>locale</label>
      </node>
      <node id="35">
        <label>logging.h</label>
      </node>
      <node id="45">
        <label>map</label>
      </node>
      <node id="46">
        <label>memory</label>
      </node>
      <node id="38">
        <label>mutex</label>
      </node>
      <node id="33">
        <label>optional</label>
      </node>
      <node id="29">
        <label>ostream</label>
      </node>
      <node id="14">
        <label>span</label>
      </node>
      <node id="8">
        <label>sstream</label>
      </node>
      <node id="9">
        <label>stdexcept</label>
      </node>
      <node id="21">
        <label>string</label>
      </node>
      <node id="22">
        <label>string_view</label>
      </node>
      <node id="48">
        <label>sys/resource.h</label>
      </node>
      <node id="30">
        <label>system_error</label>
      </node>
      <node id="41">
        <label>thread</label>
      </node>
      <node id="15">
        <label>type_traits</label>
      </node>
      <node id="49">
        <label>unistd.h</label>
      </node>
      <node id="16">
        <label>utility</label>
      </node>
      <node id="23">
        <label>vector</label>
      </node>
    </incdepgraph>
    <innernamespace refid="namespaceutil">util</innernamespace>
    <sectiondef kind="var">
      <memberdef kind="variable" id="fs__helpers_8cpp_1a39bde3a0919c1b174fe2f760fec30881" prot="public" static="yes" mutable="no">
        <type><ref refid="class_global_mutex" kindref="compound">GlobalMutex</ref></type>
        <definition>GlobalMutex cs_dir_locks</definition>
        <argsstring></argsstring>
        <name>cs_dir_locks</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para><ref refid="sync_8h_1a326d1d46ce05b5316d8ebe2694a10a6e" kindref="member">Mutex</ref> to protect dir_locks. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/util/fs_helpers.cpp" line="39" column="20" bodyfile="src/util/fs_helpers.cpp" bodystart="39" bodyend="-1"/>
      </memberdef>
    </sectiondef>
    <sectiondef kind="func">
      <memberdef kind="function" id="fs__helpers_8cpp_1adb887610fd3fdc893f934e203195e055" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>std::map&lt; std::string, std::unique_ptr&lt; <ref refid="classfsbridge_1_1_file_lock" kindref="compound">fsbridge::FileLock</ref> &gt; &gt; dir_locks</type>
        <definition>static std::map&lt; std::string, std::unique_ptr&lt; fsbridge::FileLock &gt; &gt; dir_locks GUARDED_BY</definition>
        <argsstring>(cs_dir_locks)</argsstring>
        <name>GUARDED_BY</name>
        <param>
          <type>cs_dir_locks</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>A map that contains all the currently held directory locks. After successful locking, these will be held here until the global destructor cleans them up and thus automatically unlocks them, or ReleaseDirectoryLocks is called. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/util/fs_helpers.cpp" line="45" column="27" declfile="src/util/fs_helpers.cpp" declline="45" declcolumn="27"/>
      </memberdef>
      <memberdef kind="function" id="fs__helpers_8cpp_1af40252a0b20b111179778c92b60f2f13" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void UnlockDirectory</definition>
        <argsstring>(const fs::path &amp;directory, const fs::path &amp;lockfile_name)</argsstring>
        <name>UnlockDirectory</name>
        <param>
          <type>const <ref refid="classfs_1_1path" kindref="compound">fs::path</ref> &amp;</type>
          <declname>directory</declname>
        </param>
        <param>
          <type>const <ref refid="classfs_1_1path" kindref="compound">fs::path</ref> &amp;</type>
          <declname>lockfile_name</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/util/fs_helpers.cpp" line="75" column="6" bodyfile="src/util/fs_helpers.cpp" bodystart="75" bodyend="79"/>
      </memberdef>
      <memberdef kind="function" id="fs__helpers_8cpp_1a851fa89def443bac9d04ddb908cb91bb" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void ReleaseDirectoryLocks</definition>
        <argsstring>()</argsstring>
        <name>ReleaseDirectoryLocks</name>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Release all directory locks. This is used for unit testing only, at runtime the global destructor will take care of the locks. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/util/fs_helpers.cpp" line="81" column="6" bodyfile="src/util/fs_helpers.cpp" bodystart="81" bodyend="85"/>
      </memberdef>
      <memberdef kind="function" id="fs__helpers_8cpp_1aafef764388e19a399584b65ef3d97b99" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool CheckDiskSpace</definition>
        <argsstring>(const fs::path &amp;dir, uint64_t additional_bytes)</argsstring>
        <name>CheckDiskSpace</name>
        <param>
          <type>const <ref refid="classfs_1_1path" kindref="compound">fs::path</ref> &amp;</type>
          <declname>dir</declname>
        </param>
        <param>
          <type>uint64_t</type>
          <declname>additional_bytes</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/util/fs_helpers.cpp" line="87" column="6" bodyfile="src/util/fs_helpers.cpp" bodystart="87" bodyend="93"/>
      </memberdef>
      <memberdef kind="function" id="fs__helpers_8cpp_1a6396560e175adc5b89e6ebd7e335cf8a" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>std::streampos</type>
        <definition>std::streampos GetFileSize</definition>
        <argsstring>(const char *path, std::streamsize max)</argsstring>
        <name>GetFileSize</name>
        <param>
          <type>const char *</type>
          <declname>path</declname>
        </param>
        <param>
          <type>std::streamsize</type>
          <declname>max</declname>
          <defval>std::numeric_limits&lt; std::streamsize &gt;::max()</defval>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Get the size of a file by scanning it.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">path</parametername>
</parameternamelist>
<parameterdescription>
<para>The file path </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername direction="in">max</parametername>
</parameternamelist>
<parameterdescription>
<para>Stop seeking beyond this limit </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>The file size or max </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/util/fs_helpers.cpp" line="95" column="16" bodyfile="src/util/fs_helpers.cpp" bodystart="95" bodyend="100"/>
      </memberdef>
      <memberdef kind="function" id="fs__helpers_8cpp_1aedd7d9ab25c6cfb8c81a4aaa917b104e" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool FileCommit</definition>
        <argsstring>(FILE *file)</argsstring>
        <name>FileCommit</name>
        <param>
          <type>FILE *</type>
          <declname>file</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Ensure file contents are fully committed to disk, using a platform-specific feature analogous to fsync(). </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/util/fs_helpers.cpp" line="102" column="6" bodyfile="src/util/fs_helpers.cpp" bodystart="102" bodyend="131"/>
      </memberdef>
      <memberdef kind="function" id="fs__helpers_8cpp_1a7ec0a8f5e6d2d0f3f3358b3ee4fec5e0" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void DirectoryCommit</definition>
        <argsstring>(const fs::path &amp;dirname)</argsstring>
        <name>DirectoryCommit</name>
        <param>
          <type>const <ref refid="classfs_1_1path" kindref="compound">fs::path</ref> &amp;</type>
          <declname>dirname</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Sync directory contents. This is required on some environments to ensure that newly created files are committed to disk. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/util/fs_helpers.cpp" line="133" column="6" bodyfile="src/util/fs_helpers.cpp" bodystart="133" bodyend="142"/>
      </memberdef>
      <memberdef kind="function" id="fs__helpers_8cpp_1acb8d6b822bc1bfa609bf43bbac1a0d44" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool TruncateFile</definition>
        <argsstring>(FILE *file, unsigned int length)</argsstring>
        <name>TruncateFile</name>
        <param>
          <type>FILE *</type>
          <declname>file</declname>
        </param>
        <param>
          <type>unsigned int</type>
          <declname>length</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/util/fs_helpers.cpp" line="144" column="6" bodyfile="src/util/fs_helpers.cpp" bodystart="144" bodyend="151"/>
      </memberdef>
      <memberdef kind="function" id="fs__helpers_8cpp_1a756a5c49a4bb607d16d9842f8f3ede4f" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int RaiseFileDescriptorLimit</definition>
        <argsstring>(int nMinFD)</argsstring>
        <name>RaiseFileDescriptorLimit</name>
        <param>
          <type>int</type>
          <declname>nMinFD</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>this function tries to raise the file descriptor limit to the requested number. It returns the actual file descriptor limit (which may be more or less than nMinFD) </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/util/fs_helpers.cpp" line="157" column="5" bodyfile="src/util/fs_helpers.cpp" bodystart="157" bodyend="175"/>
      </memberdef>
      <memberdef kind="function" id="fs__helpers_8cpp_1a91c763bffc49cf7ed8d45cc44870e55c" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void AllocateFileRange</definition>
        <argsstring>(FILE *file, unsigned int offset, unsigned int length)</argsstring>
        <name>AllocateFileRange</name>
        <param>
          <type>FILE *</type>
          <declname>file</declname>
        </param>
        <param>
          <type>unsigned int</type>
          <declname>offset</declname>
        </param>
        <param>
          <type>unsigned int</type>
          <declname>length</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>this function tries to make a particular range of a file allocated (corresponding to disk space) it is advisory, and the range specified in the arguments will never contain live data </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/util/fs_helpers.cpp" line="181" column="6" bodyfile="src/util/fs_helpers.cpp" bodystart="181" bodyend="227"/>
      </memberdef>
      <memberdef kind="function" id="fs__helpers_8cpp_1a579657da2b55b131ecd453bf1b0d2314" prot="public" static="no" nodiscard="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool RenameOver</definition>
        <argsstring>(fs::path src, fs::path dest)</argsstring>
        <name>RenameOver</name>
        <param>
          <type><ref refid="classfs_1_1path" kindref="compound">fs::path</ref></type>
          <declname>src</declname>
        </param>
        <param>
          <type><ref refid="classfs_1_1path" kindref="compound">fs::path</ref></type>
          <declname>dest</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Rename src to dest. <simplesect kind="return"><para>true if the rename was successful. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/util/fs_helpers.cpp" line="243" column="6" bodyfile="src/util/fs_helpers.cpp" bodystart="243" bodyend="248"/>
      </memberdef>
      <memberdef kind="function" id="fs__helpers_8cpp_1a9042a919d837da9d97311a0c460c597c" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>bool</type>
        <definition>bool TryCreateDirectories</definition>
        <argsstring>(const fs::path &amp;p)</argsstring>
        <name>TryCreateDirectories</name>
        <param>
          <type>const <ref refid="classfs_1_1path" kindref="compound">fs::path</ref> &amp;</type>
          <declname>p</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Ignores exceptions thrown by create_directories if the requested directory exists. Specifically handles case where path p exists, but it wasn&apos;t possible for the user to write to the parent directory. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/util/fs_helpers.cpp" line="255" column="6" bodyfile="src/util/fs_helpers.cpp" bodystart="255" bodyend="266"/>
      </memberdef>
      <memberdef kind="function" id="fs__helpers_8cpp_1ae34526a9ca0bc46252b39f5f7bde63db" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>std::string</type>
        <definition>std::string PermsToSymbolicString</definition>
        <argsstring>(fs::perms p)</argsstring>
        <name>PermsToSymbolicString</name>
        <param>
          <type>fs::perms</type>
          <declname>p</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Convert fs::perms to symbolic string of the form &apos;rwxrwxrwx&apos;</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">p</parametername>
</parameternamelist>
<parameterdescription>
<para>the perms to be converted </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>Symbolic permissions string </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/util/fs_helpers.cpp" line="268" column="13" bodyfile="src/util/fs_helpers.cpp" bodystart="268" bodyend="289"/>
      </memberdef>
      <memberdef kind="function" id="fs__helpers_8cpp_1abc0b553e20da0fcce0c071a85a1ec1ea" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>std::optional&lt; fs::perms &gt;</type>
        <definition>std::optional&lt; fs::perms &gt; InterpretPermString</definition>
        <argsstring>(const std::string &amp;s)</argsstring>
        <name>InterpretPermString</name>
        <param>
          <type>const std::string &amp;</type>
          <declname>s</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Interpret a custom permissions level string as fs::perms</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername direction="in">s</parametername>
</parameternamelist>
<parameterdescription>
<para>Permission level string </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>Permissions as fs::perms </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/util/fs_helpers.cpp" line="291" column="15" bodyfile="src/util/fs_helpers.cpp" bodystart="291" bodyend="305"/>
      </memberdef>
    </sectiondef>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="comment">//<sp/>Copyright<sp/>(c)<sp/>2009-2010<sp/>Satoshi<sp/>Nakamoto</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Copyright<sp/>(c)<sp/>2009-present<sp/>The<sp/>Bitcoin<sp/>Core<sp/>developers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Distributed<sp/>under<sp/>the<sp/>MIT<sp/>software<sp/>license,<sp/>see<sp/>the<sp/>accompanying</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4"><highlight class="normal"></highlight><highlight class="comment">//<sp/>file<sp/>COPYING<sp/>or<sp/>http://www.opensource.org/licenses/mit-license.php.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5"><highlight class="normal"></highlight></codeline>
<codeline lineno="6"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="fs__helpers_8h" kindref="compound">util/fs_helpers.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;bitcoin-build-config.h&gt;</highlight><highlight class="normal"><sp/></highlight><highlight class="comment">//<sp/>IWYU<sp/>pragma:<sp/>keep</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;logging.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="sync_8h" kindref="compound">sync.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="fs_8h" kindref="compound">util/fs.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="13"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="syserror_8h" kindref="compound">util/syserror.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="14"><highlight class="normal"></highlight></codeline>
<codeline lineno="15"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;cerrno&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="16"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;fstream&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="17"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;map&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="18"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;memory&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="19"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;optional&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="20"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;string&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="21"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;system_error&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="22"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;utility&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="23"><highlight class="normal"></highlight></codeline>
<codeline lineno="24"><highlight class="normal"></highlight><highlight class="preprocessor">#ifndef<sp/>WIN32</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="25"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;fcntl.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="26"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;sys/resource.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="27"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;unistd.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="28"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="29"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;io.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="30"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;shlobj.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="31"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/></highlight><highlight class="comment">//<sp/>WIN32</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="32"><highlight class="normal"></highlight></codeline>
<codeline lineno="33"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>__APPLE__</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="34"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;sys/mount.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="35"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;sys/param.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="36"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="37"><highlight class="normal"></highlight></codeline>
<codeline lineno="39"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/><ref refid="class_global_mutex" kindref="compound">GlobalMutex</ref><sp/>cs_dir_locks;</highlight></codeline>
<codeline lineno="45"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>std::map&lt;std::string,<sp/>std::unique_ptr&lt;fsbridge::FileLock&gt;&gt;<sp/>dir_locks<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(cs_dir_locks);</highlight></codeline>
<codeline lineno="46"><highlight class="normal"></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal"><ref refid="namespaceutil" kindref="compound">util</ref><sp/>{</highlight></codeline>
<codeline lineno="47"><highlight class="normal"><ref refid="namespaceutil_1a3520a91e926bf45bc7230610c2e893f3" kindref="member">LockResult</ref><sp/><ref refid="namespaceutil_1a4e0b24c45776b5599a02005ef0a189dd" kindref="member">LockDirectory</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::path&amp;<sp/>directory,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::path&amp;<sp/>lockfile_name,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>probe_only)</highlight></codeline>
<codeline lineno="48"><highlight class="normal">{</highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(cs_dir_locks);</highlight></codeline>
<codeline lineno="50"><highlight class="normal"><sp/><sp/><sp/><sp/>fs::path<sp/>pathLockFile<sp/>=<sp/>directory<sp/>/<sp/>lockfile_name;</highlight></codeline>
<codeline lineno="51"><highlight class="normal"></highlight></codeline>
<codeline lineno="52"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>a<sp/>lock<sp/>for<sp/>this<sp/>directory<sp/>already<sp/>exists<sp/>in<sp/>the<sp/>map,<sp/>don&apos;t<sp/>try<sp/>to<sp/>re-lock<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="53"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(dir_locks.contains(fs::PathToString(pathLockFile)))<sp/>{</highlight></codeline>
<codeline lineno="54"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="namespaceutil_1a3520a91e926bf45bc7230610c2e893f3a505a83f220c02df2f85c3810cd9ceb38" kindref="member">LockResult::Success</ref>;</highlight></codeline>
<codeline lineno="55"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="56"><highlight class="normal"></highlight></codeline>
<codeline lineno="57"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Create<sp/>empty<sp/>lock<sp/>file<sp/>if<sp/>it<sp/>doesn&apos;t<sp/>exist.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="58"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>created{<ref refid="namespacefsbridge_1a52093f6db7ef176f21e89f9e46367ded" kindref="member">fsbridge::fopen</ref>(pathLockFile,<sp/></highlight><highlight class="stringliteral">&quot;a&quot;</highlight><highlight class="normal">)})<sp/>{</highlight></codeline>
<codeline lineno="59"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::fclose(created);</highlight></codeline>
<codeline lineno="60"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="namespaceutil_1a3520a91e926bf45bc7230610c2e893f3a05f9fd8b78a01625a2df427c3413488d" kindref="member">LockResult::ErrorWrite</ref>;</highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>lock<sp/>=<sp/>std::make_unique&lt;fsbridge::FileLock&gt;(pathLockFile);</highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!lock-&gt;TryLock())<sp/>{</highlight></codeline>
<codeline lineno="65"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;Error<sp/>while<sp/>attempting<sp/>to<sp/>lock<sp/>directory<sp/>%s:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>fs::PathToString(directory),<sp/>lock-&gt;GetReason());</highlight></codeline>
<codeline lineno="66"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="namespaceutil_1a3520a91e926bf45bc7230610c2e893f3a6dc3e93d1a7110731aaec2df1cfc93b8" kindref="member">LockResult::ErrorLock</ref>;</highlight></codeline>
<codeline lineno="67"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="68"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!probe_only)<sp/>{</highlight></codeline>
<codeline lineno="69"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Lock<sp/>successful<sp/>and<sp/>we&apos;re<sp/>not<sp/>just<sp/>probing,<sp/>put<sp/>it<sp/>into<sp/>the<sp/>map</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="70"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dir_locks.emplace(fs::PathToString(pathLockFile),<sp/>std::move(lock));</highlight></codeline>
<codeline lineno="71"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="72"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="namespaceutil_1a3520a91e926bf45bc7230610c2e893f3a505a83f220c02df2f85c3810cd9ceb38" kindref="member">LockResult::Success</ref>;</highlight></codeline>
<codeline lineno="73"><highlight class="normal">}</highlight></codeline>
<codeline lineno="74"><highlight class="normal">}<sp/></highlight><highlight class="comment">//<sp/>namespace<sp/>util</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="75"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="fs__helpers_8cpp_1af40252a0b20b111179778c92b60f2f13" kindref="member">UnlockDirectory</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::path&amp;<sp/>directory,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::path&amp;<sp/>lockfile_name)</highlight></codeline>
<codeline lineno="76"><highlight class="normal">{</highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(cs_dir_locks);</highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/>dir_locks.erase(fs::PathToString(directory<sp/>/<sp/>lockfile_name));</highlight></codeline>
<codeline lineno="79"><highlight class="normal">}</highlight></codeline>
<codeline lineno="80"><highlight class="normal"></highlight></codeline>
<codeline lineno="81"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="fs__helpers_8cpp_1a851fa89def443bac9d04ddb908cb91bb" kindref="member">ReleaseDirectoryLocks</ref>()</highlight></codeline>
<codeline lineno="82"><highlight class="normal">{</highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(cs_dir_locks);</highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/>dir_locks.clear();</highlight></codeline>
<codeline lineno="85"><highlight class="normal">}</highlight></codeline>
<codeline lineno="86"><highlight class="normal"></highlight></codeline>
<codeline lineno="87"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="fs__helpers_8cpp_1aafef764388e19a399584b65ef3d97b99" kindref="member">CheckDiskSpace</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::path&amp;<sp/>dir,<sp/>uint64_t<sp/>additional_bytes)</highlight></codeline>
<codeline lineno="88"><highlight class="normal">{</highlight></codeline>
<codeline lineno="89"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint64_t<sp/>min_disk_space<sp/>=<sp/>52428800;<sp/></highlight><highlight class="comment">//<sp/>50<sp/>MiB</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="90"><highlight class="normal"></highlight></codeline>
<codeline lineno="91"><highlight class="normal"><sp/><sp/><sp/><sp/>uint64_t<sp/>free_bytes_available<sp/>=<sp/>fs::space(dir).available;</highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>free_bytes_available<sp/>&gt;=<sp/>min_disk_space<sp/>+<sp/>additional_bytes;</highlight></codeline>
<codeline lineno="93"><highlight class="normal">}</highlight></codeline>
<codeline lineno="94"><highlight class="normal"></highlight></codeline>
<codeline lineno="95"><highlight class="normal">std::streampos<sp/><ref refid="fs__helpers_8cpp_1a6396560e175adc5b89e6ebd7e335cf8a" kindref="member">GetFileSize</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal">*<sp/>path,<sp/>std::streamsize<sp/>max)</highlight></codeline>
<codeline lineno="96"><highlight class="normal">{</highlight></codeline>
<codeline lineno="97"><highlight class="normal"><sp/><sp/><sp/><sp/>std::ifstream<sp/>file{path,<sp/>std::ios::binary};</highlight></codeline>
<codeline lineno="98"><highlight class="normal"><sp/><sp/><sp/><sp/>file.ignore(max);</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>file.gcount();</highlight></codeline>
<codeline lineno="100"><highlight class="normal">}</highlight></codeline>
<codeline lineno="101"><highlight class="normal"></highlight></codeline>
<codeline lineno="102"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="fs__helpers_8cpp_1aedd7d9ab25c6cfb8c81a4aaa917b104e" kindref="member">FileCommit</ref>(FILE*<sp/>file)</highlight></codeline>
<codeline lineno="103"><highlight class="normal">{</highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fflush(file)<sp/>!=<sp/>0)<sp/>{<sp/></highlight><highlight class="comment">//<sp/>harmless<sp/>if<sp/>redundantly<sp/>called</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;fflush<sp/>failed:<sp/>%s&quot;</highlight><highlight class="normal">,<sp/><ref refid="syserror_8cpp_1aed54b21219b1bf6d2e7367bd5ece9482" kindref="member">SysErrorString</ref>(errno));</highlight></codeline>
<codeline lineno="106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="108"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>WIN32</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/><sp/><sp/>HANDLE<sp/>hFile<sp/>=<sp/>(HANDLE)_get_osfhandle(_fileno(file));</highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(FlushFileBuffers(hFile)<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;FlushFileBuffers<sp/>failed:<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>Win32ErrorString(GetLastError()));</highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="114"><highlight class="normal"></highlight><highlight class="preprocessor">#elif<sp/>defined(__APPLE__)<sp/>&amp;&amp;<sp/>defined(F_FULLFSYNC)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fcntl(fileno(file),<sp/>F_FULLFSYNC,<sp/>0)<sp/>==<sp/>-1)<sp/>{<sp/></highlight><highlight class="comment">//<sp/>Manpage<sp/>says<sp/>&quot;value<sp/>other<sp/>than<sp/>-1&quot;<sp/>is<sp/>returned<sp/>on<sp/>success</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;fcntl<sp/>F_FULLFSYNC<sp/>failed:<sp/>%s&quot;</highlight><highlight class="normal">,<sp/><ref refid="syserror_8cpp_1aed54b21219b1bf6d2e7367bd5ece9482" kindref="member">SysErrorString</ref>(errno));</highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="119"><highlight class="normal"></highlight><highlight class="preprocessor">#elif<sp/>HAVE_FDATASYNC</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fdatasync(fileno(file))<sp/>!=<sp/>0<sp/>&amp;&amp;<sp/>errno<sp/>!=<sp/>EINVAL)<sp/>{<sp/></highlight><highlight class="comment">//<sp/>Ignore<sp/>EINVAL<sp/>for<sp/>filesystems<sp/>that<sp/>don&apos;t<sp/>support<sp/>sync</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;fdatasync<sp/>failed:<sp/>%s&quot;</highlight><highlight class="normal">,<sp/><ref refid="syserror_8cpp_1aed54b21219b1bf6d2e7367bd5ece9482" kindref="member">SysErrorString</ref>(errno));</highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="123"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="124"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fsync(fileno(file))<sp/>!=<sp/>0<sp/>&amp;&amp;<sp/>errno<sp/>!=<sp/>EINVAL)<sp/>{</highlight></codeline>
<codeline lineno="126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;fsync<sp/>failed:<sp/>%s&quot;</highlight><highlight class="normal">,<sp/><ref refid="syserror_8cpp_1aed54b21219b1bf6d2e7367bd5ece9482" kindref="member">SysErrorString</ref>(errno));</highlight></codeline>
<codeline lineno="127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="128"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="129"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="131"><highlight class="normal">}</highlight></codeline>
<codeline lineno="132"><highlight class="normal"></highlight></codeline>
<codeline lineno="133"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="fs__helpers_8cpp_1a7ec0a8f5e6d2d0f3f3358b3ee4fec5e0" kindref="member">DirectoryCommit</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::path&amp;<sp/>dirname)</highlight></codeline>
<codeline lineno="134"><highlight class="normal">{</highlight></codeline>
<codeline lineno="135"><highlight class="normal"></highlight><highlight class="preprocessor">#ifndef<sp/>WIN32</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="136"><highlight class="normal"><sp/><sp/><sp/><sp/>FILE*<sp/>file<sp/>=<sp/><ref refid="namespacefsbridge_1a52093f6db7ef176f21e89f9e46367ded" kindref="member">fsbridge::fopen</ref>(dirname,<sp/></highlight><highlight class="stringliteral">&quot;r&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(file)<sp/>{</highlight></codeline>
<codeline lineno="138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fsync(fileno(file));</highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fclose(file);</highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="141"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="142"><highlight class="normal">}</highlight></codeline>
<codeline lineno="143"><highlight class="normal"></highlight></codeline>
<codeline lineno="144"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="fs__helpers_8cpp_1acb8d6b822bc1bfa609bf43bbac1a0d44" kindref="member">TruncateFile</ref>(FILE*<sp/>file,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>length)</highlight></codeline>
<codeline lineno="145"><highlight class="normal">{</highlight></codeline>
<codeline lineno="146"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>defined(WIN32)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>_chsize(_fileno(file),<sp/>length)<sp/>==<sp/>0;</highlight></codeline>
<codeline lineno="148"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="149"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ftruncate(fileno(file),<sp/>length)<sp/>==<sp/>0;</highlight></codeline>
<codeline lineno="150"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="151"><highlight class="normal">}</highlight></codeline>
<codeline lineno="152"><highlight class="normal"></highlight></codeline>
<codeline lineno="157"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="fs__helpers_8cpp_1a756a5c49a4bb607d16d9842f8f3ede4f" kindref="member">RaiseFileDescriptorLimit</ref>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nMinFD)</highlight></codeline>
<codeline lineno="158"><highlight class="normal">{</highlight></codeline>
<codeline lineno="159"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>defined(WIN32)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>2048;</highlight></codeline>
<codeline lineno="161"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">rlimit<sp/>limitFD;</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(getrlimit(RLIMIT_NOFILE,<sp/>&amp;limitFD)<sp/>!=<sp/>-1)<sp/>{</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(limitFD.rlim_cur<sp/>&lt;<sp/>(rlim_t)nMinFD)<sp/>{</highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>limitFD.rlim_cur<sp/>=<sp/>nMinFD;</highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(limitFD.rlim_cur<sp/>&gt;<sp/>limitFD.rlim_max)</highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>limitFD.rlim_cur<sp/>=<sp/>limitFD.rlim_max;</highlight></codeline>
<codeline lineno="168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>setrlimit(RLIMIT_NOFILE,<sp/>&amp;limitFD);</highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>getrlimit(RLIMIT_NOFILE,<sp/>&amp;limitFD);</highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>limitFD.rlim_cur;</highlight></codeline>
<codeline lineno="172"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>nMinFD;<sp/></highlight><highlight class="comment">//<sp/>getrlimit<sp/>failed,<sp/>assume<sp/>it&apos;s<sp/>fine</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="174"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="175"><highlight class="normal">}</highlight></codeline>
<codeline lineno="176"><highlight class="normal"></highlight></codeline>
<codeline lineno="181"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="fs__helpers_8cpp_1a91c763bffc49cf7ed8d45cc44870e55c" kindref="member">AllocateFileRange</ref>(FILE*<sp/>file,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>offset,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>length)</highlight></codeline>
<codeline lineno="182"><highlight class="normal">{</highlight></codeline>
<codeline lineno="183"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>defined(WIN32)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Windows-specific<sp/>version</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/><sp/><sp/>HANDLE<sp/>hFile<sp/>=<sp/>(HANDLE)_get_osfhandle(_fileno(file));</highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/><sp/><sp/>LARGE_INTEGER<sp/>nFileSize;</highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/>int64_t<sp/>nEndPos<sp/>=<sp/>(int64_t)offset<sp/>+<sp/>length;</highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><sp/><sp/>nFileSize.u.LowPart<sp/>=<sp/>nEndPos<sp/>&amp;<sp/>0xFFFFFFFF;</highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/>nFileSize.u.HighPart<sp/>=<sp/>nEndPos<sp/>&gt;&gt;<sp/>32;</highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/><sp/><sp/>SetFilePointerEx(hFile,<sp/>nFileSize,<sp/>0,<sp/>FILE_BEGIN);</highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/><sp/><sp/>SetEndOfFile(hFile);</highlight></codeline>
<codeline lineno="192"><highlight class="normal"></highlight><highlight class="preprocessor">#elif<sp/>defined(__APPLE__)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>OSX<sp/>specific<sp/>version</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>NOTE:<sp/>Contrary<sp/>to<sp/>other<sp/>OS<sp/>versions,<sp/>the<sp/>OSX<sp/>version<sp/>assumes<sp/>that</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>NOTE:<sp/>offset<sp/>is<sp/>the<sp/>size<sp/>of<sp/>the<sp/>file.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/>fstore_t<sp/>fst;</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/>fst.fst_flags<sp/>=<sp/>F_ALLOCATECONTIG;</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/><sp/><sp/>fst.fst_posmode<sp/>=<sp/>F_PEOFPOSMODE;</highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/><sp/><sp/>fst.fst_offset<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/><sp/><sp/>fst.fst_length<sp/>=<sp/>length;<sp/></highlight><highlight class="comment">//<sp/>mac<sp/>os<sp/>fst_length<sp/>takes<sp/>the<sp/>#<sp/>of<sp/>free<sp/>bytes<sp/>to<sp/>allocate,<sp/>not<sp/>desired<sp/>file<sp/>size</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/><sp/><sp/>fst.fst_bytesalloc<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fcntl(fileno(file),<sp/>F_PREALLOCATE,<sp/>&amp;fst)<sp/>==<sp/>-1)<sp/>{</highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fst.fst_flags<sp/>=<sp/>F_ALLOCATEALL;</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fcntl(fileno(file),<sp/>F_PREALLOCATE,<sp/>&amp;fst);</highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/><sp/><sp/>ftruncate(fileno(file),<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="normal">off_t</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(offset)<sp/>+<sp/>length);</highlight></codeline>
<codeline lineno="207"><highlight class="normal"></highlight><highlight class="preprocessor">#else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="208"><highlight class="normal"></highlight><highlight class="preprocessor">#if<sp/>defined(HAVE_POSIX_FALLOCATE)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Version<sp/>using<sp/>posix_fallocate</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/>off_t<sp/>nEndPos<sp/>=<sp/>(off_t)offset<sp/>+<sp/>length;</highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(0<sp/>==<sp/>posix_fallocate(fileno(file),<sp/>0,<sp/>nEndPos))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="212"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Fallback<sp/>version</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>TODO:<sp/>just<sp/>write<sp/>one<sp/>byte<sp/>per<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>buf[65536]<sp/>=<sp/>{};</highlight></codeline>
<codeline lineno="216"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fseek(file,<sp/>offset,<sp/>SEEK_SET))<sp/>{</highlight></codeline>
<codeline lineno="217"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="218"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="219"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(length<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>now<sp/>=<sp/>65536;</highlight></codeline>
<codeline lineno="221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(length<sp/>&lt;<sp/>now)</highlight></codeline>
<codeline lineno="222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>now<sp/>=<sp/>length;</highlight></codeline>
<codeline lineno="223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fwrite(buf,<sp/>1,<sp/>now,<sp/>file);<sp/></highlight><highlight class="comment">//<sp/>allowed<sp/>to<sp/>fail;<sp/>this<sp/>function<sp/>is<sp/>advisory<sp/>anyway</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>length<sp/>-=<sp/>now;</highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="226"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="227"><highlight class="normal">}</highlight></codeline>
<codeline lineno="228"><highlight class="normal"></highlight></codeline>
<codeline lineno="229"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>WIN32</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="230"><highlight class="normal">fs::path<sp/>GetSpecialFolderPath(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nFolder,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fCreate)</highlight></codeline>
<codeline lineno="231"><highlight class="normal">{</highlight></codeline>
<codeline lineno="232"><highlight class="normal"><sp/><sp/><sp/><sp/>WCHAR<sp/>pszPath[<ref refid="compat_8h_1ab99ded389af74001a6298fc9e44e74e5" kindref="member">MAX_PATH</ref>]<sp/>=<sp/>L</highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="233"><highlight class="normal"></highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(SHGetSpecialFolderPathW(</highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">,<sp/>pszPath,<sp/>nFolder,<sp/>fCreate))<sp/>{</highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>fs::path(pszPath);</highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="237"><highlight class="normal"></highlight></codeline>
<codeline lineno="238"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;SHGetSpecialFolderPathW()<sp/>failed,<sp/>could<sp/>not<sp/>obtain<sp/>requested<sp/>path.&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>fs::path(</highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="240"><highlight class="normal">}</highlight></codeline>
<codeline lineno="241"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="242"><highlight class="normal"></highlight></codeline>
<codeline lineno="243"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="fs__helpers_8cpp_1a579657da2b55b131ecd453bf1b0d2314" kindref="member">RenameOver</ref>(fs::path<sp/>src,<sp/>fs::path<sp/>dest)</highlight></codeline>
<codeline lineno="244"><highlight class="normal">{</highlight></codeline>
<codeline lineno="245"><highlight class="normal"><sp/><sp/><sp/><sp/>std::error_code<sp/>error;</highlight></codeline>
<codeline lineno="246"><highlight class="normal"><sp/><sp/><sp/><sp/>fs::rename(src,<sp/>dest,<sp/>error);</highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>!error;</highlight></codeline>
<codeline lineno="248"><highlight class="normal">}</highlight></codeline>
<codeline lineno="249"><highlight class="normal"></highlight></codeline>
<codeline lineno="255"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="fs__helpers_8cpp_1a9042a919d837da9d97311a0c460c597c" kindref="member">TryCreateDirectories</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::path&amp;<sp/>p)</highlight></codeline>
<codeline lineno="256"><highlight class="normal">{</highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>fs::create_directories(p);</highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::filesystem_error&amp;)<sp/>{</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!fs::exists(p)<sp/>||<sp/>!fs::is_directory(p))</highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="263"><highlight class="normal"></highlight></codeline>
<codeline lineno="264"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>create_directories<sp/>didn&apos;t<sp/>create<sp/>the<sp/>directory,<sp/>it<sp/>had<sp/>to<sp/>have<sp/>existed<sp/>already</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="266"><highlight class="normal">}</highlight></codeline>
<codeline lineno="267"><highlight class="normal"></highlight></codeline>
<codeline lineno="268"><highlight class="normal">std::string<sp/><ref refid="fs__helpers_8cpp_1ae34526a9ca0bc46252b39f5f7bde63db" kindref="member">PermsToSymbolicString</ref>(fs::perms<sp/>p)</highlight></codeline>
<codeline lineno="269"><highlight class="normal">{</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/><sp/><sp/>std::string<sp/>perm_str(9,<sp/></highlight><highlight class="charliteral">&apos;-&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="271"><highlight class="normal"></highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>set_perm<sp/>=<sp/>[&amp;](</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>pos,<sp/>fs::perms<sp/>required_perm,<sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>letter)<sp/>{</highlight></codeline>
<codeline lineno="273"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((p<sp/>&amp;<sp/>required_perm)<sp/>!=<sp/>fs::perms::none)<sp/>{</highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>perm_str[pos]<sp/>=<sp/>letter;</highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="277"><highlight class="normal"></highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/>set_perm(0,<sp/>fs::perms::owner_read,<sp/><sp/><sp/></highlight><highlight class="charliteral">&apos;r&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/>set_perm(1,<sp/>fs::perms::owner_write,<sp/><sp/></highlight><highlight class="charliteral">&apos;w&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/>set_perm(2,<sp/>fs::perms::owner_exec,<sp/><sp/><sp/></highlight><highlight class="charliteral">&apos;x&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/>set_perm(3,<sp/>fs::perms::group_read,<sp/><sp/><sp/></highlight><highlight class="charliteral">&apos;r&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/><sp/><sp/>set_perm(4,<sp/>fs::perms::group_write,<sp/><sp/></highlight><highlight class="charliteral">&apos;w&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="283"><highlight class="normal"><sp/><sp/><sp/><sp/>set_perm(5,<sp/>fs::perms::group_exec,<sp/><sp/><sp/></highlight><highlight class="charliteral">&apos;x&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/><sp/><sp/>set_perm(6,<sp/>fs::perms::others_read,<sp/><sp/></highlight><highlight class="charliteral">&apos;r&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/><sp/><sp/>set_perm(7,<sp/>fs::perms::others_write,<sp/></highlight><highlight class="charliteral">&apos;w&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/><sp/><sp/>set_perm(8,<sp/>fs::perms::others_exec,<sp/><sp/></highlight><highlight class="charliteral">&apos;x&apos;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="287"><highlight class="normal"></highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>perm_str;</highlight></codeline>
<codeline lineno="289"><highlight class="normal">}</highlight></codeline>
<codeline lineno="290"><highlight class="normal"></highlight></codeline>
<codeline lineno="291"><highlight class="normal">std::optional&lt;fs::perms&gt;<sp/><ref refid="fs__helpers_8cpp_1abc0b553e20da0fcce0c071a85a1ec1ea" kindref="member">InterpretPermString</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::string&amp;<sp/>s)</highlight></codeline>
<codeline lineno="292"><highlight class="normal">{</highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(s<sp/>==<sp/></highlight><highlight class="stringliteral">&quot;owner&quot;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>fs::perms::owner_read<sp/>|<sp/>fs::perms::owner_write;</highlight></codeline>
<codeline lineno="295"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(s<sp/>==<sp/></highlight><highlight class="stringliteral">&quot;group&quot;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>fs::perms::owner_read<sp/>|<sp/>fs::perms::owner_write<sp/>|</highlight></codeline>
<codeline lineno="297"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs::perms::group_read;</highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(s<sp/>==<sp/></highlight><highlight class="stringliteral">&quot;all&quot;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>fs::perms::owner_read<sp/>|<sp/>fs::perms::owner_write<sp/>|</highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs::perms::group_read<sp/>|</highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fs::perms::others_read;</highlight></codeline>
<codeline lineno="302"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::nullopt;</highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="305"><highlight class="normal">}</highlight></codeline>
<codeline lineno="306"><highlight class="normal"></highlight></codeline>
<codeline lineno="307"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>__APPLE__</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="308"><highlight class="normal">FSType<sp/>GetFilesystemType(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::path&amp;<sp/>path)</highlight></codeline>
<codeline lineno="309"><highlight class="normal">{</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">struct</highlight><highlight class="normal"><sp/>statfs<sp/>fs_info;<sp/>statfs(path.c_str(),<sp/>&amp;fs_info))<sp/>{</highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FSType::ERROR;</highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(std::string_view{fs_info.f_fstypename}<sp/>==<sp/></highlight><highlight class="stringliteral">&quot;exfat&quot;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FSType::EXFAT;</highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="315"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>FSType::OTHER;</highlight></codeline>
<codeline lineno="316"><highlight class="normal">}</highlight></codeline>
<codeline lineno="317"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight></codeline>
    </programlisting>
    <location file="src/util/fs_helpers.cpp"/>
  </compounddef>
</doxygen>
