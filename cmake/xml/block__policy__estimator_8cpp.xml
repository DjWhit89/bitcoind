<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.15.0" xml:lang="en-US">
  <compounddef id="block__policy__estimator_8cpp" kind="file" language="C++">
    <compoundname>block_policy_estimator.cpp</compoundname>
    <includes refid="block__policy__estimator_8h" local="no">policy/fees/block_policy_estimator.h</includes>
    <includes refid="system_8h" local="no">common/system.h</includes>
    <includes refid="amount_8h" local="no">consensus/amount.h</includes>
    <includes refid="mempool__entry_8h" local="no">kernel/mempool_entry.h</includes>
    <includes local="no">logging.h</includes>
    <includes refid="feerate_8h" local="no">policy/feerate.h</includes>
    <includes refid="primitives_2transaction_8h" local="no">primitives/transaction.h</includes>
    <includes local="no">random.h</includes>
    <includes refid="serialize_8h" local="no">serialize.h</includes>
    <includes refid="streams_8h" local="no">streams.h</includes>
    <includes refid="sync_8h" local="no">sync.h</includes>
    <includes refid="tinyformat_8h" local="no">tinyformat.h</includes>
    <includes refid="uint256_8h" local="no">uint256.h</includes>
    <includes refid="fs_8h" local="no">util/fs.h</includes>
    <includes refid="serfloat_8h" local="no">util/serfloat.h</includes>
    <includes refid="syserror_8h" local="no">util/syserror.h</includes>
    <includes local="no">util/time.h</includes>
    <includes local="no">algorithm</includes>
    <includes local="no">cassert</includes>
    <includes local="no">chrono</includes>
    <includes local="no">cmath</includes>
    <includes local="no">cstddef</includes>
    <includes local="no">cstdint</includes>
    <includes local="no">exception</includes>
    <includes local="no">stdexcept</includes>
    <includes local="no">utility</includes>
    <incdepgraph>
      <node id="7">
        <label>attributes.h</label>
        <link refid="attributes_8h"/>
      </node>
      <node id="75">
        <label>common/system.h</label>
        <link refid="system_8h"/>
        <childnode refid="76" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="54" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="8">
        <label>compat/assumptions.h</label>
        <link refid="compat_2assumptions_8h"/>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="12">
        <label>compat/byteswap.h</label>
        <link refid="byteswap_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="11">
        <label>compat/endian.h</label>
        <link refid="endian_8h"/>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="3">
        <label>consensus/amount.h</label>
        <link refid="amount_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="79">
        <label>consensus/consensus.h</label>
        <link refid="consensus_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
      </node>
      <node id="78">
        <label>consensus/validation.h</label>
        <link refid="consensus_2validation_8h"/>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
      </node>
      <node id="82">
        <label>core_memusage.h</label>
        <link refid="core__memusage_8h"/>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
        <childnode refid="83" relation="include">
        </childnode>
      </node>
      <node id="46">
        <label>crypto/common.h</label>
        <link refid="crypto_2common_8h"/>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
      </node>
      <node id="48">
        <label>crypto/hex_base.h</label>
        <link refid="hex__base_8h"/>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="104">
        <label>crypto/siphash.h</label>
        <link refid="siphash_8h"/>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
      </node>
      <node id="84">
        <label>indirectmap.h</label>
        <link refid="indirectmap_8h"/>
        <childnode refid="26" relation="include">
        </childnode>
      </node>
      <node id="65">
        <label>kernel/cs_main.h</label>
        <link refid="cs__main_8h"/>
        <childnode refid="39" relation="include">
        </childnode>
      </node>
      <node id="77">
        <label>kernel/mempool_entry.h</label>
        <link refid="mempool__entry_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="78" relation="include">
        </childnode>
        <childnode refid="82" relation="include">
        </childnode>
        <childnode refid="90" relation="include">
        </childnode>
        <childnode refid="96" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="97" relation="include">
        </childnode>
        <childnode refid="98" relation="include">
        </childnode>
        <childnode refid="99" relation="include">
        </childnode>
        <childnode refid="74" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="61" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
      </node>
      <node id="103">
        <label>logging.h</label>
        <link refid="logging_8h"/>
        <childnode refid="104" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
        <childnode refid="32" relation="include">
        </childnode>
        <childnode refid="56" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="105" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="61" relation="include">
        </childnode>
        <childnode refid="86" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="88" relation="include">
        </childnode>
        <childnode refid="89" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
      </node>
      <node id="83">
        <label>memusage.h</label>
        <link refid="memusage_8h"/>
        <childnode refid="84" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="85" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="86" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="88" relation="include">
        </childnode>
        <childnode refid="89" relation="include">
        </childnode>
      </node>
      <node id="5">
        <label>policy/feerate.h</label>
        <link refid="feerate_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="31" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
      </node>
      <node id="1">
        <label>src/policy/fees/block_policy_estimator.cpp</label>
        <link refid="block__policy__estimator_8cpp"/>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="75" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="77" relation="include">
        </childnode>
        <childnode refid="101" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="102" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="56" relation="include">
        </childnode>
        <childnode refid="110" relation="include">
        </childnode>
        <childnode refid="109" relation="include">
        </childnode>
        <childnode refid="81" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="74" relation="include">
        </childnode>
        <childnode refid="111" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="112" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
      </node>
      <node id="2">
        <label>policy/fees/block_policy_estimator.h</label>
        <link refid="block__policy__estimator_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="56" relation="include">
        </childnode>
        <childnode refid="64" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="74" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
      </node>
      <node id="90">
        <label>policy/policy.h</label>
        <link refid="policy_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="91" relation="include">
        </childnode>
        <childnode refid="95" relation="include">
        </childnode>
        <childnode refid="31" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="96">
        <label>policy/settings.h</label>
        <link refid="policy_2settings_8h"/>
      </node>
      <node id="14">
        <label>prevector.h</label>
        <link refid="prevector_8h"/>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
      </node>
      <node id="80">
        <label>primitives/block.h</label>
        <link refid="primitives_2block_8h"/>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="81" relation="include">
        </childnode>
      </node>
      <node id="66">
        <label>primitives/transaction.h</label>
        <link refid="primitives_2transaction_8h"/>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="71" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="73" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="69" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
      </node>
      <node id="67">
        <label>primitives/transaction_identifier.h</label>
        <link refid="transaction__identifier_8h"/>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="37" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="69" relation="include">
        </childnode>
        <childnode refid="70" relation="include">
        </childnode>
      </node>
      <node id="91">
        <label>script/interpreter.h</label>
        <link refid="interpreter_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="92" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="93" relation="include">
        </childnode>
        <childnode refid="94" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="54" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
      </node>
      <node id="71">
        <label>script/script.h</label>
        <link refid="script_2script_8h"/>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="46" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="72" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
      </node>
      <node id="93">
        <label>script/script_error.h</label>
        <link refid="script__error_8h"/>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="95">
        <label>script/solver.h</label>
        <link refid="solver_8h"/>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="71" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="54" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
      </node>
      <node id="94">
        <label>script/verify_flags.h</label>
        <link refid="verify__flags_8h"/>
        <childnode refid="37" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="6">
        <label>serialize.h</label>
        <link refid="serialize_8h"/>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
      </node>
      <node id="22">
        <label>span.h</label>
        <link refid="span_8h"/>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
      </node>
      <node id="102">
        <label>streams.h</label>
        <link refid="streams_8h"/>
        <childnode refid="103" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="106" relation="include">
        </childnode>
        <childnode refid="32" relation="include">
        </childnode>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="99" relation="include">
        </childnode>
        <childnode refid="109" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="54" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
      </node>
      <node id="85">
        <label>support/allocators/pool.h</label>
        <link refid="pool_8h"/>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="86" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="87" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="32" relation="include">
        </childnode>
      </node>
      <node id="106">
        <label>support/allocators/zeroafterfree.h</label>
        <link refid="zeroafterfree_8h"/>
        <childnode refid="107" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
      </node>
      <node id="107">
        <label>support/cleanse.h</label>
        <link refid="cleanse_8h"/>
        <childnode refid="17" relation="include">
        </childnode>
      </node>
      <node id="39">
        <label>sync.h</label>
        <link refid="sync_8h"/>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
      </node>
      <node id="40">
        <label>threadsafety.h</label>
        <link refid="threadsafety_8h"/>
        <childnode refid="41" relation="include">
        </childnode>
      </node>
      <node id="57">
        <label>tinyformat.h</label>
        <link refid="tinyformat_8h"/>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="58" relation="include">
        </childnode>
        <childnode refid="52" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
      </node>
      <node id="97">
        <label>txgraph.h</label>
        <link refid="txgraph_8h"/>
        <childnode refid="37" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="54" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="31" relation="include">
        </childnode>
      </node>
      <node id="45">
        <label>uint256.h</label>
        <link refid="uint256_8h"/>
        <childnode refid="46" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="54" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
      </node>
      <node id="32">
        <label>util/check.h</label>
        <link refid="check_8h"/>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
      </node>
      <node id="98">
        <label>util/epochguard.h</label>
        <link refid="epochguard_8h"/>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
      </node>
      <node id="31">
        <label>util/feefrac.h</label>
        <link refid="feefrac_8h"/>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="32" relation="include">
        </childnode>
        <childnode refid="37" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
      </node>
      <node id="56">
        <label>util/fs.h</label>
        <link refid="fs_8h"/>
        <childnode refid="57" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="60" relation="include">
        </childnode>
        <childnode refid="61" relation="include">
        </childnode>
        <childnode refid="62" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="63" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
      </node>
      <node id="72">
        <label>util/hash_type.h</label>
        <link refid="hash__type_8h"/>
      </node>
      <node id="42">
        <label>util/macros.h</label>
        <link refid="macros_8h"/>
      </node>
      <node id="108">
        <label>util/obfuscation.h</label>
        <link refid="obfuscation_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="100" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
      </node>
      <node id="99">
        <label>util/overflow.h</label>
        <link refid="overflow_8h"/>
        <childnode refid="100" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="54" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
      </node>
      <node id="110">
        <label>util/serfloat.h</label>
        <link refid="serfloat_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="47">
        <label>util/strencodings.h</label>
        <link refid="strencodings_8h"/>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="53" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="54" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
      </node>
      <node id="49">
        <label>util/string.h</label>
        <link refid="string_8h"/>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="51" relation="include">
        </childnode>
        <childnode refid="52" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
      </node>
      <node id="109">
        <label>util/syserror.h</label>
        <link refid="syserror_8h"/>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="105">
        <label>util/time.h</label>
        <link refid="util_2time_8h"/>
        <childnode refid="74" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="54" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
      </node>
      <node id="68">
        <label>util/types.h</label>
        <link refid="util_2types_8h"/>
      </node>
      <node id="64">
        <label>validationinterface.h</label>
        <link refid="validationinterface_8h"/>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="61" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
      </node>
      <node id="15">
        <label>algorithm</label>
      </node>
      <node id="50">
        <label>array</label>
      </node>
      <node id="33">
        <label>atomic</label>
      </node>
      <node id="13">
        <label>bit</label>
      </node>
      <node id="76">
        <label>bitcoin-build-config.h</label>
      </node>
      <node id="16">
        <label>cassert</label>
      </node>
      <node id="53">
        <label>charconv</label>
      </node>
      <node id="74">
        <label>chrono</label>
      </node>
      <node id="100">
        <label>climits</label>
      </node>
      <node id="111">
        <label>cmath</label>
      </node>
      <node id="37">
        <label>compare</label>
      </node>
      <node id="24">
        <label>concepts</label>
      </node>
      <node id="43">
        <label>condition_variable</label>
      </node>
      <node id="9">
        <label>cstddef</label>
      </node>
      <node id="4">
        <label>cstdint</label>
      </node>
      <node id="59">
        <label>cstdio</label>
      </node>
      <node id="17">
        <label>cstdlib</label>
      </node>
      <node id="18">
        <label>cstring</label>
      </node>
      <node id="112">
        <label>exception</label>
      </node>
      <node id="60">
        <label>filesystem</label>
      </node>
      <node id="61">
        <label>functional</label>
      </node>
      <node id="92">
        <label>hash.h</label>
      </node>
      <node id="62">
        <label>iomanip</label>
      </node>
      <node id="25">
        <label>ios</label>
      </node>
      <node id="58">
        <label>iostream</label>
      </node>
      <node id="19">
        <label>iterator</label>
      </node>
      <node id="10">
        <label>limits</label>
      </node>
      <node id="86">
        <label>list</label>
      </node>
      <node id="51">
        <label>locale</label>
      </node>
      <node id="101">
        <label>logging.h</label>
      </node>
      <node id="26">
        <label>map</label>
      </node>
      <node id="27">
        <label>memory</label>
      </node>
      <node id="41">
        <label>mutex</label>
      </node>
      <node id="87">
        <label>new</label>
      </node>
      <node id="73">
        <label>numeric</label>
      </node>
      <node id="54">
        <label>optional</label>
      </node>
      <node id="63">
        <label>ostream</label>
      </node>
      <node id="38">
        <label>random.h</label>
      </node>
      <node id="28">
        <label>set</label>
      </node>
      <node id="34">
        <label>source_location</label>
      </node>
      <node id="23">
        <label>span</label>
      </node>
      <node id="52">
        <label>sstream</label>
      </node>
      <node id="35">
        <label>stdexcept</label>
      </node>
      <node id="29">
        <label>string</label>
      </node>
      <node id="36">
        <label>string_view</label>
      </node>
      <node id="55">
        <label>system_error</label>
      </node>
      <node id="44">
        <label>thread</label>
      </node>
      <node id="69">
        <label>tuple</label>
      </node>
      <node id="20">
        <label>type_traits</label>
      </node>
      <node id="88">
        <label>unordered_map</label>
      </node>
      <node id="89">
        <label>unordered_set</label>
      </node>
      <node id="81">
        <label>util/time.h</label>
      </node>
      <node id="21">
        <label>utility</label>
      </node>
      <node id="70">
        <label>variant</label>
      </node>
      <node id="30">
        <label>vector</label>
      </node>
    </incdepgraph>
    <innerclass refid="class_tx_confirm_stats" prot="public">TxConfirmStats</innerclass>
    <sectiondef kind="var">
      <memberdef kind="variable" id="block__policy__estimator_8cpp_1a7b6bea4ad824d119546ccc55158e72d8" prot="public" static="no" constexpr="yes" mutable="no">
        <type>int</type>
        <definition>int CURRENT_FEES_FILE_VERSION</definition>
        <argsstring></argsstring>
        <name>CURRENT_FEES_FILE_VERSION</name>
        <initializer>{149900}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/policy/fees/block_policy_estimator.cpp" line="37" column="15" bodyfile="src/policy/fees/block_policy_estimator.cpp" bodystart="37" bodyend="37"/>
      </memberdef>
      <memberdef kind="variable" id="block__policy__estimator_8cpp_1a0ce249bfa9acd6e939190dfa757852a1" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>double</type>
        <definition>double INF_FEERATE</definition>
        <argsstring></argsstring>
        <name>INF_FEERATE</name>
        <initializer>= 1e99</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/policy/fees/block_policy_estimator.cpp" line="39" column="25" bodyfile="src/policy/fees/block_policy_estimator.cpp" bodystart="39" bodyend="-1"/>
      </memberdef>
    </sectiondef>
    <sectiondef kind="func">
      <memberdef kind="function" id="block__policy__estimator_8cpp_1ab3463ec40515841c25b50c1003c72108" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>std::string</type>
        <definition>std::string StringForFeeEstimateHorizon</definition>
        <argsstring>(FeeEstimateHorizon horizon)</argsstring>
        <name>StringForFeeEstimateHorizon</name>
        <param>
          <type><ref refid="block__policy__estimator_8h_1a8e4bdf4356d17e4e14401a8c92da04f2" kindref="member">FeeEstimateHorizon</ref></type>
          <declname>horizon</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/policy/fees/block_policy_estimator.cpp" line="41" column="13" bodyfile="src/policy/fees/block_policy_estimator.cpp" bodystart="41" bodyend="49"/>
      </memberdef>
      <memberdef kind="function" id="block__policy__estimator_8cpp_1a1a388eb0a94bed848f75ce492b6027e1" prot="public" static="yes" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>std::set&lt; double &gt;</type>
        <definition>static std::set&lt; double &gt; MakeFeeSet</definition>
        <argsstring>(const CFeeRate &amp;min_incremental_fee, double max_filter_fee_rate, double fee_filter_spacing)</argsstring>
        <name>MakeFeeSet</name>
        <param>
          <type>const <ref refid="class_c_fee_rate" kindref="compound">CFeeRate</ref> &amp;</type>
          <declname>min_incremental_fee</declname>
        </param>
        <param>
          <type>double</type>
          <declname>max_filter_fee_rate</declname>
        </param>
        <param>
          <type>double</type>
          <declname>fee_filter_spacing</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/policy/fees/block_policy_estimator.cpp" line="1086" column="17" bodyfile="src/policy/fees/block_policy_estimator.cpp" bodystart="1086" bodyend="1102"/>
      </memberdef>
    </sectiondef>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="comment">//<sp/>Copyright<sp/>(c)<sp/>2009-2010<sp/>Satoshi<sp/>Nakamoto</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Copyright<sp/>(c)<sp/>2009-present<sp/>The<sp/>Bitcoin<sp/>Core<sp/>developers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Distributed<sp/>under<sp/>the<sp/>MIT<sp/>software<sp/>license,<sp/>see<sp/>the<sp/>accompanying</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4"><highlight class="normal"></highlight><highlight class="comment">//<sp/>file<sp/>COPYING<sp/>or<sp/>http://www.opensource.org/licenses/mit-license.php.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5"><highlight class="normal"></highlight></codeline>
<codeline lineno="6"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="block__policy__estimator_8h" kindref="compound">policy/fees/block_policy_estimator.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="system_8h" kindref="compound">common/system.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="amount_8h" kindref="compound">consensus/amount.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="mempool__entry_8h" kindref="compound">kernel/mempool_entry.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;logging.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="feerate_8h" kindref="compound">policy/feerate.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="13"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="primitives_2transaction_8h" kindref="compound">primitives/transaction.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="14"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;random.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="15"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="serialize_8h" kindref="compound">serialize.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="16"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="streams_8h" kindref="compound">streams.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="17"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="sync_8h" kindref="compound">sync.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="18"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="tinyformat_8h" kindref="compound">tinyformat.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="19"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="uint256_8h" kindref="compound">uint256.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="20"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="fs_8h" kindref="compound">util/fs.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="21"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="serfloat_8h" kindref="compound">util/serfloat.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="22"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="syserror_8h" kindref="compound">util/syserror.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="23"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;util/time.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="24"><highlight class="normal"></highlight></codeline>
<codeline lineno="25"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;algorithm&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="26"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;cassert&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="27"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;chrono&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="28"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;cmath&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="29"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;cstddef&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="30"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;cstdint&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="31"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;exception&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="32"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;stdexcept&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="33"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;utility&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="34"><highlight class="normal"></highlight></codeline>
<codeline lineno="35"><highlight class="normal"></highlight><highlight class="comment">//<sp/>The<sp/>current<sp/>format<sp/>written,<sp/>and<sp/>the<sp/>version<sp/>required<sp/>to<sp/>read.<sp/>Must<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="36"><highlight class="normal"></highlight><highlight class="comment">//<sp/>increased<sp/>to<sp/>at<sp/>least<sp/>289900+1<sp/>on<sp/>the<sp/>next<sp/>breaking<sp/>change.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="37"><highlight class="normal"></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="block__policy__estimator_8cpp_1a7b6bea4ad824d119546ccc55158e72d8" kindref="member">CURRENT_FEES_FILE_VERSION</ref>{149900};</highlight></codeline>
<codeline lineno="38"><highlight class="normal"></highlight></codeline>
<codeline lineno="39"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>INF_FEERATE<sp/>=<sp/>1e99;</highlight></codeline>
<codeline lineno="40"><highlight class="normal"></highlight></codeline>
<codeline lineno="41"><highlight class="normal">std::string<sp/><ref refid="block__policy__estimator_8cpp_1ab3463ec40515841c25b50c1003c72108" kindref="member">StringForFeeEstimateHorizon</ref>(<ref refid="block__policy__estimator_8h_1a8e4bdf4356d17e4e14401a8c92da04f2" kindref="member">FeeEstimateHorizon</ref><sp/>horizon)</highlight></codeline>
<codeline lineno="42"><highlight class="normal">{</highlight></codeline>
<codeline lineno="43"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(horizon)<sp/>{</highlight></codeline>
<codeline lineno="44"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="block__policy__estimator_8h_1a8e4bdf4356d17e4e14401a8c92da04f2a55535e5be30f4713167dd5225a9b89c6" kindref="member">FeeEstimateHorizon::SHORT_HALFLIFE</ref>:<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;short&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="45"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="block__policy__estimator_8h_1a8e4bdf4356d17e4e14401a8c92da04f2a8411fd05f06f8ddba21bddb6c720635e" kindref="member">FeeEstimateHorizon::MED_HALFLIFE</ref>:<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;medium&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="46"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="block__policy__estimator_8h_1a8e4bdf4356d17e4e14401a8c92da04f2a2121a90b0e675bc3669cbb1ef9d1dfb6" kindref="member">FeeEstimateHorizon::LONG_HALFLIFE</ref>:<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;long&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="47"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>no<sp/>default<sp/>case,<sp/>so<sp/>the<sp/>compiler<sp/>can<sp/>warn<sp/>about<sp/>missing<sp/>cases</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="48"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(</highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="49"><highlight class="normal">}</highlight></codeline>
<codeline lineno="50"><highlight class="normal"></highlight></codeline>
<codeline lineno="51"><highlight class="normal"></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="52"><highlight class="normal"></highlight></codeline>
<codeline lineno="53"><highlight class="normal"></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">EncodedDoubleFormatter</highlight></codeline>
<codeline lineno="54"><highlight class="normal">{</highlight></codeline>
<codeline lineno="55"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">typename</highlight><highlight class="normal"><sp/>Stream&gt;<sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>Ser(Stream<sp/>&amp;s,<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>v)</highlight></codeline>
<codeline lineno="56"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="57"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacetest__vectors__musig2__generate_1a5fcf9c70fa717a8efd481752dcb8ffa4" kindref="member">s</ref><sp/>&lt;&lt;<sp/><ref refid="serfloat_8cpp_1a8bb70ab23daf4f7c32be7e3accd7e504" kindref="member">EncodeDouble</ref>(v);</highlight></codeline>
<codeline lineno="58"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="59"><highlight class="normal"></highlight></codeline>
<codeline lineno="60"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">typename</highlight><highlight class="normal"><sp/>Stream&gt;<sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>Unser(Stream&amp;<sp/>s,<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal">&amp;<sp/>v)</highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>encoded;</highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacetest__vectors__musig2__generate_1a5fcf9c70fa717a8efd481752dcb8ffa4" kindref="member">s</ref><sp/>&gt;&gt;<sp/>encoded;</highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>v<sp/>=<sp/><ref refid="serfloat_8cpp_1a99ab89e8094a7ba5650d3a673f242556" kindref="member">DecodeDouble</ref>(encoded);</highlight></codeline>
<codeline lineno="65"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="66"><highlight class="normal">};</highlight></codeline>
<codeline lineno="67"><highlight class="normal"></highlight></codeline>
<codeline lineno="68"><highlight class="normal">}<sp/></highlight><highlight class="comment">//<sp/>namespace</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="69"><highlight class="normal"></highlight></codeline>
<codeline lineno="78" refid="class_tx_confirm_stats" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="class_tx_confirm_stats_1ac7b4481c4965b9c4c17c8cf0990331c4" kindref="member">TxConfirmStats</ref></highlight></codeline>
<codeline lineno="79"><highlight class="normal">{</highlight></codeline>
<codeline lineno="80"><highlight class="normal"></highlight><highlight class="keyword">private</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//Define<sp/>the<sp/>buckets<sp/>we<sp/>will<sp/>group<sp/>transactions<sp/>into</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;double&gt;&amp;<sp/>buckets;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>upper-bound<sp/>of<sp/>the<sp/>range<sp/>for<sp/>the<sp/>bucket<sp/>(inclusive)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::map&lt;double,<sp/>unsigned<sp/>int&gt;&amp;<sp/>bucketMap;<sp/></highlight><highlight class="comment">//<sp/>Map<sp/>of<sp/>bucket<sp/>upper-bound<sp/>to<sp/>index<sp/>into<sp/>all<sp/>vectors<sp/>by<sp/>bucket</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="84"><highlight class="normal"></highlight></codeline>
<codeline lineno="85"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>For<sp/>each<sp/>bucket<sp/>X:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="86"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Count<sp/>the<sp/>total<sp/>#<sp/>of<sp/>txs<sp/>in<sp/>each<sp/>bucket</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="87"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Track<sp/>the<sp/>historical<sp/>moving<sp/>average<sp/>of<sp/>this<sp/>total<sp/>over<sp/>blocks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="88"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;double&gt;<sp/>txCtAvg;</highlight></codeline>
<codeline lineno="89"><highlight class="normal"></highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Count<sp/>the<sp/>total<sp/>#<sp/>of<sp/>txs<sp/>confirmed<sp/>within<sp/>Y<sp/>blocks<sp/>in<sp/>each<sp/>bucket</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="91"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Track<sp/>the<sp/>historical<sp/>moving<sp/>average<sp/>of<sp/>these<sp/>totals<sp/>over<sp/>blocks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;std::vector&lt;double&gt;&gt;<sp/>confAvg;<sp/></highlight><highlight class="comment">//<sp/>confAvg[Y][X]</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="93"><highlight class="normal"></highlight></codeline>
<codeline lineno="94"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Track<sp/>moving<sp/>avg<sp/>of<sp/>txs<sp/>which<sp/>have<sp/>been<sp/>evicted<sp/>from<sp/>the<sp/>mempool</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>after<sp/>failing<sp/>to<sp/>be<sp/>confirmed<sp/>within<sp/>Y<sp/>blocks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="96"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;std::vector&lt;double&gt;&gt;<sp/>failAvg;<sp/></highlight><highlight class="comment">//<sp/>failAvg[Y][X]</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="97"><highlight class="normal"></highlight></codeline>
<codeline lineno="98"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Sum<sp/>the<sp/>total<sp/>feerate<sp/>of<sp/>all<sp/>tx&apos;s<sp/>in<sp/>each<sp/>bucket</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Track<sp/>the<sp/>historical<sp/>moving<sp/>average<sp/>of<sp/>this<sp/>total<sp/>over<sp/>blocks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;double&gt;<sp/>m_feerate_avg;</highlight></codeline>
<codeline lineno="101"><highlight class="normal"></highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Combine<sp/>the<sp/>conf<sp/>counts<sp/>with<sp/>tx<sp/>counts<sp/>to<sp/>calculate<sp/>the<sp/>confirmation<sp/>%<sp/>for<sp/>each<sp/>Y,X</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Combine<sp/>the<sp/>total<sp/>value<sp/>with<sp/>the<sp/>tx<sp/>counts<sp/>to<sp/>calculate<sp/>the<sp/>avg<sp/>feerate<sp/>per<sp/>bucket</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="104"><highlight class="normal"></highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>decay;</highlight></codeline>
<codeline lineno="106"><highlight class="normal"></highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Resolution<sp/>(#<sp/>of<sp/>blocks)<sp/>with<sp/>which<sp/>confirmations<sp/>are<sp/>tracked</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>scale;</highlight></codeline>
<codeline lineno="109"><highlight class="normal"></highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Mempool<sp/>counts<sp/>of<sp/>outstanding<sp/>transactions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>For<sp/>each<sp/>bucket<sp/>X,<sp/>track<sp/>the<sp/>number<sp/>of<sp/>transactions<sp/>in<sp/>the<sp/>mempool</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>that<sp/>are<sp/>unconfirmed<sp/>for<sp/>each<sp/>possible<sp/>confirmation<sp/>value<sp/>Y</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;std::vector&lt;int&gt;<sp/>&gt;<sp/>unconfTxs;<sp/><sp/></highlight><highlight class="comment">//unconfTxs[Y][X]</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transactions<sp/>still<sp/>unconfirmed<sp/>after<sp/>GetMaxConfirms<sp/>for<sp/>each<sp/>bucket</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;int&gt;<sp/>oldUnconfTxs;</highlight></codeline>
<codeline lineno="116"><highlight class="normal"></highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>resizeInMemoryCounters(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>newbuckets);</highlight></codeline>
<codeline lineno="118"><highlight class="normal"></highlight></codeline>
<codeline lineno="119"><highlight class="normal"></highlight><highlight class="keyword">public</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="127"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_tx_confirm_stats_1ac7b4481c4965b9c4c17c8cf0990331c4" kindref="member">TxConfirmStats</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;double&gt;&amp;<sp/>defaultBuckets,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::map&lt;double,<sp/>unsigned<sp/>int&gt;&amp;<sp/>defaultBucketMap,</highlight></codeline>
<codeline lineno="128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>maxPeriods,<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>decay,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>scale);</highlight></codeline>
<codeline lineno="129"><highlight class="normal"></highlight></codeline>
<codeline lineno="131"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1aa4969591ef8e28d6dbfebfe354b22739" kindref="member">ClearCurrent</ref>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nBlockHeight);</highlight></codeline>
<codeline lineno="132"><highlight class="normal"></highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1ac3150d4b839c8e61aff5c75e512b2fbe" kindref="member">Record</ref>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>blocksToConfirm,<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>val);</highlight></codeline>
<codeline lineno="140"><highlight class="normal"></highlight></codeline>
<codeline lineno="142"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1a216f28be9a9cb676ad34f883130e723a" kindref="member">NewTx</ref>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nBlockHeight,<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>val);</highlight></codeline>
<codeline lineno="143"><highlight class="normal"></highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1a9071ab202d08ede3278412045288f14a" kindref="member">removeTx</ref>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>entryHeight,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nBestSeenHeight,</highlight></codeline>
<codeline lineno="146"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>bucketIndex,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>inBlock);</highlight></codeline>
<codeline lineno="147"><highlight class="normal"></highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1a544feb81331431764ca22fed70c0c594" kindref="member">UpdateMovingAverages</ref>();</highlight></codeline>
<codeline lineno="151"><highlight class="normal"></highlight></codeline>
<codeline lineno="161"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1a3f3b2a3c3e9038522985c4e70d2cee5c" kindref="member">EstimateMedianVal</ref>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>confTarget,<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>sufficientTxVal,</highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>minSuccess,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nBlockHeight,</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_estimation_result" kindref="compound">EstimationResult</ref><sp/>*result<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="164"><highlight class="normal"></highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1a1780f7ece2fba74410d5f132f2c07e1b" kindref="member">GetMaxConfirms</ref>()</highlight><highlight class="keyword"><sp/>const<sp/></highlight><highlight class="normal">{<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>scale<sp/>*<sp/>confAvg.size();<sp/>}</highlight></codeline>
<codeline lineno="167"><highlight class="normal"></highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1a2b650cb03a6aa607e58d9236b617106e" kindref="member">Write</ref>(<ref refid="class_auto_file" kindref="compound">AutoFile</ref>&amp;<sp/>fileout)<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="170"><highlight class="normal"></highlight></codeline>
<codeline lineno="175"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1af5ea5b73531ffb775c4f9fe157feeaaf" kindref="member">Read</ref>(<ref refid="class_auto_file" kindref="compound">AutoFile</ref>&amp;<sp/>filein,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>numBuckets);</highlight></codeline>
<codeline lineno="176"><highlight class="normal">};</highlight></codeline>
<codeline lineno="177"><highlight class="normal"></highlight></codeline>
<codeline lineno="178"><highlight class="normal"></highlight></codeline>
<codeline lineno="179"><highlight class="normal"><ref refid="class_tx_confirm_stats_1ac7b4481c4965b9c4c17c8cf0990331c4" kindref="member">TxConfirmStats::TxConfirmStats</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;double&gt;&amp;<sp/>defaultBuckets,</highlight></codeline>
<codeline lineno="180"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::map&lt;double,<sp/>unsigned<sp/>int&gt;&amp;<sp/>defaultBucketMap,</highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>maxPeriods,<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>_decay,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>_scale)</highlight></codeline>
<codeline lineno="182"><highlight class="normal"><sp/><sp/><sp/><sp/>:<sp/>buckets(defaultBuckets),<sp/>bucketMap(defaultBucketMap),<sp/>decay(_decay),<sp/>scale(_scale)</highlight></codeline>
<codeline lineno="183"><highlight class="normal">{</highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(_scale<sp/>!=<sp/>0<sp/>&amp;&amp;<sp/></highlight><highlight class="stringliteral">&quot;_scale<sp/>must<sp/>be<sp/>non-zero&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/><sp/><sp/>confAvg.resize(maxPeriods);</highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/><sp/><sp/>failAvg.resize(maxPeriods);</highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>maxPeriods;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>confAvg[i].resize(buckets.size());</highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failAvg[i].resize(buckets.size());</highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="191"><highlight class="normal"></highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/><sp/><sp/>txCtAvg.resize(buckets.size());</highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/>m_feerate_avg.resize(buckets.size());</highlight></codeline>
<codeline lineno="194"><highlight class="normal"></highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/>resizeInMemoryCounters(buckets.size());</highlight></codeline>
<codeline lineno="196"><highlight class="normal">}</highlight></codeline>
<codeline lineno="197"><highlight class="normal"></highlight></codeline>
<codeline lineno="198"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>TxConfirmStats::resizeInMemoryCounters(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>newbuckets)<sp/>{</highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>newbuckets<sp/>must<sp/>be<sp/>passed<sp/>in<sp/>because<sp/>the<sp/>buckets<sp/>referred<sp/>to<sp/>during<sp/>Read<sp/>have<sp/>not<sp/>been<sp/>updated<sp/>yet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/><sp/><sp/>unconfTxs.resize(<ref refid="class_tx_confirm_stats_1a1780f7ece2fba74410d5f132f2c07e1b" kindref="member">GetMaxConfirms</ref>());</highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>unconfTxs.size();<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>unconfTxs[i].resize(newbuckets);</highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/><sp/><sp/>oldUnconfTxs.resize(newbuckets);</highlight></codeline>
<codeline lineno="205"><highlight class="normal">}</highlight></codeline>
<codeline lineno="206"><highlight class="normal"></highlight></codeline>
<codeline lineno="207"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Roll<sp/>the<sp/>unconfirmed<sp/>txs<sp/>circular<sp/>buffer</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="208"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1aa4969591ef8e28d6dbfebfe354b22739" kindref="member">TxConfirmStats::ClearCurrent</ref>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nBlockHeight)</highlight></codeline>
<codeline lineno="209"><highlight class="normal">{</highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>buckets.size();<sp/>j++)<sp/>{</highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>oldUnconfTxs[j]<sp/>+=<sp/>unconfTxs[nBlockHeight<sp/>%<sp/>unconfTxs.size()][j];</highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>unconfTxs[nBlockHeight%unconfTxs.size()][j]<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="214"><highlight class="normal">}</highlight></codeline>
<codeline lineno="215"><highlight class="normal"></highlight></codeline>
<codeline lineno="216"><highlight class="normal"></highlight></codeline>
<codeline lineno="217"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1ac3150d4b839c8e61aff5c75e512b2fbe" kindref="member">TxConfirmStats::Record</ref>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>blocksToConfirm,<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>feerate)</highlight></codeline>
<codeline lineno="218"><highlight class="normal">{</highlight></codeline>
<codeline lineno="219"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>blocksToConfirm<sp/>is<sp/>1-based</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="220"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(blocksToConfirm<sp/>&lt;<sp/>1)</highlight></codeline>
<codeline lineno="221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="222"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>periodsToConfirm<sp/>=<sp/>(blocksToConfirm<sp/>+<sp/>scale<sp/>-<sp/>1)<sp/>/<sp/>scale;</highlight></codeline>
<codeline lineno="223"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>bucketindex<sp/>=<sp/>bucketMap.lower_bound(feerate)-&gt;second;</highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>periodsToConfirm;<sp/>i<sp/>&lt;=<sp/>confAvg.size();<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>confAvg[i<sp/>-<sp/>1][bucketindex]++;</highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/><sp/><sp/>txCtAvg[bucketindex]++;</highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/><sp/><sp/>m_feerate_avg[bucketindex]<sp/>+=<sp/>feerate;</highlight></codeline>
<codeline lineno="229"><highlight class="normal">}</highlight></codeline>
<codeline lineno="230"><highlight class="normal"></highlight></codeline>
<codeline lineno="231"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1a544feb81331431764ca22fed70c0c594" kindref="member">TxConfirmStats::UpdateMovingAverages</ref>()</highlight></codeline>
<codeline lineno="232"><highlight class="normal">{</highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(confAvg.size()<sp/>==<sp/>failAvg.size());</highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>j<sp/>=<sp/>0;<sp/>j<sp/>&lt;<sp/>buckets.size();<sp/>j++)<sp/>{</highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>confAvg.size();<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>confAvg[i][j]<sp/>*=<sp/>decay;</highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failAvg[i][j]<sp/>*=<sp/>decay;</highlight></codeline>
<codeline lineno="238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_feerate_avg[j]<sp/>*=<sp/>decay;</highlight></codeline>
<codeline lineno="240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>txCtAvg[j]<sp/>*=<sp/>decay;</highlight></codeline>
<codeline lineno="241"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="242"><highlight class="normal">}</highlight></codeline>
<codeline lineno="243"><highlight class="normal"></highlight></codeline>
<codeline lineno="244"><highlight class="normal"></highlight><highlight class="comment">//<sp/>returns<sp/>-1<sp/>on<sp/>error<sp/>conditions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="245"><highlight class="normal"></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1a3f3b2a3c3e9038522985c4e70d2cee5c" kindref="member">TxConfirmStats::EstimateMedianVal</ref>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>confTarget,<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>sufficientTxVal,</highlight></codeline>
<codeline lineno="246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>successBreakPoint,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nBlockHeight,</highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="struct_estimation_result" kindref="compound">EstimationResult</ref><sp/>*result)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="248"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Counters<sp/>for<sp/>a<sp/>bucket<sp/>(or<sp/>range<sp/>of<sp/>buckets)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="250"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>nConf<sp/>=<sp/>0;<sp/></highlight><highlight class="comment">//<sp/>Number<sp/>of<sp/>tx&apos;s<sp/>confirmed<sp/>within<sp/>the<sp/>confTarget</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>totalNum<sp/>=<sp/>0;<sp/></highlight><highlight class="comment">//<sp/>Total<sp/>number<sp/>of<sp/>tx&apos;s<sp/>that<sp/>were<sp/>ever<sp/>confirmed</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>extraNum<sp/>=<sp/>0;<sp/><sp/></highlight><highlight class="comment">//<sp/>Number<sp/>of<sp/>tx&apos;s<sp/>still<sp/>in<sp/>mempool<sp/>for<sp/>confTarget<sp/>or<sp/>longer</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>failNum<sp/>=<sp/>0;<sp/></highlight><highlight class="comment">//<sp/>Number<sp/>of<sp/>tx&apos;s<sp/>that<sp/>were<sp/>never<sp/>confirmed<sp/>but<sp/>removed<sp/>from<sp/>the<sp/>mempool<sp/>after<sp/>confTarget</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="254"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>periodTarget<sp/>=<sp/>(confTarget<sp/>+<sp/>scale<sp/>-<sp/>1)<sp/>/<sp/>scale;</highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>maxbucketindex<sp/>=<sp/>buckets.size()<sp/>-<sp/>1;</highlight></codeline>
<codeline lineno="256"><highlight class="normal"></highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We&apos;ll<sp/>combine<sp/>buckets<sp/>until<sp/>we<sp/>have<sp/>enough<sp/>samples.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>near<sp/>and<sp/>far<sp/>variables<sp/>will<sp/>define<sp/>the<sp/>range<sp/>we&apos;ve<sp/>combined</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>best<sp/>variables<sp/>are<sp/>the<sp/>last<sp/>range<sp/>we<sp/>saw<sp/>which<sp/>still<sp/>had<sp/>a<sp/>high</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>enough<sp/>confirmation<sp/>rate<sp/>to<sp/>count<sp/>as<sp/>success.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>cur<sp/>variables<sp/>are<sp/>the<sp/>current<sp/>range<sp/>we&apos;re<sp/>counting.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>curNearBucket<sp/>=<sp/>maxbucketindex;</highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>bestNearBucket<sp/>=<sp/>maxbucketindex;</highlight></codeline>
<codeline lineno="264"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>curFarBucket<sp/>=<sp/>maxbucketindex;</highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>bestFarBucket<sp/>=<sp/>maxbucketindex;</highlight></codeline>
<codeline lineno="266"><highlight class="normal"></highlight></codeline>
<codeline lineno="267"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We&apos;ll<sp/>always<sp/>group<sp/>buckets<sp/>into<sp/>sets<sp/>that<sp/>meet<sp/>sufficientTxVal<sp/>--</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>this<sp/>ensures<sp/>that<sp/>we&apos;re<sp/>using<sp/>consistent<sp/>groups<sp/>between<sp/>different</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>confirmation<sp/>targets.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>partialNum<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="271"><highlight class="normal"></highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>foundAnswer<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="273"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>bins<sp/>=<sp/>unconfTxs.size();</highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>newBucketRange<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>passing<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/>EstimatorBucket<sp/>passBucket;</highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/>EstimatorBucket<sp/>failBucket;</highlight></codeline>
<codeline lineno="278"><highlight class="normal"></highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Start<sp/>counting<sp/>from<sp/>highest<sp/>feerate<sp/>transactions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>bucket<sp/>=<sp/>maxbucketindex;<sp/>bucket<sp/>&gt;=<sp/>0;<sp/>--bucket)<sp/>{</highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(newBucketRange)<sp/>{</highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>curNearBucket<sp/>=<sp/>bucket;</highlight></codeline>
<codeline lineno="283"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>newBucketRange<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>curFarBucket<sp/>=<sp/>bucket;</highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nConf<sp/>+=<sp/>confAvg[periodTarget<sp/>-<sp/>1][bucket];</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>partialNum<sp/>+=<sp/>txCtAvg[bucket];</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>totalNum<sp/>+=<sp/>txCtAvg[bucket];</highlight></codeline>
<codeline lineno="289"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failNum<sp/>+=<sp/>failAvg[periodTarget<sp/>-<sp/>1][bucket];</highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>confct<sp/>=<sp/>confTarget;<sp/>confct<sp/>&lt;<sp/><ref refid="class_tx_confirm_stats_1a1780f7ece2fba74410d5f132f2c07e1b" kindref="member">GetMaxConfirms</ref>();<sp/>confct++)</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>extraNum<sp/>+=<sp/>unconfTxs[(nBlockHeight<sp/>-<sp/>confct)<sp/>%<sp/>bins][bucket];</highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>extraNum<sp/>+=<sp/>oldUnconfTxs[bucket];</highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>have<sp/>enough<sp/>transaction<sp/>data<sp/>points<sp/>in<sp/>this<sp/>range<sp/>of<sp/>buckets,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>can<sp/>test<sp/>for<sp/>success</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(Only<sp/>count<sp/>the<sp/>confirmed<sp/>data<sp/>points,<sp/>so<sp/>that<sp/>each<sp/>confirmation<sp/>count</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>will<sp/>be<sp/>looking<sp/>at<sp/>the<sp/>same<sp/>amount<sp/>of<sp/>data<sp/>and<sp/>same<sp/>bucket<sp/>breaks)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="297"><highlight class="normal"></highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(partialNum<sp/>&lt;<sp/>sufficientTxVal<sp/>/<sp/>(1<sp/>-<sp/>decay))<sp/>{</highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>buckets<sp/>we&apos;ve<sp/>added<sp/>in<sp/>this<sp/>round<sp/>aren&apos;t<sp/>sufficient</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>so<sp/>keep<sp/>adding</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>partialNum<sp/>=<sp/>0;<sp/></highlight><highlight class="comment">//<sp/>reset<sp/>for<sp/>the<sp/>next<sp/>range<sp/>we&apos;ll<sp/>add</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="304"><highlight class="normal"></highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>curPct<sp/>=<sp/>nConf<sp/>/<sp/>(totalNum<sp/>+<sp/>failNum<sp/>+<sp/>extraNum);</highlight></codeline>
<codeline lineno="306"><highlight class="normal"></highlight></codeline>
<codeline lineno="307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>to<sp/>see<sp/>if<sp/>we<sp/>are<sp/>no<sp/>longer<sp/>getting<sp/>confirmed<sp/>at<sp/>the<sp/>success<sp/>rate</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(curPct<sp/>&lt;<sp/>successBreakPoint)<sp/>{</highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(passing<sp/>==<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>First<sp/>time<sp/>we<sp/>hit<sp/>a<sp/>failure<sp/>record<sp/>the<sp/>failed<sp/>bucket</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>failMinBucket<sp/>=<sp/>std::min(curNearBucket,<sp/>curFarBucket);</highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>failMaxBucket<sp/>=<sp/>std::max(curNearBucket,<sp/>curFarBucket);</highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failBucket.<ref refid="struct_estimator_bucket_1a45314566a84a31f43e6435d1eb24d4ec" kindref="member">start</ref><sp/>=<sp/>failMinBucket<sp/>?<sp/>buckets[failMinBucket<sp/>-<sp/>1]<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failBucket.<ref refid="struct_estimator_bucket_1a2c6c1302fc577e5e226869e3b899043e" kindref="member">end</ref><sp/>=<sp/>buckets[failMaxBucket];</highlight></codeline>
<codeline lineno="315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failBucket.<ref refid="struct_estimator_bucket_1a2ec18659e99bbb5d63a83ffc93d1c212" kindref="member">withinTarget</ref><sp/>=<sp/>nConf;</highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failBucket.<ref refid="struct_estimator_bucket_1ac380fc99ca2fbf9436a560ea5607f066" kindref="member">totalConfirmed</ref><sp/>=<sp/>totalNum;</highlight></codeline>
<codeline lineno="317"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failBucket.<ref refid="struct_estimator_bucket_1a340e02da0335b37ee0e16b001cbc4f66" kindref="member">inMempool</ref><sp/>=<sp/>extraNum;</highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failBucket.<ref refid="struct_estimator_bucket_1a5a5c6572d919e41b836a52884a7e2e7b" kindref="member">leftMempool</ref><sp/>=<sp/>failNum;</highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>passing<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Otherwise<sp/>update<sp/>the<sp/>cumulative<sp/>stats,<sp/>and<sp/>the<sp/>bucket<sp/>variables</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>reset<sp/>the<sp/>counters</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failBucket<sp/>=<sp/>EstimatorBucket();<sp/></highlight><highlight class="comment">//<sp/>Reset<sp/>any<sp/>failed<sp/>bucket,<sp/>currently<sp/>passing</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>foundAnswer<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>passing<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>passBucket.<ref refid="struct_estimator_bucket_1a2ec18659e99bbb5d63a83ffc93d1c212" kindref="member">withinTarget</ref><sp/>=<sp/>nConf;</highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nConf<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>passBucket.<ref refid="struct_estimator_bucket_1ac380fc99ca2fbf9436a560ea5607f066" kindref="member">totalConfirmed</ref><sp/>=<sp/>totalNum;</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>totalNum<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>passBucket.<ref refid="struct_estimator_bucket_1a340e02da0335b37ee0e16b001cbc4f66" kindref="member">inMempool</ref><sp/>=<sp/>extraNum;</highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>passBucket.<ref refid="struct_estimator_bucket_1a5a5c6572d919e41b836a52884a7e2e7b" kindref="member">leftMempool</ref><sp/>=<sp/>failNum;</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failNum<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>extraNum<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bestNearBucket<sp/>=<sp/>curNearBucket;</highlight></codeline>
<codeline lineno="338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bestFarBucket<sp/>=<sp/>curFarBucket;</highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>newBucketRange<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="343"><highlight class="normal"></highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>median<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>txSum<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="346"><highlight class="normal"></highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Calculate<sp/>the<sp/>&quot;average&quot;<sp/>feerate<sp/>of<sp/>the<sp/>best<sp/>bucket<sp/>range<sp/>that<sp/>met<sp/>success<sp/>conditions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Find<sp/>the<sp/>bucket<sp/>with<sp/>the<sp/>median<sp/>transaction<sp/>and<sp/>then<sp/>report<sp/>the<sp/>average<sp/>feerate<sp/>from<sp/>that<sp/>bucket</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="349"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>is<sp/>a<sp/>compromise<sp/>between<sp/>finding<sp/>the<sp/>median<sp/>which<sp/>we<sp/>can&apos;t<sp/>since<sp/>we<sp/>don&apos;t<sp/>save<sp/>all<sp/>tx&apos;s</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>reporting<sp/>the<sp/>average<sp/>which<sp/>is<sp/>less<sp/>accurate</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="351"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>minBucket<sp/>=<sp/>std::min(bestNearBucket,<sp/>bestFarBucket);</highlight></codeline>
<codeline lineno="352"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>maxBucket<sp/>=<sp/>std::max(bestNearBucket,<sp/>bestFarBucket);</highlight></codeline>
<codeline lineno="353"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>j<sp/>=<sp/>minBucket;<sp/>j<sp/>&lt;=<sp/>maxBucket;<sp/>j++)<sp/>{</highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>txSum<sp/>+=<sp/>txCtAvg[j];</highlight></codeline>
<codeline lineno="355"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="356"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(foundAnswer<sp/>&amp;&amp;<sp/>txSum<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>txSum<sp/>=<sp/>txSum<sp/>/<sp/>2;</highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>j<sp/>=<sp/>minBucket;<sp/>j<sp/>&lt;=<sp/>maxBucket;<sp/>j++)<sp/>{</highlight></codeline>
<codeline lineno="359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(txCtAvg[j]<sp/>&lt;<sp/>txSum)</highlight></codeline>
<codeline lineno="360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>txSum<sp/>-=<sp/>txCtAvg[j];</highlight></codeline>
<codeline lineno="361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{<sp/></highlight><highlight class="comment">//<sp/>we&apos;re<sp/>in<sp/>the<sp/>right<sp/>bucket</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>median<sp/>=<sp/>m_feerate_avg[j]<sp/>/<sp/>txCtAvg[j];</highlight></codeline>
<codeline lineno="363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="366"><highlight class="normal"></highlight></codeline>
<codeline lineno="367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>passBucket.<ref refid="struct_estimator_bucket_1a45314566a84a31f43e6435d1eb24d4ec" kindref="member">start</ref><sp/>=<sp/>minBucket<sp/>?<sp/>buckets[minBucket-1]<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>passBucket.<ref refid="struct_estimator_bucket_1a2c6c1302fc577e5e226869e3b899043e" kindref="member">end</ref><sp/>=<sp/>buckets[maxBucket];</highlight></codeline>
<codeline lineno="369"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="370"><highlight class="normal"></highlight></codeline>
<codeline lineno="371"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>were<sp/>passing<sp/>until<sp/>we<sp/>reached<sp/>last<sp/>few<sp/>buckets<sp/>with<sp/>insufficient<sp/>data,<sp/>then<sp/>report<sp/>those<sp/>as<sp/>failed</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="372"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(passing<sp/>&amp;&amp;<sp/>!newBucketRange)<sp/>{</highlight></codeline>
<codeline lineno="373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>failMinBucket<sp/>=<sp/>std::min(curNearBucket,<sp/>curFarBucket);</highlight></codeline>
<codeline lineno="374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>failMaxBucket<sp/>=<sp/>std::max(curNearBucket,<sp/>curFarBucket);</highlight></codeline>
<codeline lineno="375"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failBucket.<ref refid="struct_estimator_bucket_1a45314566a84a31f43e6435d1eb24d4ec" kindref="member">start</ref><sp/>=<sp/>failMinBucket<sp/>?<sp/>buckets[failMinBucket<sp/>-<sp/>1]<sp/>:<sp/>0;</highlight></codeline>
<codeline lineno="376"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failBucket.<ref refid="struct_estimator_bucket_1a2c6c1302fc577e5e226869e3b899043e" kindref="member">end</ref><sp/>=<sp/>buckets[failMaxBucket];</highlight></codeline>
<codeline lineno="377"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failBucket.<ref refid="struct_estimator_bucket_1a2ec18659e99bbb5d63a83ffc93d1c212" kindref="member">withinTarget</ref><sp/>=<sp/>nConf;</highlight></codeline>
<codeline lineno="378"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failBucket.<ref refid="struct_estimator_bucket_1ac380fc99ca2fbf9436a560ea5607f066" kindref="member">totalConfirmed</ref><sp/>=<sp/>totalNum;</highlight></codeline>
<codeline lineno="379"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failBucket.<ref refid="struct_estimator_bucket_1a340e02da0335b37ee0e16b001cbc4f66" kindref="member">inMempool</ref><sp/>=<sp/>extraNum;</highlight></codeline>
<codeline lineno="380"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failBucket.<ref refid="struct_estimator_bucket_1a5a5c6572d919e41b836a52884a7e2e7b" kindref="member">leftMempool</ref><sp/>=<sp/>failNum;</highlight></codeline>
<codeline lineno="381"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="382"><highlight class="normal"></highlight></codeline>
<codeline lineno="383"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>passed_within_target_perc<sp/>=<sp/>0.0;</highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">float</highlight><highlight class="normal"><sp/>failed_within_target_perc<sp/>=<sp/>0.0;</highlight></codeline>
<codeline lineno="385"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((passBucket.<ref refid="struct_estimator_bucket_1ac380fc99ca2fbf9436a560ea5607f066" kindref="member">totalConfirmed</ref><sp/>+<sp/>passBucket.<ref refid="struct_estimator_bucket_1a340e02da0335b37ee0e16b001cbc4f66" kindref="member">inMempool</ref><sp/>+<sp/>passBucket.<ref refid="struct_estimator_bucket_1a5a5c6572d919e41b836a52884a7e2e7b" kindref="member">leftMempool</ref>))<sp/>{</highlight></codeline>
<codeline lineno="386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>passed_within_target_perc<sp/>=<sp/>100<sp/>*<sp/>passBucket.<ref refid="struct_estimator_bucket_1a2ec18659e99bbb5d63a83ffc93d1c212" kindref="member">withinTarget</ref><sp/>/<sp/>(passBucket.<ref refid="struct_estimator_bucket_1ac380fc99ca2fbf9436a560ea5607f066" kindref="member">totalConfirmed</ref><sp/>+<sp/>passBucket.<ref refid="struct_estimator_bucket_1a340e02da0335b37ee0e16b001cbc4f66" kindref="member">inMempool</ref><sp/>+<sp/>passBucket.<ref refid="struct_estimator_bucket_1a5a5c6572d919e41b836a52884a7e2e7b" kindref="member">leftMempool</ref>);</highlight></codeline>
<codeline lineno="387"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="388"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((failBucket.<ref refid="struct_estimator_bucket_1ac380fc99ca2fbf9436a560ea5607f066" kindref="member">totalConfirmed</ref><sp/>+<sp/>failBucket.<ref refid="struct_estimator_bucket_1a340e02da0335b37ee0e16b001cbc4f66" kindref="member">inMempool</ref><sp/>+<sp/>failBucket.<ref refid="struct_estimator_bucket_1a5a5c6572d919e41b836a52884a7e2e7b" kindref="member">leftMempool</ref>))<sp/>{</highlight></codeline>
<codeline lineno="389"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failed_within_target_perc<sp/>=<sp/>100<sp/>*<sp/>failBucket.<ref refid="struct_estimator_bucket_1a2ec18659e99bbb5d63a83ffc93d1c212" kindref="member">withinTarget</ref><sp/>/<sp/>(failBucket.<ref refid="struct_estimator_bucket_1ac380fc99ca2fbf9436a560ea5607f066" kindref="member">totalConfirmed</ref><sp/>+<sp/>failBucket.<ref refid="struct_estimator_bucket_1a340e02da0335b37ee0e16b001cbc4f66" kindref="member">inMempool</ref><sp/>+<sp/>failBucket.<ref refid="struct_estimator_bucket_1a5a5c6572d919e41b836a52884a7e2e7b" kindref="member">leftMempool</ref>);</highlight></codeline>
<codeline lineno="390"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="391"><highlight class="normal"></highlight></codeline>
<codeline lineno="392"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a390409d91483ef8b1b33fbc3ff0f4918" kindref="member">BCLog::ESTIMATEFEE</ref>,<sp/></highlight><highlight class="stringliteral">&quot;FeeEst:<sp/>%d<sp/>&gt;<sp/>%.0f%%<sp/>decay<sp/>%.5f:<sp/>feerate:<sp/>%g<sp/>from<sp/>(%g<sp/>-<sp/>%g)<sp/>%.2f%%<sp/>%.1f/(%.1f<sp/>%d<sp/>mem<sp/>%.1f<sp/>out)<sp/>Fail:<sp/>(%g<sp/>-<sp/>%g)<sp/>%.2f%%<sp/>%.1f/(%.1f<sp/>%d<sp/>mem<sp/>%.1f<sp/>out)\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>confTarget,<sp/>100.0<sp/>*<sp/>successBreakPoint,<sp/>decay,</highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>median,<sp/>passBucket.<ref refid="struct_estimator_bucket_1a45314566a84a31f43e6435d1eb24d4ec" kindref="member">start</ref>,<sp/>passBucket.<ref refid="struct_estimator_bucket_1a2c6c1302fc577e5e226869e3b899043e" kindref="member">end</ref>,</highlight></codeline>
<codeline lineno="395"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>passed_within_target_perc,</highlight></codeline>
<codeline lineno="396"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>passBucket.<ref refid="struct_estimator_bucket_1a2ec18659e99bbb5d63a83ffc93d1c212" kindref="member">withinTarget</ref>,<sp/>passBucket.<ref refid="struct_estimator_bucket_1ac380fc99ca2fbf9436a560ea5607f066" kindref="member">totalConfirmed</ref>,<sp/>passBucket.<ref refid="struct_estimator_bucket_1a340e02da0335b37ee0e16b001cbc4f66" kindref="member">inMempool</ref>,<sp/>passBucket.<ref refid="struct_estimator_bucket_1a5a5c6572d919e41b836a52884a7e2e7b" kindref="member">leftMempool</ref>,</highlight></codeline>
<codeline lineno="397"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failBucket.<ref refid="struct_estimator_bucket_1a45314566a84a31f43e6435d1eb24d4ec" kindref="member">start</ref>,<sp/>failBucket.<ref refid="struct_estimator_bucket_1a2c6c1302fc577e5e226869e3b899043e" kindref="member">end</ref>,</highlight></codeline>
<codeline lineno="398"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failed_within_target_perc,</highlight></codeline>
<codeline lineno="399"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failBucket.<ref refid="struct_estimator_bucket_1a2ec18659e99bbb5d63a83ffc93d1c212" kindref="member">withinTarget</ref>,<sp/>failBucket.<ref refid="struct_estimator_bucket_1ac380fc99ca2fbf9436a560ea5607f066" kindref="member">totalConfirmed</ref>,<sp/>failBucket.<ref refid="struct_estimator_bucket_1a340e02da0335b37ee0e16b001cbc4f66" kindref="member">inMempool</ref>,<sp/>failBucket.<ref refid="struct_estimator_bucket_1a5a5c6572d919e41b836a52884a7e2e7b" kindref="member">leftMempool</ref>);</highlight></codeline>
<codeline lineno="400"><highlight class="normal"></highlight></codeline>
<codeline lineno="401"><highlight class="normal"></highlight></codeline>
<codeline lineno="402"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(result)<sp/>{</highlight></codeline>
<codeline lineno="403"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result-&gt;<ref refid="struct_estimation_result_1a29948367da50cc1ce558576734ba23c0" kindref="member">pass</ref><sp/>=<sp/>passBucket;</highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result-&gt;<ref refid="struct_estimation_result_1acd2ac36d00a92418635d79a42cae51c5" kindref="member">fail</ref><sp/>=<sp/>failBucket;</highlight></codeline>
<codeline lineno="405"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result-&gt;<ref refid="struct_estimation_result_1ab01a33c3f845cc963c97a17973b4e871" kindref="member">decay</ref><sp/>=<sp/>decay;</highlight></codeline>
<codeline lineno="406"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>result-&gt;<ref refid="struct_estimation_result_1a73cf545ebcc0acb294e2d29af4204d7a" kindref="member">scale</ref><sp/>=<sp/>scale;</highlight></codeline>
<codeline lineno="407"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="408"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>median;</highlight></codeline>
<codeline lineno="409"><highlight class="normal">}</highlight></codeline>
<codeline lineno="410"><highlight class="normal"></highlight></codeline>
<codeline lineno="411"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1a2b650cb03a6aa607e58d9236b617106e" kindref="member">TxConfirmStats::Write</ref>(<ref refid="class_auto_file" kindref="compound">AutoFile</ref>&amp;<sp/>fileout)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="412"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="413"><highlight class="normal"><sp/><sp/><sp/><sp/>fileout<sp/>&lt;&lt;<sp/>Using&lt;EncodedDoubleFormatter&gt;(decay);</highlight></codeline>
<codeline lineno="414"><highlight class="normal"><sp/><sp/><sp/><sp/>fileout<sp/>&lt;&lt;<sp/>scale;</highlight></codeline>
<codeline lineno="415"><highlight class="normal"><sp/><sp/><sp/><sp/>fileout<sp/>&lt;&lt;<sp/>Using&lt;VectorFormatter&lt;EncodedDoubleFormatter&gt;&gt;(m_feerate_avg);</highlight></codeline>
<codeline lineno="416"><highlight class="normal"><sp/><sp/><sp/><sp/>fileout<sp/>&lt;&lt;<sp/>Using&lt;VectorFormatter&lt;EncodedDoubleFormatter&gt;&gt;(txCtAvg);</highlight></codeline>
<codeline lineno="417"><highlight class="normal"><sp/><sp/><sp/><sp/>fileout<sp/>&lt;&lt;<sp/>Using&lt;VectorFormatter&lt;VectorFormatter&lt;EncodedDoubleFormatter&gt;&gt;&gt;(confAvg);</highlight></codeline>
<codeline lineno="418"><highlight class="normal"><sp/><sp/><sp/><sp/>fileout<sp/>&lt;&lt;<sp/>Using&lt;VectorFormatter&lt;VectorFormatter&lt;EncodedDoubleFormatter&gt;&gt;&gt;(failAvg);</highlight></codeline>
<codeline lineno="419"><highlight class="normal">}</highlight></codeline>
<codeline lineno="420"><highlight class="normal"></highlight></codeline>
<codeline lineno="421"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1af5ea5b73531ffb775c4f9fe157feeaaf" kindref="member">TxConfirmStats::Read</ref>(<ref refid="class_auto_file" kindref="compound">AutoFile</ref>&amp;<sp/>filein,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>numBuckets)</highlight></codeline>
<codeline lineno="422"><highlight class="normal">{</highlight></codeline>
<codeline lineno="423"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Read<sp/>data<sp/>file<sp/>and<sp/>do<sp/>some<sp/>very<sp/>basic<sp/>sanity<sp/>checking</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="424"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>buckets<sp/>and<sp/>bucketMap<sp/>are<sp/>not<sp/>updated<sp/>yet,<sp/>so<sp/>don&apos;t<sp/>access<sp/>them</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="425"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>there<sp/>is<sp/>a<sp/>read<sp/>failure,<sp/>we&apos;ll<sp/>just<sp/>discard<sp/>this<sp/>entire<sp/>object<sp/>anyway</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="426"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>maxConfirms,<sp/>maxPeriods;</highlight></codeline>
<codeline lineno="427"><highlight class="normal"></highlight></codeline>
<codeline lineno="428"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>current<sp/>version<sp/>will<sp/>store<sp/>the<sp/>decay<sp/>with<sp/>each<sp/>individual<sp/>TxConfirmStats<sp/>and<sp/>also<sp/>keep<sp/>a<sp/>scale<sp/>factor</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="429"><highlight class="normal"><sp/><sp/><sp/><sp/>filein<sp/>&gt;&gt;<sp/>Using&lt;EncodedDoubleFormatter&gt;(decay);</highlight></codeline>
<codeline lineno="430"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(decay<sp/>&lt;=<sp/>0<sp/>||<sp/>decay<sp/>&gt;=<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/>std::runtime_error(</highlight><highlight class="stringliteral">&quot;Corrupt<sp/>estimates<sp/>file.<sp/>Decay<sp/>must<sp/>be<sp/>between<sp/>0<sp/>and<sp/>1<sp/>(non-inclusive)&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="432"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="433"><highlight class="normal"><sp/><sp/><sp/><sp/>filein<sp/>&gt;&gt;<sp/>scale;</highlight></codeline>
<codeline lineno="434"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(scale<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="435"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/>std::runtime_error(</highlight><highlight class="stringliteral">&quot;Corrupt<sp/>estimates<sp/>file.<sp/>Scale<sp/>must<sp/>be<sp/>non-zero&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="436"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="437"><highlight class="normal"></highlight></codeline>
<codeline lineno="438"><highlight class="normal"><sp/><sp/><sp/><sp/>filein<sp/>&gt;&gt;<sp/>Using&lt;VectorFormatter&lt;EncodedDoubleFormatter&gt;&gt;(m_feerate_avg);</highlight></codeline>
<codeline lineno="439"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_feerate_avg.size()<sp/>!=<sp/>numBuckets)<sp/>{</highlight></codeline>
<codeline lineno="440"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/>std::runtime_error(</highlight><highlight class="stringliteral">&quot;Corrupt<sp/>estimates<sp/>file.<sp/>Mismatch<sp/>in<sp/>feerate<sp/>average<sp/>bucket<sp/>count&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="441"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="442"><highlight class="normal"><sp/><sp/><sp/><sp/>filein<sp/>&gt;&gt;<sp/>Using&lt;VectorFormatter&lt;EncodedDoubleFormatter&gt;&gt;(txCtAvg);</highlight></codeline>
<codeline lineno="443"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(txCtAvg.size()<sp/>!=<sp/>numBuckets)<sp/>{</highlight></codeline>
<codeline lineno="444"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/>std::runtime_error(</highlight><highlight class="stringliteral">&quot;Corrupt<sp/>estimates<sp/>file.<sp/>Mismatch<sp/>in<sp/>tx<sp/>count<sp/>bucket<sp/>count&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="445"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="446"><highlight class="normal"><sp/><sp/><sp/><sp/>filein<sp/>&gt;&gt;<sp/>Using&lt;VectorFormatter&lt;VectorFormatter&lt;EncodedDoubleFormatter&gt;&gt;&gt;(confAvg);</highlight></codeline>
<codeline lineno="447"><highlight class="normal"><sp/><sp/><sp/><sp/>maxPeriods<sp/>=<sp/>confAvg.<ref refid="class_auto_file_1aefa4cbcbdc75e346ec1ffadacbc0a72b" kindref="member">size</ref>();</highlight></codeline>
<codeline lineno="448"><highlight class="normal"><sp/><sp/><sp/><sp/>maxConfirms<sp/>=<sp/>scale<sp/>*<sp/>maxPeriods;</highlight></codeline>
<codeline lineno="449"><highlight class="normal"></highlight></codeline>
<codeline lineno="450"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(maxConfirms<sp/>&lt;=<sp/>0<sp/>||<sp/>maxConfirms<sp/>&gt;<sp/>6<sp/>*<sp/>24<sp/>*<sp/>7)<sp/>{<sp/></highlight><highlight class="comment">//<sp/>one<sp/>week</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/>std::runtime_error(</highlight><highlight class="stringliteral">&quot;Corrupt<sp/>estimates<sp/>file.<sp/><sp/>Must<sp/>maintain<sp/>estimates<sp/>for<sp/>between<sp/>1<sp/>and<sp/>1008<sp/>(one<sp/>week)<sp/>confirms&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="452"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="453"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>maxPeriods;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(confAvg[i].size()<sp/>!=<sp/>numBuckets)<sp/>{</highlight></codeline>
<codeline lineno="455"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/>std::runtime_error(</highlight><highlight class="stringliteral">&quot;Corrupt<sp/>estimates<sp/>file.<sp/>Mismatch<sp/>in<sp/>feerate<sp/>conf<sp/>average<sp/>bucket<sp/>count&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="456"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="457"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="458"><highlight class="normal"></highlight></codeline>
<codeline lineno="459"><highlight class="normal"><sp/><sp/><sp/><sp/>filein<sp/>&gt;&gt;<sp/>Using&lt;VectorFormatter&lt;VectorFormatter&lt;EncodedDoubleFormatter&gt;&gt;&gt;(failAvg);</highlight></codeline>
<codeline lineno="460"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(maxPeriods<sp/>!=<sp/>failAvg.size())<sp/>{</highlight></codeline>
<codeline lineno="461"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/>std::runtime_error(</highlight><highlight class="stringliteral">&quot;Corrupt<sp/>estimates<sp/>file.<sp/>Mismatch<sp/>in<sp/>confirms<sp/>tracked<sp/>for<sp/>failures&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="462"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="463"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>maxPeriods;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="464"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(failAvg[i].size()<sp/>!=<sp/>numBuckets)<sp/>{</highlight></codeline>
<codeline lineno="465"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/>std::runtime_error(</highlight><highlight class="stringliteral">&quot;Corrupt<sp/>estimates<sp/>file.<sp/>Mismatch<sp/>in<sp/>one<sp/>of<sp/>failure<sp/>average<sp/>bucket<sp/>counts&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="466"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="467"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="468"><highlight class="normal"></highlight></codeline>
<codeline lineno="469"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Resize<sp/>the<sp/>current<sp/>block<sp/>variables<sp/>which<sp/>aren&apos;t<sp/>stored<sp/>in<sp/>the<sp/>data<sp/>file</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="470"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>match<sp/>the<sp/>number<sp/>of<sp/>confirms<sp/>and<sp/>buckets</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="471"><highlight class="normal"><sp/><sp/><sp/><sp/>resizeInMemoryCounters(numBuckets);</highlight></codeline>
<codeline lineno="472"><highlight class="normal"></highlight></codeline>
<codeline lineno="473"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a390409d91483ef8b1b33fbc3ff0f4918" kindref="member">BCLog::ESTIMATEFEE</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Reading<sp/>estimates:<sp/>%u<sp/>buckets<sp/>counting<sp/>confirms<sp/>up<sp/>to<sp/>%u<sp/>blocks\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="474"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>numBuckets,<sp/>maxConfirms);</highlight></codeline>
<codeline lineno="475"><highlight class="normal">}</highlight></codeline>
<codeline lineno="476"><highlight class="normal"></highlight></codeline>
<codeline lineno="477"><highlight class="normal"></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1a216f28be9a9cb676ad34f883130e723a" kindref="member">TxConfirmStats::NewTx</ref>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nBlockHeight,<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>val)</highlight></codeline>
<codeline lineno="478"><highlight class="normal">{</highlight></codeline>
<codeline lineno="479"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>bucketindex<sp/>=<sp/>bucketMap.lower_bound(val)-&gt;second;</highlight></codeline>
<codeline lineno="480"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>blockIndex<sp/>=<sp/>nBlockHeight<sp/>%<sp/>unconfTxs.size();</highlight></codeline>
<codeline lineno="481"><highlight class="normal"><sp/><sp/><sp/><sp/>unconfTxs[blockIndex][bucketindex]++;</highlight></codeline>
<codeline lineno="482"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>bucketindex;</highlight></codeline>
<codeline lineno="483"><highlight class="normal">}</highlight></codeline>
<codeline lineno="484"><highlight class="normal"></highlight></codeline>
<codeline lineno="485"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1a9071ab202d08ede3278412045288f14a" kindref="member">TxConfirmStats::removeTx</ref>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>entryHeight,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nBestSeenHeight,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>bucketindex,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>inBlock)</highlight></codeline>
<codeline lineno="486"><highlight class="normal">{</highlight></codeline>
<codeline lineno="487"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//nBestSeenHeight<sp/>is<sp/>not<sp/>updated<sp/>yet<sp/>for<sp/>the<sp/>new<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="488"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>blocksAgo<sp/>=<sp/>nBestSeenHeight<sp/>-<sp/>entryHeight;</highlight></codeline>
<codeline lineno="489"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nBestSeenHeight<sp/>==<sp/>0)<sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>BlockPolicyEstimator<sp/>hasn&apos;t<sp/>seen<sp/>any<sp/>blocks<sp/>yet</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocksAgo<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="491"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(blocksAgo<sp/>&lt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a390409d91483ef8b1b33fbc3ff0f4918" kindref="member">BCLog::ESTIMATEFEE</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Blockpolicy<sp/>error,<sp/>blocks<sp/>ago<sp/>is<sp/>negative<sp/>for<sp/>mempool<sp/>tx\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;<sp/><sp/></highlight><highlight class="comment">//This<sp/>can&apos;t<sp/>happen<sp/>because<sp/>we<sp/>call<sp/>this<sp/>with<sp/>our<sp/>best<sp/>seen<sp/>height,<sp/>no<sp/>entries<sp/>can<sp/>have<sp/>higher</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="494"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="495"><highlight class="normal"></highlight></codeline>
<codeline lineno="496"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(blocksAgo<sp/>&gt;=<sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)unconfTxs.size())<sp/>{</highlight></codeline>
<codeline lineno="497"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(oldUnconfTxs[bucketindex]<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>oldUnconfTxs[bucketindex]--;</highlight></codeline>
<codeline lineno="499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a390409d91483ef8b1b33fbc3ff0f4918" kindref="member">BCLog::ESTIMATEFEE</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Blockpolicy<sp/>error,<sp/>mempool<sp/>tx<sp/>removed<sp/>from<sp/>&gt;25<sp/>blocks,bucketIndex=%u<sp/>already\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bucketindex);</highlight></codeline>
<codeline lineno="502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="503"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="504"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>blockIndex<sp/>=<sp/>entryHeight<sp/>%<sp/>unconfTxs.size();</highlight></codeline>
<codeline lineno="506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(unconfTxs[blockIndex][bucketindex]<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>unconfTxs[blockIndex][bucketindex]--;</highlight></codeline>
<codeline lineno="508"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="509"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a390409d91483ef8b1b33fbc3ff0f4918" kindref="member">BCLog::ESTIMATEFEE</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Blockpolicy<sp/>error,<sp/>mempool<sp/>tx<sp/>removed<sp/>from<sp/>blockIndex=%u,bucketIndex=%u<sp/>already\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blockIndex,<sp/>bucketindex);</highlight></codeline>
<codeline lineno="511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="512"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="513"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!inBlock<sp/>&amp;&amp;<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)blocksAgo<sp/>&gt;=<sp/>scale)<sp/>{<sp/></highlight><highlight class="comment">//<sp/>Only<sp/>counts<sp/>as<sp/>a<sp/>failure<sp/>if<sp/>not<sp/>confirmed<sp/>for<sp/>entire<sp/>period</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(scale<sp/>!=<sp/>0);</highlight></codeline>
<codeline lineno="515"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>periodsAgo<sp/>=<sp/>blocksAgo<sp/>/<sp/>scale;</highlight></codeline>
<codeline lineno="516"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>periodsAgo<sp/>&amp;&amp;<sp/>i<sp/>&lt;<sp/>failAvg.size();<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>failAvg[i][bucketindex]++;</highlight></codeline>
<codeline lineno="518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="519"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="520"><highlight class="normal">}</highlight></codeline>
<codeline lineno="521"><highlight class="normal"></highlight></codeline>
<codeline lineno="522"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_c_block_policy_estimator_1ae527d524ab2393114960a1dd71bc9fac" kindref="member">CBlockPolicyEstimator::removeTx</ref>(<ref refid="transaction__identifier_8h_1ac4bb3c35b94889843d632be4de4b223c" kindref="member">Txid</ref><sp/>hash)</highlight></codeline>
<codeline lineno="523"><highlight class="normal">{</highlight></codeline>
<codeline lineno="524"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_cs_fee_estimator);</highlight></codeline>
<codeline lineno="525"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>_removeTx(hash,<sp/></highlight><highlight class="comment">/*inBlock=*/</highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="526"><highlight class="normal">}</highlight></codeline>
<codeline lineno="527"><highlight class="normal"></highlight></codeline>
<codeline lineno="528"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CBlockPolicyEstimator::_removeTx(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="transaction__identifier_8h_1ac4bb3c35b94889843d632be4de4b223c" kindref="member">Txid</ref>&amp;<sp/>hash,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>inBlock)</highlight></codeline>
<codeline lineno="529"><highlight class="normal">{</highlight></codeline>
<codeline lineno="530"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(m_cs_fee_estimator);</highlight></codeline>
<codeline lineno="531"><highlight class="normal"><sp/><sp/><sp/><sp/>std::map&lt;Txid,<sp/>TxStatsInfo&gt;::iterator<sp/>pos<sp/>=<sp/>mapMemPoolTxs.find(hash);</highlight></codeline>
<codeline lineno="532"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pos<sp/>!=<sp/>mapMemPoolTxs.end())<sp/>{</highlight></codeline>
<codeline lineno="533"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feeStats-&gt;removeTx(pos-&gt;second.blockHeight,<sp/>nBestSeenHeight,<sp/>pos-&gt;second.bucketIndex,<sp/>inBlock);</highlight></codeline>
<codeline lineno="534"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>shortStats-&gt;removeTx(pos-&gt;second.blockHeight,<sp/>nBestSeenHeight,<sp/>pos-&gt;second.bucketIndex,<sp/>inBlock);</highlight></codeline>
<codeline lineno="535"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>longStats-&gt;removeTx(pos-&gt;second.blockHeight,<sp/>nBestSeenHeight,<sp/>pos-&gt;second.bucketIndex,<sp/>inBlock);</highlight></codeline>
<codeline lineno="536"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mapMemPoolTxs.erase(hash);</highlight></codeline>
<codeline lineno="537"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="538"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="539"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="540"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="541"><highlight class="normal">}</highlight></codeline>
<codeline lineno="542"><highlight class="normal"></highlight></codeline>
<codeline lineno="543"><highlight class="normal"><ref refid="class_c_block_policy_estimator_1a815227f17255990ccf29ea25464c043c" kindref="member">CBlockPolicyEstimator::CBlockPolicyEstimator</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>fs::path&amp;<sp/>estimation_filepath,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>read_stale_estimates)</highlight></codeline>
<codeline lineno="544"><highlight class="normal"><sp/><sp/><sp/><sp/>:<sp/>m_estimation_filepath{estimation_filepath}</highlight></codeline>
<codeline lineno="545"><highlight class="normal">{</highlight></codeline>
<codeline lineno="546"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">static_assert</highlight><highlight class="normal">(MIN_BUCKET_FEERATE<sp/>&gt;<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;Min<sp/>feerate<sp/>must<sp/>be<sp/>nonzero&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="547"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>bucketIndex<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="548"><highlight class="normal"></highlight></codeline>
<codeline lineno="549"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>bucketBoundary<sp/>=<sp/>MIN_BUCKET_FEERATE;<sp/>bucketBoundary<sp/>&lt;=<sp/>MAX_BUCKET_FEERATE;<sp/>bucketBoundary<sp/>*=<sp/>FEE_SPACING,<sp/>bucketIndex++)<sp/>{</highlight></codeline>
<codeline lineno="550"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>buckets.push_back(bucketBoundary);</highlight></codeline>
<codeline lineno="551"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bucketMap[bucketBoundary]<sp/>=<sp/>bucketIndex;</highlight></codeline>
<codeline lineno="552"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="553"><highlight class="normal"><sp/><sp/><sp/><sp/>buckets.push_back(INF_FEERATE);</highlight></codeline>
<codeline lineno="554"><highlight class="normal"><sp/><sp/><sp/><sp/>bucketMap[INF_FEERATE]<sp/>=<sp/>bucketIndex;</highlight></codeline>
<codeline lineno="555"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(bucketMap.size()<sp/>==<sp/>buckets.size());</highlight></codeline>
<codeline lineno="556"><highlight class="normal"></highlight></codeline>
<codeline lineno="557"><highlight class="normal"><sp/><sp/><sp/><sp/>feeStats<sp/>=<sp/>std::unique_ptr&lt;TxConfirmStats&gt;(</highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1ac7b4481c4965b9c4c17c8cf0990331c4" kindref="member">TxConfirmStats</ref>(buckets,<sp/>bucketMap,<sp/>MED_BLOCK_PERIODS,<sp/>MED_DECAY,<sp/>MED_SCALE));</highlight></codeline>
<codeline lineno="558"><highlight class="normal"><sp/><sp/><sp/><sp/>shortStats<sp/>=<sp/>std::unique_ptr&lt;TxConfirmStats&gt;(</highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1ac7b4481c4965b9c4c17c8cf0990331c4" kindref="member">TxConfirmStats</ref>(buckets,<sp/>bucketMap,<sp/>SHORT_BLOCK_PERIODS,<sp/>SHORT_DECAY,<sp/>SHORT_SCALE));</highlight></codeline>
<codeline lineno="559"><highlight class="normal"><sp/><sp/><sp/><sp/>longStats<sp/>=<sp/>std::unique_ptr&lt;TxConfirmStats&gt;(</highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/><ref refid="class_tx_confirm_stats_1ac7b4481c4965b9c4c17c8cf0990331c4" kindref="member">TxConfirmStats</ref>(buckets,<sp/>bucketMap,<sp/>LONG_BLOCK_PERIODS,<sp/>LONG_DECAY,<sp/>LONG_SCALE));</highlight></codeline>
<codeline lineno="560"><highlight class="normal"></highlight></codeline>
<codeline lineno="561"><highlight class="normal"><sp/><sp/><sp/><sp/>AutoFile<sp/>est_file{<ref refid="namespacefsbridge_1a52093f6db7ef176f21e89f9e46367ded" kindref="member">fsbridge::fopen</ref>(m_estimation_filepath,<sp/></highlight><highlight class="stringliteral">&quot;rb&quot;</highlight><highlight class="normal">)};</highlight></codeline>
<codeline lineno="562"><highlight class="normal"></highlight></codeline>
<codeline lineno="563"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(est_file.<ref refid="class_auto_file_1ac4d637a0dec45d546495c1660c9f6047" kindref="member">IsNull</ref>())<sp/>{</highlight></codeline>
<codeline lineno="564"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;%s<sp/>is<sp/>not<sp/>found.<sp/>Continue<sp/>anyway.&quot;</highlight><highlight class="normal">,<sp/>fs::PathToString(m_estimation_filepath));</highlight></codeline>
<codeline lineno="565"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="566"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="567"><highlight class="normal"></highlight></codeline>
<codeline lineno="568"><highlight class="normal"><sp/><sp/><sp/><sp/>std::chrono::hours<sp/>file_age<sp/>=<sp/>GetFeeEstimatorFileAge();</highlight></codeline>
<codeline lineno="569"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(file_age<sp/>&gt;<sp/>MAX_FILE_AGE<sp/>&amp;&amp;<sp/>!read_stale_estimates)<sp/>{</highlight></codeline>
<codeline lineno="570"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;Fee<sp/>estimation<sp/>file<sp/>%s<sp/>too<sp/>old<sp/>(age=%lld<sp/>&gt;<sp/>%lld<sp/>hours)<sp/>and<sp/>will<sp/>not<sp/>be<sp/>used<sp/>to<sp/>avoid<sp/>serving<sp/>stale<sp/>estimates.&quot;</highlight><highlight class="normal">,<sp/>fs::PathToString(m_estimation_filepath),<sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;std::chrono::hours&gt;</ref>(file_age),<sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;std::chrono::hours&gt;</ref>(MAX_FILE_AGE));</highlight></codeline>
<codeline lineno="571"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="572"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="573"><highlight class="normal"></highlight></codeline>
<codeline lineno="574"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="class_tx_confirm_stats_1af5ea5b73531ffb775c4f9fe157feeaaf" kindref="member">Read</ref>(est_file))<sp/>{</highlight></codeline>
<codeline lineno="575"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>read<sp/>fee<sp/>estimates<sp/>from<sp/>%s.<sp/>Continue<sp/>anyway.&quot;</highlight><highlight class="normal">,<sp/>fs::PathToString(m_estimation_filepath));</highlight></codeline>
<codeline lineno="576"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="577"><highlight class="normal">}</highlight></codeline>
<codeline lineno="578"><highlight class="normal"></highlight></codeline>
<codeline lineno="579"><highlight class="normal"><ref refid="class_c_block_policy_estimator_1a47ebc7133c7fddd3bc81483c1741d690" kindref="member">CBlockPolicyEstimator::~CBlockPolicyEstimator</ref>()<sp/>=<sp/></highlight><highlight class="keywordflow">default</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="580"><highlight class="normal"></highlight></codeline>
<codeline lineno="581"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_c_block_policy_estimator_1a82ce5bcdb57e2684d50b589d18e82624" kindref="member">CBlockPolicyEstimator::TransactionAddedToMempool</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_new_mempool_transaction_info" kindref="compound">NewMempoolTransactionInfo</ref>&amp;<sp/>tx,<sp/>uint64_t<sp/></highlight><highlight class="comment">/*unused*/</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="582"><highlight class="normal">{</highlight></codeline>
<codeline lineno="583"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_block_policy_estimator_1a77dd2df6a56ac08a4da69d9a14c565f1" kindref="member">processTransaction</ref>(tx);</highlight></codeline>
<codeline lineno="584"><highlight class="normal">}</highlight></codeline>
<codeline lineno="585"><highlight class="normal"></highlight></codeline>
<codeline lineno="586"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_c_block_policy_estimator_1a0aa4813d9d5f3e8f4c71be5f205b8f20" kindref="member">CBlockPolicyEstimator::TransactionRemovedFromMempool</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref>&amp;<sp/>tx,<sp/><ref refid="mempool__removal__reason_8h_1a2bc6653552b5871101b6cbefdbaf251f" kindref="member">MemPoolRemovalReason</ref><sp/></highlight><highlight class="comment">/*unused*/</highlight><highlight class="normal">,<sp/>uint64_t<sp/></highlight><highlight class="comment">/*unused*/</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="587"><highlight class="normal">{</highlight></codeline>
<codeline lineno="588"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_block_policy_estimator_1ae527d524ab2393114960a1dd71bc9fac" kindref="member">removeTx</ref>(tx-&gt;GetHash());</highlight></codeline>
<codeline lineno="589"><highlight class="normal">}</highlight></codeline>
<codeline lineno="590"><highlight class="normal"></highlight></codeline>
<codeline lineno="591"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_c_block_policy_estimator_1a011805724fc262857fa82f49186c7455" kindref="member">CBlockPolicyEstimator::MempoolTransactionsRemovedForBlock</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;RemovedMempoolTransactionInfo&gt;&amp;<sp/>txs_removed_for_block,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nBlockHeight)</highlight></codeline>
<codeline lineno="592"><highlight class="normal">{</highlight></codeline>
<codeline lineno="593"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_block_policy_estimator_1a65f0b56680542778f34609dca718e8c6" kindref="member">processBlock</ref>(txs_removed_for_block,<sp/>nBlockHeight);</highlight></codeline>
<codeline lineno="594"><highlight class="normal">}</highlight></codeline>
<codeline lineno="595"><highlight class="normal"></highlight></codeline>
<codeline lineno="596"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_c_block_policy_estimator_1a77dd2df6a56ac08a4da69d9a14c565f1" kindref="member">CBlockPolicyEstimator::processTransaction</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_new_mempool_transaction_info" kindref="compound">NewMempoolTransactionInfo</ref>&amp;<sp/>tx)</highlight></codeline>
<codeline lineno="597"><highlight class="normal">{</highlight></codeline>
<codeline lineno="598"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_cs_fee_estimator);</highlight></codeline>
<codeline lineno="599"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>txHeight<sp/>=<sp/>tx.<ref refid="struct_new_mempool_transaction_info_1adc3fa961cbcf8cd3499ee68b1c81170b" kindref="member">info</ref>.<ref refid="struct_transaction_info_1afbb87c9970019c30a84a2005a94dae57" kindref="member">txHeight</ref>;</highlight></codeline>
<codeline lineno="600"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>hash<sp/>=<sp/>tx.<ref refid="struct_new_mempool_transaction_info_1adc3fa961cbcf8cd3499ee68b1c81170b" kindref="member">info</ref>.<ref refid="struct_transaction_info_1a922340a8df5626de91524f28346f04da" kindref="member">m_tx</ref>-&gt;GetHash();</highlight></codeline>
<codeline lineno="601"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(mapMemPoolTxs.contains(hash))<sp/>{</highlight></codeline>
<codeline lineno="602"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a390409d91483ef8b1b33fbc3ff0f4918" kindref="member">BCLog::ESTIMATEFEE</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Blockpolicy<sp/>error<sp/>mempool<sp/>tx<sp/>%s<sp/>already<sp/>being<sp/>tracked\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="603"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hash.<ref refid="classtransaction__identifier_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="604"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="605"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="606"><highlight class="normal"></highlight></codeline>
<codeline lineno="607"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(txHeight<sp/>!=<sp/>nBestSeenHeight)<sp/>{</highlight></codeline>
<codeline lineno="608"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ignore<sp/>side<sp/>chains<sp/>and<sp/>re-orgs;<sp/>assuming<sp/>they<sp/>are<sp/>random<sp/>they<sp/>don&apos;t</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="609"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>affect<sp/>the<sp/>estimate.<sp/><sp/>We&apos;ll<sp/>potentially<sp/>double<sp/>count<sp/>transactions<sp/>in<sp/>1-block<sp/>reorgs.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="610"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ignore<sp/>txs<sp/>if<sp/>BlockPolicyEstimator<sp/>is<sp/>not<sp/>in<sp/>sync<sp/>with<sp/>ActiveChain().Tip().</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="611"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>It<sp/>will<sp/>be<sp/>synced<sp/>next<sp/>time<sp/>a<sp/>block<sp/>is<sp/>processed.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="612"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="613"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="614"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>transaction<sp/>should<sp/>only<sp/>count<sp/>for<sp/>fee<sp/>estimation<sp/>if:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="615"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>it&apos;s<sp/>not<sp/>being<sp/>re-added<sp/>during<sp/>a<sp/>reorg<sp/>which<sp/>bypasses<sp/>typical<sp/>mempool<sp/>fee<sp/>limits</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="616"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>the<sp/>node<sp/>is<sp/>not<sp/>behind</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="617"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>the<sp/>transaction<sp/>is<sp/>not<sp/>dependent<sp/>on<sp/>any<sp/>other<sp/>transactions<sp/>in<sp/>the<sp/>mempool</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="618"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>it&apos;s<sp/>not<sp/>part<sp/>of<sp/>a<sp/>package.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="619"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>validForFeeEstimation<sp/>=<sp/>!tx.<ref refid="struct_new_mempool_transaction_info_1a2d18d54e74de70af17b1aa4b613fa256" kindref="member">m_mempool_limit_bypassed</ref><sp/>&amp;&amp;<sp/>!tx.<ref refid="struct_new_mempool_transaction_info_1ac8c705c28b4833e28d970bdadd042791" kindref="member">m_submitted_in_package</ref><sp/>&amp;&amp;<sp/>tx.<ref refid="struct_new_mempool_transaction_info_1a5b628c222f72da07425fedb463747689" kindref="member">m_chainstate_is_current</ref><sp/>&amp;&amp;<sp/>tx.<ref refid="struct_new_mempool_transaction_info_1aa8a60dcdfa770ba0a5384ac7e0eb8dd4" kindref="member">m_has_no_mempool_parents</ref>;</highlight></codeline>
<codeline lineno="620"><highlight class="normal"></highlight></codeline>
<codeline lineno="621"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>want<sp/>to<sp/>be<sp/>updating<sp/>estimates<sp/>when<sp/>our<sp/>blockchain<sp/>is<sp/>synced,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="622"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>otherwise<sp/>we&apos;ll<sp/>miscalculate<sp/>how<sp/>many<sp/>blocks<sp/>its<sp/>taking<sp/>to<sp/>get<sp/>included.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="623"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!validForFeeEstimation)<sp/>{</highlight></codeline>
<codeline lineno="624"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>untrackedTxs++;</highlight></codeline>
<codeline lineno="625"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="626"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="627"><highlight class="normal"><sp/><sp/><sp/><sp/>trackedTxs++;</highlight></codeline>
<codeline lineno="628"><highlight class="normal"></highlight></codeline>
<codeline lineno="629"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Feerates<sp/>are<sp/>stored<sp/>and<sp/>reported<sp/>as<sp/>BTC-per-kb:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="630"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CFeeRate<sp/>feeRate(tx.<ref refid="struct_new_mempool_transaction_info_1adc3fa961cbcf8cd3499ee68b1c81170b" kindref="member">info</ref>.<ref refid="struct_transaction_info_1a534daa1a026a705d48942eb108ea37a6" kindref="member">m_fee</ref>,<sp/>tx.<ref refid="struct_new_mempool_transaction_info_1adc3fa961cbcf8cd3499ee68b1c81170b" kindref="member">info</ref>.<ref refid="struct_transaction_info_1a9e21091a1684ca43a73aa60b32527bc1" kindref="member">m_virtual_transaction_size</ref>);</highlight></codeline>
<codeline lineno="631"><highlight class="normal"></highlight></codeline>
<codeline lineno="632"><highlight class="normal"><sp/><sp/><sp/><sp/>mapMemPoolTxs[hash].blockHeight<sp/>=<sp/>txHeight;</highlight></codeline>
<codeline lineno="633"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>bucketIndex<sp/>=<sp/>feeStats-&gt;NewTx(txHeight,<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">double</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(feeRate.GetFeePerK()));</highlight></codeline>
<codeline lineno="634"><highlight class="normal"><sp/><sp/><sp/><sp/>mapMemPoolTxs[hash].bucketIndex<sp/>=<sp/>bucketIndex;</highlight></codeline>
<codeline lineno="635"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>bucketIndex2<sp/>=<sp/>shortStats-&gt;NewTx(txHeight,<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">double</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(feeRate.GetFeePerK()));</highlight></codeline>
<codeline lineno="636"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(bucketIndex<sp/>==<sp/>bucketIndex2);</highlight></codeline>
<codeline lineno="637"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>bucketIndex3<sp/>=<sp/>longStats-&gt;NewTx(txHeight,<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">double</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(feeRate.GetFeePerK()));</highlight></codeline>
<codeline lineno="638"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(bucketIndex<sp/>==<sp/>bucketIndex3);</highlight></codeline>
<codeline lineno="639"><highlight class="normal">}</highlight></codeline>
<codeline lineno="640"><highlight class="normal"></highlight></codeline>
<codeline lineno="641"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CBlockPolicyEstimator::processBlockTx(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nBlockHeight,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="struct_removed_mempool_transaction_info" kindref="compound">RemovedMempoolTransactionInfo</ref>&amp;<sp/>tx)</highlight></codeline>
<codeline lineno="642"><highlight class="normal">{</highlight></codeline>
<codeline lineno="643"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(m_cs_fee_estimator);</highlight></codeline>
<codeline lineno="644"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!_removeTx(tx.<ref refid="struct_removed_mempool_transaction_info_1adc3fa961cbcf8cd3499ee68b1c81170b" kindref="member">info</ref>.<ref refid="struct_transaction_info_1a922340a8df5626de91524f28346f04da" kindref="member">m_tx</ref>-&gt;GetHash(),<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="645"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>transaction<sp/>wasn&apos;t<sp/>being<sp/>tracked<sp/>for<sp/>fee<sp/>estimation</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="646"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="647"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="648"><highlight class="normal"></highlight></codeline>
<codeline lineno="649"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>How<sp/>many<sp/>blocks<sp/>did<sp/>it<sp/>take<sp/>for<sp/>miners<sp/>to<sp/>include<sp/>this<sp/>transaction?</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="650"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>blocksToConfirm<sp/>is<sp/>1-based,<sp/>so<sp/>a<sp/>transaction<sp/>included<sp/>in<sp/>the<sp/>earliest</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="651"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>possible<sp/>block<sp/>has<sp/>confirmation<sp/>count<sp/>of<sp/>1</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="652"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>blocksToConfirm<sp/>=<sp/>nBlockHeight<sp/>-<sp/>tx.<ref refid="struct_removed_mempool_transaction_info_1adc3fa961cbcf8cd3499ee68b1c81170b" kindref="member">info</ref>.<ref refid="struct_transaction_info_1afbb87c9970019c30a84a2005a94dae57" kindref="member">txHeight</ref>;</highlight></codeline>
<codeline lineno="653"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(blocksToConfirm<sp/>&lt;=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="654"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>can&apos;t<sp/>happen<sp/>because<sp/>we<sp/>don&apos;t<sp/>process<sp/>transactions<sp/>from<sp/>a<sp/>block<sp/>with<sp/>a<sp/>height</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="655"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>lower<sp/>than<sp/>our<sp/>greatest<sp/>seen<sp/>height</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="656"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a390409d91483ef8b1b33fbc3ff0f4918" kindref="member">BCLog::ESTIMATEFEE</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Blockpolicy<sp/>error<sp/>Transaction<sp/>had<sp/>negative<sp/>blocksToConfirm\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="657"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="658"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="659"><highlight class="normal"></highlight></codeline>
<codeline lineno="660"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Feerates<sp/>are<sp/>stored<sp/>and<sp/>reported<sp/>as<sp/>BTC-per-kb:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="661"><highlight class="normal"><sp/><sp/><sp/><sp/>CFeeRate<sp/>feeRate(tx.<ref refid="struct_removed_mempool_transaction_info_1adc3fa961cbcf8cd3499ee68b1c81170b" kindref="member">info</ref>.<ref refid="struct_transaction_info_1a534daa1a026a705d48942eb108ea37a6" kindref="member">m_fee</ref>,<sp/>tx.<ref refid="struct_removed_mempool_transaction_info_1adc3fa961cbcf8cd3499ee68b1c81170b" kindref="member">info</ref>.<ref refid="struct_transaction_info_1a9e21091a1684ca43a73aa60b32527bc1" kindref="member">m_virtual_transaction_size</ref>);</highlight></codeline>
<codeline lineno="662"><highlight class="normal"></highlight></codeline>
<codeline lineno="663"><highlight class="normal"><sp/><sp/><sp/><sp/>feeStats-&gt;Record(blocksToConfirm,<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">double</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(feeRate.GetFeePerK()));</highlight></codeline>
<codeline lineno="664"><highlight class="normal"><sp/><sp/><sp/><sp/>shortStats-&gt;Record(blocksToConfirm,<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">double</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(feeRate.GetFeePerK()));</highlight></codeline>
<codeline lineno="665"><highlight class="normal"><sp/><sp/><sp/><sp/>longStats-&gt;Record(blocksToConfirm,<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">double</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(feeRate.GetFeePerK()));</highlight></codeline>
<codeline lineno="666"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="667"><highlight class="normal">}</highlight></codeline>
<codeline lineno="668"><highlight class="normal"></highlight></codeline>
<codeline lineno="669"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_c_block_policy_estimator_1a65f0b56680542778f34609dca718e8c6" kindref="member">CBlockPolicyEstimator::processBlock</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;RemovedMempoolTransactionInfo&gt;&amp;<sp/>txs_removed_for_block,</highlight></codeline>
<codeline lineno="670"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nBlockHeight)</highlight></codeline>
<codeline lineno="671"><highlight class="normal">{</highlight></codeline>
<codeline lineno="672"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_cs_fee_estimator);</highlight></codeline>
<codeline lineno="673"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nBlockHeight<sp/>&lt;=<sp/>nBestSeenHeight)<sp/>{</highlight></codeline>
<codeline lineno="674"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ignore<sp/>side<sp/>chains<sp/>and<sp/>re-orgs;<sp/>assuming<sp/>they<sp/>are<sp/>random</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>they<sp/>don&apos;t<sp/>affect<sp/>the<sp/>estimate.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="676"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>And<sp/>if<sp/>an<sp/>attacker<sp/>can<sp/>re-org<sp/>the<sp/>chain<sp/>at<sp/>will,<sp/>then</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="677"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>you&apos;ve<sp/>got<sp/>much<sp/>bigger<sp/>problems<sp/>than<sp/>&quot;attacker<sp/>can<sp/>influence</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="678"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transaction<sp/>fees.&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="679"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="680"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="681"><highlight class="normal"></highlight></codeline>
<codeline lineno="682"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Must<sp/>update<sp/>nBestSeenHeight<sp/>in<sp/>sync<sp/>with<sp/>ClearCurrent<sp/>so<sp/>that</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="683"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>calls<sp/>to<sp/>removeTx<sp/>(via<sp/>processBlockTx)<sp/>correctly<sp/>calculate<sp/>age</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="684"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>of<sp/>unconfirmed<sp/>txs<sp/>to<sp/>remove<sp/>from<sp/>tracking.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="685"><highlight class="normal"><sp/><sp/><sp/><sp/>nBestSeenHeight<sp/>=<sp/>nBlockHeight;</highlight></codeline>
<codeline lineno="686"><highlight class="normal"></highlight></codeline>
<codeline lineno="687"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Update<sp/>unconfirmed<sp/>circular<sp/>buffer</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="688"><highlight class="normal"><sp/><sp/><sp/><sp/>feeStats-&gt;ClearCurrent(nBlockHeight);</highlight></codeline>
<codeline lineno="689"><highlight class="normal"><sp/><sp/><sp/><sp/>shortStats-&gt;ClearCurrent(nBlockHeight);</highlight></codeline>
<codeline lineno="690"><highlight class="normal"><sp/><sp/><sp/><sp/>longStats-&gt;ClearCurrent(nBlockHeight);</highlight></codeline>
<codeline lineno="691"><highlight class="normal"></highlight></codeline>
<codeline lineno="692"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Decay<sp/>all<sp/>exponential<sp/>averages</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="693"><highlight class="normal"><sp/><sp/><sp/><sp/>feeStats-&gt;UpdateMovingAverages();</highlight></codeline>
<codeline lineno="694"><highlight class="normal"><sp/><sp/><sp/><sp/>shortStats-&gt;UpdateMovingAverages();</highlight></codeline>
<codeline lineno="695"><highlight class="normal"><sp/><sp/><sp/><sp/>longStats-&gt;UpdateMovingAverages();</highlight></codeline>
<codeline lineno="696"><highlight class="normal"></highlight></codeline>
<codeline lineno="697"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>countedTxs<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="698"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Update<sp/>averages<sp/>with<sp/>data<sp/>points<sp/>from<sp/>current<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="699"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tx<sp/>:<sp/>txs_removed_for_block)<sp/>{</highlight></codeline>
<codeline lineno="700"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(processBlockTx(nBlockHeight,<sp/>tx))</highlight></codeline>
<codeline lineno="701"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>countedTxs++;</highlight></codeline>
<codeline lineno="702"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="703"><highlight class="normal"></highlight></codeline>
<codeline lineno="704"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(firstRecordedHeight<sp/>==<sp/>0<sp/>&amp;&amp;<sp/>countedTxs<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="705"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>firstRecordedHeight<sp/>=<sp/>nBestSeenHeight;</highlight></codeline>
<codeline lineno="706"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a390409d91483ef8b1b33fbc3ff0f4918" kindref="member">BCLog::ESTIMATEFEE</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Blockpolicy<sp/>first<sp/>recorded<sp/>height<sp/>%u\n&quot;</highlight><highlight class="normal">,<sp/>firstRecordedHeight);</highlight></codeline>
<codeline lineno="707"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="708"><highlight class="normal"></highlight></codeline>
<codeline lineno="709"><highlight class="normal"></highlight></codeline>
<codeline lineno="710"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a390409d91483ef8b1b33fbc3ff0f4918" kindref="member">BCLog::ESTIMATEFEE</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Blockpolicy<sp/>estimates<sp/>updated<sp/>by<sp/>%u<sp/>of<sp/>%u<sp/>block<sp/>txs,<sp/>since<sp/>last<sp/>block<sp/>%u<sp/>of<sp/>%u<sp/>tracked,<sp/>mempool<sp/>map<sp/>size<sp/>%u,<sp/>max<sp/>target<sp/>%u<sp/>from<sp/>%s\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="711"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>countedTxs,<sp/>txs_removed_for_block.size(),<sp/>trackedTxs,<sp/>trackedTxs<sp/>+<sp/>untrackedTxs,<sp/>mapMemPoolTxs.size(),</highlight></codeline>
<codeline lineno="712"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MaxUsableEstimate(),<sp/>HistoricalBlockSpan()<sp/>&gt;<sp/>BlockSpan()<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;historical&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;current&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="713"><highlight class="normal"></highlight></codeline>
<codeline lineno="714"><highlight class="normal"><sp/><sp/><sp/><sp/>trackedTxs<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="715"><highlight class="normal"><sp/><sp/><sp/><sp/>untrackedTxs<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="716"><highlight class="normal">}</highlight></codeline>
<codeline lineno="717"><highlight class="normal"></highlight></codeline>
<codeline lineno="718"><highlight class="normal"><ref refid="class_c_fee_rate" kindref="compound">CFeeRate</ref><sp/><ref refid="class_c_block_policy_estimator_1ad080776568edc383fecca04b03922daa" kindref="member">CBlockPolicyEstimator::estimateFee</ref>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>confTarget)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="719"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="720"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>It&apos;s<sp/>not<sp/>possible<sp/>to<sp/>get<sp/>reasonable<sp/>estimates<sp/>for<sp/>confTarget<sp/>of<sp/>1</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="721"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(confTarget<sp/>&lt;=<sp/>1)</highlight></codeline>
<codeline lineno="722"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>CFeeRate(0);</highlight></codeline>
<codeline lineno="723"><highlight class="normal"></highlight></codeline>
<codeline lineno="724"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="class_c_block_policy_estimator_1aebb09054edb6c8141fd011472b7913d7" kindref="member">estimateRawFee</ref>(confTarget,<sp/>DOUBLE_SUCCESS_PCT,<sp/><ref refid="block__policy__estimator_8h_1a8e4bdf4356d17e4e14401a8c92da04f2a8411fd05f06f8ddba21bddb6c720635e" kindref="member">FeeEstimateHorizon::MED_HALFLIFE</ref>);</highlight></codeline>
<codeline lineno="725"><highlight class="normal">}</highlight></codeline>
<codeline lineno="726"><highlight class="normal"></highlight></codeline>
<codeline lineno="727"><highlight class="normal"><ref refid="class_c_fee_rate" kindref="compound">CFeeRate</ref><sp/><ref refid="class_c_block_policy_estimator_1aebb09054edb6c8141fd011472b7913d7" kindref="member">CBlockPolicyEstimator::estimateRawFee</ref>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>confTarget,<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>successThreshold,<sp/><ref refid="block__policy__estimator_8h_1a8e4bdf4356d17e4e14401a8c92da04f2" kindref="member">FeeEstimateHorizon</ref><sp/>horizon,<sp/><ref refid="struct_estimation_result" kindref="compound">EstimationResult</ref>*<sp/>result)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="728"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="729"><highlight class="normal"><sp/><sp/><sp/><sp/>TxConfirmStats*<sp/>stats<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="730"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>sufficientTxs<sp/>=<sp/>SUFFICIENT_FEETXS;</highlight></codeline>
<codeline lineno="731"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(horizon)<sp/>{</highlight></codeline>
<codeline lineno="732"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="block__policy__estimator_8h_1a8e4bdf4356d17e4e14401a8c92da04f2a55535e5be30f4713167dd5225a9b89c6" kindref="member">FeeEstimateHorizon::SHORT_HALFLIFE</ref>:<sp/>{</highlight></codeline>
<codeline lineno="733"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats<sp/>=<sp/>shortStats.get();</highlight></codeline>
<codeline lineno="734"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sufficientTxs<sp/>=<sp/>SUFFICIENT_TXS_SHORT;</highlight></codeline>
<codeline lineno="735"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="736"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="737"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="block__policy__estimator_8h_1a8e4bdf4356d17e4e14401a8c92da04f2a8411fd05f06f8ddba21bddb6c720635e" kindref="member">FeeEstimateHorizon::MED_HALFLIFE</ref>:<sp/>{</highlight></codeline>
<codeline lineno="738"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats<sp/>=<sp/>feeStats.get();</highlight></codeline>
<codeline lineno="739"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="740"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="741"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="block__policy__estimator_8h_1a8e4bdf4356d17e4e14401a8c92da04f2a2121a90b0e675bc3669cbb1ef9d1dfb6" kindref="member">FeeEstimateHorizon::LONG_HALFLIFE</ref>:<sp/>{</highlight></codeline>
<codeline lineno="742"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats<sp/>=<sp/>longStats.get();</highlight></codeline>
<codeline lineno="743"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="744"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="745"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>no<sp/>default<sp/>case,<sp/>so<sp/>the<sp/>compiler<sp/>can<sp/>warn<sp/>about<sp/>missing<sp/>cases</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="746"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(stats);</highlight></codeline>
<codeline lineno="747"><highlight class="normal"></highlight></codeline>
<codeline lineno="748"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_cs_fee_estimator);</highlight></codeline>
<codeline lineno="749"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Return<sp/>failure<sp/>if<sp/>trying<sp/>to<sp/>analyze<sp/>a<sp/>target<sp/>we&apos;re<sp/>not<sp/>tracking</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="750"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(confTarget<sp/>&lt;=<sp/>0<sp/>||<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)confTarget<sp/>&gt;<sp/>stats-&gt;<ref refid="class_tx_confirm_stats_1a1780f7ece2fba74410d5f132f2c07e1b" kindref="member">GetMaxConfirms</ref>())</highlight></codeline>
<codeline lineno="751"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>CFeeRate(0);</highlight></codeline>
<codeline lineno="752"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(successThreshold<sp/>&gt;<sp/>1)</highlight></codeline>
<codeline lineno="753"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>CFeeRate(0);</highlight></codeline>
<codeline lineno="754"><highlight class="normal"></highlight></codeline>
<codeline lineno="755"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>median<sp/>=<sp/>stats-&gt;<ref refid="class_tx_confirm_stats_1a3f3b2a3c3e9038522985c4e70d2cee5c" kindref="member">EstimateMedianVal</ref>(confTarget,<sp/>sufficientTxs,<sp/>successThreshold,<sp/>nBestSeenHeight,<sp/>result);</highlight></codeline>
<codeline lineno="756"><highlight class="normal"></highlight></codeline>
<codeline lineno="757"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(median<sp/>&lt;<sp/>0)</highlight></codeline>
<codeline lineno="758"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>CFeeRate(0);</highlight></codeline>
<codeline lineno="759"><highlight class="normal"></highlight></codeline>
<codeline lineno="760"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>CFeeRate(llround(median));</highlight></codeline>
<codeline lineno="761"><highlight class="normal">}</highlight></codeline>
<codeline lineno="762"><highlight class="normal"></highlight></codeline>
<codeline lineno="763"><highlight class="normal"></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="class_c_block_policy_estimator_1a3efe98e3f82015824278af45fb8d07e5" kindref="member">CBlockPolicyEstimator::HighestTargetTracked</ref>(<ref refid="block__policy__estimator_8h_1a8e4bdf4356d17e4e14401a8c92da04f2" kindref="member">FeeEstimateHorizon</ref><sp/>horizon)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="764"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="765"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_cs_fee_estimator);</highlight></codeline>
<codeline lineno="766"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(horizon)<sp/>{</highlight></codeline>
<codeline lineno="767"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="block__policy__estimator_8h_1a8e4bdf4356d17e4e14401a8c92da04f2a55535e5be30f4713167dd5225a9b89c6" kindref="member">FeeEstimateHorizon::SHORT_HALFLIFE</ref>:<sp/>{</highlight></codeline>
<codeline lineno="768"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>shortStats-&gt;GetMaxConfirms();</highlight></codeline>
<codeline lineno="769"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="770"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="block__policy__estimator_8h_1a8e4bdf4356d17e4e14401a8c92da04f2a8411fd05f06f8ddba21bddb6c720635e" kindref="member">FeeEstimateHorizon::MED_HALFLIFE</ref>:<sp/>{</highlight></codeline>
<codeline lineno="771"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>feeStats-&gt;GetMaxConfirms();</highlight></codeline>
<codeline lineno="772"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="773"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="block__policy__estimator_8h_1a8e4bdf4356d17e4e14401a8c92da04f2a2121a90b0e675bc3669cbb1ef9d1dfb6" kindref="member">FeeEstimateHorizon::LONG_HALFLIFE</ref>:<sp/>{</highlight></codeline>
<codeline lineno="774"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>longStats-&gt;GetMaxConfirms();</highlight></codeline>
<codeline lineno="775"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="776"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>no<sp/>default<sp/>case,<sp/>so<sp/>the<sp/>compiler<sp/>can<sp/>warn<sp/>about<sp/>missing<sp/>cases</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="777"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(</highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="778"><highlight class="normal">}</highlight></codeline>
<codeline lineno="779"><highlight class="normal"></highlight></codeline>
<codeline lineno="780"><highlight class="normal"></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>CBlockPolicyEstimator::BlockSpan()</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="781"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="782"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(firstRecordedHeight<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="783"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(nBestSeenHeight<sp/>&gt;=<sp/>firstRecordedHeight);</highlight></codeline>
<codeline lineno="784"><highlight class="normal"></highlight></codeline>
<codeline lineno="785"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>nBestSeenHeight<sp/>-<sp/>firstRecordedHeight;</highlight></codeline>
<codeline lineno="786"><highlight class="normal">}</highlight></codeline>
<codeline lineno="787"><highlight class="normal"></highlight></codeline>
<codeline lineno="788"><highlight class="normal"></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>CBlockPolicyEstimator::HistoricalBlockSpan()</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="789"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="790"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(historicalFirst<sp/>==<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="791"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(historicalBest<sp/>&gt;=<sp/>historicalFirst);</highlight></codeline>
<codeline lineno="792"><highlight class="normal"></highlight></codeline>
<codeline lineno="793"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nBestSeenHeight<sp/>-<sp/>historicalBest<sp/>&gt;<sp/>OLDEST_ESTIMATE_HISTORY)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="794"><highlight class="normal"></highlight></codeline>
<codeline lineno="795"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>historicalBest<sp/>-<sp/>historicalFirst;</highlight></codeline>
<codeline lineno="796"><highlight class="normal">}</highlight></codeline>
<codeline lineno="797"><highlight class="normal"></highlight></codeline>
<codeline lineno="798"><highlight class="normal"></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>CBlockPolicyEstimator::MaxUsableEstimate()</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="799"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="800"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Block<sp/>spans<sp/>are<sp/>divided<sp/>by<sp/>2<sp/>to<sp/>make<sp/>sure<sp/>there<sp/>are<sp/>enough<sp/>potential<sp/>failing<sp/>data<sp/>points<sp/>for<sp/>the<sp/>estimate</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="801"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::min(longStats-&gt;GetMaxConfirms(),<sp/>std::max(BlockSpan(),<sp/>HistoricalBlockSpan())<sp/>/<sp/>2);</highlight></codeline>
<codeline lineno="802"><highlight class="normal">}</highlight></codeline>
<codeline lineno="803"><highlight class="normal"></highlight></codeline>
<codeline lineno="808"><highlight class="normal"></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>CBlockPolicyEstimator::estimateCombinedFee(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>confTarget,<sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>successThreshold,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>checkShorterHorizon,<sp/><ref refid="struct_estimation_result" kindref="compound">EstimationResult</ref><sp/>*result)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="809"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="810"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>estimate<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="811"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(confTarget<sp/>&gt;=<sp/>1<sp/>&amp;&amp;<sp/>confTarget<sp/>&lt;=<sp/>longStats-&gt;GetMaxConfirms())<sp/>{</highlight></codeline>
<codeline lineno="812"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Find<sp/>estimate<sp/>from<sp/>shortest<sp/>time<sp/>horizon<sp/>possible</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="813"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(confTarget<sp/>&lt;=<sp/>shortStats-&gt;GetMaxConfirms())<sp/>{<sp/></highlight><highlight class="comment">//<sp/>short<sp/>horizon</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="814"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>estimate<sp/>=<sp/>shortStats-&gt;EstimateMedianVal(confTarget,<sp/>SUFFICIENT_TXS_SHORT,<sp/>successThreshold,<sp/>nBestSeenHeight,<sp/>result);</highlight></codeline>
<codeline lineno="815"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="816"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(confTarget<sp/>&lt;=<sp/>feeStats-&gt;GetMaxConfirms())<sp/>{<sp/></highlight><highlight class="comment">//<sp/>medium<sp/>horizon</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="817"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>estimate<sp/>=<sp/>feeStats-&gt;EstimateMedianVal(confTarget,<sp/>SUFFICIENT_FEETXS,<sp/>successThreshold,<sp/>nBestSeenHeight,<sp/>result);</highlight></codeline>
<codeline lineno="818"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="819"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{<sp/></highlight><highlight class="comment">//<sp/>long<sp/>horizon</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="820"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>estimate<sp/>=<sp/>longStats-&gt;EstimateMedianVal(confTarget,<sp/>SUFFICIENT_FEETXS,<sp/>successThreshold,<sp/>nBestSeenHeight,<sp/>result);</highlight></codeline>
<codeline lineno="821"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="822"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(checkShorterHorizon)<sp/>{</highlight></codeline>
<codeline lineno="823"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>EstimationResult<sp/>tempResult;</highlight></codeline>
<codeline lineno="824"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>a<sp/>lower<sp/>confTarget<sp/>from<sp/>a<sp/>more<sp/>recent<sp/>horizon<sp/>returns<sp/>a<sp/>lower<sp/>answer<sp/>use<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="825"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(confTarget<sp/>&gt;<sp/>feeStats-&gt;GetMaxConfirms())<sp/>{</highlight></codeline>
<codeline lineno="826"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>medMax<sp/>=<sp/>feeStats-&gt;EstimateMedianVal(feeStats-&gt;GetMaxConfirms(),<sp/>SUFFICIENT_FEETXS,<sp/>successThreshold,<sp/>nBestSeenHeight,<sp/>&amp;tempResult);</highlight></codeline>
<codeline lineno="827"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(medMax<sp/>&gt;<sp/>0<sp/>&amp;&amp;<sp/>(estimate<sp/>==<sp/>-1<sp/>||<sp/>medMax<sp/>&lt;<sp/>estimate))<sp/>{</highlight></codeline>
<codeline lineno="828"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>estimate<sp/>=<sp/>medMax;</highlight></codeline>
<codeline lineno="829"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(result)<sp/>*result<sp/>=<sp/>tempResult;</highlight></codeline>
<codeline lineno="830"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="831"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="832"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(confTarget<sp/>&gt;<sp/>shortStats-&gt;GetMaxConfirms())<sp/>{</highlight></codeline>
<codeline lineno="833"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>shortMax<sp/>=<sp/>shortStats-&gt;EstimateMedianVal(shortStats-&gt;GetMaxConfirms(),<sp/>SUFFICIENT_TXS_SHORT,<sp/>successThreshold,<sp/>nBestSeenHeight,<sp/>&amp;tempResult);</highlight></codeline>
<codeline lineno="834"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(shortMax<sp/>&gt;<sp/>0<sp/>&amp;&amp;<sp/>(estimate<sp/>==<sp/>-1<sp/>||<sp/>shortMax<sp/>&lt;<sp/>estimate))<sp/>{</highlight></codeline>
<codeline lineno="835"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>estimate<sp/>=<sp/>shortMax;</highlight></codeline>
<codeline lineno="836"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(result)<sp/>*result<sp/>=<sp/>tempResult;</highlight></codeline>
<codeline lineno="837"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="838"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="839"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="840"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="841"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>estimate;</highlight></codeline>
<codeline lineno="842"><highlight class="normal">}</highlight></codeline>
<codeline lineno="843"><highlight class="normal"></highlight></codeline>
<codeline lineno="847"><highlight class="normal"></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>CBlockPolicyEstimator::estimateConservativeFee(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>doubleTarget,<sp/><ref refid="struct_estimation_result" kindref="compound">EstimationResult</ref><sp/>*result)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="848"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="849"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>estimate<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="850"><highlight class="normal"><sp/><sp/><sp/><sp/>EstimationResult<sp/>tempResult;</highlight></codeline>
<codeline lineno="851"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(doubleTarget<sp/>&lt;=<sp/>shortStats-&gt;GetMaxConfirms())<sp/>{</highlight></codeline>
<codeline lineno="852"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>estimate<sp/>=<sp/>feeStats-&gt;EstimateMedianVal(doubleTarget,<sp/>SUFFICIENT_FEETXS,<sp/>DOUBLE_SUCCESS_PCT,<sp/>nBestSeenHeight,<sp/>result);</highlight></codeline>
<codeline lineno="853"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="854"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(doubleTarget<sp/>&lt;=<sp/>feeStats-&gt;GetMaxConfirms())<sp/>{</highlight></codeline>
<codeline lineno="855"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>longEstimate<sp/>=<sp/>longStats-&gt;EstimateMedianVal(doubleTarget,<sp/>SUFFICIENT_FEETXS,<sp/>DOUBLE_SUCCESS_PCT,<sp/>nBestSeenHeight,<sp/>&amp;tempResult);</highlight></codeline>
<codeline lineno="856"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(longEstimate<sp/>&gt;<sp/>estimate)<sp/>{</highlight></codeline>
<codeline lineno="857"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>estimate<sp/>=<sp/>longEstimate;</highlight></codeline>
<codeline lineno="858"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(result)<sp/>*result<sp/>=<sp/>tempResult;</highlight></codeline>
<codeline lineno="859"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="860"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="861"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>estimate;</highlight></codeline>
<codeline lineno="862"><highlight class="normal">}</highlight></codeline>
<codeline lineno="863"><highlight class="normal"></highlight></codeline>
<codeline lineno="871"><highlight class="normal"><ref refid="class_c_fee_rate" kindref="compound">CFeeRate</ref><sp/><ref refid="class_c_block_policy_estimator_1a91a7a3600d2d4ed050dddc8af78344d4" kindref="member">CBlockPolicyEstimator::estimateSmartFee</ref>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>confTarget,<sp/><ref refid="struct_fee_calculation" kindref="compound">FeeCalculation</ref><sp/>*feeCalc,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>conservative)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="872"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="873"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_cs_fee_estimator);</highlight></codeline>
<codeline lineno="874"><highlight class="normal"></highlight></codeline>
<codeline lineno="875"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(feeCalc)<sp/>{</highlight></codeline>
<codeline lineno="876"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feeCalc-&gt;<ref refid="struct_fee_calculation_1a2e685a1e7bf4d672a9860f5b35675d30" kindref="member">desiredTarget</ref><sp/>=<sp/>confTarget;</highlight></codeline>
<codeline lineno="877"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feeCalc-&gt;<ref refid="struct_fee_calculation_1aaa03c371d7c462bbbfbe38b50f4c5e42" kindref="member">returnedTarget</ref><sp/>=<sp/>confTarget;</highlight></codeline>
<codeline lineno="878"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feeCalc-&gt;<ref refid="struct_fee_calculation_1a9c407bff50127f7cdd26b4495d436e01" kindref="member">best_height</ref><sp/>=<sp/>nBestSeenHeight;</highlight></codeline>
<codeline lineno="879"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="880"><highlight class="normal"></highlight></codeline>
<codeline lineno="881"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>median<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="882"><highlight class="normal"><sp/><sp/><sp/><sp/>EstimationResult<sp/>tempResult;</highlight></codeline>
<codeline lineno="883"><highlight class="normal"></highlight></codeline>
<codeline lineno="884"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Return<sp/>failure<sp/>if<sp/>trying<sp/>to<sp/>analyze<sp/>a<sp/>target<sp/>we&apos;re<sp/>not<sp/>tracking</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="885"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(confTarget<sp/>&lt;=<sp/>0<sp/>||<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)confTarget<sp/>&gt;<sp/>longStats-&gt;GetMaxConfirms())<sp/>{</highlight></codeline>
<codeline lineno="886"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>CFeeRate(0);<sp/><sp/></highlight><highlight class="comment">//<sp/>error<sp/>condition</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="887"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="888"><highlight class="normal"></highlight></codeline>
<codeline lineno="889"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>It&apos;s<sp/>not<sp/>possible<sp/>to<sp/>get<sp/>reasonable<sp/>estimates<sp/>for<sp/>confTarget<sp/>of<sp/>1</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="890"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(confTarget<sp/>==<sp/>1)<sp/>confTarget<sp/>=<sp/>2;</highlight></codeline>
<codeline lineno="891"><highlight class="normal"></highlight></codeline>
<codeline lineno="892"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>maxUsableEstimate<sp/>=<sp/>MaxUsableEstimate();</highlight></codeline>
<codeline lineno="893"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)confTarget<sp/>&gt;<sp/>maxUsableEstimate)<sp/>{</highlight></codeline>
<codeline lineno="894"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>confTarget<sp/>=<sp/>maxUsableEstimate;</highlight></codeline>
<codeline lineno="895"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="896"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(feeCalc)<sp/>feeCalc-&gt;<ref refid="struct_fee_calculation_1aaa03c371d7c462bbbfbe38b50f4c5e42" kindref="member">returnedTarget</ref><sp/>=<sp/>confTarget;</highlight></codeline>
<codeline lineno="897"><highlight class="normal"></highlight></codeline>
<codeline lineno="898"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(confTarget<sp/>&lt;=<sp/>1)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>CFeeRate(0);<sp/></highlight><highlight class="comment">//<sp/>error<sp/>condition</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="899"><highlight class="normal"></highlight></codeline>
<codeline lineno="900"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(confTarget<sp/>&gt;<sp/>0);<sp/></highlight><highlight class="comment">//estimateCombinedFee<sp/>and<sp/>estimateConservativeFee<sp/>take<sp/>unsigned<sp/>ints</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="919"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>halfEst<sp/>=<sp/>estimateCombinedFee(confTarget/2,<sp/>HALF_SUCCESS_PCT,<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">,<sp/>&amp;tempResult);</highlight></codeline>
<codeline lineno="920"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(feeCalc)<sp/>{</highlight></codeline>
<codeline lineno="921"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feeCalc-&gt;<ref refid="struct_fee_calculation_1a3a75e6fc8d51dc1fdfe24f873f9508f3" kindref="member">est</ref><sp/>=<sp/>tempResult;</highlight></codeline>
<codeline lineno="922"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feeCalc-&gt;<ref refid="struct_fee_calculation_1a8f1067343a7b638a11110cb23ad17b2c" kindref="member">reason</ref><sp/>=<sp/><ref refid="block__policy__estimator_8h_1ad4442247e3a53b4e0e9142797e833186ac22b4a2aa17938cc65cf14e90a80e869" kindref="member">FeeReason::HALF_ESTIMATE</ref>;</highlight></codeline>
<codeline lineno="923"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="924"><highlight class="normal"><sp/><sp/><sp/><sp/>median<sp/>=<sp/>halfEst;</highlight></codeline>
<codeline lineno="925"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>actualEst<sp/>=<sp/>estimateCombinedFee(confTarget,<sp/>SUCCESS_PCT,<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">,<sp/>&amp;tempResult);</highlight></codeline>
<codeline lineno="926"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(actualEst<sp/>&gt;<sp/>median)<sp/>{</highlight></codeline>
<codeline lineno="927"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>median<sp/>=<sp/>actualEst;</highlight></codeline>
<codeline lineno="928"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(feeCalc)<sp/>{</highlight></codeline>
<codeline lineno="929"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feeCalc-&gt;<ref refid="struct_fee_calculation_1a3a75e6fc8d51dc1fdfe24f873f9508f3" kindref="member">est</ref><sp/>=<sp/>tempResult;</highlight></codeline>
<codeline lineno="930"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feeCalc-&gt;<ref refid="struct_fee_calculation_1a8f1067343a7b638a11110cb23ad17b2c" kindref="member">reason</ref><sp/>=<sp/><ref refid="block__policy__estimator_8h_1ad4442247e3a53b4e0e9142797e833186a804ce3e2a778b928177f624ac08b54bc" kindref="member">FeeReason::FULL_ESTIMATE</ref>;</highlight></codeline>
<codeline lineno="931"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="932"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="933"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>doubleEst<sp/>=<sp/>estimateCombinedFee(2<sp/>*<sp/>confTarget,<sp/>DOUBLE_SUCCESS_PCT,<sp/>!conservative,<sp/>&amp;tempResult);</highlight></codeline>
<codeline lineno="934"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(doubleEst<sp/>&gt;<sp/>median)<sp/>{</highlight></codeline>
<codeline lineno="935"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>median<sp/>=<sp/>doubleEst;</highlight></codeline>
<codeline lineno="936"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(feeCalc)<sp/>{</highlight></codeline>
<codeline lineno="937"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feeCalc-&gt;<ref refid="struct_fee_calculation_1a3a75e6fc8d51dc1fdfe24f873f9508f3" kindref="member">est</ref><sp/>=<sp/>tempResult;</highlight></codeline>
<codeline lineno="938"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feeCalc-&gt;<ref refid="struct_fee_calculation_1a8f1067343a7b638a11110cb23ad17b2c" kindref="member">reason</ref><sp/>=<sp/><ref refid="block__policy__estimator_8h_1ad4442247e3a53b4e0e9142797e833186acd1ed924a47883b85646649d3a6097f8" kindref="member">FeeReason::DOUBLE_ESTIMATE</ref>;</highlight></codeline>
<codeline lineno="939"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="940"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="941"><highlight class="normal"></highlight></codeline>
<codeline lineno="942"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(conservative<sp/>||<sp/>median<sp/>==<sp/>-1)<sp/>{</highlight></codeline>
<codeline lineno="943"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>consEst<sp/>=<sp/><sp/>estimateConservativeFee(2<sp/>*<sp/>confTarget,<sp/>&amp;tempResult);</highlight></codeline>
<codeline lineno="944"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(consEst<sp/>&gt;<sp/>median)<sp/>{</highlight></codeline>
<codeline lineno="945"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>median<sp/>=<sp/>consEst;</highlight></codeline>
<codeline lineno="946"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(feeCalc)<sp/>{</highlight></codeline>
<codeline lineno="947"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feeCalc-&gt;<ref refid="struct_fee_calculation_1a3a75e6fc8d51dc1fdfe24f873f9508f3" kindref="member">est</ref><sp/>=<sp/>tempResult;</highlight></codeline>
<codeline lineno="948"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feeCalc-&gt;<ref refid="struct_fee_calculation_1a8f1067343a7b638a11110cb23ad17b2c" kindref="member">reason</ref><sp/>=<sp/><ref refid="block__policy__estimator_8h_1ad4442247e3a53b4e0e9142797e833186a321c4353253381c1d9274aea14ee6d38" kindref="member">FeeReason::CONSERVATIVE</ref>;</highlight></codeline>
<codeline lineno="949"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="950"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="951"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="952"><highlight class="normal"></highlight></codeline>
<codeline lineno="953"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(median<sp/>&lt;<sp/>0)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>CFeeRate(0);<sp/></highlight><highlight class="comment">//<sp/>error<sp/>condition</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="954"><highlight class="normal"></highlight></codeline>
<codeline lineno="955"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>CFeeRate(llround(median));</highlight></codeline>
<codeline lineno="956"><highlight class="normal">}</highlight></codeline>
<codeline lineno="957"><highlight class="normal"></highlight></codeline>
<codeline lineno="958"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_c_block_policy_estimator_1aeccd7769dcdae47867184fd809016799" kindref="member">CBlockPolicyEstimator::Flush</ref>()<sp/>{</highlight></codeline>
<codeline lineno="959"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_block_policy_estimator_1a0814f91b291e30546df18c6831b3ae8b" kindref="member">FlushUnconfirmed</ref>();</highlight></codeline>
<codeline lineno="960"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="class_c_block_policy_estimator_1a39973876d07137743f37456b71c5711b" kindref="member">FlushFeeEstimates</ref>();</highlight></codeline>
<codeline lineno="961"><highlight class="normal">}</highlight></codeline>
<codeline lineno="962"><highlight class="normal"></highlight></codeline>
<codeline lineno="963"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_c_block_policy_estimator_1a39973876d07137743f37456b71c5711b" kindref="member">CBlockPolicyEstimator::FlushFeeEstimates</ref>()</highlight></codeline>
<codeline lineno="964"><highlight class="normal">{</highlight></codeline>
<codeline lineno="965"><highlight class="normal"><sp/><sp/><sp/><sp/>AutoFile<sp/>est_file{<ref refid="namespacefsbridge_1a52093f6db7ef176f21e89f9e46367ded" kindref="member">fsbridge::fopen</ref>(m_estimation_filepath,<sp/></highlight><highlight class="stringliteral">&quot;wb&quot;</highlight><highlight class="normal">)};</highlight></codeline>
<codeline lineno="966"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(est_file.<ref refid="class_auto_file_1ac4d637a0dec45d546495c1660c9f6047" kindref="member">IsNull</ref>()<sp/>||<sp/>!<ref refid="class_c_block_policy_estimator_1a38b652a99060c3e2ec89ce60f1c3b71a" kindref="member">Write</ref>(est_file))<sp/>{</highlight></codeline>
<codeline lineno="967"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>write<sp/>fee<sp/>estimates<sp/>to<sp/>%s.<sp/>Continue<sp/>anyway.&quot;</highlight><highlight class="normal">,<sp/>fs::PathToString(m_estimation_filepath));</highlight></codeline>
<codeline lineno="968"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(void)est_file.<ref refid="class_auto_file_1a8b9c3a533b9c6429d63aa0a970fb214c" kindref="member">fclose</ref>();</highlight></codeline>
<codeline lineno="969"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="970"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="971"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(est_file.<ref refid="class_auto_file_1a8b9c3a533b9c6429d63aa0a970fb214c" kindref="member">fclose</ref>()<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="972"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>close<sp/>fee<sp/>estimates<sp/>file<sp/>%s:<sp/>%s.<sp/>Continuing<sp/>anyway.&quot;</highlight><highlight class="normal">,<sp/>fs::PathToString(m_estimation_filepath),<sp/><ref refid="syserror_8cpp_1aed54b21219b1bf6d2e7367bd5ece9482" kindref="member">SysErrorString</ref>(errno));</highlight></codeline>
<codeline lineno="973"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="974"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="975"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Flushed<sp/>fee<sp/>estimates<sp/>to<sp/>%s.&quot;</highlight><highlight class="normal">,<sp/>fs::PathToString(m_estimation_filepath.filename()));</highlight></codeline>
<codeline lineno="976"><highlight class="normal">}</highlight></codeline>
<codeline lineno="977"><highlight class="normal"></highlight></codeline>
<codeline lineno="978"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_c_block_policy_estimator_1a38b652a99060c3e2ec89ce60f1c3b71a" kindref="member">CBlockPolicyEstimator::Write</ref>(<ref refid="class_auto_file" kindref="compound">AutoFile</ref>&amp;<sp/>fileout)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="979"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="980"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="981"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_cs_fee_estimator);</highlight></codeline>
<codeline lineno="982"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fileout<sp/>&lt;&lt;<sp/><ref refid="block__policy__estimator_8cpp_1a7b6bea4ad824d119546ccc55158e72d8" kindref="member">CURRENT_FEES_FILE_VERSION</ref>;</highlight></codeline>
<codeline lineno="983"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fileout<sp/>&lt;&lt;<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal">{0};<sp/></highlight><highlight class="comment">//<sp/>Unused<sp/>dummy<sp/>field.<sp/>Written<sp/>files<sp/>may<sp/>contain<sp/>any<sp/>value<sp/>in<sp/>[0,<sp/>289900]</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="984"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fileout<sp/>&lt;&lt;<sp/>nBestSeenHeight;</highlight></codeline>
<codeline lineno="985"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(BlockSpan()<sp/>&gt;<sp/>HistoricalBlockSpan()/2)<sp/>{</highlight></codeline>
<codeline lineno="986"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fileout<sp/>&lt;&lt;<sp/>firstRecordedHeight<sp/>&lt;&lt;<sp/>nBestSeenHeight;</highlight></codeline>
<codeline lineno="987"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="988"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="989"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fileout<sp/>&lt;&lt;<sp/>historicalFirst<sp/>&lt;&lt;<sp/>historicalBest;</highlight></codeline>
<codeline lineno="990"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="991"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fileout<sp/>&lt;&lt;<sp/>Using&lt;VectorFormatter&lt;EncodedDoubleFormatter&gt;&gt;(buckets);</highlight></codeline>
<codeline lineno="992"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feeStats-&gt;Write(fileout);</highlight></codeline>
<codeline lineno="993"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>shortStats-&gt;Write(fileout);</highlight></codeline>
<codeline lineno="994"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>longStats-&gt;Write(fileout);</highlight></codeline>
<codeline lineno="995"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="996"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::exception&amp;)<sp/>{</highlight></codeline>
<codeline lineno="997"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;Unable<sp/>to<sp/>write<sp/>policy<sp/>estimator<sp/>data<sp/>(non-fatal)&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="998"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="999"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1000"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1001"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1002"><highlight class="normal"></highlight></codeline>
<codeline lineno="1003"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="class_c_block_policy_estimator_1ad3295f8549a3322f053137055a15ecf9" kindref="member">CBlockPolicyEstimator::Read</ref>(<ref refid="class_auto_file" kindref="compound">AutoFile</ref>&amp;<sp/>filein)</highlight></codeline>
<codeline lineno="1004"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1005"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1006"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_cs_fee_estimator);</highlight></codeline>
<codeline lineno="1007"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nVersionRequired,<sp/>dummy;</highlight></codeline>
<codeline lineno="1008"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>filein<sp/>&gt;&gt;<sp/>nVersionRequired<sp/>&gt;&gt;<sp/>dummy;</highlight></codeline>
<codeline lineno="1009"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nVersionRequired<sp/>&gt;<sp/><ref refid="block__policy__estimator_8cpp_1a7b6bea4ad824d119546ccc55158e72d8" kindref="member">CURRENT_FEES_FILE_VERSION</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1010"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/>std::runtime_error{<ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;File<sp/>version<sp/>(%d)<sp/>too<sp/>high<sp/>to<sp/>be<sp/>read.&quot;</highlight><highlight class="normal">,<sp/>nVersionRequired)};</highlight></codeline>
<codeline lineno="1011"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1012"><highlight class="normal"></highlight></codeline>
<codeline lineno="1013"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Read<sp/>fee<sp/>estimates<sp/>file<sp/>into<sp/>temporary<sp/>variables<sp/>so<sp/>existing<sp/>data</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1014"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>structures<sp/>aren&apos;t<sp/>corrupted<sp/>if<sp/>there<sp/>is<sp/>an<sp/>exception.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1015"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nFileBestSeenHeight;</highlight></codeline>
<codeline lineno="1016"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>filein<sp/>&gt;&gt;<sp/>nFileBestSeenHeight;</highlight></codeline>
<codeline lineno="1017"><highlight class="normal"></highlight></codeline>
<codeline lineno="1018"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nVersionRequired<sp/>&lt;<sp/><ref refid="block__policy__estimator_8cpp_1a7b6bea4ad824d119546ccc55158e72d8" kindref="member">CURRENT_FEES_FILE_VERSION</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1019"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;Incompatible<sp/>old<sp/>fee<sp/>estimation<sp/>data<sp/>(non-fatal).<sp/>Version:<sp/>%d&quot;</highlight><highlight class="normal">,<sp/>nVersionRequired);</highlight></codeline>
<codeline lineno="1020"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{<sp/></highlight><highlight class="comment">//<sp/>nVersionRequired<sp/>==<sp/>CURRENT_FEES_FILE_VERSION</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1021"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nFileHistoricalFirst,<sp/>nFileHistoricalBest;</highlight></codeline>
<codeline lineno="1022"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>filein<sp/>&gt;&gt;<sp/>nFileHistoricalFirst<sp/>&gt;&gt;<sp/>nFileHistoricalBest;</highlight></codeline>
<codeline lineno="1023"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nFileHistoricalFirst<sp/>&gt;<sp/>nFileHistoricalBest<sp/>||<sp/>nFileHistoricalBest<sp/>&gt;<sp/>nFileBestSeenHeight)<sp/>{</highlight></codeline>
<codeline lineno="1024"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/>std::runtime_error(</highlight><highlight class="stringliteral">&quot;Corrupt<sp/>estimates<sp/>file.<sp/>Historical<sp/>block<sp/>range<sp/>for<sp/>estimates<sp/>is<sp/>invalid&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1025"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1026"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;double&gt;<sp/>fileBuckets;</highlight></codeline>
<codeline lineno="1027"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>filein<sp/>&gt;&gt;<sp/>Using&lt;VectorFormatter&lt;EncodedDoubleFormatter&gt;&gt;(fileBuckets);</highlight></codeline>
<codeline lineno="1028"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>numBuckets<sp/>=<sp/>fileBuckets.<ref refid="class_auto_file_1aefa4cbcbdc75e346ec1ffadacbc0a72b" kindref="member">size</ref>();</highlight></codeline>
<codeline lineno="1029"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(numBuckets<sp/>&lt;=<sp/>1<sp/>||<sp/>numBuckets<sp/>&gt;<sp/>1000)<sp/>{</highlight></codeline>
<codeline lineno="1030"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/>std::runtime_error(</highlight><highlight class="stringliteral">&quot;Corrupt<sp/>estimates<sp/>file.<sp/>Must<sp/>have<sp/>between<sp/>2<sp/>and<sp/>1000<sp/>feerate<sp/>buckets&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1031"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1032"><highlight class="normal"></highlight></codeline>
<codeline lineno="1033"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::unique_ptr&lt;TxConfirmStats&gt;<sp/>fileFeeStats(</highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>TxConfirmStats(buckets,<sp/>bucketMap,<sp/>MED_BLOCK_PERIODS,<sp/>MED_DECAY,<sp/>MED_SCALE));</highlight></codeline>
<codeline lineno="1034"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::unique_ptr&lt;TxConfirmStats&gt;<sp/>fileShortStats(</highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>TxConfirmStats(buckets,<sp/>bucketMap,<sp/>SHORT_BLOCK_PERIODS,<sp/>SHORT_DECAY,<sp/>SHORT_SCALE));</highlight></codeline>
<codeline lineno="1035"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::unique_ptr&lt;TxConfirmStats&gt;<sp/>fileLongStats(</highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>TxConfirmStats(buckets,<sp/>bucketMap,<sp/>LONG_BLOCK_PERIODS,<sp/>LONG_DECAY,<sp/>LONG_SCALE));</highlight></codeline>
<codeline lineno="1036"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fileFeeStats-&gt;Read(filein,<sp/>numBuckets);</highlight></codeline>
<codeline lineno="1037"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fileShortStats-&gt;Read(filein,<sp/>numBuckets);</highlight></codeline>
<codeline lineno="1038"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fileLongStats-&gt;Read(filein,<sp/>numBuckets);</highlight></codeline>
<codeline lineno="1039"><highlight class="normal"></highlight></codeline>
<codeline lineno="1040"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Fee<sp/>estimates<sp/>file<sp/>parsed<sp/>correctly</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1041"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Copy<sp/>buckets<sp/>from<sp/>file<sp/>and<sp/>refresh<sp/>our<sp/>bucketmap</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1042"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>buckets<sp/>=<sp/>fileBuckets;</highlight></codeline>
<codeline lineno="1043"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bucketMap.clear();</highlight></codeline>
<codeline lineno="1044"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>buckets.size();<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="1045"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bucketMap[buckets[i]]<sp/>=<sp/>i;</highlight></codeline>
<codeline lineno="1046"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1047"><highlight class="normal"></highlight></codeline>
<codeline lineno="1048"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Destroy<sp/>old<sp/>TxConfirmStats<sp/>and<sp/>point<sp/>to<sp/>new<sp/>ones<sp/>that<sp/>already<sp/>reference<sp/>buckets<sp/>and<sp/>bucketMap</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1049"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>feeStats<sp/>=<sp/>std::move(fileFeeStats);</highlight></codeline>
<codeline lineno="1050"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>shortStats<sp/>=<sp/>std::move(fileShortStats);</highlight></codeline>
<codeline lineno="1051"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>longStats<sp/>=<sp/>std::move(fileLongStats);</highlight></codeline>
<codeline lineno="1052"><highlight class="normal"></highlight></codeline>
<codeline lineno="1053"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nBestSeenHeight<sp/>=<sp/>nFileBestSeenHeight;</highlight></codeline>
<codeline lineno="1054"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>historicalFirst<sp/>=<sp/>nFileHistoricalFirst;</highlight></codeline>
<codeline lineno="1055"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>historicalBest<sp/>=<sp/>nFileHistoricalBest;</highlight></codeline>
<codeline lineno="1056"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1057"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1058"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::exception&amp;<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="1059"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;Unable<sp/>to<sp/>read<sp/>policy<sp/>estimator<sp/>data<sp/>(non-fatal):<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>e.what());</highlight></codeline>
<codeline lineno="1060"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1061"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1062"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1063"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1064"><highlight class="normal"></highlight></codeline>
<codeline lineno="1065"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="class_c_block_policy_estimator_1a0814f91b291e30546df18c6831b3ae8b" kindref="member">CBlockPolicyEstimator::FlushUnconfirmed</ref>()</highlight></codeline>
<codeline lineno="1066"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1067"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>startclear{SteadyClock::now()};</highlight></codeline>
<codeline lineno="1068"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_cs_fee_estimator);</highlight></codeline>
<codeline lineno="1069"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>num_entries<sp/>=<sp/>mapMemPoolTxs.size();</highlight></codeline>
<codeline lineno="1070"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Remove<sp/>every<sp/>entry<sp/>in<sp/>mapMemPoolTxs</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1071"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(!mapMemPoolTxs.empty())<sp/>{</highlight></codeline>
<codeline lineno="1072"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>mi<sp/>=<sp/>mapMemPoolTxs.begin();</highlight></codeline>
<codeline lineno="1073"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_removeTx(mi-&gt;first,<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">);<sp/></highlight><highlight class="comment">//<sp/>this<sp/>calls<sp/>erase()<sp/>on<sp/>mapMemPoolTxs</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1074"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1075"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>endclear{SteadyClock::now()};</highlight></codeline>
<codeline lineno="1076"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a390409d91483ef8b1b33fbc3ff0f4918" kindref="member">BCLog::ESTIMATEFEE</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Recorded<sp/>%u<sp/>unconfirmed<sp/>txs<sp/>from<sp/>mempool<sp/>in<sp/>%.3fs\n&quot;</highlight><highlight class="normal">,<sp/>num_entries,<sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;SecondsDouble&gt;</ref>(endclear<sp/>-<sp/>startclear));</highlight></codeline>
<codeline lineno="1077"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1078"><highlight class="normal"></highlight></codeline>
<codeline lineno="1079"><highlight class="normal">std::chrono::hours<sp/><ref refid="class_c_block_policy_estimator_1a7767edfa6aa286e24a456adf484e6860" kindref="member">CBlockPolicyEstimator::GetFeeEstimatorFileAge</ref>()</highlight></codeline>
<codeline lineno="1080"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1081"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>file_time{fs::last_write_time(m_estimation_filepath)};</highlight></codeline>
<codeline lineno="1082"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>now{fs::file_time_type::clock::now()};</highlight></codeline>
<codeline lineno="1083"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::chrono::duration_cast&lt;std::chrono::hours&gt;(now<sp/>-<sp/>file_time);</highlight></codeline>
<codeline lineno="1084"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1085"><highlight class="normal"></highlight></codeline>
<codeline lineno="1086"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>std::set&lt;double&gt;<sp/>MakeFeeSet(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_fee_rate" kindref="compound">CFeeRate</ref>&amp;<sp/>min_incremental_fee,</highlight></codeline>
<codeline lineno="1087"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>max_filter_fee_rate,</highlight></codeline>
<codeline lineno="1088"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>fee_filter_spacing)</highlight></codeline>
<codeline lineno="1089"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1090"><highlight class="normal"><sp/><sp/><sp/><sp/>std::set&lt;double&gt;<sp/>fee_set;</highlight></codeline>
<codeline lineno="1091"><highlight class="normal"></highlight></codeline>
<codeline lineno="1092"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/>min_fee_limit{std::max(<ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref>(1),<sp/>min_incremental_fee.<ref refid="class_c_fee_rate_1ad9e8eebf71570868a82e7f7e63334ec2" kindref="member">GetFeePerK</ref>()<sp/>/<sp/>2)};</highlight></codeline>
<codeline lineno="1093"><highlight class="normal"><sp/><sp/><sp/><sp/>fee_set.insert(0);</highlight></codeline>
<codeline lineno="1094"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>bucket_boundary<sp/>=<sp/>min_fee_limit;</highlight></codeline>
<codeline lineno="1095"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bucket_boundary<sp/>&lt;=<sp/>max_filter_fee_rate;</highlight></codeline>
<codeline lineno="1096"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bucket_boundary<sp/>*=<sp/>fee_filter_spacing)<sp/>{</highlight></codeline>
<codeline lineno="1097"><highlight class="normal"></highlight></codeline>
<codeline lineno="1098"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fee_set.insert(bucket_boundary);</highlight></codeline>
<codeline lineno="1099"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1100"><highlight class="normal"></highlight></codeline>
<codeline lineno="1101"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>fee_set;</highlight></codeline>
<codeline lineno="1102"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1103"><highlight class="normal"></highlight></codeline>
<codeline lineno="1104"><highlight class="normal"><ref refid="class_fee_filter_rounder_1aba6acaa75a09d4430d9f2a4affa1f2a9" kindref="member">FeeFilterRounder::FeeFilterRounder</ref>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="class_c_fee_rate" kindref="compound">CFeeRate</ref>&amp;<sp/>minIncrementalFee,<sp/><ref refid="class_fast_random_context" kindref="compound">FastRandomContext</ref>&amp;<sp/>rng)</highlight></codeline>
<codeline lineno="1105"><highlight class="normal"><sp/><sp/><sp/><sp/>:<sp/>m_fee_set{MakeFeeSet(minIncrementalFee,<sp/>MAX_FILTER_FEERATE,<sp/>FEE_FILTER_SPACING)},</highlight></codeline>
<codeline lineno="1106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>insecure_rand{rng}</highlight></codeline>
<codeline lineno="1107"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1108"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1109"><highlight class="normal"></highlight></codeline>
<codeline lineno="1110"><highlight class="normal"><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/><ref refid="class_fee_filter_rounder_1a4b3cef15f6bce9f619c901579194f179" kindref="member">FeeFilterRounder::round</ref>(<ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/>currentMinFee)</highlight></codeline>
<codeline lineno="1111"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1112"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(m_insecure_rand_mutex);</highlight></codeline>
<codeline lineno="1113"><highlight class="normal"><sp/><sp/><sp/><sp/>std::set&lt;double&gt;::iterator<sp/>it<sp/>=<sp/>m_fee_set.lower_bound(currentMinFee);</highlight></codeline>
<codeline lineno="1114"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>==<sp/>m_fee_set.end()<sp/>||</highlight></codeline>
<codeline lineno="1115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(it<sp/>!=<sp/>m_fee_set.begin()<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="1116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(m_insecure_rand_mutex,<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>insecure_rand.rand32())<sp/>%<sp/>3<sp/>!=<sp/>0))<sp/>{</highlight></codeline>
<codeline lineno="1117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>--it;</highlight></codeline>
<codeline lineno="1118"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1119"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="normal"><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref></highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(*it);</highlight></codeline>
<codeline lineno="1120"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="src/policy/fees/block_policy_estimator.cpp"/>
  </compounddef>
</doxygen>
