<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.15.0" xml:lang="en-US">
  <compounddef id="net__processing_8cpp" kind="file" language="C++">
    <compoundname>net_processing.cpp</compoundname>
    <includes refid="net__processing_8h" local="no">net_processing.h</includes>
    <includes refid="addrman_8h" local="no">addrman.h</includes>
    <includes refid="arith__uint256_8h" local="no">arith_uint256.h</includes>
    <includes refid="banman_8h" local="no">banman.h</includes>
    <includes refid="blockencodings_8h" local="no">blockencodings.h</includes>
    <includes refid="blockfilter_8h" local="no">blockfilter.h</includes>
    <includes refid="chain_8h" local="no">chain.h</includes>
    <includes refid="chainparams_8h" local="no">chainparams.h</includes>
    <includes refid="bloom_8h" local="no">common/bloom.h</includes>
    <includes refid="amount_8h" local="no">consensus/amount.h</includes>
    <includes refid="params_8h" local="no">consensus/params.h</includes>
    <includes refid="consensus_2validation_8h" local="no">consensus/validation.h</includes>
    <includes refid="core__memusage_8h" local="no">core_memusage.h</includes>
    <includes refid="siphash_8h" local="no">crypto/siphash.h</includes>
    <includes refid="deploymentstatus_8h" local="no">deploymentstatus.h</includes>
    <includes refid="flatfile_8h" local="no">flatfile.h</includes>
    <includes refid="headerssync_8h" local="no">headerssync.h</includes>
    <includes refid="blockfilterindex_8h" local="no">index/blockfilterindex.h</includes>
    <includes refid="kernel_2types_8h" local="no">kernel/types.h</includes>
    <includes refid="logging_8h" local="no">logging.h</includes>
    <includes refid="merkleblock_8h" local="no">merkleblock.h</includes>
    <includes refid="net_8h" local="no">net.h</includes>
    <includes refid="net__permissions_8h" local="no">net_permissions.h</includes>
    <includes refid="netaddress_8h" local="no">netaddress.h</includes>
    <includes refid="netbase_8h" local="no">netbase.h</includes>
    <includes refid="netmessagemaker_8h" local="no">netmessagemaker.h</includes>
    <includes refid="blockstorage_8h" local="no">node/blockstorage.h</includes>
    <includes refid="connection__types_8h" local="no">node/connection_types.h</includes>
    <includes refid="protocol__version_8h" local="no">node/protocol_version.h</includes>
    <includes refid="timeoffsets_8h" local="no">node/timeoffsets.h</includes>
    <includes refid="txdownloadman_8h" local="no">node/txdownloadman.h</includes>
    <includes refid="txorphanage_8h" local="no">node/txorphanage.h</includes>
    <includes refid="txreconciliation_8h" local="no">node/txreconciliation.h</includes>
    <includes refid="warnings_8h" local="no">node/warnings.h</includes>
    <includes refid="feerate_8h" local="no">policy/feerate.h</includes>
    <includes refid="block__policy__estimator_8h" local="no">policy/fees/block_policy_estimator.h</includes>
    <includes refid="packages_8h" local="no">policy/packages.h</includes>
    <includes refid="policy_8h" local="no">policy/policy.h</includes>
    <includes refid="primitives_2block_8h" local="no">primitives/block.h</includes>
    <includes refid="primitives_2transaction_8h" local="no">primitives/transaction.h</includes>
    <includes refid="protocol_8h" local="no">protocol.h</includes>
    <includes refid="random_8h" local="no">random.h</includes>
    <includes refid="scheduler_8h" local="no">scheduler.h</includes>
    <includes refid="script_2script_8h" local="no">script/script.h</includes>
    <includes refid="serialize_8h" local="no">serialize.h</includes>
    <includes refid="span_8h" local="no">span.h</includes>
    <includes refid="streams_8h" local="no">streams.h</includes>
    <includes refid="sync_8h" local="no">sync.h</includes>
    <includes refid="tinyformat_8h" local="no">tinyformat.h</includes>
    <includes refid="txmempool_8h" local="no">txmempool.h</includes>
    <includes refid="uint256_8h" local="no">uint256.h</includes>
    <includes refid="check_8h" local="no">util/check.h</includes>
    <includes refid="strencodings_8h" local="no">util/strencodings.h</includes>
    <includes refid="util_2time_8h" local="no">util/time.h</includes>
    <includes refid="trace_8h" local="no">util/trace.h</includes>
    <includes refid="validation_8h" local="no">validation.h</includes>
    <includes local="no">algorithm</includes>
    <includes local="no">array</includes>
    <includes local="no">atomic</includes>
    <includes local="no">compare</includes>
    <includes local="no">cstddef</includes>
    <includes local="no">deque</includes>
    <includes local="no">exception</includes>
    <includes local="no">functional</includes>
    <includes local="no">future</includes>
    <includes local="no">initializer_list</includes>
    <includes local="no">iterator</includes>
    <includes local="no">limits</includes>
    <includes local="no">list</includes>
    <includes local="no">map</includes>
    <includes local="no">memory</includes>
    <includes local="no">optional</includes>
    <includes local="no">queue</includes>
    <includes local="no">ranges</includes>
    <includes local="no">ratio</includes>
    <includes local="no">set</includes>
    <includes local="no">span</includes>
    <includes local="no">typeinfo</includes>
    <includes local="no">utility</includes>
    <incdepgraph>
      <node id="148">
        <label>addrdb.h</label>
        <link refid="addrdb_8h"/>
        <childnode refid="149" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="150" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="145">
        <label>addrman.h</label>
        <link refid="addrman_8h"/>
        <childnode refid="97" relation="include">
        </childnode>
        <childnode refid="120" relation="include">
        </childnode>
        <childnode refid="125" relation="include">
        </childnode>
        <childnode refid="126" relation="include">
        </childnode>
        <childnode refid="128" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="113" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="146">
        <label>arith_uint256.h</label>
        <link refid="arith__uint256_8h"/>
        <childnode refid="64" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
      </node>
      <node id="23">
        <label>attributes.h</label>
        <link refid="attributes_8h"/>
      </node>
      <node id="147">
        <label>banman.h</label>
        <link refid="banman_8h"/>
        <childnode refid="148" relation="include">
        </childnode>
        <childnode refid="81" relation="include">
        </childnode>
        <childnode refid="149" relation="include">
        </childnode>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
      </node>
      <node id="6">
        <label>bip324.h</label>
        <link refid="bip324_8h"/>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
      </node>
      <node id="152">
        <label>blockencodings.h</label>
        <link refid="blockencodings_8h"/>
        <childnode refid="95" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
      </node>
      <node id="153">
        <label>blockfilter.h</label>
        <link refid="blockfilter_8h"/>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="113" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="154" relation="include">
        </childnode>
      </node>
      <node id="155">
        <label>chain.h</label>
        <link refid="chain_8h"/>
        <childnode refid="146" relation="include">
        </childnode>
        <childnode refid="62" relation="include">
        </childnode>
        <childnode refid="156" relation="include">
        </childnode>
        <childnode refid="144" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="128" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="60">
        <label>chainparams.h</label>
        <link refid="chainparams_8h"/>
        <childnode refid="61" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
      </node>
      <node id="219">
        <label>checkqueue.h</label>
        <link refid="checkqueue_8h"/>
        <childnode refid="127" relation="include">
        </childnode>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="102" relation="include">
        </childnode>
        <childnode refid="220" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="200">
        <label>coins.h</label>
        <link refid="coins_8h"/>
        <childnode refid="201" relation="include">
        </childnode>
        <childnode refid="157" relation="include">
        </childnode>
        <childnode refid="158" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="160" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="99" relation="include">
        </childnode>
        <childnode refid="167" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
      </node>
      <node id="81">
        <label>common/bloom.h</label>
        <link refid="bloom_8h"/>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="174">
        <label>common/settings.h</label>
        <link refid="common_2settings_8h"/>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="37">
        <label>compat/assumptions.h</label>
        <link refid="compat_2assumptions_8h"/>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
      </node>
      <node id="26">
        <label>compat/byteswap.h</label>
        <link refid="byteswap_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="82">
        <label>compat/compat.h</label>
        <link refid="compat_8h"/>
        <childnode refid="83" relation="include">
        </childnode>
        <childnode refid="84" relation="include">
        </childnode>
        <childnode refid="85" relation="include">
        </childnode>
        <childnode refid="86" relation="include">
        </childnode>
        <childnode refid="87" relation="include">
        </childnode>
        <childnode refid="88" relation="include">
        </childnode>
        <childnode refid="89" relation="include">
        </childnode>
        <childnode refid="90" relation="include">
        </childnode>
        <childnode refid="91" relation="include">
        </childnode>
        <childnode refid="92" relation="include">
        </childnode>
        <childnode refid="93" relation="include">
        </childnode>
        <childnode refid="94" relation="include">
        </childnode>
      </node>
      <node id="25">
        <label>compat/endian.h</label>
        <link refid="endian_8h"/>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="201">
        <label>compressor.h</label>
        <link refid="compressor_8h"/>
        <childnode refid="34" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="73" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
      </node>
      <node id="3">
        <label>consensus/amount.h</label>
        <link refid="amount_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="140">
        <label>consensus/consensus.h</label>
        <link refid="consensus_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="31" relation="include">
        </childnode>
      </node>
      <node id="62">
        <label>consensus/params.h</label>
        <link refid="params_8h"/>
        <childnode refid="63" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="139">
        <label>consensus/validation.h</label>
        <link refid="consensus_2validation_8h"/>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="140" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
      </node>
      <node id="157">
        <label>core_memusage.h</label>
        <link refid="core__memusage_8h"/>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="158" relation="include">
        </childnode>
      </node>
      <node id="10">
        <label>crypto/chacha20.h</label>
        <link refid="chacha20_8h"/>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
      </node>
      <node id="14">
        <label>crypto/chacha20poly1305.h</label>
        <link refid="chacha20poly1305_8h"/>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
      </node>
      <node id="24">
        <label>crypto/common.h</label>
        <link refid="crypto_2common_8h"/>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="46">
        <label>crypto/hex_base.h</label>
        <link refid="hex__base_8h"/>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
      </node>
      <node id="15">
        <label>crypto/poly1305.h</label>
        <link refid="poly1305_8h"/>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
      </node>
      <node id="30">
        <label>crypto/ripemd160.h</label>
        <link refid="ripemd160_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="31" relation="include">
        </childnode>
      </node>
      <node id="32">
        <label>crypto/sha256.h</label>
        <link refid="sha256_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="31" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
      </node>
      <node id="95">
        <label>crypto/siphash.h</label>
        <link refid="siphash_8h"/>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
      </node>
      <node id="221">
        <label>cuckoocache.h</label>
        <link refid="cuckoocache_8h"/>
        <childnode refid="222" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="100" relation="include">
        </childnode>
        <childnode refid="223" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="170">
        <label>dbwrapper.h</label>
        <link refid="dbwrapper_8h"/>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="126" relation="include">
        </childnode>
        <childnode refid="99" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="171" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
      </node>
      <node id="162">
        <label>deploymentstatus.h</label>
        <link refid="deploymentstatus_8h"/>
        <childnode refid="155" relation="include">
        </childnode>
        <childnode refid="163" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
      </node>
      <node id="156">
        <label>flatfile.h</label>
        <link refid="flatfile_8h"/>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
      </node>
      <node id="22">
        <label>hash.h</label>
        <link refid="hash_8h"/>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="32" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="164">
        <label>headerssync.h</label>
        <link refid="headerssync_8h"/>
        <childnode refid="146" relation="include">
        </childnode>
        <childnode refid="155" relation="include">
        </childnode>
        <childnode refid="62" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="165" relation="include">
        </childnode>
        <childnode refid="167" relation="include">
        </childnode>
        <childnode refid="136" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="96">
        <label>i2p.h</label>
        <link refid="i2p_8h"/>
        <childnode refid="82" relation="include">
        </childnode>
        <childnode refid="97" relation="include">
        </childnode>
        <childnode refid="104" relation="include">
        </childnode>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="105" relation="include">
        </childnode>
        <childnode refid="107" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="169">
        <label>index/base.h</label>
        <link refid="base_8h"/>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="170" relation="include">
        </childnode>
        <childnode refid="172" relation="include">
        </childnode>
        <childnode refid="144" relation="include">
        </childnode>
        <childnode refid="109" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="106" relation="include">
        </childnode>
        <childnode refid="143" relation="include">
        </childnode>
        <childnode refid="100" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="112" relation="include">
        </childnode>
      </node>
      <node id="168">
        <label>index/blockfilterindex.h</label>
        <link refid="blockfilterindex_8h"/>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="156" relation="include">
        </childnode>
        <childnode refid="169" relation="include">
        </childnode>
        <childnode refid="172" relation="include">
        </childnode>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="167" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="159">
        <label>indirectmap.h</label>
        <link refid="indirectmap_8h"/>
        <childnode refid="40" relation="include">
        </childnode>
      </node>
      <node id="172">
        <label>interfaces/chain.h</label>
        <link refid="interfaces_2chain_8h"/>
        <childnode refid="173" relation="include">
        </childnode>
        <childnode refid="174" relation="include">
        </childnode>
        <childnode refid="175" relation="include">
        </childnode>
        <childnode refid="176" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="150" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="187">
        <label>kernel/blockmanager_opts.h</label>
        <link refid="blockmanager__opts_8h"/>
        <childnode refid="170" relation="include">
        </childnode>
        <childnode refid="188" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="228">
        <label>kernel/caches.h</label>
        <link refid="kernel_2caches_8h"/>
        <childnode refid="229" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
      </node>
      <node id="175">
        <label>kernel/chain.h</label>
        <link refid="kernel_2chain_8h"/>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="103" relation="include">
        </childnode>
      </node>
      <node id="61">
        <label>kernel/chainparams.h</label>
        <link refid="kernel_2chainparams_8h"/>
        <childnode refid="62" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="77" relation="include">
        </childnode>
        <childnode refid="74" relation="include">
        </childnode>
        <childnode refid="78" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="224">
        <label>kernel/chainstatemanager_opts.h</label>
        <link refid="chainstatemanager__opts_8h"/>
        <childnode refid="188" relation="include">
        </childnode>
        <childnode refid="146" relation="include">
        </childnode>
        <childnode refid="170" relation="include">
        </childnode>
        <childnode refid="225" relation="include">
        </childnode>
        <childnode refid="227" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="76" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
      </node>
      <node id="144">
        <label>kernel/cs_main.h</label>
        <link refid="cs__main_8h"/>
        <childnode refid="108" relation="include">
        </childnode>
      </node>
      <node id="202">
        <label>kernel/mempool_entry.h</label>
        <link refid="mempool__entry_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="139" relation="include">
        </childnode>
        <childnode refid="157" relation="include">
        </childnode>
        <childnode refid="177" relation="include">
        </childnode>
        <childnode refid="203" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="204" relation="include">
        </childnode>
        <childnode refid="205" relation="include">
        </childnode>
        <childnode refid="132" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
      </node>
      <node id="206">
        <label>kernel/mempool_limits.h</label>
        <link refid="mempool__limits_8h"/>
        <childnode refid="177" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="207">
        <label>kernel/mempool_options.h</label>
        <link refid="mempool__options_8h"/>
        <childnode refid="206" relation="include">
        </childnode>
        <childnode refid="123" relation="include">
        </childnode>
        <childnode refid="177" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
      </node>
      <node id="208">
        <label>kernel/mempool_removal_reason.h</label>
        <link refid="mempool__removal__reason_8h"/>
        <childnode refid="33" relation="include">
        </childnode>
      </node>
      <node id="66">
        <label>kernel/messagestartchars.h</label>
        <link refid="messagestartchars_8h"/>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="188">
        <label>kernel/notifications_interface.h</label>
        <link refid="notifications__interface_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="72" relation="include">
        </childnode>
      </node>
      <node id="182">
        <label>kernel/types.h</label>
        <link refid="kernel_2types_8h"/>
      </node>
      <node id="19">
        <label>key.h</label>
        <link refid="key_8h"/>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="53" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="127">
        <label>logging.h</label>
        <link refid="logging_8h"/>
        <childnode refid="95" relation="include">
        </childnode>
        <childnode refid="109" relation="include">
        </childnode>
        <childnode refid="102" relation="include">
        </childnode>
        <childnode refid="99" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="128" relation="include">
        </childnode>
        <childnode refid="100" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="56" relation="include">
        </childnode>
        <childnode refid="101" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
        <childnode refid="113" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="158">
        <label>memusage.h</label>
        <link refid="memusage_8h"/>
        <childnode refid="159" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
        <childnode refid="160" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="31" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
        <childnode refid="113" relation="include">
        </childnode>
      </node>
      <node id="183">
        <label>merkleblock.h</label>
        <link refid="merkleblock_8h"/>
        <childnode refid="81" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="69" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="20">
        <label>musig.h</label>
        <link refid="musig_8h"/>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="5">
        <label>net.h</label>
        <link refid="net_8h"/>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="60" relation="include">
        </childnode>
        <childnode refid="81" relation="include">
        </childnode>
        <childnode refid="82" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="95" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="96" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="119" relation="include">
        </childnode>
        <childnode refid="97" relation="include">
        </childnode>
        <childnode refid="104" relation="include">
        </childnode>
        <childnode refid="120" relation="include">
        </childnode>
        <childnode refid="121" relation="include">
        </childnode>
        <childnode refid="122" relation="include">
        </childnode>
        <childnode refid="123" relation="include">
        </childnode>
        <childnode refid="125" relation="include">
        </childnode>
        <childnode refid="98" relation="include">
        </childnode>
        <childnode refid="134" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="126" relation="include">
        </childnode>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="99" relation="include">
        </childnode>
        <childnode refid="105" relation="include">
        </childnode>
        <childnode refid="107" relation="include">
        </childnode>
        <childnode refid="100" relation="include">
        </childnode>
        <childnode refid="111" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="136" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="137" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="112" relation="include">
        </childnode>
        <childnode refid="113" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="119">
        <label>net_permissions.h</label>
        <link refid="net__permissions_8h"/>
        <childnode refid="97" relation="include">
        </childnode>
        <childnode refid="104" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="1">
        <label>src/net_processing.cpp</label>
        <link refid="net__processing_8cpp"/>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="145" relation="include">
        </childnode>
        <childnode refid="146" relation="include">
        </childnode>
        <childnode refid="147" relation="include">
        </childnode>
        <childnode refid="152" relation="include">
        </childnode>
        <childnode refid="153" relation="include">
        </childnode>
        <childnode refid="155" relation="include">
        </childnode>
        <childnode refid="60" relation="include">
        </childnode>
        <childnode refid="81" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="62" relation="include">
        </childnode>
        <childnode refid="139" relation="include">
        </childnode>
        <childnode refid="157" relation="include">
        </childnode>
        <childnode refid="95" relation="include">
        </childnode>
        <childnode refid="162" relation="include">
        </childnode>
        <childnode refid="156" relation="include">
        </childnode>
        <childnode refid="164" relation="include">
        </childnode>
        <childnode refid="168" relation="include">
        </childnode>
        <childnode refid="182" relation="include">
        </childnode>
        <childnode refid="127" relation="include">
        </childnode>
        <childnode refid="183" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="119" relation="include">
        </childnode>
        <childnode refid="97" relation="include">
        </childnode>
        <childnode refid="104" relation="include">
        </childnode>
        <childnode refid="184" relation="include">
        </childnode>
        <childnode refid="185" relation="include">
        </childnode>
        <childnode refid="121" relation="include">
        </childnode>
        <childnode refid="122" relation="include">
        </childnode>
        <childnode refid="190" relation="include">
        </childnode>
        <childnode refid="191" relation="include">
        </childnode>
        <childnode refid="138" relation="include">
        </childnode>
        <childnode refid="193" relation="include">
        </childnode>
        <childnode refid="194" relation="include">
        </childnode>
        <childnode refid="123" relation="include">
        </childnode>
        <childnode refid="195" relation="include">
        </childnode>
        <childnode refid="192" relation="include">
        </childnode>
        <childnode refid="177" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="125" relation="include">
        </childnode>
        <childnode refid="98" relation="include">
        </childnode>
        <childnode refid="197" relation="include">
        </childnode>
        <childnode refid="73" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="126" relation="include">
        </childnode>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="102" relation="include">
        </childnode>
        <childnode refid="199" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="99" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="128" relation="include">
        </childnode>
        <childnode refid="216" relation="include">
        </childnode>
        <childnode refid="218" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="100" relation="include">
        </childnode>
        <childnode refid="64" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="136" relation="include">
        </childnode>
        <childnode refid="171" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="230" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="137" relation="include">
        </childnode>
        <childnode refid="231" relation="include">
        </childnode>
        <childnode refid="232" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="233" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
      </node>
      <node id="2">
        <label>net_processing.h</label>
        <link refid="net__processing_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="138" relation="include">
        </childnode>
        <childnode refid="125" relation="include">
        </childnode>
        <childnode refid="109" relation="include">
        </childnode>
        <childnode refid="142" relation="include">
        </childnode>
        <childnode refid="143" relation="include">
        </childnode>
        <childnode refid="100" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="149">
        <label>net_types.h</label>
        <link refid="net__types_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
      </node>
      <node id="97">
        <label>netaddress.h</label>
        <link refid="netaddress_8h"/>
        <childnode refid="82" relation="include">
        </childnode>
        <childnode refid="95" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
        <childnode refid="98" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="102" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="104">
        <label>netbase.h</label>
        <link refid="netbase_8h"/>
        <childnode refid="82" relation="include">
        </childnode>
        <childnode refid="97" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="105" relation="include">
        </childnode>
        <childnode refid="107" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="113" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="120">
        <label>netgroup.h</label>
        <link refid="netgroup_8h"/>
        <childnode refid="97" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="184">
        <label>netmessagemaker.h</label>
        <link refid="netmessagemaker_8h"/>
        <childnode refid="5" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
      </node>
      <node id="185">
        <label>node/blockstorage.h</label>
        <link refid="blockstorage_8h"/>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="186" relation="include">
        </childnode>
        <childnode refid="170" relation="include">
        </childnode>
        <childnode refid="156" relation="include">
        </childnode>
        <childnode refid="187" relation="include">
        </childnode>
        <childnode refid="61" relation="include">
        </childnode>
        <childnode refid="144" relation="include">
        </childnode>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="126" relation="include">
        </childnode>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="142" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="167" relation="include">
        </childnode>
        <childnode refid="130" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="100" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="189" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="121">
        <label>node/connection_types.h</label>
        <link refid="connection__types_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
      </node>
      <node id="122">
        <label>node/protocol_version.h</label>
        <link refid="protocol__version_8h"/>
      </node>
      <node id="190">
        <label>node/timeoffsets.h</label>
        <link refid="timeoffsets_8h"/>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="136" relation="include">
        </childnode>
      </node>
      <node id="191">
        <label>node/txdownloadman.h</label>
        <link refid="txdownloadman_8h"/>
        <childnode refid="141" relation="include">
        </childnode>
        <childnode refid="138" relation="include">
        </childnode>
        <childnode refid="192" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
      </node>
      <node id="138">
        <label>node/txorphanage.h</label>
        <link refid="txorphanage_8h"/>
        <childnode refid="139" relation="include">
        </childnode>
        <childnode refid="141" relation="include">
        </childnode>
        <childnode refid="67" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="76" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
      </node>
      <node id="193">
        <label>node/txreconciliation.h</label>
        <link refid="txreconciliation_8h"/>
        <childnode refid="141" relation="include">
        </childnode>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="71" relation="include">
        </childnode>
      </node>
      <node id="176">
        <label>node/types.h</label>
        <link refid="node_2types_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="177" relation="include">
        </childnode>
        <childnode refid="73" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="76" relation="include">
        </childnode>
      </node>
      <node id="194">
        <label>node/warnings.h</label>
        <link refid="warnings_8h"/>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="151" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="72" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="123">
        <label>policy/feerate.h</label>
        <link refid="feerate_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="124" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
      </node>
      <node id="195">
        <label>policy/fees/block_policy_estimator.h</label>
        <link refid="block__policy__estimator_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="123" relation="include">
        </childnode>
        <childnode refid="196" relation="include">
        </childnode>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="109" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="143" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="192">
        <label>policy/packages.h</label>
        <link refid="packages_8h"/>
        <childnode refid="140" relation="include">
        </childnode>
        <childnode refid="139" relation="include">
        </childnode>
        <childnode refid="177" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="167" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="113" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="177">
        <label>policy/policy.h</label>
        <link refid="policy_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="140" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="178" relation="include">
        </childnode>
        <childnode refid="181" relation="include">
        </childnode>
        <childnode refid="124" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
      </node>
      <node id="203">
        <label>policy/settings.h</label>
        <link refid="policy_2settings_8h"/>
      </node>
      <node id="34">
        <label>prevector.h</label>
        <link refid="prevector_8h"/>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="31" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
      </node>
      <node id="67">
        <label>primitives/block.h</label>
        <link refid="primitives_2block_8h"/>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="76" relation="include">
        </childnode>
      </node>
      <node id="68">
        <label>primitives/transaction.h</label>
        <link refid="primitives_2transaction_8h"/>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="69" relation="include">
        </childnode>
        <childnode refid="73" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="75" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="71" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="69">
        <label>primitives/transaction_identifier.h</label>
        <link refid="transaction__identifier_8h"/>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="70" relation="include">
        </childnode>
        <childnode refid="64" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="71" relation="include">
        </childnode>
        <childnode refid="72" relation="include">
        </childnode>
      </node>
      <node id="125">
        <label>protocol.h</label>
        <link refid="protocol_8h"/>
        <childnode refid="66" relation="include">
        </childnode>
        <childnode refid="97" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="126" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="128" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
      </node>
      <node id="21">
        <label>pubkey.h</label>
        <link refid="pubkey_8h"/>
        <childnode refid="22" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="98">
        <label>random.h</label>
        <link refid="random_8h"/>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="99" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="197">
        <label>scheduler.h</label>
        <link refid="scheduler_8h"/>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="109" relation="include">
        </childnode>
        <childnode refid="198" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="111" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="112" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
      </node>
      <node id="178">
        <label>script/interpreter.h</label>
        <link refid="interpreter_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="179" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="180" relation="include">
        </childnode>
        <childnode refid="63" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="73">
        <label>script/script.h</label>
        <link refid="script_2script_8h"/>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="74" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="180">
        <label>script/script_error.h</label>
        <link refid="script__error_8h"/>
        <childnode refid="33" relation="include">
        </childnode>
      </node>
      <node id="225">
        <label>script/sigcache.h</label>
        <link refid="sigcache_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="32" relation="include">
        </childnode>
        <childnode refid="221" relation="include">
        </childnode>
        <childnode refid="178" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="167" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="226" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="181">
        <label>script/solver.h</label>
        <link refid="solver_8h"/>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="73" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="63">
        <label>script/verify_flags.h</label>
        <link refid="verify__flags_8h"/>
        <childnode refid="64" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="134">
        <label>semaphore_grant.h</label>
        <link refid="semaphore__grant_8h"/>
        <childnode refid="135" relation="include">
        </childnode>
      </node>
      <node id="36">
        <label>serialize.h</label>
        <link refid="serialize_8h"/>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="37" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="16">
        <label>span.h</label>
        <link refid="span_8h"/>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
      </node>
      <node id="126">
        <label>streams.h</label>
        <link refid="streams_8h"/>
        <childnode refid="127" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="129" relation="include">
        </childnode>
        <childnode refid="99" relation="include">
        </childnode>
        <childnode refid="130" relation="include">
        </childnode>
        <childnode refid="132" relation="include">
        </childnode>
        <childnode refid="133" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="115" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="160">
        <label>support/allocators/pool.h</label>
        <link refid="pool_8h"/>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="161" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="99" relation="include">
        </childnode>
      </node>
      <node id="53">
        <label>support/allocators/secure.h</label>
        <link refid="secure_8h"/>
        <childnode refid="54" relation="include">
        </childnode>
        <childnode refid="58" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
      </node>
      <node id="129">
        <label>support/allocators/zeroafterfree.h</label>
        <link refid="zeroafterfree_8h"/>
        <childnode refid="58" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="58">
        <label>support/cleanse.h</label>
        <link refid="cleanse_8h"/>
        <childnode refid="31" relation="include">
        </childnode>
      </node>
      <node id="54">
        <label>support/lockedpool.h</label>
        <link refid="lockedpool_8h"/>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="55" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="56" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
      </node>
      <node id="108">
        <label>sync.h</label>
        <link refid="sync_8h"/>
        <childnode refid="109" relation="include">
        </childnode>
        <childnode refid="110" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="111" relation="include">
        </childnode>
        <childnode refid="56" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="112" relation="include">
        </childnode>
      </node>
      <node id="109">
        <label>threadsafety.h</label>
        <link refid="threadsafety_8h"/>
        <childnode refid="56" relation="include">
        </childnode>
      </node>
      <node id="102">
        <label>tinyformat.h</label>
        <link refid="tinyformat_8h"/>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="103" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
      </node>
      <node id="227">
        <label>txdb.h</label>
        <link refid="txdb_8h"/>
        <childnode refid="200" relation="include">
        </childnode>
        <childnode refid="170" relation="include">
        </childnode>
        <childnode refid="228" relation="include">
        </childnode>
        <childnode refid="144" relation="include">
        </childnode>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="204">
        <label>txgraph.h</label>
        <link refid="txgraph_8h"/>
        <childnode refid="64" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
        <childnode refid="124" relation="include">
        </childnode>
      </node>
      <node id="199">
        <label>txmempool.h</label>
        <link refid="txmempool_8h"/>
        <childnode refid="200" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="159" relation="include">
        </childnode>
        <childnode refid="144" relation="include">
        </childnode>
        <childnode refid="202" relation="include">
        </childnode>
        <childnode refid="206" relation="include">
        </childnode>
        <childnode refid="207" relation="include">
        </childnode>
        <childnode refid="208" relation="include">
        </childnode>
        <childnode refid="123" relation="include">
        </childnode>
        <childnode refid="192" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="69" relation="include">
        </childnode>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="204" relation="include">
        </childnode>
        <childnode refid="205" relation="include">
        </childnode>
        <childnode refid="124" relation="include">
        </childnode>
        <childnode refid="167" relation="include">
        </childnode>
        <childnode refid="150" relation="include">
        </childnode>
        <childnode refid="209" relation="include">
        </childnode>
        <childnode refid="210" relation="include">
        </childnode>
        <childnode refid="211" relation="include">
        </childnode>
        <childnode refid="212" relation="include">
        </childnode>
        <childnode refid="213" relation="include">
        </childnode>
        <childnode refid="214" relation="include">
        </childnode>
        <childnode refid="215" relation="include">
        </childnode>
        <childnode refid="100" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="44">
        <label>uint256.h</label>
        <link refid="uint256_8h"/>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
      </node>
      <node id="165">
        <label>util/bitdeque.h</label>
        <link refid="bitdeque_8h"/>
        <childnode refid="166" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="136" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="71" relation="include">
        </childnode>
      </node>
      <node id="229">
        <label>util/byte_units.h</label>
        <link refid="byte__units_8h"/>
        <childnode refid="132" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
      </node>
      <node id="154">
        <label>util/bytevectorhash.h</label>
        <link refid="bytevectorhash_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="77">
        <label>util/chaintype.h</label>
        <link refid="chaintype_8h"/>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
      </node>
      <node id="99">
        <label>util/check.h</label>
        <link refid="check_8h"/>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="100" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="101" relation="include">
        </childnode>
        <childnode refid="59" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
      </node>
      <node id="205">
        <label>util/epochguard.h</label>
        <link refid="epochguard_8h"/>
        <childnode refid="109" relation="include">
        </childnode>
        <childnode refid="110" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
      </node>
      <node id="142">
        <label>util/expected.h</label>
        <link refid="expected_8h"/>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="72" relation="include">
        </childnode>
      </node>
      <node id="222">
        <label>util/fastrange.h</label>
        <link refid="fastrange_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
      </node>
      <node id="124">
        <label>util/feefrac.h</label>
        <link refid="feefrac_8h"/>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="99" relation="include">
        </childnode>
        <childnode refid="64" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="114">
        <label>util/fs.h</label>
        <link refid="fs_8h"/>
        <childnode refid="102" relation="include">
        </childnode>
        <childnode refid="115" relation="include">
        </childnode>
        <childnode refid="116" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="117" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="118" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="52" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
      </node>
      <node id="74">
        <label>util/hash_type.h</label>
        <link refid="hash__type_8h"/>
      </node>
      <node id="167">
        <label>util/hasher.h</label>
        <link refid="hasher_8h"/>
        <childnode refid="24" relation="include">
        </childnode>
        <childnode refid="95" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="110">
        <label>util/macros.h</label>
        <link refid="macros_8h"/>
      </node>
      <node id="130">
        <label>util/obfuscation.h</label>
        <link refid="obfuscation_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="102" relation="include">
        </childnode>
        <childnode refid="45" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="131" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
      </node>
      <node id="132">
        <label>util/overflow.h</label>
        <link refid="overflow_8h"/>
        <childnode refid="131" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
      </node>
      <node id="150">
        <label>util/result.h</label>
        <link refid="result_8h"/>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="151" relation="include">
        </childnode>
        <childnode refid="72" relation="include">
        </childnode>
      </node>
      <node id="105">
        <label>util/sock.h</label>
        <link refid="sock_8h"/>
        <childnode refid="82" relation="include">
        </childnode>
        <childnode refid="106" relation="include">
        </childnode>
        <childnode refid="76" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="57" relation="include">
        </childnode>
      </node>
      <node id="45">
        <label>util/strencodings.h</label>
        <link refid="strencodings_8h"/>
        <childnode refid="46" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="51" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="52" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="47">
        <label>util/string.h</label>
        <link refid="string_8h"/>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
        <childnode refid="48" relation="include">
        </childnode>
        <childnode refid="49" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="133">
        <label>util/syserror.h</label>
        <link refid="syserror_8h"/>
        <childnode refid="33" relation="include">
        </childnode>
      </node>
      <node id="198">
        <label>util/task_runner.h</label>
        <link refid="task__runner_8h"/>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
      </node>
      <node id="107">
        <label>util/threadinterrupt.h</label>
        <link refid="util_2threadinterrupt_8h"/>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="109" relation="include">
        </childnode>
        <childnode refid="100" relation="include">
        </childnode>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="111" relation="include">
        </childnode>
      </node>
      <node id="220">
        <label>util/threadnames.h</label>
        <link refid="threadnames_8h"/>
        <childnode refid="33" relation="include">
        </childnode>
      </node>
      <node id="128">
        <label>util/time.h</label>
        <link refid="util_2time_8h"/>
        <childnode refid="65" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="50" relation="include">
        </childnode>
      </node>
      <node id="216">
        <label>util/trace.h</label>
        <link refid="trace_8h"/>
        <childnode refid="217" relation="include">
        </childnode>
      </node>
      <node id="151">
        <label>util/translation.h</label>
        <link refid="translation_8h"/>
        <childnode refid="102" relation="include">
        </childnode>
        <childnode refid="47" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
      </node>
      <node id="70">
        <label>util/types.h</label>
        <link refid="util_2types_8h"/>
      </node>
      <node id="78">
        <label>util/vector.h</label>
        <link refid="vector_8h"/>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="80" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="218">
        <label>validation.h</label>
        <link refid="validation_8h"/>
        <childnode refid="146" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="155" relation="include">
        </childnode>
        <childnode refid="219" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="221" relation="include">
        </childnode>
        <childnode refid="162" relation="include">
        </childnode>
        <childnode refid="175" relation="include">
        </childnode>
        <childnode refid="61" relation="include">
        </childnode>
        <childnode refid="224" relation="include">
        </childnode>
        <childnode refid="144" relation="include">
        </childnode>
        <childnode refid="185" relation="include">
        </childnode>
        <childnode refid="123" relation="include">
        </childnode>
        <childnode refid="192" relation="include">
        </childnode>
        <childnode refid="177" relation="include">
        </childnode>
        <childnode refid="180" relation="include">
        </childnode>
        <childnode refid="225" relation="include">
        </childnode>
        <childnode refid="63" relation="include">
        </childnode>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="227" relation="include">
        </childnode>
        <childnode refid="199" relation="include">
        </childnode>
        <childnode refid="44" relation="include">
        </childnode>
        <childnode refid="229" relation="include">
        </childnode>
        <childnode refid="99" relation="include">
        </childnode>
        <childnode refid="114" relation="include">
        </childnode>
        <childnode refid="167" relation="include">
        </childnode>
        <childnode refid="150" relation="include">
        </childnode>
        <childnode refid="128" relation="include">
        </childnode>
        <childnode refid="151" relation="include">
        </childnode>
        <childnode refid="163" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="100" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="42" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="143">
        <label>validationinterface.h</label>
        <link refid="validationinterface_8h"/>
        <childnode refid="144" relation="include">
        </childnode>
        <childnode refid="68" relation="include">
        </childnode>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="79" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="163">
        <label>versionbits.h</label>
        <link refid="versionbits_8h"/>
        <childnode refid="155" relation="include">
        </childnode>
        <childnode refid="108" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="43" relation="include">
        </childnode>
      </node>
      <node id="35">
        <label>algorithm</label>
      </node>
      <node id="83">
        <label>arpa/inet.h</label>
      </node>
      <node id="7">
        <label>array</label>
      </node>
      <node id="100">
        <label>atomic</label>
      </node>
      <node id="27">
        <label>bit</label>
      </node>
      <node id="217">
        <label>bitcoin-build-config.h</label>
      </node>
      <node id="166">
        <label>bitset</label>
      </node>
      <node id="173">
        <label>blockfilter.h</label>
      </node>
      <node id="209">
        <label>boost/multi_index/hashed_index.hpp</label>
      </node>
      <node id="210">
        <label>boost/multi_index/identity.hpp</label>
      </node>
      <node id="211">
        <label>boost/multi_index/indexed_by.hpp</label>
      </node>
      <node id="212">
        <label>boost/multi_index/ordered_index.hpp</label>
      </node>
      <node id="213">
        <label>boost/multi_index/sequenced_index.hpp</label>
      </node>
      <node id="214">
        <label>boost/multi_index/tag.hpp</label>
      </node>
      <node id="215">
        <label>boost/multi_index_container.hpp</label>
      </node>
      <node id="17">
        <label>cassert</label>
      </node>
      <node id="94">
        <label>cerrno</label>
      </node>
      <node id="186">
        <label>chain.h</label>
      </node>
      <node id="51">
        <label>charconv</label>
      </node>
      <node id="65">
        <label>chrono</label>
      </node>
      <node id="131">
        <label>climits</label>
      </node>
      <node id="223">
        <label>cmath</label>
      </node>
      <node id="64">
        <label>compare</label>
      </node>
      <node id="28">
        <label>concepts</label>
      </node>
      <node id="111">
        <label>condition_variable</label>
      </node>
      <node id="8">
        <label>cstddef</label>
      </node>
      <node id="4">
        <label>cstdint</label>
      </node>
      <node id="115">
        <label>cstdio</label>
      </node>
      <node id="31">
        <label>cstdlib</label>
      </node>
      <node id="29">
        <label>cstring</label>
      </node>
      <node id="136">
        <label>deque</label>
      </node>
      <node id="171">
        <label>exception</label>
      </node>
      <node id="84">
        <label>fcntl.h</label>
      </node>
      <node id="116">
        <label>filesystem</label>
      </node>
      <node id="79">
        <label>functional</label>
      </node>
      <node id="230">
        <label>future</label>
      </node>
      <node id="179">
        <label>hash.h</label>
      </node>
      <node id="80">
        <label>initializer_list</label>
      </node>
      <node id="117">
        <label>iomanip</label>
      </node>
      <node id="39">
        <label>ios</label>
      </node>
      <node id="189">
        <label>iosfwd</label>
      </node>
      <node id="103">
        <label>iostream</label>
      </node>
      <node id="11">
        <label>iterator</label>
      </node>
      <node id="38">
        <label>limits</label>
      </node>
      <node id="55">
        <label>list</label>
      </node>
      <node id="48">
        <label>locale</label>
      </node>
      <node id="40">
        <label>map</label>
      </node>
      <node id="41">
        <label>memory</label>
      </node>
      <node id="56">
        <label>mutex</label>
      </node>
      <node id="141">
        <label>net.h</label>
      </node>
      <node id="85">
        <label>net/if.h</label>
      </node>
      <node id="86">
        <label>netdb.h</label>
      </node>
      <node id="87">
        <label>netinet/in.h</label>
      </node>
      <node id="88">
        <label>netinet/tcp.h</label>
      </node>
      <node id="161">
        <label>new</label>
      </node>
      <node id="75">
        <label>numeric</label>
      </node>
      <node id="9">
        <label>optional</label>
      </node>
      <node id="118">
        <label>ostream</label>
      </node>
      <node id="137">
        <label>queue</label>
      </node>
      <node id="196">
        <label>random.h</label>
      </node>
      <node id="231">
        <label>ranges</label>
      </node>
      <node id="232">
        <label>ratio</label>
      </node>
      <node id="135">
        <label>semaphore</label>
      </node>
      <node id="42">
        <label>set</label>
      </node>
      <node id="226">
        <label>shared_mutex</label>
      </node>
      <node id="101">
        <label>source_location</label>
      </node>
      <node id="12">
        <label>span</label>
      </node>
      <node id="49">
        <label>sstream</label>
      </node>
      <node id="59">
        <label>stdexcept</label>
      </node>
      <node id="33">
        <label>string</label>
      </node>
      <node id="50">
        <label>string_view</label>
      </node>
      <node id="89">
        <label>sys/mman.h</label>
      </node>
      <node id="90">
        <label>sys/select.h</label>
      </node>
      <node id="91">
        <label>sys/socket.h</label>
      </node>
      <node id="92">
        <label>sys/types.h</label>
      </node>
      <node id="52">
        <label>system_error</label>
      </node>
      <node id="112">
        <label>thread</label>
      </node>
      <node id="71">
        <label>tuple</label>
      </node>
      <node id="18">
        <label>type_traits</label>
      </node>
      <node id="233">
        <label>typeinfo</label>
      </node>
      <node id="93">
        <label>unistd.h</label>
      </node>
      <node id="57">
        <label>unordered_map</label>
      </node>
      <node id="113">
        <label>unordered_set</label>
      </node>
      <node id="106">
        <label>util/threadinterrupt.h</label>
      </node>
      <node id="76">
        <label>util/time.h</label>
      </node>
      <node id="13">
        <label>utility</label>
      </node>
      <node id="72">
        <label>variant</label>
      </node>
      <node id="43">
        <label>vector</label>
      </node>
    </incdepgraph>
    <sectiondef kind="var">
      <memberdef kind="variable" id="net__processing_8cpp_1a93d0ff6d1622793dcc3cab2c8d17311c" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto HEADERS_DOWNLOAD_TIMEOUT_BASE</definition>
        <argsstring></argsstring>
        <name>HEADERS_DOWNLOAD_TIMEOUT_BASE</name>
        <initializer>= 15min</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Headers download timeout. Timeout = base + per_header * (expected number of headers) </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="96" column="23" bodyfile="src/net_processing.cpp" bodystart="96" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1ae33c00a2a6f64ffcfde2a7ff3b6acd32" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto HEADERS_DOWNLOAD_TIMEOUT_PER_HEADER</definition>
        <argsstring></argsstring>
        <name>HEADERS_DOWNLOAD_TIMEOUT_PER_HEADER</name>
        <initializer>= 1ms</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="97" column="23" bodyfile="src/net_processing.cpp" bodystart="97" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a0420b6891733794d3e3ed318c3240626" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto HEADERS_RESPONSE_TIME</definition>
        <argsstring></argsstring>
        <name>HEADERS_RESPONSE_TIME</name>
        <initializer>{2min}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>How long to wait for a peer to respond to a getheaders request </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="99" column="23" bodyfile="src/net_processing.cpp" bodystart="99" bodyend="99"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a7c2874becf319f50fcd6b394659d1d9f" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>int32_t</type>
        <definition>int32_t MAX_OUTBOUND_PEERS_TO_PROTECT_FROM_DISCONNECT</definition>
        <argsstring></argsstring>
        <name>MAX_OUTBOUND_PEERS_TO_PROTECT_FROM_DISCONNECT</name>
        <initializer>= 4</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Protect at least this many outbound peers from disconnection due to slow/ behind headers chain. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="103" column="26" bodyfile="src/net_processing.cpp" bodystart="103" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a55c07a7140ad76c9b0926b2b8232ebca" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto CHAIN_SYNC_TIMEOUT</definition>
        <argsstring></argsstring>
        <name>CHAIN_SYNC_TIMEOUT</name>
        <initializer>{20min}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Timeout for (unprotected) outbound peers to sync to our chainwork </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="105" column="23" bodyfile="src/net_processing.cpp" bodystart="105" bodyend="105"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1aa33bed1bf7ec5ddff43c45640a9a8ee5" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto STALE_CHECK_INTERVAL</definition>
        <argsstring></argsstring>
        <name>STALE_CHECK_INTERVAL</name>
        <initializer>{10min}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>How frequently to check for stale tips </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="107" column="23" bodyfile="src/net_processing.cpp" bodystart="107" bodyend="107"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a38a80d927795c039d8973b6c9d202ce7" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto EXTRA_PEER_CHECK_INTERVAL</definition>
        <argsstring></argsstring>
        <name>EXTRA_PEER_CHECK_INTERVAL</name>
        <initializer>{45s}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>How frequently to check for extra outbound peers and disconnect </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="109" column="23" bodyfile="src/net_processing.cpp" bodystart="109" bodyend="109"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a557c8cd5de6bfa876693bb446e732003" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto MINIMUM_CONNECT_TIME</definition>
        <argsstring></argsstring>
        <name>MINIMUM_CONNECT_TIME</name>
        <initializer>{30s}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Minimum time an outbound-peer-eviction candidate must be connected for, in order to evict </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="111" column="23" bodyfile="src/net_processing.cpp" bodystart="111" bodyend="111"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1ae52ef62db6498571ad0f62279f3c4205" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>uint64_t</type>
        <definition>uint64_t RANDOMIZER_ID_ADDRESS_RELAY</definition>
        <argsstring></argsstring>
        <name>RANDOMIZER_ID_ADDRESS_RELAY</name>
        <initializer>= 0x3cac0035b5866b90ULL</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>SHA256(&quot;main address relay&quot;)[0:8] </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="113" column="27" bodyfile="src/net_processing.cpp" bodystart="113" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a44936168143fd7321f670269be82a935" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>int</type>
        <definition>int STALE_RELAY_AGE_LIMIT</definition>
        <argsstring></argsstring>
        <name>STALE_RELAY_AGE_LIMIT</name>
        <initializer>= 30 * 24 * 60 * 60</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Age after which a stale block will no longer be served if requested as protection against fingerprinting. Set to one month, denominated in seconds. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="116" column="22" bodyfile="src/net_processing.cpp" bodystart="116" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a46fef1e583bc7bce11f07c818ac0c755" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>int</type>
        <definition>int HISTORICAL_BLOCK_AGE</definition>
        <argsstring></argsstring>
        <name>HISTORICAL_BLOCK_AGE</name>
        <initializer>= 7 * 24 * 60 * 60</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Age after which a block is considered historical for purposes of rate limiting block relay. Set to one week, denominated in seconds. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="119" column="22" bodyfile="src/net_processing.cpp" bodystart="119" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1ac5cf9c06f1f30770d3ef5606a3a90f91" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto PING_INTERVAL</definition>
        <argsstring></argsstring>
        <name>PING_INTERVAL</name>
        <initializer>{2min}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Time between pings automatically sent out for latency probing and keepalive </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="121" column="23" bodyfile="src/net_processing.cpp" bodystart="121" bodyend="121"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1ab3277e53a127bd0ec331c9c354cfc687" prot="public" static="yes" mutable="no">
        <type>const unsigned int</type>
        <definition>const unsigned int MAX_LOCATOR_SZ</definition>
        <argsstring></argsstring>
        <name>MAX_LOCATOR_SZ</name>
        <initializer>= 101</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>The maximum number of entries in a locator </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="123" column="27" bodyfile="src/net_processing.cpp" bodystart="123" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1af677dfc85dddc429fe0303f338878ec0" prot="public" static="yes" mutable="no">
        <type>const unsigned int</type>
        <definition>const unsigned int MAX_INV_SZ</definition>
        <argsstring></argsstring>
        <name>MAX_INV_SZ</name>
        <initializer>= 50000</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>The maximum number of entries in an &apos;inv&apos; protocol message </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="125" column="27" bodyfile="src/net_processing.cpp" bodystart="125" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a94d0bd41756163cb0cc58f36d8d6676a" prot="public" static="yes" mutable="no">
        <type>const unsigned int</type>
        <definition>const unsigned int MAX_GETDATA_SZ</definition>
        <argsstring></argsstring>
        <name>MAX_GETDATA_SZ</name>
        <initializer>= 1000</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Limit to avoid sending big packets. Not used in processing incoming GETDATA for compatibility </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="127" column="27" bodyfile="src/net_processing.cpp" bodystart="127" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a276b0b56a72df733dda86cfe6322f604" prot="public" static="yes" mutable="no">
        <type>const int</type>
        <definition>const int MAX_BLOCKS_IN_TRANSIT_PER_PEER</definition>
        <argsstring></argsstring>
        <name>MAX_BLOCKS_IN_TRANSIT_PER_PEER</name>
        <initializer>= 16</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Number of blocks that can be requested at any given time from a single peer. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="129" column="18" bodyfile="src/net_processing.cpp" bodystart="129" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a2bcbf2c55ccae992d926cfe7d6f00625" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto BLOCK_STALLING_TIMEOUT_DEFAULT</definition>
        <argsstring></argsstring>
        <name>BLOCK_STALLING_TIMEOUT_DEFAULT</name>
        <initializer>{2s}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Default time during which a peer must stall block download progress before being disconnected. the actual timeout is increased temporarily if peers are disconnected for hitting the timeout </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="132" column="23" bodyfile="src/net_processing.cpp" bodystart="132" bodyend="132"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1add636734cff88f3479dc86905e3311b0" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto BLOCK_STALLING_TIMEOUT_MAX</definition>
        <argsstring></argsstring>
        <name>BLOCK_STALLING_TIMEOUT_MAX</name>
        <initializer>{64s}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Maximum timeout for stalling block download. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="134" column="23" bodyfile="src/net_processing.cpp" bodystart="134" bodyend="134"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1acc576d09fdf7bf11e878a178f15d4a1a" prot="public" static="yes" mutable="no">
        <type>const int</type>
        <definition>const int MAX_CMPCTBLOCK_DEPTH</definition>
        <argsstring></argsstring>
        <name>MAX_CMPCTBLOCK_DEPTH</name>
        <initializer>= 5</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Maximum depth of blocks we&apos;re willing to serve as compact blocks to peers when requested. For older blocks, a regular BLOCK response will be sent. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="137" column="18" bodyfile="src/net_processing.cpp" bodystart="137" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a6cee75436117a7a79d4e0bc5b87bc2a6" prot="public" static="yes" mutable="no">
        <type>const int</type>
        <definition>const int MAX_BLOCKTXN_DEPTH</definition>
        <argsstring></argsstring>
        <name>MAX_BLOCKTXN_DEPTH</name>
        <initializer>= 10</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Maximum depth of blocks we&apos;re willing to respond to GETBLOCKTXN requests for. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="139" column="18" bodyfile="src/net_processing.cpp" bodystart="139" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a3db9a6c313045e841191037a97268a96" prot="public" static="yes" mutable="no">
        <type>const unsigned int</type>
        <definition>const unsigned int BLOCK_DOWNLOAD_WINDOW</definition>
        <argsstring></argsstring>
        <name>BLOCK_DOWNLOAD_WINDOW</name>
        <initializer>= 1024</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Size of the &quot;block download window&quot;: how far ahead of our current height do we fetch? Larger windows tolerate larger download speed differences between peer, but increase the potential degree of disordering of blocks on disk (which make reindexing and pruning harder). We&apos;ll probably want to make this a per-peer adaptive value at some point. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="145" column="27" bodyfile="src/net_processing.cpp" bodystart="145" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a9bdd552a823be0661f0eb6f3002b6373" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>double</type>
        <definition>double BLOCK_DOWNLOAD_TIMEOUT_BASE</definition>
        <argsstring></argsstring>
        <name>BLOCK_DOWNLOAD_TIMEOUT_BASE</name>
        <initializer>= 1</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Block download timeout base, expressed in multiples of the block interval (i.e. 10 min) </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="147" column="25" bodyfile="src/net_processing.cpp" bodystart="147" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1abca10e6298412a28ed48e7f0e108738b" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>double</type>
        <definition>double BLOCK_DOWNLOAD_TIMEOUT_PER_PEER</definition>
        <argsstring></argsstring>
        <name>BLOCK_DOWNLOAD_TIMEOUT_PER_PEER</name>
        <initializer>= 0.5</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Additional block download timeout per parallel downloading peer (i.e. 5 min) </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="149" column="25" bodyfile="src/net_processing.cpp" bodystart="149" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1ad4d4718d1ec747708a31bc47aaa66578" prot="public" static="yes" mutable="no">
        <type>const unsigned int</type>
        <definition>const unsigned int MAX_BLOCKS_TO_ANNOUNCE</definition>
        <argsstring></argsstring>
        <name>MAX_BLOCKS_TO_ANNOUNCE</name>
        <initializer>= 8</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Maximum number of headers to announce when relaying blocks with headers message. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="151" column="27" bodyfile="src/net_processing.cpp" bodystart="151" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a5df18e7f16a7c3cb6ac8ea991137c5db" prot="public" static="yes" mutable="no">
        <type>const unsigned int</type>
        <definition>const unsigned int NODE_NETWORK_LIMITED_MIN_BLOCKS</definition>
        <argsstring></argsstring>
        <name>NODE_NETWORK_LIMITED_MIN_BLOCKS</name>
        <initializer>= 288</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Minimum blocks required to signal NODE_NETWORK_LIMITED </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="153" column="27" bodyfile="src/net_processing.cpp" bodystart="153" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1ad9dbd542b4eb0002d78b111d9451ade6" prot="public" static="yes" mutable="no">
        <type>const unsigned int</type>
        <definition>const unsigned int NODE_NETWORK_LIMITED_ALLOW_CONN_BLOCKS</definition>
        <argsstring></argsstring>
        <name>NODE_NETWORK_LIMITED_ALLOW_CONN_BLOCKS</name>
        <initializer>= 144</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Window, in blocks, for connecting to NODE_NETWORK_LIMITED peers </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="155" column="27" bodyfile="src/net_processing.cpp" bodystart="155" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a69b433ff4fb00d5842e1b23cfacb8d47" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL</definition>
        <argsstring></argsstring>
        <name>AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL</name>
        <initializer>{24h}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Average delay between local address broadcasts </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="157" column="23" bodyfile="src/net_processing.cpp" bodystart="157" bodyend="157"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1aa988ec6225aab4bbaf3d442e2caacf65" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto AVG_ADDRESS_BROADCAST_INTERVAL</definition>
        <argsstring></argsstring>
        <name>AVG_ADDRESS_BROADCAST_INTERVAL</name>
        <initializer>{30s}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Average delay between peer address broadcasts </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="159" column="23" bodyfile="src/net_processing.cpp" bodystart="159" bodyend="159"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a4a03b5f7d680de018f34e17603a0df3a" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto ROTATE_ADDR_RELAY_DEST_INTERVAL</definition>
        <argsstring></argsstring>
        <name>ROTATE_ADDR_RELAY_DEST_INTERVAL</name>
        <initializer>{24h}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Delay between rotating the peers we relay a particular address to </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="161" column="23" bodyfile="src/net_processing.cpp" bodystart="161" bodyend="161"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a7f1379e66bd66e4e5c99c82b8a6df92e" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto INBOUND_INVENTORY_BROADCAST_INTERVAL</definition>
        <argsstring></argsstring>
        <name>INBOUND_INVENTORY_BROADCAST_INTERVAL</name>
        <initializer>{5s}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Average delay between trickled inventory transmissions for inbound peers. Blocks and peers with <ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a12b80870cf3a64e605a95b9c521ac46f" kindref="member">NetPermissionFlags::NoBan</ref> permission bypass this. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="164" column="23" bodyfile="src/net_processing.cpp" bodystart="164" bodyend="164"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a5ab168fb2e6365fd92c3793765227fb2" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto OUTBOUND_INVENTORY_BROADCAST_INTERVAL</definition>
        <argsstring></argsstring>
        <name>OUTBOUND_INVENTORY_BROADCAST_INTERVAL</name>
        <initializer>{2s}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Average delay between trickled inventory transmissions for outbound peers. Use a smaller delay as there is less privacy concern for them. Blocks and peers with <ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a12b80870cf3a64e605a95b9c521ac46f" kindref="member">NetPermissionFlags::NoBan</ref> permission bypass this. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="168" column="23" bodyfile="src/net_processing.cpp" bodystart="168" bodyend="168"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1afd7942511c71a6beff3a52ebca300bd7" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>unsigned int</type>
        <definition>unsigned int INVENTORY_BROADCAST_PER_SECOND</definition>
        <argsstring></argsstring>
        <name>INVENTORY_BROADCAST_PER_SECOND</name>
        <initializer>{14}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Maximum rate of inventory items to send per second. Limits the impact of low-fee transaction floods. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="171" column="31" bodyfile="src/net_processing.cpp" bodystart="171" bodyend="171"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1ab5692270b5e7254f96f6609eec385df7" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>unsigned int</type>
        <definition>unsigned int INVENTORY_BROADCAST_TARGET</definition>
        <argsstring></argsstring>
        <name>INVENTORY_BROADCAST_TARGET</name>
        <initializer>= INVENTORY_BROADCAST_PER_SECOND * <ref refid="util_2time_8h_1a888f421c54ec4d38a01dd0f7ddacd6a6" kindref="member">count_seconds</ref>(INBOUND_INVENTORY_BROADCAST_INTERVAL)</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Target number of tx inventory items to send per transmission. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="173" column="31" bodyfile="src/net_processing.cpp" bodystart="173" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1ae619001e2f5b743715aa2ba3fe246b28" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>unsigned int</type>
        <definition>unsigned int INVENTORY_BROADCAST_MAX</definition>
        <argsstring></argsstring>
        <name>INVENTORY_BROADCAST_MAX</name>
        <initializer>= 1000</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Maximum number of inventory items to send per transmission. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="175" column="31" bodyfile="src/net_processing.cpp" bodystart="175" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a33c1d7a620522f0c1d4bbea50b1a78be" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto AVG_FEEFILTER_BROADCAST_INTERVAL</definition>
        <argsstring></argsstring>
        <name>AVG_FEEFILTER_BROADCAST_INTERVAL</name>
        <initializer>{10min}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Average delay between feefilter broadcasts in seconds. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="179" column="23" bodyfile="src/net_processing.cpp" bodystart="179" bodyend="179"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a910fba768a75562f70ade13b5912aff1" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>auto</type>
        <definition>auto MAX_FEEFILTER_CHANGE_DELAY</definition>
        <argsstring></argsstring>
        <name>MAX_FEEFILTER_CHANGE_DELAY</name>
        <initializer>{5min}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Maximum feefilter broadcast delay after significant change. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="181" column="23" bodyfile="src/net_processing.cpp" bodystart="181" bodyend="181"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a9232f9dcae06cb13135087951e4ff344" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>uint32_t</type>
        <definition>uint32_t MAX_GETCFILTERS_SIZE</definition>
        <argsstring></argsstring>
        <name>MAX_GETCFILTERS_SIZE</name>
        <initializer>= 1000</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Maximum number of compact filters that may be requested with one getcfilters. See BIP 157. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="183" column="27" bodyfile="src/net_processing.cpp" bodystart="183" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1adae0716c0b4b8f4cd4b2c09bc85d30f3" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>uint32_t</type>
        <definition>uint32_t MAX_GETCFHEADERS_SIZE</definition>
        <argsstring></argsstring>
        <name>MAX_GETCFHEADERS_SIZE</name>
        <initializer>= 2000</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Maximum number of cf hashes that may be requested with one getcfheaders. See BIP 157. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="185" column="27" bodyfile="src/net_processing.cpp" bodystart="185" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1aef5cecf17a89b3c6ac23f65a1869be8f" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>size_t</type>
        <definition>size_t MAX_PCT_ADDR_TO_SEND</definition>
        <argsstring></argsstring>
        <name>MAX_PCT_ADDR_TO_SEND</name>
        <initializer>= 23</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>the maximum percentage of addresses from our addrman to return in response to a getaddr message. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="187" column="25" bodyfile="src/net_processing.cpp" bodystart="187" bodyend="-1"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a0984d0ffb5f71eb4b61cb4019ae06bd0" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>size_t</type>
        <definition>size_t MAX_ADDR_TO_SEND</definition>
        <argsstring></argsstring>
        <name>MAX_ADDR_TO_SEND</name>
        <initializer>{1000}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>The maximum number of address records permitted in an ADDR message. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="189" column="25" bodyfile="src/net_processing.cpp" bodystart="189" bodyend="189"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1ac1660bcf523da75e96c6dbbe468c11a9" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>double</type>
        <definition>double MAX_ADDR_RATE_PER_SECOND</definition>
        <argsstring></argsstring>
        <name>MAX_ADDR_RATE_PER_SECOND</name>
        <initializer>{0.1}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>The maximum rate of address records we&apos;re willing to process on average. Can be bypassed using the <ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a3649a5e29ad648f3cfe3eea1a93d2f78" kindref="member">NetPermissionFlags::Addr</ref> permission. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="192" column="25" bodyfile="src/net_processing.cpp" bodystart="192" bodyend="192"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a0aada74bf62d10238c37e17f79ad0666" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>size_t</type>
        <definition>size_t MAX_ADDR_PROCESSING_TOKEN_BUCKET</definition>
        <argsstring></argsstring>
        <name>MAX_ADDR_PROCESSING_TOKEN_BUCKET</name>
        <initializer>{MAX_ADDR_TO_SEND}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>The soft limit of the address processing token bucket (the regular MAX_ADDR_RATE_PER_SECOND based increments won&apos;t go above this, but the MAX_ADDR_TO_SEND increment following GETADDR is exempt from this limit). </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="196" column="25" bodyfile="src/net_processing.cpp" bodystart="196" bodyend="196"/>
      </memberdef>
      <memberdef kind="variable" id="net__processing_8cpp_1a70d6fac555e42ddf050610cf461e76aa" prot="public" static="yes" constexpr="yes" mutable="no">
        <type>uint64_t</type>
        <definition>uint64_t CMPCTBLOCKS_VERSION</definition>
        <argsstring></argsstring>
        <name>CMPCTBLOCKS_VERSION</name>
        <initializer>{2}</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>The compactblocks version we support. See BIP 152. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="198" column="27" bodyfile="src/net_processing.cpp" bodystart="198" bodyend="198"/>
      </memberdef>
    </sectiondef>
    <sectiondef kind="func">
      <memberdef kind="function" id="net__processing_8cpp_1a21738205e135763c54e18d8b3ff24bf3" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>TRACEPOINT_SEMAPHORE</definition>
        <argsstring>(net, inbound_message)</argsstring>
        <name>TRACEPOINT_SEMAPHORE</name>
        <param>
          <type>net</type>
        </param>
        <param>
          <type>inbound_message</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="91" column="1" declfile="src/net_processing.cpp" declline="91" declcolumn="1"/>
      </memberdef>
      <memberdef kind="function" id="net__processing_8cpp_1a2f45dd8ae5514c59cfb888aa47f20fb2" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type></type>
        <definition>TRACEPOINT_SEMAPHORE</definition>
        <argsstring>(net, misbehaving_connection)</argsstring>
        <name>TRACEPOINT_SEMAPHORE</name>
        <param>
          <type>net</type>
        </param>
        <param>
          <type>misbehaving_connection</type>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="src/net_processing.cpp" line="92" column="1" declfile="src/net_processing.cpp" declline="92" declcolumn="1"/>
      </memberdef>
    </sectiondef>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="comment">//<sp/>Copyright<sp/>(c)<sp/>2009-2010<sp/>Satoshi<sp/>Nakamoto</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Copyright<sp/>(c)<sp/>2009-present<sp/>The<sp/>Bitcoin<sp/>Core<sp/>developers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Distributed<sp/>under<sp/>the<sp/>MIT<sp/>software<sp/>license,<sp/>see<sp/>the<sp/>accompanying</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4"><highlight class="normal"></highlight><highlight class="comment">//<sp/>file<sp/>COPYING<sp/>or<sp/>http://www.opensource.org/licenses/mit-license.php.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5"><highlight class="normal"></highlight></codeline>
<codeline lineno="6"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="net__processing_8h" kindref="compound">net_processing.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="addrman_8h" kindref="compound">addrman.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="arith__uint256_8h" kindref="compound">arith_uint256.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="banman_8h" kindref="compound">banman.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="blockencodings_8h" kindref="compound">blockencodings.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="blockfilter_8h" kindref="compound">blockfilter.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="13"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="chain_8h" kindref="compound">chain.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="14"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="chainparams_8h" kindref="compound">chainparams.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="15"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="bloom_8h" kindref="compound">common/bloom.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="16"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="amount_8h" kindref="compound">consensus/amount.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="17"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="params_8h" kindref="compound">consensus/params.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="18"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="consensus_2validation_8h" kindref="compound">consensus/validation.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="19"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="core__memusage_8h" kindref="compound">core_memusage.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="20"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="siphash_8h" kindref="compound">crypto/siphash.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="21"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="deploymentstatus_8h" kindref="compound">deploymentstatus.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="22"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="flatfile_8h" kindref="compound">flatfile.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="23"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="headerssync_8h" kindref="compound">headerssync.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="24"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="blockfilterindex_8h" kindref="compound">index/blockfilterindex.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="25"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="kernel_2types_8h" kindref="compound">kernel/types.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="26"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="logging_8h" kindref="compound">logging.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="27"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="merkleblock_8h" kindref="compound">merkleblock.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="28"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="net_8h" kindref="compound">net.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="29"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="net__permissions_8h" kindref="compound">net_permissions.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="30"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="netaddress_8h" kindref="compound">netaddress.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="31"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="netbase_8h" kindref="compound">netbase.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="32"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="netmessagemaker_8h" kindref="compound">netmessagemaker.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="33"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="blockstorage_8h" kindref="compound">node/blockstorage.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="34"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="connection__types_8h" kindref="compound">node/connection_types.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="35"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="protocol__version_8h" kindref="compound">node/protocol_version.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="36"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="timeoffsets_8h" kindref="compound">node/timeoffsets.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="37"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="txdownloadman_8h" kindref="compound">node/txdownloadman.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="38"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="txorphanage_8h" kindref="compound">node/txorphanage.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="39"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="txreconciliation_8h" kindref="compound">node/txreconciliation.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="40"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="warnings_8h" kindref="compound">node/warnings.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="41"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="feerate_8h" kindref="compound">policy/feerate.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="42"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="block__policy__estimator_8h" kindref="compound">policy/fees/block_policy_estimator.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="43"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="packages_8h" kindref="compound">policy/packages.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="44"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="policy_8h" kindref="compound">policy/policy.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="45"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="primitives_2block_8h" kindref="compound">primitives/block.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="46"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="primitives_2transaction_8h" kindref="compound">primitives/transaction.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="47"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="protocol_8h" kindref="compound">protocol.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="48"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="random_8h" kindref="compound">random.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="49"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="scheduler_8h" kindref="compound">scheduler.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="50"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="script_2script_8h" kindref="compound">script/script.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="51"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="serialize_8h" kindref="compound">serialize.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="52"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="span_8h" kindref="compound">span.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="53"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="streams_8h" kindref="compound">streams.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="54"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="sync_8h" kindref="compound">sync.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="55"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="tinyformat_8h" kindref="compound">tinyformat.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="56"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="txmempool_8h" kindref="compound">txmempool.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="57"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="uint256_8h" kindref="compound">uint256.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="58"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="check_8h" kindref="compound">util/check.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="59"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="strencodings_8h" kindref="compound">util/strencodings.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="60"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="util_2time_8h" kindref="compound">util/time.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="61"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="trace_8h" kindref="compound">util/trace.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="62"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="validation_8h" kindref="compound">validation.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="63"><highlight class="normal"></highlight></codeline>
<codeline lineno="64"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;algorithm&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="65"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;array&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="66"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;atomic&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="67"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;compare&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="68"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;cstddef&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="69"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;deque&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="70"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;exception&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="71"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;functional&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="72"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;future&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="73"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;initializer_list&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="74"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;iterator&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="75"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;limits&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="76"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;list&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="77"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;map&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="78"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;memory&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="79"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;optional&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="80"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;queue&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="81"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;ranges&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="82"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;ratio&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="83"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;set&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="84"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;span&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="85"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;typeinfo&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="86"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;utility&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="87"><highlight class="normal"></highlight></codeline>
<codeline lineno="88"><highlight class="normal"></highlight><highlight class="keyword">using<sp/></highlight><highlight class="normal"><ref refid="structkernel_1_1_chainstate_role" kindref="compound">kernel::ChainstateRole</ref>;</highlight></codeline>
<codeline lineno="89"><highlight class="normal"></highlight><highlight class="keyword">using<sp/>namespace<sp/></highlight><highlight class="normal"><ref refid="namespaceutil_1_1hex__literals" kindref="compound">util::hex_literals</ref>;</highlight></codeline>
<codeline lineno="90"><highlight class="normal"></highlight></codeline>
<codeline lineno="91"><highlight class="normal"><ref refid="trace_8h_1af7302c002c156c1b9ea318c0d86f624a" kindref="member">TRACEPOINT_SEMAPHORE</ref>(net,<sp/>inbound_message);</highlight></codeline>
<codeline lineno="92"><highlight class="normal"><ref refid="trace_8h_1af7302c002c156c1b9ea318c0d86f624a" kindref="member">TRACEPOINT_SEMAPHORE</ref>(net,<sp/>misbehaving_connection);</highlight></codeline>
<codeline lineno="93"><highlight class="normal"></highlight></codeline>
<codeline lineno="96"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>HEADERS_DOWNLOAD_TIMEOUT_BASE<sp/>=<sp/>15min;</highlight></codeline>
<codeline lineno="97"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>HEADERS_DOWNLOAD_TIMEOUT_PER_HEADER<sp/>=<sp/>1ms;</highlight></codeline>
<codeline lineno="99"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>HEADERS_RESPONSE_TIME{2min};</highlight></codeline>
<codeline lineno="103"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>int32_t<sp/>MAX_OUTBOUND_PEERS_TO_PROTECT_FROM_DISCONNECT<sp/>=<sp/>4;</highlight></codeline>
<codeline lineno="105"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>CHAIN_SYNC_TIMEOUT{20min};</highlight></codeline>
<codeline lineno="107"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>STALE_CHECK_INTERVAL{10min};</highlight></codeline>
<codeline lineno="109"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>EXTRA_PEER_CHECK_INTERVAL{45<ref refid="namespacetest__vectors__musig2__generate_1a5fcf9c70fa717a8efd481752dcb8ffa4" kindref="member">s</ref>};</highlight></codeline>
<codeline lineno="111"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>MINIMUM_CONNECT_TIME{30<ref refid="namespacetest__vectors__musig2__generate_1a5fcf9c70fa717a8efd481752dcb8ffa4" kindref="member">s</ref>};</highlight></codeline>
<codeline lineno="113"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint64_t<sp/>RANDOMIZER_ID_ADDRESS_RELAY<sp/>=<sp/>0x3cac0035b5866b90ULL;</highlight></codeline>
<codeline lineno="116"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>STALE_RELAY_AGE_LIMIT<sp/>=<sp/>30<sp/>*<sp/>24<sp/>*<sp/>60<sp/>*<sp/>60;</highlight></codeline>
<codeline lineno="119"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>HISTORICAL_BLOCK_AGE<sp/>=<sp/>7<sp/>*<sp/>24<sp/>*<sp/>60<sp/>*<sp/>60;</highlight></codeline>
<codeline lineno="121"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>PING_INTERVAL{2min};</highlight></codeline>
<codeline lineno="123"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>MAX_LOCATOR_SZ<sp/>=<sp/>101;</highlight></codeline>
<codeline lineno="125"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>MAX_INV_SZ<sp/>=<sp/>50000;</highlight></codeline>
<codeline lineno="127"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>MAX_GETDATA_SZ<sp/>=<sp/>1000;</highlight></codeline>
<codeline lineno="129"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>MAX_BLOCKS_IN_TRANSIT_PER_PEER<sp/>=<sp/>16;</highlight></codeline>
<codeline lineno="132"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>BLOCK_STALLING_TIMEOUT_DEFAULT{2<ref refid="namespacetest__vectors__musig2__generate_1a5fcf9c70fa717a8efd481752dcb8ffa4" kindref="member">s</ref>};</highlight></codeline>
<codeline lineno="134"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>BLOCK_STALLING_TIMEOUT_MAX{64<ref refid="namespacetest__vectors__musig2__generate_1a5fcf9c70fa717a8efd481752dcb8ffa4" kindref="member">s</ref>};</highlight></codeline>
<codeline lineno="137"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>MAX_CMPCTBLOCK_DEPTH<sp/>=<sp/>5;</highlight></codeline>
<codeline lineno="139"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>MAX_BLOCKTXN_DEPTH<sp/>=<sp/>10;</highlight></codeline>
<codeline lineno="140"><highlight class="normal"></highlight><highlight class="keyword">static_assert</highlight><highlight class="normal">(MAX_BLOCKTXN_DEPTH<sp/>&lt;=<sp/>MIN_BLOCKS_TO_KEEP,<sp/></highlight><highlight class="stringliteral">&quot;MAX_BLOCKTXN_DEPTH<sp/>too<sp/>high&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="145"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>BLOCK_DOWNLOAD_WINDOW<sp/>=<sp/>1024;</highlight></codeline>
<codeline lineno="147"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>BLOCK_DOWNLOAD_TIMEOUT_BASE<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="149"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>BLOCK_DOWNLOAD_TIMEOUT_PER_PEER<sp/>=<sp/>0.5;</highlight></codeline>
<codeline lineno="151"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>MAX_BLOCKS_TO_ANNOUNCE<sp/>=<sp/>8;</highlight></codeline>
<codeline lineno="153"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>NODE_NETWORK_LIMITED_MIN_BLOCKS<sp/>=<sp/>288;</highlight></codeline>
<codeline lineno="155"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>NODE_NETWORK_LIMITED_ALLOW_CONN_BLOCKS<sp/>=<sp/>144;</highlight></codeline>
<codeline lineno="157"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL{24h};</highlight></codeline>
<codeline lineno="159"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>AVG_ADDRESS_BROADCAST_INTERVAL{30<ref refid="namespacetest__vectors__musig2__generate_1a5fcf9c70fa717a8efd481752dcb8ffa4" kindref="member">s</ref>};</highlight></codeline>
<codeline lineno="161"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>ROTATE_ADDR_RELAY_DEST_INTERVAL{24h};</highlight></codeline>
<codeline lineno="164"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>INBOUND_INVENTORY_BROADCAST_INTERVAL{5<ref refid="namespacetest__vectors__musig2__generate_1a5fcf9c70fa717a8efd481752dcb8ffa4" kindref="member">s</ref>};</highlight></codeline>
<codeline lineno="168"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>OUTBOUND_INVENTORY_BROADCAST_INTERVAL{2<ref refid="namespacetest__vectors__musig2__generate_1a5fcf9c70fa717a8efd481752dcb8ffa4" kindref="member">s</ref>};</highlight></codeline>
<codeline lineno="171"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>INVENTORY_BROADCAST_PER_SECOND{14};</highlight></codeline>
<codeline lineno="173"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>INVENTORY_BROADCAST_TARGET<sp/>=<sp/>INVENTORY_BROADCAST_PER_SECOND<sp/>*<sp/><ref refid="util_2time_8h_1a888f421c54ec4d38a01dd0f7ddacd6a6" kindref="member">count_seconds</ref>(INBOUND_INVENTORY_BROADCAST_INTERVAL);</highlight></codeline>
<codeline lineno="175"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>INVENTORY_BROADCAST_MAX<sp/>=<sp/>1000;</highlight></codeline>
<codeline lineno="176"><highlight class="normal"></highlight><highlight class="keyword">static_assert</highlight><highlight class="normal">(INVENTORY_BROADCAST_MAX<sp/>&gt;=<sp/>INVENTORY_BROADCAST_TARGET,<sp/></highlight><highlight class="stringliteral">&quot;INVENTORY_BROADCAST_MAX<sp/>too<sp/>low&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="177"><highlight class="normal"></highlight><highlight class="keyword">static_assert</highlight><highlight class="normal">(INVENTORY_BROADCAST_MAX<sp/>&lt;=<sp/>node::MAX_PEER_TX_ANNOUNCEMENTS,<sp/></highlight><highlight class="stringliteral">&quot;INVENTORY_BROADCAST_MAX<sp/>too<sp/>high&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="179"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>AVG_FEEFILTER_BROADCAST_INTERVAL{10min};</highlight></codeline>
<codeline lineno="181"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>MAX_FEEFILTER_CHANGE_DELAY{5min};</highlight></codeline>
<codeline lineno="183"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint32_t<sp/>MAX_GETCFILTERS_SIZE<sp/>=<sp/>1000;</highlight></codeline>
<codeline lineno="185"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint32_t<sp/>MAX_GETCFHEADERS_SIZE<sp/>=<sp/>2000;</highlight></codeline>
<codeline lineno="187"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>MAX_PCT_ADDR_TO_SEND<sp/>=<sp/>23;</highlight></codeline>
<codeline lineno="189"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>MAX_ADDR_TO_SEND{1000};</highlight></codeline>
<codeline lineno="192"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>MAX_ADDR_RATE_PER_SECOND{0.1};</highlight></codeline>
<codeline lineno="196"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>MAX_ADDR_PROCESSING_TOKEN_BUCKET{MAX_ADDR_TO_SEND};</highlight></codeline>
<codeline lineno="198"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/>uint64_t<sp/>CMPCTBLOCKS_VERSION{2};</highlight></codeline>
<codeline lineno="199"><highlight class="normal"></highlight></codeline>
<codeline lineno="200"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Internal<sp/>stuff</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="201"><highlight class="normal"></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="203"><highlight class="normal"></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">QueuedBlock<sp/>{</highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindex;</highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/><sp/><sp/>std::unique_ptr&lt;PartiallyDownloadedBlock&gt;<sp/>partialBlock;</highlight></codeline>
<codeline lineno="208"><highlight class="normal">};</highlight></codeline>
<codeline lineno="209"><highlight class="normal"></highlight></codeline>
<codeline lineno="222"><highlight class="normal"></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">Peer<sp/>{</highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>m_id{0};</highlight></codeline>
<codeline lineno="225"><highlight class="normal"></highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537" kindref="member">ServiceFlags</ref><sp/>m_our_services;</highlight></codeline>
<codeline lineno="241"><highlight class="normal"><sp/><sp/><sp/><sp/>std::atomic&lt;ServiceFlags&gt;<sp/>m_their_services{<ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a51f819cd0b9ac374d6950a29b4861398" kindref="member">NODE_NONE</ref>};</highlight></codeline>
<codeline lineno="242"><highlight class="normal"></highlight></codeline>
<codeline lineno="244"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_is_inbound;</highlight></codeline>
<codeline lineno="245"><highlight class="normal"></highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a326d1d46ce05b5316d8ebe2694a10a6e" kindref="member">Mutex</ref><sp/>m_misbehavior_mutex;</highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_should_discourage<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_misbehavior_mutex){</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="250"><highlight class="normal"></highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a326d1d46ce05b5316d8ebe2694a10a6e" kindref="member">Mutex</ref><sp/>m_block_inv_mutex;</highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;uint256&gt;<sp/>m_blocks_for_inv_relay<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_block_inv_mutex);</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;uint256&gt;<sp/>m_blocks_for_headers_relay<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_block_inv_mutex);</highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><sp/><sp/>uint256<sp/>m_continuation_block<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_block_inv_mutex)<sp/>{};</highlight></codeline>
<codeline lineno="266"><highlight class="normal"></highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_outbound_version_message_sent<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="class_net_events_interface_1a49f0444456d2f1da9c3d2ce68a9bb128" kindref="member">NetEventsInterface::g_msgproc_mutex</ref>){</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="269"><highlight class="normal"></highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/><sp/><sp/>std::atomic&lt;int&gt;<sp/>m_starting_height{-1};</highlight></codeline>
<codeline lineno="272"><highlight class="normal"></highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/>std::atomic&lt;uint64_t&gt;<sp/>m_ping_nonce_sent{0};</highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/>std::atomic&lt;std::chrono::microseconds&gt;<sp/>m_ping_start{0us};</highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/>std::atomic&lt;bool&gt;<sp/>m_ping_queued{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="279"><highlight class="normal"></highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/>std::atomic&lt;bool&gt;<sp/>m_wtxid_relay{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/>m_fee_filter_sent<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="class_net_events_interface_1a49f0444456d2f1da9c3d2ce68a9bb128" kindref="member">NetEventsInterface::g_msgproc_mutex</ref>){0};</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/><sp/><sp/>std::chrono::microseconds<sp/>m_next_send_feefilter<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="class_net_events_interface_1a49f0444456d2f1da9c3d2ce68a9bb128" kindref="member">NetEventsInterface::g_msgproc_mutex</ref>){0};</highlight></codeline>
<codeline lineno="289"><highlight class="normal"></highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">TxRelay<sp/>{</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">mutable</highlight><highlight class="normal"><sp/><ref refid="sync_8h_1a5d71768bc9626b7482055d56d4e2c533" kindref="member">RecursiveMutex</ref><sp/>m_bloom_filter_mutex;</highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_relay_txs<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_bloom_filter_mutex){</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::unique_ptr&lt;CBloomFilter&gt;<sp/>m_bloom_filter<sp/><ref refid="thread__annotations_8h_1ac50ea92afc792eaa17777dc6009e31c0" kindref="member">PT_GUARDED_BY</ref>(m_bloom_filter_mutex)<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_bloom_filter_mutex){</highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="296"><highlight class="normal"></highlight></codeline>
<codeline lineno="297"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">mutable</highlight><highlight class="normal"><sp/><ref refid="sync_8h_1a5d71768bc9626b7482055d56d4e2c533" kindref="member">RecursiveMutex</ref><sp/>m_tx_inventory_mutex;</highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CRollingBloomFilter<sp/>m_tx_inventory_known_filter<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_tx_inventory_mutex){50000,<sp/>0.000001};</highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::set&lt;Wtxid&gt;<sp/>m_tx_inventory_to_send<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_tx_inventory_mutex);</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_send_mempool<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_tx_inventory_mutex){</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::chrono::microseconds<sp/>m_next_inv_send_time<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_tx_inventory_mutex){0};</highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>m_last_inv_sequence<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_tx_inventory_mutex){1};</highlight></codeline>
<codeline lineno="317"><highlight class="normal"></highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::atomic&lt;CAmount&gt;<sp/>m_fee_filter_received{0};</highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="321"><highlight class="normal"></highlight></codeline>
<codeline lineno="322"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Initializes<sp/>a<sp/>TxRelay<sp/>struct<sp/>for<sp/>this<sp/>peer.<sp/>Can<sp/>be<sp/>called<sp/>at<sp/>most<sp/>once<sp/>for<sp/>a<sp/>peer.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="323"><highlight class="normal"><sp/><sp/><sp/><sp/>TxRelay*<sp/>SetTxRelay()<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_tx_relay_mutex)</highlight></codeline>
<codeline lineno="324"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_tx_relay_mutex);</highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(!m_tx_relay);</highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_tx_relay<sp/>=<sp/>std::make_unique&lt;Peer::TxRelay&gt;();</highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>m_tx_relay.get();</highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="330"><highlight class="normal"></highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/>TxRelay*<sp/>GetTxRelay()<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_tx_relay_mutex)</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(m_tx_relay_mutex,<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>m_tx_relay.get());</highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="335"><highlight class="normal"></highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;CAddress&gt;<sp/>m_addrs_to_send<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="class_net_events_interface_1a49f0444456d2f1da9c3d2ce68a9bb128" kindref="member">NetEventsInterface::g_msgproc_mutex</ref>);</highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/>std::unique_ptr&lt;CRollingBloomFilter&gt;<sp/>m_addr_known<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="class_net_events_interface_1a49f0444456d2f1da9c3d2ce68a9bb128" kindref="member">NetEventsInterface::g_msgproc_mutex</ref>);</highlight></codeline>
<codeline lineno="362"><highlight class="normal"><sp/><sp/><sp/><sp/>std::atomic_bool<sp/>m_addr_relay_enabled{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="364"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_getaddr_sent<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="class_net_events_interface_1a49f0444456d2f1da9c3d2ce68a9bb128" kindref="member">NetEventsInterface::g_msgproc_mutex</ref>){</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="366"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">mutable</highlight><highlight class="normal"><sp/><ref refid="sync_8h_1a326d1d46ce05b5316d8ebe2694a10a6e" kindref="member">Mutex</ref><sp/>m_addr_send_times_mutex;</highlight></codeline>
<codeline lineno="368"><highlight class="normal"><sp/><sp/><sp/><sp/>std::chrono::microseconds<sp/>m_next_addr_send<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_addr_send_times_mutex){0};</highlight></codeline>
<codeline lineno="370"><highlight class="normal"><sp/><sp/><sp/><sp/>std::chrono::microseconds<sp/>m_next_local_addr_send<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_addr_send_times_mutex){0};</highlight></codeline>
<codeline lineno="373"><highlight class="normal"><sp/><sp/><sp/><sp/>std::atomic_bool<sp/>m_wants_addrv2{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="375"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_getaddr_recvd<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="class_net_events_interface_1a49f0444456d2f1da9c3d2ce68a9bb128" kindref="member">NetEventsInterface::g_msgproc_mutex</ref>){</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="378"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>m_addr_token_bucket<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="class_net_events_interface_1a49f0444456d2f1da9c3d2ce68a9bb128" kindref="member">NetEventsInterface::g_msgproc_mutex</ref>){1.0};</highlight></codeline>
<codeline lineno="380"><highlight class="normal"><sp/><sp/><sp/><sp/>std::chrono::microseconds<sp/>m_addr_token_timestamp<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="class_net_events_interface_1a49f0444456d2f1da9c3d2ce68a9bb128" kindref="member">NetEventsInterface::g_msgproc_mutex</ref>){<ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime&lt;std::chrono::microseconds&gt;</ref>()};</highlight></codeline>
<codeline lineno="382"><highlight class="normal"><sp/><sp/><sp/><sp/>std::atomic&lt;uint64_t&gt;<sp/>m_addr_rate_limited{0};</highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/><sp/><sp/>std::atomic&lt;uint64_t&gt;<sp/>m_addr_processed{0};</highlight></codeline>
<codeline lineno="385"><highlight class="normal"></highlight></codeline>
<codeline lineno="387"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_inv_triggered_getheaders_before_sync<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="class_net_events_interface_1a49f0444456d2f1da9c3d2ce68a9bb128" kindref="member">NetEventsInterface::g_msgproc_mutex</ref>){</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="388"><highlight class="normal"></highlight></codeline>
<codeline lineno="390"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a326d1d46ce05b5316d8ebe2694a10a6e" kindref="member">Mutex</ref><sp/>m_getdata_requests_mutex;</highlight></codeline>
<codeline lineno="392"><highlight class="normal"><sp/><sp/><sp/><sp/>std::deque&lt;CInv&gt;<sp/>m_getdata_requests<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_getdata_requests_mutex);</highlight></codeline>
<codeline lineno="393"><highlight class="normal"></highlight></codeline>
<codeline lineno="395"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="struct_node_clock_1a48de4126184b01b03967add7a27aae96" kindref="member">NodeClock::time_point</ref><sp/>m_last_getheaders_timestamp<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="class_net_events_interface_1a49f0444456d2f1da9c3d2ce68a9bb128" kindref="member">NetEventsInterface::g_msgproc_mutex</ref>){};</highlight></codeline>
<codeline lineno="396"><highlight class="normal"></highlight></codeline>
<codeline lineno="398"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a326d1d46ce05b5316d8ebe2694a10a6e" kindref="member">Mutex</ref><sp/>m_headers_sync_mutex;</highlight></codeline>
<codeline lineno="401"><highlight class="normal"><sp/><sp/><sp/><sp/>std::unique_ptr&lt;HeadersSyncState&gt;<sp/>m_headers_sync<sp/><ref refid="thread__annotations_8h_1ac50ea92afc792eaa17777dc6009e31c0" kindref="member">PT_GUARDED_BY</ref>(m_headers_sync_mutex)<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_headers_sync_mutex)<sp/>{};</highlight></codeline>
<codeline lineno="402"><highlight class="normal"></highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/><sp/><sp/>std::atomic&lt;bool&gt;<sp/>m_sent_sendheaders{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="405"><highlight class="normal"></highlight></codeline>
<codeline lineno="407"><highlight class="normal"><sp/><sp/><sp/><sp/>std::chrono::microseconds<sp/>m_headers_sync_timeout<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="class_net_events_interface_1a49f0444456d2f1da9c3d2ce68a9bb128" kindref="member">NetEventsInterface::g_msgproc_mutex</ref>){0us};</highlight></codeline>
<codeline lineno="408"><highlight class="normal"></highlight></codeline>
<codeline lineno="410"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_prefers_headers<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="class_net_events_interface_1a49f0444456d2f1da9c3d2ce68a9bb128" kindref="member">NetEventsInterface::g_msgproc_mutex</ref>){</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="411"><highlight class="normal"></highlight></codeline>
<codeline lineno="414"><highlight class="normal"><sp/><sp/><sp/><sp/>std::atomic&lt;std::chrono::seconds&gt;<sp/>m_time_offset{0<ref refid="namespacetest__vectors__musig2__generate_1a5fcf9c70fa717a8efd481752dcb8ffa4" kindref="member">s</ref>};</highlight></codeline>
<codeline lineno="415"><highlight class="normal"></highlight></codeline>
<codeline lineno="416"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">explicit</highlight><highlight class="normal"><sp/>Peer(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal">,<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537" kindref="member">ServiceFlags</ref><sp/>our_services,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>is_inbound)</highlight></codeline>
<codeline lineno="417"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>:<sp/>m_id{id}</highlight></codeline>
<codeline lineno="418"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,<sp/>m_our_services{our_services}</highlight></codeline>
<codeline lineno="419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,<sp/>m_is_inbound{is_inbound}</highlight></codeline>
<codeline lineno="420"><highlight class="normal"><sp/><sp/><sp/><sp/>{}</highlight></codeline>
<codeline lineno="421"><highlight class="normal"></highlight></codeline>
<codeline lineno="422"><highlight class="normal"></highlight><highlight class="keyword">private</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="423"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">mutable</highlight><highlight class="normal"><sp/><ref refid="sync_8h_1a326d1d46ce05b5316d8ebe2694a10a6e" kindref="member">Mutex</ref><sp/>m_tx_relay_mutex;</highlight></codeline>
<codeline lineno="424"><highlight class="normal"></highlight></codeline>
<codeline lineno="426"><highlight class="normal"><sp/><sp/><sp/><sp/>std::unique_ptr&lt;TxRelay&gt;<sp/>m_tx_relay<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_tx_relay_mutex);</highlight></codeline>
<codeline lineno="427"><highlight class="normal">};</highlight></codeline>
<codeline lineno="428"><highlight class="normal"></highlight></codeline>
<codeline lineno="429"><highlight class="normal"></highlight><highlight class="keyword">using<sp/></highlight><highlight class="normal">PeerRef<sp/>=<sp/>std::shared_ptr&lt;Peer&gt;;</highlight></codeline>
<codeline lineno="430"><highlight class="normal"></highlight></codeline>
<codeline lineno="437"><highlight class="normal"></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">CNodeState<sp/>{</highlight></codeline>
<codeline lineno="439"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindexBestKnownBlock{</highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="441"><highlight class="normal"><sp/><sp/><sp/><sp/>uint256<sp/>hashLastUnknownBlock{};</highlight></codeline>
<codeline lineno="443"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindexLastCommonBlock{</highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="445"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindexBestHeaderSent{</highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="447"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fSyncStarted{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="449"><highlight class="normal"><sp/><sp/><sp/><sp/>std::chrono::microseconds<sp/>m_stalling_since{0us};</highlight></codeline>
<codeline lineno="450"><highlight class="normal"><sp/><sp/><sp/><sp/>std::list&lt;QueuedBlock&gt;<sp/>vBlocksInFlight;</highlight></codeline>
<codeline lineno="452"><highlight class="normal"><sp/><sp/><sp/><sp/>std::chrono::microseconds<sp/>m_downloading_since{0us};</highlight></codeline>
<codeline lineno="454"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fPreferredDownload{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="456"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_requested_hb_cmpctblocks{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="458"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_provides_cmpctblocks{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="459"><highlight class="normal"></highlight></codeline>
<codeline lineno="484"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">ChainSyncTimeoutState<sp/>{</highlight></codeline>
<codeline lineno="486"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::chrono::seconds<sp/>m_timeout{0<ref refid="namespacetest__vectors__musig2__generate_1a5fcf9c70fa717a8efd481752dcb8ffa4" kindref="member">s</ref>};</highlight></codeline>
<codeline lineno="488"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>m_work_header{</highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_sent_getheaders{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_protect{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="493"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="494"><highlight class="normal"></highlight></codeline>
<codeline lineno="495"><highlight class="normal"><sp/><sp/><sp/><sp/>ChainSyncTimeoutState<sp/>m_chain_sync;</highlight></codeline>
<codeline lineno="496"><highlight class="normal"></highlight></codeline>
<codeline lineno="498"><highlight class="normal"><sp/><sp/><sp/><sp/>int64_t<sp/>m_last_block_announcement{0};</highlight></codeline>
<codeline lineno="499"><highlight class="normal">};</highlight></codeline>
<codeline lineno="500"><highlight class="normal"></highlight></codeline>
<codeline lineno="501"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal">PeerManagerImpl<sp/>final<sp/>:<sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/><ref refid="class_peer_manager" kindref="compound">PeerManager</ref></highlight></codeline>
<codeline lineno="502"><highlight class="normal">{</highlight></codeline>
<codeline lineno="503"><highlight class="normal"></highlight><highlight class="keyword">public</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="504"><highlight class="normal"><sp/><sp/><sp/><sp/>PeerManagerImpl(CConnman&amp;<sp/>connman,<sp/>AddrMan&amp;<sp/>addrman,</highlight></codeline>
<codeline lineno="505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BanMan*<sp/>banman,<sp/>ChainstateManager&amp;<sp/>chainman,</highlight></codeline>
<codeline lineno="506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CTxMemPool&amp;<sp/>pool,<sp/>node::Warnings&amp;<sp/>warnings,<sp/>Options<sp/>opts);</highlight></codeline>
<codeline lineno="507"><highlight class="normal"></highlight></codeline>
<codeline lineno="509"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ActiveTipChange(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex&amp;<sp/>new_tip,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal">)<sp/></highlight><highlight class="keyword">override</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_tx_download_mutex);</highlight></codeline>
<codeline lineno="511"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>BlockConnected(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>ChainstateRole&amp;<sp/>role,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;&amp;<sp/>pblock,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindexConnected)<sp/></highlight><highlight class="keyword">override</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_tx_download_mutex);</highlight></codeline>
<codeline lineno="513"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>BlockDisconnected(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;<sp/>&amp;block,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindex)<sp/></highlight><highlight class="keyword">override</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_tx_download_mutex);</highlight></codeline>
<codeline lineno="515"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>UpdatedBlockTip(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex<sp/>*pindexNew,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex<sp/>*pindexFork,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fInitialDownload)<sp/></highlight><highlight class="keyword">override</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="516"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex);</highlight></codeline>
<codeline lineno="517"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>BlockChecked(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;&amp;<sp/>block,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BlockValidationState&amp;<sp/>state)<sp/></highlight><highlight class="keyword">override</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex);</highlight></codeline>
<codeline lineno="519"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>NewPoWValidBlock(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex<sp/>*pindex,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;&amp;<sp/>pblock)<sp/></highlight><highlight class="keyword">override</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="520"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_most_recent_block_mutex);</highlight></codeline>
<codeline lineno="521"><highlight class="normal"></highlight></codeline>
<codeline lineno="523"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>InitializeNode(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CNode&amp;<sp/>node,<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537" kindref="member">ServiceFlags</ref><sp/>our_services)<sp/></highlight><highlight class="keyword">override</highlight><highlight class="normal"><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex,<sp/>!m_tx_download_mutex);</highlight></codeline>
<codeline lineno="524"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>FinalizeNode(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CNode&amp;<sp/>node)<sp/></highlight><highlight class="keyword">override</highlight><highlight class="normal"><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex,<sp/>!m_headers_presync_mutex,<sp/>!m_tx_download_mutex);</highlight></codeline>
<codeline lineno="525"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>HasAllDesirableServiceFlags(<ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537" kindref="member">ServiceFlags</ref><sp/>services)<sp/></highlight><highlight class="keyword">const<sp/>override</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="526"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>ProcessMessages(CNode*<sp/>pfrom,<sp/>std::atomic&lt;bool&gt;&amp;<sp/>interrupt)<sp/></highlight><highlight class="keyword">override</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="527"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex,<sp/>!m_most_recent_block_mutex,<sp/>!m_headers_presync_mutex,<sp/>g_msgproc_mutex,<sp/>!m_tx_download_mutex);</highlight></codeline>
<codeline lineno="528"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>SendMessages(CNode*<sp/>pto)<sp/></highlight><highlight class="keyword">override</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="529"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex,<sp/>!m_most_recent_block_mutex,<sp/>g_msgproc_mutex,<sp/>!m_tx_download_mutex);</highlight></codeline>
<codeline lineno="530"><highlight class="normal"></highlight></codeline>
<codeline lineno="532"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>StartScheduledTasks(CScheduler&amp;<sp/>scheduler)<sp/></highlight><highlight class="keyword">override</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="533"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>CheckForStaleTipAndEvictPeers()<sp/></highlight><highlight class="keyword">override</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="534"><highlight class="normal"><sp/><sp/><sp/><sp/>util::Expected&lt;void,<sp/>std::string&gt;<sp/>FetchBlock(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>peer_id,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex&amp;<sp/>block_index)<sp/></highlight><highlight class="keyword">override</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="535"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex);</highlight></codeline>
<codeline lineno="536"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>GetNodeStateStats(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid,<sp/>CNodeStateStats&amp;<sp/>stats)<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">override</highlight><highlight class="normal"><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex);</highlight></codeline>
<codeline lineno="537"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;node::TxOrphanage::OrphanInfo&gt;<sp/>GetOrphanTransactions()<sp/>override<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_tx_download_mutex);</highlight></codeline>
<codeline lineno="538"><highlight class="normal"><sp/><sp/><sp/><sp/>PeerManagerInfo<sp/>GetInfo()<sp/>const<sp/>override<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex);</highlight></codeline>
<codeline lineno="539"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>SendPings()<sp/>override<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex);</highlight></codeline>
<codeline lineno="540"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>RelayTransaction(const<sp/><ref refid="transaction__identifier_8h_1ac4bb3c35b94889843d632be4de4b223c" kindref="member">Txid</ref>&amp;<sp/>txid,<sp/>const<sp/><ref refid="transaction__identifier_8h_1a23364c1312d4dffbbf549b4440333fd9" kindref="member">Wtxid</ref>&amp;<sp/>wtxid)<sp/>override<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex);</highlight></codeline>
<codeline lineno="541"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>SetBestBlock(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>height,<sp/>std::chrono::seconds<sp/>time)</highlight><highlight class="keyword"><sp/>override</highlight></codeline>
<codeline lineno="542"><highlight class="keyword"><sp/><sp/><sp/><sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="543"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_best_height<sp/>=<sp/>height;</highlight></codeline>
<codeline lineno="544"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_best_block_time<sp/>=<sp/>time;</highlight></codeline>
<codeline lineno="545"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="546"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>UnitTestMisbehaving(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>peer_id)<sp/></highlight><highlight class="keyword">override</highlight><highlight class="normal"><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex)<sp/>{<sp/>Misbehaving(*<ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(GetPeerRef(peer_id)),<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">);<sp/>};</highlight></codeline>
<codeline lineno="547"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ProcessMessage(CNode&amp;<sp/>pfrom,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::string&amp;<sp/>msg_type,<sp/>DataStream&amp;<sp/>vRecv,</highlight></codeline>
<codeline lineno="548"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::chrono::microseconds<sp/>time_received,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::atomic&lt;bool&gt;&amp;<sp/>interruptMsgProc)<sp/></highlight><highlight class="keyword">override</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="549"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex,<sp/>!m_most_recent_block_mutex,<sp/>!m_headers_presync_mutex,<sp/>g_msgproc_mutex,<sp/>!m_tx_download_mutex);</highlight></codeline>
<codeline lineno="550"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>UpdateLastBlockAnnounceTime(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>node,<sp/>int64_t<sp/>time_in_seconds)<sp/></highlight><highlight class="keyword">override</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="551"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537" kindref="member">ServiceFlags</ref><sp/>GetDesirableServiceFlags(<ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537" kindref="member">ServiceFlags</ref><sp/>services)<sp/></highlight><highlight class="keyword">const<sp/>override</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="552"><highlight class="normal"></highlight></codeline>
<codeline lineno="553"><highlight class="normal"></highlight><highlight class="keyword">private</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="555"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ConsiderEviction(CNode&amp;<sp/>pto,<sp/>Peer&amp;<sp/>peer,<sp/>std::chrono::seconds<sp/>time_in_seconds)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>g_msgproc_mutex);</highlight></codeline>
<codeline lineno="556"><highlight class="normal"></highlight></codeline>
<codeline lineno="558"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>EvictExtraOutboundPeers(std::chrono::seconds<sp/>now)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="559"><highlight class="normal"></highlight></codeline>
<codeline lineno="561"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ReattemptInitialBroadcast(CScheduler&amp;<sp/>scheduler)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex);</highlight></codeline>
<codeline lineno="562"><highlight class="normal"></highlight></codeline>
<codeline lineno="565"><highlight class="normal"><sp/><sp/><sp/><sp/>PeerRef<sp/>GetPeerRef(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal">)<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex);</highlight></codeline>
<codeline lineno="566"><highlight class="normal"></highlight></codeline>
<codeline lineno="569"><highlight class="normal"><sp/><sp/><sp/><sp/>PeerRef<sp/>RemovePeer(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal">)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex);</highlight></codeline>
<codeline lineno="570"><highlight class="normal"></highlight></codeline>
<codeline lineno="573"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>Misbehaving(Peer&amp;<sp/>peer,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::string&amp;<sp/>message);</highlight></codeline>
<codeline lineno="574"><highlight class="normal"></highlight></codeline>
<codeline lineno="583"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>MaybePunishNodeForBlock(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BlockValidationState&amp;<sp/>state,</highlight></codeline>
<codeline lineno="584"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>via_compact_block,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::string&amp;<sp/>message<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="585"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex);</highlight></codeline>
<codeline lineno="586"><highlight class="normal"></highlight></codeline>
<codeline lineno="593"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>MaybeDiscourageAndDisconnect(CNode&amp;<sp/>pnode,<sp/>Peer&amp;<sp/>peer);</highlight></codeline>
<codeline lineno="594"><highlight class="normal"></highlight></codeline>
<codeline lineno="606"><highlight class="normal"><sp/><sp/><sp/><sp/>std::optional&lt;node::PackageToValidate&gt;<sp/>ProcessInvalidTx(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid,<sp/>const<sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref>&amp;<sp/>tx,<sp/>const<sp/>TxValidationState&amp;<sp/>result,</highlight></codeline>
<codeline lineno="607"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>first_time_failure)</highlight></codeline>
<codeline lineno="608"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex,<sp/>g_msgproc_mutex,<sp/>m_tx_download_mutex);</highlight></codeline>
<codeline lineno="609"><highlight class="normal"></highlight></codeline>
<codeline lineno="612"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ProcessValidTx(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid,<sp/>const<sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref>&amp;<sp/>tx,<sp/>const<sp/>std::list&lt;<ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref>&gt;&amp;<sp/>replaced_transactions)</highlight></codeline>
<codeline lineno="613"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex,<sp/>g_msgproc_mutex,<sp/>m_tx_download_mutex);</highlight></codeline>
<codeline lineno="614"><highlight class="normal"></highlight></codeline>
<codeline lineno="618"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ProcessPackageResult(const<sp/>node::PackageToValidate&amp;<sp/>package_to_validate,<sp/>const<sp/>PackageMempoolAcceptResult&amp;<sp/>package_result)</highlight></codeline>
<codeline lineno="619"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex,<sp/>g_msgproc_mutex,<sp/>m_tx_download_mutex);</highlight></codeline>
<codeline lineno="620"><highlight class="normal"></highlight></codeline>
<codeline lineno="632"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>ProcessOrphanTx(Peer&amp;<sp/>peer)</highlight></codeline>
<codeline lineno="633"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex,<sp/>g_msgproc_mutex,<sp/>!m_tx_download_mutex);</highlight></codeline>
<codeline lineno="634"><highlight class="normal"></highlight></codeline>
<codeline lineno="642"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ProcessHeadersMessage(CNode&amp;<sp/>pfrom,<sp/>Peer&amp;<sp/>peer,</highlight></codeline>
<codeline lineno="643"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CBlockHeader&gt;&amp;&amp;<sp/>headers,</highlight></codeline>
<codeline lineno="644"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>via_compact_block)</highlight></codeline>
<codeline lineno="645"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex,<sp/>!m_headers_presync_mutex,<sp/>g_msgproc_mutex);</highlight></codeline>
<codeline lineno="648"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CheckHeadersPoW(const<sp/>std::vector&lt;CBlockHeader&gt;&amp;<sp/>headers,<sp/>const<sp/>Consensus::<ref refid="chainparams_8cpp_1ad82533eea3b187c1ac5b7c54d8c6f121" kindref="member">Params</ref>&amp;<sp/>consensusParams,<sp/>Peer&amp;<sp/>peer);</highlight></codeline>
<codeline lineno="650"><highlight class="normal"><sp/><sp/><sp/><sp/>arith_uint256<sp/>GetAntiDoSWorkThreshold();</highlight></codeline>
<codeline lineno="654"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>HandleUnconnectingHeaders(CNode&amp;<sp/>pfrom,<sp/>Peer&amp;<sp/>peer,<sp/>const<sp/>std::vector&lt;CBlockHeader&gt;&amp;<sp/>headers)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="656"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CheckHeadersAreContinuous(const<sp/>std::vector&lt;CBlockHeader&gt;&amp;<sp/>headers)<sp/>const;</highlight></codeline>
<codeline lineno="675"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>IsContinuationOfLowWorkHeadersSync(Peer&amp;<sp/>peer,<sp/>CNode&amp;<sp/>pfrom,</highlight></codeline>
<codeline lineno="676"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CBlockHeader&gt;&amp;<sp/>headers)</highlight></codeline>
<codeline lineno="677"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(peer.m_headers_sync_mutex,<sp/>!m_headers_presync_mutex,<sp/>g_msgproc_mutex);</highlight></codeline>
<codeline lineno="689"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>TryLowWorkHeadersSync(Peer&amp;<sp/>peer,<sp/>CNode&amp;<sp/>pfrom,</highlight></codeline>
<codeline lineno="690"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>CBlockIndex*<sp/>chain_start_header,</highlight></codeline>
<codeline lineno="691"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CBlockHeader&gt;&amp;<sp/>headers)</highlight></codeline>
<codeline lineno="692"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!peer.m_headers_sync_mutex,<sp/>!m_peer_mutex,<sp/>!m_headers_presync_mutex,<sp/>g_msgproc_mutex);</highlight></codeline>
<codeline lineno="693"><highlight class="normal"></highlight></codeline>
<codeline lineno="696"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>IsAncestorOfBestHeaderOrTip(const<sp/>CBlockIndex*<sp/>header)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="697"><highlight class="normal"></highlight></codeline>
<codeline lineno="702"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>MaybeSendGetHeaders(CNode&amp;<sp/>pfrom,<sp/>const<sp/>CBlockLocator&amp;<sp/>locator,<sp/>Peer&amp;<sp/>peer)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="704"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>HeadersDirectFetchBlocks(CNode&amp;<sp/>pfrom,<sp/>const<sp/>Peer&amp;<sp/>peer,<sp/>const<sp/>CBlockIndex&amp;<sp/>last_header);</highlight></codeline>
<codeline lineno="706"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>UpdatePeerStateForReceivedHeaders(CNode&amp;<sp/>pfrom,<sp/>Peer&amp;<sp/>peer,<sp/>const<sp/>CBlockIndex&amp;<sp/>last_header,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>received_new_header,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>may_have_more_headers)</highlight></codeline>
<codeline lineno="707"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="708"><highlight class="normal"></highlight></codeline>
<codeline lineno="709"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>SendBlockTransactions(CNode&amp;<sp/>pfrom,<sp/>Peer&amp;<sp/>peer,<sp/>const<sp/>CBlock&amp;<sp/>block,<sp/>const<sp/>BlockTransactionsRequest&amp;<sp/>req);</highlight></codeline>
<codeline lineno="710"><highlight class="normal"></highlight></codeline>
<codeline lineno="712"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PushMessage(CNode&amp;<sp/>node,<sp/>CSerializedNetMsg&amp;&amp;<sp/>msg)</highlight><highlight class="keyword"><sp/>const<sp/></highlight><highlight class="normal">{<sp/>m_connman.PushMessage(&amp;node,<sp/>std::move(msg));<sp/>}</highlight></codeline>
<codeline lineno="713"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">template</highlight><highlight class="normal"><sp/>&lt;</highlight><highlight class="keyword">typename</highlight><highlight class="normal">...<sp/>Args&gt;</highlight></codeline>
<codeline lineno="714"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>MakeAndPushMessage(CNode&amp;<sp/>node,<sp/>std::string<sp/>msg_type,<sp/>Args&amp;&amp;...<sp/><ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="715"><highlight class="keyword"><sp/><sp/><sp/><sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="716"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_connman.PushMessage(&amp;node,<sp/><ref refid="namespace_net_msg_1af64271506a941980bc0af944c721b637" kindref="member">NetMsg::Make</ref>(std::move(msg_type),<sp/>std::forward&lt;Args&gt;(<ref refid="bitcoind_8cpp_1a38fca8b1d65c4185736654ab56bcf691" kindref="member">args</ref>)...));</highlight></codeline>
<codeline lineno="717"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="718"><highlight class="normal"></highlight></codeline>
<codeline lineno="720"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PushNodeVersion(CNode&amp;<sp/>pnode,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Peer&amp;<sp/>peer);</highlight></codeline>
<codeline lineno="721"><highlight class="normal"></highlight></codeline>
<codeline lineno="726"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>MaybeSendPing(CNode&amp;<sp/>node_to,<sp/>Peer&amp;<sp/>peer,<sp/>std::chrono::microseconds<sp/>now);</highlight></codeline>
<codeline lineno="727"><highlight class="normal"></highlight></codeline>
<codeline lineno="729"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>MaybeSendAddr(CNode&amp;<sp/>node,<sp/>Peer&amp;<sp/>peer,<sp/>std::chrono::microseconds<sp/>current_time)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="730"><highlight class="normal"></highlight></codeline>
<codeline lineno="732"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>MaybeSendSendHeaders(CNode&amp;<sp/>node,<sp/>Peer&amp;<sp/>peer)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="733"><highlight class="normal"></highlight></codeline>
<codeline lineno="741"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>RelayAddress(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>originator,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CAddress&amp;<sp/>addr,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fReachable)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_peer_mutex,<sp/>g_msgproc_mutex);</highlight></codeline>
<codeline lineno="742"><highlight class="normal"></highlight></codeline>
<codeline lineno="744"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>MaybeSendFeefilter(CNode&amp;<sp/>node,<sp/>Peer&amp;<sp/>peer,<sp/>std::chrono::microseconds<sp/>current_time)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="745"><highlight class="normal"></highlight></codeline>
<codeline lineno="746"><highlight class="normal"><sp/><sp/><sp/><sp/>FastRandomContext<sp/>m_rng<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="class_net_events_interface_1a49f0444456d2f1da9c3d2ce68a9bb128" kindref="member">NetEventsInterface::g_msgproc_mutex</ref>);</highlight></codeline>
<codeline lineno="747"><highlight class="normal"></highlight></codeline>
<codeline lineno="748"><highlight class="normal"><sp/><sp/><sp/><sp/>FeeFilterRounder<sp/>m_fee_filter_rounder<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="class_net_events_interface_1a49f0444456d2f1da9c3d2ce68a9bb128" kindref="member">NetEventsInterface::g_msgproc_mutex</ref>);</highlight></codeline>
<codeline lineno="749"><highlight class="normal"></highlight></codeline>
<codeline lineno="750"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CChainParams&amp;<sp/>m_chainparams;</highlight></codeline>
<codeline lineno="751"><highlight class="normal"><sp/><sp/><sp/><sp/>CConnman&amp;<sp/>m_connman;</highlight></codeline>
<codeline lineno="752"><highlight class="normal"><sp/><sp/><sp/><sp/>AddrMan&amp;<sp/>m_addrman;</highlight></codeline>
<codeline lineno="754"><highlight class="normal"><sp/><sp/><sp/><sp/>BanMan*<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>m_banman;</highlight></codeline>
<codeline lineno="755"><highlight class="normal"><sp/><sp/><sp/><sp/>ChainstateManager&amp;<sp/>m_chainman;</highlight></codeline>
<codeline lineno="756"><highlight class="normal"><sp/><sp/><sp/><sp/>CTxMemPool&amp;<sp/>m_mempool;</highlight></codeline>
<codeline lineno="757"><highlight class="normal"></highlight></codeline>
<codeline lineno="766"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a326d1d46ce05b5316d8ebe2694a10a6e" kindref="member">Mutex</ref><sp/>m_tx_download_mutex<sp/><ref refid="thread__annotations_8h_1aabfe9909811c29995cc731bd19a2d544" kindref="member">ACQUIRED_BEFORE</ref>(m_mempool.cs);</highlight></codeline>
<codeline lineno="767"><highlight class="normal"><sp/><sp/><sp/><sp/>node::TxDownloadManager<sp/>m_txdownloadman<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_tx_download_mutex);</highlight></codeline>
<codeline lineno="768"><highlight class="normal"></highlight></codeline>
<codeline lineno="769"><highlight class="normal"><sp/><sp/><sp/><sp/>std::unique_ptr&lt;TxReconciliationTracker&gt;<sp/>m_txreconciliation;</highlight></codeline>
<codeline lineno="770"><highlight class="normal"></highlight></codeline>
<codeline lineno="772"><highlight class="normal"><sp/><sp/><sp/><sp/>std::atomic&lt;int&gt;<sp/>m_best_height{-1};</highlight></codeline>
<codeline lineno="774"><highlight class="normal"><sp/><sp/><sp/><sp/>std::atomic&lt;std::chrono::seconds&gt;<sp/>m_best_block_time{0<ref refid="namespacetest__vectors__musig2__generate_1a5fcf9c70fa717a8efd481752dcb8ffa4" kindref="member">s</ref>};</highlight></codeline>
<codeline lineno="775"><highlight class="normal"></highlight></codeline>
<codeline lineno="777"><highlight class="normal"><sp/><sp/><sp/><sp/>std::chrono::seconds<sp/>m_stale_tip_check_time<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>){0<ref refid="namespacetest__vectors__musig2__generate_1a5fcf9c70fa717a8efd481752dcb8ffa4" kindref="member">s</ref>};</highlight></codeline>
<codeline lineno="778"><highlight class="normal"></highlight></codeline>
<codeline lineno="779"><highlight class="normal"><sp/><sp/><sp/><sp/>node::Warnings&amp;<sp/>m_warnings;</highlight></codeline>
<codeline lineno="780"><highlight class="normal"><sp/><sp/><sp/><sp/>TimeOffsets<sp/>m_outbound_time_offsets{m_warnings};</highlight></codeline>
<codeline lineno="781"><highlight class="normal"></highlight></codeline>
<codeline lineno="782"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Options<sp/>m_opts;</highlight></codeline>
<codeline lineno="783"><highlight class="normal"></highlight></codeline>
<codeline lineno="784"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>RejectIncomingTxs(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CNode&amp;<sp/>peer)<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="785"><highlight class="normal"></highlight></codeline>
<codeline lineno="788"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>m_initial_sync_finished<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>){</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="789"><highlight class="normal"></highlight></codeline>
<codeline lineno="792"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">mutable</highlight><highlight class="normal"><sp/><ref refid="sync_8h_1a326d1d46ce05b5316d8ebe2694a10a6e" kindref="member">Mutex</ref><sp/>m_peer_mutex;</highlight></codeline>
<codeline lineno="799"><highlight class="normal"><sp/><sp/><sp/><sp/>std::map&lt;NodeId,<sp/>PeerRef&gt;<sp/>m_peer_map<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_peer_mutex);</highlight></codeline>
<codeline lineno="800"><highlight class="normal"></highlight></codeline>
<codeline lineno="802"><highlight class="normal"><sp/><sp/><sp/><sp/>std::map&lt;NodeId,<sp/>CNodeState&gt;<sp/>m_node_states<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="803"><highlight class="normal"></highlight></codeline>
<codeline lineno="805"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CNodeState*<sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>pnode)<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="807"><highlight class="normal"><sp/><sp/><sp/><sp/>CNodeState*<sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>pnode)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="808"><highlight class="normal"></highlight></codeline>
<codeline lineno="809"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>GetFetchFlags(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Peer&amp;<sp/>peer)<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="810"><highlight class="normal"></highlight></codeline>
<codeline lineno="811"><highlight class="normal"><sp/><sp/><sp/><sp/>std::map&lt;uint64_t,<sp/>std::chrono::microseconds&gt;<sp/>m_next_inv_to_inbounds_per_network_key<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="812"><highlight class="normal"></highlight></codeline>
<codeline lineno="814"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nSyncStarted<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>)<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="815"><highlight class="normal"></highlight></codeline>
<codeline lineno="817"><highlight class="normal"><sp/><sp/><sp/><sp/>uint256<sp/>m_last_block_inv_triggering_headers_sync<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(g_msgproc_mutex){};</highlight></codeline>
<codeline lineno="818"><highlight class="normal"></highlight></codeline>
<codeline lineno="825"><highlight class="normal"><sp/><sp/><sp/><sp/>std::map&lt;uint256,<sp/>std::pair&lt;NodeId,<sp/>bool&gt;&gt;<sp/>mapBlockSource<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="826"><highlight class="normal"></highlight></codeline>
<codeline lineno="828"><highlight class="normal"><sp/><sp/><sp/><sp/>std::atomic&lt;int&gt;<sp/>m_wtxid_relay_peers{0};</highlight></codeline>
<codeline lineno="829"><highlight class="normal"></highlight></codeline>
<codeline lineno="831"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>m_outbound_peers_with_protect_from_disconnect<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>)<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="832"><highlight class="normal"></highlight></codeline>
<codeline lineno="834"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>m_num_preferred_download_peers<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>){0};</highlight></codeline>
<codeline lineno="835"><highlight class="normal"></highlight></codeline>
<codeline lineno="837"><highlight class="normal"><sp/><sp/><sp/><sp/>std::atomic&lt;std::chrono::seconds&gt;<sp/>m_block_stalling_timeout{BLOCK_STALLING_TIMEOUT_DEFAULT};</highlight></codeline>
<codeline lineno="838"><highlight class="normal"></highlight></codeline>
<codeline lineno="846"><highlight class="normal"><sp/><sp/><sp/><sp/>std::chrono::microseconds<sp/>NextInvToInbounds(std::chrono::microseconds<sp/>now,</highlight></codeline>
<codeline lineno="847"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::chrono::seconds<sp/>average_interval,</highlight></codeline>
<codeline lineno="848"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>network_key)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="849"><highlight class="normal"></highlight></codeline>
<codeline lineno="850"><highlight class="normal"></highlight></codeline>
<codeline lineno="851"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>All<sp/>of<sp/>the<sp/>following<sp/>cache<sp/>a<sp/>recent<sp/>block,<sp/>and<sp/>are<sp/>protected<sp/>by<sp/>m_most_recent_block_mutex</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="852"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a326d1d46ce05b5316d8ebe2694a10a6e" kindref="member">Mutex</ref><sp/>m_most_recent_block_mutex;</highlight></codeline>
<codeline lineno="853"><highlight class="normal"><sp/><sp/><sp/><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;<sp/>m_most_recent_block<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_most_recent_block_mutex);</highlight></codeline>
<codeline lineno="854"><highlight class="normal"><sp/><sp/><sp/><sp/>std::shared_ptr&lt;const<sp/>CBlockHeaderAndShortTxIDs&gt;<sp/>m_most_recent_compact_block<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_most_recent_block_mutex);</highlight></codeline>
<codeline lineno="855"><highlight class="normal"><sp/><sp/><sp/><sp/>uint256<sp/>m_most_recent_block_hash<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_most_recent_block_mutex);</highlight></codeline>
<codeline lineno="856"><highlight class="normal"><sp/><sp/><sp/><sp/>std::unique_ptr&lt;const<sp/>std::map&lt;GenTxid,<sp/>CTransactionRef&gt;&gt;<sp/>m_most_recent_block_txs<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_most_recent_block_mutex);</highlight></codeline>
<codeline lineno="857"><highlight class="normal"></highlight></codeline>
<codeline lineno="858"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Data<sp/>about<sp/>the<sp/>low-work<sp/>headers<sp/>synchronization,<sp/>aggregated<sp/>from<sp/>all<sp/>peers&apos;<sp/>HeadersSyncStates.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="860"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a326d1d46ce05b5316d8ebe2694a10a6e" kindref="member">Mutex</ref><sp/>m_headers_presync_mutex;</highlight></codeline>
<codeline lineno="868"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">using<sp/></highlight><highlight class="normal">HeadersPresyncStats<sp/>=<sp/>std::pair&lt;arith_uint256,<sp/>std::optional&lt;std::pair&lt;int64_t,<sp/>uint32_t&gt;&gt;&gt;;</highlight></codeline>
<codeline lineno="870"><highlight class="normal"><sp/><sp/><sp/><sp/>std::map&lt;NodeId,<sp/>HeadersPresyncStats&gt;<sp/>m_headers_presync_stats<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_headers_presync_mutex)<sp/>{};</highlight></codeline>
<codeline lineno="872"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>m_headers_presync_bestpeer<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(m_headers_presync_mutex)<sp/>{-1};</highlight></codeline>
<codeline lineno="874"><highlight class="normal"><sp/><sp/><sp/><sp/>std::atomic_bool<sp/>m_headers_presync_should_signal{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="875"><highlight class="normal"></highlight></codeline>
<codeline lineno="877"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>m_highest_fast_announce<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>){0};</highlight></codeline>
<codeline lineno="878"><highlight class="normal"></highlight></codeline>
<codeline lineno="880"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>IsBlockRequested(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256&amp;<sp/>hash)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="881"><highlight class="normal"></highlight></codeline>
<codeline lineno="883"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>IsBlockRequestedFromOutbound(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256&amp;<sp/>hash)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>!m_peer_mutex);</highlight></codeline>
<codeline lineno="884"><highlight class="normal"></highlight></codeline>
<codeline lineno="892"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>RemoveBlockRequest(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256&amp;<sp/>hash,<sp/>std::optional&lt;NodeId&gt;<sp/>from_peer)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="893"><highlight class="normal"></highlight></codeline>
<codeline lineno="894"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Mark<sp/>a<sp/>block<sp/>as<sp/>in<sp/>flight</highlight></codeline>
<codeline lineno="895"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/>*<sp/>Returns<sp/>false,<sp/>still<sp/>setting<sp/>pit,<sp/>if<sp/>the<sp/>block<sp/>was<sp/>already<sp/>in<sp/>flight<sp/>from<sp/>the<sp/>same<sp/>peer</highlight></codeline>
<codeline lineno="896"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/>*<sp/>pit<sp/>will<sp/>only<sp/>be<sp/>valid<sp/>as<sp/>long<sp/>as<sp/>the<sp/>same<sp/>cs_main<sp/>lock<sp/>is<sp/>being<sp/>held</highlight></codeline>
<codeline lineno="897"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="898"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>BlockRequested(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex&amp;<sp/>block,<sp/>std::list&lt;QueuedBlock&gt;::iterator**<sp/>pit<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="899"><highlight class="normal"></highlight></codeline>
<codeline lineno="900"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>TipMayBeStale()<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="901"><highlight class="normal"></highlight></codeline>
<codeline lineno="905"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>FindNextBlocksToDownload(const<sp/>Peer&amp;<sp/>peer,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>count,<sp/>std::vector&lt;const<sp/>CBlockIndex*&gt;&amp;<sp/>vBlocks,<sp/><ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref>&amp;<sp/>nodeStaller)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="906"><highlight class="normal"></highlight></codeline>
<codeline lineno="908"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>TryDownloadingHistoricalBlocks(const<sp/>Peer&amp;<sp/>peer,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>count,<sp/>std::vector&lt;const<sp/>CBlockIndex*&gt;&amp;<sp/>vBlocks,<sp/>const<sp/>CBlockIndex*<sp/>from_tip,<sp/>const<sp/>CBlockIndex*<sp/>target_block)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="909"><highlight class="normal"></highlight></codeline>
<codeline lineno="937"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>FindNextBlocks(std::vector&lt;const<sp/>CBlockIndex*&gt;&amp;<sp/>vBlocks,<sp/>const<sp/>Peer&amp;<sp/>peer,<sp/>CNodeState<sp/>*state,<sp/>const<sp/>CBlockIndex<sp/>*pindexWalk,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>count,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nWindowEnd,<sp/>const<sp/>CChain*<sp/>activeChain=</highlight><highlight class="keywordtype">nullptr</highlight><highlight class="normal">,<sp/><ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref>*<sp/>nodeStaller=</highlight><highlight class="keywordtype">nullptr</highlight><highlight class="normal">)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="938"><highlight class="normal"></highlight></codeline>
<codeline lineno="939"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Multimap<sp/>used<sp/>to<sp/>preserve<sp/>insertion<sp/>order<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="940"><highlight class="normal"><sp/><sp/><sp/><sp/>typedef<sp/>std::multimap&lt;uint256,<sp/>std::pair&lt;<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref>,<sp/>std::list&lt;QueuedBlock&gt;::iterator&gt;&gt;<sp/>BlockDownloadMap;</highlight></codeline>
<codeline lineno="941"><highlight class="normal"><sp/><sp/><sp/><sp/>BlockDownloadMap<sp/>mapBlocksInFlight<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="942"><highlight class="normal"></highlight></codeline>
<codeline lineno="944"><highlight class="normal"><sp/><sp/><sp/><sp/>std::atomic&lt;std::chrono::seconds&gt;<sp/>m_last_tip_update{0<ref refid="namespacetest__vectors__musig2__generate_1a5fcf9c70fa717a8efd481752dcb8ffa4" kindref="member">s</ref>};</highlight></codeline>
<codeline lineno="945"><highlight class="normal"></highlight></codeline>
<codeline lineno="947"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref><sp/>FindTxForGetData(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Peer::TxRelay&amp;<sp/>tx_relay,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>GenTxid&amp;<sp/>gtxid)</highlight></codeline>
<codeline lineno="948"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_most_recent_block_mutex,<sp/>!tx_relay.m_tx_inventory_mutex);</highlight></codeline>
<codeline lineno="949"><highlight class="normal"></highlight></codeline>
<codeline lineno="950"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ProcessGetData(CNode&amp;<sp/>pfrom,<sp/>Peer&amp;<sp/>peer,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::atomic&lt;bool&gt;&amp;<sp/>interruptMsgProc)</highlight></codeline>
<codeline lineno="951"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(!m_most_recent_block_mutex,<sp/>peer.m_getdata_requests_mutex,<sp/><ref refid="class_net_events_interface_1a49f0444456d2f1da9c3d2ce68a9bb128" kindref="member">NetEventsInterface::g_msgproc_mutex</ref>)</highlight></codeline>
<codeline lineno="952"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a6bb97382864d0bd2cd4dd5191bb03f6c" kindref="member">LOCKS_EXCLUDED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="953"><highlight class="normal"></highlight></codeline>
<codeline lineno="955"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ProcessBlock(CNode&amp;<sp/>node,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;&amp;<sp/>block,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>force_processing,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>min_pow_checked);</highlight></codeline>
<codeline lineno="956"><highlight class="normal"></highlight></codeline>
<codeline lineno="958"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ProcessCompactBlockTxns(CNode&amp;<sp/>pfrom,<sp/>Peer&amp;<sp/>peer,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BlockTransactions&amp;<sp/>block_transactions)</highlight></codeline>
<codeline lineno="959"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(g_msgproc_mutex,<sp/>!m_most_recent_block_mutex);</highlight></codeline>
<codeline lineno="960"><highlight class="normal"></highlight></codeline>
<codeline lineno="967"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>MaybeSetPeerAsAnnouncingHeaderAndIDs(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>!m_peer_mutex);</highlight></codeline>
<codeline lineno="968"><highlight class="normal"></highlight></codeline>
<codeline lineno="970"><highlight class="normal"><sp/><sp/><sp/><sp/>std::list&lt;NodeId&gt;<sp/>lNodesAnnouncingHeaderAndIDs<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="971"><highlight class="normal"></highlight></codeline>
<codeline lineno="973"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>m_peers_downloading_from<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>)<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="974"><highlight class="normal"></highlight></codeline>
<codeline lineno="975"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>AddToCompactExtraTransactions(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref>&amp;<sp/>tx)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="976"><highlight class="normal"></highlight></codeline>
<codeline lineno="980"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;std::pair&lt;Wtxid,<sp/>CTransactionRef&gt;&gt;<sp/>vExtraTxnForCompact<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="982"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>vExtraTxnForCompactIt<sp/><ref refid="thread__annotations_8h_1a4bc26ad7e8bc853ad3f58a8a343c952e" kindref="member">GUARDED_BY</ref>(g_msgproc_mutex)<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="983"><highlight class="normal"></highlight></codeline>
<codeline lineno="985"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ProcessBlockAvailability(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="987"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>UpdateBlockAvailability(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256&amp;<sp/>hash)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="988"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CanDirectFetch()<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="989"><highlight class="normal"></highlight></codeline>
<codeline lineno="994"><highlight class="normal"><sp/><sp/><sp/><sp/>int64_t<sp/>ApproximateBestBlockDepth()<sp/>const;</highlight></codeline>
<codeline lineno="995"><highlight class="normal"></highlight></codeline>
<codeline lineno="1002"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>BlockRequestAllowed(const<sp/>CBlockIndex*<sp/>pindex)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1003"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>AlreadyHaveBlock(const<sp/>uint256&amp;<sp/>block_hash)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1004"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ProcessGetBlockData(CNode&amp;<sp/>pfrom,<sp/>Peer&amp;<sp/>peer,<sp/>const<sp/>CInv&amp;<sp/>inv)</highlight></codeline>
<codeline lineno="1005"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(g_msgproc_mutex,<sp/>!m_most_recent_block_mutex);</highlight></codeline>
<codeline lineno="1006"><highlight class="normal"></highlight></codeline>
<codeline lineno="1022"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PrepareBlockFilterRequest(CNode&amp;<sp/>node,<sp/>Peer&amp;<sp/>peer,</highlight></codeline>
<codeline lineno="1023"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="blockfilter_8h_1a530bf73ca0d532a142641644a1605250" kindref="member">BlockFilterType</ref><sp/>filter_type,<sp/>uint32_t<sp/>start_height,</highlight></codeline>
<codeline lineno="1024"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>uint256&amp;<sp/>stop_hash,<sp/>uint32_t<sp/>max_height_diff,</highlight></codeline>
<codeline lineno="1025"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>const<sp/>CBlockIndex*&amp;<sp/>stop_index,</highlight></codeline>
<codeline lineno="1026"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BlockFilterIndex*&amp;<sp/>filter_index);</highlight></codeline>
<codeline lineno="1027"><highlight class="normal"></highlight></codeline>
<codeline lineno="1037"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ProcessGetCFilters(CNode&amp;<sp/>node,<sp/>Peer&amp;<sp/>peer,<sp/>DataStream&amp;<sp/>vRecv);</highlight></codeline>
<codeline lineno="1038"><highlight class="normal"></highlight></codeline>
<codeline lineno="1048"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ProcessGetCFHeaders(CNode&amp;<sp/>node,<sp/>Peer&amp;<sp/>peer,<sp/>DataStream&amp;<sp/>vRecv);</highlight></codeline>
<codeline lineno="1049"><highlight class="normal"></highlight></codeline>
<codeline lineno="1059"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>ProcessGetCFCheckPt(CNode&amp;<sp/>node,<sp/>Peer&amp;<sp/>peer,<sp/>DataStream&amp;<sp/>vRecv);</highlight></codeline>
<codeline lineno="1060"><highlight class="normal"></highlight></codeline>
<codeline lineno="1067"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>SetupAddressRelay(const<sp/>CNode&amp;<sp/>node,<sp/>Peer&amp;<sp/>peer)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="1068"><highlight class="normal"></highlight></codeline>
<codeline lineno="1069"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>AddAddressKnown(Peer&amp;<sp/>peer,<sp/>const<sp/>CAddress&amp;<sp/>addr)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="1070"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PushAddress(Peer&amp;<sp/>peer,<sp/>const<sp/>CAddress&amp;<sp/>addr)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="1071"><highlight class="normal"></highlight></codeline>
<codeline lineno="1072"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>LogBlockHeader(const<sp/>CBlockIndex&amp;<sp/>index,<sp/>const<sp/>CNode&amp;<sp/>peer,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>via_compact_block);</highlight></codeline>
<codeline lineno="1073"><highlight class="normal">};</highlight></codeline>
<codeline lineno="1074"><highlight class="normal"></highlight></codeline>
<codeline lineno="1075"><highlight class="normal">const<sp/>CNodeState*<sp/>PeerManagerImpl::<ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>pnode)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="1076"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="1077"><highlight class="normal"><sp/><sp/><sp/><sp/>std::map&lt;NodeId,<sp/>CNodeState&gt;::const_iterator<sp/>it<sp/>=<sp/>m_node_states.find(pnode);</highlight></codeline>
<codeline lineno="1078"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>==<sp/>m_node_states.end())</highlight></codeline>
<codeline lineno="1079"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1080"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>&amp;it-&gt;second;</highlight></codeline>
<codeline lineno="1081"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1082"><highlight class="normal"></highlight></codeline>
<codeline lineno="1083"><highlight class="normal">CNodeState*<sp/>PeerManagerImpl::State(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>pnode)</highlight></codeline>
<codeline lineno="1084"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1085"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const_cast&lt;</highlight><highlight class="normal">CNodeState*</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(std::as_const(*this).State(pnode));</highlight></codeline>
<codeline lineno="1086"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1087"><highlight class="normal"></highlight></codeline>
<codeline lineno="1093"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>IsAddrCompatible(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Peer&amp;<sp/>peer,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CAddress&amp;<sp/>addr)</highlight></codeline>
<codeline lineno="1094"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1095"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>peer.m_wants_addrv2<sp/>||<sp/>addr.<ref refid="class_c_net_addr_1acb53f81684bd84498030193c3d1e9ffb" kindref="member">IsAddrV1Compatible</ref>();</highlight></codeline>
<codeline lineno="1096"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1097"><highlight class="normal"></highlight></codeline>
<codeline lineno="1098"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::AddAddressKnown(Peer&amp;<sp/>peer,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CAddress&amp;<sp/>addr)</highlight></codeline>
<codeline lineno="1099"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1100"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(peer.m_addr_known);</highlight></codeline>
<codeline lineno="1101"><highlight class="normal"><sp/><sp/><sp/><sp/>peer.m_addr_known-&gt;insert(addr.<ref refid="class_c_service_1a2f76cbfe9660cf0325a7498e3c5b6f22" kindref="member">GetKey</ref>());</highlight></codeline>
<codeline lineno="1102"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1103"><highlight class="normal"></highlight></codeline>
<codeline lineno="1104"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::PushAddress(Peer&amp;<sp/>peer,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CAddress&amp;<sp/>addr)</highlight></codeline>
<codeline lineno="1105"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1106"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Known<sp/>checking<sp/>here<sp/>is<sp/>only<sp/>to<sp/>save<sp/>space<sp/>from<sp/>duplicates.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1107"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Before<sp/>sending,<sp/>we&apos;ll<sp/>filter<sp/>it<sp/>again<sp/>for<sp/>known<sp/>addresses<sp/>that<sp/>were</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1108"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>added<sp/>after<sp/>addresses<sp/>were<sp/>pushed.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1109"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(peer.m_addr_known);</highlight></codeline>
<codeline lineno="1110"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(addr.<ref refid="class_c_net_addr_1ac532c4b500b1a85ea22217f2c65a70ed" kindref="member">IsValid</ref>()<sp/>&amp;&amp;<sp/>!peer.m_addr_known-&gt;contains(addr.<ref refid="class_c_service_1a2f76cbfe9660cf0325a7498e3c5b6f22" kindref="member">GetKey</ref>())<sp/>&amp;&amp;<sp/>IsAddrCompatible(peer,<sp/>addr))<sp/>{</highlight></codeline>
<codeline lineno="1111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer.m_addrs_to_send.size()<sp/>&gt;=<sp/>MAX_ADDR_TO_SEND)<sp/>{</highlight></codeline>
<codeline lineno="1112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_addrs_to_send[m_rng.randrange(peer.m_addrs_to_send.size())]<sp/>=<sp/>addr;</highlight></codeline>
<codeline lineno="1113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_addrs_to_send.push_back(addr);</highlight></codeline>
<codeline lineno="1115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1116"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1117"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1118"><highlight class="normal"></highlight></codeline>
<codeline lineno="1119"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>AddKnownTx(Peer&amp;<sp/>peer,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256&amp;<sp/>hash)</highlight></codeline>
<codeline lineno="1120"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1121"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>tx_relay<sp/>=<sp/>peer.GetTxRelay();</highlight></codeline>
<codeline lineno="1122"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tx_relay)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1123"><highlight class="normal"></highlight></codeline>
<codeline lineno="1124"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(tx_relay-&gt;m_tx_inventory_mutex);</highlight></codeline>
<codeline lineno="1125"><highlight class="normal"><sp/><sp/><sp/><sp/>tx_relay-&gt;m_tx_inventory_known_filter.insert(hash);</highlight></codeline>
<codeline lineno="1126"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1127"><highlight class="normal"></highlight></codeline>
<codeline lineno="1129"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CanServeBlocks(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Peer&amp;<sp/>peer)</highlight></codeline>
<codeline lineno="1130"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1131"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>peer.m_their_services<sp/>&amp;<sp/>(<ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a9d1154f0e7e56f183a5c8373abe2e86c" kindref="member">NODE_NETWORK</ref>|<ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a8294ff7e8ff77692c2fb330df0a3c372" kindref="member">NODE_NETWORK_LIMITED</ref>);</highlight></codeline>
<codeline lineno="1132"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1133"><highlight class="normal"></highlight></codeline>
<codeline lineno="1136"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>IsLimitedPeer(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Peer&amp;<sp/>peer)</highlight></codeline>
<codeline lineno="1137"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1138"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(!(peer.m_their_services<sp/>&amp;<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a9d1154f0e7e56f183a5c8373abe2e86c" kindref="member">NODE_NETWORK</ref>)<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="1139"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(peer.m_their_services<sp/>&amp;<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a8294ff7e8ff77692c2fb330df0a3c372" kindref="member">NODE_NETWORK_LIMITED</ref>));</highlight></codeline>
<codeline lineno="1140"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1141"><highlight class="normal"></highlight></codeline>
<codeline lineno="1143"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>CanServeWitnesses(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Peer&amp;<sp/>peer)</highlight></codeline>
<codeline lineno="1144"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1145"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>peer.m_their_services<sp/>&amp;<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a749f25f8cdb0125f7a479627b4944696" kindref="member">NODE_WITNESS</ref>;</highlight></codeline>
<codeline lineno="1146"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1147"><highlight class="normal"></highlight></codeline>
<codeline lineno="1148"><highlight class="normal">std::chrono::microseconds<sp/>PeerManagerImpl::NextInvToInbounds(std::chrono::microseconds<sp/>now,</highlight></codeline>
<codeline lineno="1149"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::chrono::seconds<sp/>average_interval,</highlight></codeline>
<codeline lineno="1150"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>network_key)</highlight></codeline>
<codeline lineno="1151"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1152"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>[it,<sp/>inserted]<sp/>=<sp/>m_next_inv_to_inbounds_per_network_key.try_emplace(network_key,<sp/>0us);</highlight></codeline>
<codeline lineno="1153"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>timer{it-&gt;second};</highlight></codeline>
<codeline lineno="1154"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(timer<sp/>&lt;<sp/>now)<sp/>{</highlight></codeline>
<codeline lineno="1155"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>timer<sp/>=<sp/>now<sp/>+<sp/>m_rng.rand_exp_duration(average_interval);</highlight></codeline>
<codeline lineno="1156"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1157"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>timer;</highlight></codeline>
<codeline lineno="1158"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1159"><highlight class="normal"></highlight></codeline>
<codeline lineno="1160"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::IsBlockRequested(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256&amp;<sp/>hash)</highlight></codeline>
<codeline lineno="1161"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1162"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>mapBlocksInFlight.contains(hash);</highlight></codeline>
<codeline lineno="1163"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1164"><highlight class="normal"></highlight></codeline>
<codeline lineno="1165"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::IsBlockRequestedFromOutbound(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256&amp;<sp/>hash)</highlight></codeline>
<codeline lineno="1166"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1167"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>range<sp/>=<sp/>mapBlocksInFlight.equal_range(hash);<sp/>range.first<sp/>!=<sp/>range.second;<sp/>range.first++)<sp/>{</highlight></codeline>
<codeline lineno="1168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>[nodeid,<sp/>block_it]<sp/>=<sp/>range.first-&gt;second;</highlight></codeline>
<codeline lineno="1169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PeerRef<sp/>peer{GetPeerRef(nodeid)};</highlight></codeline>
<codeline lineno="1170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer<sp/>&amp;&amp;<sp/>!peer-&gt;m_is_inbound)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1171"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1172"><highlight class="normal"></highlight></codeline>
<codeline lineno="1173"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1174"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1175"><highlight class="normal"></highlight></codeline>
<codeline lineno="1176"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::RemoveBlockRequest(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256&amp;<sp/>hash,<sp/>std::optional&lt;NodeId&gt;<sp/>from_peer)</highlight></codeline>
<codeline lineno="1177"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1178"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>range<sp/>=<sp/>mapBlocksInFlight.equal_range(hash);</highlight></codeline>
<codeline lineno="1179"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(range.first<sp/>==<sp/>range.second)<sp/>{</highlight></codeline>
<codeline lineno="1180"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Block<sp/>was<sp/>not<sp/>requested<sp/>from<sp/>any<sp/>peer</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1181"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1182"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1183"><highlight class="normal"></highlight></codeline>
<codeline lineno="1184"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>should<sp/>not<sp/>have<sp/>requested<sp/>too<sp/>many<sp/>of<sp/>this<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1185"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(mapBlocksInFlight.count(hash)<sp/>&lt;=<sp/>MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK);</highlight></codeline>
<codeline lineno="1186"><highlight class="normal"></highlight></codeline>
<codeline lineno="1187"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(range.first<sp/>!=<sp/>range.second)<sp/>{</highlight></codeline>
<codeline lineno="1188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>[node_id,<sp/>list_it]{range.first-&gt;second};</highlight></codeline>
<codeline lineno="1189"><highlight class="normal"></highlight></codeline>
<codeline lineno="1190"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(from_peer<sp/>&amp;&amp;<sp/>*from_peer<sp/>!=<sp/>node_id)<sp/>{</highlight></codeline>
<codeline lineno="1191"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>range.first++;</highlight></codeline>
<codeline lineno="1192"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1193"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1194"><highlight class="normal"></highlight></codeline>
<codeline lineno="1195"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CNodeState&amp;<sp/>state<sp/>=<sp/>*<ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(<ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(node_id));</highlight></codeline>
<codeline lineno="1196"><highlight class="normal"></highlight></codeline>
<codeline lineno="1197"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.vBlocksInFlight.begin()<sp/>==<sp/>list_it)<sp/>{</highlight></codeline>
<codeline lineno="1198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>First<sp/>block<sp/>on<sp/>the<sp/>queue<sp/>was<sp/>received,<sp/>update<sp/>the<sp/>start<sp/>download<sp/>time<sp/>for<sp/>the<sp/>next<sp/>one</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1199"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.m_downloading_since<sp/>=<sp/>std::max(state.m_downloading_since,<sp/><ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime&lt;std::chrono::microseconds&gt;</ref>());</highlight></codeline>
<codeline lineno="1200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1201"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.vBlocksInFlight.erase(list_it);</highlight></codeline>
<codeline lineno="1202"><highlight class="normal"></highlight></codeline>
<codeline lineno="1203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.vBlocksInFlight.empty())<sp/>{</highlight></codeline>
<codeline lineno="1204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Last<sp/>validated<sp/>block<sp/>on<sp/>the<sp/>queue<sp/>for<sp/>this<sp/>peer<sp/>was<sp/>received.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_peers_downloading_from--;</highlight></codeline>
<codeline lineno="1206"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1207"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.m_stalling_since<sp/>=<sp/>0us;</highlight></codeline>
<codeline lineno="1208"><highlight class="normal"></highlight></codeline>
<codeline lineno="1209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>range.first<sp/>=<sp/>mapBlocksInFlight.erase(range.first);</highlight></codeline>
<codeline lineno="1210"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1211"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1212"><highlight class="normal"></highlight></codeline>
<codeline lineno="1213"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::BlockRequested(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex&amp;<sp/>block,<sp/>std::list&lt;QueuedBlock&gt;::iterator**<sp/>pit)</highlight></codeline>
<codeline lineno="1214"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1215"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256&amp;<sp/>hash{block.<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>()};</highlight></codeline>
<codeline lineno="1216"><highlight class="normal"></highlight></codeline>
<codeline lineno="1217"><highlight class="normal"><sp/><sp/><sp/><sp/>CNodeState<sp/>*state<sp/>=<sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(nodeid);</highlight></codeline>
<codeline lineno="1218"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(state<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1219"><highlight class="normal"></highlight></codeline>
<codeline lineno="1220"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(mapBlocksInFlight.count(hash)<sp/>&lt;=<sp/>MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK);</highlight></codeline>
<codeline lineno="1221"><highlight class="normal"></highlight></codeline>
<codeline lineno="1222"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Short-circuit<sp/>most<sp/>stuff<sp/>in<sp/>case<sp/>it<sp/>is<sp/>from<sp/>the<sp/>same<sp/>node</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1223"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>range<sp/>=<sp/>mapBlocksInFlight.equal_range(hash);<sp/>range.first<sp/>!=<sp/>range.second;<sp/>range.first++)<sp/>{</highlight></codeline>
<codeline lineno="1224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(range.first-&gt;second.first<sp/>==<sp/>nodeid)<sp/>{</highlight></codeline>
<codeline lineno="1225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pit)<sp/>{</highlight></codeline>
<codeline lineno="1226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*pit<sp/>=<sp/>&amp;range.first-&gt;second.second;</highlight></codeline>
<codeline lineno="1227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1230"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1231"><highlight class="normal"></highlight></codeline>
<codeline lineno="1232"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Make<sp/>sure<sp/>it&apos;s<sp/>not<sp/>being<sp/>fetched<sp/>already<sp/>from<sp/>same<sp/>peer.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1233"><highlight class="normal"><sp/><sp/><sp/><sp/>RemoveBlockRequest(hash,<sp/>nodeid);</highlight></codeline>
<codeline lineno="1234"><highlight class="normal"></highlight></codeline>
<codeline lineno="1235"><highlight class="normal"><sp/><sp/><sp/><sp/>std::list&lt;QueuedBlock&gt;::iterator<sp/>it<sp/>=<sp/>state-&gt;vBlocksInFlight.insert(state-&gt;vBlocksInFlight.end(),</highlight></codeline>
<codeline lineno="1236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{&amp;block,<sp/>std::unique_ptr&lt;PartiallyDownloadedBlock&gt;(pit<sp/>?<sp/>new<sp/>PartiallyDownloadedBlock(&amp;m_mempool)<sp/>:<sp/>nullptr)});</highlight></codeline>
<codeline lineno="1237"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state-&gt;vBlocksInFlight.size()<sp/>==<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="1238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We&apos;re<sp/>starting<sp/>a<sp/>block<sp/>download<sp/>(batch)<sp/>from<sp/>this<sp/>peer.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state-&gt;m_downloading_since<sp/>=<sp/><ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime&lt;std::chrono::microseconds&gt;</ref>();</highlight></codeline>
<codeline lineno="1240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_peers_downloading_from++;</highlight></codeline>
<codeline lineno="1241"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1242"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>itInFlight<sp/>=<sp/>mapBlocksInFlight.insert(std::make_pair(hash,<sp/>std::make_pair(nodeid,<sp/>it)));</highlight></codeline>
<codeline lineno="1243"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pit)<sp/>{</highlight></codeline>
<codeline lineno="1244"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*pit<sp/>=<sp/>&amp;itInFlight-&gt;second.second;</highlight></codeline>
<codeline lineno="1245"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1246"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1247"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1248"><highlight class="normal"></highlight></codeline>
<codeline lineno="1249"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid)</highlight></codeline>
<codeline lineno="1250"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1251"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1252"><highlight class="normal"></highlight></codeline>
<codeline lineno="1253"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When<sp/>in<sp/>-blocksonly<sp/>mode,<sp/>never<sp/>request<sp/>high-bandwidth<sp/>mode<sp/>from<sp/>peers.<sp/>Our</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1254"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>mempool<sp/>will<sp/>not<sp/>contain<sp/>the<sp/>transactions<sp/>necessary<sp/>to<sp/>reconstruct<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1255"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>compact<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1256"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_opts.ignore_incoming_txs)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1257"><highlight class="normal"></highlight></codeline>
<codeline lineno="1258"><highlight class="normal"><sp/><sp/><sp/><sp/>CNodeState*<sp/>nodestate<sp/>=<sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(nodeid);</highlight></codeline>
<codeline lineno="1259"><highlight class="normal"><sp/><sp/><sp/><sp/>PeerRef<sp/>peer{GetPeerRef(nodeid)};</highlight></codeline>
<codeline lineno="1260"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!nodestate<sp/>||<sp/>!nodestate-&gt;m_provides_cmpctblocks)<sp/>{</highlight></codeline>
<codeline lineno="1261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Don&apos;t<sp/>request<sp/>compact<sp/>blocks<sp/>if<sp/>the<sp/>peer<sp/>has<sp/>not<sp/>signalled<sp/>support</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1262"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1263"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1264"><highlight class="normal"></highlight></codeline>
<codeline lineno="1265"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>num_outbound_hb_peers<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1266"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(std::list&lt;NodeId&gt;::iterator<sp/>it<sp/>=<sp/>lNodesAnnouncingHeaderAndIDs.begin();<sp/>it<sp/>!=<sp/>lNodesAnnouncingHeaderAndIDs.end();<sp/>it++)<sp/>{</highlight></codeline>
<codeline lineno="1267"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(*it<sp/>==<sp/>nodeid)<sp/>{</highlight></codeline>
<codeline lineno="1268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lNodesAnnouncingHeaderAndIDs.erase(it);</highlight></codeline>
<codeline lineno="1269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lNodesAnnouncingHeaderAndIDs.push_back(nodeid);</highlight></codeline>
<codeline lineno="1270"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1271"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PeerRef<sp/>peer_ref{GetPeerRef(*it)};</highlight></codeline>
<codeline lineno="1273"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer_ref<sp/>&amp;&amp;<sp/>!peer_ref-&gt;m_is_inbound)<sp/>++num_outbound_hb_peers;</highlight></codeline>
<codeline lineno="1274"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1275"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer<sp/>&amp;&amp;<sp/>peer-&gt;m_is_inbound)<sp/>{</highlight></codeline>
<codeline lineno="1276"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we&apos;re<sp/>adding<sp/>an<sp/>inbound<sp/>HB<sp/>peer,<sp/>make<sp/>sure<sp/>we&apos;re<sp/>not<sp/>removing</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>our<sp/>last<sp/>outbound<sp/>HB<sp/>peer<sp/>in<sp/>the<sp/>process.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lNodesAnnouncingHeaderAndIDs.size()<sp/>&gt;=<sp/>3<sp/>&amp;&amp;<sp/>num_outbound_hb_peers<sp/>==<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="1279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PeerRef<sp/>remove_peer{GetPeerRef(lNodesAnnouncingHeaderAndIDs.front())};</highlight></codeline>
<codeline lineno="1280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(remove_peer<sp/>&amp;&amp;<sp/>!remove_peer-&gt;m_is_inbound)<sp/>{</highlight></codeline>
<codeline lineno="1281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Put<sp/>the<sp/>HB<sp/>outbound<sp/>peer<sp/>in<sp/>the<sp/>second<sp/>slot,<sp/>so<sp/>that<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>doesn&apos;t<sp/>get<sp/>removed.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1283"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::swap(lNodesAnnouncingHeaderAndIDs.front(),<sp/>*std::next(lNodesAnnouncingHeaderAndIDs.begin()));</highlight></codeline>
<codeline lineno="1284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1286"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1287"><highlight class="normal"><sp/><sp/><sp/><sp/>m_connman.ForNode(nodeid,<sp/>[</highlight><highlight class="keyword">this</highlight><highlight class="normal">](CNode*<sp/>pfrom)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="1289"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(lNodesAnnouncingHeaderAndIDs.size()<sp/>&gt;=<sp/>3)<sp/>{</highlight></codeline>
<codeline lineno="1290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>As<sp/>per<sp/>BIP152,<sp/>we<sp/>only<sp/>get<sp/>3<sp/>of<sp/>our<sp/>peers<sp/>to<sp/>announce</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>blocks<sp/>using<sp/>compact<sp/>encodings.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(),<sp/>[</highlight><highlight class="keyword">this</highlight><highlight class="normal">](CNode*<sp/>pnodeStop){</highlight></codeline>
<codeline lineno="1293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(*pnodeStop,<sp/>NetMsgType::SENDCMPCT,<sp/></highlight><highlight class="comment">/*high_bandwidth=*/</highlight><highlight class="normal">false,<sp/></highlight><highlight class="comment">/*version=*/</highlight><highlight class="normal">CMPCTBLOCKS_VERSION);</highlight></codeline>
<codeline lineno="1294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>save<sp/>BIP152<sp/>bandwidth<sp/>state:<sp/>we<sp/>select<sp/>peer<sp/>to<sp/>be<sp/>low-bandwidth</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pnodeStop-&gt;m_bip152_highbandwidth_to<sp/>=<sp/>false;</highlight></codeline>
<codeline lineno="1296"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>true;</highlight></codeline>
<codeline lineno="1297"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="1298"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lNodesAnnouncingHeaderAndIDs.pop_front();</highlight></codeline>
<codeline lineno="1299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(*pfrom,<sp/><ref refid="namespace_net_msg_type_1ae8d06c3ffaa85c181610c87ed7275b58" kindref="member">NetMsgType::SENDCMPCT</ref>,<sp/></highlight><highlight class="comment">/*high_bandwidth=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">,<sp/></highlight><highlight class="comment">/*version=*/</highlight><highlight class="normal">CMPCTBLOCKS_VERSION);</highlight></codeline>
<codeline lineno="1301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>save<sp/>BIP152<sp/>bandwidth<sp/>state:<sp/>we<sp/>select<sp/>peer<sp/>to<sp/>be<sp/>high-bandwidth</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom-&gt;<ref refid="class_c_node_1ad565e2a61dff2ebdc4a420bb5b972ac7" kindref="member">m_bip152_highbandwidth_to</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>lNodesAnnouncingHeaderAndIDs.push_back(pfrom-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="1304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1305"><highlight class="normal"><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="1306"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1307"><highlight class="normal"></highlight></codeline>
<codeline lineno="1308"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::TipMayBeStale()</highlight></codeline>
<codeline lineno="1309"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1310"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1311"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Consensus::Params&amp;<sp/>consensusParams<sp/>=<sp/>m_chainparams.GetConsensus();</highlight></codeline>
<codeline lineno="1312"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_last_tip_update.load()<sp/>==<sp/>0s)<sp/>{</highlight></codeline>
<codeline lineno="1313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_last_tip_update<sp/>=<sp/><ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime&lt;std::chrono::seconds&gt;</ref>();</highlight></codeline>
<codeline lineno="1314"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1315"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>m_last_tip_update.load()<sp/>&lt;<sp/><ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime&lt;std::chrono::seconds&gt;</ref>()<sp/>-<sp/>std::chrono::seconds{consensusParams.<ref refid="struct_consensus_1_1_params_1a096ffd2f2385b72c7bff4ba651f0bb51" kindref="member">nPowTargetSpacing</ref><sp/>*<sp/>3}<sp/>&amp;&amp;<sp/>mapBlocksInFlight.empty();</highlight></codeline>
<codeline lineno="1316"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1317"><highlight class="normal"></highlight></codeline>
<codeline lineno="1318"><highlight class="normal">int64_t<sp/>PeerManagerImpl::ApproximateBestBlockDepth()</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="1319"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="1320"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(<ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime&lt;std::chrono::seconds&gt;</ref>()<sp/>-<sp/>m_best_block_time.load()).count()<sp/>/<sp/>m_chainparams.GetConsensus().nPowTargetSpacing;</highlight></codeline>
<codeline lineno="1321"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1322"><highlight class="normal"></highlight></codeline>
<codeline lineno="1323"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::CanDirectFetch()</highlight></codeline>
<codeline lineno="1324"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1325"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>m_chainman.ActiveChain().Tip()-&gt;Time()<sp/>&gt;<sp/><ref refid="struct_node_clock_1a1be2fa9903731211253f2e36b5f3b584" kindref="member">NodeClock::now</ref>()<sp/>-<sp/>m_chainparams.GetConsensus().PowTargetSpacing()<sp/>*<sp/>20;</highlight></codeline>
<codeline lineno="1326"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1327"><highlight class="normal"></highlight></codeline>
<codeline lineno="1328"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerHasHeader(CNodeState<sp/>*state,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex<sp/>*pindex)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>)</highlight></codeline>
<codeline lineno="1329"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1330"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state-&gt;pindexBestKnownBlock<sp/>&amp;&amp;<sp/>pindex<sp/>==<sp/>state-&gt;pindexBestKnownBlock-&gt;<ref refid="class_c_block_index_1ac20120d6b64792647a63d216b26e4b53" kindref="member">GetAncestor</ref>(pindex-&gt;nHeight))</highlight></codeline>
<codeline lineno="1331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1332"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state-&gt;pindexBestHeaderSent<sp/>&amp;&amp;<sp/>pindex<sp/>==<sp/>state-&gt;pindexBestHeaderSent-&gt;<ref refid="class_c_block_index_1ac20120d6b64792647a63d216b26e4b53" kindref="member">GetAncestor</ref>(pindex-&gt;nHeight))</highlight></codeline>
<codeline lineno="1333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1334"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1335"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1336"><highlight class="normal"></highlight></codeline>
<codeline lineno="1337"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::ProcessBlockAvailability(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid)<sp/>{</highlight></codeline>
<codeline lineno="1338"><highlight class="normal"><sp/><sp/><sp/><sp/>CNodeState<sp/>*state<sp/>=<sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(nodeid);</highlight></codeline>
<codeline lineno="1339"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(state<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1340"><highlight class="normal"></highlight></codeline>
<codeline lineno="1341"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!state-&gt;hashLastUnknownBlock.<ref refid="classbase__blob_1a067b44b9f2bd293d8a93401655e6476e" kindref="member">IsNull</ref>())<sp/>{</highlight></codeline>
<codeline lineno="1342"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindex<sp/>=<sp/>m_chainman.m_blockman.LookupBlockIndex(state-&gt;hashLastUnknownBlock);</highlight></codeline>
<codeline lineno="1343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex<sp/>&amp;&amp;<sp/>pindex-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state-&gt;pindexBestKnownBlock<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>||<sp/>pindex-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&gt;=<sp/>state-&gt;pindexBestKnownBlock-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state-&gt;pindexBestKnownBlock<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="1346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state-&gt;hashLastUnknownBlock.<ref refid="classbase__blob_1a1919a0a15668b0d05c24918c11a7d286" kindref="member">SetNull</ref>();</highlight></codeline>
<codeline lineno="1348"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1349"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1350"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1351"><highlight class="normal"></highlight></codeline>
<codeline lineno="1352"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::UpdateBlockAvailability(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256<sp/>&amp;hash)<sp/>{</highlight></codeline>
<codeline lineno="1353"><highlight class="normal"><sp/><sp/><sp/><sp/>CNodeState<sp/>*state<sp/>=<sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(nodeid);</highlight></codeline>
<codeline lineno="1354"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(state<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1355"><highlight class="normal"></highlight></codeline>
<codeline lineno="1356"><highlight class="normal"><sp/><sp/><sp/><sp/>ProcessBlockAvailability(nodeid);</highlight></codeline>
<codeline lineno="1357"><highlight class="normal"></highlight></codeline>
<codeline lineno="1358"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindex<sp/>=<sp/>m_chainman.m_blockman.LookupBlockIndex(hash);</highlight></codeline>
<codeline lineno="1359"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex<sp/>&amp;&amp;<sp/>pindex-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="1360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>An<sp/>actually<sp/>better<sp/>block<sp/>was<sp/>announced.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state-&gt;pindexBestKnownBlock<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>||<sp/>pindex-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&gt;=<sp/>state-&gt;pindexBestKnownBlock-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state-&gt;pindexBestKnownBlock<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="1363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1364"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>An<sp/>unknown<sp/>block<sp/>was<sp/>announced;<sp/>just<sp/>assume<sp/>that<sp/>the<sp/>latest<sp/>one<sp/>is<sp/>the<sp/>best<sp/>one.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1366"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state-&gt;hashLastUnknownBlock<sp/>=<sp/>hash;</highlight></codeline>
<codeline lineno="1367"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1368"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1369"><highlight class="normal"></highlight></codeline>
<codeline lineno="1370"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Logic<sp/>for<sp/>calculating<sp/>which<sp/>blocks<sp/>to<sp/>download<sp/>from<sp/>a<sp/>given<sp/>peer,<sp/>given<sp/>our<sp/>current<sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1371"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::FindNextBlocksToDownload(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Peer&amp;<sp/>peer,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>count,<sp/>std::vector&lt;const<sp/>CBlockIndex*&gt;&amp;<sp/>vBlocks,<sp/><ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref>&amp;<sp/>nodeStaller)</highlight></codeline>
<codeline lineno="1372"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1373"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(count<sp/>==<sp/>0)</highlight></codeline>
<codeline lineno="1374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1375"><highlight class="normal"></highlight></codeline>
<codeline lineno="1376"><highlight class="normal"><sp/><sp/><sp/><sp/>vBlocks.reserve(vBlocks.size()<sp/>+<sp/>count);</highlight></codeline>
<codeline lineno="1377"><highlight class="normal"><sp/><sp/><sp/><sp/>CNodeState<sp/>*state<sp/>=<sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(peer.m_id);</highlight></codeline>
<codeline lineno="1378"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(state<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1379"><highlight class="normal"></highlight></codeline>
<codeline lineno="1380"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Make<sp/>sure<sp/>pindexBestKnownBlock<sp/>is<sp/>up<sp/>to<sp/>date,<sp/>we&apos;ll<sp/>need<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1381"><highlight class="normal"><sp/><sp/><sp/><sp/>ProcessBlockAvailability(peer.m_id);</highlight></codeline>
<codeline lineno="1382"><highlight class="normal"></highlight></codeline>
<codeline lineno="1383"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state-&gt;pindexBestKnownBlock<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>||<sp/>state-&gt;pindexBestKnownBlock-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&lt;<sp/>m_chainman.ActiveChain().Tip()-&gt;nChainWork<sp/>||<sp/>state-&gt;pindexBestKnownBlock-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&lt;<sp/>m_chainman.MinimumChainWork())<sp/>{</highlight></codeline>
<codeline lineno="1384"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>peer<sp/>has<sp/>nothing<sp/>interesting.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1385"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1386"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1387"><highlight class="normal"></highlight></codeline>
<codeline lineno="1388"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When<sp/>we<sp/>sync<sp/>with<sp/>AssumeUtxo<sp/>and<sp/>discover<sp/>the<sp/>snapshot<sp/>is<sp/>not<sp/>in<sp/>the<sp/>peer&apos;s<sp/>best<sp/>chain,<sp/>abort:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1389"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>can&apos;t<sp/>reorg<sp/>to<sp/>this<sp/>chain<sp/>due<sp/>to<sp/>missing<sp/>undo<sp/>data<sp/>until<sp/>the<sp/>background<sp/>sync<sp/>has<sp/>finished,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1390"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>so<sp/>downloading<sp/>blocks<sp/>from<sp/>it<sp/>would<sp/>be<sp/>futile.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1391"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>snap_base{m_chainman.CurrentChainstate().SnapshotBase()};</highlight></codeline>
<codeline lineno="1392"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(snap_base<sp/>&amp;&amp;<sp/>state-&gt;pindexBestKnownBlock-&gt;<ref refid="class_c_block_index_1ac20120d6b64792647a63d216b26e4b53" kindref="member">GetAncestor</ref>(snap_base-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>)<sp/>!=<sp/>snap_base)<sp/>{</highlight></codeline>
<codeline lineno="1393"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Not<sp/>downloading<sp/>blocks<sp/>from<sp/>peer=%d,<sp/>which<sp/>doesn&apos;t<sp/>have<sp/>the<sp/>snapshot<sp/>block<sp/>in<sp/>its<sp/>best<sp/>chain.\n&quot;</highlight><highlight class="normal">,<sp/>peer.m_id);</highlight></codeline>
<codeline lineno="1394"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1395"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1396"><highlight class="normal"></highlight></codeline>
<codeline lineno="1397"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Determine<sp/>the<sp/>forking<sp/>point<sp/>between<sp/>the<sp/>peer&apos;s<sp/>chain<sp/>and<sp/>our<sp/>chain:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1398"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>pindexLastCommonBlock<sp/>is<sp/>required<sp/>to<sp/>be<sp/>an<sp/>ancestor<sp/>of<sp/>pindexBestKnownBlock,<sp/>and<sp/>will<sp/>be<sp/>used<sp/>as<sp/>a<sp/>starting<sp/>point.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1399"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>It<sp/>is<sp/>being<sp/>set<sp/>to<sp/>the<sp/>fork<sp/>point<sp/>between<sp/>the<sp/>peer&apos;s<sp/>best<sp/>known<sp/>block<sp/>and<sp/>the<sp/>current<sp/>tip,<sp/>unless<sp/>it<sp/>is<sp/>already<sp/>set<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1400"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>an<sp/>ancestor<sp/>with<sp/>more<sp/>work<sp/>than<sp/>the<sp/>fork<sp/>point.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1401"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>fork_point<sp/>=<sp/><ref refid="chain_8cpp_1add771d649e0005eaf353c1d04626df91" kindref="member">LastCommonAncestor</ref>(state-&gt;pindexBestKnownBlock,<sp/>m_chainman.ActiveTip());</highlight></codeline>
<codeline lineno="1402"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state-&gt;pindexLastCommonBlock<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>||</highlight></codeline>
<codeline lineno="1403"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fork_point-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&gt;<sp/>state-&gt;pindexLastCommonBlock-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>||</highlight></codeline>
<codeline lineno="1404"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state-&gt;pindexBestKnownBlock-&gt;<ref refid="class_c_block_index_1ac20120d6b64792647a63d216b26e4b53" kindref="member">GetAncestor</ref>(state-&gt;pindexLastCommonBlock-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>)<sp/>!=<sp/>state-&gt;pindexLastCommonBlock)<sp/>{</highlight></codeline>
<codeline lineno="1405"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state-&gt;pindexLastCommonBlock<sp/>=<sp/>fork_point;</highlight></codeline>
<codeline lineno="1406"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1407"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state-&gt;pindexLastCommonBlock<sp/>==<sp/>state-&gt;pindexBestKnownBlock)</highlight></codeline>
<codeline lineno="1408"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1409"><highlight class="normal"></highlight></codeline>
<codeline lineno="1410"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex<sp/>*pindexWalk<sp/>=<sp/>state-&gt;pindexLastCommonBlock;</highlight></codeline>
<codeline lineno="1411"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Never<sp/>fetch<sp/>further<sp/>than<sp/>the<sp/>best<sp/>block<sp/>we<sp/>know<sp/>the<sp/>peer<sp/>has,<sp/>or<sp/>more<sp/>than<sp/>BLOCK_DOWNLOAD_WINDOW<sp/>+<sp/>1<sp/>beyond<sp/>the<sp/>last</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1412"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>linked<sp/>block<sp/>we<sp/>have<sp/>in<sp/>common<sp/>with<sp/>this<sp/>peer.<sp/>The<sp/>+1<sp/>is<sp/>so<sp/>we<sp/>can<sp/>detect<sp/>stalling,<sp/>namely<sp/>if<sp/>we<sp/>would<sp/>be<sp/>able<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1413"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>download<sp/>that<sp/>next<sp/>block<sp/>if<sp/>the<sp/>window<sp/>were<sp/>1<sp/>larger.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1414"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nWindowEnd<sp/>=<sp/>state-&gt;pindexLastCommonBlock-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>+<sp/>BLOCK_DOWNLOAD_WINDOW;</highlight></codeline>
<codeline lineno="1415"><highlight class="normal"></highlight></codeline>
<codeline lineno="1416"><highlight class="normal"><sp/><sp/><sp/><sp/>FindNextBlocks(vBlocks,<sp/>peer,<sp/>state,<sp/>pindexWalk,<sp/>count,<sp/>nWindowEnd,<sp/>&amp;m_chainman.ActiveChain(),<sp/>&amp;nodeStaller);</highlight></codeline>
<codeline lineno="1417"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1418"><highlight class="normal"></highlight></codeline>
<codeline lineno="1419"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::TryDownloadingHistoricalBlocks(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Peer&amp;<sp/>peer,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>count,<sp/>std::vector&lt;const<sp/>CBlockIndex*&gt;&amp;<sp/>vBlocks,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex<sp/>*from_tip,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>target_block)</highlight></codeline>
<codeline lineno="1420"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1421"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(from_tip);</highlight></codeline>
<codeline lineno="1422"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(target_block);</highlight></codeline>
<codeline lineno="1423"><highlight class="normal"></highlight></codeline>
<codeline lineno="1424"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vBlocks.size()<sp/>&gt;=<sp/>count)<sp/>{</highlight></codeline>
<codeline lineno="1425"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1426"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1427"><highlight class="normal"></highlight></codeline>
<codeline lineno="1428"><highlight class="normal"><sp/><sp/><sp/><sp/>vBlocks.reserve(count);</highlight></codeline>
<codeline lineno="1429"><highlight class="normal"><sp/><sp/><sp/><sp/>CNodeState<sp/>*state<sp/>=<sp/><ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(<ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(peer.m_id));</highlight></codeline>
<codeline lineno="1430"><highlight class="normal"></highlight></codeline>
<codeline lineno="1431"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state-&gt;pindexBestKnownBlock<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>||<sp/>state-&gt;pindexBestKnownBlock-&gt;<ref refid="class_c_block_index_1ac20120d6b64792647a63d216b26e4b53" kindref="member">GetAncestor</ref>(target_block-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>)<sp/>!=<sp/>target_block)<sp/>{</highlight></codeline>
<codeline lineno="1432"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>peer<sp/>can&apos;t<sp/>provide<sp/>us<sp/>the<sp/>complete<sp/>series<sp/>of<sp/>blocks<sp/>leading<sp/>up<sp/>to<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>assumeutxo<sp/>snapshot<sp/>base.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1434"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1435"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Presumably<sp/>this<sp/>peer&apos;s<sp/>chain<sp/>has<sp/>less<sp/>work<sp/>than<sp/>our<sp/>ActiveChain()&apos;s<sp/>tip,<sp/>or<sp/>else<sp/>we</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1436"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>will<sp/>eventually<sp/>crash<sp/>when<sp/>we<sp/>try<sp/>to<sp/>reorg<sp/>to<sp/>it.<sp/>Let<sp/>other<sp/>logic</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1437"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>deal<sp/>with<sp/>whether<sp/>we<sp/>disconnect<sp/>this<sp/>peer.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1438"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1439"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>TODO<sp/>at<sp/>some<sp/>point<sp/>in<sp/>the<sp/>future,<sp/>we<sp/>might<sp/>choose<sp/>to<sp/>request<sp/>what<sp/>blocks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1440"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>this<sp/>peer<sp/>does<sp/>have<sp/>from<sp/>the<sp/>historical<sp/>chain,<sp/>despite<sp/>it<sp/>not<sp/>having<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1441"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>complete<sp/>history<sp/>beneath<sp/>the<sp/>snapshot<sp/>base.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1442"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1443"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1444"><highlight class="normal"></highlight></codeline>
<codeline lineno="1445"><highlight class="normal"><sp/><sp/><sp/><sp/>FindNextBlocks(vBlocks,<sp/>peer,<sp/>state,<sp/>from_tip,<sp/>count,<sp/>std::min&lt;int&gt;(from_tip-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>+<sp/>BLOCK_DOWNLOAD_WINDOW,<sp/>target_block-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>));</highlight></codeline>
<codeline lineno="1446"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1447"><highlight class="normal"></highlight></codeline>
<codeline lineno="1448"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::FindNextBlocks(std::vector&lt;const<sp/>CBlockIndex*&gt;&amp;<sp/>vBlocks,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Peer&amp;<sp/>peer,<sp/>CNodeState<sp/>*state,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex<sp/>*pindexWalk,<sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>count,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nWindowEnd,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CChain*<sp/>activeChain,<sp/><ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref>*<sp/>nodeStaller)</highlight></codeline>
<codeline lineno="1449"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1450"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;const<sp/>CBlockIndex*&gt;<sp/>vToFetch;</highlight></codeline>
<codeline lineno="1451"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nMaxHeight<sp/>=<sp/>std::min&lt;int&gt;(state-&gt;pindexBestKnownBlock-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>nWindowEnd<sp/>+<sp/>1);</highlight></codeline>
<codeline lineno="1452"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>is_limited_peer<sp/>=<sp/>IsLimitedPeer(peer);</highlight></codeline>
<codeline lineno="1453"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>waitingfor<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="1454"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(pindexWalk-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>&lt;<sp/>nMaxHeight)<sp/>{</highlight></codeline>
<codeline lineno="1455"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Read<sp/>up<sp/>to<sp/>128<sp/>(or<sp/>more,<sp/>if<sp/>more<sp/>blocks<sp/>than<sp/>that<sp/>are<sp/>needed)<sp/>successors<sp/>of<sp/>pindexWalk<sp/>(towards</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1456"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>pindexBestKnownBlock)<sp/>into<sp/>vToFetch.<sp/>We<sp/>fetch<sp/>128,<sp/>because<sp/>CBlockIndex::GetAncestor<sp/>may<sp/>be<sp/>as<sp/>expensive</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1457"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>as<sp/>iterating<sp/>over<sp/>~100<sp/>CBlockIndex*<sp/>entries<sp/>anyway.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1458"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nToFetch<sp/>=<sp/>std::min(nMaxHeight<sp/>-<sp/>pindexWalk-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>std::max&lt;int&gt;(count<sp/>-<sp/>vBlocks.size(),<sp/>128));</highlight></codeline>
<codeline lineno="1459"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vToFetch.resize(nToFetch);</highlight></codeline>
<codeline lineno="1460"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexWalk<sp/>=<sp/>state-&gt;pindexBestKnownBlock-&gt;<ref refid="class_c_block_index_1ac20120d6b64792647a63d216b26e4b53" kindref="member">GetAncestor</ref>(pindexWalk-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>+<sp/>nToFetch);</highlight></codeline>
<codeline lineno="1461"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vToFetch[nToFetch<sp/>-<sp/>1]<sp/>=<sp/>pindexWalk;</highlight></codeline>
<codeline lineno="1462"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>nToFetch<sp/>-<sp/>1;<sp/>i<sp/>&gt;<sp/>0;<sp/>i--)<sp/>{</highlight></codeline>
<codeline lineno="1463"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vToFetch[i<sp/>-<sp/>1]<sp/>=<sp/>vToFetch[i]-&gt;pprev;</highlight></codeline>
<codeline lineno="1464"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1465"><highlight class="normal"></highlight></codeline>
<codeline lineno="1466"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Iterate<sp/>over<sp/>those<sp/>blocks<sp/>in<sp/>vToFetch<sp/>(in<sp/>forward<sp/>direction),<sp/>adding<sp/>the<sp/>ones<sp/>that</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1467"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>are<sp/>not<sp/>yet<sp/>downloaded<sp/>and<sp/>not<sp/>in<sp/>flight<sp/>to<sp/>vBlocks.<sp/>In<sp/>the<sp/>meantime,<sp/>update</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1468"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>pindexLastCommonBlock<sp/>as<sp/>long<sp/>as<sp/>all<sp/>ancestors<sp/>are<sp/>already<sp/>downloaded,<sp/>or<sp/>if<sp/>it&apos;s</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1469"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>already<sp/>part<sp/>of<sp/>our<sp/>chain<sp/>(and<sp/>therefore<sp/>don&apos;t<sp/>need<sp/>it<sp/>even<sp/>if<sp/>pruned).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1470"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindex<sp/>:<sp/>vToFetch)<sp/>{</highlight></codeline>
<codeline lineno="1471"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pindex-&gt;<ref refid="class_c_block_index_1a1b5a636925d1c416b9d59eb0392a7a62" kindref="member">IsValid</ref>(<ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada67f3a88eeb793cc62f427f87ae830573" kindref="member">BLOCK_VALID_TREE</ref>))<sp/>{</highlight></codeline>
<codeline lineno="1472"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>consider<sp/>the<sp/>chain<sp/>that<sp/>this<sp/>peer<sp/>is<sp/>on<sp/>invalid.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1473"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1474"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1475"><highlight class="normal"></highlight></codeline>
<codeline lineno="1476"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!CanServeWitnesses(peer)<sp/>&amp;&amp;<sp/><ref refid="deploymentstatus_8h_1af313e9a747786adc5b5f3fc8e4e1a3fe" kindref="member">DeploymentActiveAt</ref>(*pindex,<sp/>m_chainman,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dbac12a10e827db62556122f2b1a9b0431b" kindref="member">Consensus::DEPLOYMENT_SEGWIT</ref>))<sp/>{</highlight></codeline>
<codeline lineno="1477"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>wouldn&apos;t<sp/>download<sp/>this<sp/>block<sp/>or<sp/>its<sp/>descendants<sp/>from<sp/>this<sp/>peer.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1478"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1479"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1480"><highlight class="normal"></highlight></codeline>
<codeline lineno="1481"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15" kindref="member">BLOCK_HAVE_DATA</ref><sp/>||<sp/>(activeChain<sp/>&amp;&amp;<sp/>activeChain-&gt;<ref refid="class_c_chain_1a78c557b8d1209a61416487a99a7808a9" kindref="member">Contains</ref>(pindex)))<sp/>{</highlight></codeline>
<codeline lineno="1482"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(activeChain<sp/>&amp;&amp;<sp/>pindex-&gt;<ref refid="class_c_block_index_1ae804dd1f9a78669920c2bc21dc7a9812" kindref="member">HaveNumChainTxs</ref>())<sp/>{</highlight></codeline>
<codeline lineno="1483"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state-&gt;pindexLastCommonBlock<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="1484"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1485"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1486"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1487"><highlight class="normal"></highlight></codeline>
<codeline lineno="1488"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Is<sp/>block<sp/>in-flight?</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1489"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(IsBlockRequested(pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>()))<sp/>{</highlight></codeline>
<codeline lineno="1490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(waitingfor<sp/>==<sp/>-1)<sp/>{</highlight></codeline>
<codeline lineno="1491"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>is<sp/>the<sp/>first<sp/>already-in-flight<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>waitingfor<sp/>=<sp/>mapBlocksInFlight.lower_bound(pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>())-&gt;second.first;</highlight></codeline>
<codeline lineno="1493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1495"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1496"><highlight class="normal"></highlight></codeline>
<codeline lineno="1497"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>block<sp/>is<sp/>not<sp/>already<sp/>downloaded,<sp/>and<sp/>not<sp/>yet<sp/>in<sp/>flight.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>&gt;<sp/>nWindowEnd)<sp/>{</highlight></codeline>
<codeline lineno="1499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>reached<sp/>the<sp/>end<sp/>of<sp/>the<sp/>window.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vBlocks.size()<sp/>==<sp/>0<sp/>&amp;&amp;<sp/>waitingfor<sp/>!=<sp/>peer.m_id)<sp/>{</highlight></codeline>
<codeline lineno="1501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>aren&apos;t<sp/>able<sp/>to<sp/>fetch<sp/>anything,<sp/>but<sp/>we<sp/>would<sp/>be<sp/>if<sp/>the<sp/>download<sp/>window<sp/>was<sp/>one<sp/>larger.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nodeStaller)<sp/>*nodeStaller<sp/>=<sp/>waitingfor;</highlight></codeline>
<codeline lineno="1503"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1504"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1506"><highlight class="normal"></highlight></codeline>
<codeline lineno="1507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Don&apos;t<sp/>request<sp/>blocks<sp/>that<sp/>go<sp/>further<sp/>than<sp/>what<sp/>limited<sp/>peers<sp/>can<sp/>provide</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1508"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(is_limited_peer<sp/>&amp;&amp;<sp/>(state-&gt;pindexBestKnownBlock-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>-<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>&gt;=<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">int</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(NODE_NETWORK_LIMITED_MIN_BLOCKS)<sp/>-<sp/>2<sp/></highlight><highlight class="comment">/*<sp/>two<sp/>blocks<sp/>buffer<sp/>for<sp/>possible<sp/>races<sp/>*/</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="1509"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1511"><highlight class="normal"></highlight></codeline>
<codeline lineno="1512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vBlocks.push_back(pindex);</highlight></codeline>
<codeline lineno="1513"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vBlocks.size()<sp/>==<sp/>count)<sp/>{</highlight></codeline>
<codeline lineno="1514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1515"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1516"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1517"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1518"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1519"><highlight class="normal"></highlight></codeline>
<codeline lineno="1520"><highlight class="normal">}<sp/></highlight><highlight class="comment">//<sp/>namespace</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1521"><highlight class="normal"></highlight></codeline>
<codeline lineno="1522"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::PushNodeVersion(<ref refid="class_c_node" kindref="compound">CNode</ref>&amp;<sp/>pnode,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Peer&amp;<sp/>peer)</highlight></codeline>
<codeline lineno="1523"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1524"><highlight class="normal"><sp/><sp/><sp/><sp/>uint64_t<sp/>my_services{peer.m_our_services};</highlight></codeline>
<codeline lineno="1525"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>int64_t<sp/>nTime{<ref refid="util_2time_8h_1a888f421c54ec4d38a01dd0f7ddacd6a6" kindref="member">count_seconds</ref>(<ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime&lt;std::chrono::seconds&gt;</ref>())};</highlight></codeline>
<codeline lineno="1526"><highlight class="normal"><sp/><sp/><sp/><sp/>uint64_t<sp/><ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref><sp/>=<sp/>pnode.<ref refid="class_c_node_1a814aea882a96b7a7422c2170bee869a1" kindref="member">GetLocalNonce</ref>();</highlight></codeline>
<codeline lineno="1527"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nNodeStartingHeight{m_best_height};</highlight></codeline>
<codeline lineno="1528"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid<sp/>=<sp/>pnode.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>();</highlight></codeline>
<codeline lineno="1529"><highlight class="normal"><sp/><sp/><sp/><sp/>CAddress<sp/>addr<sp/>=<sp/>pnode.<ref refid="class_c_node_1afefbbc75aa05390712188a0f1e13d6f5" kindref="member">addr</ref>;</highlight></codeline>
<codeline lineno="1530"><highlight class="normal"></highlight></codeline>
<codeline lineno="1531"><highlight class="normal"><sp/><sp/><sp/><sp/>CService<sp/>addr_you<sp/>=<sp/>addr.<ref refid="class_c_net_addr_1a060c294e63468f8536252f5a48345e54" kindref="member">IsRoutable</ref>()<sp/>&amp;&amp;<sp/>!<ref refid="netbase_8cpp_1aef250c1632d217d8f3b752ddeacc0368" kindref="member">IsProxy</ref>(addr)<sp/>&amp;&amp;<sp/>addr.<ref refid="class_c_net_addr_1acb53f81684bd84498030193c3d1e9ffb" kindref="member">IsAddrV1Compatible</ref>()<sp/>?<sp/>addr<sp/>:<sp/>CService();</highlight></codeline>
<codeline lineno="1532"><highlight class="normal"><sp/><sp/><sp/><sp/>uint64_t<sp/>your_services{addr.<ref refid="class_c_address_1a45a80242c5f6e9d562cfc8b3604ec428" kindref="member">nServices</ref>};</highlight></codeline>
<codeline lineno="1533"><highlight class="normal"></highlight></codeline>
<codeline lineno="1534"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>tx_relay{!RejectIncomingTxs(pnode)};</highlight></codeline>
<codeline lineno="1535"><highlight class="normal"><sp/><sp/><sp/><sp/>MakeAndPushMessage(pnode,<sp/><ref refid="namespace_net_msg_type_1a35aceb690e11a3d78331de7dda9563ae" kindref="member">NetMsgType::VERSION</ref>,<sp/>PROTOCOL_VERSION,<sp/>my_services,<sp/>nTime,</highlight></codeline>
<codeline lineno="1536"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>your_services,<sp/><ref refid="class_c_net_addr_1a9c9a92b90fc38b4bf84776615f6fd22c" kindref="member">CNetAddr::V1</ref>(addr_you),<sp/></highlight><highlight class="comment">//<sp/>Together<sp/>the<sp/>pre-version-31402<sp/>serialization<sp/>of<sp/>CAddress<sp/>&quot;addrYou&quot;<sp/>(without<sp/>nTime)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1537"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>my_services,<sp/><ref refid="class_c_net_addr_1a9c9a92b90fc38b4bf84776615f6fd22c" kindref="member">CNetAddr::V1</ref>(CService{}),<sp/></highlight><highlight class="comment">//<sp/>Together<sp/>the<sp/>pre-version-31402<sp/>serialization<sp/>of<sp/>CAddress<sp/>&quot;addrMe&quot;<sp/>(without<sp/>nTime)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1538"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref>,<sp/><ref refid="net_8cpp_1a6c58f8ccc4c93105a44caf588562d609" kindref="member">strSubVersion</ref>,<sp/>nNodeStartingHeight,<sp/>tx_relay);</highlight></codeline>
<codeline lineno="1539"><highlight class="normal"></highlight></codeline>
<codeline lineno="1540"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1541"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;send<sp/>version<sp/>message:<sp/>version<sp/>%d,<sp/>blocks=%d,<sp/>them=%s,<sp/>txrelay=%d,<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>PROTOCOL_VERSION,<sp/>nNodeStartingHeight,<sp/>addr_you.<ref refid="class_c_service_1aac5ca8b51c9b88aab6790964f43b0684" kindref="member">ToStringAddrPort</ref>(),<sp/>tx_relay,<sp/>nodeid);</highlight></codeline>
<codeline lineno="1542"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1543"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;send<sp/>version<sp/>message:<sp/>version<sp/>%d,<sp/>blocks=%d,<sp/>txrelay=%d,<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>PROTOCOL_VERSION,<sp/>nNodeStartingHeight,<sp/>tx_relay,<sp/>nodeid);</highlight></codeline>
<codeline lineno="1544"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1545"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1546"><highlight class="normal"></highlight></codeline>
<codeline lineno="1547"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::UpdateLastBlockAnnounceTime(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>node,<sp/>int64_t<sp/>time_in_seconds)</highlight></codeline>
<codeline lineno="1548"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1549"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1550"><highlight class="normal"><sp/><sp/><sp/><sp/>CNodeState<sp/>*state<sp/>=<sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(node);</highlight></codeline>
<codeline lineno="1551"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state)<sp/>state-&gt;m_last_block_announcement<sp/>=<sp/>time_in_seconds;</highlight></codeline>
<codeline lineno="1552"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1553"><highlight class="normal"></highlight></codeline>
<codeline lineno="1554"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::InitializeNode(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CNode&amp;<sp/>node,<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537" kindref="member">ServiceFlags</ref><sp/>our_services)</highlight></codeline>
<codeline lineno="1555"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1556"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid<sp/>=<sp/>node.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>();</highlight></codeline>
<codeline lineno="1557"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="1558"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);<sp/></highlight><highlight class="comment">//<sp/>For<sp/>m_node_states</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1559"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_node_states.try_emplace(m_node_states.end(),<sp/>nodeid);</highlight></codeline>
<codeline lineno="1560"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1561"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(m_tx_download_mutex,<sp/>m_txdownloadman.CheckIsEmpty(nodeid));</highlight></codeline>
<codeline lineno="1562"><highlight class="normal"></highlight></codeline>
<codeline lineno="1563"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="class_net_permissions_1a1c5670aab4ba06b8394ea3d45cb00df2" kindref="member">NetPermissions::HasFlag</ref>(node.<ref refid="class_c_node_1a5e93871fb547b234ab35a0572c7a4fc9" kindref="member">m_permission_flags</ref>,<sp/><ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0afda65e2992afb15a934f2c91611953dc" kindref="member">NetPermissionFlags::BloomFilter</ref>))<sp/>{</highlight></codeline>
<codeline lineno="1564"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>our_services<sp/>=<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="normal"><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537" kindref="member">ServiceFlags</ref></highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(our_services<sp/>|<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a9ca74e44e29a412c070750bdbf2380bb" kindref="member">NODE_BLOOM</ref>);</highlight></codeline>
<codeline lineno="1565"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1566"><highlight class="normal"></highlight></codeline>
<codeline lineno="1567"><highlight class="normal"><sp/><sp/><sp/><sp/>PeerRef<sp/>peer<sp/>=<sp/>std::make_shared&lt;Peer&gt;(nodeid,<sp/>our_services,<sp/>node.<ref refid="class_c_node_1a878e09eabda286e4cabf6ffc0fb24ba3" kindref="member">IsInboundConn</ref>());</highlight></codeline>
<codeline lineno="1568"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="1569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_peer_mutex);</highlight></codeline>
<codeline lineno="1570"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_peer_map.emplace_hint(m_peer_map.end(),<sp/>nodeid,<sp/>peer);</highlight></codeline>
<codeline lineno="1571"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1572"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1573"><highlight class="normal"></highlight></codeline>
<codeline lineno="1574"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::ReattemptInitialBroadcast(CScheduler&amp;<sp/>scheduler)</highlight></codeline>
<codeline lineno="1575"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1576"><highlight class="normal"><sp/><sp/><sp/><sp/>std::set&lt;Txid&gt;<sp/>unbroadcast_txids<sp/>=<sp/>m_mempool.<ref refid="class_c_tx_mem_pool_1ac2b86aa51025367f16bff990e7c5a1d8" kindref="member">GetUnbroadcastTxs</ref>();</highlight></codeline>
<codeline lineno="1577"><highlight class="normal"></highlight></codeline>
<codeline lineno="1578"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>txid<sp/>:<sp/>unbroadcast_txids)<sp/>{</highlight></codeline>
<codeline lineno="1579"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref><sp/>tx<sp/>=<sp/>m_mempool.<ref refid="class_c_tx_mem_pool_1add969118b972f73b902bdf73dd5912f4" kindref="member">get</ref>(txid);</highlight></codeline>
<codeline lineno="1580"><highlight class="normal"></highlight></codeline>
<codeline lineno="1581"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tx<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="1582"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RelayTransaction(txid,<sp/>tx-&gt;GetWitnessHash());</highlight></codeline>
<codeline lineno="1583"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1584"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_mempool.<ref refid="class_c_tx_mem_pool_1a7252105274f9b0e060438692de785a8c" kindref="member">RemoveUnbroadcastTx</ref>(txid,<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1585"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1586"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1587"><highlight class="normal"></highlight></codeline>
<codeline lineno="1588"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Schedule<sp/>next<sp/>run<sp/>for<sp/>10-15<sp/>minutes<sp/>in<sp/>the<sp/>future.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1589"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>add<sp/>randomness<sp/>on<sp/>every<sp/>cycle<sp/>to<sp/>avoid<sp/>the<sp/>possibility<sp/>of<sp/>P2P<sp/>fingerprinting.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1590"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>delta<sp/>=<sp/>10min<sp/>+<sp/>FastRandomContext().randrange&lt;std::chrono::milliseconds&gt;(5min);</highlight></codeline>
<codeline lineno="1591"><highlight class="normal"><sp/><sp/><sp/><sp/>scheduler.<ref refid="class_c_scheduler_1afdb52271200f958fa88b14b94546bb20" kindref="member">scheduleFromNow</ref>([&amp;]<sp/>{<sp/>ReattemptInitialBroadcast(scheduler);<sp/>},<sp/>delta);</highlight></codeline>
<codeline lineno="1592"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1593"><highlight class="normal"></highlight></codeline>
<codeline lineno="1594"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::FinalizeNode(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CNode&amp;<sp/>node)</highlight></codeline>
<codeline lineno="1595"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1596"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid<sp/>=<sp/>node.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>();</highlight></codeline>
<codeline lineno="1597"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="1598"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1599"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="1600"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>remove<sp/>the<sp/>PeerRef<sp/>from<sp/>g_peer_map<sp/>here,<sp/>but<sp/>we<sp/>don&apos;t<sp/>always</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1601"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>destruct<sp/>the<sp/>Peer.<sp/>Sometimes<sp/>another<sp/>thread<sp/>is<sp/>still<sp/>holding<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1602"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>PeerRef,<sp/>so<sp/>the<sp/>refcount<sp/>is<sp/>&gt;=<sp/>1.<sp/>Be<sp/>careful<sp/>not<sp/>to<sp/>do<sp/>any</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1603"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>processing<sp/>here<sp/>that<sp/>assumes<sp/>Peer<sp/>won&apos;t<sp/>be<sp/>changed<sp/>before<sp/>it&apos;s</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1604"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>destructed.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1605"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PeerRef<sp/>peer<sp/>=<sp/>RemovePeer(nodeid);</highlight></codeline>
<codeline lineno="1606"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(peer<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1607"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_wtxid_relay_peers<sp/>-=<sp/>peer-&gt;m_wtxid_relay;</highlight></codeline>
<codeline lineno="1608"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(m_wtxid_relay_peers<sp/>&gt;=<sp/>0);</highlight></codeline>
<codeline lineno="1609"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1610"><highlight class="normal"><sp/><sp/><sp/><sp/>CNodeState<sp/>*state<sp/>=<sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(nodeid);</highlight></codeline>
<codeline lineno="1611"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(state<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1612"><highlight class="normal"></highlight></codeline>
<codeline lineno="1613"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state-&gt;fSyncStarted)</highlight></codeline>
<codeline lineno="1614"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nSyncStarted--;</highlight></codeline>
<codeline lineno="1615"><highlight class="normal"></highlight></codeline>
<codeline lineno="1616"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>QueuedBlock&amp;<sp/>entry<sp/>:<sp/>state-&gt;vBlocksInFlight)<sp/>{</highlight></codeline>
<codeline lineno="1617"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>range<sp/>=<sp/>mapBlocksInFlight.equal_range(entry.pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>());</highlight></codeline>
<codeline lineno="1618"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(range.first<sp/>!=<sp/>range.second)<sp/>{</highlight></codeline>
<codeline lineno="1619"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>[node_id,<sp/>list_it]<sp/>=<sp/>range.first-&gt;second;</highlight></codeline>
<codeline lineno="1620"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(node_id<sp/>!=<sp/>nodeid)<sp/>{</highlight></codeline>
<codeline lineno="1621"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>range.first++;</highlight></codeline>
<codeline lineno="1622"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1623"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>range.first<sp/>=<sp/>mapBlocksInFlight.erase(range.first);</highlight></codeline>
<codeline lineno="1624"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1625"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1626"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1627"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="1628"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_tx_download_mutex);</highlight></codeline>
<codeline lineno="1629"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_txdownloadman.DisconnectedPeer(nodeid);</highlight></codeline>
<codeline lineno="1630"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1631"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_txreconciliation)<sp/>m_txreconciliation-&gt;ForgetPeer(nodeid);</highlight></codeline>
<codeline lineno="1632"><highlight class="normal"><sp/><sp/><sp/><sp/>m_num_preferred_download_peers<sp/>-=<sp/>state-&gt;fPreferredDownload;</highlight></codeline>
<codeline lineno="1633"><highlight class="normal"><sp/><sp/><sp/><sp/>m_peers_downloading_from<sp/>-=<sp/>(!state-&gt;vBlocksInFlight.empty());</highlight></codeline>
<codeline lineno="1634"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(m_peers_downloading_from<sp/>&gt;=<sp/>0);</highlight></codeline>
<codeline lineno="1635"><highlight class="normal"><sp/><sp/><sp/><sp/>m_outbound_peers_with_protect_from_disconnect<sp/>-=<sp/>state-&gt;m_chain_sync.m_protect;</highlight></codeline>
<codeline lineno="1636"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(m_outbound_peers_with_protect_from_disconnect<sp/>&gt;=<sp/>0);</highlight></codeline>
<codeline lineno="1637"><highlight class="normal"></highlight></codeline>
<codeline lineno="1638"><highlight class="normal"><sp/><sp/><sp/><sp/>m_node_states.erase(nodeid);</highlight></codeline>
<codeline lineno="1639"><highlight class="normal"></highlight></codeline>
<codeline lineno="1640"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_node_states.empty())<sp/>{</highlight></codeline>
<codeline lineno="1641"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Do<sp/>a<sp/>consistency<sp/>check<sp/>after<sp/>the<sp/>last<sp/>peer<sp/>is<sp/>removed.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1642"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(mapBlocksInFlight.empty());</highlight></codeline>
<codeline lineno="1643"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(m_num_preferred_download_peers<sp/>==<sp/>0);</highlight></codeline>
<codeline lineno="1644"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(m_peers_downloading_from<sp/>==<sp/>0);</highlight></codeline>
<codeline lineno="1645"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(m_outbound_peers_with_protect_from_disconnect<sp/>==<sp/>0);</highlight></codeline>
<codeline lineno="1646"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(m_wtxid_relay_peers<sp/>==<sp/>0);</highlight></codeline>
<codeline lineno="1647"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(m_tx_download_mutex,<sp/>m_txdownloadman.CheckIsEmpty());</highlight></codeline>
<codeline lineno="1648"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1649"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>cs_main</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1650"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(node.<ref refid="class_c_node_1a304b58083dbf991d0f448962530c2e94" kindref="member">fSuccessfullyConnected</ref><sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="1651"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!node.<ref refid="class_c_node_1a610ec1d1f02cc4bb029acc3cf47b9f4c" kindref="member">IsBlockOnlyConn</ref>()<sp/>&amp;&amp;<sp/>!node.<ref refid="class_c_node_1a878e09eabda286e4cabf6ffc0fb24ba3" kindref="member">IsInboundConn</ref>())<sp/>{</highlight></codeline>
<codeline lineno="1652"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>change<sp/>visible<sp/>addrman<sp/>state<sp/>for<sp/>full<sp/>outbound<sp/>peers.<sp/><sp/>We<sp/>don&apos;t</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1653"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>call<sp/>Connected()<sp/>for<sp/>feeler<sp/>connections<sp/>since<sp/>they<sp/>don&apos;t<sp/>have</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1654"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>fSuccessfullyConnected<sp/>set.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1655"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_addrman.<ref refid="class_addr_man_1a5db77c65bd764c01b128936f2dcca9ef" kindref="member">Connected</ref>(node.<ref refid="class_c_node_1afefbbc75aa05390712188a0f1e13d6f5" kindref="member">addr</ref>);</highlight></codeline>
<codeline lineno="1656"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1657"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="1658"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_headers_presync_mutex);</highlight></codeline>
<codeline lineno="1659"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_headers_presync_stats.erase(nodeid);</highlight></codeline>
<codeline lineno="1660"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1661"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Cleared<sp/>nodestate<sp/>for<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>nodeid);</highlight></codeline>
<codeline lineno="1662"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1663"><highlight class="normal"></highlight></codeline>
<codeline lineno="1664"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::HasAllDesirableServiceFlags(<ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537" kindref="member">ServiceFlags</ref><sp/>services)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="1665"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="1666"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Shortcut<sp/>for<sp/>(services<sp/>&amp;<sp/>GetDesirableServiceFlags(services))<sp/>==<sp/>GetDesirableServiceFlags(services)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1667"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>!(GetDesirableServiceFlags(services)<sp/>&amp;<sp/>(~services));</highlight></codeline>
<codeline lineno="1668"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1669"><highlight class="normal"></highlight></codeline>
<codeline lineno="1670"><highlight class="normal"><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537" kindref="member">ServiceFlags</ref><sp/>PeerManagerImpl::GetDesirableServiceFlags(<ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537" kindref="member">ServiceFlags</ref><sp/>services)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="1671"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="1672"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(services<sp/>&amp;<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a8294ff7e8ff77692c2fb330df0a3c372" kindref="member">NODE_NETWORK_LIMITED</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1673"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Limited<sp/>peers<sp/>are<sp/>desirable<sp/>when<sp/>we<sp/>are<sp/>close<sp/>to<sp/>the<sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1674"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ApproximateBestBlockDepth()<sp/>&lt;<sp/>NODE_NETWORK_LIMITED_ALLOW_CONN_BLOCKS)<sp/>{</highlight></codeline>
<codeline lineno="1675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537" kindref="member">ServiceFlags</ref>(<ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a8294ff7e8ff77692c2fb330df0a3c372" kindref="member">NODE_NETWORK_LIMITED</ref><sp/>|<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a749f25f8cdb0125f7a479627b4944696" kindref="member">NODE_WITNESS</ref>);</highlight></codeline>
<codeline lineno="1676"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1677"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1678"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537" kindref="member">ServiceFlags</ref>(<ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a9d1154f0e7e56f183a5c8373abe2e86c" kindref="member">NODE_NETWORK</ref><sp/>|<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a749f25f8cdb0125f7a479627b4944696" kindref="member">NODE_WITNESS</ref>);</highlight></codeline>
<codeline lineno="1679"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1680"><highlight class="normal"></highlight></codeline>
<codeline lineno="1681"><highlight class="normal">PeerRef<sp/>PeerManagerImpl::GetPeerRef(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal">)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="1682"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="1683"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_peer_mutex);</highlight></codeline>
<codeline lineno="1684"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it<sp/>=<sp/>m_peer_map.find(</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1685"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>it<sp/>!=<sp/>m_peer_map.end()<sp/>?<sp/>it-&gt;second<sp/>:<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1686"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1687"><highlight class="normal"></highlight></codeline>
<codeline lineno="1688"><highlight class="normal">PeerRef<sp/>PeerManagerImpl::RemovePeer(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="1689"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1690"><highlight class="normal"><sp/><sp/><sp/><sp/>PeerRef<sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>;</highlight></codeline>
<codeline lineno="1691"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_peer_mutex);</highlight></codeline>
<codeline lineno="1692"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it<sp/>=<sp/>m_peer_map.find(</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1693"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>!=<sp/>m_peer_map.end())<sp/>{</highlight></codeline>
<codeline lineno="1694"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref><sp/>=<sp/>std::move(it-&gt;second);</highlight></codeline>
<codeline lineno="1695"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_peer_map.erase(it);</highlight></codeline>
<codeline lineno="1696"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1697"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>;</highlight></codeline>
<codeline lineno="1698"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1699"><highlight class="normal"></highlight></codeline>
<codeline lineno="1700"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::GetNodeStateStats(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid,<sp/>CNodeStateStats&amp;<sp/>stats)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="1701"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="1702"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="1703"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1704"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CNodeState*<sp/>state<sp/>=<sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(nodeid);</highlight></codeline>
<codeline lineno="1705"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="1706"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1707"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats.<ref refid="struct_c_node_state_stats_1ae813f246a8584559d7e45d063a7f26c6" kindref="member">nSyncHeight</ref><sp/>=<sp/>state-&gt;pindexBestKnownBlock<sp/>?<sp/>state-&gt;pindexBestKnownBlock-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>:<sp/>-1;</highlight></codeline>
<codeline lineno="1708"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats.<ref refid="struct_c_node_state_stats_1ad2b8002be272028cd38a5b71ec4236d2" kindref="member">nCommonHeight</ref><sp/>=<sp/>state-&gt;pindexLastCommonBlock<sp/>?<sp/>state-&gt;pindexLastCommonBlock-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>:<sp/>-1;</highlight></codeline>
<codeline lineno="1709"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>QueuedBlock&amp;<sp/>queue<sp/>:<sp/>state-&gt;vBlocksInFlight)<sp/>{</highlight></codeline>
<codeline lineno="1710"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(queue.pindex)</highlight></codeline>
<codeline lineno="1711"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats.<ref refid="struct_c_node_state_stats_1a7c9a4be52bfef68b90515cb4e853f1eb" kindref="member">vHeightInFlight</ref>.push_back(queue.pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>);</highlight></codeline>
<codeline lineno="1712"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1713"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1714"><highlight class="normal"></highlight></codeline>
<codeline lineno="1715"><highlight class="normal"><sp/><sp/><sp/><sp/>PeerRef<sp/>peer<sp/>=<sp/>GetPeerRef(nodeid);</highlight></codeline>
<codeline lineno="1716"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1717"><highlight class="normal"><sp/><sp/><sp/><sp/>stats.<ref refid="struct_c_node_state_stats_1aab30e828629a88d39006001deb50b72e" kindref="member">their_services</ref><sp/>=<sp/>peer-&gt;m_their_services;</highlight></codeline>
<codeline lineno="1718"><highlight class="normal"><sp/><sp/><sp/><sp/>stats.<ref refid="struct_c_node_state_stats_1ac33689c42e84887b0b484f85531f32c6" kindref="member">m_starting_height</ref><sp/>=<sp/>peer-&gt;m_starting_height;</highlight></codeline>
<codeline lineno="1719"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>It<sp/>is<sp/>common<sp/>for<sp/>nodes<sp/>with<sp/>good<sp/>ping<sp/>times<sp/>to<sp/>suddenly<sp/>become<sp/>lagged,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1720"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>due<sp/>to<sp/>a<sp/>new<sp/>block<sp/>arriving<sp/>or<sp/>other<sp/>large<sp/>transfer.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1721"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Merely<sp/>reporting<sp/>pingtime<sp/>might<sp/>fool<sp/>the<sp/>caller<sp/>into<sp/>thinking<sp/>the<sp/>node<sp/>was<sp/>still<sp/>responsive,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1722"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>since<sp/>pingtime<sp/>does<sp/>not<sp/>update<sp/>until<sp/>the<sp/>ping<sp/>is<sp/>complete,<sp/>which<sp/>might<sp/>take<sp/>a<sp/>while.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1723"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>So,<sp/>if<sp/>a<sp/>ping<sp/>is<sp/>taking<sp/>an<sp/>unusually<sp/>long<sp/>time<sp/>in<sp/>flight,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1724"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>caller<sp/>can<sp/>immediately<sp/>detect<sp/>that<sp/>this<sp/>is<sp/>happening.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1725"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>ping_wait{0us};</highlight></codeline>
<codeline lineno="1726"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((0<sp/>!=<sp/>peer-&gt;m_ping_nonce_sent)<sp/>&amp;&amp;<sp/>(0<sp/>!=<sp/>peer-&gt;m_ping_start.load().count()))<sp/>{</highlight></codeline>
<codeline lineno="1727"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ping_wait<sp/>=<sp/><ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime&lt;std::chrono::microseconds&gt;</ref>()<sp/>-<sp/>peer-&gt;m_ping_start.load();</highlight></codeline>
<codeline lineno="1728"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1729"><highlight class="normal"></highlight></codeline>
<codeline lineno="1730"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>tx_relay<sp/>=<sp/>peer-&gt;GetTxRelay();<sp/>tx_relay<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="1731"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats.<ref refid="struct_c_node_state_stats_1a7543e00102377ff2f261b4b2451fb6f6" kindref="member">m_relay_txs</ref><sp/>=<sp/><ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(tx_relay-&gt;m_bloom_filter_mutex,<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>tx_relay-&gt;m_relay_txs);</highlight></codeline>
<codeline lineno="1732"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats.<ref refid="struct_c_node_state_stats_1ab278bdaedda4111f6764977aaa88f0f9" kindref="member">m_fee_filter_received</ref><sp/>=<sp/>tx_relay-&gt;m_fee_filter_received.load();</highlight></codeline>
<codeline lineno="1733"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(tx_relay-&gt;m_tx_inventory_mutex);</highlight></codeline>
<codeline lineno="1734"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats.<ref refid="struct_c_node_state_stats_1ab16940707521df8b744c16826458b9ab" kindref="member">m_last_inv_seq</ref><sp/>=<sp/>tx_relay-&gt;m_last_inv_sequence;</highlight></codeline>
<codeline lineno="1735"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats.<ref refid="struct_c_node_state_stats_1a6a0fd5c1e95de08bab390014f6e8af69" kindref="member">m_inv_to_send</ref><sp/>=<sp/>tx_relay-&gt;m_tx_inventory_to_send.size();</highlight></codeline>
<codeline lineno="1736"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="1737"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats.<ref refid="struct_c_node_state_stats_1a7543e00102377ff2f261b4b2451fb6f6" kindref="member">m_relay_txs</ref><sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1738"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats.<ref refid="struct_c_node_state_stats_1ab278bdaedda4111f6764977aaa88f0f9" kindref="member">m_fee_filter_received</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1739"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats.<ref refid="struct_c_node_state_stats_1a6a0fd5c1e95de08bab390014f6e8af69" kindref="member">m_inv_to_send</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="1740"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1741"><highlight class="normal"></highlight></codeline>
<codeline lineno="1742"><highlight class="normal"><sp/><sp/><sp/><sp/>stats.<ref refid="struct_c_node_state_stats_1a683bfde9d62b0f59f399c621c12ce22c" kindref="member">m_ping_wait</ref><sp/>=<sp/>ping_wait;</highlight></codeline>
<codeline lineno="1743"><highlight class="normal"><sp/><sp/><sp/><sp/>stats.<ref refid="struct_c_node_state_stats_1a720b8e7a6e04ac8a650cf89fbb6bebc4" kindref="member">m_addr_processed</ref><sp/>=<sp/>peer-&gt;m_addr_processed.load();</highlight></codeline>
<codeline lineno="1744"><highlight class="normal"><sp/><sp/><sp/><sp/>stats.<ref refid="struct_c_node_state_stats_1a210b39a806dca70eede58f135b61ca28" kindref="member">m_addr_rate_limited</ref><sp/>=<sp/>peer-&gt;m_addr_rate_limited.load();</highlight></codeline>
<codeline lineno="1745"><highlight class="normal"><sp/><sp/><sp/><sp/>stats.<ref refid="struct_c_node_state_stats_1a9a8f94fdf6b85d1a14b54e9d0300cb53" kindref="member">m_addr_relay_enabled</ref><sp/>=<sp/>peer-&gt;m_addr_relay_enabled.load();</highlight></codeline>
<codeline lineno="1746"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="1747"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(peer-&gt;m_headers_sync_mutex);</highlight></codeline>
<codeline lineno="1748"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer-&gt;m_headers_sync)<sp/>{</highlight></codeline>
<codeline lineno="1749"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats.<ref refid="struct_c_node_state_stats_1ad12f21b267ad030eb4289c093a2648c0" kindref="member">presync_height</ref><sp/>=<sp/>peer-&gt;m_headers_sync-&gt;GetPresyncHeight();</highlight></codeline>
<codeline lineno="1750"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1751"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1752"><highlight class="normal"><sp/><sp/><sp/><sp/>stats.<ref refid="struct_c_node_state_stats_1af35885b1ccb35daf5e54f3285fd0c500" kindref="member">time_offset</ref><sp/>=<sp/>peer-&gt;m_time_offset;</highlight></codeline>
<codeline lineno="1753"><highlight class="normal"></highlight></codeline>
<codeline lineno="1754"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1755"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1756"><highlight class="normal"></highlight></codeline>
<codeline lineno="1757"><highlight class="normal">std::vector&lt;node::TxOrphanage::OrphanInfo&gt;<sp/>PeerManagerImpl::GetOrphanTransactions()</highlight></codeline>
<codeline lineno="1758"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1759"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_tx_download_mutex);</highlight></codeline>
<codeline lineno="1760"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>m_txdownloadman.GetOrphanTransactions();</highlight></codeline>
<codeline lineno="1761"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1762"><highlight class="normal"></highlight></codeline>
<codeline lineno="1763"><highlight class="normal">PeerManagerInfo<sp/>PeerManagerImpl::GetInfo()</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="1764"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="1765"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>PeerManagerInfo{</highlight></codeline>
<codeline lineno="1766"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.median_outbound_time_offset<sp/>=<sp/>m_outbound_time_offsets.<ref refid="class_time_offsets_1afc5034662d40ab6443f0c4fccb211879" kindref="member">Median</ref>(),</highlight></codeline>
<codeline lineno="1767"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.ignores_incoming_txs<sp/>=<sp/>m_opts.ignore_incoming_txs,</highlight></codeline>
<codeline lineno="1768"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="1769"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1770"><highlight class="normal"></highlight></codeline>
<codeline lineno="1771"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::AddToCompactExtraTransactions(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref>&amp;<sp/>tx)</highlight></codeline>
<codeline lineno="1772"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1773"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_opts.max_extra_txs<sp/>&lt;=<sp/>0)</highlight></codeline>
<codeline lineno="1774"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1775"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!vExtraTxnForCompact.size())</highlight></codeline>
<codeline lineno="1776"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vExtraTxnForCompact.resize(m_opts.max_extra_txs);</highlight></codeline>
<codeline lineno="1777"><highlight class="normal"><sp/><sp/><sp/><sp/>vExtraTxnForCompact[vExtraTxnForCompactIt]<sp/>=<sp/>std::make_pair(tx-&gt;GetWitnessHash(),<sp/>tx);</highlight></codeline>
<codeline lineno="1778"><highlight class="normal"><sp/><sp/><sp/><sp/>vExtraTxnForCompactIt<sp/>=<sp/>(vExtraTxnForCompactIt<sp/>+<sp/>1)<sp/>%<sp/>m_opts.max_extra_txs;</highlight></codeline>
<codeline lineno="1779"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1780"><highlight class="normal"></highlight></codeline>
<codeline lineno="1781"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::Misbehaving(Peer&amp;<sp/>peer,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::string&amp;<sp/>message)</highlight></codeline>
<codeline lineno="1782"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1783"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(peer.m_misbehavior_mutex);</highlight></codeline>
<codeline lineno="1784"><highlight class="normal"></highlight></codeline>
<codeline lineno="1785"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::string<sp/>message_prefixed<sp/>=<sp/>message.empty()<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal"><sp/>:<sp/>(</highlight><highlight class="stringliteral">&quot;:<sp/>&quot;</highlight><highlight class="normal"><sp/>+<sp/>message);</highlight></codeline>
<codeline lineno="1786"><highlight class="normal"><sp/><sp/><sp/><sp/>peer.m_should_discourage<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1787"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Misbehaving:<sp/>peer=%d%s\n&quot;</highlight><highlight class="normal">,<sp/>peer.m_id,<sp/>message_prefixed);</highlight></codeline>
<codeline lineno="1788"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="trace_8h_1ae7d4767c75c045d7e4d4b840fb4a8e5f" kindref="member">TRACEPOINT</ref>(net,<sp/>misbehaving_connection,</highlight></codeline>
<codeline lineno="1789"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_id,</highlight></codeline>
<codeline lineno="1790"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>message.c_str()</highlight></codeline>
<codeline lineno="1791"><highlight class="normal"><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="1792"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1793"><highlight class="normal"></highlight></codeline>
<codeline lineno="1794"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::MaybePunishNodeForBlock(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BlockValidationState&amp;<sp/>state,</highlight></codeline>
<codeline lineno="1795"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>via_compact_block,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::string&amp;<sp/>message)</highlight></codeline>
<codeline lineno="1796"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1797"><highlight class="normal"><sp/><sp/><sp/><sp/>PeerRef<sp/>peer{GetPeerRef(nodeid)};</highlight></codeline>
<codeline lineno="1798"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(state.<ref refid="class_validation_state_1a1b98c7dab961aab90e13b3f3f9fcf52d" kindref="member">GetResult</ref>())<sp/>{</highlight></codeline>
<codeline lineno="1799"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580af1d64fcb3663d9ed3a1481fac607b54b" kindref="member">BlockValidationResult::BLOCK_RESULT_UNSET</ref>:</highlight></codeline>
<codeline lineno="1800"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1801"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a5a70bd865d41ac7d01f874abc5124e99" kindref="member">BlockValidationResult::BLOCK_HEADER_LOW_WORK</ref>:</highlight></codeline>
<codeline lineno="1802"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>didn&apos;t<sp/>try<sp/>to<sp/>process<sp/>the<sp/>block<sp/>because<sp/>the<sp/>header<sp/>chain<sp/>may<sp/>have</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1803"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>too<sp/>little<sp/>work.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1804"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1805"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>node<sp/>is<sp/>providing<sp/>invalid<sp/>data:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1806"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a6d95354aa8213c32922ccc6fa949befb" kindref="member">BlockValidationResult::BLOCK_CONSENSUS</ref>:</highlight></codeline>
<codeline lineno="1807"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580aa74bec7838a1da98fe1e6e0620d31170" kindref="member">BlockValidationResult::BLOCK_MUTATED</ref>:</highlight></codeline>
<codeline lineno="1808"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!via_compact_block)<sp/>{</highlight></codeline>
<codeline lineno="1809"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer)<sp/>Misbehaving(*peer,<sp/>message);</highlight></codeline>
<codeline lineno="1810"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1811"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1812"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1813"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a66107f1a16fc14f7b8dff8becdf353b8" kindref="member">BlockValidationResult::BLOCK_CACHED_INVALID</ref>:</highlight></codeline>
<codeline lineno="1814"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="1815"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Discourage<sp/>outbound<sp/>(but<sp/>not<sp/>inbound)<sp/>peers<sp/>if<sp/>on<sp/>an<sp/>invalid<sp/>chain.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1816"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Exempt<sp/>HB<sp/>compact<sp/>block<sp/>peers.<sp/>Manual<sp/>connections<sp/>are<sp/>always<sp/>protected<sp/>from<sp/>discouragement.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1817"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer<sp/>&amp;&amp;<sp/>!via_compact_block<sp/>&amp;&amp;<sp/>!peer-&gt;m_is_inbound)<sp/>{</highlight></codeline>
<codeline lineno="1818"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer)<sp/>Misbehaving(*peer,<sp/>message);</highlight></codeline>
<codeline lineno="1819"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1820"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1821"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1822"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1823"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a5ba8236eb864c026cf09cd1d7d145bb9" kindref="member">BlockValidationResult::BLOCK_INVALID_HEADER</ref>:</highlight></codeline>
<codeline lineno="1824"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a9bd09980f054effc42d4dac919472ead" kindref="member">BlockValidationResult::BLOCK_INVALID_PREV</ref>:</highlight></codeline>
<codeline lineno="1825"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer)<sp/>Misbehaving(*peer,<sp/>message);</highlight></codeline>
<codeline lineno="1826"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1827"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Conflicting<sp/>(but<sp/>not<sp/>necessarily<sp/>invalid)<sp/>data<sp/>or<sp/>different<sp/>policy:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1828"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a75fe58bb96b5b8a9992cfc163cd38435" kindref="member">BlockValidationResult::BLOCK_MISSING_PREV</ref>:</highlight></codeline>
<codeline lineno="1829"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer)<sp/>Misbehaving(*peer,<sp/>message);</highlight></codeline>
<codeline lineno="1830"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1831"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580aaec42241441df64f66774cd2cc142830" kindref="member">BlockValidationResult::BLOCK_TIME_FUTURE</ref>:</highlight></codeline>
<codeline lineno="1832"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1833"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1834"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(message<sp/>!=<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="1835"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;peer=%d:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>nodeid,<sp/>message);</highlight></codeline>
<codeline lineno="1836"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1837"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1838"><highlight class="normal"></highlight></codeline>
<codeline lineno="1839"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::BlockRequestAllowed(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindex)</highlight></codeline>
<codeline lineno="1840"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1841"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1842"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a78c557b8d1209a61416487a99a7808a9" kindref="member">Contains</ref>(pindex))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1843"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>pindex-&gt;<ref refid="class_c_block_index_1a1b5a636925d1c416b9d59eb0392a7a62" kindref="member">IsValid</ref>(<ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada47b28fca76b64d094ddca0a3aa8da230" kindref="member">BLOCK_VALID_SCRIPTS</ref>)<sp/>&amp;&amp;<sp/>(m_chainman.m_best_header<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="1844"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(m_chainman.m_best_header-&gt;GetBlockTime()<sp/>-<sp/>pindex-&gt;<ref refid="class_c_block_index_1a7aea61ae131a8b7b934f8b3a758d9490" kindref="member">GetBlockTime</ref>()<sp/>&lt;<sp/>STALE_RELAY_AGE_LIMIT)<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="1845"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(<ref refid="chain_8cpp_1abe314b9d901829ab0166322b67cffd70" kindref="member">GetBlockProofEquivalentTime</ref>(*m_chainman.m_best_header,<sp/>*pindex,<sp/>*m_chainman.m_best_header,<sp/>m_chainparams.<ref refid="class_c_chain_params_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>())<sp/>&lt;<sp/>STALE_RELAY_AGE_LIMIT);</highlight></codeline>
<codeline lineno="1846"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1847"><highlight class="normal"></highlight></codeline>
<codeline lineno="1848"><highlight class="normal">util::Expected&lt;void,<sp/>std::string&gt;<sp/>PeerManagerImpl::FetchBlock(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>peer_id,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex&amp;<sp/>block_index)</highlight></codeline>
<codeline lineno="1849"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1850"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1acef48b2a0b8aa252efa69928192b4d5a" kindref="member">LoadingBlocks</ref>())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Unexpected{</highlight><highlight class="stringliteral">&quot;Loading<sp/>blocks<sp/>...&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="1851"><highlight class="normal"></highlight></codeline>
<codeline lineno="1852"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ensure<sp/>this<sp/>peer<sp/>exists<sp/>and<sp/>hasn&apos;t<sp/>been<sp/>disconnected</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1853"><highlight class="normal"><sp/><sp/><sp/><sp/>PeerRef<sp/>peer<sp/>=<sp/>GetPeerRef(peer_id);</highlight></codeline>
<codeline lineno="1854"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Unexpected{</highlight><highlight class="stringliteral">&quot;Peer<sp/>does<sp/>not<sp/>exist&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="1855"><highlight class="normal"></highlight></codeline>
<codeline lineno="1856"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ignore<sp/>pre-segwit<sp/>peers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1857"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!CanServeWitnesses(*peer))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Unexpected{</highlight><highlight class="stringliteral">&quot;Pre-SegWit<sp/>peer&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="1858"><highlight class="normal"></highlight></codeline>
<codeline lineno="1859"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1860"><highlight class="normal"></highlight></codeline>
<codeline lineno="1861"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Forget<sp/>about<sp/>all<sp/>prior<sp/>requests</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1862"><highlight class="normal"><sp/><sp/><sp/><sp/>RemoveBlockRequest(block_index.<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>(),<sp/>std::nullopt);</highlight></codeline>
<codeline lineno="1863"><highlight class="normal"></highlight></codeline>
<codeline lineno="1864"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Mark<sp/>block<sp/>as<sp/>in-flight</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1865"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!BlockRequested(peer_id,<sp/>block_index))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Unexpected{</highlight><highlight class="stringliteral">&quot;Already<sp/>requested<sp/>from<sp/>this<sp/>peer&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="1866"><highlight class="normal"></highlight></codeline>
<codeline lineno="1867"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Construct<sp/>message<sp/>to<sp/>request<sp/>the<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1868"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256&amp;<sp/>hash{block_index.<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>()};</highlight></codeline>
<codeline lineno="1869"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;CInv&gt;<sp/>invs{CInv(<ref refid="protocol_8h_1ac1162efdf35b533ba996ac9d1c96fc05a4cae15fd207d555331995cd5c57689c1" kindref="member">MSG_BLOCK</ref><sp/>|<sp/><ref refid="protocol_8h_1a706dc5bf653ca632edd8d08fa81c1073" kindref="member">MSG_WITNESS_FLAG</ref>,<sp/>hash)};</highlight></codeline>
<codeline lineno="1870"><highlight class="normal"></highlight></codeline>
<codeline lineno="1871"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Send<sp/>block<sp/>request<sp/>message<sp/>to<sp/>the<sp/>peer</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1872"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>success<sp/>=<sp/>m_connman.<ref refid="class_c_connman_1a0df360faf6c653e1ebea6b5b7eee301b" kindref="member">ForNode</ref>(peer_id,<sp/>[</highlight><highlight class="keyword">this</highlight><highlight class="normal">,<sp/>&amp;invs](CNode*<sp/>node)<sp/>{</highlight></codeline>
<codeline lineno="1873"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>this-&gt;MakeAndPushMessage(*node,<sp/><ref refid="namespace_net_msg_type_1a18544277034744dbf6f85e748835ecfe" kindref="member">NetMsgType::GETDATA</ref>,<sp/>invs);</highlight></codeline>
<codeline lineno="1874"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1875"><highlight class="normal"><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="1876"><highlight class="normal"></highlight></codeline>
<codeline lineno="1877"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!success)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>util::Unexpected{</highlight><highlight class="stringliteral">&quot;Peer<sp/>not<sp/>fully<sp/>connected&quot;</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="1878"><highlight class="normal"></highlight></codeline>
<codeline lineno="1879"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Requesting<sp/>block<sp/>%s<sp/>from<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="1880"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>peer_id);</highlight></codeline>
<codeline lineno="1881"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{};</highlight></codeline>
<codeline lineno="1882"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1883"><highlight class="normal"></highlight></codeline>
<codeline lineno="1884"><highlight class="normal">std::unique_ptr&lt;PeerManager&gt;<sp/><ref refid="class_peer_manager_1a9d86f722d4111fed4e14deca63b5841e" kindref="member">PeerManager::make</ref>(CConnman&amp;<sp/>connman,<sp/>AddrMan&amp;<sp/>addrman,</highlight></codeline>
<codeline lineno="1885"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BanMan*<sp/>banman,<sp/>ChainstateManager&amp;<sp/>chainman,</highlight></codeline>
<codeline lineno="1886"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CTxMemPool&amp;<sp/>pool,<sp/>node::Warnings&amp;<sp/>warnings,<sp/>Options<sp/>opts)</highlight></codeline>
<codeline lineno="1887"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1888"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::make_unique&lt;PeerManagerImpl&gt;(connman,<sp/>addrman,<sp/>banman,<sp/>chainman,<sp/>pool,<sp/>warnings,<sp/>opts);</highlight></codeline>
<codeline lineno="1889"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1890"><highlight class="normal"></highlight></codeline>
<codeline lineno="1891"><highlight class="normal">PeerManagerImpl::PeerManagerImpl(CConnman&amp;<sp/>connman,<sp/>AddrMan&amp;<sp/>addrman,</highlight></codeline>
<codeline lineno="1892"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BanMan*<sp/>banman,<sp/>ChainstateManager&amp;<sp/>chainman,</highlight></codeline>
<codeline lineno="1893"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CTxMemPool&amp;<sp/>pool,<sp/>node::Warnings&amp;<sp/>warnings,<sp/>Options<sp/>opts)</highlight></codeline>
<codeline lineno="1894"><highlight class="normal"><sp/><sp/><sp/><sp/>:<sp/>m_rng{opts.deterministic_rng},</highlight></codeline>
<codeline lineno="1895"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_fee_filter_rounder{CFeeRate{DEFAULT_MIN_RELAY_TX_FEE},<sp/>m_rng},</highlight></codeline>
<codeline lineno="1896"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_chainparams(chainman.GetParams()),</highlight></codeline>
<codeline lineno="1897"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_connman(connman),</highlight></codeline>
<codeline lineno="1898"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_addrman(addrman),</highlight></codeline>
<codeline lineno="1899"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_banman(banman),</highlight></codeline>
<codeline lineno="1900"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_chainman(chainman),</highlight></codeline>
<codeline lineno="1901"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_mempool(pool),</highlight></codeline>
<codeline lineno="1902"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_txdownloadman(node::TxDownloadOptions{pool,<sp/>m_rng,<sp/>opts.deterministic_rng}),</highlight></codeline>
<codeline lineno="1903"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_warnings{warnings},</highlight></codeline>
<codeline lineno="1904"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>m_opts{opts}</highlight></codeline>
<codeline lineno="1905"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1906"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>While<sp/>Erlay<sp/>support<sp/>is<sp/>incomplete,<sp/>it<sp/>must<sp/>be<sp/>enabled<sp/>explicitly<sp/>via<sp/>-txreconciliation.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1907"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>argument<sp/>can<sp/>go<sp/>away<sp/>after<sp/>Erlay<sp/>support<sp/>is<sp/>complete.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1908"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(opts.reconcile_txs)<sp/>{</highlight></codeline>
<codeline lineno="1909"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_txreconciliation<sp/>=<sp/>std::make_unique&lt;TxReconciliationTracker&gt;(TXRECONCILIATION_VERSION);</highlight></codeline>
<codeline lineno="1910"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1911"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1912"><highlight class="normal"></highlight></codeline>
<codeline lineno="1913"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::StartScheduledTasks(<ref refid="class_c_scheduler" kindref="compound">CScheduler</ref>&amp;<sp/>scheduler)</highlight></codeline>
<codeline lineno="1914"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1915"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Stale<sp/>tip<sp/>checking<sp/>and<sp/>peer<sp/>eviction<sp/>are<sp/>on<sp/>two<sp/>different<sp/>timers,<sp/>but<sp/>we</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1916"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>don&apos;t<sp/>want<sp/>them<sp/>to<sp/>get<sp/>out<sp/>of<sp/>sync<sp/>due<sp/>to<sp/>drift<sp/>in<sp/>the<sp/>scheduler,<sp/>so<sp/>we</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1917"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>combine<sp/>them<sp/>in<sp/>one<sp/>function<sp/>and<sp/>schedule<sp/>at<sp/>the<sp/>quicker<sp/>(peer-eviction)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1918"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>timer.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1919"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">static_assert</highlight><highlight class="normal">(EXTRA_PEER_CHECK_INTERVAL<sp/>&lt;<sp/>STALE_CHECK_INTERVAL,<sp/></highlight><highlight class="stringliteral">&quot;peer<sp/>eviction<sp/>timer<sp/>should<sp/>be<sp/>less<sp/>than<sp/>stale<sp/>tip<sp/>check<sp/>timer&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="1920"><highlight class="normal"><sp/><sp/><sp/><sp/>scheduler.<ref refid="class_c_scheduler_1afc967db034e89889059bca31574ec485" kindref="member">scheduleEvery</ref>([</highlight><highlight class="keyword">this</highlight><highlight class="normal">]<sp/>{<sp/>this-&gt;CheckForStaleTipAndEvictPeers();<sp/>},<sp/>std::chrono::seconds{EXTRA_PEER_CHECK_INTERVAL});</highlight></codeline>
<codeline lineno="1921"><highlight class="normal"></highlight></codeline>
<codeline lineno="1922"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>schedule<sp/>next<sp/>run<sp/>for<sp/>10-15<sp/>minutes<sp/>in<sp/>the<sp/>future</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1923"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>delta<sp/>=<sp/>10min<sp/>+<sp/>FastRandomContext().randrange&lt;std::chrono::milliseconds&gt;(5min);</highlight></codeline>
<codeline lineno="1924"><highlight class="normal"><sp/><sp/><sp/><sp/>scheduler.<ref refid="class_c_scheduler_1afdb52271200f958fa88b14b94546bb20" kindref="member">scheduleFromNow</ref>([&amp;]<sp/>{<sp/>ReattemptInitialBroadcast(scheduler);<sp/>},<sp/>delta);</highlight></codeline>
<codeline lineno="1925"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1926"><highlight class="normal"></highlight></codeline>
<codeline lineno="1927"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::ActiveTipChange(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex&amp;<sp/>new_tip,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>is_ibd)</highlight></codeline>
<codeline lineno="1928"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1929"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ensure<sp/>mempool<sp/>mutex<sp/>was<sp/>released,<sp/>otherwise<sp/>deadlock<sp/>may<sp/>occur<sp/>if<sp/>another<sp/>thread<sp/>holding</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1930"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>m_tx_download_mutex<sp/>waits<sp/>on<sp/>the<sp/>mempool<sp/>mutex.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1931"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(m_mempool.<ref refid="class_c_tx_mem_pool_1ab322659c2acf98d3bb6e877e69414281" kindref="member">cs</ref>);</highlight></codeline>
<codeline lineno="1932"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(m_tx_download_mutex);</highlight></codeline>
<codeline lineno="1933"><highlight class="normal"></highlight></codeline>
<codeline lineno="1934"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!is_ibd)<sp/>{</highlight></codeline>
<codeline lineno="1935"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_tx_download_mutex);</highlight></codeline>
<codeline lineno="1936"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>chain<sp/>tip<sp/>has<sp/>changed,<sp/>previously<sp/>rejected<sp/>transactions<sp/>might<sp/>now<sp/>be<sp/>valid,<sp/>e.g.<sp/>due</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1937"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>a<sp/>timelock.<sp/>Reset<sp/>the<sp/>rejection<sp/>filters<sp/>to<sp/>give<sp/>those<sp/>transactions<sp/>another<sp/>chance<sp/>if<sp/>we</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1938"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>see<sp/>them<sp/>again.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1939"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_txdownloadman.ActiveTipChange();</highlight></codeline>
<codeline lineno="1940"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1941"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1942"><highlight class="normal"></highlight></codeline>
<codeline lineno="1949"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::BlockConnected(</highlight></codeline>
<codeline lineno="1950"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>ChainstateRole&amp;<sp/>role,</highlight></codeline>
<codeline lineno="1951"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;&amp;<sp/>pblock,</highlight></codeline>
<codeline lineno="1952"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindex)</highlight></codeline>
<codeline lineno="1953"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1954"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Update<sp/>this<sp/>for<sp/>all<sp/>chainstate<sp/>roles<sp/>so<sp/>that<sp/>we<sp/>don&apos;t<sp/>mistakenly<sp/>see<sp/>peers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1955"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>helping<sp/>us<sp/>do<sp/>background<sp/>IBD<sp/>as<sp/>having<sp/>a<sp/>stale<sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1956"><highlight class="normal"><sp/><sp/><sp/><sp/>m_last_tip_update<sp/>=<sp/><ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime&lt;std::chrono::seconds&gt;</ref>();</highlight></codeline>
<codeline lineno="1957"><highlight class="normal"></highlight></codeline>
<codeline lineno="1958"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>In<sp/>case<sp/>the<sp/>dynamic<sp/>timeout<sp/>was<sp/>doubled<sp/>once<sp/>or<sp/>more,<sp/>reduce<sp/>it<sp/>slowly<sp/>back<sp/>to<sp/>its<sp/>default<sp/>value</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1959"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>stalling_timeout<sp/>=<sp/>m_block_stalling_timeout.load();</highlight></codeline>
<codeline lineno="1960"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(stalling_timeout<sp/>&gt;=<sp/>BLOCK_STALLING_TIMEOUT_DEFAULT);</highlight></codeline>
<codeline lineno="1961"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stalling_timeout<sp/>!=<sp/>BLOCK_STALLING_TIMEOUT_DEFAULT)<sp/>{</highlight></codeline>
<codeline lineno="1962"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>new_timeout<sp/>=<sp/>std::max(std::chrono::duration_cast&lt;std::chrono::seconds&gt;(stalling_timeout<sp/>*<sp/>0.85),<sp/>BLOCK_STALLING_TIMEOUT_DEFAULT);</highlight></codeline>
<codeline lineno="1963"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_block_stalling_timeout.compare_exchange_strong(stalling_timeout,<sp/>new_timeout))<sp/>{</highlight></codeline>
<codeline lineno="1964"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Decreased<sp/>stalling<sp/>timeout<sp/>to<sp/>%d<sp/>seconds\n&quot;</highlight><highlight class="normal">,<sp/><ref refid="util_2time_8h_1a888f421c54ec4d38a01dd0f7ddacd6a6" kindref="member">count_seconds</ref>(new_timeout));</highlight></codeline>
<codeline lineno="1965"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1966"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1967"><highlight class="normal"></highlight></codeline>
<codeline lineno="1968"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>following<sp/>task<sp/>can<sp/>be<sp/>skipped<sp/>since<sp/>we<sp/>don&apos;t<sp/>maintain<sp/>a<sp/>mempool<sp/>for</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1969"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>historical<sp/>chainstate.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1970"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(role.<ref refid="structkernel_1_1_chainstate_role_1aba104d5a59781b2939c4b924c7d8e008" kindref="member">historical</ref>)<sp/>{</highlight></codeline>
<codeline lineno="1971"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1972"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1973"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_tx_download_mutex);</highlight></codeline>
<codeline lineno="1974"><highlight class="normal"><sp/><sp/><sp/><sp/>m_txdownloadman.BlockConnected(pblock);</highlight></codeline>
<codeline lineno="1975"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1976"><highlight class="normal"></highlight></codeline>
<codeline lineno="1977"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::BlockDisconnected(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;<sp/>&amp;block,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindex)</highlight></codeline>
<codeline lineno="1978"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1979"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_tx_download_mutex);</highlight></codeline>
<codeline lineno="1980"><highlight class="normal"><sp/><sp/><sp/><sp/>m_txdownloadman.BlockDisconnected();</highlight></codeline>
<codeline lineno="1981"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1982"><highlight class="normal"></highlight></codeline>
<codeline lineno="1987"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::NewPoWValidBlock(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex<sp/>*pindex,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;&amp;<sp/>pblock)</highlight></codeline>
<codeline lineno="1988"><highlight class="normal">{</highlight></codeline>
<codeline lineno="1989"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>pcmpctblock<sp/>=<sp/>std::make_shared&lt;const<sp/>CBlockHeaderAndShortTxIDs&gt;(*pblock,<sp/>FastRandomContext().rand64());</highlight></codeline>
<codeline lineno="1990"><highlight class="normal"></highlight></codeline>
<codeline lineno="1991"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="1992"><highlight class="normal"></highlight></codeline>
<codeline lineno="1993"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>&lt;=<sp/>m_highest_fast_announce)</highlight></codeline>
<codeline lineno="1994"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1995"><highlight class="normal"><sp/><sp/><sp/><sp/>m_highest_fast_announce<sp/>=<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>;</highlight></codeline>
<codeline lineno="1996"><highlight class="normal"></highlight></codeline>
<codeline lineno="1997"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="deploymentstatus_8h_1af313e9a747786adc5b5f3fc8e4e1a3fe" kindref="member">DeploymentActiveAt</ref>(*pindex,<sp/>m_chainman,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dbac12a10e827db62556122f2b1a9b0431b" kindref="member">Consensus::DEPLOYMENT_SEGWIT</ref>))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="1998"><highlight class="normal"></highlight></codeline>
<codeline lineno="1999"><highlight class="normal"><sp/><sp/><sp/><sp/>uint256<sp/>hashBlock(pblock-&gt;GetHash());</highlight></codeline>
<codeline lineno="2000"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::shared_future&lt;CSerializedNetMsg&gt;<sp/>lazy_ser{</highlight></codeline>
<codeline lineno="2001"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::async(std::launch::deferred,<sp/>[&amp;]<sp/>{<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="namespace_net_msg_1af64271506a941980bc0af944c721b637" kindref="member">NetMsg::Make</ref>(<ref refid="namespace_net_msg_type_1afb4658de55462fbfe264fc0f1ddb1d44" kindref="member">NetMsgType::CMPCTBLOCK</ref>,<sp/>*pcmpctblock);<sp/>})};</highlight></codeline>
<codeline lineno="2002"><highlight class="normal"></highlight></codeline>
<codeline lineno="2003"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2004"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>most_recent_block_txs<sp/>=<sp/>std::make_unique&lt;std::map&lt;GenTxid,<sp/>CTransactionRef&gt;&gt;();</highlight></codeline>
<codeline lineno="2005"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tx<sp/>:<sp/>pblock-&gt;vtx)<sp/>{</highlight></codeline>
<codeline lineno="2006"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>most_recent_block_txs-&gt;emplace(tx-&gt;GetHash(),<sp/>tx);</highlight></codeline>
<codeline lineno="2007"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>most_recent_block_txs-&gt;emplace(tx-&gt;GetWitnessHash(),<sp/>tx);</highlight></codeline>
<codeline lineno="2008"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2009"><highlight class="normal"></highlight></codeline>
<codeline lineno="2010"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_most_recent_block_mutex);</highlight></codeline>
<codeline lineno="2011"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_most_recent_block_hash<sp/>=<sp/>hashBlock;</highlight></codeline>
<codeline lineno="2012"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_most_recent_block<sp/>=<sp/>pblock;</highlight></codeline>
<codeline lineno="2013"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_most_recent_compact_block<sp/>=<sp/>pcmpctblock;</highlight></codeline>
<codeline lineno="2014"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_most_recent_block_txs<sp/>=<sp/>std::move(most_recent_block_txs);</highlight></codeline>
<codeline lineno="2015"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2016"><highlight class="normal"></highlight></codeline>
<codeline lineno="2017"><highlight class="normal"><sp/><sp/><sp/><sp/>m_connman.<ref refid="class_c_connman_1a94ba073a4116729f3850622392d86168" kindref="member">ForEachNode</ref>([</highlight><highlight class="keyword">this</highlight><highlight class="normal">,<sp/>pindex,<sp/>&amp;lazy_ser,<sp/>&amp;hashBlock](CNode*<sp/>pnode)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2018"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="2019"><highlight class="normal"></highlight></codeline>
<codeline lineno="2020"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pnode-&gt;<ref refid="class_c_node_1af039a299f31c62d63996fd5907c3f953" kindref="member">GetCommonVersion</ref>()<sp/>&lt;<sp/>INVALID_CB_NO_BAN_VERSION<sp/>||<sp/>pnode-&gt;<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref>)</highlight></codeline>
<codeline lineno="2021"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2022"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ProcessBlockAvailability(pnode-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="2023"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CNodeState<sp/>&amp;state<sp/>=<sp/>*<ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(pnode-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="2024"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>peer<sp/>has,<sp/>or<sp/>we<sp/>announced<sp/>to<sp/>them<sp/>the<sp/>previous<sp/>block<sp/>already,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2025"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>but<sp/>we<sp/>don&apos;t<sp/>think<sp/>they<sp/>have<sp/>this<sp/>one,<sp/>go<sp/>ahead<sp/>and<sp/>announce<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2026"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.m_requested_hb_cmpctblocks<sp/>&amp;&amp;<sp/>!PeerHasHeader(&amp;state,<sp/>pindex)<sp/>&amp;&amp;<sp/>PeerHasHeader(&amp;state,<sp/>pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>))<sp/>{</highlight></codeline>
<codeline lineno="2027"><highlight class="normal"></highlight></codeline>
<codeline lineno="2028"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s<sp/>sending<sp/>header-and-ids<sp/>%s<sp/>to<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;PeerManager::NewPoWValidBlock&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2029"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hashBlock.ToString(),<sp/>pnode-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="2030"><highlight class="normal"></highlight></codeline>
<codeline lineno="2031"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CSerializedNetMsg&amp;<sp/>ser_cmpctblock{lazy_ser.get()};</highlight></codeline>
<codeline lineno="2032"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PushMessage(*pnode,<sp/>ser_cmpctblock.<ref refid="struct_c_serialized_net_msg_1a06f9406e2c057c6d2f83271d4f16e022" kindref="member">Copy</ref>());</highlight></codeline>
<codeline lineno="2033"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.pindexBestHeaderSent<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="2034"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2035"><highlight class="normal"><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="2036"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2037"><highlight class="normal"></highlight></codeline>
<codeline lineno="2042"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::UpdatedBlockTip(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex<sp/>*pindexNew,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex<sp/>*pindexFork,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fInitialDownload)</highlight></codeline>
<codeline lineno="2043"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2044"><highlight class="normal"><sp/><sp/><sp/><sp/>SetBestBlock(pindexNew-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>std::chrono::seconds{pindexNew-&gt;GetBlockTime()});</highlight></codeline>
<codeline lineno="2045"><highlight class="normal"></highlight></codeline>
<codeline lineno="2046"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Don&apos;t<sp/>relay<sp/>inventory<sp/>during<sp/>initial<sp/>block<sp/>download.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2047"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fInitialDownload)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2048"><highlight class="normal"></highlight></codeline>
<codeline lineno="2049"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Find<sp/>the<sp/>hashes<sp/>of<sp/>all<sp/>blocks<sp/>that<sp/>weren&apos;t<sp/>previously<sp/>in<sp/>the<sp/>best<sp/>chain.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2050"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;uint256&gt;<sp/>vHashes;</highlight></codeline>
<codeline lineno="2051"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex<sp/>*pindexToAnnounce<sp/>=<sp/>pindexNew;</highlight></codeline>
<codeline lineno="2052"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(pindexToAnnounce<sp/>!=<sp/>pindexFork)<sp/>{</highlight></codeline>
<codeline lineno="2053"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vHashes.push_back(pindexToAnnounce-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>());</highlight></codeline>
<codeline lineno="2054"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexToAnnounce<sp/>=<sp/>pindexToAnnounce-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>;</highlight></codeline>
<codeline lineno="2055"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vHashes.size()<sp/>==<sp/>MAX_BLOCKS_TO_ANNOUNCE)<sp/>{</highlight></codeline>
<codeline lineno="2056"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Limit<sp/>announcements<sp/>in<sp/>case<sp/>of<sp/>a<sp/>huge<sp/>reorganization.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2057"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Rely<sp/>on<sp/>the<sp/>peer&apos;s<sp/>synchronization<sp/>mechanism<sp/>in<sp/>that<sp/>case.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2058"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2059"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2060"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2061"><highlight class="normal"></highlight></codeline>
<codeline lineno="2062"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2063"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_peer_mutex);</highlight></codeline>
<codeline lineno="2064"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>it<sp/>:<sp/>m_peer_map)<sp/>{</highlight></codeline>
<codeline lineno="2065"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Peer&amp;<sp/>peer<sp/>=<sp/>*it.second;</highlight></codeline>
<codeline lineno="2066"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(peer.m_block_inv_mutex);</highlight></codeline>
<codeline lineno="2067"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256&amp;<sp/>hash<sp/>:<sp/>vHashes<sp/>|<sp/>std::views::reverse)<sp/>{</highlight></codeline>
<codeline lineno="2068"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_blocks_for_headers_relay.push_back(hash);</highlight></codeline>
<codeline lineno="2069"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2070"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2071"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2072"><highlight class="normal"></highlight></codeline>
<codeline lineno="2073"><highlight class="normal"><sp/><sp/><sp/><sp/>m_connman.<ref refid="class_c_connman_1aca877d27e58f6c965c68af7440bc9e0d" kindref="member">WakeMessageHandler</ref>();</highlight></codeline>
<codeline lineno="2074"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2075"><highlight class="normal"></highlight></codeline>
<codeline lineno="2080"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::BlockChecked(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;&amp;<sp/>block,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BlockValidationState&amp;<sp/>state)</highlight></codeline>
<codeline lineno="2081"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2082"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="2083"><highlight class="normal"></highlight></codeline>
<codeline lineno="2084"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256<sp/>hash(block-&gt;GetHash());</highlight></codeline>
<codeline lineno="2085"><highlight class="normal"><sp/><sp/><sp/><sp/>std::map&lt;uint256,<sp/>std::pair&lt;NodeId,<sp/>bool&gt;&gt;::iterator<sp/>it<sp/>=<sp/>mapBlockSource.find(hash);</highlight></codeline>
<codeline lineno="2086"><highlight class="normal"></highlight></codeline>
<codeline lineno="2087"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>block<sp/>failed<sp/>validation,<sp/>we<sp/>know<sp/>where<sp/>it<sp/>came<sp/>from<sp/>and<sp/>we&apos;re<sp/>still<sp/>connected</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2088"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>that<sp/>peer,<sp/>maybe<sp/>punish.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2089"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.<ref refid="class_validation_state_1a6c1f27c9de7ff98356fa712e4b796a1a" kindref="member">IsInvalid</ref>()<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="2090"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>it<sp/>!=<sp/>mapBlockSource.end()<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="2091"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(it-&gt;second.first))<sp/>{</highlight></codeline>
<codeline lineno="2092"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MaybePunishNodeForBlock(</highlight><highlight class="comment">/*nodeid=*/</highlight><highlight class="normal"><sp/>it-&gt;second.first,<sp/>state,<sp/></highlight><highlight class="comment">/*via_compact_block=*/</highlight><highlight class="normal"><sp/>!it-&gt;second.second);</highlight></codeline>
<codeline lineno="2093"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2094"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>that:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2095"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>1.<sp/>The<sp/>block<sp/>is<sp/>valid</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2096"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>2.<sp/>We&apos;re<sp/>not<sp/>in<sp/>initial<sp/>block<sp/>download</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2097"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>3.<sp/>This<sp/>is<sp/>currently<sp/>the<sp/>best<sp/>block<sp/>we&apos;re<sp/>aware<sp/>of.<sp/>We<sp/>haven&apos;t<sp/>updated</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2098"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/>the<sp/>tip<sp/>yet<sp/>so<sp/>we<sp/>have<sp/>no<sp/>way<sp/>to<sp/>check<sp/>this<sp/>directly<sp/>here.<sp/>Instead<sp/>we</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2099"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/>just<sp/>check<sp/>that<sp/>there<sp/>are<sp/>currently<sp/>no<sp/>other<sp/>blocks<sp/>in<sp/>flight.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2100"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.<ref refid="class_validation_state_1ac532c4b500b1a85ea22217f2c65a70ed" kindref="member">IsValid</ref>()<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="2101"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!m_chainman.<ref refid="class_chainstate_manager_1a312bb1a2008bae3205f4699b90880d66" kindref="member">IsInitialBlockDownload</ref>()<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="2102"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mapBlocksInFlight.count(hash)<sp/>==<sp/>mapBlocksInFlight.size())<sp/>{</highlight></codeline>
<codeline lineno="2103"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>!=<sp/>mapBlockSource.end())<sp/>{</highlight></codeline>
<codeline lineno="2104"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MaybeSetPeerAsAnnouncingHeaderAndIDs(it-&gt;second.first);</highlight></codeline>
<codeline lineno="2105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2106"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2107"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>!=<sp/>mapBlockSource.end())</highlight></codeline>
<codeline lineno="2108"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mapBlockSource.erase(it);</highlight></codeline>
<codeline lineno="2109"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2110"><highlight class="normal"></highlight></codeline>
<codeline lineno="2112"><highlight class="normal"></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2113"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Messages</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2114"><highlight class="normal"></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2115"><highlight class="normal"></highlight></codeline>
<codeline lineno="2116"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::AlreadyHaveBlock(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256&amp;<sp/>block_hash)</highlight></codeline>
<codeline lineno="2117"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2118"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1a87eab19fb1a7e025715c13377ebfd356" kindref="member">LookupBlockIndex</ref>(block_hash)<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2119"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2120"><highlight class="normal"></highlight></codeline>
<codeline lineno="2121"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::SendPings()</highlight></codeline>
<codeline lineno="2122"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2123"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_peer_mutex);</highlight></codeline>
<codeline lineno="2124"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>it<sp/>:<sp/>m_peer_map)<sp/>it.second-&gt;m_ping_queued<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2125"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2126"><highlight class="normal"></highlight></codeline>
<codeline lineno="2127"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::RelayTransaction(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="transaction__identifier_8h_1ac4bb3c35b94889843d632be4de4b223c" kindref="member">Txid</ref>&amp;<sp/>txid,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="transaction__identifier_8h_1a23364c1312d4dffbbf549b4440333fd9" kindref="member">Wtxid</ref>&amp;<sp/>wtxid)</highlight></codeline>
<codeline lineno="2128"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2129"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_peer_mutex);</highlight></codeline>
<codeline lineno="2130"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>it<sp/>:<sp/>m_peer_map)<sp/>{</highlight></codeline>
<codeline lineno="2131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Peer&amp;<sp/>peer<sp/>=<sp/>*it.second;</highlight></codeline>
<codeline lineno="2132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>tx_relay<sp/>=<sp/>peer.GetTxRelay();</highlight></codeline>
<codeline lineno="2133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tx_relay)<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2134"><highlight class="normal"></highlight></codeline>
<codeline lineno="2135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(tx_relay-&gt;m_tx_inventory_mutex);</highlight></codeline>
<codeline lineno="2136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>queue<sp/>transactions<sp/>for<sp/>announcement<sp/>once<sp/>the<sp/>version<sp/>handshake</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>is<sp/>completed.<sp/>The<sp/>time<sp/>of<sp/>arrival<sp/>for<sp/>these<sp/>transactions<sp/>is</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>otherwise<sp/>at<sp/>risk<sp/>of<sp/>leaking<sp/>to<sp/>a<sp/>spy,<sp/>if<sp/>the<sp/>spy<sp/>is<sp/>able<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2139"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>distinguish<sp/>transactions<sp/>received<sp/>during<sp/>the<sp/>handshake<sp/>from<sp/>the<sp/>rest</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2140"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>in<sp/>the<sp/>announcement.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2141"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tx_relay-&gt;m_next_inv_send_time<sp/>==<sp/>0s)<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2142"><highlight class="normal"></highlight></codeline>
<codeline lineno="2143"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256&amp;<sp/>hash{peer.m_wtxid_relay<sp/>?<sp/>wtxid.<ref refid="classtransaction__identifier_1a1cb411c7b8bb6c9024bc1a87b6d367ba" kindref="member">ToUint256</ref>()<sp/>:<sp/>txid.<ref refid="classtransaction__identifier_1a1cb411c7b8bb6c9024bc1a87b6d367ba" kindref="member">ToUint256</ref>()};</highlight></codeline>
<codeline lineno="2144"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tx_relay-&gt;m_tx_inventory_known_filter.contains(hash))<sp/>{</highlight></codeline>
<codeline lineno="2145"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_relay-&gt;m_tx_inventory_to_send.insert(wtxid);</highlight></codeline>
<codeline lineno="2146"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2147"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2148"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2149"><highlight class="normal"></highlight></codeline>
<codeline lineno="2150"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::RelayAddress(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>originator,</highlight></codeline>
<codeline lineno="2151"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CAddress&amp;<sp/>addr,</highlight></codeline>
<codeline lineno="2152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fReachable)</highlight></codeline>
<codeline lineno="2153"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2154"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>choose<sp/>the<sp/>same<sp/>nodes<sp/>within<sp/>a<sp/>given<sp/>24h<sp/>window<sp/>(if<sp/>the<sp/>list<sp/>of<sp/>connected</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2155"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>nodes<sp/>does<sp/>not<sp/>change)<sp/>and<sp/>we<sp/>don&apos;t<sp/>relay<sp/>to<sp/>nodes<sp/>that<sp/>already<sp/>know<sp/>an</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2156"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>address.<sp/>So<sp/>within<sp/>24h<sp/>we<sp/>will<sp/>likely<sp/>relay<sp/>a<sp/>given<sp/>address<sp/>once.<sp/>This<sp/>is<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2157"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>prevent<sp/>a<sp/>peer<sp/>from<sp/>unjustly<sp/>giving<sp/>their<sp/>address<sp/>better<sp/>propagation<sp/>by<sp/>sending</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2158"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>it<sp/>to<sp/>us<sp/>repeatedly.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2159"><highlight class="normal"></highlight></codeline>
<codeline lineno="2160"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!fReachable<sp/>&amp;&amp;<sp/>!addr.<ref refid="class_c_net_addr_1a0bec7aba5bcfbf9653f07478e418c71e" kindref="member">IsRelayable</ref>())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2161"><highlight class="normal"></highlight></codeline>
<codeline lineno="2162"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Relay<sp/>to<sp/>a<sp/>limited<sp/>number<sp/>of<sp/>other<sp/>nodes</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2163"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Use<sp/>deterministic<sp/>randomness<sp/>to<sp/>send<sp/>to<sp/>the<sp/>same<sp/>nodes<sp/>for<sp/>24<sp/>hours</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2164"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>at<sp/>a<sp/>time<sp/>so<sp/>the<sp/>m_addr_knowns<sp/>of<sp/>the<sp/>chosen<sp/>nodes<sp/>prevent<sp/>repeats</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2165"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>hash_addr{CServiceHash(0,<sp/>0)(addr)};</highlight></codeline>
<codeline lineno="2166"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>current_time{<ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime&lt;std::chrono::seconds&gt;</ref>()};</highlight></codeline>
<codeline lineno="2167"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Adding<sp/>address<sp/>hash<sp/>makes<sp/>exact<sp/>rotation<sp/>time<sp/>different<sp/>per<sp/>address,<sp/>while<sp/>preserving<sp/>periodicity.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2168"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>time_addr{(</highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="normal">uint64_t</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(<ref refid="util_2time_8h_1a888f421c54ec4d38a01dd0f7ddacd6a6" kindref="member">count_seconds</ref>(current_time))<sp/>+<sp/>hash_addr)<sp/>/<sp/><ref refid="util_2time_8h_1a888f421c54ec4d38a01dd0f7ddacd6a6" kindref="member">count_seconds</ref>(ROTATE_ADDR_RELAY_DEST_INTERVAL)};</highlight></codeline>
<codeline lineno="2169"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CSipHasher<sp/>hasher{m_connman.<ref refid="class_c_connman_1a62d984d9362bdd151e2f845bd153f331" kindref="member">GetDeterministicRandomizer</ref>(RANDOMIZER_ID_ADDRESS_RELAY)</highlight></codeline>
<codeline lineno="2170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.<ref refid="class_c_sip_hasher_1ad40f8bffc9948973b7027f33bf417dee" kindref="member">Write</ref>(hash_addr)</highlight></codeline>
<codeline lineno="2171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.<ref refid="class_c_sip_hasher_1ad40f8bffc9948973b7027f33bf417dee" kindref="member">Write</ref>(time_addr)};</highlight></codeline>
<codeline lineno="2172"><highlight class="normal"></highlight></codeline>
<codeline lineno="2173"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Relay<sp/>reachable<sp/>addresses<sp/>to<sp/>2<sp/>peers.<sp/>Unreachable<sp/>addresses<sp/>are<sp/>relayed<sp/>randomly<sp/>to<sp/>1<sp/>or<sp/>2<sp/>peers.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2174"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nRelayNodes<sp/>=<sp/>(fReachable<sp/>||<sp/>(hasher.<ref refid="class_c_sip_hasher_1a1819935e246b62fc6ee9165df38ff623" kindref="member">Finalize</ref>()<sp/>&amp;<sp/>1))<sp/>?<sp/>2<sp/>:<sp/>1;</highlight></codeline>
<codeline lineno="2175"><highlight class="normal"></highlight></codeline>
<codeline lineno="2176"><highlight class="normal"><sp/><sp/><sp/><sp/>std::array&lt;std::pair&lt;uint64_t,<sp/>Peer*&gt;,<sp/>2&gt;<sp/>best{{{0,<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">},<sp/>{0,<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">}}};</highlight></codeline>
<codeline lineno="2177"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(nRelayNodes<sp/>&lt;=<sp/>best.size());</highlight></codeline>
<codeline lineno="2178"><highlight class="normal"></highlight></codeline>
<codeline lineno="2179"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_peer_mutex);</highlight></codeline>
<codeline lineno="2180"><highlight class="normal"></highlight></codeline>
<codeline lineno="2181"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>[</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">,<sp/>peer]<sp/>:<sp/>m_peer_map)<sp/>{</highlight></codeline>
<codeline lineno="2182"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer-&gt;m_addr_relay_enabled<sp/>&amp;&amp;<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal"><sp/>!=<sp/>originator<sp/>&amp;&amp;<sp/>IsAddrCompatible(*peer,<sp/>addr))<sp/>{</highlight></codeline>
<codeline lineno="2183"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>hashKey<sp/>=<sp/>CSipHasher(hasher).Write(</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">).Finalize();</highlight></codeline>
<codeline lineno="2184"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>nRelayNodes;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="2185"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(hashKey<sp/>&gt;<sp/>best[i].first)<sp/>{</highlight></codeline>
<codeline lineno="2186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::copy(best.begin()<sp/>+<sp/>i,<sp/>best.begin()<sp/>+<sp/>nRelayNodes<sp/>-<sp/>1,<sp/>best.begin()<sp/>+<sp/>i<sp/>+<sp/>1);</highlight></codeline>
<codeline lineno="2187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>best[i]<sp/>=<sp/>std::make_pair(hashKey,<sp/>peer.get());</highlight></codeline>
<codeline lineno="2188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2190"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2191"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2192"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="2193"><highlight class="normal"></highlight></codeline>
<codeline lineno="2194"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>nRelayNodes<sp/>&amp;&amp;<sp/>best[i].first<sp/>!=<sp/>0;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="2195"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PushAddress(*best[i].second,<sp/>addr);</highlight></codeline>
<codeline lineno="2196"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2197"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2198"><highlight class="normal"></highlight></codeline>
<codeline lineno="2199"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::ProcessGetBlockData(CNode&amp;<sp/>pfrom,<sp/>Peer&amp;<sp/>peer,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CInv&amp;<sp/>inv)</highlight></codeline>
<codeline lineno="2200"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2201"><highlight class="normal"><sp/><sp/><sp/><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;<sp/>a_recent_block;</highlight></codeline>
<codeline lineno="2202"><highlight class="normal"><sp/><sp/><sp/><sp/>std::shared_ptr&lt;const<sp/>CBlockHeaderAndShortTxIDs&gt;<sp/>a_recent_compact_block;</highlight></codeline>
<codeline lineno="2203"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_most_recent_block_mutex);</highlight></codeline>
<codeline lineno="2205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>a_recent_block<sp/>=<sp/>m_most_recent_block;</highlight></codeline>
<codeline lineno="2206"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>a_recent_compact_block<sp/>=<sp/>m_most_recent_compact_block;</highlight></codeline>
<codeline lineno="2207"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2208"><highlight class="normal"></highlight></codeline>
<codeline lineno="2209"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>need_activate_chain<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2210"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="2212"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindex<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1a87eab19fb1a7e025715c13377ebfd356" kindref="member">LookupBlockIndex</ref>(inv.<ref refid="class_c_inv_1aa5db1ede9ecd9798d4549e62e5e19745" kindref="member">hash</ref>);</highlight></codeline>
<codeline lineno="2213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex)<sp/>{</highlight></codeline>
<codeline lineno="2214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1ae804dd1f9a78669920c2bc21dc7a9812" kindref="member">HaveNumChainTxs</ref>()<sp/>&amp;&amp;<sp/>!pindex-&gt;<ref refid="class_c_block_index_1a1b5a636925d1c416b9d59eb0392a7a62" kindref="member">IsValid</ref>(<ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada47b28fca76b64d094ddca0a3aa8da230" kindref="member">BLOCK_VALID_SCRIPTS</ref>)<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="2215"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex-&gt;<ref refid="class_c_block_index_1a1b5a636925d1c416b9d59eb0392a7a62" kindref="member">IsValid</ref>(<ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada67f3a88eeb793cc62f427f87ae830573" kindref="member">BLOCK_VALID_TREE</ref>))<sp/>{</highlight></codeline>
<codeline lineno="2216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>have<sp/>the<sp/>block<sp/>and<sp/>all<sp/>of<sp/>its<sp/>parents,<sp/>but<sp/>have<sp/>not<sp/>yet<sp/>validated<sp/>it,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2217"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>might<sp/>be<sp/>in<sp/>the<sp/>middle<sp/>of<sp/>connecting<sp/>it<sp/>(ie<sp/>in<sp/>the<sp/>unlock<sp/>of<sp/>cs_main</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2218"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>before<sp/>ActivateBestChain<sp/>but<sp/>after<sp/>AcceptBlock).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2219"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>In<sp/>this<sp/>case,<sp/>we<sp/>need<sp/>to<sp/>run<sp/>ActivateBestChain<sp/>prior<sp/>to<sp/>checking<sp/>the<sp/>relay</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>conditions<sp/>below.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>need_activate_chain<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2224"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>release<sp/>cs_main<sp/>before<sp/>calling<sp/>ActivateBestChain</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2225"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(need_activate_chain)<sp/>{</highlight></codeline>
<codeline lineno="2226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BlockValidationState<sp/>state;</highlight></codeline>
<codeline lineno="2227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_chainman.<ref refid="class_chainstate_manager_1a0ed46908ea52e17d172f2fcc0ceb9964" kindref="member">ActiveChainstate</ref>().ActivateBestChain(state,<sp/>a_recent_block))<sp/>{</highlight></codeline>
<codeline lineno="2228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;failed<sp/>to<sp/>activate<sp/>chain<sp/>(%s)\n&quot;</highlight><highlight class="normal">,<sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="2229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2230"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2231"><highlight class="normal"></highlight></codeline>
<codeline lineno="2232"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindex{</highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2233"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>tip{</highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2234"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>can_direct_fetch{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2235"><highlight class="normal"><sp/><sp/><sp/><sp/>FlatFilePos<sp/>block_pos{};</highlight></codeline>
<codeline lineno="2236"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="2238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1a87eab19fb1a7e025715c13377ebfd356" kindref="member">LookupBlockIndex</ref>(inv.<ref refid="class_c_inv_1aa5db1ede9ecd9798d4549e62e5e19745" kindref="member">hash</ref>);</highlight></codeline>
<codeline lineno="2239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pindex)<sp/>{</highlight></codeline>
<codeline lineno="2240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!BlockRequestAllowed(pindex))<sp/>{</highlight></codeline>
<codeline lineno="2243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s:<sp/>ignoring<sp/>request<sp/>from<sp/>peer=%i<sp/>for<sp/>old<sp/>block<sp/>that<sp/>isn&apos;t<sp/>in<sp/>the<sp/>main<sp/>chain\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="2244"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>disconnect<sp/>node<sp/>in<sp/>case<sp/>we<sp/>have<sp/>reached<sp/>the<sp/>outbound<sp/>limit<sp/>for<sp/>serving<sp/>historical<sp/>blocks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2247"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_connman.<ref refid="class_c_connman_1ab1c8de1b6e3a4a49afb85c3ad5daa528" kindref="member">OutboundTargetReached</ref>(</highlight><highlight class="keyword">true</highlight><highlight class="normal">)<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="2248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(((m_chainman.m_best_header<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>&amp;&amp;<sp/>(m_chainman.m_best_header-&gt;GetBlockTime()<sp/>-<sp/>pindex-&gt;<ref refid="class_c_block_index_1a7aea61ae131a8b7b934f8b3a758d9490" kindref="member">GetBlockTime</ref>()<sp/>&gt;<sp/>HISTORICAL_BLOCK_AGE))<sp/>||<sp/>inv.<ref refid="class_c_inv_1a826d71c56afe9949ccedf6fcd4db84c4" kindref="member">IsMsgFilteredBlk</ref>())<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="2249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!pfrom.<ref refid="class_c_node_1ad093ef142d44eddf28162f2aa26d56c2" kindref="member">HasPermission</ref>(<ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a801ab24683a4a8c433c6eb40c48bcd9d" kindref="member">NetPermissionFlags::Download</ref>)<sp/></highlight><highlight class="comment">//<sp/>nodes<sp/>with<sp/>the<sp/>download<sp/>permission<sp/>may<sp/>exceed<sp/>target</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)<sp/>{</highlight></codeline>
<codeline lineno="2251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;historical<sp/>block<sp/>serving<sp/>limit<sp/>reached,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="2252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tip<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>();</highlight></codeline>
<codeline lineno="2256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Avoid<sp/>leaking<sp/>prune-height<sp/>by<sp/>never<sp/>sending<sp/>blocks<sp/>below<sp/>the<sp/>NODE_NETWORK_LIMITED<sp/>threshold</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pfrom.<ref refid="class_c_node_1ad093ef142d44eddf28162f2aa26d56c2" kindref="member">HasPermission</ref>(<ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a12b80870cf3a64e605a95b9c521ac46f" kindref="member">NetPermissionFlags::NoBan</ref>)<sp/>&amp;&amp;<sp/>(</highlight></codeline>
<codeline lineno="2258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(((peer.m_our_services<sp/>&amp;<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a8294ff7e8ff77692c2fb330df0a3c372" kindref="member">NODE_NETWORK_LIMITED</ref>)<sp/>==<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a8294ff7e8ff77692c2fb330df0a3c372" kindref="member">NODE_NETWORK_LIMITED</ref>)<sp/>&amp;&amp;<sp/>((peer.m_our_services<sp/>&amp;<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a9d1154f0e7e56f183a5c8373abe2e86c" kindref="member">NODE_NETWORK</ref>)<sp/>!=<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a9d1154f0e7e56f183a5c8373abe2e86c" kindref="member">NODE_NETWORK</ref>)<sp/>&amp;&amp;<sp/>(tip-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>-<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>&gt;<sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)NODE_NETWORK_LIMITED_MIN_BLOCKS<sp/>+<sp/>2<sp/></highlight><highlight class="comment">/*<sp/>add<sp/>two<sp/>blocks<sp/>buffer<sp/>extension<sp/>for<sp/>possible<sp/>races<sp/>*/</highlight><highlight class="normal">)<sp/>)</highlight></codeline>
<codeline lineno="2259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>))<sp/>{</highlight></codeline>
<codeline lineno="2260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Ignore<sp/>block<sp/>request<sp/>below<sp/>NODE_NETWORK_LIMITED<sp/>threshold,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="2261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//disconnect<sp/>node<sp/>and<sp/>prevent<sp/>it<sp/>from<sp/>stalling<sp/>(would<sp/>otherwise<sp/>wait<sp/>for<sp/>the<sp/>missing<sp/>block)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2262"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2263"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2264"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2265"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Pruned<sp/>nodes<sp/>may<sp/>have<sp/>deleted<sp/>the<sp/>block,<sp/>so<sp/>check<sp/>whether</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2266"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>it&apos;s<sp/>available<sp/>before<sp/>trying<sp/>to<sp/>send.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2267"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15" kindref="member">BLOCK_HAVE_DATA</ref>))<sp/>{</highlight></codeline>
<codeline lineno="2268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2270"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>can_direct_fetch<sp/>=<sp/>CanDirectFetch();</highlight></codeline>
<codeline lineno="2271"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>block_pos<sp/>=<sp/>pindex-&gt;<ref refid="class_c_block_index_1a21a3478b2a1d45cc8d1f266508eaa80e" kindref="member">GetBlockPos</ref>();</highlight></codeline>
<codeline lineno="2272"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2273"><highlight class="normal"></highlight></codeline>
<codeline lineno="2274"><highlight class="normal"><sp/><sp/><sp/><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;<sp/>pblock;</highlight></codeline>
<codeline lineno="2275"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(a_recent_block<sp/>&amp;&amp;<sp/>a_recent_block-&gt;GetHash()<sp/>==<sp/>inv.<ref refid="class_c_inv_1aa5db1ede9ecd9798d4549e62e5e19745" kindref="member">hash</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2276"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pblock<sp/>=<sp/>a_recent_block;</highlight></codeline>
<codeline lineno="2277"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(inv.<ref refid="class_c_inv_1aeee63b624053196286caeb0b1f6cdc8f" kindref="member">IsMsgWitnessBlk</ref>())<sp/>{</highlight></codeline>
<codeline lineno="2278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Fast-path:<sp/>in<sp/>this<sp/>case<sp/>it<sp/>is<sp/>possible<sp/>to<sp/>serve<sp/>the<sp/>block<sp/>directly<sp/>from<sp/>disk,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>as<sp/>the<sp/>network<sp/>format<sp/>matches<sp/>the<sp/>format<sp/>on<sp/>disk</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>block_data{m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1a0bfb8d6c21eed2929e6a388578ceae4d" kindref="member">ReadRawBlock</ref>(block_pos)})<sp/>{</highlight></codeline>
<codeline lineno="2281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a0c38093fb63e2aba2a1dad671b645de6" kindref="member">NetMsgType::BLOCK</ref>,<sp/>std::span{*block_data});</highlight></codeline>
<codeline lineno="2282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2283"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(m_chainman.<ref refid="class_chainstate_manager_1af99ab8783b483abe3fef8ab596a3e6b6" kindref="member">GetMutex</ref>(),<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.IsBlockPruned(*pindex)))<sp/>{</highlight></codeline>
<codeline lineno="2284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Block<sp/>was<sp/>pruned<sp/>before<sp/>it<sp/>could<sp/>be<sp/>read,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="2285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;Cannot<sp/>load<sp/>block<sp/>from<sp/>disk,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="2287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2289"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Don&apos;t<sp/>set<sp/>pblock<sp/>as<sp/>we&apos;ve<sp/>sent<sp/>the<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2292"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Send<sp/>block<sp/>from<sp/>disk</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::shared_ptr&lt;CBlock&gt;<sp/>pblockRead<sp/>=<sp/>std::make_shared&lt;CBlock&gt;();</highlight></codeline>
<codeline lineno="2295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1ad59bbdccdaca9da495b6b6e80c481a1a" kindref="member">ReadBlock</ref>(*pblockRead,<sp/>block_pos,<sp/>inv.<ref refid="class_c_inv_1aa5db1ede9ecd9798d4549e62e5e19745" kindref="member">hash</ref>))<sp/>{</highlight></codeline>
<codeline lineno="2296"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(m_chainman.<ref refid="class_chainstate_manager_1af99ab8783b483abe3fef8ab596a3e6b6" kindref="member">GetMutex</ref>(),<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.IsBlockPruned(*pindex)))<sp/>{</highlight></codeline>
<codeline lineno="2297"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Block<sp/>was<sp/>pruned<sp/>before<sp/>it<sp/>could<sp/>be<sp/>read,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="2298"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a611dbbfa5c2f148b7190b97a12835b5e" kindref="member">LogError</ref>(</highlight><highlight class="stringliteral">&quot;Cannot<sp/>load<sp/>block<sp/>from<sp/>disk,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="2300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pblock<sp/>=<sp/>pblockRead;</highlight></codeline>
<codeline lineno="2305"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2306"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pblock)<sp/>{</highlight></codeline>
<codeline lineno="2307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(inv.<ref refid="class_c_inv_1a882b1b632a99d4f0658f6ee175225ea6" kindref="member">IsMsgBlk</ref>())<sp/>{</highlight></codeline>
<codeline lineno="2308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a0c38093fb63e2aba2a1dad671b645de6" kindref="member">NetMsgType::BLOCK</ref>,<sp/>TX_NO_WITNESS(*pblock));</highlight></codeline>
<codeline lineno="2309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(inv.<ref refid="class_c_inv_1aeee63b624053196286caeb0b1f6cdc8f" kindref="member">IsMsgWitnessBlk</ref>())<sp/>{</highlight></codeline>
<codeline lineno="2310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a0c38093fb63e2aba2a1dad671b645de6" kindref="member">NetMsgType::BLOCK</ref>,<sp/>TX_WITH_WITNESS(*pblock));</highlight></codeline>
<codeline lineno="2311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(inv.<ref refid="class_c_inv_1a826d71c56afe9949ccedf6fcd4db84c4" kindref="member">IsMsgFilteredBlk</ref>())<sp/>{</highlight></codeline>
<codeline lineno="2312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>sendMerkleBlock<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CMerkleBlock<sp/>merkleBlock;</highlight></codeline>
<codeline lineno="2314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>tx_relay<sp/>=<sp/>peer.GetTxRelay();<sp/>tx_relay<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="2315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(tx_relay-&gt;m_bloom_filter_mutex);</highlight></codeline>
<codeline lineno="2316"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tx_relay-&gt;m_bloom_filter)<sp/>{</highlight></codeline>
<codeline lineno="2317"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sendMerkleBlock<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>merkleBlock<sp/>=<sp/>CMerkleBlock(*pblock,<sp/>*tx_relay-&gt;m_bloom_filter);</highlight></codeline>
<codeline lineno="2319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sendMerkleBlock)<sp/>{</highlight></codeline>
<codeline lineno="2322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1ae18674af9a72ecc5274738b5ac9f79dc" kindref="member">NetMsgType::MERKLEBLOCK</ref>,<sp/>merkleBlock);</highlight></codeline>
<codeline lineno="2323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>CMerkleBlock<sp/>just<sp/>contains<sp/>hashes,<sp/>so<sp/>also<sp/>push<sp/>any<sp/>transactions<sp/>in<sp/>the<sp/>block<sp/>the<sp/>client<sp/>did<sp/>not<sp/>see</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>avoids<sp/>hurting<sp/>performance<sp/>by<sp/>pointlessly<sp/>requiring<sp/>a<sp/>round-trip</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note<sp/>that<sp/>there<sp/>is<sp/>currently<sp/>no<sp/>way<sp/>for<sp/>a<sp/>node<sp/>to<sp/>request<sp/>any<sp/>single<sp/>transactions<sp/>we<sp/>didn&apos;t<sp/>send<sp/>here<sp/>-</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>they<sp/>must<sp/>either<sp/>disconnect<sp/>and<sp/>retry<sp/>or<sp/>request<sp/>the<sp/>full<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Thus,<sp/>the<sp/>protocol<sp/>spec<sp/>specified<sp/>allows<sp/>for<sp/>us<sp/>to<sp/>provide<sp/>duplicate<sp/>txn<sp/>here,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>however<sp/>we<sp/>MUST<sp/>always<sp/>provide<sp/>at<sp/>least<sp/>what<sp/>the<sp/>remote<sp/>peer<sp/>needs</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>[tx_idx,<sp/><ref refid="translation_8h_1a4f2d958035f4051a605124ebe248de38" kindref="member">_</ref>]<sp/>:<sp/>merkleBlock.<ref refid="class_c_merkle_block_1adc0ed9028da5ee243f3282e96bc77865" kindref="member">vMatchedTxn</ref>)</highlight></codeline>
<codeline lineno="2330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a737a463566994e29c65ef40499762be7" kindref="member">NetMsgType::TX</ref>,<sp/>TX_NO_WITNESS(*pblock-&gt;vtx[tx_idx]));</highlight></codeline>
<codeline lineno="2331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>no<sp/>response</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2334"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(inv.<ref refid="class_c_inv_1a52ec0108179f6f3929687c9b51113d06" kindref="member">IsMsgCmpctBlk</ref>())<sp/>{</highlight></codeline>
<codeline lineno="2335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>a<sp/>peer<sp/>is<sp/>asking<sp/>for<sp/>old<sp/>blocks,<sp/>we&apos;re<sp/>almost<sp/>guaranteed</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>they<sp/>won&apos;t<sp/>have<sp/>a<sp/>useful<sp/>mempool<sp/>to<sp/>match<sp/>against<sp/>a<sp/>compact<sp/>block,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>we<sp/>don&apos;t<sp/>feel<sp/>like<sp/>constructing<sp/>the<sp/>object<sp/>for<sp/>them,<sp/>so</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>instead<sp/>we<sp/>respond<sp/>with<sp/>the<sp/>full,<sp/>non-compact<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(can_direct_fetch<sp/>&amp;&amp;<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>&gt;=<sp/>tip-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>-<sp/>MAX_CMPCTBLOCK_DEPTH)<sp/>{</highlight></codeline>
<codeline lineno="2340"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(a_recent_compact_block<sp/>&amp;&amp;<sp/>a_recent_compact_block-&gt;header.GetHash()<sp/>==<sp/>inv.<ref refid="class_c_inv_1aa5db1ede9ecd9798d4549e62e5e19745" kindref="member">hash</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1afb4658de55462fbfe264fc0f1ddb1d44" kindref="member">NetMsgType::CMPCTBLOCK</ref>,<sp/>*a_recent_compact_block);</highlight></codeline>
<codeline lineno="2342"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockHeaderAndShortTxIDs<sp/>cmpctblock{*pblock,<sp/>m_rng.rand64()};</highlight></codeline>
<codeline lineno="2344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1afb4658de55462fbfe264fc0f1ddb1d44" kindref="member">NetMsgType::CMPCTBLOCK</ref>,<sp/>cmpctblock);</highlight></codeline>
<codeline lineno="2345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a0c38093fb63e2aba2a1dad671b645de6" kindref="member">NetMsgType::BLOCK</ref>,<sp/>TX_WITH_WITNESS(*pblock));</highlight></codeline>
<codeline lineno="2348"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2349"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2350"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2351"><highlight class="normal"></highlight></codeline>
<codeline lineno="2352"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(peer.m_block_inv_mutex);</highlight></codeline>
<codeline lineno="2354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Trigger<sp/>the<sp/>peer<sp/>node<sp/>to<sp/>send<sp/>a<sp/>getblocks<sp/>request<sp/>for<sp/>the<sp/>next<sp/>batch<sp/>of<sp/>inventory</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2355"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(inv.<ref refid="class_c_inv_1aa5db1ede9ecd9798d4549e62e5e19745" kindref="member">hash</ref><sp/>==<sp/>peer.m_continuation_block)<sp/>{</highlight></codeline>
<codeline lineno="2356"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Send<sp/>immediately.<sp/>This<sp/>must<sp/>send<sp/>even<sp/>if<sp/>redundant,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>we<sp/>want<sp/>it<sp/>right<sp/>after<sp/>the<sp/>last<sp/>block<sp/>so<sp/>they<sp/>don&apos;t</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2358"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>wait<sp/>for<sp/>other<sp/>stuff<sp/>first.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CInv&gt;<sp/>vInv;</highlight></codeline>
<codeline lineno="2360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vInv.emplace_back(<ref refid="protocol_8h_1ac1162efdf35b533ba996ac9d1c96fc05a4cae15fd207d555331995cd5c57689c1" kindref="member">MSG_BLOCK</ref>,<sp/>tip-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>());</highlight></codeline>
<codeline lineno="2361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a74ff47f13e393d7fa01ca77282ae01f6" kindref="member">NetMsgType::INV</ref>,<sp/>vInv);</highlight></codeline>
<codeline lineno="2362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_continuation_block.SetNull();</highlight></codeline>
<codeline lineno="2363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2364"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2365"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2366"><highlight class="normal"></highlight></codeline>
<codeline lineno="2367"><highlight class="normal"><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref><sp/>PeerManagerImpl::FindTxForGetData(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Peer::TxRelay&amp;<sp/>tx_relay,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>GenTxid&amp;<sp/>gtxid)</highlight></codeline>
<codeline lineno="2368"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2369"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>a<sp/>tx<sp/>was<sp/>in<sp/>the<sp/>mempool<sp/>prior<sp/>to<sp/>the<sp/>last<sp/>INV<sp/>for<sp/>this<sp/>peer,<sp/>permit<sp/>the<sp/>request.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2370"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>txinfo{std::visit(</highlight></codeline>
<codeline lineno="2371"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[&amp;](</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/></highlight><highlight class="keywordtype">id</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="2372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>m_mempool.<ref refid="class_c_tx_mem_pool_1a34585ef669394d19269d5589dc3e520e" kindref="member">info_for_relay</ref>(</highlight><highlight class="keywordtype">id</highlight><highlight class="normal">,<sp/><ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(tx_relay.m_tx_inventory_mutex,<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>tx_relay.m_last_inv_sequence));</highlight></codeline>
<codeline lineno="2373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>},</highlight></codeline>
<codeline lineno="2374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>gtxid)};</highlight></codeline>
<codeline lineno="2375"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(txinfo.tx)<sp/>{</highlight></codeline>
<codeline lineno="2376"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::move(txinfo.tx);</highlight></codeline>
<codeline lineno="2377"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2378"><highlight class="normal"></highlight></codeline>
<codeline lineno="2379"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Or<sp/>it<sp/>might<sp/>be<sp/>from<sp/>the<sp/>most<sp/>recent<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2380"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2381"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_most_recent_block_mutex);</highlight></codeline>
<codeline lineno="2382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_most_recent_block_txs<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="2383"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it<sp/>=<sp/>m_most_recent_block_txs-&gt;find(gtxid);</highlight></codeline>
<codeline lineno="2384"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>!=<sp/>m_most_recent_block_txs-&gt;end())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>it-&gt;second;</highlight></codeline>
<codeline lineno="2385"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2386"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2387"><highlight class="normal"></highlight></codeline>
<codeline lineno="2388"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>{};</highlight></codeline>
<codeline lineno="2389"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2390"><highlight class="normal"></highlight></codeline>
<codeline lineno="2391"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::ProcessGetData(CNode&amp;<sp/>pfrom,<sp/>Peer&amp;<sp/>peer,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::atomic&lt;bool&gt;&amp;<sp/>interruptMsgProc)</highlight></codeline>
<codeline lineno="2392"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2393"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="2394"><highlight class="normal"></highlight></codeline>
<codeline lineno="2395"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>tx_relay<sp/>=<sp/>peer.GetTxRelay();</highlight></codeline>
<codeline lineno="2396"><highlight class="normal"></highlight></codeline>
<codeline lineno="2397"><highlight class="normal"><sp/><sp/><sp/><sp/>std::deque&lt;CInv&gt;::iterator<sp/>it<sp/>=<sp/>peer.m_getdata_requests.begin();</highlight></codeline>
<codeline lineno="2398"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;CInv&gt;<sp/>vNotFound;</highlight></codeline>
<codeline lineno="2399"><highlight class="normal"></highlight></codeline>
<codeline lineno="2400"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Process<sp/>as<sp/>many<sp/>TX<sp/>items<sp/>from<sp/>the<sp/>front<sp/>of<sp/>the<sp/>getdata<sp/>queue<sp/>as</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2401"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>possible,<sp/>since<sp/>they&apos;re<sp/>common<sp/>and<sp/>it&apos;s<sp/>efficient<sp/>to<sp/>batch<sp/>process</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2402"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>them.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2403"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(it<sp/>!=<sp/>peer.m_getdata_requests.end()<sp/>&amp;&amp;<sp/>it-&gt;IsGenTxMsg())<sp/>{</highlight></codeline>
<codeline lineno="2404"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(interruptMsgProc)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2405"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>send<sp/>buffer<sp/>provides<sp/>backpressure.<sp/>If<sp/>there&apos;s<sp/>no<sp/>space<sp/>in</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2406"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>buffer,<sp/>pause<sp/>processing<sp/>until<sp/>the<sp/>next<sp/>call.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2407"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1a0d7c1f3172d1da877e15031b02b54133" kindref="member">fPauseSend</ref>)<sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2408"><highlight class="normal"></highlight></codeline>
<codeline lineno="2409"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CInv<sp/>&amp;inv<sp/>=<sp/>*it++;</highlight></codeline>
<codeline lineno="2410"><highlight class="normal"></highlight></codeline>
<codeline lineno="2411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tx_relay<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="2412"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ignore<sp/>GETDATA<sp/>requests<sp/>for<sp/>transactions<sp/>from<sp/>block-relay-only</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>peers<sp/>and<sp/>peers<sp/>that<sp/>asked<sp/>us<sp/>not<sp/>to<sp/>announce<sp/>transactions.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2414"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2416"><highlight class="normal"></highlight></codeline>
<codeline lineno="2417"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>tx{FindTxForGetData(*tx_relay,<sp/><ref refid="protocol_8cpp_1a3466d64f79e3865dc16910ed3d1ba3d8" kindref="member">ToGenTxid</ref>(inv))})<sp/>{</highlight></codeline>
<codeline lineno="2418"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>WTX<sp/>and<sp/>WITNESS_TX<sp/>imply<sp/>we<sp/>serialize<sp/>with<sp/>witness</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>maybe_with_witness<sp/>=<sp/>(inv.<ref refid="class_c_inv_1a44141828f1bea7793381c5be37e9b828" kindref="member">IsMsgTx</ref>()<sp/>?<sp/>TX_NO_WITNESS<sp/>:<sp/>TX_WITH_WITNESS);</highlight></codeline>
<codeline lineno="2420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a737a463566994e29c65ef40499762be7" kindref="member">NetMsgType::TX</ref>,<sp/>maybe_with_witness(*tx));</highlight></codeline>
<codeline lineno="2421"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_mempool.<ref refid="class_c_tx_mem_pool_1a7252105274f9b0e060438692de785a8c" kindref="member">RemoveUnbroadcastTx</ref>(tx-&gt;GetHash());</highlight></codeline>
<codeline lineno="2422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2423"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vNotFound.push_back(inv);</highlight></codeline>
<codeline lineno="2424"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2425"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2426"><highlight class="normal"></highlight></codeline>
<codeline lineno="2427"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>process<sp/>one<sp/>BLOCK<sp/>item<sp/>per<sp/>call,<sp/>since<sp/>they&apos;re<sp/>uncommon<sp/>and<sp/>can<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2428"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>expensive<sp/>to<sp/>process.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2429"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>!=<sp/>peer.m_getdata_requests.end()<sp/>&amp;&amp;<sp/>!pfrom.<ref refid="class_c_node_1a0d7c1f3172d1da877e15031b02b54133" kindref="member">fPauseSend</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CInv<sp/>&amp;inv<sp/>=<sp/>*it++;</highlight></codeline>
<codeline lineno="2431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(inv.<ref refid="class_c_inv_1a53c3f59172506681678fbd4e866b1762" kindref="member">IsGenBlkMsg</ref>())<sp/>{</highlight></codeline>
<codeline lineno="2432"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ProcessGetBlockData(pfrom,<sp/>peer,<sp/>inv);</highlight></codeline>
<codeline lineno="2433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2434"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>else:<sp/>If<sp/>the<sp/>first<sp/>item<sp/>on<sp/>the<sp/>queue<sp/>is<sp/>an<sp/>unknown<sp/>type,<sp/>we<sp/>erase<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2435"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>continue<sp/>processing<sp/>the<sp/>queue<sp/>on<sp/>the<sp/>next<sp/>call.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2436"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>NOTE:<sp/>previously<sp/>we<sp/>wouldn&apos;t<sp/>do<sp/>so<sp/>and<sp/>the<sp/>peer<sp/>sending<sp/>us<sp/>a<sp/>malformed<sp/>GETDATA<sp/>could</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2437"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>result<sp/>in<sp/>never<sp/>making<sp/>progress<sp/>and<sp/>this<sp/>thread<sp/>using<sp/>100%<sp/>allocated<sp/>CPU.<sp/>See</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2438"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>https://bitcoincore.org/en/2024/07/03/disclose-getdata-cpu.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2439"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2440"><highlight class="normal"></highlight></codeline>
<codeline lineno="2441"><highlight class="normal"><sp/><sp/><sp/><sp/>peer.m_getdata_requests.erase(peer.m_getdata_requests.begin(),<sp/>it);</highlight></codeline>
<codeline lineno="2442"><highlight class="normal"></highlight></codeline>
<codeline lineno="2443"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!vNotFound.empty())<sp/>{</highlight></codeline>
<codeline lineno="2444"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Let<sp/>the<sp/>peer<sp/>know<sp/>that<sp/>we<sp/>didn&apos;t<sp/>find<sp/>what<sp/>it<sp/>asked<sp/>for,<sp/>so<sp/>it<sp/>doesn&apos;t</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2445"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>have<sp/>to<sp/>wait<sp/>around<sp/>forever.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2446"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>SPV<sp/>clients<sp/>care<sp/>about<sp/>this<sp/>message:<sp/>it&apos;s<sp/>needed<sp/>when<sp/>they<sp/>are</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2447"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>recursively<sp/>walking<sp/>the<sp/>dependencies<sp/>of<sp/>relevant<sp/>unconfirmed</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2448"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transactions.<sp/>SPV<sp/>clients<sp/>want<sp/>to<sp/>do<sp/>that<sp/>because<sp/>they<sp/>want<sp/>to<sp/>know</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2449"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>about<sp/>(and<sp/>store<sp/>and<sp/>rebroadcast<sp/>and<sp/>risk<sp/>analyze)<sp/>the<sp/>dependencies</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2450"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>of<sp/>transactions<sp/>relevant<sp/>to<sp/>them,<sp/>without<sp/>having<sp/>to<sp/>download<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>entire<sp/>memory<sp/>pool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2452"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Also,<sp/>other<sp/>nodes<sp/>can<sp/>use<sp/>these<sp/>messages<sp/>to<sp/>automatically<sp/>request<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2453"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transaction<sp/>from<sp/>some<sp/>other<sp/>peer<sp/>that<sp/>announced<sp/>it,<sp/>and<sp/>stop</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>waiting<sp/>for<sp/>us<sp/>to<sp/>respond.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2455"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>In<sp/>normal<sp/>operation,<sp/>we<sp/>often<sp/>send<sp/>NOTFOUND<sp/>messages<sp/>for<sp/>parents<sp/>of</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2456"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transactions<sp/>that<sp/>we<sp/>relay;<sp/>if<sp/>a<sp/>peer<sp/>is<sp/>missing<sp/>a<sp/>parent,<sp/>they<sp/>may</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2457"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>assume<sp/>we<sp/>have<sp/>them<sp/>and<sp/>request<sp/>the<sp/>parents<sp/>from<sp/>us.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2458"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a971a91e1a9757b280d32452dbdcccddc" kindref="member">NetMsgType::NOTFOUND</ref>,<sp/>vNotFound);</highlight></codeline>
<codeline lineno="2459"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2460"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2461"><highlight class="normal"></highlight></codeline>
<codeline lineno="2462"><highlight class="normal">uint32_t<sp/>PeerManagerImpl::GetFetchFlags(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Peer&amp;<sp/>peer)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="2463"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="2464"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>nFetchFlags<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="2465"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(CanServeWitnesses(peer))<sp/>{</highlight></codeline>
<codeline lineno="2466"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nFetchFlags<sp/>|=<sp/><ref refid="protocol_8h_1a706dc5bf653ca632edd8d08fa81c1073" kindref="member">MSG_WITNESS_FLAG</ref>;</highlight></codeline>
<codeline lineno="2467"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2468"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>nFetchFlags;</highlight></codeline>
<codeline lineno="2469"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2470"><highlight class="normal"></highlight></codeline>
<codeline lineno="2471"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::SendBlockTransactions(CNode&amp;<sp/>pfrom,<sp/>Peer&amp;<sp/>peer,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlock&amp;<sp/>block,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BlockTransactionsRequest&amp;<sp/>req)</highlight></codeline>
<codeline lineno="2472"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2473"><highlight class="normal"><sp/><sp/><sp/><sp/>BlockTransactions<sp/>resp(req);</highlight></codeline>
<codeline lineno="2474"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>tx_requested_size<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="2475"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>req.<ref refid="class_block_transactions_request_1af2b570488d7bd913bdcc2734a813b9eb" kindref="member">indexes</ref>.size();<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="2476"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(req.<ref refid="class_block_transactions_request_1af2b570488d7bd913bdcc2734a813b9eb" kindref="member">indexes</ref>[i]<sp/>&gt;=<sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>.size())<sp/>{</highlight></codeline>
<codeline lineno="2477"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Misbehaving(peer,<sp/></highlight><highlight class="stringliteral">&quot;getblocktxn<sp/>with<sp/>out-of-bounds<sp/>tx<sp/>indices&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2478"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2479"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2480"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>resp.txn[i]<sp/>=<sp/>block.<ref refid="class_c_block_1a099273d5360f67b96bf7e9ce5729b0bb" kindref="member">vtx</ref>[req.<ref refid="class_block_transactions_request_1af2b570488d7bd913bdcc2734a813b9eb" kindref="member">indexes</ref>[i]];</highlight></codeline>
<codeline lineno="2481"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_requested_size<sp/>+=<sp/>resp.txn[i]-&gt;GetTotalSize();</highlight></codeline>
<codeline lineno="2482"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2483"><highlight class="normal"></highlight></codeline>
<codeline lineno="2484"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a732f85a165d0fa3c97bc3e572dffa096" kindref="member">BCLog::CMPCTBLOCK</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Peer<sp/>%d<sp/>sent<sp/>us<sp/>a<sp/>GETBLOCKTXN<sp/>for<sp/>block<sp/>%s,<sp/>sending<sp/>a<sp/>BLOCKTXN<sp/>with<sp/>%u<sp/>txns.<sp/>(%u<sp/>bytes)\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>block.<ref refid="class_c_block_header_1a6df30b63c4634d52dfeaadb46d60d0f5" kindref="member">GetHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>resp.txn.size(),<sp/>tx_requested_size);</highlight></codeline>
<codeline lineno="2485"><highlight class="normal"><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a0168b12bb13a2b8c2100050c86273cb6" kindref="member">NetMsgType::BLOCKTXN</ref>,<sp/>resp);</highlight></codeline>
<codeline lineno="2486"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2487"><highlight class="normal"></highlight></codeline>
<codeline lineno="2488"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::CheckHeadersPoW(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;CBlockHeader&gt;&amp;<sp/>headers,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Consensus::Params&amp;<sp/>consensusParams,<sp/>Peer&amp;<sp/>peer)</highlight></codeline>
<codeline lineno="2489"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2490"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Do<sp/>these<sp/>headers<sp/>have<sp/>proof-of-work<sp/>matching<sp/>what&apos;s<sp/>claimed?</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2491"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="validation_8cpp_1a600cde3b7d04dc488eec00d290931db7" kindref="member">HasValidProofOfWork</ref>(headers,<sp/>consensusParams))<sp/>{</highlight></codeline>
<codeline lineno="2492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Misbehaving(peer,<sp/></highlight><highlight class="stringliteral">&quot;header<sp/>with<sp/>invalid<sp/>proof<sp/>of<sp/>work&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2494"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2495"><highlight class="normal"></highlight></codeline>
<codeline lineno="2496"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Are<sp/>these<sp/>headers<sp/>connected<sp/>to<sp/>each<sp/>other?</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2497"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!CheckHeadersAreContinuous(headers))<sp/>{</highlight></codeline>
<codeline lineno="2498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Misbehaving(peer,<sp/></highlight><highlight class="stringliteral">&quot;non-continuous<sp/>headers<sp/>sequence&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2500"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2501"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2502"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2503"><highlight class="normal"></highlight></codeline>
<codeline lineno="2504"><highlight class="normal">arith_uint256<sp/>PeerManagerImpl::GetAntiDoSWorkThreshold()</highlight></codeline>
<codeline lineno="2505"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2506"><highlight class="normal"><sp/><sp/><sp/><sp/>arith_uint256<sp/>near_chaintip_work<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="2507"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="2508"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>()<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="2509"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex<sp/>*tip<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>();</highlight></codeline>
<codeline lineno="2510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Use<sp/>a<sp/>144<sp/>block<sp/>buffer,<sp/>so<sp/>that<sp/>we&apos;ll<sp/>accept<sp/>headers<sp/>that<sp/>fork<sp/>from</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>near<sp/>our<sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>near_chaintip_work<sp/>=<sp/>tip-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>-<sp/>std::min&lt;arith_uint256&gt;(144*<ref refid="chain_8cpp_1a334aa8015cc7185f7fdf484783e40f38" kindref="member">GetBlockProof</ref>(*tip),<sp/>tip-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref>);</highlight></codeline>
<codeline lineno="2513"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2514"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::max(near_chaintip_work,<sp/>m_chainman.<ref refid="class_chainstate_manager_1af6689b42eea6a15ba7e5409ea374cdb4" kindref="member">MinimumChainWork</ref>());</highlight></codeline>
<codeline lineno="2515"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2516"><highlight class="normal"></highlight></codeline>
<codeline lineno="2523"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::HandleUnconnectingHeaders(CNode&amp;<sp/>pfrom,<sp/>Peer&amp;<sp/>peer,</highlight></codeline>
<codeline lineno="2524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;CBlockHeader&gt;&amp;<sp/>headers)</highlight></codeline>
<codeline lineno="2525"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2526"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Try<sp/>to<sp/>fill<sp/>in<sp/>the<sp/>missing<sp/>headers.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2527"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>best_header{<ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>m_chainman.m_best_header)};</highlight></codeline>
<codeline lineno="2528"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(MaybeSendGetHeaders(pfrom,<sp/><ref refid="chain_8cpp_1a6f7cb8de33a43e97b3dd7517998379bc" kindref="member">GetLocator</ref>(best_header),<sp/>peer))<sp/>{</highlight></codeline>
<codeline lineno="2529"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;received<sp/>header<sp/>%s:<sp/>missing<sp/>prev<sp/>block<sp/>%s,<sp/>sending<sp/>getheaders<sp/>(%d)<sp/>to<sp/>end<sp/>(peer=%d)\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2530"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>headers[0].GetHash().<ref refid="bitcoin-cli_8cpp_1aec2c30b1707eac00ff7e4fb5b3f7a92d" kindref="member">ToString</ref>(),</highlight></codeline>
<codeline lineno="2531"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>headers[0].hashPrevBlock.ToString(),</highlight></codeline>
<codeline lineno="2532"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>best_header-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,</highlight></codeline>
<codeline lineno="2533"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="2534"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2535"><highlight class="normal"></highlight></codeline>
<codeline lineno="2536"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Set<sp/>hashLastUnknownBlock<sp/>for<sp/>this<sp/>peer,<sp/>so<sp/>that<sp/>if<sp/>we</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2537"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>eventually<sp/>get<sp/>the<sp/>headers<sp/>-<sp/>even<sp/>from<sp/>a<sp/>different<sp/>peer<sp/>-</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2538"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>can<sp/>use<sp/>this<sp/>peer<sp/>to<sp/>download.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2539"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>UpdateBlockAvailability(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>headers.back().GetHash()));</highlight></codeline>
<codeline lineno="2540"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2541"><highlight class="normal"></highlight></codeline>
<codeline lineno="2542"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::CheckHeadersAreContinuous(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::vector&lt;CBlockHeader&gt;&amp;<sp/>headers)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="2543"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="2544"><highlight class="normal"><sp/><sp/><sp/><sp/>uint256<sp/>hashLastBlock;</highlight></codeline>
<codeline lineno="2545"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockHeader&amp;<sp/>header<sp/>:<sp/>headers)<sp/>{</highlight></codeline>
<codeline lineno="2546"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!hashLastBlock.<ref refid="classbase__blob_1a067b44b9f2bd293d8a93401655e6476e" kindref="member">IsNull</ref>()<sp/>&amp;&amp;<sp/>header.hashPrevBlock<sp/>!=<sp/>hashLastBlock)<sp/>{</highlight></codeline>
<codeline lineno="2547"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2548"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2549"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hashLastBlock<sp/>=<sp/>header.GetHash();</highlight></codeline>
<codeline lineno="2550"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2551"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2552"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2553"><highlight class="normal"></highlight></codeline>
<codeline lineno="2554"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::IsContinuationOfLowWorkHeadersSync(Peer&amp;<sp/>peer,<sp/>CNode&amp;<sp/>pfrom,<sp/>std::vector&lt;CBlockHeader&gt;&amp;<sp/>headers)</highlight></codeline>
<codeline lineno="2555"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2556"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer.m_headers_sync)<sp/>{</highlight></codeline>
<codeline lineno="2557"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>result<sp/>=<sp/>peer.m_headers_sync-&gt;ProcessNextHeaders(headers,<sp/>headers.size()<sp/>==<sp/>m_opts.max_headers_result);</highlight></codeline>
<codeline lineno="2558"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>it<sp/>is<sp/>a<sp/>valid<sp/>continuation,<sp/>we<sp/>should<sp/>treat<sp/>the<sp/>existing<sp/>getheaders<sp/>request<sp/>as<sp/>responded<sp/>to.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2559"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(result.success)<sp/>peer.m_last_getheaders_timestamp<sp/>=<sp/>{};</highlight></codeline>
<codeline lineno="2560"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(result.request_more)<sp/>{</highlight></codeline>
<codeline lineno="2561"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>locator<sp/>=<sp/>peer.m_headers_sync-&gt;NextHeadersRequestLocator();</highlight></codeline>
<codeline lineno="2562"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>were<sp/>instructed<sp/>to<sp/>ask<sp/>for<sp/>a<sp/>locator,<sp/>it<sp/>should<sp/>not<sp/>be<sp/>empty.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2563"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(!locator.vHave.empty());</highlight></codeline>
<codeline lineno="2564"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>can<sp/>only<sp/>be<sp/>instructed<sp/>to<sp/>request<sp/>more<sp/>if<sp/>processing<sp/>was<sp/>successful.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2565"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(result.success);</highlight></codeline>
<codeline lineno="2566"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!locator.vHave.empty())<sp/>{</highlight></codeline>
<codeline lineno="2567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>It<sp/>should<sp/>be<sp/>impossible<sp/>for<sp/>the<sp/>getheaders<sp/>request<sp/>to<sp/>fail,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>because<sp/>we<sp/>just<sp/>cleared<sp/>the<sp/>last<sp/>getheaders<sp/>timestamp.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>sent_getheaders<sp/>=<sp/>MaybeSendGetHeaders(pfrom,<sp/>locator,<sp/>peer);</highlight></codeline>
<codeline lineno="2570"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(sent_getheaders);</highlight></codeline>
<codeline lineno="2571"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;more<sp/>getheaders<sp/>(from<sp/>%s)<sp/>to<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2572"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>locator.vHave.front().ToString(),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="2573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2574"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2575"><highlight class="normal"></highlight></codeline>
<codeline lineno="2576"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer.m_headers_sync-&gt;GetState()<sp/>==<sp/>HeadersSyncState::State::FINAL)<sp/>{</highlight></codeline>
<codeline lineno="2577"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_headers_sync.reset(</highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2578"><highlight class="normal"></highlight></codeline>
<codeline lineno="2579"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Delete<sp/>this<sp/>peer&apos;s<sp/>entry<sp/>in<sp/>m_headers_presync_stats.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2580"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>this<sp/>is<sp/>m_headers_presync_bestpeer,<sp/>it<sp/>will<sp/>be<sp/>replaced<sp/>later</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2581"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>by<sp/>the<sp/>next<sp/>peer<sp/>that<sp/>triggers<sp/>the<sp/>else{}<sp/>branch<sp/>below.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2582"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_headers_presync_mutex);</highlight></codeline>
<codeline lineno="2583"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_headers_presync_stats.erase(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="2584"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2585"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Build<sp/>statistics<sp/>for<sp/>this<sp/>peer&apos;s<sp/>sync.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2586"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>HeadersPresyncStats<sp/>stats;</highlight></codeline>
<codeline lineno="2587"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats.first<sp/>=<sp/>peer.m_headers_sync-&gt;GetPresyncWork();</highlight></codeline>
<codeline lineno="2588"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer.m_headers_sync-&gt;GetState()<sp/>==<sp/>HeadersSyncState::State::PRESYNC)<sp/>{</highlight></codeline>
<codeline lineno="2589"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stats.second<sp/>=<sp/>{peer.m_headers_sync-&gt;GetPresyncHeight(),</highlight></codeline>
<codeline lineno="2590"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_headers_sync-&gt;GetPresyncTime()};</highlight></codeline>
<codeline lineno="2591"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2592"><highlight class="normal"></highlight></codeline>
<codeline lineno="2593"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Update<sp/>statistics<sp/>in<sp/>stats.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2594"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_headers_presync_mutex);</highlight></codeline>
<codeline lineno="2595"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_headers_presync_stats[pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>()]<sp/>=<sp/>stats;</highlight></codeline>
<codeline lineno="2596"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>best_it<sp/>=<sp/>m_headers_presync_stats.find(m_headers_presync_bestpeer);</highlight></codeline>
<codeline lineno="2597"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>best_updated<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2598"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(best_it<sp/>==<sp/>m_headers_presync_stats.end())<sp/>{</highlight></codeline>
<codeline lineno="2599"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>cached<sp/>best<sp/>peer<sp/>is<sp/>outdated,<sp/>iterate<sp/>over<sp/>all<sp/>remaining<sp/>ones<sp/>(including</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2600"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>newly<sp/>updated<sp/>one)<sp/>to<sp/>find<sp/>the<sp/>best<sp/>one.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2601"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>peer_best{-1};</highlight></codeline>
<codeline lineno="2602"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>HeadersPresyncStats*<sp/>stat_best{</highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2603"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>[peer,<sp/>stat]<sp/>:<sp/>m_headers_presync_stats)<sp/>{</highlight></codeline>
<codeline lineno="2604"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!stat_best<sp/>||<sp/>stat<sp/>&gt;<sp/>*stat_best)<sp/>{</highlight></codeline>
<codeline lineno="2605"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer_best<sp/>=<sp/>peer;</highlight></codeline>
<codeline lineno="2606"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stat_best<sp/>=<sp/>&amp;stat;</highlight></codeline>
<codeline lineno="2607"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2608"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2609"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_headers_presync_bestpeer<sp/>=<sp/>peer_best;</highlight></codeline>
<codeline lineno="2610"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>best_updated<sp/>=<sp/>(peer_best<sp/>==<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="2611"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(best_it-&gt;first<sp/>==<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>()<sp/>||<sp/>stats<sp/>&gt;<sp/>best_it-&gt;second)<sp/>{</highlight></codeline>
<codeline lineno="2612"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>pfrom<sp/>was<sp/>and<sp/>remains<sp/>the<sp/>best<sp/>peer,<sp/>or<sp/>pfrom<sp/>just<sp/>became<sp/>best.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2613"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_headers_presync_bestpeer<sp/>=<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>();</highlight></codeline>
<codeline lineno="2614"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>best_updated<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2615"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2616"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(best_updated<sp/>&amp;&amp;<sp/>stats.second.has_value())<sp/>{</highlight></codeline>
<codeline lineno="2617"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>best<sp/>peer<sp/>updated,<sp/>and<sp/>it<sp/>is<sp/>in<sp/>its<sp/>first<sp/>phase,<sp/>signal.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2618"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_headers_presync_should_signal<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2619"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2620"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2621"><highlight class="normal"></highlight></codeline>
<codeline lineno="2622"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(result.success)<sp/>{</highlight></codeline>
<codeline lineno="2623"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>only<sp/>overwrite<sp/>the<sp/>headers<sp/>passed<sp/>in<sp/>if<sp/>processing<sp/>was</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2624"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>successful.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2625"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>headers.swap(result.pow_validated_headers);</highlight></codeline>
<codeline lineno="2626"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2627"><highlight class="normal"></highlight></codeline>
<codeline lineno="2628"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>result.success;</highlight></codeline>
<codeline lineno="2629"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2630"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Either<sp/>we<sp/>didn&apos;t<sp/>have<sp/>a<sp/>sync<sp/>in<sp/>progress,<sp/>or<sp/>something<sp/>went<sp/>wrong</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2631"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>processing<sp/>these<sp/>headers,<sp/>or<sp/>we<sp/>are<sp/>returning<sp/>headers<sp/>to<sp/>the<sp/>caller<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2632"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>process.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2633"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2634"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2635"><highlight class="normal"></highlight></codeline>
<codeline lineno="2636"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::TryLowWorkHeadersSync(Peer&amp;<sp/>peer,<sp/>CNode&amp;<sp/>pfrom,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>chain_start_header,<sp/>std::vector&lt;CBlockHeader&gt;&amp;<sp/>headers)</highlight></codeline>
<codeline lineno="2637"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2638"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Calculate<sp/>the<sp/>claimed<sp/>total<sp/>work<sp/>on<sp/>this<sp/>chain.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2639"><highlight class="normal"><sp/><sp/><sp/><sp/>arith_uint256<sp/>total_work<sp/>=<sp/>chain_start_header-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>+<sp/><ref refid="validation_8cpp_1a805faf00f329288736b407376d6edb7a" kindref="member">CalculateClaimedHeadersWork</ref>(headers);</highlight></codeline>
<codeline lineno="2640"><highlight class="normal"></highlight></codeline>
<codeline lineno="2641"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Our<sp/>dynamic<sp/>anti-DoS<sp/>threshold<sp/>(minimum<sp/>work<sp/>required<sp/>on<sp/>a<sp/>headers<sp/>chain</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2642"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>before<sp/>we&apos;ll<sp/>store<sp/>it)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2643"><highlight class="normal"><sp/><sp/><sp/><sp/>arith_uint256<sp/>minimum_chain_work<sp/>=<sp/>GetAntiDoSWorkThreshold();</highlight></codeline>
<codeline lineno="2644"><highlight class="normal"></highlight></codeline>
<codeline lineno="2645"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Avoid<sp/>DoS<sp/>via<sp/>low-difficulty-headers<sp/>by<sp/>only<sp/>processing<sp/>if<sp/>the<sp/>headers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2646"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>are<sp/>part<sp/>of<sp/>a<sp/>chain<sp/>with<sp/>sufficient<sp/>work.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2647"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(total_work<sp/>&lt;<sp/>minimum_chain_work)<sp/>{</highlight></codeline>
<codeline lineno="2648"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>try<sp/>to<sp/>sync<sp/>with<sp/>this<sp/>peer<sp/>if<sp/>their<sp/>headers<sp/>message<sp/>was<sp/>full;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2649"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>otherwise<sp/>they<sp/>don&apos;t<sp/>have<sp/>more<sp/>headers<sp/>after<sp/>this<sp/>so<sp/>no<sp/>point<sp/>in</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2650"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>trying<sp/>to<sp/>sync<sp/>their<sp/>too-little-work<sp/>chain.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2651"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(headers.size()<sp/>==<sp/>m_opts.max_headers_result)<sp/>{</highlight></codeline>
<codeline lineno="2652"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note:<sp/>we<sp/>could<sp/>advance<sp/>to<sp/>the<sp/>last<sp/>header<sp/>in<sp/>this<sp/>set<sp/>that<sp/>is</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2653"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>known<sp/>to<sp/>us,<sp/>rather<sp/>than<sp/>starting<sp/>at<sp/>the<sp/>first<sp/>header<sp/>(which<sp/>we</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2654"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>may<sp/>already<sp/>have);<sp/>however<sp/>this<sp/>is<sp/>unlikely<sp/>to<sp/>matter<sp/>much<sp/>since</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2655"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ProcessHeadersMessage()<sp/>already<sp/>handles<sp/>the<sp/>case<sp/>where<sp/>all</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2656"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>headers<sp/>in<sp/>a<sp/>received<sp/>message<sp/>are<sp/>already<sp/>known<sp/>and<sp/>are</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2657"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ancestors<sp/>of<sp/>m_best_header<sp/>or<sp/>chainActive.Tip(),<sp/>by<sp/>skipping</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2658"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>this<sp/>logic<sp/>in<sp/>that<sp/>case.<sp/>So<sp/>even<sp/>if<sp/>the<sp/>first<sp/>header<sp/>in<sp/>this<sp/>set</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2659"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>of<sp/>headers<sp/>is<sp/>known,<sp/>some<sp/>header<sp/>in<sp/>this<sp/>set<sp/>must<sp/>be<sp/>new,<sp/>so</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2660"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>advancing<sp/>to<sp/>the<sp/>first<sp/>unknown<sp/>header<sp/>would<sp/>be<sp/>a<sp/>small<sp/>effect.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2661"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(peer.m_headers_sync_mutex);</highlight></codeline>
<codeline lineno="2662"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_headers_sync.reset(</highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>HeadersSyncState(peer.m_id,<sp/>m_chainparams.<ref refid="class_c_chain_params_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>(),</highlight></codeline>
<codeline lineno="2663"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_chainparams.<ref refid="class_c_chain_params_1acea908bce3955ce8bde4f0dd1038a149" kindref="member">HeadersSync</ref>(),<sp/>chain_start_header,<sp/>minimum_chain_work));</highlight></codeline>
<codeline lineno="2664"><highlight class="normal"></highlight></codeline>
<codeline lineno="2665"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Now<sp/>a<sp/>HeadersSyncState<sp/>object<sp/>for<sp/>tracking<sp/>this<sp/>synchronization</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2666"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>is<sp/>created,<sp/>process<sp/>the<sp/>headers<sp/>using<sp/>it<sp/>as<sp/>normal.<sp/>Failures<sp/>are</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2667"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>handled<sp/>inside<sp/>of<sp/>IsContinuationOfLowWorkHeadersSync.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2668"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(void)IsContinuationOfLowWorkHeadersSync(peer,<sp/>pfrom,<sp/>headers);</highlight></codeline>
<codeline lineno="2669"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2670"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Ignoring<sp/>low-work<sp/>chain<sp/>(height=%u)<sp/>from<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>chain_start_header-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>+<sp/>headers.size(),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="2671"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2672"><highlight class="normal"></highlight></codeline>
<codeline lineno="2673"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>peer<sp/>has<sp/>not<sp/>yet<sp/>given<sp/>us<sp/>a<sp/>chain<sp/>that<sp/>meets<sp/>our<sp/>work<sp/>threshold,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2674"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>so<sp/>we<sp/>want<sp/>to<sp/>prevent<sp/>further<sp/>processing<sp/>of<sp/>the<sp/>headers<sp/>in<sp/>any<sp/>case.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>headers<sp/>=<sp/>{};</highlight></codeline>
<codeline lineno="2676"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2677"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2678"><highlight class="normal"></highlight></codeline>
<codeline lineno="2679"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2680"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2681"><highlight class="normal"></highlight></codeline>
<codeline lineno="2682"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::IsAncestorOfBestHeaderOrTip(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>header)</highlight></codeline>
<codeline lineno="2683"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2684"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(header<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="2685"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2686"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.m_best_header<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>header<sp/>==<sp/>m_chainman.m_best_header-&gt;GetAncestor(header-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>))<sp/>{</highlight></codeline>
<codeline lineno="2687"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2688"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a78c557b8d1209a61416487a99a7808a9" kindref="member">Contains</ref>(header))<sp/>{</highlight></codeline>
<codeline lineno="2689"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2690"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2691"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2692"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2693"><highlight class="normal"></highlight></codeline>
<codeline lineno="2694"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::MaybeSendGetHeaders(CNode&amp;<sp/>pfrom,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockLocator&amp;<sp/>locator,<sp/>Peer&amp;<sp/>peer)</highlight></codeline>
<codeline lineno="2695"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2696"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>current_time<sp/>=<sp/><ref refid="struct_node_clock_1a1be2fa9903731211253f2e36b5f3b584" kindref="member">NodeClock::now</ref>();</highlight></codeline>
<codeline lineno="2697"><highlight class="normal"></highlight></codeline>
<codeline lineno="2698"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>allow<sp/>a<sp/>new<sp/>getheaders<sp/>message<sp/>to<sp/>go<sp/>out<sp/>if<sp/>we<sp/>don&apos;t<sp/>have<sp/>a<sp/>recent</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2699"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>one<sp/>already<sp/>in-flight</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2700"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(current_time<sp/>-<sp/>peer.m_last_getheaders_timestamp<sp/>&gt;<sp/>HEADERS_RESPONSE_TIME)<sp/>{</highlight></codeline>
<codeline lineno="2701"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a5c1eff22535aa79a2bc54ba481b753fb" kindref="member">NetMsgType::GETHEADERS</ref>,<sp/>locator,<sp/>uint256());</highlight></codeline>
<codeline lineno="2702"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_last_getheaders_timestamp<sp/>=<sp/>current_time;</highlight></codeline>
<codeline lineno="2703"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2704"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2705"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2706"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2707"><highlight class="normal"></highlight></codeline>
<codeline lineno="2708"><highlight class="normal"></highlight><highlight class="comment">/*</highlight></codeline>
<codeline lineno="2709"><highlight class="comment"><sp/>*<sp/>Given<sp/>a<sp/>new<sp/>headers<sp/>tip<sp/>ending<sp/>in<sp/>last_header,<sp/>potentially<sp/>request<sp/>blocks<sp/>towards<sp/>that<sp/>tip.</highlight></codeline>
<codeline lineno="2710"><highlight class="comment"><sp/>*<sp/>We<sp/>require<sp/>that<sp/>the<sp/>given<sp/>tip<sp/>have<sp/>at<sp/>least<sp/>as<sp/>much<sp/>work<sp/>as<sp/>our<sp/>tip,<sp/>and<sp/>for</highlight></codeline>
<codeline lineno="2711"><highlight class="comment"><sp/>*<sp/>our<sp/>current<sp/>tip<sp/>to<sp/>be<sp/>&quot;close<sp/>to<sp/>synced&quot;<sp/>(see<sp/>CanDirectFetch()).</highlight></codeline>
<codeline lineno="2712"><highlight class="comment"><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2713"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::HeadersDirectFetchBlocks(CNode&amp;<sp/>pfrom,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Peer&amp;<sp/>peer,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex&amp;<sp/>last_header)</highlight></codeline>
<codeline lineno="2714"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2715"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="2716"><highlight class="normal"><sp/><sp/><sp/><sp/>CNodeState<sp/>*nodestate<sp/>=<sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="2717"><highlight class="normal"></highlight></codeline>
<codeline lineno="2718"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(CanDirectFetch()<sp/>&amp;&amp;<sp/>last_header.<ref refid="class_c_block_index_1a1b5a636925d1c416b9d59eb0392a7a62" kindref="member">IsValid</ref>(<ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada67f3a88eeb793cc62f427f87ae830573" kindref="member">BLOCK_VALID_TREE</ref>)<sp/>&amp;&amp;<sp/>m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>()-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&lt;=<sp/>last_header.<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2719"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;const<sp/>CBlockIndex*&gt;<sp/>vToFetch;</highlight></codeline>
<codeline lineno="2720"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindexWalk{&amp;last_header};</highlight></codeline>
<codeline lineno="2721"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Calculate<sp/>all<sp/>the<sp/>blocks<sp/>we&apos;d<sp/>need<sp/>to<sp/>switch<sp/>to<sp/>last_header,<sp/>up<sp/>to<sp/>a<sp/>limit.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2722"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(pindexWalk<sp/>&amp;&amp;<sp/>!m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a78c557b8d1209a61416487a99a7808a9" kindref="member">Contains</ref>(pindexWalk)<sp/>&amp;&amp;<sp/>vToFetch.size()<sp/>&lt;=<sp/>MAX_BLOCKS_IN_TRANSIT_PER_PEER)<sp/>{</highlight></codeline>
<codeline lineno="2723"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!(pindexWalk-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15" kindref="member">BLOCK_HAVE_DATA</ref>)<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="2724"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!IsBlockRequested(pindexWalk-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>())<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="2725"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(!<ref refid="deploymentstatus_8h_1af313e9a747786adc5b5f3fc8e4e1a3fe" kindref="member">DeploymentActiveAt</ref>(*pindexWalk,<sp/>m_chainman,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dbac12a10e827db62556122f2b1a9b0431b" kindref="member">Consensus::DEPLOYMENT_SEGWIT</ref>)<sp/>||<sp/>CanServeWitnesses(peer)))<sp/>{</highlight></codeline>
<codeline lineno="2726"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>don&apos;t<sp/>have<sp/>this<sp/>block,<sp/>and<sp/>it&apos;s<sp/>not<sp/>yet<sp/>in<sp/>flight.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2727"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vToFetch.push_back(pindexWalk);</highlight></codeline>
<codeline lineno="2728"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2729"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexWalk<sp/>=<sp/>pindexWalk-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>;</highlight></codeline>
<codeline lineno="2730"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2731"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>pindexWalk<sp/>still<sp/>isn&apos;t<sp/>on<sp/>our<sp/>main<sp/>chain,<sp/>we&apos;re<sp/>looking<sp/>at<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2732"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>very<sp/>large<sp/>reorg<sp/>at<sp/>a<sp/>time<sp/>we<sp/>think<sp/>we&apos;re<sp/>close<sp/>to<sp/>caught<sp/>up<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2733"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>main<sp/>chain<sp/>--<sp/>this<sp/>shouldn&apos;t<sp/>really<sp/>happen.<sp/><sp/>Bail<sp/>out<sp/>on<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2734"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>direct<sp/>fetch<sp/>and<sp/>rely<sp/>on<sp/>parallel<sp/>download<sp/>instead.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2735"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a78c557b8d1209a61416487a99a7808a9" kindref="member">Contains</ref>(pindexWalk))<sp/>{</highlight></codeline>
<codeline lineno="2736"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Large<sp/>reorg,<sp/>won&apos;t<sp/>direct<sp/>fetch<sp/>to<sp/>%s<sp/>(%d)\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2737"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>last_header.<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),</highlight></codeline>
<codeline lineno="2738"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>last_header.<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>);</highlight></codeline>
<codeline lineno="2739"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="2740"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CInv&gt;<sp/>vGetData;</highlight></codeline>
<codeline lineno="2741"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Download<sp/>as<sp/>much<sp/>as<sp/>possible,<sp/>from<sp/>earliest<sp/>to<sp/>latest.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2742"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindex<sp/>:<sp/>vToFetch<sp/>|<sp/>std::views::reverse)<sp/>{</highlight></codeline>
<codeline lineno="2743"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nodestate-&gt;vBlocksInFlight.size()<sp/>&gt;=<sp/>MAX_BLOCKS_IN_TRANSIT_PER_PEER)<sp/>{</highlight></codeline>
<codeline lineno="2744"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Can&apos;t<sp/>download<sp/>any<sp/>more<sp/>from<sp/>this<sp/>peer</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2745"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2746"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2747"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>nFetchFlags<sp/>=<sp/>GetFetchFlags(peer);</highlight></codeline>
<codeline lineno="2748"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vGetData.emplace_back(<ref refid="protocol_8h_1ac1162efdf35b533ba996ac9d1c96fc05a4cae15fd207d555331995cd5c57689c1" kindref="member">MSG_BLOCK</ref><sp/>|<sp/>nFetchFlags,<sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>());</highlight></codeline>
<codeline lineno="2749"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BlockRequested(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>*pindex);</highlight></codeline>
<codeline lineno="2750"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Requesting<sp/>block<sp/>%s<sp/>from<sp/><sp/>peer=%d\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2751"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="2752"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2753"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vGetData.size()<sp/>&gt;<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="2754"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Downloading<sp/>blocks<sp/>toward<sp/>%s<sp/>(%d)<sp/>via<sp/>headers<sp/>direct<sp/>fetch\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2755"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>last_header.<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),</highlight></codeline>
<codeline lineno="2756"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>last_header.<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>);</highlight></codeline>
<codeline lineno="2757"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2758"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vGetData.size()<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2759"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_opts.ignore_incoming_txs<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="2760"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nodestate-&gt;m_provides_cmpctblocks<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="2761"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vGetData.size()<sp/>==<sp/>1<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="2762"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mapBlocksInFlight.size()<sp/>==<sp/>1<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="2763"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>last_header.<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>-&gt;<ref refid="class_c_block_index_1a1b5a636925d1c416b9d59eb0392a7a62" kindref="member">IsValid</ref>(<ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada00332fcf52dbd55990d8ff86b616bc65" kindref="member">BLOCK_VALID_CHAIN</ref>))<sp/>{</highlight></codeline>
<codeline lineno="2764"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>In<sp/>any<sp/>case,<sp/>we<sp/>want<sp/>to<sp/>download<sp/>using<sp/>a<sp/>compact<sp/>block,<sp/>not<sp/>a<sp/>regular<sp/>one</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2765"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vGetData[0]<sp/>=<sp/>CInv(<ref refid="protocol_8h_1ac1162efdf35b533ba996ac9d1c96fc05a78b9ead22ca5cae07b98370ffab06abc" kindref="member">MSG_CMPCT_BLOCK</ref>,<sp/>vGetData[0].hash);</highlight></codeline>
<codeline lineno="2766"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2767"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a18544277034744dbf6f85e748835ecfe" kindref="member">NetMsgType::GETDATA</ref>,<sp/>vGetData);</highlight></codeline>
<codeline lineno="2768"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2769"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2770"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2771"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2772"><highlight class="normal"></highlight></codeline>
<codeline lineno="2778"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::UpdatePeerStateForReceivedHeaders(CNode&amp;<sp/>pfrom,<sp/>Peer&amp;<sp/>peer,</highlight></codeline>
<codeline lineno="2779"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex&amp;<sp/>last_header,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>received_new_header,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>may_have_more_headers)</highlight></codeline>
<codeline lineno="2780"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2781"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="2782"><highlight class="normal"><sp/><sp/><sp/><sp/>CNodeState<sp/>*nodestate<sp/>=<sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="2783"><highlight class="normal"></highlight></codeline>
<codeline lineno="2784"><highlight class="normal"><sp/><sp/><sp/><sp/>UpdateBlockAvailability(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>last_header.<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>());</highlight></codeline>
<codeline lineno="2785"><highlight class="normal"></highlight></codeline>
<codeline lineno="2786"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>From<sp/>here,<sp/>pindexBestKnownBlock<sp/>should<sp/>be<sp/>guaranteed<sp/>to<sp/>be<sp/>non-null,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2787"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>because<sp/>it<sp/>is<sp/>set<sp/>in<sp/>UpdateBlockAvailability.<sp/>Some<sp/>nullptr<sp/>checks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2788"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>are<sp/>still<sp/>present,<sp/>however,<sp/>as<sp/>belt-and-suspenders.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2789"><highlight class="normal"></highlight></codeline>
<codeline lineno="2790"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(received_new_header<sp/>&amp;&amp;<sp/>last_header.<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&gt;<sp/>m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>()-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2791"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nodestate-&gt;m_last_block_announcement<sp/>=<sp/><ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime</ref>();</highlight></codeline>
<codeline lineno="2792"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2793"><highlight class="normal"></highlight></codeline>
<codeline lineno="2794"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we&apos;re<sp/>in<sp/>IBD,<sp/>we<sp/>want<sp/>outbound<sp/>peers<sp/>that<sp/>will<sp/>serve<sp/>us<sp/>a<sp/>useful</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2795"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>chain.<sp/>Disconnect<sp/>peers<sp/>that<sp/>are<sp/>on<sp/>chains<sp/>with<sp/>insufficient<sp/>work.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2796"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.<ref refid="class_chainstate_manager_1a312bb1a2008bae3205f4699b90880d66" kindref="member">IsInitialBlockDownload</ref>()<sp/>&amp;&amp;<sp/>!may_have_more_headers)<sp/>{</highlight></codeline>
<codeline lineno="2797"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>peer<sp/>has<sp/>no<sp/>more<sp/>headers<sp/>to<sp/>give<sp/>us,<sp/>then<sp/>we<sp/>know<sp/>we<sp/>have</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2798"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>their<sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2799"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nodestate-&gt;pindexBestKnownBlock<sp/>&amp;&amp;<sp/>nodestate-&gt;pindexBestKnownBlock-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&lt;<sp/>m_chainman.<ref refid="class_chainstate_manager_1af6689b42eea6a15ba7e5409ea374cdb4" kindref="member">MinimumChainWork</ref>())<sp/>{</highlight></codeline>
<codeline lineno="2800"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>peer<sp/>has<sp/>too<sp/>little<sp/>work<sp/>on<sp/>their<sp/>headers<sp/>chain<sp/>to<sp/>help</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2801"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>us<sp/>sync<sp/>--<sp/>disconnect<sp/>if<sp/>it<sp/>is<sp/>an<sp/>outbound<sp/>disconnection</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2802"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>candidate.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2803"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note:<sp/>We<sp/>compare<sp/>their<sp/>tip<sp/>to<sp/>the<sp/>minimum<sp/>chain<sp/>work<sp/>(rather<sp/>than</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2804"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>m_chainman.ActiveChain().Tip())<sp/>because<sp/>we<sp/>won&apos;t<sp/>start<sp/>block<sp/>download</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2805"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>until<sp/>we<sp/>have<sp/>a<sp/>headers<sp/>chain<sp/>that<sp/>has<sp/>at<sp/>least</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2806"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>minimum<sp/>chain<sp/>work,<sp/>even<sp/>if<sp/>a<sp/>peer<sp/>has<sp/>a<sp/>chain<sp/>past<sp/>our<sp/>tip,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2807"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>as<sp/>an<sp/>anti-DoS<sp/>measure.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2808"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1a9a98751838e41cb1a4a8b1919ef4a167" kindref="member">IsOutboundOrBlockRelayConn</ref>())<sp/>{</highlight></codeline>
<codeline lineno="2809"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;outbound<sp/>peer<sp/>headers<sp/>chain<sp/>has<sp/>insufficient<sp/>work,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="2810"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2811"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2812"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2813"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2814"><highlight class="normal"></highlight></codeline>
<codeline lineno="2815"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>this<sp/>is<sp/>an<sp/>outbound<sp/>full-relay<sp/>peer,<sp/>check<sp/>to<sp/>see<sp/>if<sp/>we<sp/>should<sp/>protect</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2816"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>it<sp/>from<sp/>the<sp/>bad/lagging<sp/>chain<sp/>logic.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2817"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note<sp/>that<sp/>outbound<sp/>block-relay<sp/>peers<sp/>are<sp/>excluded<sp/>from<sp/>this<sp/>protection,<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2818"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>thus<sp/>always<sp/>subject<sp/>to<sp/>eviction<sp/>under<sp/>the<sp/>bad/lagging<sp/>chain<sp/>logic.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2819"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>See<sp/>ChainSyncTimeoutState.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2820"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>&amp;&amp;<sp/>pfrom.<ref refid="class_c_node_1a9d84c3968942baa4d097b52ebcaf6ad2" kindref="member">IsFullOutboundConn</ref>()<sp/>&amp;&amp;<sp/>nodestate-&gt;pindexBestKnownBlock<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="2821"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_outbound_peers_with_protect_from_disconnect<sp/>&lt;<sp/>MAX_OUTBOUND_PEERS_TO_PROTECT_FROM_DISCONNECT<sp/>&amp;&amp;<sp/>nodestate-&gt;pindexBestKnownBlock-&gt;nChainWork<sp/>&gt;=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>()-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&amp;&amp;<sp/>!nodestate-&gt;m_chain_sync.m_protect)<sp/>{</highlight></codeline>
<codeline lineno="2822"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Protecting<sp/>outbound<sp/>peer=%d<sp/>from<sp/>eviction\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="2823"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nodestate-&gt;m_chain_sync.m_protect<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2824"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++m_outbound_peers_with_protect_from_disconnect;</highlight></codeline>
<codeline lineno="2825"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2826"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2827"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2828"><highlight class="normal"></highlight></codeline>
<codeline lineno="2829"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::ProcessHeadersMessage(CNode&amp;<sp/>pfrom,<sp/>Peer&amp;<sp/>peer,</highlight></codeline>
<codeline lineno="2830"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CBlockHeader&gt;&amp;&amp;<sp/>headers,</highlight></codeline>
<codeline lineno="2831"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>via_compact_block)</highlight></codeline>
<codeline lineno="2832"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2833"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>nCount<sp/>=<sp/>headers.size();</highlight></codeline>
<codeline lineno="2834"><highlight class="normal"></highlight></codeline>
<codeline lineno="2835"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nCount<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="2836"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Nothing<sp/>interesting.<sp/>Stop<sp/>asking<sp/>this<sp/>peers<sp/>for<sp/>more<sp/>headers.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2837"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>were<sp/>in<sp/>the<sp/>middle<sp/>of<sp/>headers<sp/>sync,<sp/>receiving<sp/>an<sp/>empty<sp/>headers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2838"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>message<sp/>suggests<sp/>that<sp/>the<sp/>peer<sp/>suddenly<sp/>has<sp/>nothing<sp/>to<sp/>give<sp/>us</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2839"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(perhaps<sp/>it<sp/>reorged<sp/>to<sp/>our<sp/>chain).<sp/>Clear<sp/>download<sp/>state<sp/>for<sp/>this<sp/>peer.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2840"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(peer.m_headers_sync_mutex);</highlight></codeline>
<codeline lineno="2841"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer.m_headers_sync)<sp/>{</highlight></codeline>
<codeline lineno="2842"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_headers_sync.reset(</highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2843"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_headers_presync_mutex);</highlight></codeline>
<codeline lineno="2844"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_headers_presync_stats.erase(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="2845"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2846"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>A<sp/>headers<sp/>message<sp/>with<sp/>no<sp/>headers<sp/>cannot<sp/>be<sp/>an<sp/>announcement,<sp/>so<sp/>assume</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2847"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>it<sp/>is<sp/>a<sp/>response<sp/>to<sp/>our<sp/>last<sp/>getheaders<sp/>request,<sp/>if<sp/>there<sp/>is<sp/>one.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2848"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_last_getheaders_timestamp<sp/>=<sp/>{};</highlight></codeline>
<codeline lineno="2849"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2850"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2851"><highlight class="normal"></highlight></codeline>
<codeline lineno="2852"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Before<sp/>we<sp/>do<sp/>any<sp/>processing,<sp/>make<sp/>sure<sp/>these<sp/>pass<sp/>basic<sp/>sanity<sp/>checks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2853"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We&apos;ll<sp/>rely<sp/>on<sp/>headers<sp/>having<sp/>valid<sp/>proof-of-work<sp/>further<sp/>down,<sp/>as<sp/>an</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2854"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>anti-DoS<sp/>criteria<sp/>(note:<sp/>this<sp/>check<sp/>is<sp/>required<sp/>before<sp/>passing<sp/>any</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2855"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>headers<sp/>into<sp/>HeadersSyncState).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2856"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!CheckHeadersPoW(headers,<sp/>m_chainparams.<ref refid="class_c_chain_params_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>(),<sp/>peer))<sp/>{</highlight></codeline>
<codeline lineno="2857"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Misbehaving()<sp/>calls<sp/>are<sp/>handled<sp/>within<sp/>CheckHeadersPoW(),<sp/>so<sp/>we<sp/>can</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2858"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>just<sp/>return.<sp/>(Note<sp/>that<sp/>even<sp/>if<sp/>a<sp/>header<sp/>is<sp/>announced<sp/>via<sp/>compact</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2859"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>block,<sp/>the<sp/>header<sp/>itself<sp/>should<sp/>be<sp/>valid,<sp/>so<sp/>this<sp/>type<sp/>of<sp/>error<sp/>can</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2860"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>always<sp/>be<sp/>punished.)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2861"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2862"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2863"><highlight class="normal"></highlight></codeline>
<codeline lineno="2864"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex<sp/>*pindexLast<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2865"><highlight class="normal"></highlight></codeline>
<codeline lineno="2866"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We&apos;ll<sp/>set<sp/>already_validated_work<sp/>to<sp/>true<sp/>if<sp/>these<sp/>headers<sp/>are</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2867"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>successfully<sp/>processed<sp/>as<sp/>part<sp/>of<sp/>a<sp/>low-work<sp/>headers<sp/>sync<sp/>in<sp/>progress</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2868"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(either<sp/>in<sp/>PRESYNC<sp/>or<sp/>REDOWNLOAD<sp/>phase).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2869"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>true,<sp/>this<sp/>will<sp/>mean<sp/>that<sp/>any<sp/>headers<sp/>returned<sp/>to<sp/>us<sp/>(ie<sp/>during</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2870"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>REDOWNLOAD)<sp/>can<sp/>be<sp/>validated<sp/>without<sp/>further<sp/>anti-DoS<sp/>checks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2871"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>already_validated_work<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2872"><highlight class="normal"></highlight></codeline>
<codeline lineno="2873"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we&apos;re<sp/>in<sp/>the<sp/>middle<sp/>of<sp/>headers<sp/>sync,<sp/>let<sp/>it<sp/>do<sp/>its<sp/>magic.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2874"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>have_headers_sync<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2875"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2876"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(peer.m_headers_sync_mutex);</highlight></codeline>
<codeline lineno="2877"><highlight class="normal"></highlight></codeline>
<codeline lineno="2878"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>already_validated_work<sp/>=<sp/>IsContinuationOfLowWorkHeadersSync(peer,<sp/>pfrom,<sp/>headers);</highlight></codeline>
<codeline lineno="2879"><highlight class="normal"></highlight></codeline>
<codeline lineno="2880"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>headers<sp/>we<sp/>passed<sp/>in<sp/>may<sp/>have<sp/>been:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2881"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>untouched,<sp/>perhaps<sp/>if<sp/>no<sp/>headers-sync<sp/>was<sp/>in<sp/>progress,<sp/>or<sp/>some</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2882"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>failure<sp/>occurred</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2883"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>erased,<sp/>such<sp/>as<sp/>if<sp/>the<sp/>headers<sp/>were<sp/>successfully<sp/>processed<sp/>and<sp/>no</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2884"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>additional<sp/>headers<sp/>processing<sp/>needs<sp/>to<sp/>take<sp/>place<sp/>(such<sp/>as<sp/>if<sp/>we</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2885"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>are<sp/>still<sp/>in<sp/>PRESYNC)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2886"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>replaced<sp/>with<sp/>headers<sp/>that<sp/>are<sp/>now<sp/>ready<sp/>for<sp/>validation,<sp/>such<sp/>as</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2887"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>during<sp/>the<sp/>REDOWNLOAD<sp/>phase<sp/>of<sp/>a<sp/>low-work<sp/>headers<sp/>sync.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2888"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>So<sp/>just<sp/>check<sp/>whether<sp/>we<sp/>still<sp/>have<sp/>headers<sp/>that<sp/>we<sp/>need<sp/>to<sp/>process,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2889"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>or<sp/>not.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2890"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(headers.empty())<sp/>{</highlight></codeline>
<codeline lineno="2891"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2892"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2893"><highlight class="normal"></highlight></codeline>
<codeline lineno="2894"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>have_headers_sync<sp/>=<sp/>!!peer.m_headers_sync;</highlight></codeline>
<codeline lineno="2895"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2896"><highlight class="normal"></highlight></codeline>
<codeline lineno="2897"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Do<sp/>these<sp/>headers<sp/>connect<sp/>to<sp/>something<sp/>in<sp/>our<sp/>block<sp/>index?</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2898"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex<sp/>*chain_start_header{<ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>,<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1a87eab19fb1a7e025715c13377ebfd356" kindref="member">LookupBlockIndex</ref>(headers[0].hashPrevBlock))};</highlight></codeline>
<codeline lineno="2899"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>headers_connect_blockindex{chain_start_header<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2900"><highlight class="normal"></highlight></codeline>
<codeline lineno="2901"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!headers_connect_blockindex)<sp/>{</highlight></codeline>
<codeline lineno="2902"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>could<sp/>be<sp/>a<sp/>BIP<sp/>130<sp/>block<sp/>announcement,<sp/>use</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2903"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>special<sp/>logic<sp/>for<sp/>handling<sp/>headers<sp/>that<sp/>don&apos;t<sp/>connect,<sp/>as<sp/>this</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2904"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>could<sp/>be<sp/>benign.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2905"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>HandleUnconnectingHeaders(pfrom,<sp/>peer,<sp/>headers);</highlight></codeline>
<codeline lineno="2906"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2907"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2908"><highlight class="normal"></highlight></codeline>
<codeline lineno="2909"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>headers<sp/>connect,<sp/>assume<sp/>that<sp/>this<sp/>is<sp/>in<sp/>response<sp/>to<sp/>any<sp/>outstanding<sp/>getheaders</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2910"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>request<sp/>we<sp/>may<sp/>have<sp/>sent,<sp/>and<sp/>clear<sp/>out<sp/>the<sp/>time<sp/>of<sp/>our<sp/>last<sp/>request.<sp/>Non-connecting</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2911"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>headers<sp/>cannot<sp/>be<sp/>a<sp/>response<sp/>to<sp/>a<sp/>getheaders<sp/>request.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2912"><highlight class="normal"><sp/><sp/><sp/><sp/>peer.m_last_getheaders_timestamp<sp/>=<sp/>{};</highlight></codeline>
<codeline lineno="2913"><highlight class="normal"></highlight></codeline>
<codeline lineno="2914"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>headers<sp/>we<sp/>received<sp/>are<sp/>already<sp/>in<sp/>memory<sp/>and<sp/>an<sp/>ancestor<sp/>of</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2915"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>m_best_header<sp/>or<sp/>our<sp/>tip,<sp/>skip<sp/>anti-DoS<sp/>checks.<sp/>These<sp/>headers<sp/>will<sp/>not</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2916"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>use<sp/>any<sp/>more<sp/>memory<sp/>(and<sp/>we<sp/>are<sp/>not<sp/>leaking<sp/>information<sp/>that<sp/>could<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2917"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>used<sp/>to<sp/>fingerprint<sp/>us).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2918"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex<sp/>*last_received_header{</highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2919"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="2920"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="2921"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>last_received_header<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1a87eab19fb1a7e025715c13377ebfd356" kindref="member">LookupBlockIndex</ref>(headers.back().GetHash());</highlight></codeline>
<codeline lineno="2922"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(IsAncestorOfBestHeaderOrTip(last_received_header))<sp/>{</highlight></codeline>
<codeline lineno="2923"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>already_validated_work<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2924"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2925"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2926"><highlight class="normal"></highlight></codeline>
<codeline lineno="2927"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>our<sp/>peer<sp/>has<sp/>NetPermissionFlags::NoBan<sp/>privileges,<sp/>then<sp/>bypass<sp/>our</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2928"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>anti-DoS<sp/>logic<sp/>(this<sp/>saves<sp/>bandwidth<sp/>when<sp/>we<sp/>connect<sp/>to<sp/>a<sp/>trusted<sp/>peer</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2929"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>on<sp/>startup).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2930"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1ad093ef142d44eddf28162f2aa26d56c2" kindref="member">HasPermission</ref>(<ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a12b80870cf3a64e605a95b9c521ac46f" kindref="member">NetPermissionFlags::NoBan</ref>))<sp/>{</highlight></codeline>
<codeline lineno="2931"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>already_validated_work<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2932"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2933"><highlight class="normal"></highlight></codeline>
<codeline lineno="2934"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>At<sp/>this<sp/>point,<sp/>the<sp/>headers<sp/>connect<sp/>to<sp/>something<sp/>in<sp/>our<sp/>block<sp/>index.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2935"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Do<sp/>anti-DoS<sp/>checks<sp/>to<sp/>determine<sp/>if<sp/>we<sp/>should<sp/>process<sp/>or<sp/>store<sp/>for<sp/>later</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2936"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>processing.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2937"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!already_validated_work<sp/>&amp;&amp;<sp/>TryLowWorkHeadersSync(peer,<sp/>pfrom,</highlight></codeline>
<codeline lineno="2938"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>chain_start_header,<sp/>headers))<sp/>{</highlight></codeline>
<codeline lineno="2939"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>successfully<sp/>started<sp/>a<sp/>low-work<sp/>headers<sp/>sync,<sp/>then<sp/>there</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2940"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>should<sp/>be<sp/>no<sp/>headers<sp/>to<sp/>process<sp/>any<sp/>further.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2941"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(headers.empty());</highlight></codeline>
<codeline lineno="2942"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2943"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2944"><highlight class="normal"></highlight></codeline>
<codeline lineno="2945"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>At<sp/>this<sp/>point,<sp/>we<sp/>have<sp/>a<sp/>set<sp/>of<sp/>headers<sp/>with<sp/>sufficient<sp/>work<sp/>on<sp/>them</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2946"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>which<sp/>can<sp/>be<sp/>processed.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2947"><highlight class="normal"></highlight></codeline>
<codeline lineno="2948"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>don&apos;t<sp/>have<sp/>the<sp/>last<sp/>header,<sp/>then<sp/>this<sp/>peer<sp/>will<sp/>have<sp/>given<sp/>us</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2949"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>something<sp/>new<sp/>(if<sp/>these<sp/>headers<sp/>are<sp/>valid).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2950"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>received_new_header{last_received_header<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="2951"><highlight class="normal"></highlight></codeline>
<codeline lineno="2952"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Now<sp/>process<sp/>all<sp/>the<sp/>headers.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2953"><highlight class="normal"><sp/><sp/><sp/><sp/>BlockValidationState<sp/>state;</highlight></codeline>
<codeline lineno="2954"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>processed{m_chainman.<ref refid="class_chainstate_manager_1ae76ff7fc56e3342ba5a97ca33ec5aa37" kindref="member">ProcessNewBlockHeaders</ref>(headers,</highlight></codeline>
<codeline lineno="2955"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*min_pow_checked=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2956"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state,<sp/>&amp;pindexLast)};</highlight></codeline>
<codeline lineno="2957"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!processed)<sp/>{</highlight></codeline>
<codeline lineno="2958"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.<ref refid="class_validation_state_1a6c1f27c9de7ff98356fa712e4b796a1a" kindref="member">IsInvalid</ref>())<sp/>{</highlight></codeline>
<codeline lineno="2959"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pfrom.<ref refid="class_c_node_1a878e09eabda286e4cabf6ffc0fb24ba3" kindref="member">IsInboundConn</ref>()<sp/>&amp;&amp;<sp/>state.<ref refid="class_validation_state_1a1b98c7dab961aab90e13b3f3f9fcf52d" kindref="member">GetResult</ref>()<sp/>==<sp/><ref refid="consensus_2validation_8h_1ab12ebe934df246179ab286448e7ef580a66107f1a16fc14f7b8dff8becdf353b8" kindref="member">BlockValidationResult::BLOCK_CACHED_INVALID</ref>)<sp/>{</highlight></codeline>
<codeline lineno="2960"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Warn<sp/>user<sp/>if<sp/>outgoing<sp/>peers<sp/>send<sp/>us<sp/>headers<sp/>of<sp/>blocks<sp/>that<sp/>we<sp/>previously<sp/>marked<sp/>as<sp/>invalid.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2961"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;%s<sp/>(received<sp/>from<sp/>peer=%i).<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2962"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;If<sp/>this<sp/>happens<sp/>with<sp/>all<sp/>peers,<sp/>consider<sp/>database<sp/>corruption<sp/>(that<sp/>-reindex<sp/>may<sp/>fix)<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2963"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;or<sp/>a<sp/>potential<sp/>consensus<sp/>incompatibility.&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2964"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.<ref refid="class_validation_state_1ac444b5235f12cdc04292ab64fe44226b" kindref="member">GetDebugMessage</ref>(),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="2965"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2966"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MaybePunishNodeForBlock(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>state,<sp/>via_compact_block,<sp/></highlight><highlight class="stringliteral">&quot;invalid<sp/>header<sp/>received&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2967"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2968"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2969"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2970"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindexLast);</highlight></codeline>
<codeline lineno="2971"><highlight class="normal"></highlight></codeline>
<codeline lineno="2972"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(processed<sp/>&amp;&amp;<sp/>received_new_header)<sp/>{</highlight></codeline>
<codeline lineno="2973"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LogBlockHeader(*pindexLast,<sp/>pfrom,<sp/></highlight><highlight class="comment">/*via_compact_block=*/</highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="2974"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2975"><highlight class="normal"></highlight></codeline>
<codeline lineno="2976"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Consider<sp/>fetching<sp/>more<sp/>headers<sp/>if<sp/>we<sp/>are<sp/>not<sp/>using<sp/>our<sp/>headers-sync<sp/>mechanism.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2977"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nCount<sp/>==<sp/>m_opts.max_headers_result<sp/>&amp;&amp;<sp/>!have_headers_sync)<sp/>{</highlight></codeline>
<codeline lineno="2978"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Headers<sp/>message<sp/>had<sp/>its<sp/>maximum<sp/>size;<sp/>the<sp/>peer<sp/>may<sp/>have<sp/>more<sp/>headers.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2979"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(MaybeSendGetHeaders(pfrom,<sp/><ref refid="chain_8cpp_1a6f7cb8de33a43e97b3dd7517998379bc" kindref="member">GetLocator</ref>(pindexLast),<sp/>peer))<sp/>{</highlight></codeline>
<codeline lineno="2980"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;more<sp/>getheaders<sp/>(%d)<sp/>to<sp/>end<sp/>to<sp/>peer=%d<sp/>(startheight:%d)\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="2981"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexLast-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>peer.m_starting_height);</highlight></codeline>
<codeline lineno="2982"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2983"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="2984"><highlight class="normal"></highlight></codeline>
<codeline lineno="2985"><highlight class="normal"><sp/><sp/><sp/><sp/>UpdatePeerStateForReceivedHeaders(pfrom,<sp/>peer,<sp/>*pindexLast,<sp/>received_new_header,<sp/>nCount<sp/>==<sp/>m_opts.max_headers_result);</highlight></codeline>
<codeline lineno="2986"><highlight class="normal"></highlight></codeline>
<codeline lineno="2987"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Consider<sp/>immediately<sp/>downloading<sp/>blocks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2988"><highlight class="normal"><sp/><sp/><sp/><sp/>HeadersDirectFetchBlocks(pfrom,<sp/>peer,<sp/>*pindexLast);</highlight></codeline>
<codeline lineno="2989"><highlight class="normal"></highlight></codeline>
<codeline lineno="2990"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="2991"><highlight class="normal">}</highlight></codeline>
<codeline lineno="2992"><highlight class="normal"></highlight></codeline>
<codeline lineno="2993"><highlight class="normal">std::optional&lt;node::PackageToValidate&gt;<sp/>PeerManagerImpl::ProcessInvalidTx(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref>&amp;<sp/>ptx,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>TxValidationState&amp;<sp/>state,</highlight></codeline>
<codeline lineno="2994"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>first_time_failure)</highlight></codeline>
<codeline lineno="2995"><highlight class="normal">{</highlight></codeline>
<codeline lineno="2996"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(m_peer_mutex);</highlight></codeline>
<codeline lineno="2997"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="2998"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(m_tx_download_mutex);</highlight></codeline>
<codeline lineno="2999"><highlight class="normal"></highlight></codeline>
<codeline lineno="3000"><highlight class="normal"><sp/><sp/><sp/><sp/>PeerRef<sp/>peer{GetPeerRef(nodeid)};</highlight></codeline>
<codeline lineno="3001"><highlight class="normal"></highlight></codeline>
<codeline lineno="3002"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395abd59ff4c5eb87b207d85744d429f9f17" kindref="member">BCLog::MEMPOOLREJ</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s<sp/>(wtxid=%s)<sp/>from<sp/>peer=%d<sp/>was<sp/>not<sp/>accepted:<sp/>%s\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3003"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ptx-&gt;GetHash().ToString(),</highlight></codeline>
<codeline lineno="3004"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ptx-&gt;GetWitnessHash().ToString(),</highlight></codeline>
<codeline lineno="3005"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nodeid,</highlight></codeline>
<codeline lineno="3006"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="3007"><highlight class="normal"></highlight></codeline>
<codeline lineno="3008"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>[add_extra_compact_tx,<sp/>unique_parents,<sp/>package_to_validate]<sp/>=<sp/>m_txdownloadman.MempoolRejectedTx(ptx,<sp/>state,<sp/>nodeid,<sp/>first_time_failure);</highlight></codeline>
<codeline lineno="3009"><highlight class="normal"></highlight></codeline>
<codeline lineno="3010"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(add_extra_compact_tx<sp/>&amp;&amp;<sp/>RecursiveDynamicUsage(*ptx)<sp/>&lt;<sp/>100000)<sp/>{</highlight></codeline>
<codeline lineno="3011"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>AddToCompactExtraTransactions(ptx);</highlight></codeline>
<codeline lineno="3012"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3013"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="transaction__identifier_8h_1ac4bb3c35b94889843d632be4de4b223c" kindref="member">Txid</ref>&amp;<sp/>parent_txid<sp/>:<sp/>unique_parents)<sp/>{</highlight></codeline>
<codeline lineno="3014"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer)<sp/>AddKnownTx(*peer,<sp/>parent_txid.ToUint256());</highlight></codeline>
<codeline lineno="3015"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3016"><highlight class="normal"></highlight></codeline>
<codeline lineno="3017"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>package_to_validate;</highlight></codeline>
<codeline lineno="3018"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3019"><highlight class="normal"></highlight></codeline>
<codeline lineno="3020"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::ProcessValidTx(<ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref>&amp;<sp/>tx,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::list&lt;CTransactionRef&gt;&amp;<sp/>replaced_transactions)</highlight></codeline>
<codeline lineno="3021"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3022"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(m_peer_mutex);</highlight></codeline>
<codeline lineno="3023"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="3024"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(m_tx_download_mutex);</highlight></codeline>
<codeline lineno="3025"><highlight class="normal"></highlight></codeline>
<codeline lineno="3026"><highlight class="normal"><sp/><sp/><sp/><sp/>m_txdownloadman.MempoolAcceptedTx(tx);</highlight></codeline>
<codeline lineno="3027"><highlight class="normal"></highlight></codeline>
<codeline lineno="3028"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395afb374f9d778e803545f3af036ca147a0" kindref="member">BCLog::MEMPOOL</ref>,<sp/></highlight><highlight class="stringliteral">&quot;AcceptToMemoryPool:<sp/>peer=%d:<sp/>accepted<sp/>%s<sp/>(wtxid=%s)<sp/>(poolsz<sp/>%u<sp/>txn,<sp/>%u<sp/>kB)\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3029"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nodeid,</highlight></codeline>
<codeline lineno="3030"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx-&gt;GetHash().ToString(),</highlight></codeline>
<codeline lineno="3031"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx-&gt;GetWitnessHash().ToString(),</highlight></codeline>
<codeline lineno="3032"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_mempool.<ref refid="class_c_tx_mem_pool_1af22b5286aa0191a7087a205f6d04b032" kindref="member">size</ref>(),<sp/>m_mempool.<ref refid="class_c_tx_mem_pool_1afcc22204abc15aeefd5d1f7396e909a4" kindref="member">DynamicMemoryUsage</ref>()<sp/>/<sp/>1000);</highlight></codeline>
<codeline lineno="3033"><highlight class="normal"></highlight></codeline>
<codeline lineno="3034"><highlight class="normal"><sp/><sp/><sp/><sp/>RelayTransaction(tx-&gt;GetHash(),<sp/>tx-&gt;GetWitnessHash());</highlight></codeline>
<codeline lineno="3035"><highlight class="normal"></highlight></codeline>
<codeline lineno="3036"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref>&amp;<sp/>removedTx<sp/>:<sp/>replaced_transactions)<sp/>{</highlight></codeline>
<codeline lineno="3037"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>AddToCompactExtraTransactions(removedTx);</highlight></codeline>
<codeline lineno="3038"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3039"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3040"><highlight class="normal"></highlight></codeline>
<codeline lineno="3041"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::ProcessPackageResult(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>node::PackageToValidate&amp;<sp/>package_to_validate,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>PackageMempoolAcceptResult&amp;<sp/>package_result)</highlight></codeline>
<codeline lineno="3042"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3043"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(m_peer_mutex);</highlight></codeline>
<codeline lineno="3044"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="3045"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(m_tx_download_mutex);</highlight></codeline>
<codeline lineno="3046"><highlight class="normal"></highlight></codeline>
<codeline lineno="3047"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/></highlight><highlight class="keyword">package<sp/></highlight><highlight class="normal">=<sp/>package_to_validate.m_txns;</highlight></codeline>
<codeline lineno="3048"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>senders<sp/>=<sp/>package_to_validate.<ref refid="structnode_1_1_package_to_validate_1aad3373a679e96a2dbf8097fddd7c9c12" kindref="member">m_senders</ref>;</highlight></codeline>
<codeline lineno="3049"><highlight class="normal"></highlight></codeline>
<codeline lineno="3050"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(package_result.<ref refid="struct_package_mempool_accept_result_1a14b1b7ea32b2b5c3b49c35b147fab3cb" kindref="member">m_state</ref>.<ref refid="class_validation_state_1a6c1f27c9de7ff98356fa712e4b796a1a" kindref="member">IsInvalid</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3051"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_txdownloadman.MempoolRejectedPackage(package);</highlight></codeline>
<codeline lineno="3052"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3053"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>currently<sp/>only<sp/>expect<sp/>to<sp/>process<sp/>1-parent-1-child<sp/>packages.<sp/>Remove<sp/>if<sp/>this<sp/>changes.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3054"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(package.size()<sp/>==<sp/>2))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3055"><highlight class="normal"></highlight></codeline>
<codeline lineno="3056"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Iterate<sp/>backwards<sp/>to<sp/>erase<sp/>in-package<sp/>descendants<sp/>from<sp/>the<sp/>orphanage<sp/>before<sp/>they<sp/>become</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3057"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>relevant<sp/>in<sp/>AddChildrenToWorkSet.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3058"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>package_iter<sp/>=<sp/>package.rbegin();</highlight></codeline>
<codeline lineno="3059"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>senders_iter<sp/>=<sp/>senders.rbegin();</highlight></codeline>
<codeline lineno="3060"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(package_iter<sp/>!=<sp/>package.rend())<sp/>{</highlight></codeline>
<codeline lineno="3061"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tx<sp/>=<sp/>*package_iter;</highlight></codeline>
<codeline lineno="3062"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>nodeid<sp/>=<sp/>*senders_iter;</highlight></codeline>
<codeline lineno="3063"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it_result{package_result.<ref refid="struct_package_mempool_accept_result_1a048e81b8b8e77d642e29e840c5b7488d" kindref="member">m_tx_results</ref>.find(tx-&gt;GetWitnessHash())};</highlight></codeline>
<codeline lineno="3064"><highlight class="normal"></highlight></codeline>
<codeline lineno="3065"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>It<sp/>is<sp/>not<sp/>guaranteed<sp/>that<sp/>a<sp/>result<sp/>exists<sp/>for<sp/>every<sp/>transaction.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3066"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it_result<sp/>!=<sp/>package_result.<ref refid="struct_package_mempool_accept_result_1a048e81b8b8e77d642e29e840c5b7488d" kindref="member">m_tx_results</ref>.end())<sp/>{</highlight></codeline>
<codeline lineno="3067"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>tx_result<sp/>=<sp/>it_result-&gt;second;</highlight></codeline>
<codeline lineno="3068"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(tx_result.m_result_type)<sp/>{</highlight></codeline>
<codeline lineno="3069"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="struct_mempool_accept_result_1aa71b5fc2a82d29a91db3a734ff892a49ac9f1a6384b1c466d4612f513bd8e13ea" kindref="member">MempoolAcceptResult::ResultType::VALID</ref>:</highlight></codeline>
<codeline lineno="3070"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3071"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ProcessValidTx(nodeid,<sp/>tx,<sp/>tx_result.m_replaced_transactions);</highlight></codeline>
<codeline lineno="3072"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3073"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3074"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="struct_mempool_accept_result_1aa71b5fc2a82d29a91db3a734ff892a49accc0377a8afbf50e7094f5c23a8af223" kindref="member">MempoolAcceptResult::ResultType::INVALID</ref>:</highlight></codeline>
<codeline lineno="3075"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="struct_mempool_accept_result_1aa71b5fc2a82d29a91db3a734ff892a49a2d29ec62347aac067b052563d894edc1" kindref="member">MempoolAcceptResult::ResultType::DIFFERENT_WITNESS</ref>:</highlight></codeline>
<codeline lineno="3076"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3077"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Don&apos;t<sp/>add<sp/>to<sp/>vExtraTxnForCompact,<sp/>as<sp/>these<sp/>transactions<sp/>should<sp/>have<sp/>already<sp/>been</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3078"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>added<sp/>there<sp/>when<sp/>added<sp/>to<sp/>the<sp/>orphanage<sp/>or<sp/>rejected<sp/>for<sp/>TX_RECONSIDERABLE.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3079"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>should<sp/>be<sp/>updated<sp/>if<sp/>package<sp/>submission<sp/>is<sp/>ever<sp/>used<sp/>for<sp/>transactions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3080"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>that<sp/>haven&apos;t<sp/>already<sp/>been<sp/>validated<sp/>before.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3081"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ProcessInvalidTx(nodeid,<sp/>tx,<sp/>tx_result.m_state,<sp/></highlight><highlight class="comment">/*first_time_failure=*/</highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3082"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3083"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3084"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="struct_mempool_accept_result_1aa71b5fc2a82d29a91db3a734ff892a49a7293a7b88fa11eadb03e7f9e3111d0b8" kindref="member">MempoolAcceptResult::ResultType::MEMPOOL_ENTRY</ref>:</highlight></codeline>
<codeline lineno="3085"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3086"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>AlreadyHaveTx()<sp/>should<sp/>be<sp/>catching<sp/>transactions<sp/>that<sp/>are<sp/>already<sp/>in<sp/>mempool.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3087"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(</highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3088"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3089"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3090"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3091"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3092"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>package_iter++;</highlight></codeline>
<codeline lineno="3093"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>senders_iter++;</highlight></codeline>
<codeline lineno="3094"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3095"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3096"><highlight class="normal"></highlight></codeline>
<codeline lineno="3097"><highlight class="normal"></highlight><highlight class="comment">//<sp/>NOTE:<sp/>the<sp/>orphan<sp/>processing<sp/>used<sp/>to<sp/>be<sp/>uninterruptible<sp/>and<sp/>quadratic,<sp/>which<sp/>could<sp/>allow<sp/>a<sp/>peer<sp/>to<sp/>stall<sp/>the<sp/>node<sp/>for</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3098"><highlight class="normal"></highlight><highlight class="comment">//<sp/>hours<sp/>with<sp/>specially<sp/>crafted<sp/>transactions.<sp/>See<sp/>https://bitcoincore.org/en/2024/07/03/disclose-orphan-dos.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3099"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::ProcessOrphanTx(Peer&amp;<sp/>peer)</highlight></codeline>
<codeline lineno="3100"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3101"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="3102"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a35644e2b75a93da0cb0f6c768f34efa8" kindref="member">LOCK2</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>,<sp/>m_tx_download_mutex);</highlight></codeline>
<codeline lineno="3103"><highlight class="normal"></highlight></codeline>
<codeline lineno="3104"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref><sp/>porphanTx<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3105"><highlight class="normal"></highlight></codeline>
<codeline lineno="3106"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(<ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref><sp/>porphanTx<sp/>=<sp/>m_txdownloadman.GetTxToReconsider(peer.m_id))<sp/>{</highlight></codeline>
<codeline lineno="3107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MempoolAcceptResult<sp/>result<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a9c7d6797a606a08696d722e7489b6d4d" kindref="member">ProcessTransaction</ref>(porphanTx);</highlight></codeline>
<codeline lineno="3108"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>TxValidationState&amp;<sp/>state<sp/>=<sp/>result.<ref refid="struct_mempool_accept_result_1a5d8238ae23efa4592916ffc81d18cd4d" kindref="member">m_state</ref>;</highlight></codeline>
<codeline lineno="3109"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="transaction__identifier_8h_1ac4bb3c35b94889843d632be4de4b223c" kindref="member">Txid</ref>&amp;<sp/>orphanHash<sp/>=<sp/>porphanTx-&gt;GetHash();</highlight></codeline>
<codeline lineno="3110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="transaction__identifier_8h_1a23364c1312d4dffbbf549b4440333fd9" kindref="member">Wtxid</ref>&amp;<sp/>orphan_wtxid<sp/>=<sp/>porphanTx-&gt;GetWitnessHash();</highlight></codeline>
<codeline lineno="3111"><highlight class="normal"></highlight></codeline>
<codeline lineno="3112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(result.<ref refid="struct_mempool_accept_result_1af8017e4319a28c0cac9c61662b1d7565" kindref="member">m_result_type</ref><sp/>==<sp/><ref refid="struct_mempool_accept_result_1aa71b5fc2a82d29a91db3a734ff892a49ac9f1a6384b1c466d4612f513bd8e13ea" kindref="member">MempoolAcceptResult::ResultType::VALID</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395aeb418caf082e910fc5ab0d298fb6a8ac" kindref="member">BCLog::TXPACKAGES</ref>,<sp/></highlight><highlight class="stringliteral">&quot;<sp/><sp/><sp/>accepted<sp/>orphan<sp/>tx<sp/>%s<sp/>(wtxid=%s)\n&quot;</highlight><highlight class="normal">,<sp/>orphanHash.<ref refid="classtransaction__identifier_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>(),<sp/>orphan_wtxid.<ref refid="classtransaction__identifier_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="3114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ProcessValidTx(peer.m_id,<sp/>porphanTx,<sp/>result.<ref refid="struct_mempool_accept_result_1a4c4c805f30f282cc10c2cdad8346644c" kindref="member">m_replaced_transactions</ref>);</highlight></codeline>
<codeline lineno="3115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.<ref refid="class_validation_state_1a1b98c7dab961aab90e13b3f3f9fcf52d" kindref="member">GetResult</ref>()<sp/>!=<sp/><ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa16d3efb22890f6c8dd36c8e0e81dd796" kindref="member">TxValidationResult::TX_MISSING_INPUTS</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395aeb418caf082e910fc5ab0d298fb6a8ac" kindref="member">BCLog::TXPACKAGES</ref>,<sp/></highlight><highlight class="stringliteral">&quot;<sp/><sp/><sp/>invalid<sp/>orphan<sp/>tx<sp/>%s<sp/>(wtxid=%s)<sp/>from<sp/>peer=%d.<sp/>%s\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>orphanHash.<ref refid="classtransaction__identifier_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>(),</highlight></codeline>
<codeline lineno="3119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>orphan_wtxid.<ref refid="classtransaction__identifier_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>(),</highlight></codeline>
<codeline lineno="3120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_id,</highlight></codeline>
<codeline lineno="3121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="3122"><highlight class="normal"></highlight></codeline>
<codeline lineno="3123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(state.<ref refid="class_validation_state_1a6c1f27c9de7ff98356fa712e4b796a1a" kindref="member">IsInvalid</ref>()<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="3124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.<ref refid="class_validation_state_1a1b98c7dab961aab90e13b3f3f9fcf52d" kindref="member">GetResult</ref>()<sp/>!=<sp/><ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fa4442794a27caad913e53e2a50f1bf5fe" kindref="member">TxValidationResult::TX_UNKNOWN</ref><sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="3125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.<ref refid="class_validation_state_1a1b98c7dab961aab90e13b3f3f9fcf52d" kindref="member">GetResult</ref>()<sp/>!=<sp/><ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89fabf7c24f91e2c3c9b6d53aee4ba84e5ca" kindref="member">TxValidationResult::TX_NO_MEMPOOL</ref><sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="3126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.<ref refid="class_validation_state_1a1b98c7dab961aab90e13b3f3f9fcf52d" kindref="member">GetResult</ref>()<sp/>!=<sp/><ref refid="consensus_2validation_8h_1af79c18cdf56a2455d281427abb70f89face9077815b8b186782275db957aaa16e" kindref="member">TxValidationResult::TX_RESULT_UNSET</ref>))<sp/>{</highlight></codeline>
<codeline lineno="3127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ProcessInvalidTx(peer.m_id,<sp/>porphanTx,<sp/>state,<sp/></highlight><highlight class="comment">/*first_time_failure=*/</highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3129"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3131"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3132"><highlight class="normal"></highlight></codeline>
<codeline lineno="3133"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3134"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3135"><highlight class="normal"></highlight></codeline>
<codeline lineno="3136"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::PrepareBlockFilterRequest(CNode&amp;<sp/>node,<sp/>Peer&amp;<sp/>peer,</highlight></codeline>
<codeline lineno="3137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="blockfilter_8h_1a530bf73ca0d532a142641644a1605250" kindref="member">BlockFilterType</ref><sp/>filter_type,<sp/>uint32_t<sp/>start_height,</highlight></codeline>
<codeline lineno="3138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256&amp;<sp/>stop_hash,<sp/>uint32_t<sp/>max_height_diff,</highlight></codeline>
<codeline lineno="3139"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*&amp;<sp/>stop_index,</highlight></codeline>
<codeline lineno="3140"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BlockFilterIndex*&amp;<sp/>filter_index)</highlight></codeline>
<codeline lineno="3141"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3142"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>supported_filter_type<sp/>=</highlight></codeline>
<codeline lineno="3143"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(filter_type<sp/>==<sp/><ref refid="blockfilter_8h_1a530bf73ca0d532a142641644a1605250ae4ac03f6c9f00665644e868dd1fb9f1e" kindref="member">BlockFilterType::BASIC</ref><sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="3144"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(peer.m_our_services<sp/>&amp;<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537ad279240d0624d58813461a7790873e46" kindref="member">NODE_COMPACT_FILTERS</ref>));</highlight></codeline>
<codeline lineno="3145"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!supported_filter_type)<sp/>{</highlight></codeline>
<codeline lineno="3146"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;peer<sp/>requested<sp/>unsupported<sp/>block<sp/>filter<sp/>type:<sp/>%d,<sp/>%s\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3147"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="normal">uint8_t</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(filter_type),<sp/>node.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="3148"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>node.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3149"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3150"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3151"><highlight class="normal"></highlight></codeline>
<codeline lineno="3152"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3153"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="3154"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stop_index<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1a87eab19fb1a7e025715c13377ebfd356" kindref="member">LookupBlockIndex</ref>(stop_hash);</highlight></codeline>
<codeline lineno="3155"><highlight class="normal"></highlight></codeline>
<codeline lineno="3156"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>that<sp/>the<sp/>stop<sp/>block<sp/>exists<sp/>and<sp/>the<sp/>peer<sp/>would<sp/>be<sp/>allowed<sp/>to<sp/>fetch<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3157"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!stop_index<sp/>||<sp/>!BlockRequestAllowed(stop_index))<sp/>{</highlight></codeline>
<codeline lineno="3158"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;peer<sp/>requested<sp/>invalid<sp/>block<sp/>hash:<sp/>%s,<sp/>%s\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stop_hash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>node.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="3160"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>node.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3161"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3162"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3163"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3164"><highlight class="normal"></highlight></codeline>
<codeline lineno="3165"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>stop_height<sp/>=<sp/>stop_index-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>;</highlight></codeline>
<codeline lineno="3166"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(start_height<sp/>&gt;<sp/>stop_height)<sp/>{</highlight></codeline>
<codeline lineno="3167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;peer<sp/>sent<sp/>invalid<sp/>getcfilters/getcfheaders<sp/>with<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;start<sp/>height<sp/>%d<sp/>and<sp/>stop<sp/>height<sp/>%d,<sp/>%s\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_height,<sp/>stop_height,<sp/>node.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="3170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>node.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3172"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3173"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stop_height<sp/>-<sp/>start_height<sp/>&gt;=<sp/>max_height_diff)<sp/>{</highlight></codeline>
<codeline lineno="3174"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;peer<sp/>requested<sp/>too<sp/>many<sp/>cfilters/cfheaders:<sp/>%d<sp/>/<sp/>%d,<sp/>%s\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3175"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stop_height<sp/>-<sp/>start_height<sp/>+<sp/>1,<sp/>max_height_diff,<sp/>node.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="3176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>node.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3177"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3178"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3179"><highlight class="normal"></highlight></codeline>
<codeline lineno="3180"><highlight class="normal"><sp/><sp/><sp/><sp/>filter_index<sp/>=<sp/><ref refid="blockfilterindex_8cpp_1a7e5a7eafefd6511f8d95b2583bdb53b0" kindref="member">GetBlockFilterIndex</ref>(filter_type);</highlight></codeline>
<codeline lineno="3181"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!filter_index)<sp/>{</highlight></codeline>
<codeline lineno="3182"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Filter<sp/>index<sp/>for<sp/>supported<sp/>type<sp/>%s<sp/>not<sp/>found\n&quot;</highlight><highlight class="normal">,<sp/><ref refid="blockfilter_8cpp_1a75df3661184c3291fc4d612d4f99d3ad" kindref="member">BlockFilterTypeName</ref>(filter_type));</highlight></codeline>
<codeline lineno="3183"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3184"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3185"><highlight class="normal"></highlight></codeline>
<codeline lineno="3186"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3187"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3188"><highlight class="normal"></highlight></codeline>
<codeline lineno="3189"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::ProcessGetCFilters(CNode&amp;<sp/>node,<sp/>Peer&amp;<sp/>peer,<sp/>DataStream&amp;<sp/>vRecv)</highlight></codeline>
<codeline lineno="3190"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3191"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t<sp/>filter_type_ser;</highlight></codeline>
<codeline lineno="3192"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>start_height;</highlight></codeline>
<codeline lineno="3193"><highlight class="normal"><sp/><sp/><sp/><sp/>uint256<sp/>stop_hash;</highlight></codeline>
<codeline lineno="3194"><highlight class="normal"></highlight></codeline>
<codeline lineno="3195"><highlight class="normal"><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>filter_type_ser<sp/>&gt;&gt;<sp/>start_height<sp/>&gt;&gt;<sp/>stop_hash;</highlight></codeline>
<codeline lineno="3196"><highlight class="normal"></highlight></codeline>
<codeline lineno="3197"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="blockfilter_8h_1a530bf73ca0d532a142641644a1605250" kindref="member">BlockFilterType</ref><sp/>filter_type<sp/>=<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="normal"><ref refid="blockfilter_8h_1a530bf73ca0d532a142641644a1605250" kindref="member">BlockFilterType</ref></highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(filter_type_ser);</highlight></codeline>
<codeline lineno="3198"><highlight class="normal"></highlight></codeline>
<codeline lineno="3199"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>stop_index;</highlight></codeline>
<codeline lineno="3200"><highlight class="normal"><sp/><sp/><sp/><sp/>BlockFilterIndex*<sp/>filter_index;</highlight></codeline>
<codeline lineno="3201"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!PrepareBlockFilterRequest(node,<sp/>peer,<sp/>filter_type,<sp/>start_height,<sp/>stop_hash,</highlight></codeline>
<codeline lineno="3202"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MAX_GETCFILTERS_SIZE,<sp/>stop_index,<sp/>filter_index))<sp/>{</highlight></codeline>
<codeline lineno="3203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3204"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3205"><highlight class="normal"></highlight></codeline>
<codeline lineno="3206"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;BlockFilter&gt;<sp/>filters;</highlight></codeline>
<codeline lineno="3207"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!filter_index-&gt;<ref refid="class_block_filter_index_1a3b76396ced514ecf4807816bc5900e53" kindref="member">LookupFilterRange</ref>(start_height,<sp/>stop_index,<sp/>filters))<sp/>{</highlight></codeline>
<codeline lineno="3208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>find<sp/>block<sp/>filter<sp/>in<sp/>index:<sp/>filter_type=%s,<sp/>start_height=%d,<sp/>stop_hash=%s\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="blockfilter_8cpp_1a75df3661184c3291fc4d612d4f99d3ad" kindref="member">BlockFilterTypeName</ref>(filter_type),<sp/>start_height,<sp/>stop_hash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="3210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3211"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3212"><highlight class="normal"></highlight></codeline>
<codeline lineno="3213"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>filter<sp/>:<sp/>filters)<sp/>{</highlight></codeline>
<codeline lineno="3214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(node,<sp/><ref refid="namespace_net_msg_type_1a7931d7fd782a093212795ba6233c3c14" kindref="member">NetMsgType::CFILTER</ref>,<sp/>filter);</highlight></codeline>
<codeline lineno="3215"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3216"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3217"><highlight class="normal"></highlight></codeline>
<codeline lineno="3218"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::ProcessGetCFHeaders(CNode&amp;<sp/>node,<sp/>Peer&amp;<sp/>peer,<sp/>DataStream&amp;<sp/>vRecv)</highlight></codeline>
<codeline lineno="3219"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3220"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t<sp/>filter_type_ser;</highlight></codeline>
<codeline lineno="3221"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>start_height;</highlight></codeline>
<codeline lineno="3222"><highlight class="normal"><sp/><sp/><sp/><sp/>uint256<sp/>stop_hash;</highlight></codeline>
<codeline lineno="3223"><highlight class="normal"></highlight></codeline>
<codeline lineno="3224"><highlight class="normal"><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>filter_type_ser<sp/>&gt;&gt;<sp/>start_height<sp/>&gt;&gt;<sp/>stop_hash;</highlight></codeline>
<codeline lineno="3225"><highlight class="normal"></highlight></codeline>
<codeline lineno="3226"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="blockfilter_8h_1a530bf73ca0d532a142641644a1605250" kindref="member">BlockFilterType</ref><sp/>filter_type<sp/>=<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="normal"><ref refid="blockfilter_8h_1a530bf73ca0d532a142641644a1605250" kindref="member">BlockFilterType</ref></highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(filter_type_ser);</highlight></codeline>
<codeline lineno="3227"><highlight class="normal"></highlight></codeline>
<codeline lineno="3228"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>stop_index;</highlight></codeline>
<codeline lineno="3229"><highlight class="normal"><sp/><sp/><sp/><sp/>BlockFilterIndex*<sp/>filter_index;</highlight></codeline>
<codeline lineno="3230"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!PrepareBlockFilterRequest(node,<sp/>peer,<sp/>filter_type,<sp/>start_height,<sp/>stop_hash,</highlight></codeline>
<codeline lineno="3231"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MAX_GETCFHEADERS_SIZE,<sp/>stop_index,<sp/>filter_index))<sp/>{</highlight></codeline>
<codeline lineno="3232"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3233"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3234"><highlight class="normal"></highlight></codeline>
<codeline lineno="3235"><highlight class="normal"><sp/><sp/><sp/><sp/>uint256<sp/>prev_header;</highlight></codeline>
<codeline lineno="3236"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(start_height<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="3237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>prev_block<sp/>=</highlight></codeline>
<codeline lineno="3238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stop_index-&gt;<ref refid="class_c_block_index_1ac20120d6b64792647a63d216b26e4b53" kindref="member">GetAncestor</ref>(</highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">int</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(start_height<sp/>-<sp/>1));</highlight></codeline>
<codeline lineno="3239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!filter_index-&gt;<ref refid="class_block_filter_index_1acfdddc9ce6b0ff5c2082815ca526977f" kindref="member">LookupFilterHeader</ref>(prev_block,<sp/>prev_header))<sp/>{</highlight></codeline>
<codeline lineno="3240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>find<sp/>block<sp/>filter<sp/>header<sp/>in<sp/>index:<sp/>filter_type=%s,<sp/>block_hash=%s\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="blockfilter_8cpp_1a75df3661184c3291fc4d612d4f99d3ad" kindref="member">BlockFilterTypeName</ref>(filter_type),<sp/>prev_block-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="3242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3244"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3245"><highlight class="normal"></highlight></codeline>
<codeline lineno="3246"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;uint256&gt;<sp/>filter_hashes;</highlight></codeline>
<codeline lineno="3247"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!filter_index-&gt;<ref refid="class_block_filter_index_1a5b477dbe22cb72cbff33c42a358b867b" kindref="member">LookupFilterHashRange</ref>(start_height,<sp/>stop_index,<sp/>filter_hashes))<sp/>{</highlight></codeline>
<codeline lineno="3248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>find<sp/>block<sp/>filter<sp/>hashes<sp/>in<sp/>index:<sp/>filter_type=%s,<sp/>start_height=%d,<sp/>stop_hash=%s\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="blockfilter_8cpp_1a75df3661184c3291fc4d612d4f99d3ad" kindref="member">BlockFilterTypeName</ref>(filter_type),<sp/>start_height,<sp/>stop_hash.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="3250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3251"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3252"><highlight class="normal"></highlight></codeline>
<codeline lineno="3253"><highlight class="normal"><sp/><sp/><sp/><sp/>MakeAndPushMessage(node,<sp/><ref refid="namespace_net_msg_type_1a5f59d7ae0f69bad2946a1e067ff807cb" kindref="member">NetMsgType::CFHEADERS</ref>,</highlight></codeline>
<codeline lineno="3254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>filter_type_ser,</highlight></codeline>
<codeline lineno="3255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stop_index-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>(),</highlight></codeline>
<codeline lineno="3256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>prev_header,</highlight></codeline>
<codeline lineno="3257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>filter_hashes);</highlight></codeline>
<codeline lineno="3258"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3259"><highlight class="normal"></highlight></codeline>
<codeline lineno="3260"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::ProcessGetCFCheckPt(CNode&amp;<sp/>node,<sp/>Peer&amp;<sp/>peer,<sp/>DataStream&amp;<sp/>vRecv)</highlight></codeline>
<codeline lineno="3261"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3262"><highlight class="normal"><sp/><sp/><sp/><sp/>uint8_t<sp/>filter_type_ser;</highlight></codeline>
<codeline lineno="3263"><highlight class="normal"><sp/><sp/><sp/><sp/>uint256<sp/>stop_hash;</highlight></codeline>
<codeline lineno="3264"><highlight class="normal"></highlight></codeline>
<codeline lineno="3265"><highlight class="normal"><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>filter_type_ser<sp/>&gt;&gt;<sp/>stop_hash;</highlight></codeline>
<codeline lineno="3266"><highlight class="normal"></highlight></codeline>
<codeline lineno="3267"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="blockfilter_8h_1a530bf73ca0d532a142641644a1605250" kindref="member">BlockFilterType</ref><sp/>filter_type<sp/>=<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="normal"><ref refid="blockfilter_8h_1a530bf73ca0d532a142641644a1605250" kindref="member">BlockFilterType</ref></highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(filter_type_ser);</highlight></codeline>
<codeline lineno="3268"><highlight class="normal"></highlight></codeline>
<codeline lineno="3269"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>stop_index;</highlight></codeline>
<codeline lineno="3270"><highlight class="normal"><sp/><sp/><sp/><sp/>BlockFilterIndex*<sp/>filter_index;</highlight></codeline>
<codeline lineno="3271"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!PrepareBlockFilterRequest(node,<sp/>peer,<sp/>filter_type,<sp/></highlight><highlight class="comment">/*start_height=*/</highlight><highlight class="normal">0,<sp/>stop_hash,</highlight></codeline>
<codeline lineno="3272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*max_height_diff=*/</highlight><highlight class="normal">std::numeric_limits&lt;uint32_t&gt;::max(),</highlight></codeline>
<codeline lineno="3273"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stop_index,<sp/>filter_index))<sp/>{</highlight></codeline>
<codeline lineno="3274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3275"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3276"><highlight class="normal"></highlight></codeline>
<codeline lineno="3277"><highlight class="normal"><sp/><sp/><sp/><sp/>std::vector&lt;uint256&gt;<sp/>headers(stop_index-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>/<sp/>CFCHECKPT_INTERVAL);</highlight></codeline>
<codeline lineno="3278"><highlight class="normal"></highlight></codeline>
<codeline lineno="3279"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Populate<sp/>headers.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3280"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>block_index<sp/>=<sp/>stop_index;</highlight></codeline>
<codeline lineno="3281"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>headers.size()<sp/>-<sp/>1;<sp/>i<sp/>&gt;=<sp/>0;<sp/>i--)<sp/>{</highlight></codeline>
<codeline lineno="3282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>height<sp/>=<sp/>(i<sp/>+<sp/>1)<sp/>*<sp/>CFCHECKPT_INTERVAL;</highlight></codeline>
<codeline lineno="3283"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>block_index<sp/>=<sp/>block_index-&gt;<ref refid="class_c_block_index_1ac20120d6b64792647a63d216b26e4b53" kindref="member">GetAncestor</ref>(height);</highlight></codeline>
<codeline lineno="3284"><highlight class="normal"></highlight></codeline>
<codeline lineno="3285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!filter_index-&gt;<ref refid="class_block_filter_index_1acfdddc9ce6b0ff5c2082815ca526977f" kindref="member">LookupFilterHeader</ref>(block_index,<sp/>headers[i]))<sp/>{</highlight></codeline>
<codeline lineno="3286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>find<sp/>block<sp/>filter<sp/>header<sp/>in<sp/>index:<sp/>filter_type=%s,<sp/>block_hash=%s\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="blockfilter_8cpp_1a75df3661184c3291fc4d612d4f99d3ad" kindref="member">BlockFilterTypeName</ref>(filter_type),<sp/>block_index-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="3288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3289"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3290"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3291"><highlight class="normal"></highlight></codeline>
<codeline lineno="3292"><highlight class="normal"><sp/><sp/><sp/><sp/>MakeAndPushMessage(node,<sp/><ref refid="namespace_net_msg_type_1a42a3bcabd93d36d02afbf69927d6a55e" kindref="member">NetMsgType::CFCHECKPT</ref>,</highlight></codeline>
<codeline lineno="3293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>filter_type_ser,</highlight></codeline>
<codeline lineno="3294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>stop_index-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>(),</highlight></codeline>
<codeline lineno="3295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>headers);</highlight></codeline>
<codeline lineno="3296"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3297"><highlight class="normal"></highlight></codeline>
<codeline lineno="3298"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::ProcessBlock(CNode&amp;<sp/>node,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;&amp;<sp/>block,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>force_processing,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>min_pow_checked)</highlight></codeline>
<codeline lineno="3299"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3300"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>new_block{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="3301"><highlight class="normal"><sp/><sp/><sp/><sp/>m_chainman.<ref refid="class_chainstate_manager_1a1e0c145b7a823316fb026a73d305a049" kindref="member">ProcessNewBlock</ref>(block,<sp/>force_processing,<sp/>min_pow_checked,<sp/>&amp;new_block);</highlight></codeline>
<codeline lineno="3302"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(new_block)<sp/>{</highlight></codeline>
<codeline lineno="3303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>node.<ref refid="class_c_node_1a187bf49ad10db6ecf4917f24a17048b6" kindref="member">m_last_block_time</ref><sp/>=<sp/><ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime&lt;std::chrono::seconds&gt;</ref>();</highlight></codeline>
<codeline lineno="3304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>In<sp/>case<sp/>this<sp/>block<sp/>came<sp/>from<sp/>a<sp/>different<sp/>peer<sp/>than<sp/>we<sp/>requested</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>from,<sp/>we<sp/>can<sp/>erase<sp/>the<sp/>block<sp/>request<sp/>now<sp/>anyway<sp/>(as<sp/>we<sp/>just<sp/>stored</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>this<sp/>block<sp/>to<sp/>disk).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="3308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RemoveBlockRequest(block-&gt;GetHash(),<sp/>std::nullopt);</highlight></codeline>
<codeline lineno="3309"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="3311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mapBlockSource.erase(block-&gt;GetHash());</highlight></codeline>
<codeline lineno="3312"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3313"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3314"><highlight class="normal"></highlight></codeline>
<codeline lineno="3315"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::ProcessCompactBlockTxns(CNode&amp;<sp/>pfrom,<sp/>Peer&amp;<sp/>peer,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>BlockTransactions&amp;<sp/>block_transactions)</highlight></codeline>
<codeline lineno="3316"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3317"><highlight class="normal"><sp/><sp/><sp/><sp/>std::shared_ptr&lt;CBlock&gt;<sp/>pblock<sp/>=<sp/>std::make_shared&lt;CBlock&gt;();</highlight></codeline>
<codeline lineno="3318"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fBlockRead{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="3319"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="3321"><highlight class="normal"></highlight></codeline>
<codeline lineno="3322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>range_flight<sp/>=<sp/>mapBlocksInFlight.equal_range(block_transactions.<ref refid="class_block_transactions_1a263d85ccb893578195c39b712b3dbb70" kindref="member">blockhash</ref>);</highlight></codeline>
<codeline lineno="3323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>already_in_flight<sp/>=<sp/>std::distance(range_flight.first,<sp/>range_flight.second);</highlight></codeline>
<codeline lineno="3324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>requested_block_from_this_peer{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="3325"><highlight class="normal"></highlight></codeline>
<codeline lineno="3326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Multimap<sp/>ensures<sp/>ordering<sp/>of<sp/>outstanding<sp/>requests.<sp/>It&apos;s<sp/>either<sp/>empty<sp/>or<sp/>first<sp/>in<sp/>line.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>first_in_flight<sp/>=<sp/>already_in_flight<sp/>==<sp/>0<sp/>||<sp/>(range_flight.first-&gt;second.first<sp/>==<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3328"><highlight class="normal"></highlight></codeline>
<codeline lineno="3329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(range_flight.first<sp/>!=<sp/>range_flight.second)<sp/>{</highlight></codeline>
<codeline lineno="3330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>[node_id,<sp/>block_it]<sp/>=<sp/>range_flight.first-&gt;second;</highlight></codeline>
<codeline lineno="3331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(node_id<sp/>==<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>()<sp/>&amp;&amp;<sp/>block_it-&gt;partialBlock)<sp/>{</highlight></codeline>
<codeline lineno="3332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>requested_block_from_this_peer<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3334"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>range_flight.first++;</highlight></codeline>
<codeline lineno="3336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3337"><highlight class="normal"></highlight></codeline>
<codeline lineno="3338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!requested_block_from_this_peer)<sp/>{</highlight></codeline>
<codeline lineno="3339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Peer<sp/>%d<sp/>sent<sp/>us<sp/>block<sp/>transactions<sp/>for<sp/>block<sp/>we<sp/>weren&apos;t<sp/>expecting\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3340"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3342"><highlight class="normal"></highlight></codeline>
<codeline lineno="3343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PartiallyDownloadedBlock&amp;<sp/>partialBlock<sp/>=<sp/>*range_flight.first-&gt;second.second-&gt;partialBlock;</highlight></codeline>
<codeline lineno="3344"><highlight class="normal"></highlight></codeline>
<codeline lineno="3345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(partialBlock.<ref refid="class_partially_downloaded_block_1af75c697fd3767e6048840bdeba4f8546" kindref="member">header</ref>.<ref refid="class_c_block_header_1ac4d637a0dec45d546495c1660c9f6047" kindref="member">IsNull</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>It<sp/>is<sp/>possible<sp/>for<sp/>the<sp/>header<sp/>to<sp/>be<sp/>empty<sp/>if<sp/>a<sp/>previous<sp/>call<sp/>to<sp/>FillBlock<sp/>wiped<sp/>the<sp/>header,<sp/>but<sp/>left</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>PartiallyDownloadedBlock<sp/>pointer<sp/>around<sp/>(i.e.<sp/>did<sp/>not<sp/>call<sp/>RemoveBlockRequest).<sp/>In<sp/>this<sp/>case,<sp/>we</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3348"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>should<sp/>not<sp/>call<sp/>LookupBlockIndex<sp/>below.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3349"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RemoveBlockRequest(block_transactions.<ref refid="class_block_transactions_1a263d85ccb893578195c39b712b3dbb70" kindref="member">blockhash</ref>,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Misbehaving(peer,<sp/></highlight><highlight class="stringliteral">&quot;previous<sp/>compact<sp/>block<sp/>reconstruction<sp/>attempt<sp/>failed&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3351"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Peer<sp/>%d<sp/>sent<sp/>compact<sp/>block<sp/>transactions<sp/>multiple<sp/>times&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3352"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3354"><highlight class="normal"></highlight></codeline>
<codeline lineno="3355"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>should<sp/>not<sp/>have<sp/>gotten<sp/>this<sp/>far<sp/>in<sp/>compact<sp/>block<sp/>processing<sp/>unless<sp/>it&apos;s<sp/>attached<sp/>to<sp/>a<sp/>known<sp/>header</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3356"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>prev_block{<ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1a87eab19fb1a7e025715c13377ebfd356" kindref="member">LookupBlockIndex</ref>(partialBlock.<ref refid="class_partially_downloaded_block_1af75c697fd3767e6048840bdeba4f8546" kindref="member">header</ref>.<ref refid="class_c_block_header_1a96c46394fa2ffef51517b645bcabcb5e" kindref="member">hashPrevBlock</ref>))};</highlight></codeline>
<codeline lineno="3357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="blockencodings_8h_1a7b89c048c40ea04ec7ba13bb4279f70a" kindref="member">ReadStatus</ref><sp/>status<sp/>=<sp/>partialBlock.<ref refid="class_partially_downloaded_block_1aac4e40d6b890df218627a02b73eb5ca5" kindref="member">FillBlock</ref>(*pblock,<sp/>block_transactions.<ref refid="class_block_transactions_1ac273d76205b09a915aa9e27c5aa14a35" kindref="member">txn</ref>,</highlight></codeline>
<codeline lineno="3358"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*segwit_active=*/</highlight><highlight class="normal"><ref refid="deploymentstatus_8h_1a0f9c7fc832b34b673ebfeadaffc86182" kindref="member">DeploymentActiveAfter</ref>(prev_block,<sp/>m_chainman,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dbac12a10e827db62556122f2b1a9b0431b" kindref="member">Consensus::DEPLOYMENT_SEGWIT</ref>));</highlight></codeline>
<codeline lineno="3359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(status<sp/>==<sp/><ref refid="blockencodings_8h_1a2454e2824c9d3db86bf62fbc974f50cea2c4369130f1cab4f039ffe2bf247d812" kindref="member">READ_STATUS_INVALID</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RemoveBlockRequest(block_transactions.<ref refid="class_block_transactions_1a263d85ccb893578195c39b712b3dbb70" kindref="member">blockhash</ref>,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());<sp/></highlight><highlight class="comment">//<sp/>Reset<sp/>in-flight<sp/>state<sp/>in<sp/>case<sp/>Misbehaving<sp/>does<sp/>not<sp/>result<sp/>in<sp/>a<sp/>disconnect</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Misbehaving(peer,<sp/></highlight><highlight class="stringliteral">&quot;invalid<sp/>compact<sp/>block/non-matching<sp/>block<sp/>transactions&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(status<sp/>==<sp/><ref refid="blockencodings_8h_1a2454e2824c9d3db86bf62fbc974f50ceaee0cfe0767680ec8c16bb91d3c1d9b22" kindref="member">READ_STATUS_FAILED</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(first_in_flight)<sp/>{</highlight></codeline>
<codeline lineno="3365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Might<sp/>have<sp/>collided,<sp/>fall<sp/>back<sp/>to<sp/>getdata<sp/>now<sp/>:(</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3366"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>keep<sp/>the<sp/>failed<sp/>partialBlock<sp/>to<sp/>disallow<sp/>processing<sp/>another<sp/>compact<sp/>block<sp/>announcement<sp/>from<sp/>the<sp/>same</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>peer<sp/>for<sp/>the<sp/>same<sp/>block.<sp/>We<sp/>let<sp/>the<sp/>full<sp/>block<sp/>download<sp/>below<sp/>continue<sp/>under<sp/>the<sp/>same<sp/>m_downloading_since</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>timer.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3369"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CInv&gt;<sp/>invs;</highlight></codeline>
<codeline lineno="3370"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>invs.emplace_back(<ref refid="protocol_8h_1ac1162efdf35b533ba996ac9d1c96fc05a4cae15fd207d555331995cd5c57689c1" kindref="member">MSG_BLOCK</ref><sp/>|<sp/>GetFetchFlags(peer),<sp/>block_transactions.<ref refid="class_block_transactions_1a263d85ccb893578195c39b712b3dbb70" kindref="member">blockhash</ref>);</highlight></codeline>
<codeline lineno="3371"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a18544277034744dbf6f85e748835ecfe" kindref="member">NetMsgType::GETDATA</ref>,<sp/>invs);</highlight></codeline>
<codeline lineno="3372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RemoveBlockRequest(block_transactions.<ref refid="class_block_transactions_1a263d85ccb893578195c39b712b3dbb70" kindref="member">blockhash</ref>,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Peer<sp/>%d<sp/>sent<sp/>us<sp/>a<sp/>compact<sp/>block<sp/>but<sp/>it<sp/>failed<sp/>to<sp/>reconstruct,<sp/>waiting<sp/>on<sp/>first<sp/>download<sp/>to<sp/>complete\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3375"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3376"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3377"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3378"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Block<sp/>is<sp/>okay<sp/>for<sp/>further<sp/>processing</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3379"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RemoveBlockRequest(block_transactions.<ref refid="class_block_transactions_1a263d85ccb893578195c39b712b3dbb70" kindref="member">blockhash</ref>,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());<sp/></highlight><highlight class="comment">//<sp/>it<sp/>is<sp/>now<sp/>an<sp/>empty<sp/>pointer</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3380"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fBlockRead<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3381"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>mapBlockSource<sp/>is<sp/>used<sp/>for<sp/>potentially<sp/>punishing<sp/>peers<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>updating<sp/>which<sp/>peers<sp/>send<sp/>us<sp/>compact<sp/>blocks,<sp/>so<sp/>the<sp/>race</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3383"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>between<sp/>here<sp/>and<sp/>cs_main<sp/>in<sp/>ProcessNewBlock<sp/>is<sp/>fine.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3384"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>BIP<sp/>152<sp/>permits<sp/>peers<sp/>to<sp/>relay<sp/>compact<sp/>blocks<sp/>after<sp/>validating</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3385"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>header<sp/>only;<sp/>we<sp/>should<sp/>not<sp/>punish<sp/>peers<sp/>if<sp/>the<sp/>block<sp/>turns</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>out<sp/>to<sp/>be<sp/>invalid.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3387"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mapBlockSource.emplace(block_transactions.<ref refid="class_block_transactions_1a263d85ccb893578195c39b712b3dbb70" kindref="member">blockhash</ref>,<sp/>std::make_pair(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="3388"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3389"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>Don&apos;t<sp/>hold<sp/>cs_main<sp/>when<sp/>we<sp/>call<sp/>into<sp/>ProcessNewBlock</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3390"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fBlockRead)<sp/>{</highlight></codeline>
<codeline lineno="3391"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Since<sp/>we<sp/>requested<sp/>this<sp/>block<sp/>(it<sp/>was<sp/>in<sp/>mapBlocksInFlight),<sp/>force<sp/>it<sp/>to<sp/>be<sp/>processed,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3392"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>even<sp/>if<sp/>it<sp/>would<sp/>not<sp/>be<sp/>a<sp/>candidate<sp/>for<sp/>new<sp/>tip<sp/>(missing<sp/>previous<sp/>block,<sp/>chain<sp/>not<sp/>long<sp/>enough,<sp/>etc)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3393"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>bypasses<sp/>some<sp/>anti-DoS<sp/>logic<sp/>in<sp/>AcceptBlock<sp/>(eg<sp/>to<sp/>prevent</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3394"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>disk-space<sp/>attacks),<sp/>but<sp/>this<sp/>should<sp/>be<sp/>safe<sp/>due<sp/>to<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3395"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>protections<sp/>in<sp/>the<sp/>compact<sp/>block<sp/>handler<sp/>--<sp/>see<sp/>related<sp/>comment</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3396"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>in<sp/>compact<sp/>block<sp/>optimistic<sp/>reconstruction<sp/>handling.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3397"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="test_2util_2mining_8cpp_1a6176e9db3559841574e0f1caac08cd2c" kindref="member">ProcessBlock</ref>(pfrom,<sp/>pblock,<sp/></highlight><highlight class="comment">/*force_processing=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">,<sp/></highlight><highlight class="comment">/*min_pow_checked=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="3398"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3399"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3400"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3401"><highlight class="normal"></highlight></codeline>
<codeline lineno="3402"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::LogBlockHeader(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex&amp;<sp/>index,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CNode&amp;<sp/>peer,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>via_compact_block)<sp/>{</highlight></codeline>
<codeline lineno="3403"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>To<sp/>prevent<sp/>log<sp/>spam,<sp/>this<sp/>function<sp/>should<sp/>only<sp/>be<sp/>called<sp/>after<sp/>it<sp/>was<sp/>determined<sp/>that<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3404"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>header<sp/>is<sp/>both<sp/>new<sp/>and<sp/>valid.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3405"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3406"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>These<sp/>messages<sp/>are<sp/>valuable<sp/>for<sp/>detecting<sp/>potential<sp/>selfish<sp/>mining<sp/>behavior;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3407"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>multiple<sp/>displacing<sp/>headers<sp/>are<sp/>seen<sp/>near<sp/>simultaneously<sp/>across<sp/>many</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3408"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>nodes<sp/>in<sp/>the<sp/>network,<sp/>this<sp/>might<sp/>be<sp/>an<sp/>indication<sp/>of<sp/>selfish<sp/>mining.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3409"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>In<sp/>addition<sp/>it<sp/>can<sp/>be<sp/>used<sp/>to<sp/>identify<sp/>peers<sp/>which<sp/>send<sp/>us<sp/>a<sp/>header,<sp/>but</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3410"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>don&apos;t<sp/>followup<sp/>with<sp/>a<sp/>complete<sp/>and<sp/>valid<sp/>(compact)<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3411"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Having<sp/>this<sp/>log<sp/>by<sp/>default<sp/>when<sp/>not<sp/>in<sp/>IBD<sp/>ensures<sp/>broad<sp/>availability<sp/>of</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3412"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>this<sp/>data<sp/>in<sp/>case<sp/>investigation<sp/>is<sp/>merited.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3413"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a10a0f35066079abd150539d0d13dbf3e" kindref="member">msg</ref><sp/>=<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight></codeline>
<codeline lineno="3414"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Saw<sp/>new<sp/>%sheader<sp/>hash=%s<sp/>height=%d<sp/>peer=%d%s&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>via_compact_block<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;cmpctblock<sp/>&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3416"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>index.<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),</highlight></codeline>
<codeline lineno="3417"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>index.<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,</highlight></codeline>
<codeline lineno="3418"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),</highlight></codeline>
<codeline lineno="3419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.<ref refid="class_c_node_1a817d9d190e2af5b0bb7c5ed196cdc318" kindref="member">LogIP</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>)</highlight></codeline>
<codeline lineno="3420"><highlight class="normal"><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="3421"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.<ref refid="class_chainstate_manager_1a312bb1a2008bae3205f4699b90880d66" kindref="member">IsInitialBlockDownload</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a7721bbfbdf88038c07a667176e9ab22c" kindref="member">BCLog::VALIDATION</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s&quot;</highlight><highlight class="normal">,<sp/>msg);</highlight></codeline>
<codeline lineno="3423"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3424"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;%s&quot;</highlight><highlight class="normal">,<sp/>msg);</highlight></codeline>
<codeline lineno="3425"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3426"><highlight class="normal">}</highlight></codeline>
<codeline lineno="3427"><highlight class="normal"></highlight></codeline>
<codeline lineno="3428"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::ProcessMessage(CNode&amp;<sp/>pfrom,<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::string&amp;<sp/>msg_type,<sp/>DataStream&amp;<sp/>vRecv,</highlight></codeline>
<codeline lineno="3429"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::chrono::microseconds<sp/>time_received,</highlight></codeline>
<codeline lineno="3430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::atomic&lt;bool&gt;&amp;<sp/>interruptMsgProc)</highlight></codeline>
<codeline lineno="3431"><highlight class="normal">{</highlight></codeline>
<codeline lineno="3432"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="3433"><highlight class="normal"></highlight></codeline>
<codeline lineno="3434"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;received:<sp/>%s<sp/>(%u<sp/>bytes)<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/><ref refid="util_2strencodings_8cpp_1af661610872e92731fc31facae4d42361" kindref="member">SanitizeString</ref>(msg_type),<sp/>vRecv.<ref refid="class_data_stream_1a60304b65bf89363bcc3165d3cde67f86" kindref="member">size</ref>(),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3435"><highlight class="normal"></highlight></codeline>
<codeline lineno="3436"><highlight class="normal"><sp/><sp/><sp/><sp/>PeerRef<sp/>peer<sp/>=<sp/>GetPeerRef(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3437"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3438"><highlight class="normal"></highlight></codeline>
<codeline lineno="3439"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a35aceb690e11a3d78331de7dda9563ae" kindref="member">NetMsgType::VERSION</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3440"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1a52a52a9a2152f8aa8b99bd07a6cf819d" kindref="member">nVersion</ref><sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="3441"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;redundant<sp/>version<sp/>message<sp/>from<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3442"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3443"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3444"><highlight class="normal"></highlight></codeline>
<codeline lineno="3445"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int64_t<sp/>nTime;</highlight></codeline>
<codeline lineno="3446"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CService<sp/>addrMe;</highlight></codeline>
<codeline lineno="3447"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>nNonce<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="3448"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537" kindref="member">ServiceFlags</ref><sp/>nServices;</highlight></codeline>
<codeline lineno="3449"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nVersion;</highlight></codeline>
<codeline lineno="3450"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::string<sp/>cleanSubVer;</highlight></codeline>
<codeline lineno="3451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>starting_height<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="3452"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fRelay<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3453"><highlight class="normal"></highlight></codeline>
<codeline lineno="3454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>nVersion<sp/>&gt;&gt;<sp/>Using&lt;CustomUintFormatter&lt;8&gt;&gt;(nServices)<sp/>&gt;&gt;<sp/>nTime;</highlight></codeline>
<codeline lineno="3455"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nTime<sp/>&lt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="3456"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nTime<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="3457"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3458"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv.<ref refid="class_data_stream_1a2db9cfd90514346fa653cc6bb17e2b0a" kindref="member">ignore</ref>(8);<sp/></highlight><highlight class="comment">//<sp/>Ignore<sp/>the<sp/>addrMe<sp/>service<sp/>bits<sp/>sent<sp/>by<sp/>the<sp/>peer</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3459"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/><ref refid="class_c_net_addr_1a9c9a92b90fc38b4bf84776615f6fd22c" kindref="member">CNetAddr::V1</ref>(addrMe);</highlight></codeline>
<codeline lineno="3460"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pfrom.<ref refid="class_c_node_1a878e09eabda286e4cabf6ffc0fb24ba3" kindref="member">IsInboundConn</ref>())</highlight></codeline>
<codeline lineno="3461"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3462"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Overwrites<sp/>potentially<sp/>existing<sp/>services.<sp/>In<sp/>contrast<sp/>to<sp/>this,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3463"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>unvalidated<sp/>services<sp/>received<sp/>via<sp/>gossip<sp/>relay<sp/>in<sp/>ADDR/ADDRV2</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3464"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>messages<sp/>are<sp/>only<sp/>ever<sp/>added<sp/>but<sp/>cannot<sp/>replace<sp/>existing<sp/>ones.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3465"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_addrman.<ref refid="class_addr_man_1a0b0d0a32c294a075972d91681ed918fb" kindref="member">SetServices</ref>(pfrom.<ref refid="class_c_node_1afefbbc75aa05390712188a0f1e13d6f5" kindref="member">addr</ref>,<sp/>nServices);</highlight></codeline>
<codeline lineno="3466"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3467"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1a15449ecdc579f3a27c591daff6773d5e" kindref="member">ExpectServicesFromConn</ref>()<sp/>&amp;&amp;<sp/>!HasAllDesirableServiceFlags(nServices))</highlight></codeline>
<codeline lineno="3468"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3469"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;peer<sp/>does<sp/>not<sp/>offer<sp/>the<sp/>expected<sp/>services<sp/>(%08x<sp/>offered,<sp/>%08x<sp/>expected),<sp/>%s\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3470"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nServices,</highlight></codeline>
<codeline lineno="3471"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>GetDesirableServiceFlags(nServices),</highlight></codeline>
<codeline lineno="3472"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="3473"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3474"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3475"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3476"><highlight class="normal"></highlight></codeline>
<codeline lineno="3477"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nVersion<sp/>&lt;<sp/>MIN_PEER_PROTO_VERSION)<sp/>{</highlight></codeline>
<codeline lineno="3478"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>disconnect<sp/>from<sp/>peers<sp/>older<sp/>than<sp/>this<sp/>proto<sp/>version</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3479"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;peer<sp/>using<sp/>obsolete<sp/>version<sp/>%i,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>nVersion,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="3480"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3481"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3482"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3483"><highlight class="normal"></highlight></codeline>
<codeline lineno="3484"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!vRecv.<ref refid="class_data_stream_1a644718bb2fb240de962dc3c9a1fdf0dc" kindref="member">empty</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3485"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>version<sp/>message<sp/>includes<sp/>information<sp/>about<sp/>the<sp/>sending<sp/>node<sp/>which<sp/>we<sp/>don&apos;t<sp/>use:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3486"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>-<sp/>8<sp/>bytes<sp/>(service<sp/>bits)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3487"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>-<sp/>16<sp/>bytes<sp/>(ipv6<sp/>address)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3488"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>-<sp/>2<sp/>bytes<sp/>(port)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3489"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv.<ref refid="class_data_stream_1a2db9cfd90514346fa653cc6bb17e2b0a" kindref="member">ignore</ref>(26);</highlight></codeline>
<codeline lineno="3490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>nNonce;</highlight></codeline>
<codeline lineno="3491"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!vRecv.<ref refid="class_data_stream_1a644718bb2fb240de962dc3c9a1fdf0dc" kindref="member">empty</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::string<sp/>strSubVer;</highlight></codeline>
<codeline lineno="3494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/><ref refid="serialize_8h_1a78e63691a056ce2368984400605e4f6e" kindref="member">LIMITED_STRING</ref>(strSubVer,<sp/>MAX_SUBVERSION_LENGTH);</highlight></codeline>
<codeline lineno="3495"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cleanSubVer<sp/>=<sp/><ref refid="util_2strencodings_8cpp_1af661610872e92731fc31facae4d42361" kindref="member">SanitizeString</ref>(strSubVer);</highlight></codeline>
<codeline lineno="3496"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3497"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!vRecv.<ref refid="class_data_stream_1a644718bb2fb240de962dc3c9a1fdf0dc" kindref="member">empty</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>starting_height;</highlight></codeline>
<codeline lineno="3499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!vRecv.<ref refid="class_data_stream_1a644718bb2fb240de962dc3c9a1fdf0dc" kindref="member">empty</ref>())</highlight></codeline>
<codeline lineno="3501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>fRelay;</highlight></codeline>
<codeline lineno="3502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Disconnect<sp/>if<sp/>we<sp/>connected<sp/>to<sp/>ourself</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3503"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1a878e09eabda286e4cabf6ffc0fb24ba3" kindref="member">IsInboundConn</ref>()<sp/>&amp;&amp;<sp/>!m_connman.<ref refid="class_c_connman_1a3d661c95f879db66d23304643d0d2814" kindref="member">CheckIncomingNonce</ref>(nNonce))</highlight></codeline>
<codeline lineno="3504"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;connected<sp/>to<sp/>self<sp/>at<sp/>%s,<sp/>disconnecting\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1afefbbc75aa05390712188a0f1e13d6f5" kindref="member">addr</ref>.<ref refid="class_c_service_1aac5ca8b51c9b88aab6790964f43b0684" kindref="member">ToStringAddrPort</ref>());</highlight></codeline>
<codeline lineno="3506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3508"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3509"><highlight class="normal"></highlight></codeline>
<codeline lineno="3510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1a878e09eabda286e4cabf6ffc0fb24ba3" kindref="member">IsInboundConn</ref>()<sp/>&amp;&amp;<sp/>addrMe.<ref refid="class_c_net_addr_1a060c294e63468f8536252f5a48345e54" kindref="member">IsRoutable</ref>())</highlight></codeline>
<codeline lineno="3511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="net_8cpp_1af7487aacfc9d708b3db40c255ec070a8" kindref="member">SeenLocal</ref>(addrMe);</highlight></codeline>
<codeline lineno="3513"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3514"><highlight class="normal"></highlight></codeline>
<codeline lineno="3515"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Inbound<sp/>peers<sp/>send<sp/>us<sp/>their<sp/>version<sp/>message<sp/>when<sp/>they<sp/>connect.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3516"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>send<sp/>our<sp/>version<sp/>message<sp/>in<sp/>response.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1a878e09eabda286e4cabf6ffc0fb24ba3" kindref="member">IsInboundConn</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PushNodeVersion(pfrom,<sp/>*peer);</highlight></codeline>
<codeline lineno="3519"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3520"><highlight class="normal"></highlight></codeline>
<codeline lineno="3521"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Change<sp/>version</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>greatest_common_version<sp/>=<sp/>std::min(nVersion,<sp/>PROTOCOL_VERSION);</highlight></codeline>
<codeline lineno="3523"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ad0f5b49c773f2b174cbe51841697ec8d" kindref="member">SetCommonVersion</ref>(greatest_common_version);</highlight></codeline>
<codeline lineno="3524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1a52a52a9a2152f8aa8b99bd07a6cf819d" kindref="member">nVersion</ref><sp/>=<sp/>nVersion;</highlight></codeline>
<codeline lineno="3525"><highlight class="normal"></highlight></codeline>
<codeline lineno="3526"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(greatest_common_version<sp/>&gt;=<sp/>WTXID_RELAY_VERSION)<sp/>{</highlight></codeline>
<codeline lineno="3527"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a1760b2ec6136f0c4c15583042d8c1649" kindref="member">NetMsgType::WTXIDRELAY</ref>);</highlight></codeline>
<codeline lineno="3528"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3529"><highlight class="normal"></highlight></codeline>
<codeline lineno="3530"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Signal<sp/>ADDRv2<sp/>support<sp/>(BIP155).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3531"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(greatest_common_version<sp/>&gt;=<sp/>70016)<sp/>{</highlight></codeline>
<codeline lineno="3532"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>BIP155<sp/>defines<sp/>addrv2<sp/>and<sp/>sendaddrv2<sp/>for<sp/>all<sp/>protocol<sp/>versions,<sp/>but<sp/>some</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3533"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>implementations<sp/>reject<sp/>messages<sp/>they<sp/>don&apos;t<sp/>know.<sp/>As<sp/>a<sp/>courtesy,<sp/>don&apos;t<sp/>send</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3534"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>it<sp/>to<sp/>nodes<sp/>with<sp/>a<sp/>version<sp/>before<sp/>70016,<sp/>as<sp/>no<sp/>software<sp/>is<sp/>known<sp/>to<sp/>support</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3535"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>BIP155<sp/>that<sp/>doesn&apos;t<sp/>announce<sp/>at<sp/>least<sp/>that<sp/>protocol<sp/>version<sp/>number.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3536"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a3cade8dd234f4af94968797eebabdc97" kindref="member">NetMsgType::SENDADDRV2</ref>);</highlight></codeline>
<codeline lineno="3537"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3538"><highlight class="normal"></highlight></codeline>
<codeline lineno="3539"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ab956a8ceda2c6369f2c5d4cfbdef63b3" kindref="member">m_has_all_wanted_services</ref><sp/>=<sp/>HasAllDesirableServiceFlags(nServices);</highlight></codeline>
<codeline lineno="3540"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_their_services<sp/>=<sp/>nServices;</highlight></codeline>
<codeline lineno="3541"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1a55cf77cf1c90bc01e759c8599632f215" kindref="member">SetAddrLocal</ref>(addrMe);</highlight></codeline>
<codeline lineno="3542"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3543"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(pfrom.<ref refid="class_c_node_1ac3049eeaf924a9662c552defeb5cceaf" kindref="member">m_subver_mutex</ref>);</highlight></codeline>
<codeline lineno="3544"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.cleanSubVer<sp/>=<sp/>cleanSubVer;</highlight></codeline>
<codeline lineno="3545"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3546"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_starting_height<sp/>=<sp/>starting_height;</highlight></codeline>
<codeline lineno="3547"><highlight class="normal"></highlight></codeline>
<codeline lineno="3548"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>initialize<sp/>the<sp/>Peer::TxRelay<sp/>m_relay_txs<sp/>data<sp/>structure<sp/>if:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3549"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>this<sp/>isn&apos;t<sp/>an<sp/>outbound<sp/>block-relay-only<sp/>connection,<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3550"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>this<sp/>isn&apos;t<sp/>an<sp/>outbound<sp/>feeler<sp/>connection,<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3551"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>fRelay=true<sp/>(the<sp/>peer<sp/>wishes<sp/>to<sp/>receive<sp/>transaction<sp/>announcements)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3552"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>or<sp/>we&apos;re<sp/>offering<sp/>NODE_BLOOM<sp/>to<sp/>this<sp/>peer.<sp/>NODE_BLOOM<sp/>means<sp/>that</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3553"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/>the<sp/>peer<sp/>may<sp/>turn<sp/>on<sp/>transaction<sp/>relay<sp/>later.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3554"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pfrom.<ref refid="class_c_node_1a610ec1d1f02cc4bb029acc3cf47b9f4c" kindref="member">IsBlockOnlyConn</ref>()<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="3555"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!pfrom.<ref refid="class_c_node_1aa2d55484d665a0e541f5dbadd40c8854" kindref="member">IsFeelerConn</ref>()<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="3556"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(fRelay<sp/>||<sp/>(peer-&gt;m_our_services<sp/>&amp;<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a9ca74e44e29a412c070750bdbf2380bb" kindref="member">NODE_BLOOM</ref>)))<sp/>{</highlight></codeline>
<codeline lineno="3557"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">*<sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>tx_relay<sp/>=<sp/>peer-&gt;SetTxRelay();</highlight></codeline>
<codeline lineno="3558"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3559"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(tx_relay-&gt;m_bloom_filter_mutex);</highlight></codeline>
<codeline lineno="3560"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_relay-&gt;m_relay_txs<sp/>=<sp/>fRelay;<sp/></highlight><highlight class="comment">//<sp/>set<sp/>to<sp/>true<sp/>after<sp/>we<sp/>get<sp/>the<sp/>first<sp/>filter*<sp/>message</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3561"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3562"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fRelay)<sp/>pfrom.<ref refid="class_c_node_1acf03c8775bb1dd2139126ccd062ef9f3" kindref="member">m_relays_txs</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3563"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3564"><highlight class="normal"></highlight></codeline>
<codeline lineno="3565"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(greatest_common_version<sp/>&gt;=<sp/>WTXID_RELAY_VERSION<sp/>&amp;&amp;<sp/>m_txreconciliation)<sp/>{</highlight></codeline>
<codeline lineno="3566"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Per<sp/>BIP-330,<sp/>we<sp/>announce<sp/>txreconciliation<sp/>support<sp/>if:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>protocol<sp/>version<sp/>per<sp/>the<sp/>peer&apos;s<sp/>VERSION<sp/>message<sp/>supports<sp/>WTXID_RELAY;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>transaction<sp/>relay<sp/>is<sp/>supported<sp/>per<sp/>the<sp/>peer&apos;s<sp/>VERSION<sp/>message</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>this<sp/>is<sp/>not<sp/>a<sp/>block-relay-only<sp/>connection<sp/>and<sp/>not<sp/>a<sp/>feeler</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3570"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>this<sp/>is<sp/>not<sp/>an<sp/>addr<sp/>fetch<sp/>connection;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3571"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>we<sp/>are<sp/>not<sp/>in<sp/>-blocksonly<sp/>mode.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3572"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">*<sp/>tx_relay<sp/>=<sp/>peer-&gt;GetTxRelay();</highlight></codeline>
<codeline lineno="3573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tx_relay<sp/>&amp;&amp;<sp/><ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(tx_relay-&gt;m_bloom_filter_mutex,<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>tx_relay-&gt;m_relay_txs)<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="3574"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>!pfrom.<ref refid="class_c_node_1a6f655d1fa96f652649182e914c75c7e3" kindref="member">IsAddrFetchConn</ref>()<sp/>&amp;&amp;<sp/>!m_opts.ignore_incoming_txs)<sp/>{</highlight></codeline>
<codeline lineno="3575"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint64_t<sp/>recon_salt<sp/>=<sp/>m_txreconciliation-&gt;PreRegisterPeer(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3576"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1ae95fcadc29824cf359a35b839f514718" kindref="member">NetMsgType::SENDTXRCNCL</ref>,</highlight></codeline>
<codeline lineno="3577"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>TXRECONCILIATION_VERSION,<sp/>recon_salt);</highlight></codeline>
<codeline lineno="3578"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3579"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3580"><highlight class="normal"></highlight></codeline>
<codeline lineno="3581"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a7b95ce6bf7df81fa61248f64e896bd3d" kindref="member">NetMsgType::VERACK</ref>);</highlight></codeline>
<codeline lineno="3582"><highlight class="normal"></highlight></codeline>
<codeline lineno="3583"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Potentially<sp/>mark<sp/>this<sp/>peer<sp/>as<sp/>a<sp/>preferred<sp/>download<sp/>peer.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3584"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3585"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="3586"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CNodeState*<sp/>state<sp/>=<sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3587"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state-&gt;fPreferredDownload<sp/>=<sp/>(!pfrom.<ref refid="class_c_node_1a878e09eabda286e4cabf6ffc0fb24ba3" kindref="member">IsInboundConn</ref>()<sp/>||<sp/>pfrom.<ref refid="class_c_node_1ad093ef142d44eddf28162f2aa26d56c2" kindref="member">HasPermission</ref>(<ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a12b80870cf3a64e605a95b9c521ac46f" kindref="member">NetPermissionFlags::NoBan</ref>))<sp/>&amp;&amp;<sp/>!pfrom.<ref refid="class_c_node_1a6f655d1fa96f652649182e914c75c7e3" kindref="member">IsAddrFetchConn</ref>()<sp/>&amp;&amp;<sp/>CanServeBlocks(*peer);</highlight></codeline>
<codeline lineno="3588"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_num_preferred_download_peers<sp/>+=<sp/>state-&gt;fPreferredDownload;</highlight></codeline>
<codeline lineno="3589"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3590"><highlight class="normal"></highlight></codeline>
<codeline lineno="3591"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Attempt<sp/>to<sp/>initialize<sp/>address<sp/>relay<sp/>for<sp/>outbound<sp/>peers<sp/>and<sp/>use<sp/>result</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3592"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>decide<sp/>whether<sp/>to<sp/>send<sp/>GETADDR,<sp/>so<sp/>that<sp/>we<sp/>don&apos;t<sp/>send<sp/>it<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3593"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>inbound<sp/>or<sp/>outbound<sp/>block-relay-only<sp/>peers.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3594"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>send_getaddr{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="3595"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pfrom.<ref refid="class_c_node_1a878e09eabda286e4cabf6ffc0fb24ba3" kindref="member">IsInboundConn</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3596"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>send_getaddr<sp/>=<sp/>SetupAddressRelay(pfrom,<sp/>*peer);</highlight></codeline>
<codeline lineno="3597"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3598"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(send_getaddr)<sp/>{</highlight></codeline>
<codeline lineno="3599"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Do<sp/>a<sp/>one-time<sp/>address<sp/>fetch<sp/>to<sp/>help<sp/>populate/update<sp/>our<sp/>addrman.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3600"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we&apos;re<sp/>starting<sp/>up<sp/>for<sp/>the<sp/>first<sp/>time,<sp/>our<sp/>addrman<sp/>may<sp/>be<sp/>pretty</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3601"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>empty,<sp/>so<sp/>this<sp/>mechanism<sp/>is<sp/>important<sp/>to<sp/>help<sp/>us<sp/>connect<sp/>to<sp/>the<sp/>network.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3602"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>skip<sp/>this<sp/>for<sp/>block-relay-only<sp/>peers.<sp/>We<sp/>want<sp/>to<sp/>avoid</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3603"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>potentially<sp/>leaking<sp/>addr<sp/>information<sp/>and<sp/>we<sp/>do<sp/>not<sp/>want<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3604"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>indicate<sp/>to<sp/>the<sp/>peer<sp/>that<sp/>we<sp/>will<sp/>participate<sp/>in<sp/>addr<sp/>relay.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3605"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a47f973f3b4441a6402c6778763fdfd19" kindref="member">NetMsgType::GETADDR</ref>);</highlight></codeline>
<codeline lineno="3606"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_getaddr_sent<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3607"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When<sp/>requesting<sp/>a<sp/>getaddr,<sp/>accept<sp/>an<sp/>additional<sp/>MAX_ADDR_TO_SEND<sp/>addresses<sp/>in<sp/>response</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3608"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(bypassing<sp/>the<sp/>MAX_ADDR_PROCESSING_TOKEN_BUCKET<sp/>limit).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3609"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_addr_token_bucket<sp/>+=<sp/>MAX_ADDR_TO_SEND;</highlight></codeline>
<codeline lineno="3610"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3611"><highlight class="normal"></highlight></codeline>
<codeline lineno="3612"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pfrom.<ref refid="class_c_node_1a878e09eabda286e4cabf6ffc0fb24ba3" kindref="member">IsInboundConn</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3613"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>For<sp/>non-inbound<sp/>connections,<sp/>we<sp/>update<sp/>the<sp/>addrman<sp/>to<sp/>record</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3614"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>connection<sp/>success<sp/>so<sp/>that<sp/>addrman<sp/>will<sp/>have<sp/>an<sp/>up-to-date</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3615"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>notion<sp/>of<sp/>which<sp/>peers<sp/>are<sp/>online<sp/>and<sp/>available.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3616"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3617"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>While<sp/>we<sp/>strive<sp/>to<sp/>not<sp/>leak<sp/>information<sp/>about<sp/>block-relay-only</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3618"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>connections<sp/>via<sp/>the<sp/>addrman,<sp/>not<sp/>moving<sp/>an<sp/>address<sp/>to<sp/>the<sp/>tried</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3619"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>table<sp/>is<sp/>also<sp/>potentially<sp/>detrimental<sp/>because<sp/>new-table<sp/>entries</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3620"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>are<sp/>subject<sp/>to<sp/>eviction<sp/>in<sp/>the<sp/>event<sp/>of<sp/>addrman<sp/>collisions.<sp/><sp/>We</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3621"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>mitigate<sp/>the<sp/>information-leak<sp/>by<sp/>never<sp/>calling</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3622"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>AddrMan::Connected()<sp/>on<sp/>block-relay-only<sp/>peers;<sp/>see</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3623"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>FinalizeNode().</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3624"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3625"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>moves<sp/>an<sp/>address<sp/>from<sp/>New<sp/>to<sp/>Tried<sp/>table<sp/>in<sp/>Addrman,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3626"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>resolves<sp/>tried-table<sp/>collisions,<sp/>etc.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3627"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_addrman.<ref refid="class_addr_man_1a706c1c1b34e109a4c2e5310b15a72c4d" kindref="member">Good</ref>(pfrom.<ref refid="class_c_node_1afefbbc75aa05390712188a0f1e13d6f5" kindref="member">addr</ref>);</highlight></codeline>
<codeline lineno="3628"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3629"><highlight class="normal"></highlight></codeline>
<codeline lineno="3630"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>mapped_as{m_connman.<ref refid="class_c_connman_1a2f77334dc8df2c960c3c0c650d3fa9d3" kindref="member">GetMappedAS</ref>(pfrom.<ref refid="class_c_node_1afefbbc75aa05390712188a0f1e13d6f5" kindref="member">addr</ref>)};</highlight></codeline>
<codeline lineno="3631"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;receive<sp/>version<sp/>message:<sp/>%s:<sp/>version<sp/>%d,<sp/>blocks=%d,<sp/>us=%s,<sp/>txrelay=%d,<sp/>peer=%d%s%s\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3632"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cleanSubVer,<sp/>pfrom.<ref refid="class_c_node_1a52a52a9a2152f8aa8b99bd07a6cf819d" kindref="member">nVersion</ref>,</highlight></codeline>
<codeline lineno="3633"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_starting_height,<sp/>addrMe.<ref refid="class_c_service_1aac5ca8b51c9b88aab6790964f43b0684" kindref="member">ToStringAddrPort</ref>(),<sp/>fRelay,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),</highlight></codeline>
<codeline lineno="3634"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1a817d9d190e2af5b0bb7c5ed196cdc318" kindref="member">LogIP</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>),<sp/>(mapped_as<sp/>?<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;,<sp/>mapped_as=%d&quot;</highlight><highlight class="normal">,<sp/>mapped_as)<sp/>:<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="3635"><highlight class="normal"></highlight></codeline>
<codeline lineno="3636"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_time_offset<sp/>=<sp/><ref refid="util_2time_8h_1a8f3f2401a7990dfdbcf694471e95fb1e" kindref="member">NodeSeconds</ref>{std::chrono::seconds{nTime}}<sp/>-<sp/><ref refid="util_2time_8h_1a7a4e7e09a41ff922cf1eb6fdaae4b3ba" kindref="member">Now&lt;NodeSeconds&gt;</ref>();</highlight></codeline>
<codeline lineno="3637"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pfrom.<ref refid="class_c_node_1a878e09eabda286e4cabf6ffc0fb24ba3" kindref="member">IsInboundConn</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3638"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Don&apos;t<sp/>use<sp/>timedata<sp/>samples<sp/>from<sp/>inbound<sp/>peers<sp/>to<sp/>make<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3639"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>harder<sp/>for<sp/>others<sp/>to<sp/>create<sp/>false<sp/>warnings<sp/>about<sp/>our<sp/>clock<sp/>being<sp/>out<sp/>of<sp/>sync.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3640"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_outbound_time_offsets.<ref refid="class_time_offsets_1af0b24c72af07e2ee6068adb4e5b07331" kindref="member">Add</ref>(peer-&gt;m_time_offset);</highlight></codeline>
<codeline lineno="3641"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_outbound_time_offsets.<ref refid="class_time_offsets_1abd5349c19ec974513ad04800fac386b6" kindref="member">WarnIfOutOfSync</ref>();</highlight></codeline>
<codeline lineno="3642"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3643"><highlight class="normal"></highlight></codeline>
<codeline lineno="3644"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>peer<sp/>is<sp/>old<sp/>enough<sp/>to<sp/>have<sp/>the<sp/>old<sp/>alert<sp/>system,<sp/>send<sp/>it<sp/>the<sp/>final<sp/>alert.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3645"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(greatest_common_version<sp/>&lt;=<sp/>70012)<sp/>{</highlight></codeline>
<codeline lineno="3646"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">constexpr</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>finalAlert{</highlight><highlight class="stringliteral">&quot;60010000000000000000000000ffffff7f00000000ffffff7ffeffff7f01ffffff7f00000000ffffff7f00ffffff7f002f555247454e543a20416c657274206b657920636f6d70726f6d697365642c2075706772616465207265717569726564004630440220653febd6410f470f6bae11cad19c48413becb1ac2c17f908fd0fd53bdc3abd5202206d0e9c96fe88d4a0f01ed9dedae2b6f9e00da94cad0fecaae66ecf689bf71b50&quot;</highlight><highlight class="normal">_hex};</highlight></codeline>
<codeline lineno="3647"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/></highlight><highlight class="stringliteral">&quot;alert&quot;</highlight><highlight class="normal">,<sp/>finalAlert);</highlight></codeline>
<codeline lineno="3648"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3649"><highlight class="normal"></highlight></codeline>
<codeline lineno="3650"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Feeler<sp/>connections<sp/>exist<sp/>only<sp/>to<sp/>verify<sp/>if<sp/>address<sp/>is<sp/>online.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3651"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1aa2d55484d665a0e541f5dbadd40c8854" kindref="member">IsFeelerConn</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3652"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;feeler<sp/>connection<sp/>completed,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="3653"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3654"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3655"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3656"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3657"><highlight class="normal"></highlight></codeline>
<codeline lineno="3658"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1a52a52a9a2152f8aa8b99bd07a6cf819d" kindref="member">nVersion</ref><sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="3659"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Must<sp/>have<sp/>a<sp/>version<sp/>message<sp/>before<sp/>anything<sp/>else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3660"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;non-version<sp/>message<sp/>before<sp/>version<sp/>handshake.<sp/>Message<sp/>\&quot;%s\&quot;<sp/>from<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/><ref refid="util_2strencodings_8cpp_1af661610872e92731fc31facae4d42361" kindref="member">SanitizeString</ref>(msg_type),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3661"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3662"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3663"><highlight class="normal"></highlight></codeline>
<codeline lineno="3664"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a7b95ce6bf7df81fa61248f64e896bd3d" kindref="member">NetMsgType::VERACK</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3665"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1a304b58083dbf991d0f448962530c2e94" kindref="member">fSuccessfullyConnected</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3666"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;ignoring<sp/>redundant<sp/>verack<sp/>message<sp/>from<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3667"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3668"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3669"><highlight class="normal"></highlight></codeline>
<codeline lineno="3670"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>new_peer_msg<sp/>=<sp/>[&amp;]()<sp/>{</highlight></codeline>
<codeline lineno="3671"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>mapped_as{m_connman.<ref refid="class_c_connman_1a2f77334dc8df2c960c3c0c650d3fa9d3" kindref="member">GetMappedAS</ref>(pfrom.<ref refid="class_c_node_1afefbbc75aa05390712188a0f1e13d6f5" kindref="member">addr</ref>)};</highlight></codeline>
<codeline lineno="3672"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;New<sp/>%s<sp/>peer<sp/>connected:<sp/>transport:<sp/>%s,<sp/>version:<sp/>%d,<sp/>blocks=%d<sp/>peer=%d%s%s\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3673"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1a1366f7f0a8a51ed138660cae429e1aa1" kindref="member">ConnectionTypeAsString</ref>(),</highlight></codeline>
<codeline lineno="3674"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="connection__types_8cpp_1a0d6e14cbd91c1b85dc5e9b308b4bf28e" kindref="member">TransportTypeAsString</ref>(pfrom.<ref refid="class_c_node_1a580c9459c72d5701458920bdeee5859d" kindref="member">m_transport</ref>-&gt;GetInfo().transport_type),</highlight></codeline>
<codeline lineno="3675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1a52a52a9a2152f8aa8b99bd07a6cf819d" kindref="member">nVersion</ref>.load(),<sp/>peer-&gt;m_starting_height,</highlight></codeline>
<codeline lineno="3676"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>pfrom.<ref refid="class_c_node_1a817d9d190e2af5b0bb7c5ed196cdc318" kindref="member">LogIP</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>),</highlight></codeline>
<codeline lineno="3677"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(mapped_as<sp/>?<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;,<sp/>mapped_as=%d&quot;</highlight><highlight class="normal">,<sp/>mapped_as)<sp/>:<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="3678"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="3679"><highlight class="normal"></highlight></codeline>
<codeline lineno="3680"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Log<sp/>successful<sp/>connections<sp/>unconditionally<sp/>for<sp/>outbound,<sp/>but<sp/>not<sp/>for<sp/>inbound<sp/>as<sp/>those</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3681"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>can<sp/>be<sp/>triggered<sp/>by<sp/>an<sp/>attacker<sp/>at<sp/>high<sp/>rate.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3682"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1a878e09eabda286e4cabf6ffc0fb24ba3" kindref="member">IsInboundConn</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3683"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s&quot;</highlight><highlight class="normal">,<sp/>new_peer_msg());</highlight></codeline>
<codeline lineno="3684"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3685"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;%s&quot;</highlight><highlight class="normal">,<sp/>new_peer_msg());</highlight></codeline>
<codeline lineno="3686"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3687"><highlight class="normal"></highlight></codeline>
<codeline lineno="3688"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1af039a299f31c62d63996fd5907c3f953" kindref="member">GetCommonVersion</ref>()<sp/>&gt;=<sp/>SHORT_IDS_BLOCKS_VERSION)<sp/>{</highlight></codeline>
<codeline lineno="3689"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Tell<sp/>our<sp/>peer<sp/>we<sp/>are<sp/>willing<sp/>to<sp/>provide<sp/>version<sp/>2<sp/>cmpctblocks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3690"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>However,<sp/>we<sp/>do<sp/>not<sp/>request<sp/>new<sp/>block<sp/>announcements<sp/>using</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3691"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>cmpctblock<sp/>messages.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3692"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>send<sp/>this<sp/>to<sp/>non-NODE<sp/>NETWORK<sp/>peers<sp/>as<sp/>well,<sp/>because</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3693"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>they<sp/>may<sp/>wish<sp/>to<sp/>request<sp/>compact<sp/>blocks<sp/>from<sp/>us</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3694"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1ae8d06c3ffaa85c181610c87ed7275b58" kindref="member">NetMsgType::SENDCMPCT</ref>,<sp/></highlight><highlight class="comment">/*high_bandwidth=*/</highlight><highlight class="keyword">false</highlight><highlight class="normal">,<sp/></highlight><highlight class="comment">/*version=*/</highlight><highlight class="normal">CMPCTBLOCKS_VERSION);</highlight></codeline>
<codeline lineno="3695"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3696"><highlight class="normal"></highlight></codeline>
<codeline lineno="3697"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_txreconciliation)<sp/>{</highlight></codeline>
<codeline lineno="3698"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!peer-&gt;m_wtxid_relay<sp/>||<sp/>!m_txreconciliation-&gt;IsPeerRegistered(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>()))<sp/>{</highlight></codeline>
<codeline lineno="3699"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>could<sp/>have<sp/>optimistically<sp/>pre-registered/registered<sp/>the<sp/>peer.<sp/>In<sp/>that<sp/>case,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3700"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>should<sp/>forget<sp/>about<sp/>the<sp/>reconciliation<sp/>state<sp/>here<sp/>if<sp/>this<sp/>wasn&apos;t<sp/>followed</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3701"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>by<sp/>WTXIDRELAY<sp/>(since<sp/>WTXIDRELAY<sp/>can&apos;t<sp/>be<sp/>announced<sp/>later).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3702"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_txreconciliation-&gt;ForgetPeer(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3703"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3704"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3705"><highlight class="normal"></highlight></codeline>
<codeline lineno="3706"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>tx_relay<sp/>=<sp/>peer-&gt;GetTxRelay())<sp/>{</highlight></codeline>
<codeline lineno="3707"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>`TxRelay::m_tx_inventory_to_send`<sp/>must<sp/>be<sp/>empty<sp/>before<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3708"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>version<sp/>handshake<sp/>is<sp/>completed<sp/>as</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3709"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>`TxRelay::m_next_inv_send_time`<sp/>is<sp/>first<sp/>initialised<sp/>in</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3710"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>`SendMessages`<sp/>after<sp/>the<sp/>verack<sp/>is<sp/>received.<sp/>Any<sp/>transactions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3711"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>received<sp/>during<sp/>the<sp/>version<sp/>handshake<sp/>would<sp/>otherwise</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3712"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>immediately<sp/>be<sp/>advertised<sp/>without<sp/>random<sp/>delay,<sp/>potentially</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3713"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>leaking<sp/>the<sp/>time<sp/>of<sp/>arrival<sp/>to<sp/>a<sp/>spy.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3714"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(<ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(</highlight></codeline>
<codeline lineno="3715"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_relay-&gt;m_tx_inventory_mutex,</highlight></codeline>
<codeline lineno="3716"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>tx_relay-&gt;m_tx_inventory_to_send.empty()<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="3717"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_relay-&gt;m_next_inv_send_time<sp/>==<sp/>0s));</highlight></codeline>
<codeline lineno="3718"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3719"><highlight class="normal"></highlight></codeline>
<codeline lineno="3720"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3721"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a35644e2b75a93da0cb0f6c768f34efa8" kindref="member">LOCK2</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>,<sp/>m_tx_download_mutex);</highlight></codeline>
<codeline lineno="3722"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CNodeState*<sp/>state<sp/>=<sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3723"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_txdownloadman.ConnectedPeer(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>node::TxDownloadConnectionInfo<sp/>{</highlight></codeline>
<codeline lineno="3724"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.m_preferred<sp/>=<sp/>state-&gt;fPreferredDownload,</highlight></codeline>
<codeline lineno="3725"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.m_relay_permissions<sp/>=<sp/>pfrom.HasPermission(NetPermissionFlags::Relay),</highlight></codeline>
<codeline lineno="3726"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.m_wtxid_relay<sp/>=<sp/>peer-&gt;m_wtxid_relay,</highlight></codeline>
<codeline lineno="3727"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="3728"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3729"><highlight class="normal"></highlight></codeline>
<codeline lineno="3730"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1a304b58083dbf991d0f448962530c2e94" kindref="member">fSuccessfullyConnected</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3731"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3732"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3733"><highlight class="normal"></highlight></codeline>
<codeline lineno="3734"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a84032835a1817d040fe6388cb79a940a" kindref="member">NetMsgType::SENDHEADERS</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3735"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_prefers_headers<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3736"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3737"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3738"><highlight class="normal"></highlight></codeline>
<codeline lineno="3739"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1ae8d06c3ffaa85c181610c87ed7275b58" kindref="member">NetMsgType::SENDCMPCT</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3740"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>sendcmpct_hb{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="3741"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>sendcmpct_version{0};</highlight></codeline>
<codeline lineno="3742"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>sendcmpct_hb<sp/>&gt;&gt;<sp/>sendcmpct_version;</highlight></codeline>
<codeline lineno="3743"><highlight class="normal"></highlight></codeline>
<codeline lineno="3744"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>support<sp/>compact<sp/>block<sp/>relay<sp/>with<sp/>witnesses</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3745"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(sendcmpct_version<sp/>!=<sp/>CMPCTBLOCKS_VERSION)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3746"><highlight class="normal"></highlight></codeline>
<codeline lineno="3747"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="3748"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CNodeState*<sp/>nodestate<sp/>=<sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3749"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nodestate-&gt;m_provides_cmpctblocks<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3750"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nodestate-&gt;m_requested_hb_cmpctblocks<sp/>=<sp/>sendcmpct_hb;</highlight></codeline>
<codeline lineno="3751"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>save<sp/>whether<sp/>peer<sp/>selects<sp/>us<sp/>as<sp/>BIP152<sp/>high-bandwidth<sp/>peer</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3752"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(receiving<sp/>sendcmpct(1)<sp/>signals<sp/>high-bandwidth,<sp/>sendcmpct(0)<sp/>low-bandwidth)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3753"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1a6fae3240adf466571f06a703e4de7a6c" kindref="member">m_bip152_highbandwidth_from</ref><sp/>=<sp/>sendcmpct_hb;</highlight></codeline>
<codeline lineno="3754"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3755"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3756"><highlight class="normal"></highlight></codeline>
<codeline lineno="3757"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>BIP339<sp/>defines<sp/>feature<sp/>negotiation<sp/>of<sp/>wtxidrelay,<sp/>which<sp/>must<sp/>happen<sp/>between</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3758"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>VERSION<sp/>and<sp/>VERACK<sp/>to<sp/>avoid<sp/>relay<sp/>problems<sp/>from<sp/>switching<sp/>after<sp/>a<sp/>connection<sp/>is<sp/>up.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3759"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a1760b2ec6136f0c4c15583042d8c1649" kindref="member">NetMsgType::WTXIDRELAY</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3760"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1a304b58083dbf991d0f448962530c2e94" kindref="member">fSuccessfullyConnected</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3761"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Disconnect<sp/>peers<sp/>that<sp/>send<sp/>a<sp/>wtxidrelay<sp/>message<sp/>after<sp/>VERACK.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3762"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;wtxidrelay<sp/>received<sp/>after<sp/>verack,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="3763"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3764"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3765"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3766"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1af039a299f31c62d63996fd5907c3f953" kindref="member">GetCommonVersion</ref>()<sp/>&gt;=<sp/>WTXID_RELAY_VERSION)<sp/>{</highlight></codeline>
<codeline lineno="3767"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!peer-&gt;m_wtxid_relay)<sp/>{</highlight></codeline>
<codeline lineno="3768"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_wtxid_relay<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3769"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_wtxid_relay_peers++;</highlight></codeline>
<codeline lineno="3770"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3771"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;ignoring<sp/>duplicate<sp/>wtxidrelay<sp/>from<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3772"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3773"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3774"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;ignoring<sp/>wtxidrelay<sp/>due<sp/>to<sp/>old<sp/>common<sp/>version=%d<sp/>from<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1af039a299f31c62d63996fd5907c3f953" kindref="member">GetCommonVersion</ref>(),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3775"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3776"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3777"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3778"><highlight class="normal"></highlight></codeline>
<codeline lineno="3779"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>BIP155<sp/>defines<sp/>feature<sp/>negotiation<sp/>of<sp/>addrv2<sp/>and<sp/>sendaddrv2,<sp/>which<sp/>must<sp/>happen</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3780"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>between<sp/>VERSION<sp/>and<sp/>VERACK.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3781"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a3cade8dd234f4af94968797eebabdc97" kindref="member">NetMsgType::SENDADDRV2</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3782"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1a304b58083dbf991d0f448962530c2e94" kindref="member">fSuccessfullyConnected</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3783"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Disconnect<sp/>peers<sp/>that<sp/>send<sp/>a<sp/>SENDADDRV2<sp/>message<sp/>after<sp/>VERACK.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3784"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;sendaddrv2<sp/>received<sp/>after<sp/>verack,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="3785"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3786"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3787"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3788"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_wants_addrv2<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3789"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3790"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3791"><highlight class="normal"></highlight></codeline>
<codeline lineno="3792"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Received<sp/>from<sp/>a<sp/>peer<sp/>demonstrating<sp/>readiness<sp/>to<sp/>announce<sp/>transactions<sp/>via<sp/>reconciliations.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3793"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>feature<sp/>negotiation<sp/>must<sp/>happen<sp/>between<sp/>VERSION<sp/>and<sp/>VERACK<sp/>to<sp/>avoid<sp/>relay<sp/>problems</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3794"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>from<sp/>switching<sp/>announcement<sp/>protocols<sp/>after<sp/>the<sp/>connection<sp/>is<sp/>up.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3795"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1ae95fcadc29824cf359a35b839f514718" kindref="member">NetMsgType::SENDTXRCNCL</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3796"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_txreconciliation)<sp/>{</highlight></codeline>
<codeline lineno="3797"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;sendtxrcncl<sp/>from<sp/>peer=%d<sp/>ignored,<sp/>as<sp/>our<sp/>node<sp/>does<sp/>not<sp/>have<sp/>txreconciliation<sp/>enabled\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3798"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3799"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3800"><highlight class="normal"></highlight></codeline>
<codeline lineno="3801"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1a304b58083dbf991d0f448962530c2e94" kindref="member">fSuccessfullyConnected</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3802"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;sendtxrcncl<sp/>received<sp/>after<sp/>verack,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="3803"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3804"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3805"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3806"><highlight class="normal"></highlight></codeline>
<codeline lineno="3807"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Peer<sp/>must<sp/>not<sp/>offer<sp/>us<sp/>reconciliations<sp/>if<sp/>we<sp/>specified<sp/>no<sp/>tx<sp/>relay<sp/>support<sp/>in<sp/>VERSION.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3808"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(RejectIncomingTxs(pfrom))<sp/>{</highlight></codeline>
<codeline lineno="3809"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;sendtxrcncl<sp/>received<sp/>to<sp/>which<sp/>we<sp/>indicated<sp/>no<sp/>tx<sp/>relay,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="3810"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3811"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3812"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3813"><highlight class="normal"></highlight></codeline>
<codeline lineno="3814"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Peer<sp/>must<sp/>not<sp/>offer<sp/>us<sp/>reconciliations<sp/>if<sp/>they<sp/>specified<sp/>no<sp/>tx<sp/>relay<sp/>support<sp/>in<sp/>VERSION.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3815"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>flag<sp/>might<sp/>also<sp/>be<sp/>false<sp/>in<sp/>other<sp/>cases,<sp/>but<sp/>the<sp/>RejectIncomingTxs<sp/>check<sp/>above</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3816"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>eliminates<sp/>them,<sp/>so<sp/>that<sp/>this<sp/>flag<sp/>fully<sp/>represents<sp/>what<sp/>we<sp/>are<sp/>looking<sp/>for.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3817"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">*<sp/>tx_relay<sp/>=<sp/>peer-&gt;GetTxRelay();</highlight></codeline>
<codeline lineno="3818"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tx_relay<sp/>||<sp/>!<ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(tx_relay-&gt;m_bloom_filter_mutex,<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>tx_relay-&gt;m_relay_txs))<sp/>{</highlight></codeline>
<codeline lineno="3819"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;sendtxrcncl<sp/>received<sp/>which<sp/>indicated<sp/>no<sp/>tx<sp/>relay<sp/>to<sp/>us,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="3820"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3821"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3822"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3823"><highlight class="normal"></highlight></codeline>
<codeline lineno="3824"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>peer_txreconcl_version;</highlight></codeline>
<codeline lineno="3825"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>remote_salt;</highlight></codeline>
<codeline lineno="3826"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>peer_txreconcl_version<sp/>&gt;&gt;<sp/>remote_salt;</highlight></codeline>
<codeline lineno="3827"><highlight class="normal"></highlight></codeline>
<codeline lineno="3828"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="txreconciliation_8h_1a7a6f29933f8f0193e0b8289468a2337f" kindref="member">ReconciliationRegisterResult</ref><sp/>result<sp/>=<sp/>m_txreconciliation-&gt;RegisterPeer(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>pfrom.<ref refid="class_c_node_1a878e09eabda286e4cabf6ffc0fb24ba3" kindref="member">IsInboundConn</ref>(),</highlight></codeline>
<codeline lineno="3829"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer_txreconcl_version,<sp/>remote_salt);</highlight></codeline>
<codeline lineno="3830"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal"><sp/>(result)<sp/>{</highlight></codeline>
<codeline lineno="3831"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="txreconciliation_8h_1a7a6f29933f8f0193e0b8289468a2337fa8c02547a8a3b02382bac3557bcb2280d" kindref="member">ReconciliationRegisterResult::NOT_FOUND</ref>:</highlight></codeline>
<codeline lineno="3832"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Ignore<sp/>unexpected<sp/>txreconciliation<sp/>signal<sp/>from<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3833"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3834"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="txreconciliation_8h_1a7a6f29933f8f0193e0b8289468a2337fad0749aaba8b833466dfcbb0428e4f89c" kindref="member">ReconciliationRegisterResult::SUCCESS</ref>:</highlight></codeline>
<codeline lineno="3835"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3836"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="txreconciliation_8h_1a7a6f29933f8f0193e0b8289468a2337fa2ed29473219607b1b8c2d77f28b1df5c" kindref="member">ReconciliationRegisterResult::ALREADY_REGISTERED</ref>:</highlight></codeline>
<codeline lineno="3837"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;txreconciliation<sp/>protocol<sp/>violation<sp/>(sendtxrcncl<sp/>received<sp/>from<sp/>already<sp/>registered<sp/>peer),<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="3838"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3839"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3840"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/><ref refid="txreconciliation_8h_1a7a6f29933f8f0193e0b8289468a2337faa224afc9af395429edad294f94a9ae14" kindref="member">ReconciliationRegisterResult::PROTOCOL_VIOLATION</ref>:</highlight></codeline>
<codeline lineno="3841"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;txreconciliation<sp/>protocol<sp/>violation,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="3842"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3843"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3844"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3845"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3846"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3847"><highlight class="normal"></highlight></codeline>
<codeline lineno="3848"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pfrom.<ref refid="class_c_node_1a304b58083dbf991d0f448962530c2e94" kindref="member">fSuccessfullyConnected</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3849"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Unsupported<sp/>message<sp/>\&quot;%s\&quot;<sp/>prior<sp/>to<sp/>verack<sp/>from<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/><ref refid="util_2strencodings_8cpp_1af661610872e92731fc31facae4d42361" kindref="member">SanitizeString</ref>(msg_type),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3850"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3851"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3852"><highlight class="normal"></highlight></codeline>
<codeline lineno="3853"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a727f2266aa41f763e1dda50133f71078" kindref="member">NetMsgType::ADDR</ref><sp/>||<sp/>msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a63d100c38422ce00c66b37d69a07c33e" kindref="member">NetMsgType::ADDRV2</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3854"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>ser_params{</highlight></codeline>
<codeline lineno="3855"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a63d100c38422ce00c66b37d69a07c33e" kindref="member">NetMsgType::ADDRV2</ref><sp/>?</highlight></codeline>
<codeline lineno="3856"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Set<sp/>V2<sp/>param<sp/>so<sp/>that<sp/>the<sp/>CNetAddr<sp/>and<sp/>CAddress</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3857"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>unserialize<sp/>methods<sp/>know<sp/>that<sp/>an<sp/>address<sp/>in<sp/>v2<sp/>format<sp/>is<sp/>coming.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3858"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_address_1a3e08cfe400d30e4bdb6ab6c47e8629d6" kindref="member">CAddress::V2_NETWORK</ref><sp/>:</highlight></codeline>
<codeline lineno="3859"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="class_c_address_1a591c2be3475b55db0a72bc14c90dff38" kindref="member">CAddress::V1_NETWORK</ref>,</highlight></codeline>
<codeline lineno="3860"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="3861"><highlight class="normal"></highlight></codeline>
<codeline lineno="3862"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CAddress&gt;<sp/>vAddr;</highlight></codeline>
<codeline lineno="3863"><highlight class="normal"></highlight></codeline>
<codeline lineno="3864"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>ser_params(vAddr);</highlight></codeline>
<codeline lineno="3865"><highlight class="normal"></highlight></codeline>
<codeline lineno="3866"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!SetupAddressRelay(pfrom,<sp/>*peer))<sp/>{</highlight></codeline>
<codeline lineno="3867"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;ignoring<sp/>%s<sp/>message<sp/>from<sp/>%s<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>msg_type,<sp/>pfrom.<ref refid="class_c_node_1a1366f7f0a8a51ed138660cae429e1aa1" kindref="member">ConnectionTypeAsString</ref>(),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3868"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3869"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3870"><highlight class="normal"></highlight></codeline>
<codeline lineno="3871"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vAddr.size()<sp/>&gt;<sp/>MAX_ADDR_TO_SEND)</highlight></codeline>
<codeline lineno="3872"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3873"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Misbehaving(*peer,<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;%s<sp/>message<sp/>size<sp/>=<sp/>%u&quot;</highlight><highlight class="normal">,<sp/>msg_type,<sp/>vAddr.size()));</highlight></codeline>
<codeline lineno="3874"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3875"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3876"><highlight class="normal"></highlight></codeline>
<codeline lineno="3877"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Store<sp/>the<sp/>new<sp/>addresses</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3878"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CAddress&gt;<sp/>vAddrOk;</highlight></codeline>
<codeline lineno="3879"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>current_a_time{<ref refid="util_2time_8h_1a7a4e7e09a41ff922cf1eb6fdaae4b3ba" kindref="member">Now&lt;NodeSeconds&gt;</ref>()};</highlight></codeline>
<codeline lineno="3880"><highlight class="normal"></highlight></codeline>
<codeline lineno="3881"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Update/increment<sp/>addr<sp/>rate<sp/>limiting<sp/>bucket.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3882"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>current_time{<ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime&lt;std::chrono::microseconds&gt;</ref>()};</highlight></codeline>
<codeline lineno="3883"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer-&gt;m_addr_token_bucket<sp/>&lt;<sp/>MAX_ADDR_PROCESSING_TOKEN_BUCKET)<sp/>{</highlight></codeline>
<codeline lineno="3884"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Don&apos;t<sp/>increment<sp/>bucket<sp/>if<sp/>it&apos;s<sp/>already<sp/>full</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3885"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>time_diff<sp/>=<sp/>std::max(current_time<sp/>-<sp/>peer-&gt;m_addr_token_timestamp,<sp/>0us);</highlight></codeline>
<codeline lineno="3886"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">double</highlight><highlight class="normal"><sp/>increment<sp/>=<sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;SecondsDouble&gt;</ref>(time_diff)<sp/>*<sp/>MAX_ADDR_RATE_PER_SECOND;</highlight></codeline>
<codeline lineno="3887"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_addr_token_bucket<sp/>=<sp/>std::min&lt;double&gt;(peer-&gt;m_addr_token_bucket<sp/>+<sp/>increment,<sp/>MAX_ADDR_PROCESSING_TOKEN_BUCKET);</highlight></codeline>
<codeline lineno="3888"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3889"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_addr_token_timestamp<sp/>=<sp/>current_time;</highlight></codeline>
<codeline lineno="3890"><highlight class="normal"></highlight></codeline>
<codeline lineno="3891"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>rate_limited<sp/>=<sp/>!pfrom.<ref refid="class_c_node_1ad093ef142d44eddf28162f2aa26d56c2" kindref="member">HasPermission</ref>(<ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a3649a5e29ad648f3cfe3eea1a93d2f78" kindref="member">NetPermissionFlags::Addr</ref>);</highlight></codeline>
<codeline lineno="3892"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>num_proc<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="3893"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/>num_rate_limit<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="3894"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::shuffle(vAddr.begin(),<sp/>vAddr.end(),<sp/>m_rng);</highlight></codeline>
<codeline lineno="3895"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(CAddress&amp;<sp/>addr<sp/>:<sp/>vAddr)</highlight></codeline>
<codeline lineno="3896"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3897"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(interruptMsgProc)</highlight></codeline>
<codeline lineno="3898"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3899"><highlight class="normal"></highlight></codeline>
<codeline lineno="3900"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Apply<sp/>rate<sp/>limiting.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3901"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer-&gt;m_addr_token_bucket<sp/>&lt;<sp/>1.0)<sp/>{</highlight></codeline>
<codeline lineno="3902"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(rate_limited)<sp/>{</highlight></codeline>
<codeline lineno="3903"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++num_rate_limit;</highlight></codeline>
<codeline lineno="3904"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3905"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3906"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3907"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_addr_token_bucket<sp/>-=<sp/>1.0;</highlight></codeline>
<codeline lineno="3908"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3909"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>only<sp/>bother<sp/>storing<sp/>full<sp/>nodes,<sp/>though<sp/>this<sp/>may<sp/>include</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3910"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>things<sp/>which<sp/>we<sp/>would<sp/>not<sp/>make<sp/>an<sp/>outbound<sp/>connection<sp/>to,<sp/>in</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3911"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>part<sp/>because<sp/>we<sp/>may<sp/>make<sp/>feeler<sp/>connections<sp/>to<sp/>them.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3912"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!MayHaveUsefulAddressDB(addr.<ref refid="class_c_address_1a45a80242c5f6e9d562cfc8b3604ec428" kindref="member">nServices</ref>)<sp/>&amp;&amp;<sp/>!HasAllDesirableServiceFlags(addr.<ref refid="class_c_address_1a45a80242c5f6e9d562cfc8b3604ec428" kindref="member">nServices</ref>))</highlight></codeline>
<codeline lineno="3913"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3914"><highlight class="normal"></highlight></codeline>
<codeline lineno="3915"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(addr.<ref refid="class_c_address_1aefa6238a6d765e21b1ed3452e7d6ef6b" kindref="member">nTime</ref><sp/>&lt;=<sp/><ref refid="util_2time_8h_1a8f3f2401a7990dfdbcf694471e95fb1e" kindref="member">NodeSeconds</ref>{100000000s}<sp/>||<sp/>addr.<ref refid="class_c_address_1aefa6238a6d765e21b1ed3452e7d6ef6b" kindref="member">nTime</ref><sp/>&gt;<sp/>current_a_time<sp/>+<sp/>10min)<sp/>{</highlight></codeline>
<codeline lineno="3916"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>addr.<ref refid="class_c_address_1aefa6238a6d765e21b1ed3452e7d6ef6b" kindref="member">nTime</ref><sp/>=<sp/>current_a_time<sp/>-<sp/>5<sp/>*<sp/>24h;</highlight></codeline>
<codeline lineno="3917"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3918"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>AddAddressKnown(*peer,<sp/>addr);</highlight></codeline>
<codeline lineno="3919"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_banman<sp/>&amp;&amp;<sp/>(m_banman-&gt;<ref refid="class_ban_man_1af7d32bca9986074cb492e33b9877761a" kindref="member">IsDiscouraged</ref>(addr)<sp/>||<sp/>m_banman-&gt;<ref refid="class_ban_man_1a21b4c78e5821899ff2b5bb60b03ce19f" kindref="member">IsBanned</ref>(addr)))<sp/>{</highlight></codeline>
<codeline lineno="3920"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Do<sp/>not<sp/>process<sp/>banned/discouraged<sp/>addresses<sp/>beyond<sp/>remembering<sp/>we<sp/>received<sp/>them</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3921"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3922"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3923"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>++num_proc;</highlight></codeline>
<codeline lineno="3924"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>reachable{<ref refid="netbase_8cpp_1aafd55770725b866c8a3129d37dca0244" kindref="member">g_reachable_nets</ref>.<ref refid="class_reachable_nets_1afd017cf8a1d0cb945cc0b86b9e72bdb1" kindref="member">Contains</ref>(addr)};</highlight></codeline>
<codeline lineno="3925"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(addr.<ref refid="class_c_address_1aefa6238a6d765e21b1ed3452e7d6ef6b" kindref="member">nTime</ref><sp/>&gt;<sp/>current_a_time<sp/>-<sp/>10min<sp/>&amp;&amp;<sp/>!peer-&gt;m_getaddr_sent<sp/>&amp;&amp;<sp/>vAddr.size()<sp/>&lt;=<sp/>10<sp/>&amp;&amp;<sp/>addr.<ref refid="class_c_net_addr_1a060c294e63468f8536252f5a48345e54" kindref="member">IsRoutable</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3926"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Relay<sp/>to<sp/>a<sp/>limited<sp/>number<sp/>of<sp/>other<sp/>nodes</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3927"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RelayAddress(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>addr,<sp/>reachable);</highlight></codeline>
<codeline lineno="3928"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3929"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Do<sp/>not<sp/>store<sp/>addresses<sp/>outside<sp/>our<sp/>network</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3930"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(reachable)<sp/>{</highlight></codeline>
<codeline lineno="3931"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vAddrOk.push_back(addr);</highlight></codeline>
<codeline lineno="3932"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3933"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3934"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_addr_processed<sp/>+=<sp/>num_proc;</highlight></codeline>
<codeline lineno="3935"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_addr_rate_limited<sp/>+=<sp/>num_rate_limit;</highlight></codeline>
<codeline lineno="3936"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Received<sp/>addr:<sp/>%u<sp/>addresses<sp/>(%u<sp/>processed,<sp/>%u<sp/>rate-limited)<sp/>from<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="3937"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vAddr.size(),<sp/>num_proc,<sp/>num_rate_limit,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3938"><highlight class="normal"></highlight></codeline>
<codeline lineno="3939"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_addrman.<ref refid="class_addr_man_1af0acda4d7598ebd2cb76c8ee97ee845f" kindref="member">Add</ref>(vAddrOk,<sp/>pfrom.<ref refid="class_c_node_1afefbbc75aa05390712188a0f1e13d6f5" kindref="member">addr</ref>,<sp/>2h);</highlight></codeline>
<codeline lineno="3940"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vAddr.size()<sp/>&lt;<sp/>1000)<sp/>peer-&gt;m_getaddr_sent<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3941"><highlight class="normal"></highlight></codeline>
<codeline lineno="3942"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>AddrFetch:<sp/>Require<sp/>multiple<sp/>addresses<sp/>to<sp/>avoid<sp/>disconnecting<sp/>on<sp/>self-announcements</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3943"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1a6f655d1fa96f652649182e914c75c7e3" kindref="member">IsAddrFetchConn</ref>()<sp/>&amp;&amp;<sp/>vAddr.size()<sp/>&gt;<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="3944"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;addrfetch<sp/>connection<sp/>completed,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="3945"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3946"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3947"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3948"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3949"><highlight class="normal"></highlight></codeline>
<codeline lineno="3950"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a74ff47f13e393d7fa01ca77282ae01f6" kindref="member">NetMsgType::INV</ref>)<sp/>{</highlight></codeline>
<codeline lineno="3951"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CInv&gt;<sp/>vInv;</highlight></codeline>
<codeline lineno="3952"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>vInv;</highlight></codeline>
<codeline lineno="3953"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vInv.size()<sp/>&gt;<sp/>MAX_INV_SZ)</highlight></codeline>
<codeline lineno="3954"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="3955"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Misbehaving(*peer,<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;inv<sp/>message<sp/>size<sp/>=<sp/>%u&quot;</highlight><highlight class="normal">,<sp/>vInv.size()));</highlight></codeline>
<codeline lineno="3956"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3957"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3958"><highlight class="normal"></highlight></codeline>
<codeline lineno="3959"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>reject_tx_invs{RejectIncomingTxs(pfrom)};</highlight></codeline>
<codeline lineno="3960"><highlight class="normal"></highlight></codeline>
<codeline lineno="3961"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a35644e2b75a93da0cb0f6c768f34efa8" kindref="member">LOCK2</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>m_tx_download_mutex);</highlight></codeline>
<codeline lineno="3962"><highlight class="normal"></highlight></codeline>
<codeline lineno="3963"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>current_time{<ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime&lt;std::chrono::microseconds&gt;</ref>()};</highlight></codeline>
<codeline lineno="3964"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint256*<sp/>best_block{</highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="3965"><highlight class="normal"></highlight></codeline>
<codeline lineno="3966"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(CInv&amp;<sp/>inv<sp/>:<sp/>vInv)<sp/>{</highlight></codeline>
<codeline lineno="3967"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(interruptMsgProc)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3968"><highlight class="normal"></highlight></codeline>
<codeline lineno="3969"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ignore<sp/>INVs<sp/>that<sp/>don&apos;t<sp/>match<sp/>wtxidrelay<sp/>setting.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3970"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note<sp/>that<sp/>orphan<sp/>parent<sp/>fetching<sp/>always<sp/>uses<sp/>MSG_TX<sp/>GETDATAs<sp/>regardless<sp/>of<sp/>the<sp/>wtxidrelay<sp/>setting.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3971"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>is<sp/>fine<sp/>as<sp/>no<sp/>INV<sp/>messages<sp/>are<sp/>involved<sp/>in<sp/>that<sp/>process.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3972"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer-&gt;m_wtxid_relay)<sp/>{</highlight></codeline>
<codeline lineno="3973"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(inv.<ref refid="class_c_inv_1a44141828f1bea7793381c5be37e9b828" kindref="member">IsMsgTx</ref>())<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3974"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="3975"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(inv.<ref refid="class_c_inv_1a3e4d0f952ee25cf90ee3941a763cc64d" kindref="member">IsMsgWtx</ref>())<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3976"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3977"><highlight class="normal"></highlight></codeline>
<codeline lineno="3978"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(inv.<ref refid="class_c_inv_1a882b1b632a99d4f0658f6ee175225ea6" kindref="member">IsMsgBlk</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3979"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fAlreadyHave<sp/>=<sp/>AlreadyHaveBlock(inv.<ref refid="class_c_inv_1aa5db1ede9ecd9798d4549e62e5e19745" kindref="member">hash</ref>);</highlight></codeline>
<codeline lineno="3980"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;got<sp/>inv:<sp/>%s<sp/><sp/>%s<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>inv.<ref refid="class_c_inv_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>(),<sp/>fAlreadyHave<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;have&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;new&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="3981"><highlight class="normal"></highlight></codeline>
<codeline lineno="3982"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>UpdateBlockAvailability(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>inv.<ref refid="class_c_inv_1aa5db1ede9ecd9798d4549e62e5e19745" kindref="member">hash</ref>);</highlight></codeline>
<codeline lineno="3983"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!fAlreadyHave<sp/>&amp;&amp;<sp/>!m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1acef48b2a0b8aa252efa69928192b4d5a" kindref="member">LoadingBlocks</ref>()<sp/>&amp;&amp;<sp/>!IsBlockRequested(inv.<ref refid="class_c_inv_1aa5db1ede9ecd9798d4549e62e5e19745" kindref="member">hash</ref>))<sp/>{</highlight></codeline>
<codeline lineno="3984"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Headers-first<sp/>is<sp/>the<sp/>primary<sp/>method<sp/>of<sp/>announcement<sp/>on</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3985"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>network.<sp/>If<sp/>a<sp/>node<sp/>fell<sp/>back<sp/>to<sp/>sending<sp/>blocks<sp/>by</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3986"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>inv,<sp/>it<sp/>may<sp/>be<sp/>for<sp/>a<sp/>re-org,<sp/>or<sp/>because<sp/>we<sp/>haven&apos;t</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3987"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>completed<sp/>initial<sp/>headers<sp/>sync.<sp/>The<sp/>final<sp/>block<sp/>hash</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3988"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>provided<sp/>should<sp/>be<sp/>the<sp/>highest,<sp/>so<sp/>send<sp/>a<sp/>getheaders<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3989"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>then<sp/>fetch<sp/>the<sp/>blocks<sp/>we<sp/>need<sp/>to<sp/>catch<sp/>up.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3990"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>best_block<sp/>=<sp/>&amp;inv.<ref refid="class_c_inv_1aa5db1ede9ecd9798d4549e62e5e19745" kindref="member">hash</ref>;</highlight></codeline>
<codeline lineno="3991"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3992"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(inv.<ref refid="class_c_inv_1aa98ef9a38b0329822017522c9b98e358" kindref="member">IsGenTxMsg</ref>())<sp/>{</highlight></codeline>
<codeline lineno="3993"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(reject_tx_invs)<sp/>{</highlight></codeline>
<codeline lineno="3994"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;transaction<sp/>(%s)<sp/>inv<sp/>sent<sp/>in<sp/>violation<sp/>of<sp/>protocol,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>inv.<ref refid="class_c_inv_1aa5db1ede9ecd9798d4549e62e5e19745" kindref="member">hash</ref>.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="3995"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3996"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="3997"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="3998"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>GenTxid<sp/>gtxid<sp/>=<sp/><ref refid="protocol_8cpp_1a3466d64f79e3865dc16910ed3d1ba3d8" kindref="member">ToGenTxid</ref>(inv);</highlight></codeline>
<codeline lineno="3999"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>AddKnownTx(*peer,<sp/>inv.<ref refid="class_c_inv_1aa5db1ede9ecd9798d4549e62e5e19745" kindref="member">hash</ref>);</highlight></codeline>
<codeline lineno="4000"><highlight class="normal"></highlight></codeline>
<codeline lineno="4001"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_chainman.<ref refid="class_chainstate_manager_1a312bb1a2008bae3205f4699b90880d66" kindref="member">IsInitialBlockDownload</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4002"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fAlreadyHave{m_txdownloadman.AddTxAnnouncement(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>gtxid,<sp/>current_time)};</highlight></codeline>
<codeline lineno="4003"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;got<sp/>inv:<sp/>%s<sp/><sp/>%s<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>inv.<ref refid="class_c_inv_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>(),<sp/>fAlreadyHave<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;have&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;new&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4004"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4005"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4006"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Unknown<sp/>inv<sp/>type<sp/>\&quot;%s\&quot;<sp/>received<sp/>from<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>inv.<ref refid="class_c_inv_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>(),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4007"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4008"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4009"><highlight class="normal"></highlight></codeline>
<codeline lineno="4010"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(best_block<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="4011"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>haven&apos;t<sp/>started<sp/>initial<sp/>headers-sync<sp/>with<sp/>this<sp/>peer,<sp/>then</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4012"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>consider<sp/>sending<sp/>a<sp/>getheaders<sp/>now.<sp/>On<sp/>initial<sp/>startup,<sp/>there&apos;s<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4013"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>reliability<sp/>vs<sp/>bandwidth<sp/>tradeoff,<sp/>where<sp/>we<sp/>are<sp/>only<sp/>trying<sp/>to<sp/>do</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4014"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>initial<sp/>headers<sp/>sync<sp/>with<sp/>one<sp/>peer<sp/>at<sp/>a<sp/>time,<sp/>with<sp/>a<sp/>long</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4015"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>timeout<sp/>(at<sp/>which<sp/>point,<sp/>if<sp/>the<sp/>sync<sp/>hasn&apos;t<sp/>completed,<sp/>we<sp/>will</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4016"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>disconnect<sp/>the<sp/>peer<sp/>and<sp/>then<sp/>choose<sp/>another).<sp/>In<sp/>the<sp/>meantime,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4017"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>as<sp/>new<sp/>blocks<sp/>are<sp/>found,<sp/>we<sp/>are<sp/>willing<sp/>to<sp/>add<sp/>one<sp/>new<sp/>peer<sp/>per</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4018"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>block<sp/>to<sp/>sync<sp/>with<sp/>as<sp/>well,<sp/>to<sp/>sync<sp/>quicker<sp/>in<sp/>the<sp/>case<sp/>where</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4019"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>our<sp/>initial<sp/>peer<sp/>is<sp/>unresponsive<sp/>(but<sp/>less<sp/>bandwidth<sp/>than<sp/>we&apos;d</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4020"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>use<sp/>if<sp/>we<sp/>turned<sp/>on<sp/>sync<sp/>with<sp/>all<sp/>peers).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4021"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CNodeState&amp;<sp/>state{*<ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(<ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>()))};</highlight></codeline>
<codeline lineno="4022"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.fSyncStarted<sp/>||<sp/>(!peer-&gt;m_inv_triggered_getheaders_before_sync<sp/>&amp;&amp;<sp/>*best_block<sp/>!=<sp/>m_last_block_inv_triggering_headers_sync))<sp/>{</highlight></codeline>
<codeline lineno="4023"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(MaybeSendGetHeaders(pfrom,<sp/><ref refid="chain_8cpp_1a6f7cb8de33a43e97b3dd7517998379bc" kindref="member">GetLocator</ref>(m_chainman.m_best_header),<sp/>*peer))<sp/>{</highlight></codeline>
<codeline lineno="4024"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;getheaders<sp/>(%d)<sp/>%s<sp/>to<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="4025"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_chainman.m_best_header-&gt;nHeight,<sp/>best_block-&gt;<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),</highlight></codeline>
<codeline lineno="4026"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4027"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4028"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!state.fSyncStarted)<sp/>{</highlight></codeline>
<codeline lineno="4029"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_inv_triggered_getheaders_before_sync<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4030"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Update<sp/>the<sp/>last<sp/>block<sp/>hash<sp/>that<sp/>triggered<sp/>a<sp/>new<sp/>headers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4031"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>sync,<sp/>so<sp/>that<sp/>we<sp/>don&apos;t<sp/>turn<sp/>on<sp/>headers<sp/>sync<sp/>with<sp/>more</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4032"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>than<sp/>1<sp/>new<sp/>peer<sp/>every<sp/>new<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4033"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_last_block_inv_triggering_headers_sync<sp/>=<sp/>*best_block;</highlight></codeline>
<codeline lineno="4034"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4035"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4036"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4037"><highlight class="normal"></highlight></codeline>
<codeline lineno="4038"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4039"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4040"><highlight class="normal"></highlight></codeline>
<codeline lineno="4041"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a18544277034744dbf6f85e748835ecfe" kindref="member">NetMsgType::GETDATA</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4042"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CInv&gt;<sp/>vInv;</highlight></codeline>
<codeline lineno="4043"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>vInv;</highlight></codeline>
<codeline lineno="4044"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vInv.size()<sp/>&gt;<sp/>MAX_INV_SZ)</highlight></codeline>
<codeline lineno="4045"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4046"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Misbehaving(*peer,<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;getdata<sp/>message<sp/>size<sp/>=<sp/>%u&quot;</highlight><highlight class="normal">,<sp/>vInv.size()));</highlight></codeline>
<codeline lineno="4047"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4048"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4049"><highlight class="normal"></highlight></codeline>
<codeline lineno="4050"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;received<sp/>getdata<sp/>(%u<sp/>invsz)<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>vInv.size(),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4051"><highlight class="normal"></highlight></codeline>
<codeline lineno="4052"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vInv.size()<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="4053"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;received<sp/>getdata<sp/>for:<sp/>%s<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>vInv[0].<ref refid="bitcoin-cli_8cpp_1aec2c30b1707eac00ff7e4fb5b3f7a92d" kindref="member">ToString</ref>(),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4054"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4055"><highlight class="normal"></highlight></codeline>
<codeline lineno="4056"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4057"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(peer-&gt;m_getdata_requests_mutex);</highlight></codeline>
<codeline lineno="4058"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_getdata_requests.insert(peer-&gt;m_getdata_requests.end(),<sp/>vInv.begin(),<sp/>vInv.end());</highlight></codeline>
<codeline lineno="4059"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ProcessGetData(pfrom,<sp/>*peer,<sp/>interruptMsgProc);</highlight></codeline>
<codeline lineno="4060"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4061"><highlight class="normal"></highlight></codeline>
<codeline lineno="4062"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4063"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4064"><highlight class="normal"></highlight></codeline>
<codeline lineno="4065"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a710ef9d5140b30a035db02678afd9deb" kindref="member">NetMsgType::GETBLOCKS</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4066"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockLocator<sp/>locator;</highlight></codeline>
<codeline lineno="4067"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint256<sp/>hashStop;</highlight></codeline>
<codeline lineno="4068"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>locator<sp/>&gt;&gt;<sp/>hashStop;</highlight></codeline>
<codeline lineno="4069"><highlight class="normal"></highlight></codeline>
<codeline lineno="4070"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(locator.<ref refid="struct_c_block_locator_1af22e36b5cd0c4f442c0e8f14252711f4" kindref="member">vHave</ref>.size()<sp/>&gt;<sp/>MAX_LOCATOR_SZ)<sp/>{</highlight></codeline>
<codeline lineno="4071"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;getblocks<sp/>locator<sp/>size<sp/>%lld<sp/>&gt;<sp/>%d,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>locator.<ref refid="struct_c_block_locator_1af22e36b5cd0c4f442c0e8f14252711f4" kindref="member">vHave</ref>.size(),<sp/>MAX_LOCATOR_SZ,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="4072"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4073"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4074"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4075"><highlight class="normal"></highlight></codeline>
<codeline lineno="4076"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>might<sp/>have<sp/>announced<sp/>the<sp/>currently-being-connected<sp/>tip<sp/>using<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4077"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>compact<sp/>block,<sp/>which<sp/>resulted<sp/>in<sp/>the<sp/>peer<sp/>sending<sp/>a<sp/>getblocks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4078"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>request,<sp/>which<sp/>we<sp/>would<sp/>otherwise<sp/>respond<sp/>to<sp/>without<sp/>the<sp/>new<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4079"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>To<sp/>avoid<sp/>this<sp/>situation<sp/>we<sp/>simply<sp/>verify<sp/>that<sp/>we<sp/>are<sp/>on<sp/>our<sp/>best</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4080"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>known<sp/>chain<sp/>now.<sp/>This<sp/>is<sp/>super<sp/>overkill,<sp/>but<sp/>we<sp/>handle<sp/>it<sp/>better</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4081"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>for<sp/>getheaders<sp/>requests,<sp/>and<sp/>there<sp/>are<sp/>no<sp/>known<sp/>nodes<sp/>which<sp/>support</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4082"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>compact<sp/>blocks<sp/>but<sp/>still<sp/>use<sp/>getblocks<sp/>to<sp/>request<sp/>blocks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4083"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4084"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;<sp/>a_recent_block;</highlight></codeline>
<codeline lineno="4085"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4086"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_most_recent_block_mutex);</highlight></codeline>
<codeline lineno="4087"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>a_recent_block<sp/>=<sp/>m_most_recent_block;</highlight></codeline>
<codeline lineno="4088"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4089"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BlockValidationState<sp/>state;</highlight></codeline>
<codeline lineno="4090"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_chainman.<ref refid="class_chainstate_manager_1a0ed46908ea52e17d172f2fcc0ceb9964" kindref="member">ActiveChainstate</ref>().ActivateBestChain(state,<sp/>a_recent_block))<sp/>{</highlight></codeline>
<codeline lineno="4091"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;failed<sp/>to<sp/>activate<sp/>chain<sp/>(%s)\n&quot;</highlight><highlight class="normal">,<sp/>state.<ref refid="class_validation_state_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4092"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4093"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4094"><highlight class="normal"></highlight></codeline>
<codeline lineno="4095"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4096"><highlight class="normal"></highlight></codeline>
<codeline lineno="4097"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Find<sp/>the<sp/>last<sp/>block<sp/>the<sp/>caller<sp/>has<sp/>in<sp/>the<sp/>main<sp/>chain</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4098"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindex<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a0ed46908ea52e17d172f2fcc0ceb9964" kindref="member">ActiveChainstate</ref>().<ref refid="class_chainstate_1a06368acc383ffa8737427c7279e7d8ac" kindref="member">FindForkInGlobalIndex</ref>(locator);</highlight></codeline>
<codeline lineno="4099"><highlight class="normal"></highlight></codeline>
<codeline lineno="4100"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Send<sp/>the<sp/>rest<sp/>of<sp/>the<sp/>chain</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4101"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex)</highlight></codeline>
<codeline lineno="4102"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a17a69b4d98b0a7116058f3d6414dda3c" kindref="member">Next</ref>(pindex);</highlight></codeline>
<codeline lineno="4103"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nLimit<sp/>=<sp/>500;</highlight></codeline>
<codeline lineno="4104"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;getblocks<sp/>%d<sp/>to<sp/>%s<sp/>limit<sp/>%d<sp/>from<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>(pindex<sp/>?<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>:<sp/>-1),<sp/>hashStop.<ref refid="classbase__blob_1a067b44b9f2bd293d8a93401655e6476e" kindref="member">IsNull</ref>()<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;end&quot;</highlight><highlight class="normal"><sp/>:<sp/>hashStop.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>nLimit,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(;<sp/>pindex;<sp/>pindex<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().Next(pindex))</highlight></codeline>
<codeline lineno="4106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>()<sp/>==<sp/>hashStop)</highlight></codeline>
<codeline lineno="4108"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4109"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;<sp/><sp/>getblocks<sp/>stopping<sp/>at<sp/>%d<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>pruning,<sp/>don&apos;t<sp/>inv<sp/>blocks<sp/>unless<sp/>we<sp/>have<sp/>on<sp/>disk<sp/>and<sp/>are<sp/>likely<sp/>to<sp/>still<sp/>have</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>for<sp/>some<sp/>reasonable<sp/>time<sp/>window<sp/>(1<sp/>hour)<sp/>that<sp/>block<sp/>relay<sp/>might<sp/>require.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nPrunedBlocksLikelyToHave<sp/>=<sp/>MIN_BLOCKS_TO_KEEP<sp/>-<sp/>3600<sp/>/<sp/>m_chainparams.<ref refid="class_c_chain_params_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>().<ref refid="struct_consensus_1_1_params_1a096ffd2f2385b72c7bff4ba651f0bb51" kindref="member">nPowTargetSpacing</ref>;</highlight></codeline>
<codeline lineno="4115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1ad03fd92fad95bb7f82ef78cc467cb12b" kindref="member">IsPruneMode</ref>()<sp/>&amp;&amp;<sp/>(!(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15" kindref="member">BLOCK_HAVE_DATA</ref>)<sp/>||<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>&lt;=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>()-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>-<sp/>nPrunedBlocksLikelyToHave))<sp/>{</highlight></codeline>
<codeline lineno="4116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;<sp/>getblocks<sp/>stopping,<sp/>pruned<sp/>or<sp/>too<sp/>old<sp/>block<sp/>at<sp/>%d<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(peer-&gt;m_block_inv_mutex,<sp/>peer-&gt;m_blocks_for_inv_relay.push_back(pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>()));</highlight></codeline>
<codeline lineno="4120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(--nLimit<sp/>&lt;=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="4121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When<sp/>this<sp/>block<sp/>is<sp/>requested,<sp/>we&apos;ll<sp/>send<sp/>an<sp/>inv<sp/>that&apos;ll</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4122"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>trigger<sp/>the<sp/>peer<sp/>to<sp/>getblocks<sp/>the<sp/>next<sp/>batch<sp/>of<sp/>inventory.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;<sp/><sp/>getblocks<sp/>stopping<sp/>at<sp/>limit<sp/>%d<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="4124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(peer-&gt;m_block_inv_mutex,<sp/>{peer-&gt;m_continuation_block<sp/>=<sp/>pindex-&gt;GetBlockHash();});</highlight></codeline>
<codeline lineno="4125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4129"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4130"><highlight class="normal"></highlight></codeline>
<codeline lineno="4131"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a4826db5ac945c48378fa5ebac964cb7e" kindref="member">NetMsgType::GETBLOCKTXN</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BlockTransactionsRequest<sp/>req;</highlight></codeline>
<codeline lineno="4133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>req;</highlight></codeline>
<codeline lineno="4134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Verify<sp/>differential<sp/>encoding<sp/>invariant:<sp/>indexes<sp/>must<sp/>be<sp/>strictly<sp/>increasing</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>DifferenceFormatter<sp/>should<sp/>guarantee<sp/>this<sp/>property<sp/>during<sp/>deserialization</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>1;<sp/>i<sp/>&lt;<sp/>req.<ref refid="class_block_transactions_request_1af2b570488d7bd913bdcc2734a813b9eb" kindref="member">indexes</ref>.size();<sp/>++i)<sp/>{</highlight></codeline>
<codeline lineno="4137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(req.<ref refid="class_block_transactions_request_1af2b570488d7bd913bdcc2734a813b9eb" kindref="member">indexes</ref>[i]<sp/>&gt;<sp/>req.<ref refid="class_block_transactions_request_1af2b570488d7bd913bdcc2734a813b9eb" kindref="member">indexes</ref>[i-1]);</highlight></codeline>
<codeline lineno="4138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4139"><highlight class="normal"></highlight></codeline>
<codeline lineno="4140"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::shared_ptr&lt;const<sp/>CBlock&gt;<sp/>recent_block;</highlight></codeline>
<codeline lineno="4141"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4142"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_most_recent_block_mutex);</highlight></codeline>
<codeline lineno="4143"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_most_recent_block_hash<sp/>==<sp/>req.<ref refid="class_block_transactions_request_1a263d85ccb893578195c39b712b3dbb70" kindref="member">blockhash</ref>)</highlight></codeline>
<codeline lineno="4144"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>recent_block<sp/>=<sp/>m_most_recent_block;</highlight></codeline>
<codeline lineno="4145"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Unlock<sp/>m_most_recent_block_mutex<sp/>to<sp/>avoid<sp/>cs_main<sp/>lock<sp/>inversion</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4146"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4147"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(recent_block)<sp/>{</highlight></codeline>
<codeline lineno="4148"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendBlockTransactions(pfrom,<sp/>*peer,<sp/>*recent_block,<sp/>req);</highlight></codeline>
<codeline lineno="4149"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4150"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4151"><highlight class="normal"></highlight></codeline>
<codeline lineno="4152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>FlatFilePos<sp/>block_pos{};</highlight></codeline>
<codeline lineno="4153"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4154"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4155"><highlight class="normal"></highlight></codeline>
<codeline lineno="4156"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindex<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1a87eab19fb1a7e025715c13377ebfd356" kindref="member">LookupBlockIndex</ref>(req.<ref refid="class_block_transactions_request_1a263d85ccb893578195c39b712b3dbb70" kindref="member">blockhash</ref>);</highlight></codeline>
<codeline lineno="4157"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pindex<sp/>||<sp/>!(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15" kindref="member">BLOCK_HAVE_DATA</ref>))<sp/>{</highlight></codeline>
<codeline lineno="4158"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Peer<sp/>%d<sp/>sent<sp/>us<sp/>a<sp/>getblocktxn<sp/>for<sp/>a<sp/>block<sp/>we<sp/>don&apos;t<sp/>have\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4160"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4161"><highlight class="normal"></highlight></codeline>
<codeline lineno="4162"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>&gt;=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>()<sp/>-<sp/>MAX_BLOCKTXN_DEPTH)<sp/>{</highlight></codeline>
<codeline lineno="4163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>block_pos<sp/>=<sp/>pindex-&gt;<ref refid="class_c_block_index_1a21a3478b2a1d45cc8d1f266508eaa80e" kindref="member">GetBlockPos</ref>();</highlight></codeline>
<codeline lineno="4164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4166"><highlight class="normal"></highlight></codeline>
<codeline lineno="4167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!block_pos.<ref refid="struct_flat_file_pos_1ac4d637a0dec45d546495c1660c9f6047" kindref="member">IsNull</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlock<sp/>block;</highlight></codeline>
<codeline lineno="4169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>{m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1ad59bbdccdaca9da495b6b6e80c481a1a" kindref="member">ReadBlock</ref>(block,<sp/>block_pos,<sp/>req.<ref refid="class_block_transactions_request_1a263d85ccb893578195c39b712b3dbb70" kindref="member">blockhash</ref>)};</highlight></codeline>
<codeline lineno="4170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>height<sp/>is<sp/>above<sp/>MAX_BLOCKTXN_DEPTH<sp/>then<sp/>this<sp/>block<sp/>cannot<sp/>get</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>pruned<sp/>after<sp/>we<sp/>release<sp/>cs_main<sp/>above,<sp/>so<sp/>this<sp/>read<sp/>should<sp/>never<sp/>fail.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4172"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(<ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>);</highlight></codeline>
<codeline lineno="4173"><highlight class="normal"></highlight></codeline>
<codeline lineno="4174"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SendBlockTransactions(pfrom,<sp/>*peer,<sp/>block,<sp/>req);</highlight></codeline>
<codeline lineno="4175"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4177"><highlight class="normal"></highlight></codeline>
<codeline lineno="4178"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>an<sp/>older<sp/>block<sp/>is<sp/>requested<sp/>(should<sp/>never<sp/>happen<sp/>in<sp/>practice,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4179"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>but<sp/>can<sp/>happen<sp/>in<sp/>tests)<sp/>send<sp/>a<sp/>block<sp/>response<sp/>instead<sp/>of<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4180"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>blocktxn<sp/>response.<sp/>Sending<sp/>a<sp/>full<sp/>block<sp/>response<sp/>instead<sp/>of<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4181"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>small<sp/>blocktxn<sp/>response<sp/>is<sp/>preferable<sp/>in<sp/>the<sp/>case<sp/>where<sp/>a<sp/>peer</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4182"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>might<sp/>maliciously<sp/>send<sp/>lots<sp/>of<sp/>getblocktxn<sp/>requests<sp/>to<sp/>trigger</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4183"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>expensive<sp/>disk<sp/>reads,<sp/>because<sp/>it<sp/>will<sp/>require<sp/>the<sp/>peer<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4184"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>actually<sp/>receive<sp/>all<sp/>the<sp/>data<sp/>read<sp/>from<sp/>disk<sp/>over<sp/>the<sp/>network.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4185"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Peer<sp/>%d<sp/>sent<sp/>us<sp/>a<sp/>getblocktxn<sp/>for<sp/>a<sp/>block<sp/>&gt;<sp/>%i<sp/>deep\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>MAX_BLOCKTXN_DEPTH);</highlight></codeline>
<codeline lineno="4186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CInv<sp/>inv{<ref refid="protocol_8h_1ac1162efdf35b533ba996ac9d1c96fc05a818c40ec63ca86496df4bbf110fd7891" kindref="member">MSG_WITNESS_BLOCK</ref>,<sp/>req.<ref refid="class_block_transactions_request_1a263d85ccb893578195c39b712b3dbb70" kindref="member">blockhash</ref>};</highlight></codeline>
<codeline lineno="4187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(peer-&gt;m_getdata_requests_mutex,<sp/>peer-&gt;m_getdata_requests.push_back(inv));</highlight></codeline>
<codeline lineno="4188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>message<sp/>processing<sp/>loop<sp/>will<sp/>go<sp/>around<sp/>again<sp/>(without<sp/>pausing)<sp/>and<sp/>we&apos;ll<sp/>respond<sp/>then</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4190"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4191"><highlight class="normal"></highlight></codeline>
<codeline lineno="4192"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a5c1eff22535aa79a2bc54ba481b753fb" kindref="member">NetMsgType::GETHEADERS</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4193"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockLocator<sp/>locator;</highlight></codeline>
<codeline lineno="4194"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint256<sp/>hashStop;</highlight></codeline>
<codeline lineno="4195"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>locator<sp/>&gt;&gt;<sp/>hashStop;</highlight></codeline>
<codeline lineno="4196"><highlight class="normal"></highlight></codeline>
<codeline lineno="4197"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(locator.<ref refid="struct_c_block_locator_1af22e36b5cd0c4f442c0e8f14252711f4" kindref="member">vHave</ref>.size()<sp/>&gt;<sp/>MAX_LOCATOR_SZ)<sp/>{</highlight></codeline>
<codeline lineno="4198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;getheaders<sp/>locator<sp/>size<sp/>%lld<sp/>&gt;<sp/>%d,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>locator.<ref refid="struct_c_block_locator_1af22e36b5cd0c4f442c0e8f14252711f4" kindref="member">vHave</ref>.size(),<sp/>MAX_LOCATOR_SZ,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="4199"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4201"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4202"><highlight class="normal"></highlight></codeline>
<codeline lineno="4203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1acef48b2a0b8aa252efa69928192b4d5a" kindref="member">LoadingBlocks</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Ignoring<sp/>getheaders<sp/>from<sp/>peer=%d<sp/>while<sp/>importing/reindexing\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4206"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4207"><highlight class="normal"></highlight></codeline>
<codeline lineno="4208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4209"><highlight class="normal"></highlight></codeline>
<codeline lineno="4210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Don&apos;t<sp/>serve<sp/>headers<sp/>from<sp/>our<sp/>active<sp/>chain<sp/>until<sp/>our<sp/>chainwork<sp/>is<sp/>at<sp/>least</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>minimum<sp/>chain<sp/>work.<sp/>This<sp/>prevents<sp/>us<sp/>from<sp/>starting<sp/>a<sp/>low-work<sp/>headers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4212"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>sync<sp/>that<sp/>will<sp/>inevitably<sp/>be<sp/>aborted<sp/>by<sp/>our<sp/>peer.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.<ref refid="class_chainstate_manager_1ac8dc81d17ce18093b02ef600686870b3" kindref="member">ActiveTip</ref>()<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>||</highlight></codeline>
<codeline lineno="4214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(m_chainman.<ref refid="class_chainstate_manager_1ac8dc81d17ce18093b02ef600686870b3" kindref="member">ActiveTip</ref>()-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&lt;<sp/>m_chainman.<ref refid="class_chainstate_manager_1af6689b42eea6a15ba7e5409ea374cdb4" kindref="member">MinimumChainWork</ref>()<sp/>&amp;&amp;<sp/>!pfrom.<ref refid="class_c_node_1ad093ef142d44eddf28162f2aa26d56c2" kindref="member">HasPermission</ref>(<ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a801ab24683a4a8c433c6eb40c48bcd9d" kindref="member">NetPermissionFlags::Download</ref>)))<sp/>{</highlight></codeline>
<codeline lineno="4215"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Ignoring<sp/>getheaders<sp/>from<sp/>peer=%d<sp/>because<sp/>active<sp/>chain<sp/>has<sp/>too<sp/>little<sp/>work;<sp/>sending<sp/>empty<sp/>response\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Just<sp/>respond<sp/>with<sp/>an<sp/>empty<sp/>headers<sp/>message,<sp/>to<sp/>tell<sp/>the<sp/>peer<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4217"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>go<sp/>away<sp/>but<sp/>not<sp/>treat<sp/>us<sp/>as<sp/>unresponsive.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4218"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a0348bf520b74bfee619eb6bacd40199b" kindref="member">NetMsgType::HEADERS</ref>,<sp/>std::vector&lt;CBlockHeader&gt;());</highlight></codeline>
<codeline lineno="4219"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4221"><highlight class="normal"></highlight></codeline>
<codeline lineno="4222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CNodeState<sp/>*nodestate<sp/>=<sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindex<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(locator.<ref refid="struct_c_block_locator_1ac4d637a0dec45d546495c1660c9f6047" kindref="member">IsNull</ref>())</highlight></codeline>
<codeline lineno="4225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>locator<sp/>is<sp/>null,<sp/>return<sp/>the<sp/>hashStop<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1a87eab19fb1a7e025715c13377ebfd356" kindref="member">LookupBlockIndex</ref>(hashStop);</highlight></codeline>
<codeline lineno="4228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pindex)<sp/>{</highlight></codeline>
<codeline lineno="4229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4231"><highlight class="normal"></highlight></codeline>
<codeline lineno="4232"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!BlockRequestAllowed(pindex))<sp/>{</highlight></codeline>
<codeline lineno="4233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s:<sp/>ignoring<sp/>request<sp/>from<sp/>peer=%i<sp/>for<sp/>old<sp/>block<sp/>header<sp/>that<sp/>isn&apos;t<sp/>in<sp/>the<sp/>main<sp/>chain\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Find<sp/>the<sp/>last<sp/>block<sp/>the<sp/>caller<sp/>has<sp/>in<sp/>the<sp/>main<sp/>chain</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a0ed46908ea52e17d172f2fcc0ceb9964" kindref="member">ActiveChainstate</ref>().<ref refid="class_chainstate_1a06368acc383ffa8737427c7279e7d8ac" kindref="member">FindForkInGlobalIndex</ref>(locator);</highlight></codeline>
<codeline lineno="4241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex)</highlight></codeline>
<codeline lineno="4242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a17a69b4d98b0a7116058f3d6414dda3c" kindref="member">Next</ref>(pindex);</highlight></codeline>
<codeline lineno="4243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4244"><highlight class="normal"></highlight></codeline>
<codeline lineno="4245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>must<sp/>use<sp/>CBlocks,<sp/>as<sp/>CBlockHeaders<sp/>won&apos;t<sp/>include<sp/>the<sp/>0x00<sp/>nTx<sp/>count<sp/>at<sp/>the<sp/>end</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CBlock&gt;<sp/>vHeaders;</highlight></codeline>
<codeline lineno="4247"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nLimit<sp/>=<sp/>m_opts.max_headers_result;</highlight></codeline>
<codeline lineno="4248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;getheaders<sp/>%d<sp/>to<sp/>%s<sp/>from<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>(pindex<sp/>?<sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>:<sp/>-1),<sp/>hashStop.<ref refid="classbase__blob_1a067b44b9f2bd293d8a93401655e6476e" kindref="member">IsNull</ref>()<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;end&quot;</highlight><highlight class="normal"><sp/>:<sp/>hashStop.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(;<sp/>pindex;<sp/>pindex<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().Next(pindex))</highlight></codeline>
<codeline lineno="4250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vHeaders.emplace_back(pindex-&gt;<ref refid="class_c_block_index_1a86fb587abe1eaa7e77de95831c638140" kindref="member">GetBlockHeader</ref>());</highlight></codeline>
<codeline lineno="4252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(--nLimit<sp/>&lt;=<sp/>0<sp/>||<sp/>pindex-&gt;GetBlockHash()<sp/>==<sp/>hashStop)</highlight></codeline>
<codeline lineno="4253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>pindex<sp/>can<sp/>be<sp/>nullptr<sp/>either<sp/>if<sp/>we<sp/>sent<sp/>m_chainman.ActiveChain().Tip()<sp/>OR</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>if<sp/>our<sp/>peer<sp/>has<sp/>m_chainman.ActiveChain().Tip()<sp/>(and<sp/>thus<sp/>we<sp/>are<sp/>sending<sp/>an<sp/>empty</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>headers<sp/>message).<sp/>In<sp/>both<sp/>cases<sp/>it&apos;s<sp/>safe<sp/>to<sp/>update</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>pindexBestHeaderSent<sp/>to<sp/>be<sp/>our<sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>It<sp/>is<sp/>important<sp/>that<sp/>we<sp/>simply<sp/>reset<sp/>the<sp/>BestHeaderSent<sp/>value<sp/>here,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>not<sp/>max(BestHeaderSent,<sp/>newHeaderSent).<sp/>We<sp/>might<sp/>have<sp/>announced</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4262"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>currently-being-connected<sp/>tip<sp/>using<sp/>a<sp/>compact<sp/>block,<sp/>which</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4263"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>resulted<sp/>in<sp/>the<sp/>peer<sp/>sending<sp/>a<sp/>headers<sp/>request,<sp/>which<sp/>we<sp/>respond<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4264"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>without<sp/>the<sp/>new<sp/>block.<sp/>By<sp/>resetting<sp/>the<sp/>BestHeaderSent,<sp/>we<sp/>ensure<sp/>we</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4265"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>will<sp/>re-announce<sp/>the<sp/>new<sp/>block<sp/>via<sp/>headers<sp/>(or<sp/>compact<sp/>blocks<sp/>again)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4266"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>in<sp/>the<sp/>SendMessages<sp/>logic.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4267"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nodestate-&gt;pindexBestHeaderSent<sp/>=<sp/>pindex<sp/>?<sp/>pindex<sp/>:<sp/>m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>();</highlight></codeline>
<codeline lineno="4268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a0348bf520b74bfee619eb6bacd40199b" kindref="member">NetMsgType::HEADERS</ref>,<sp/>TX_WITH_WITNESS(vHeaders));</highlight></codeline>
<codeline lineno="4269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4270"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4271"><highlight class="normal"></highlight></codeline>
<codeline lineno="4272"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a737a463566994e29c65ef40499762be7" kindref="member">NetMsgType::TX</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4273"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(RejectIncomingTxs(pfrom))<sp/>{</highlight></codeline>
<codeline lineno="4274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;transaction<sp/>sent<sp/>in<sp/>violation<sp/>of<sp/>protocol,<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="4275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4276"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4278"><highlight class="normal"></highlight></codeline>
<codeline lineno="4279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Stop<sp/>processing<sp/>the<sp/>transaction<sp/>early<sp/>if<sp/>we<sp/>are<sp/>still<sp/>in<sp/>IBD<sp/>since<sp/>we<sp/>don&apos;t</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>have<sp/>enough<sp/>information<sp/>to<sp/>validate<sp/>it<sp/>yet.<sp/>Sending<sp/>unsolicited<sp/>transactions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>is<sp/>not<sp/>considered<sp/>a<sp/>protocol<sp/>violation,<sp/>so<sp/>don&apos;t<sp/>punish<sp/>the<sp/>peer.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.<ref refid="class_chainstate_manager_1a312bb1a2008bae3205f4699b90880d66" kindref="member">IsInitialBlockDownload</ref>())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4283"><highlight class="normal"></highlight></codeline>
<codeline lineno="4284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="primitives_2transaction_8h_1ae462b4b8f07705a82bf11cf361959b97" kindref="member">CTransactionRef</ref><sp/>ptx;</highlight></codeline>
<codeline lineno="4285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>TX_WITH_WITNESS(ptx);</highlight></codeline>
<codeline lineno="4286"><highlight class="normal"></highlight></codeline>
<codeline lineno="4287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="transaction__identifier_8h_1ac4bb3c35b94889843d632be4de4b223c" kindref="member">Txid</ref>&amp;<sp/>txid<sp/>=<sp/>ptx-&gt;GetHash();</highlight></codeline>
<codeline lineno="4288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="transaction__identifier_8h_1a23364c1312d4dffbbf549b4440333fd9" kindref="member">Wtxid</ref>&amp;<sp/>wtxid<sp/>=<sp/>ptx-&gt;GetWitnessHash();</highlight></codeline>
<codeline lineno="4289"><highlight class="normal"></highlight></codeline>
<codeline lineno="4290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256&amp;<sp/>hash<sp/>=<sp/>peer-&gt;m_wtxid_relay<sp/>?<sp/>wtxid.<ref refid="classtransaction__identifier_1a1cb411c7b8bb6c9024bc1a87b6d367ba" kindref="member">ToUint256</ref>()<sp/>:<sp/>txid.<ref refid="classtransaction__identifier_1a1cb411c7b8bb6c9024bc1a87b6d367ba" kindref="member">ToUint256</ref>();</highlight></codeline>
<codeline lineno="4291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>AddKnownTx(*peer,<sp/>hash);</highlight></codeline>
<codeline lineno="4292"><highlight class="normal"></highlight></codeline>
<codeline lineno="4293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a35644e2b75a93da0cb0f6c768f34efa8" kindref="member">LOCK2</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>m_tx_download_mutex);</highlight></codeline>
<codeline lineno="4294"><highlight class="normal"></highlight></codeline>
<codeline lineno="4295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>[should_validate,<sp/>package_to_validate]<sp/>=<sp/>m_txdownloadman.ReceivedTx(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>ptx);</highlight></codeline>
<codeline lineno="4296"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!should_validate)<sp/>{</highlight></codeline>
<codeline lineno="4297"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1ad093ef142d44eddf28162f2aa26d56c2" kindref="member">HasPermission</ref>(<ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a49d927322ecc171ed375b43da6c96b9c" kindref="member">NetPermissionFlags::ForceRelay</ref>))<sp/>{</highlight></codeline>
<codeline lineno="4298"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Always<sp/>relay<sp/>transactions<sp/>received<sp/>from<sp/>peers<sp/>with<sp/>forcerelay</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>permission,<sp/>even<sp/>if<sp/>they<sp/>were<sp/>already<sp/>in<sp/>the<sp/>mempool,<sp/>allowing</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>node<sp/>to<sp/>function<sp/>as<sp/>a<sp/>gateway<sp/>for<sp/>nodes<sp/>hidden<sp/>behind<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_mempool.<ref refid="class_c_tx_mem_pool_1a4f1dcdad840ef946c9925b0f4a0f95b9" kindref="member">exists</ref>(txid))<sp/>{</highlight></codeline>
<codeline lineno="4302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Not<sp/>relaying<sp/>non-mempool<sp/>transaction<sp/>%s<sp/>(wtxid=%s)<sp/>from<sp/>forcerelay<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="4303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>txid.<ref refid="classtransaction__identifier_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>(),<sp/>wtxid.<ref refid="classtransaction__identifier_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>(),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Force<sp/>relaying<sp/>tx<sp/>%s<sp/>(wtxid=%s)<sp/>from<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="4306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>txid.<ref refid="classtransaction__identifier_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>(),<sp/>wtxid.<ref refid="classtransaction__identifier_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>(),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RelayTransaction(txid,<sp/>wtxid);</highlight></codeline>
<codeline lineno="4308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4310"><highlight class="normal"></highlight></codeline>
<codeline lineno="4311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(package_to_validate)<sp/>{</highlight></codeline>
<codeline lineno="4312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>package_result{<ref refid="validation_8cpp_1a050f5f1343cc094282474bf0aff8e07f" kindref="member">ProcessNewPackage</ref>(m_chainman.<ref refid="class_chainstate_manager_1a0ed46908ea52e17d172f2fcc0ceb9964" kindref="member">ActiveChainstate</ref>(),<sp/>m_mempool,<sp/>package_to_validate-&gt;<ref refid="structnode_1_1_package_to_validate_1a46880a0feadee4f9e445742f12587e9c" kindref="member">m_txns</ref>,<sp/></highlight><highlight class="comment">/*test_accept=*/</highlight><highlight class="keyword">false</highlight><highlight class="normal">,<sp/></highlight><highlight class="comment">/*client_maxfeerate=*/</highlight><highlight class="normal">std::nullopt)};</highlight></codeline>
<codeline lineno="4313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395aeb418caf082e910fc5ab0d298fb6a8ac" kindref="member">BCLog::TXPACKAGES</ref>,<sp/></highlight><highlight class="stringliteral">&quot;package<sp/>evaluation<sp/>for<sp/>%s:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>package_to_validate-&gt;<ref refid="structnode_1_1_package_to_validate_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>(),</highlight></codeline>
<codeline lineno="4314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>package_result.<ref refid="struct_package_mempool_accept_result_1a14b1b7ea32b2b5c3b49c35b147fab3cb" kindref="member">m_state</ref>.<ref refid="class_validation_state_1ac532c4b500b1a85ea22217f2c65a70ed" kindref="member">IsValid</ref>()<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;package<sp/>accepted&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;package<sp/>rejected&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ProcessPackageResult(package_to_validate.value(),<sp/>package_result);</highlight></codeline>
<codeline lineno="4316"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4317"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4319"><highlight class="normal"></highlight></codeline>
<codeline lineno="4320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ReceivedTx<sp/>should<sp/>not<sp/>be<sp/>telling<sp/>us<sp/>to<sp/>validate<sp/>the<sp/>tx<sp/>and<sp/>a<sp/>package.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(!package_to_validate.has_value());</highlight></codeline>
<codeline lineno="4322"><highlight class="normal"></highlight></codeline>
<codeline lineno="4323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>MempoolAcceptResult<sp/>result<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a9c7d6797a606a08696d722e7489b6d4d" kindref="member">ProcessTransaction</ref>(ptx);</highlight></codeline>
<codeline lineno="4324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>TxValidationState&amp;<sp/>state<sp/>=<sp/>result.<ref refid="struct_mempool_accept_result_1a5d8238ae23efa4592916ffc81d18cd4d" kindref="member">m_state</ref>;</highlight></codeline>
<codeline lineno="4325"><highlight class="normal"></highlight></codeline>
<codeline lineno="4326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(result.<ref refid="struct_mempool_accept_result_1af8017e4319a28c0cac9c61662b1d7565" kindref="member">m_result_type</ref><sp/>==<sp/><ref refid="struct_mempool_accept_result_1aa71b5fc2a82d29a91db3a734ff892a49ac9f1a6384b1c466d4612f513bd8e13ea" kindref="member">MempoolAcceptResult::ResultType::VALID</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ProcessValidTx(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>ptx,<sp/>result.<ref refid="struct_mempool_accept_result_1a4c4c805f30f282cc10c2cdad8346644c" kindref="member">m_replaced_transactions</ref>);</highlight></codeline>
<codeline lineno="4328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1a11b1f23357476880220efd85fe7918be" kindref="member">m_last_tx_time</ref><sp/>=<sp/><ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime&lt;std::chrono::seconds&gt;</ref>();</highlight></codeline>
<codeline lineno="4329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.<ref refid="class_validation_state_1a6c1f27c9de7ff98356fa712e4b796a1a" kindref="member">IsInvalid</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>package_to_validate{ProcessInvalidTx(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>ptx,<sp/>state,<sp/></highlight><highlight class="comment">/*first_time_failure=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">)})<sp/>{</highlight></codeline>
<codeline lineno="4332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>package_result{<ref refid="validation_8cpp_1a050f5f1343cc094282474bf0aff8e07f" kindref="member">ProcessNewPackage</ref>(m_chainman.<ref refid="class_chainstate_manager_1a0ed46908ea52e17d172f2fcc0ceb9964" kindref="member">ActiveChainstate</ref>(),<sp/>m_mempool,<sp/>package_to_validate-&gt;<ref refid="structnode_1_1_package_to_validate_1a46880a0feadee4f9e445742f12587e9c" kindref="member">m_txns</ref>,<sp/></highlight><highlight class="comment">/*test_accept=*/</highlight><highlight class="keyword">false</highlight><highlight class="normal">,<sp/></highlight><highlight class="comment">/*client_maxfeerate=*/</highlight><highlight class="normal">std::nullopt)};</highlight></codeline>
<codeline lineno="4333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395aeb418caf082e910fc5ab0d298fb6a8ac" kindref="member">BCLog::TXPACKAGES</ref>,<sp/></highlight><highlight class="stringliteral">&quot;package<sp/>evaluation<sp/>for<sp/>%s:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>package_to_validate-&gt;<ref refid="structnode_1_1_package_to_validate_1a19c380b03cea21d7ac7325136a131ff0" kindref="member">ToString</ref>(),</highlight></codeline>
<codeline lineno="4334"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>package_result.<ref refid="struct_package_mempool_accept_result_1a14b1b7ea32b2b5c3b49c35b147fab3cb" kindref="member">m_state</ref>.<ref refid="class_validation_state_1ac532c4b500b1a85ea22217f2c65a70ed" kindref="member">IsValid</ref>()<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;package<sp/>accepted&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;package<sp/>rejected&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ProcessPackageResult(package_to_validate.value(),<sp/>package_result);</highlight></codeline>
<codeline lineno="4336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4338"><highlight class="normal"></highlight></codeline>
<codeline lineno="4339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4340"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4341"><highlight class="normal"></highlight></codeline>
<codeline lineno="4342"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1afb4658de55462fbfe264fc0f1ddb1d44" kindref="member">NetMsgType::CMPCTBLOCK</ref>)</highlight></codeline>
<codeline lineno="4343"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ignore<sp/>cmpctblock<sp/>received<sp/>while<sp/>importing</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1acef48b2a0b8aa252efa69928192b4d5a" kindref="member">LoadingBlocks</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Unexpected<sp/>cmpctblock<sp/>message<sp/>received<sp/>from<sp/>peer<sp/>%d\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4348"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4349"><highlight class="normal"></highlight></codeline>
<codeline lineno="4350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockHeaderAndShortTxIDs<sp/>cmpctblock;</highlight></codeline>
<codeline lineno="4351"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>cmpctblock;</highlight></codeline>
<codeline lineno="4352"><highlight class="normal"></highlight></codeline>
<codeline lineno="4353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>received_new_header<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>blockhash<sp/>=<sp/>cmpctblock.<ref refid="class_c_block_header_and_short_tx_i_ds_1af75c697fd3767e6048840bdeba4f8546" kindref="member">header</ref>.<ref refid="class_c_block_header_1a6df30b63c4634d52dfeaadb46d60d0f5" kindref="member">GetHash</ref>();</highlight></codeline>
<codeline lineno="4355"><highlight class="normal"></highlight></codeline>
<codeline lineno="4356"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4358"><highlight class="normal"></highlight></codeline>
<codeline lineno="4359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>prev_block<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1a87eab19fb1a7e025715c13377ebfd356" kindref="member">LookupBlockIndex</ref>(cmpctblock.<ref refid="class_c_block_header_and_short_tx_i_ds_1af75c697fd3767e6048840bdeba4f8546" kindref="member">header</ref>.<ref refid="class_c_block_header_1a96c46394fa2ffef51517b645bcabcb5e" kindref="member">hashPrevBlock</ref>);</highlight></codeline>
<codeline lineno="4360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!prev_block)<sp/>{</highlight></codeline>
<codeline lineno="4361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Doesn&apos;t<sp/>connect<sp/>(or<sp/>is<sp/>genesis),<sp/>instead<sp/>of<sp/>DoSing<sp/>in<sp/>AcceptBlockHeader,<sp/>request<sp/>deeper<sp/>headers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_chainman.<ref refid="class_chainstate_manager_1a312bb1a2008bae3205f4699b90880d66" kindref="member">IsInitialBlockDownload</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MaybeSendGetHeaders(pfrom,<sp/><ref refid="chain_8cpp_1a6f7cb8de33a43e97b3dd7517998379bc" kindref="member">GetLocator</ref>(m_chainman.m_best_header),<sp/>*peer);</highlight></codeline>
<codeline lineno="4364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4366"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(prev_block-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>+<sp/><ref refid="validation_8cpp_1a805faf00f329288736b407376d6edb7a" kindref="member">CalculateClaimedHeadersWork</ref>({{cmpctblock.<ref refid="class_c_block_header_and_short_tx_i_ds_1af75c697fd3767e6048840bdeba4f8546" kindref="member">header</ref>}})<sp/>&lt;<sp/>GetAntiDoSWorkThreshold())<sp/>{</highlight></codeline>
<codeline lineno="4367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>get<sp/>a<sp/>low-work<sp/>header<sp/>in<sp/>a<sp/>compact<sp/>block,<sp/>we<sp/>can<sp/>ignore<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Ignoring<sp/>low-work<sp/>compact<sp/>block<sp/>from<sp/>peer<sp/>%d\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4369"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4370"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4371"><highlight class="normal"></highlight></codeline>
<codeline lineno="4372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1a87eab19fb1a7e025715c13377ebfd356" kindref="member">LookupBlockIndex</ref>(blockhash))<sp/>{</highlight></codeline>
<codeline lineno="4373"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>received_new_header<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4375"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4376"><highlight class="normal"></highlight></codeline>
<codeline lineno="4377"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex<sp/>*pindex<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4378"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BlockValidationState<sp/>state;</highlight></codeline>
<codeline lineno="4379"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_chainman.<ref refid="class_chainstate_manager_1ae76ff7fc56e3342ba5a97ca33ec5aa37" kindref="member">ProcessNewBlockHeaders</ref>({{cmpctblock.header}},<sp/></highlight><highlight class="comment">/*min_pow_checked=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">,<sp/>state,<sp/>&amp;pindex))<sp/>{</highlight></codeline>
<codeline lineno="4380"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.<ref refid="class_validation_state_1a6c1f27c9de7ff98356fa712e4b796a1a" kindref="member">IsInvalid</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4381"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MaybePunishNodeForBlock(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>state,<sp/></highlight><highlight class="comment">/*via_compact_block=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;invalid<sp/>header<sp/>via<sp/>cmpctblock&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4383"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4384"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4385"><highlight class="normal"></highlight></codeline>
<codeline lineno="4386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>AcceptBlockHeader<sp/>returned<sp/>true,<sp/>it<sp/>set<sp/>pindex</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4387"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1acbd5520ad7c4d365ede4ed94b421231b" kindref="member">Assert</ref>(pindex);</highlight></codeline>
<codeline lineno="4388"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(received_new_header)<sp/>{</highlight></codeline>
<codeline lineno="4389"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LogBlockHeader(*pindex,<sp/>pfrom,<sp/></highlight><highlight class="comment">/*via_compact_block=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4390"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4391"><highlight class="normal"></highlight></codeline>
<codeline lineno="4392"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fProcessBLOCKTXN<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4393"><highlight class="normal"></highlight></codeline>
<codeline lineno="4394"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>end<sp/>up<sp/>treating<sp/>this<sp/>as<sp/>a<sp/>plain<sp/>headers<sp/>message,<sp/>call<sp/>that<sp/>as<sp/>well</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4395"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>without<sp/>cs_main.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4396"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fRevertToHeaderProcessing<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4397"><highlight class="normal"></highlight></codeline>
<codeline lineno="4398"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Keep<sp/>a<sp/>CBlock<sp/>for<sp/>&quot;optimistic&quot;<sp/>compactblock<sp/>reconstructions<sp/>(see</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4399"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>below)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4400"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::shared_ptr&lt;CBlock&gt;<sp/>pblock<sp/>=<sp/>std::make_shared&lt;CBlock&gt;();</highlight></codeline>
<codeline lineno="4401"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fBlockReconstructed<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4402"><highlight class="normal"></highlight></codeline>
<codeline lineno="4403"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4404"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4405"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>UpdateBlockAvailability(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>());</highlight></codeline>
<codeline lineno="4406"><highlight class="normal"></highlight></codeline>
<codeline lineno="4407"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CNodeState<sp/>*nodestate<sp/>=<sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4408"><highlight class="normal"></highlight></codeline>
<codeline lineno="4409"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>this<sp/>was<sp/>a<sp/>new<sp/>header<sp/>with<sp/>more<sp/>work<sp/>than<sp/>our<sp/>tip,<sp/>update<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4410"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>peer&apos;s<sp/>last<sp/>block<sp/>announcement<sp/>time</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(received_new_header<sp/>&amp;&amp;<sp/>pindex-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&gt;<sp/>m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>()-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4412"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nodestate-&gt;m_last_block_announcement<sp/>=<sp/><ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime</ref>();</highlight></codeline>
<codeline lineno="4413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4414"><highlight class="normal"></highlight></codeline>
<codeline lineno="4415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;nStatus<sp/>&amp;<sp/><ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15" kindref="member">BLOCK_HAVE_DATA</ref>)<sp/></highlight><highlight class="comment">//<sp/>Nothing<sp/>to<sp/>do<sp/>here</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4416"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4417"><highlight class="normal"></highlight></codeline>
<codeline lineno="4418"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>range_flight<sp/>=<sp/>mapBlocksInFlight.equal_range(pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>());</highlight></codeline>
<codeline lineno="4419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>already_in_flight<sp/>=<sp/>std::distance(range_flight.first,<sp/>range_flight.second);</highlight></codeline>
<codeline lineno="4420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>requested_block_from_this_peer{</highlight><highlight class="keyword">false</highlight><highlight class="normal">};</highlight></codeline>
<codeline lineno="4421"><highlight class="normal"></highlight></codeline>
<codeline lineno="4422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Multimap<sp/>ensures<sp/>ordering<sp/>of<sp/>outstanding<sp/>requests.<sp/>It&apos;s<sp/>either<sp/>empty<sp/>or<sp/>first<sp/>in<sp/>line.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4423"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>first_in_flight<sp/>=<sp/>already_in_flight<sp/>==<sp/>0<sp/>||<sp/>(range_flight.first-&gt;second.first<sp/>==<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4424"><highlight class="normal"></highlight></codeline>
<codeline lineno="4425"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(range_flight.first<sp/>!=<sp/>range_flight.second)<sp/>{</highlight></codeline>
<codeline lineno="4426"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(range_flight.first-&gt;second.first<sp/>==<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4427"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>requested_block_from_this_peer<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4428"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4429"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>range_flight.first++;</highlight></codeline>
<codeline lineno="4431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4432"><highlight class="normal"></highlight></codeline>
<codeline lineno="4433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&lt;=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>()-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>||<sp/></highlight><highlight class="comment">//<sp/>We<sp/>know<sp/>something<sp/>better</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4434"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex-&gt;<ref refid="class_c_block_index_1aee88ed2678dfb8c29dbb1ad986c87bf4" kindref="member">nTx</ref><sp/>!=<sp/>0)<sp/>{<sp/></highlight><highlight class="comment">//<sp/>We<sp/>had<sp/>this<sp/>block<sp/>at<sp/>some<sp/>point,<sp/>but<sp/>pruned<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4435"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(requested_block_from_this_peer)<sp/>{</highlight></codeline>
<codeline lineno="4436"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>requested<sp/>this<sp/>block<sp/>for<sp/>some<sp/>reason,<sp/>but<sp/>our<sp/>mempool<sp/>will<sp/>probably<sp/>be<sp/>useless</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4437"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>so<sp/>we<sp/>just<sp/>grab<sp/>the<sp/>block<sp/>via<sp/>normal<sp/>getdata</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4438"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CInv&gt;<sp/>vInv(1);</highlight></codeline>
<codeline lineno="4439"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vInv[0]<sp/>=<sp/>CInv(<ref refid="protocol_8h_1ac1162efdf35b533ba996ac9d1c96fc05a4cae15fd207d555331995cd5c57689c1" kindref="member">MSG_BLOCK</ref><sp/>|<sp/>GetFetchFlags(*peer),<sp/>blockhash);</highlight></codeline>
<codeline lineno="4440"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a18544277034744dbf6f85e748835ecfe" kindref="member">NetMsgType::GETDATA</ref>,<sp/>vInv);</highlight></codeline>
<codeline lineno="4441"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4442"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4443"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4444"><highlight class="normal"></highlight></codeline>
<codeline lineno="4445"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we&apos;re<sp/>not<sp/>close<sp/>to<sp/>tip<sp/>yet,<sp/>give<sp/>up<sp/>and<sp/>let<sp/>parallel<sp/>block<sp/>fetch<sp/>work<sp/>its<sp/>magic</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4446"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!already_in_flight<sp/>&amp;&amp;<sp/>!CanDirectFetch())<sp/>{</highlight></codeline>
<codeline lineno="4447"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4448"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4449"><highlight class="normal"></highlight></codeline>
<codeline lineno="4450"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>want<sp/>to<sp/>be<sp/>a<sp/>bit<sp/>conservative<sp/>just<sp/>to<sp/>be<sp/>extra<sp/>careful<sp/>about<sp/>DoS</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>possibilities<sp/>in<sp/>compact<sp/>block<sp/>processing...</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4452"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref><sp/>&lt;=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a837dbfdb2a835fa2626bfda6e2de0acc" kindref="member">Height</ref>()<sp/>+<sp/>2)<sp/>{</highlight></codeline>
<codeline lineno="4453"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((already_in_flight<sp/>&lt;<sp/>MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK<sp/>&amp;&amp;<sp/>nodestate-&gt;vBlocksInFlight.size()<sp/>&lt;<sp/>MAX_BLOCKS_IN_TRANSIT_PER_PEER)<sp/>||</highlight></codeline>
<codeline lineno="4454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>requested_block_from_this_peer)<sp/>{</highlight></codeline>
<codeline lineno="4455"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::list&lt;QueuedBlock&gt;::iterator*<sp/>queuedBlockIt<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4456"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!BlockRequested(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>*pindex,<sp/>&amp;queuedBlockIt))<sp/>{</highlight></codeline>
<codeline lineno="4457"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!(*queuedBlockIt)-&gt;partialBlock)</highlight></codeline>
<codeline lineno="4458"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(*queuedBlockIt)-&gt;partialBlock.reset(</highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>PartiallyDownloadedBlock(&amp;m_mempool));</highlight></codeline>
<codeline lineno="4459"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4460"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>block<sp/>was<sp/>already<sp/>in<sp/>flight<sp/>using<sp/>compact<sp/>blocks<sp/>from<sp/>the<sp/>same<sp/>peer</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4461"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Peer<sp/>sent<sp/>us<sp/>compact<sp/>block<sp/>we<sp/>were<sp/>already<sp/>syncing!\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4462"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4463"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4464"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4465"><highlight class="normal"></highlight></codeline>
<codeline lineno="4466"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PartiallyDownloadedBlock&amp;<sp/>partialBlock<sp/>=<sp/>*(*queuedBlockIt)-&gt;partialBlock;</highlight></codeline>
<codeline lineno="4467"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="blockencodings_8h_1a7b89c048c40ea04ec7ba13bb4279f70a" kindref="member">ReadStatus</ref><sp/>status<sp/>=<sp/>partialBlock.<ref refid="class_partially_downloaded_block_1ade976c00c21074ef253e0dd8304074de" kindref="member">InitData</ref>(cmpctblock,<sp/>vExtraTxnForCompact);</highlight></codeline>
<codeline lineno="4468"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(status<sp/>==<sp/><ref refid="blockencodings_8h_1a2454e2824c9d3db86bf62fbc974f50cea2c4369130f1cab4f039ffe2bf247d812" kindref="member">READ_STATUS_INVALID</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4469"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RemoveBlockRequest(pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>(),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());<sp/></highlight><highlight class="comment">//<sp/>Reset<sp/>in-flight<sp/>state<sp/>in<sp/>case<sp/>Misbehaving<sp/>does<sp/>not<sp/>result<sp/>in<sp/>a<sp/>disconnect</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4470"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Misbehaving(*peer,<sp/></highlight><highlight class="stringliteral">&quot;invalid<sp/>compact<sp/>block&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4471"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4472"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(status<sp/>==<sp/><ref refid="blockencodings_8h_1a2454e2824c9d3db86bf62fbc974f50ceaee0cfe0767680ec8c16bb91d3c1d9b22" kindref="member">READ_STATUS_FAILED</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4473"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(first_in_flight)<sp/><sp/>{</highlight></codeline>
<codeline lineno="4474"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Duplicate<sp/>txindexes,<sp/>the<sp/>block<sp/>is<sp/>now<sp/>in-flight,<sp/>so<sp/>just<sp/>request<sp/>it</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4475"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CInv&gt;<sp/>vInv(1);</highlight></codeline>
<codeline lineno="4476"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vInv[0]<sp/>=<sp/>CInv(<ref refid="protocol_8h_1ac1162efdf35b533ba996ac9d1c96fc05a4cae15fd207d555331995cd5c57689c1" kindref="member">MSG_BLOCK</ref><sp/>|<sp/>GetFetchFlags(*peer),<sp/>blockhash);</highlight></codeline>
<codeline lineno="4477"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a18544277034744dbf6f85e748835ecfe" kindref="member">NetMsgType::GETDATA</ref>,<sp/>vInv);</highlight></codeline>
<codeline lineno="4478"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4479"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Give<sp/>up<sp/>for<sp/>this<sp/>peer<sp/>and<sp/>wait<sp/>for<sp/>other<sp/>peer(s)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4480"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RemoveBlockRequest(pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>(),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4481"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4482"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4483"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4484"><highlight class="normal"></highlight></codeline>
<codeline lineno="4485"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BlockTransactionsRequest<sp/>req;</highlight></codeline>
<codeline lineno="4486"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>cmpctblock.<ref refid="class_c_block_header_and_short_tx_i_ds_1a2883035009b728caef42d97ed4297bee" kindref="member">BlockTxCount</ref>();<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="4487"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!partialBlock.<ref refid="class_partially_downloaded_block_1a2250084b95df5fc9631e7a7ff7e2efe4" kindref="member">IsTxAvailable</ref>(i))</highlight></codeline>
<codeline lineno="4488"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>req.<ref refid="class_block_transactions_request_1af2b570488d7bd913bdcc2734a813b9eb" kindref="member">indexes</ref>.push_back(i);</highlight></codeline>
<codeline lineno="4489"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(req.<ref refid="class_block_transactions_request_1af2b570488d7bd913bdcc2734a813b9eb" kindref="member">indexes</ref>.empty())<sp/>{</highlight></codeline>
<codeline lineno="4491"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fProcessBLOCKTXN<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(first_in_flight)<sp/>{</highlight></codeline>
<codeline lineno="4493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>will<sp/>try<sp/>to<sp/>round-trip<sp/>any<sp/>compact<sp/>blocks<sp/>we<sp/>get<sp/>on<sp/>failure,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>as<sp/>long<sp/>as<sp/>it&apos;s<sp/>first...</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4495"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>req.<ref refid="class_block_transactions_request_1a263d85ccb893578195c39b712b3dbb70" kindref="member">blockhash</ref><sp/>=<sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>();</highlight></codeline>
<codeline lineno="4496"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a4826db5ac945c48378fa5ebac964cb7e" kindref="member">NetMsgType::GETBLOCKTXN</ref>,<sp/>req);</highlight></codeline>
<codeline lineno="4497"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1ad565e2a61dff2ebdc4a420bb5b972ac7" kindref="member">m_bip152_highbandwidth_to</ref><sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="4498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(!pfrom.<ref refid="class_c_node_1a878e09eabda286e4cabf6ffc0fb24ba3" kindref="member">IsInboundConn</ref>()<sp/>||</highlight></codeline>
<codeline lineno="4499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>IsBlockRequestedFromOutbound(blockhash)<sp/>||</highlight></codeline>
<codeline lineno="4500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>already_in_flight<sp/>&lt;<sp/>MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK<sp/>-<sp/>1))<sp/>{</highlight></codeline>
<codeline lineno="4501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>...<sp/>or<sp/>it&apos;s<sp/>a<sp/>hb<sp/>relay<sp/>peer<sp/>and:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>peer<sp/>is<sp/>outbound,<sp/>or</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4503"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>we<sp/>already<sp/>have<sp/>an<sp/>outbound<sp/>attempt<sp/>in<sp/>flight(so<sp/>we&apos;ll<sp/>take<sp/>what<sp/>we<sp/>can<sp/>get),<sp/>or</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4504"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>-<sp/>it&apos;s<sp/>not<sp/>the<sp/>final<sp/>parallel<sp/>download<sp/>slot<sp/>(which<sp/>we<sp/>may<sp/>reserve<sp/>for<sp/>first<sp/>outbound)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>req.<ref refid="class_block_transactions_request_1a263d85ccb893578195c39b712b3dbb70" kindref="member">blockhash</ref><sp/>=<sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>();</highlight></codeline>
<codeline lineno="4506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a4826db5ac945c48378fa5ebac964cb7e" kindref="member">NetMsgType::GETBLOCKTXN</ref>,<sp/>req);</highlight></codeline>
<codeline lineno="4507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4508"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Give<sp/>up<sp/>for<sp/>this<sp/>peer<sp/>and<sp/>wait<sp/>for<sp/>other<sp/>peer(s)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4509"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RemoveBlockRequest(pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>(),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>block<sp/>is<sp/>either<sp/>already<sp/>in<sp/>flight<sp/>from<sp/>a<sp/>different</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4513"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>peer,<sp/>or<sp/>this<sp/>peer<sp/>has<sp/>too<sp/>many<sp/>blocks<sp/>outstanding<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>download<sp/>from.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4515"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Optimistically<sp/>try<sp/>to<sp/>reconstruct<sp/>anyway<sp/>since<sp/>we<sp/>might<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4516"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>able<sp/>to<sp/>without<sp/>any<sp/>round<sp/>trips.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PartiallyDownloadedBlock<sp/>tempBlock(&amp;m_mempool);</highlight></codeline>
<codeline lineno="4518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="blockencodings_8h_1a7b89c048c40ea04ec7ba13bb4279f70a" kindref="member">ReadStatus</ref><sp/>status<sp/>=<sp/>tempBlock.InitData(cmpctblock,<sp/>vExtraTxnForCompact);</highlight></codeline>
<codeline lineno="4519"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(status<sp/>!=<sp/><ref refid="blockencodings_8h_1a2454e2824c9d3db86bf62fbc974f50cea105d3aa9ec19f4c060b39c7fafba39ff" kindref="member">READ_STATUS_OK</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4520"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>TODO:<sp/>don&apos;t<sp/>ignore<sp/>failures</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4521"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4523"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CTransactionRef&gt;<sp/>dummy;</highlight></codeline>
<codeline lineno="4524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>prev_block{<ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1a87eab19fb1a7e025715c13377ebfd356" kindref="member">LookupBlockIndex</ref>(cmpctblock.<ref refid="class_c_block_header_and_short_tx_i_ds_1af75c697fd3767e6048840bdeba4f8546" kindref="member">header</ref>.<ref refid="class_c_block_header_1a96c46394fa2ffef51517b645bcabcb5e" kindref="member">hashPrevBlock</ref>))};</highlight></codeline>
<codeline lineno="4525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>status<sp/>=<sp/>tempBlock.FillBlock(*pblock,<sp/>dummy,</highlight></codeline>
<codeline lineno="4526"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*segwit_active=*/</highlight><highlight class="normal"><ref refid="deploymentstatus_8h_1a0f9c7fc832b34b673ebfeadaffc86182" kindref="member">DeploymentActiveAfter</ref>(prev_block,<sp/>m_chainman,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dbac12a10e827db62556122f2b1a9b0431b" kindref="member">Consensus::DEPLOYMENT_SEGWIT</ref>));</highlight></codeline>
<codeline lineno="4527"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(status<sp/>==<sp/><ref refid="blockencodings_8h_1a2454e2824c9d3db86bf62fbc974f50cea105d3aa9ec19f4c060b39c7fafba39ff" kindref="member">READ_STATUS_OK</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4528"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fBlockReconstructed<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4529"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4530"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4531"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4532"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(requested_block_from_this_peer)<sp/>{</highlight></codeline>
<codeline lineno="4533"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>requested<sp/>this<sp/>block,<sp/>but<sp/>its<sp/>far<sp/>into<sp/>the<sp/>future,<sp/>so<sp/>our</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4534"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>mempool<sp/>will<sp/>probably<sp/>be<sp/>useless<sp/>-<sp/>request<sp/>the<sp/>block<sp/>normally</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4535"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CInv&gt;<sp/>vInv(1);</highlight></codeline>
<codeline lineno="4536"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vInv[0]<sp/>=<sp/>CInv(<ref refid="protocol_8h_1ac1162efdf35b533ba996ac9d1c96fc05a4cae15fd207d555331995cd5c57689c1" kindref="member">MSG_BLOCK</ref><sp/>|<sp/>GetFetchFlags(*peer),<sp/>blockhash);</highlight></codeline>
<codeline lineno="4537"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a18544277034744dbf6f85e748835ecfe" kindref="member">NetMsgType::GETDATA</ref>,<sp/>vInv);</highlight></codeline>
<codeline lineno="4538"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4539"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4540"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>this<sp/>was<sp/>an<sp/>announce-cmpctblock,<sp/>we<sp/>want<sp/>the<sp/>same<sp/>treatment<sp/>as<sp/>a<sp/>header<sp/>message</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4541"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fRevertToHeaderProcessing<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4542"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4543"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4544"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>cs_main</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4545"><highlight class="normal"></highlight></codeline>
<codeline lineno="4546"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fProcessBLOCKTXN)<sp/>{</highlight></codeline>
<codeline lineno="4547"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BlockTransactions<sp/>txn;</highlight></codeline>
<codeline lineno="4548"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>txn.<ref refid="class_block_transactions_1a263d85ccb893578195c39b712b3dbb70" kindref="member">blockhash</ref><sp/>=<sp/>blockhash;</highlight></codeline>
<codeline lineno="4549"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ProcessCompactBlockTxns(pfrom,<sp/>*peer,<sp/>txn);</highlight></codeline>
<codeline lineno="4550"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4551"><highlight class="normal"></highlight></codeline>
<codeline lineno="4552"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fRevertToHeaderProcessing)<sp/>{</highlight></codeline>
<codeline lineno="4553"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Headers<sp/>received<sp/>from<sp/>HB<sp/>compact<sp/>block<sp/>peers<sp/>are<sp/>permitted<sp/>to<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4554"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>relayed<sp/>before<sp/>full<sp/>validation<sp/>(see<sp/>BIP<sp/>152),<sp/>so<sp/>we<sp/>don&apos;t<sp/>want<sp/>to<sp/>disconnect</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4555"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>peer<sp/>if<sp/>the<sp/>header<sp/>turns<sp/>out<sp/>to<sp/>be<sp/>for<sp/>an<sp/>invalid<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4556"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note<sp/>that<sp/>if<sp/>a<sp/>peer<sp/>tries<sp/>to<sp/>build<sp/>on<sp/>an<sp/>invalid<sp/>chain,<sp/>that</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4557"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>will<sp/>be<sp/>detected<sp/>and<sp/>the<sp/>peer<sp/>will<sp/>be<sp/>disconnected/discouraged.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4558"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ProcessHeadersMessage(pfrom,<sp/>*peer,<sp/>{cmpctblock.<ref refid="class_c_block_header_and_short_tx_i_ds_1af75c697fd3767e6048840bdeba4f8546" kindref="member">header</ref>},<sp/></highlight><highlight class="comment">/*via_compact_block=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4559"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4560"><highlight class="normal"></highlight></codeline>
<codeline lineno="4561"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fBlockReconstructed)<sp/>{</highlight></codeline>
<codeline lineno="4562"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>got<sp/>here,<sp/>we<sp/>were<sp/>able<sp/>to<sp/>optimistically<sp/>reconstruct<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4563"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>block<sp/>that<sp/>is<sp/>in<sp/>flight<sp/>from<sp/>some<sp/>other<sp/>peer.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4564"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4565"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4566"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mapBlockSource.emplace(pblock-&gt;GetHash(),<sp/>std::make_pair(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="4567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Setting<sp/>force_processing<sp/>to<sp/>true<sp/>means<sp/>that<sp/>we<sp/>bypass<sp/>some<sp/>of</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>our<sp/>anti-DoS<sp/>protections<sp/>in<sp/>AcceptBlock,<sp/>which<sp/>filters</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4570"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>unrequested<sp/>blocks<sp/>that<sp/>might<sp/>be<sp/>trying<sp/>to<sp/>waste<sp/>our<sp/>resources</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4571"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(eg<sp/>disk<sp/>space).<sp/>Because<sp/>we<sp/>only<sp/>try<sp/>to<sp/>reconstruct<sp/>blocks<sp/>when</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4572"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we&apos;re<sp/>close<sp/>to<sp/>caught<sp/>up<sp/>(via<sp/>the<sp/>CanDirectFetch()<sp/>requirement</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>above,<sp/>combined<sp/>with<sp/>the<sp/>behavior<sp/>of<sp/>not<sp/>requesting<sp/>blocks<sp/>until</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4574"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>have<sp/>a<sp/>chain<sp/>with<sp/>at<sp/>least<sp/>the<sp/>minimum<sp/>chain<sp/>work),<sp/>and<sp/>we<sp/>ignore</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4575"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>compact<sp/>blocks<sp/>with<sp/>less<sp/>work<sp/>than<sp/>our<sp/>tip,<sp/>it<sp/>is<sp/>safe<sp/>to<sp/>treat</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4576"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>reconstructed<sp/>compact<sp/>blocks<sp/>as<sp/>having<sp/>been<sp/>requested.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4577"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="test_2util_2mining_8cpp_1a6176e9db3559841574e0f1caac08cd2c" kindref="member">ProcessBlock</ref>(pfrom,<sp/>pblock,<sp/></highlight><highlight class="comment">/*force_processing=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">,<sp/></highlight><highlight class="comment">/*min_pow_checked=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4578"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);<sp/></highlight><highlight class="comment">//<sp/>hold<sp/>cs_main<sp/>for<sp/>CBlockIndex::IsValid()</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4579"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1a1b5a636925d1c416b9d59eb0392a7a62" kindref="member">IsValid</ref>(<ref refid="chain_8h_1a0d8c285f70a59a32f4f6ab41b78f93ada3eef30f876594ac79b888b7d1ff6c66c" kindref="member">BLOCK_VALID_TRANSACTIONS</ref>))<sp/>{</highlight></codeline>
<codeline lineno="4580"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Clear<sp/>download<sp/>state<sp/>for<sp/>this<sp/>block,<sp/>which<sp/>is<sp/>in</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4581"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>process<sp/>from<sp/>some<sp/>other<sp/>peer.<sp/><sp/>We<sp/>do<sp/>this<sp/>after<sp/>calling</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4582"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>ProcessNewBlock<sp/>so<sp/>that<sp/>a<sp/>malleated<sp/>cmpctblock<sp/>announcement</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4583"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>can&apos;t<sp/>be<sp/>used<sp/>to<sp/>interfere<sp/>with<sp/>block<sp/>relay.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4584"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RemoveBlockRequest(pblock-&gt;GetHash(),<sp/>std::nullopt);</highlight></codeline>
<codeline lineno="4585"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4586"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4587"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4588"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4589"><highlight class="normal"></highlight></codeline>
<codeline lineno="4590"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a0168b12bb13a2b8c2100050c86273cb6" kindref="member">NetMsgType::BLOCKTXN</ref>)</highlight></codeline>
<codeline lineno="4591"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4592"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ignore<sp/>blocktxn<sp/>received<sp/>while<sp/>importing</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4593"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1acef48b2a0b8aa252efa69928192b4d5a" kindref="member">LoadingBlocks</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4594"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Unexpected<sp/>blocktxn<sp/>message<sp/>received<sp/>from<sp/>peer<sp/>%d\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4595"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4596"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4597"><highlight class="normal"></highlight></codeline>
<codeline lineno="4598"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BlockTransactions<sp/>resp;</highlight></codeline>
<codeline lineno="4599"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>resp;</highlight></codeline>
<codeline lineno="4600"><highlight class="normal"></highlight></codeline>
<codeline lineno="4601"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ProcessCompactBlockTxns(pfrom,<sp/>*peer,<sp/>resp);</highlight></codeline>
<codeline lineno="4602"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4603"><highlight class="normal"></highlight></codeline>
<codeline lineno="4604"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a0348bf520b74bfee619eb6bacd40199b" kindref="member">NetMsgType::HEADERS</ref>)</highlight></codeline>
<codeline lineno="4605"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4606"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ignore<sp/>headers<sp/>received<sp/>while<sp/>importing</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4607"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1acef48b2a0b8aa252efa69928192b4d5a" kindref="member">LoadingBlocks</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4608"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Unexpected<sp/>headers<sp/>message<sp/>received<sp/>from<sp/>peer<sp/>%d\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4609"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4610"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4611"><highlight class="normal"></highlight></codeline>
<codeline lineno="4612"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CBlockHeader&gt;<sp/>headers;</highlight></codeline>
<codeline lineno="4613"><highlight class="normal"></highlight></codeline>
<codeline lineno="4614"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Bypass<sp/>the<sp/>normal<sp/>CBlock<sp/>deserialization,<sp/>as<sp/>we<sp/>don&apos;t<sp/>want<sp/>to<sp/>risk<sp/>deserializing<sp/>2000<sp/>full<sp/>blocks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4615"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nCount<sp/>=<sp/><ref refid="serialize_8h_1ab15e364a15e46bdbda4c90ee341d2129" kindref="member">ReadCompactSize</ref>(vRecv);</highlight></codeline>
<codeline lineno="4616"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nCount<sp/>&gt;<sp/>m_opts.max_headers_result)<sp/>{</highlight></codeline>
<codeline lineno="4617"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Misbehaving(*peer,<sp/><ref refid="tinyformat_8h_1a56c674871a61baaad36ad52238c08857" kindref="member">strprintf</ref>(</highlight><highlight class="stringliteral">&quot;headers<sp/>message<sp/>size<sp/>=<sp/>%u&quot;</highlight><highlight class="normal">,<sp/>nCount));</highlight></codeline>
<codeline lineno="4618"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4619"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4620"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>headers.resize(nCount);</highlight></codeline>
<codeline lineno="4621"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>n<sp/>=<sp/>0;<sp/>n<sp/>&lt;<sp/>nCount;<sp/>n++)<sp/>{</highlight></codeline>
<codeline lineno="4622"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>headers[n];</highlight></codeline>
<codeline lineno="4623"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="serialize_8h_1ab15e364a15e46bdbda4c90ee341d2129" kindref="member">ReadCompactSize</ref>(vRecv);<sp/></highlight><highlight class="comment">//<sp/>ignore<sp/>tx<sp/>count;<sp/>assume<sp/>it<sp/>is<sp/>0.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4624"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4625"><highlight class="normal"></highlight></codeline>
<codeline lineno="4626"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ProcessHeadersMessage(pfrom,<sp/>*peer,<sp/>std::move(headers),<sp/></highlight><highlight class="comment">/*via_compact_block=*/</highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4627"><highlight class="normal"></highlight></codeline>
<codeline lineno="4628"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>if<sp/>the<sp/>headers<sp/>presync<sp/>progress<sp/>needs<sp/>to<sp/>be<sp/>reported<sp/>to<sp/>validation.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4629"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>needs<sp/>to<sp/>be<sp/>done<sp/>without<sp/>holding<sp/>the<sp/>m_headers_presync_mutex<sp/>lock.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4630"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_headers_presync_should_signal.exchange(</highlight><highlight class="keyword">false</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="4631"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>HeadersPresyncStats<sp/>stats;</highlight></codeline>
<codeline lineno="4632"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4633"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_headers_presync_mutex);</highlight></codeline>
<codeline lineno="4634"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>it<sp/>=<sp/>m_headers_presync_stats.find(m_headers_presync_bestpeer);</highlight></codeline>
<codeline lineno="4635"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(it<sp/>!=<sp/>m_headers_presync_stats.end())<sp/>stats<sp/>=<sp/>it-&gt;second;</highlight></codeline>
<codeline lineno="4636"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4637"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stats.second)<sp/>{</highlight></codeline>
<codeline lineno="4638"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_chainman.<ref refid="class_chainstate_manager_1afbdf3e3590aa0d6082ea2105a70bd91e" kindref="member">ReportHeadersPresync</ref>(stats.first,<sp/>stats.second-&gt;first,<sp/>stats.second-&gt;second);</highlight></codeline>
<codeline lineno="4639"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4640"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4641"><highlight class="normal"></highlight></codeline>
<codeline lineno="4642"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4643"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4644"><highlight class="normal"></highlight></codeline>
<codeline lineno="4645"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a0c38093fb63e2aba2a1dad671b645de6" kindref="member">NetMsgType::BLOCK</ref>)</highlight></codeline>
<codeline lineno="4646"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4647"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ignore<sp/>block<sp/>received<sp/>while<sp/>importing</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4648"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1acef48b2a0b8aa252efa69928192b4d5a" kindref="member">LoadingBlocks</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4649"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Unexpected<sp/>block<sp/>message<sp/>received<sp/>from<sp/>peer<sp/>%d\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4650"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4651"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4652"><highlight class="normal"></highlight></codeline>
<codeline lineno="4653"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::shared_ptr&lt;CBlock&gt;<sp/>pblock<sp/>=<sp/>std::make_shared&lt;CBlock&gt;();</highlight></codeline>
<codeline lineno="4654"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>TX_WITH_WITNESS(*pblock);</highlight></codeline>
<codeline lineno="4655"><highlight class="normal"></highlight></codeline>
<codeline lineno="4656"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;received<sp/>block<sp/>%s<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>pblock-&gt;GetHash().ToString(),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4657"><highlight class="normal"></highlight></codeline>
<codeline lineno="4658"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>prev_block{<ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(m_chainman.<ref refid="class_chainstate_manager_1af99ab8783b483abe3fef8ab596a3e6b6" kindref="member">GetMutex</ref>(),<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1a87eab19fb1a7e025715c13377ebfd356" kindref="member">LookupBlockIndex</ref>(pblock-&gt;hashPrevBlock))};</highlight></codeline>
<codeline lineno="4659"><highlight class="normal"></highlight></codeline>
<codeline lineno="4660"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>for<sp/>possible<sp/>mutation<sp/>if<sp/>it<sp/>connects<sp/>to<sp/>something<sp/>we<sp/>know<sp/>so<sp/>we<sp/>can<sp/>check<sp/>for<sp/>DEPLOYMENT_SEGWIT<sp/>being<sp/>active</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4661"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(prev_block<sp/>&amp;&amp;<sp/><ref refid="validation_8cpp_1a10bb051c7f669d2bea4c37e6b6d3ed5c" kindref="member">IsBlockMutated</ref>(</highlight><highlight class="comment">/*block=*/</highlight><highlight class="normal">*pblock,</highlight></codeline>
<codeline lineno="4662"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*check_witness_root=*/</highlight><highlight class="normal"><ref refid="deploymentstatus_8h_1a0f9c7fc832b34b673ebfeadaffc86182" kindref="member">DeploymentActiveAfter</ref>(prev_block,<sp/>m_chainman,<sp/><ref refid="namespace_consensus_1a71407a1d3702f798b0bcfa84857bd7dbac12a10e827db62556122f2b1a9b0431b" kindref="member">Consensus::DEPLOYMENT_SEGWIT</ref>)))<sp/>{</highlight></codeline>
<codeline lineno="4663"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Received<sp/>mutated<sp/>block<sp/>from<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>peer-&gt;m_id);</highlight></codeline>
<codeline lineno="4664"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Misbehaving(*peer,<sp/></highlight><highlight class="stringliteral">&quot;mutated<sp/>block&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4665"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1ab3029e545f54f330170cbf37f0819693" kindref="member">WITH_LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>,<sp/>RemoveBlockRequest(pblock-&gt;GetHash(),<sp/>peer-&gt;m_id));</highlight></codeline>
<codeline lineno="4666"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4667"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4668"><highlight class="normal"></highlight></codeline>
<codeline lineno="4669"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>forceProcessing<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4670"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256<sp/>hash(pblock-&gt;GetHash());</highlight></codeline>
<codeline lineno="4671"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>min_pow_checked<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4672"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4673"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="4674"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Always<sp/>process<sp/>the<sp/>block<sp/>if<sp/>we<sp/>requested<sp/>it,<sp/>since<sp/>we<sp/>may</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>need<sp/>it<sp/>even<sp/>when<sp/>it&apos;s<sp/>not<sp/>a<sp/>candidate<sp/>for<sp/>a<sp/>new<sp/>best<sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4676"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>forceProcessing<sp/>=<sp/>IsBlockRequested(hash);</highlight></codeline>
<codeline lineno="4677"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RemoveBlockRequest(hash,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4678"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>mapBlockSource<sp/>is<sp/>only<sp/>used<sp/>for<sp/>punishing<sp/>peers<sp/>and<sp/>setting</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4679"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>which<sp/>peers<sp/>send<sp/>us<sp/>compact<sp/>blocks,<sp/>so<sp/>the<sp/>race<sp/>between<sp/>here<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4680"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>cs_main<sp/>in<sp/>ProcessNewBlock<sp/>is<sp/>fine.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4681"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mapBlockSource.emplace(hash,<sp/>std::make_pair(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="4682"><highlight class="normal"></highlight></codeline>
<codeline lineno="4683"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>claimed<sp/>work<sp/>on<sp/>this<sp/>block<sp/>against<sp/>our<sp/>anti-dos<sp/>thresholds.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4684"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(prev_block<sp/>&amp;&amp;<sp/>prev_block-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>+<sp/><ref refid="validation_8cpp_1a805faf00f329288736b407376d6edb7a" kindref="member">CalculateClaimedHeadersWork</ref>({{pblock-&gt;GetBlockHeader()}})<sp/>&gt;=<sp/>GetAntiDoSWorkThreshold())<sp/>{</highlight></codeline>
<codeline lineno="4685"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>min_pow_checked<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4686"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4687"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4688"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="test_2util_2mining_8cpp_1a6176e9db3559841574e0f1caac08cd2c" kindref="member">ProcessBlock</ref>(pfrom,<sp/>pblock,<sp/>forceProcessing,<sp/>min_pow_checked);</highlight></codeline>
<codeline lineno="4689"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4690"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4691"><highlight class="normal"></highlight></codeline>
<codeline lineno="4692"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a47f973f3b4441a6402c6778763fdfd19" kindref="member">NetMsgType::GETADDR</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4693"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>asymmetric<sp/>behavior<sp/>for<sp/>inbound<sp/>and<sp/>outbound<sp/>connections<sp/>was<sp/>introduced</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4694"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>prevent<sp/>a<sp/>fingerprinting<sp/>attack:<sp/>an<sp/>attacker<sp/>can<sp/>send<sp/>specific<sp/>fake<sp/>addresses</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4695"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>users&apos;<sp/>AddrMan<sp/>and<sp/>later<sp/>request<sp/>them<sp/>by<sp/>sending<sp/>getaddr<sp/>messages.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4696"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Making<sp/>nodes<sp/>which<sp/>are<sp/>behind<sp/>NAT<sp/>and<sp/>can<sp/>only<sp/>make<sp/>outgoing<sp/>connections<sp/>ignore</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4697"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>getaddr<sp/>message<sp/>mitigates<sp/>the<sp/>attack.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4698"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pfrom.<ref refid="class_c_node_1a878e09eabda286e4cabf6ffc0fb24ba3" kindref="member">IsInboundConn</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4699"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Ignoring<sp/>\&quot;getaddr\&quot;<sp/>from<sp/>%s<sp/>connection.<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a1366f7f0a8a51ed138660cae429e1aa1" kindref="member">ConnectionTypeAsString</ref>(),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4700"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4701"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4702"><highlight class="normal"></highlight></codeline>
<codeline lineno="4703"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Since<sp/>this<sp/>must<sp/>be<sp/>an<sp/>inbound<sp/>connection,<sp/>SetupAddressRelay<sp/>will</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4704"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>never<sp/>fail.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4705"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(SetupAddressRelay(pfrom,<sp/>*peer));</highlight></codeline>
<codeline lineno="4706"><highlight class="normal"></highlight></codeline>
<codeline lineno="4707"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>send<sp/>one<sp/>GetAddr<sp/>response<sp/>per<sp/>connection<sp/>to<sp/>reduce<sp/>resource<sp/>waste</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4708"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>discourage<sp/>addr<sp/>stamping<sp/>of<sp/>INV<sp/>announcements.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4709"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer-&gt;m_getaddr_recvd)<sp/>{</highlight></codeline>
<codeline lineno="4710"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Ignoring<sp/>repeated<sp/>\&quot;getaddr\&quot;.<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4711"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4712"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4713"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_getaddr_recvd<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4714"><highlight class="normal"></highlight></codeline>
<codeline lineno="4715"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_addrs_to_send.clear();</highlight></codeline>
<codeline lineno="4716"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CAddress&gt;<sp/>vAddr;</highlight></codeline>
<codeline lineno="4717"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1ad093ef142d44eddf28162f2aa26d56c2" kindref="member">HasPermission</ref>(<ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a3649a5e29ad648f3cfe3eea1a93d2f78" kindref="member">NetPermissionFlags::Addr</ref>))<sp/>{</highlight></codeline>
<codeline lineno="4718"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vAddr<sp/>=<sp/>m_connman.<ref refid="class_c_connman_1a072825b7032342ea0b37b0b656cc13a2" kindref="member">GetAddressesUnsafe</ref>(MAX_ADDR_TO_SEND,<sp/>MAX_PCT_ADDR_TO_SEND,<sp/></highlight><highlight class="comment">/*network=*/</highlight><highlight class="normal">std::nullopt);</highlight></codeline>
<codeline lineno="4719"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4720"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vAddr<sp/>=<sp/>m_connman.<ref refid="class_c_connman_1a29251a88172193512f78a8a1ecd89dd9" kindref="member">GetAddresses</ref>(pfrom,<sp/>MAX_ADDR_TO_SEND,<sp/>MAX_PCT_ADDR_TO_SEND);</highlight></codeline>
<codeline lineno="4721"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4722"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CAddress<sp/>&amp;addr<sp/>:<sp/>vAddr)<sp/>{</highlight></codeline>
<codeline lineno="4723"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PushAddress(*peer,<sp/>addr);</highlight></codeline>
<codeline lineno="4724"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4725"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4726"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4727"><highlight class="normal"></highlight></codeline>
<codeline lineno="4728"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a66860655ec8d12ec5a4bb08e06252c39" kindref="member">NetMsgType::MEMPOOL</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4729"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>process<sp/>received<sp/>mempool<sp/>messages<sp/>if<sp/>we<sp/>advertise<sp/>NODE_BLOOM</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4730"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>or<sp/>if<sp/>the<sp/>peer<sp/>has<sp/>mempool<sp/>permissions.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4731"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!(peer-&gt;m_our_services<sp/>&amp;<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a9ca74e44e29a412c070750bdbf2380bb" kindref="member">NODE_BLOOM</ref>)<sp/>&amp;&amp;<sp/>!pfrom.<ref refid="class_c_node_1ad093ef142d44eddf28162f2aa26d56c2" kindref="member">HasPermission</ref>(<ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a2046ead0bf60e2131e75f7f911503d62" kindref="member">NetPermissionFlags::Mempool</ref>))</highlight></codeline>
<codeline lineno="4732"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4733"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pfrom.<ref refid="class_c_node_1ad093ef142d44eddf28162f2aa26d56c2" kindref="member">HasPermission</ref>(<ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a12b80870cf3a64e605a95b9c521ac46f" kindref="member">NetPermissionFlags::NoBan</ref>))</highlight></codeline>
<codeline lineno="4734"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4735"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;mempool<sp/>request<sp/>with<sp/>bloom<sp/>filters<sp/>disabled,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="4736"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4737"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4738"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4739"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4740"><highlight class="normal"></highlight></codeline>
<codeline lineno="4741"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_connman.<ref refid="class_c_connman_1ab1c8de1b6e3a4a49afb85c3ad5daa528" kindref="member">OutboundTargetReached</ref>(</highlight><highlight class="keyword">false</highlight><highlight class="normal">)<sp/>&amp;&amp;<sp/>!pfrom.<ref refid="class_c_node_1ad093ef142d44eddf28162f2aa26d56c2" kindref="member">HasPermission</ref>(<ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a2046ead0bf60e2131e75f7f911503d62" kindref="member">NetPermissionFlags::Mempool</ref>))</highlight></codeline>
<codeline lineno="4742"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4743"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pfrom.<ref refid="class_c_node_1ad093ef142d44eddf28162f2aa26d56c2" kindref="member">HasPermission</ref>(<ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a12b80870cf3a64e605a95b9c521ac46f" kindref="member">NetPermissionFlags::NoBan</ref>))</highlight></codeline>
<codeline lineno="4744"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4745"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;mempool<sp/>request<sp/>with<sp/>bandwidth<sp/>limit<sp/>reached,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="4746"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4747"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4748"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4749"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4750"><highlight class="normal"></highlight></codeline>
<codeline lineno="4751"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>tx_relay<sp/>=<sp/>peer-&gt;GetTxRelay();<sp/>tx_relay<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="4752"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(tx_relay-&gt;m_tx_inventory_mutex);</highlight></codeline>
<codeline lineno="4753"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_relay-&gt;m_send_mempool<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4754"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4755"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4756"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4757"><highlight class="normal"></highlight></codeline>
<codeline lineno="4758"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a751cef7cb24a52347f18d02f78904833" kindref="member">NetMsgType::PING</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4759"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom.<ref refid="class_c_node_1af039a299f31c62d63996fd5907c3f953" kindref="member">GetCommonVersion</ref>()<sp/>&gt;<sp/>BIP0031_VERSION)<sp/>{</highlight></codeline>
<codeline lineno="4760"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/><ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="4761"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/><ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref>;</highlight></codeline>
<codeline lineno="4762"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Echo<sp/>the<sp/>message<sp/>back<sp/>with<sp/>the<sp/>nonce.<sp/>This<sp/>allows<sp/>for<sp/>two<sp/>useful<sp/>features:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4763"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4764"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>1)<sp/>A<sp/>remote<sp/>node<sp/>can<sp/>quickly<sp/>check<sp/>if<sp/>the<sp/>connection<sp/>is<sp/>operational</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4765"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>2)<sp/>Remote<sp/>nodes<sp/>can<sp/>measure<sp/>the<sp/>latency<sp/>of<sp/>the<sp/>network<sp/>thread.<sp/>If<sp/>this<sp/>node</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4766"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/>is<sp/>overloaded<sp/>it<sp/>won&apos;t<sp/>respond<sp/>to<sp/>pings<sp/>quickly<sp/>and<sp/>the<sp/>remote<sp/>node<sp/>can</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4767"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/><sp/><sp/>avoid<sp/>sending<sp/>us<sp/>more<sp/>work,<sp/>like<sp/>chain<sp/>download<sp/>requests.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4768"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4769"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>nonce<sp/>stops<sp/>the<sp/>remote<sp/>getting<sp/>confused<sp/>between<sp/>different<sp/>pings:<sp/>without</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4770"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>it,<sp/>if<sp/>the<sp/>remote<sp/>node<sp/>sends<sp/>a<sp/>ping<sp/>once<sp/>per<sp/>second<sp/>and<sp/>this<sp/>node<sp/>takes<sp/>5</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4771"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>seconds<sp/>to<sp/>respond<sp/>to<sp/>each,<sp/>the<sp/>5th<sp/>ping<sp/>the<sp/>remote<sp/>sends<sp/>would<sp/>appear<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4772"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>return<sp/>very<sp/>quickly.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4773"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pfrom,<sp/><ref refid="namespace_net_msg_type_1a87b99ca58cf8848b5f668564c580581d" kindref="member">NetMsgType::PONG</ref>,<sp/><ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref>);</highlight></codeline>
<codeline lineno="4774"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4775"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4776"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4777"><highlight class="normal"></highlight></codeline>
<codeline lineno="4778"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a87b99ca58cf8848b5f668564c580581d" kindref="member">NetMsgType::PONG</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4779"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>ping_end<sp/>=<sp/>time_received;</highlight></codeline>
<codeline lineno="4780"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/><ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="4781"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>nAvail<sp/>=<sp/>vRecv.<ref refid="class_data_stream_1acd01a8f741015e8a4846929de529ab9d" kindref="member">in_avail</ref>();</highlight></codeline>
<codeline lineno="4782"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>bPingFinished<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4783"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::string<sp/>sProblem;</highlight></codeline>
<codeline lineno="4784"><highlight class="normal"></highlight></codeline>
<codeline lineno="4785"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nAvail<sp/>&gt;=<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(<ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref>))<sp/>{</highlight></codeline>
<codeline lineno="4786"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/><ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref>;</highlight></codeline>
<codeline lineno="4787"><highlight class="normal"></highlight></codeline>
<codeline lineno="4788"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>process<sp/>pong<sp/>message<sp/>if<sp/>there<sp/>is<sp/>an<sp/>outstanding<sp/>ping<sp/>(old<sp/>ping<sp/>without<sp/>nonce<sp/>should<sp/>never<sp/>pong)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4789"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer-&gt;m_ping_nonce_sent<sp/>!=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="4790"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref><sp/>==<sp/>peer-&gt;m_ping_nonce_sent)<sp/>{</highlight></codeline>
<codeline lineno="4791"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Matching<sp/>pong<sp/>received,<sp/>this<sp/>ping<sp/>is<sp/>no<sp/>longer<sp/>outstanding</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4792"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bPingFinished<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4793"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>ping_time<sp/>=<sp/>ping_end<sp/>-<sp/>peer-&gt;m_ping_start.load();</highlight></codeline>
<codeline lineno="4794"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(ping_time.count()<sp/>&gt;=<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="4795"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Let<sp/>connman<sp/>know<sp/>about<sp/>this<sp/>successful<sp/>ping-pong</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4796"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac11492e59f73bdbea46ae9fde658367b" kindref="member">PongReceived</ref>(ping_time);</highlight></codeline>
<codeline lineno="4797"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4798"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>should<sp/>never<sp/>happen</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4799"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sProblem<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;Timing<sp/>mishap&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4800"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4801"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4802"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Nonce<sp/>mismatches<sp/>are<sp/>normal<sp/>when<sp/>pings<sp/>are<sp/>overlapping</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4803"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sProblem<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;Nonce<sp/>mismatch&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4804"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref><sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="4805"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>is<sp/>most<sp/>likely<sp/>a<sp/>bug<sp/>in<sp/>another<sp/>implementation<sp/>somewhere;<sp/>cancel<sp/>this<sp/>ping</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4806"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bPingFinished<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4807"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sProblem<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;Nonce<sp/>zero&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4808"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4809"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4810"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4811"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sProblem<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;Unsolicited<sp/>pong<sp/>without<sp/>ping&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4812"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4813"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4814"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>is<sp/>most<sp/>likely<sp/>a<sp/>bug<sp/>in<sp/>another<sp/>implementation<sp/>somewhere;<sp/>cancel<sp/>this<sp/>ping</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4815"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bPingFinished<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4816"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sProblem<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;Short<sp/>payload&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4817"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4818"><highlight class="normal"></highlight></codeline>
<codeline lineno="4819"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!(sProblem.empty()))<sp/>{</highlight></codeline>
<codeline lineno="4820"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;pong<sp/>peer=%d:<sp/>%s,<sp/>%x<sp/>expected,<sp/>%x<sp/>received,<sp/>%u<sp/>bytes\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="4821"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),</highlight></codeline>
<codeline lineno="4822"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sProblem,</highlight></codeline>
<codeline lineno="4823"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_ping_nonce_sent,</highlight></codeline>
<codeline lineno="4824"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref>,</highlight></codeline>
<codeline lineno="4825"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nAvail);</highlight></codeline>
<codeline lineno="4826"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4827"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(bPingFinished)<sp/>{</highlight></codeline>
<codeline lineno="4828"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_ping_nonce_sent<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="4829"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4830"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4831"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4832"><highlight class="normal"></highlight></codeline>
<codeline lineno="4833"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a82d90c5992b154b100223d9d51a65feb" kindref="member">NetMsgType::FILTERLOAD</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4834"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!(peer-&gt;m_our_services<sp/>&amp;<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a9ca74e44e29a412c070750bdbf2380bb" kindref="member">NODE_BLOOM</ref>))<sp/>{</highlight></codeline>
<codeline lineno="4835"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;filterload<sp/>received<sp/>despite<sp/>not<sp/>offering<sp/>bloom<sp/>services,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="4836"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4837"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4838"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4839"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBloomFilter<sp/>filter;</highlight></codeline>
<codeline lineno="4840"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>filter;</highlight></codeline>
<codeline lineno="4841"><highlight class="normal"></highlight></codeline>
<codeline lineno="4842"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!filter.<ref refid="class_c_bloom_filter_1af20392e863cea130e5e00d3222d40a80" kindref="member">IsWithinSizeConstraints</ref>())</highlight></codeline>
<codeline lineno="4843"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4844"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>There<sp/>is<sp/>no<sp/>excuse<sp/>for<sp/>sending<sp/>a<sp/>too-large<sp/>filter</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4845"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Misbehaving(*peer,<sp/></highlight><highlight class="stringliteral">&quot;too-large<sp/>bloom<sp/>filter&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4846"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>tx_relay<sp/>=<sp/>peer-&gt;GetTxRelay();<sp/>tx_relay<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="4847"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4848"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(tx_relay-&gt;m_bloom_filter_mutex);</highlight></codeline>
<codeline lineno="4849"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_relay-&gt;m_bloom_filter.reset(</highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>CBloomFilter(filter));</highlight></codeline>
<codeline lineno="4850"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_relay-&gt;m_relay_txs<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4851"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4852"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1a8e0916692da2c967eb74bc3b7e3e8574" kindref="member">m_bloom_filter_loaded</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4853"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1acf03c8775bb1dd2139126ccd062ef9f3" kindref="member">m_relays_txs</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4854"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4855"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4856"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4857"><highlight class="normal"></highlight></codeline>
<codeline lineno="4858"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1aee4519be4aab71975e6cdf5856c23b45" kindref="member">NetMsgType::FILTERADD</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4859"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!(peer-&gt;m_our_services<sp/>&amp;<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a9ca74e44e29a412c070750bdbf2380bb" kindref="member">NODE_BLOOM</ref>))<sp/>{</highlight></codeline>
<codeline lineno="4860"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;filteradd<sp/>received<sp/>despite<sp/>not<sp/>offering<sp/>bloom<sp/>services,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="4861"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4862"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4863"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4864"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;unsigned<sp/>char&gt;<sp/>vData;</highlight></codeline>
<codeline lineno="4865"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>vData;</highlight></codeline>
<codeline lineno="4866"><highlight class="normal"></highlight></codeline>
<codeline lineno="4867"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Nodes<sp/>must<sp/>NEVER<sp/>send<sp/>a<sp/>data<sp/>item<sp/>&gt;<sp/>MAX_SCRIPT_ELEMENT_SIZE<sp/>bytes<sp/>(the<sp/>max<sp/>size<sp/>for<sp/>a<sp/>script<sp/>data<sp/>object,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4868"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>thus,<sp/>the<sp/>maximum<sp/>size<sp/>any<sp/>matched<sp/>object<sp/>can<sp/>have)<sp/>in<sp/>a<sp/>filteradd<sp/>message</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4869"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>bad<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4870"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vData.size()<sp/>&gt;<sp/>MAX_SCRIPT_ELEMENT_SIZE)<sp/>{</highlight></codeline>
<codeline lineno="4871"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bad<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4872"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>tx_relay<sp/>=<sp/>peer-&gt;GetTxRelay();<sp/>tx_relay<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="4873"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(tx_relay-&gt;m_bloom_filter_mutex);</highlight></codeline>
<codeline lineno="4874"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tx_relay-&gt;m_bloom_filter)<sp/>{</highlight></codeline>
<codeline lineno="4875"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_relay-&gt;m_bloom_filter-&gt;insert(vData);</highlight></codeline>
<codeline lineno="4876"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="4877"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bad<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4878"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4879"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4880"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(bad)<sp/>{</highlight></codeline>
<codeline lineno="4881"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Misbehaving(*peer,<sp/></highlight><highlight class="stringliteral">&quot;bad<sp/>filteradd<sp/>message&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="4882"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4883"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4884"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4885"><highlight class="normal"></highlight></codeline>
<codeline lineno="4886"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1ac0861abd77fc3f1a91c7c044eacda178" kindref="member">NetMsgType::FILTERCLEAR</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4887"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!(peer-&gt;m_our_services<sp/>&amp;<sp/><ref refid="protocol_8h_1ad131f3177584caea787cdbf6f85a9537a9ca74e44e29a412c070750bdbf2380bb" kindref="member">NODE_BLOOM</ref>))<sp/>{</highlight></codeline>
<codeline lineno="4888"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;filterclear<sp/>received<sp/>despite<sp/>not<sp/>offering<sp/>bloom<sp/>services,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pfrom.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="4889"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4890"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4891"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4892"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>tx_relay<sp/>=<sp/>peer-&gt;GetTxRelay();</highlight></codeline>
<codeline lineno="4893"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tx_relay)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4894"><highlight class="normal"></highlight></codeline>
<codeline lineno="4895"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4896"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(tx_relay-&gt;m_bloom_filter_mutex);</highlight></codeline>
<codeline lineno="4897"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_relay-&gt;m_bloom_filter<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4898"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_relay-&gt;m_relay_txs<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4899"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4900"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1a8e0916692da2c967eb74bc3b7e3e8574" kindref="member">m_bloom_filter_loaded</ref><sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4901"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom.<ref refid="class_c_node_1acf03c8775bb1dd2139126ccd062ef9f3" kindref="member">m_relays_txs</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4902"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4903"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4904"><highlight class="normal"></highlight></codeline>
<codeline lineno="4905"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a685b5b6d3af7436779d0afbc8f695524" kindref="member">NetMsgType::FEEFILTER</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4906"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/>newFeeFilter<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="4907"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>newFeeFilter;</highlight></codeline>
<codeline lineno="4908"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="amount_8h_1a12db56a9a1c931941f0943ecbb278aae" kindref="member">MoneyRange</ref>(newFeeFilter))<sp/>{</highlight></codeline>
<codeline lineno="4909"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>tx_relay<sp/>=<sp/>peer-&gt;GetTxRelay();<sp/>tx_relay<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="4910"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_relay-&gt;m_fee_filter_received<sp/>=<sp/>newFeeFilter;</highlight></codeline>
<codeline lineno="4911"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4912"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;received:<sp/>feefilter<sp/>of<sp/>%s<sp/>from<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>CFeeRate(newFeeFilter).<ref refid="bitcoin-cli_8cpp_1aec2c30b1707eac00ff7e4fb5b3f7a92d" kindref="member">ToString</ref>(),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4913"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4914"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4915"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4916"><highlight class="normal"></highlight></codeline>
<codeline lineno="4917"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a843d4de8fa7eb40720f6e8f60a3749d9" kindref="member">NetMsgType::GETCFILTERS</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4918"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ProcessGetCFilters(pfrom,<sp/>*peer,<sp/>vRecv);</highlight></codeline>
<codeline lineno="4919"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4920"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4921"><highlight class="normal"></highlight></codeline>
<codeline lineno="4922"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1aa887f46aaaf32059bb49432d653c213e" kindref="member">NetMsgType::GETCFHEADERS</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4923"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ProcessGetCFHeaders(pfrom,<sp/>*peer,<sp/>vRecv);</highlight></codeline>
<codeline lineno="4924"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4925"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4926"><highlight class="normal"></highlight></codeline>
<codeline lineno="4927"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1aca2a1b6c8bcc29bcedbf5e3fd40c3054" kindref="member">NetMsgType::GETCFCHECKPT</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4928"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ProcessGetCFCheckPt(pfrom,<sp/>*peer,<sp/>vRecv);</highlight></codeline>
<codeline lineno="4929"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4930"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4931"><highlight class="normal"></highlight></codeline>
<codeline lineno="4932"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(msg_type<sp/>==<sp/><ref refid="namespace_net_msg_type_1a971a91e1a9757b280d32452dbdcccddc" kindref="member">NetMsgType::NOTFOUND</ref>)<sp/>{</highlight></codeline>
<codeline lineno="4933"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CInv&gt;<sp/>vInv;</highlight></codeline>
<codeline lineno="4934"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vRecv<sp/>&gt;&gt;<sp/>vInv;</highlight></codeline>
<codeline lineno="4935"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;GenTxid&gt;<sp/>tx_invs;</highlight></codeline>
<codeline lineno="4936"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vInv.size()<sp/>&lt;=<sp/>node::MAX_PEER_TX_ANNOUNCEMENTS<sp/>+<sp/>MAX_BLOCKS_IN_TRANSIT_PER_PEER)<sp/>{</highlight></codeline>
<codeline lineno="4937"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(CInv<sp/>&amp;inv<sp/>:<sp/>vInv)<sp/>{</highlight></codeline>
<codeline lineno="4938"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(inv.<ref refid="class_c_inv_1aa98ef9a38b0329822017522c9b98e358" kindref="member">IsGenTxMsg</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4939"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_invs.emplace_back(<ref refid="protocol_8cpp_1a3466d64f79e3865dc16910ed3d1ba3d8" kindref="member">ToGenTxid</ref>(inv));</highlight></codeline>
<codeline lineno="4940"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4941"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4942"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4943"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_tx_download_mutex);</highlight></codeline>
<codeline lineno="4944"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_txdownloadman.ReceivedNotFound(pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>tx_invs);</highlight></codeline>
<codeline lineno="4945"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4946"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4947"><highlight class="normal"></highlight></codeline>
<codeline lineno="4948"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ignore<sp/>unknown<sp/>commands<sp/>for<sp/>extensibility</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4949"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Unknown<sp/>command<sp/>\&quot;%s\&quot;<sp/>from<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/><ref refid="util_2strencodings_8cpp_1af661610872e92731fc31facae4d42361" kindref="member">SanitizeString</ref>(msg_type),<sp/>pfrom.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4950"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4951"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4952"><highlight class="normal"></highlight></codeline>
<codeline lineno="4953"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode&amp;<sp/>pnode,<sp/>Peer&amp;<sp/>peer)</highlight></codeline>
<codeline lineno="4954"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4955"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="4956"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(peer.m_misbehavior_mutex);</highlight></codeline>
<codeline lineno="4957"><highlight class="normal"></highlight></codeline>
<codeline lineno="4958"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>There&apos;s<sp/>nothing<sp/>to<sp/>do<sp/>if<sp/>the<sp/>m_should_discourage<sp/>flag<sp/>isn&apos;t<sp/>set</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4959"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!peer.m_should_discourage)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4960"><highlight class="normal"></highlight></codeline>
<codeline lineno="4961"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_should_discourage<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4962"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>peer.m_misbehavior_mutex</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4963"><highlight class="normal"></highlight></codeline>
<codeline lineno="4964"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pnode.<ref refid="class_c_node_1ad093ef142d44eddf28162f2aa26d56c2" kindref="member">HasPermission</ref>(<ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a12b80870cf3a64e605a95b9c521ac46f" kindref="member">NetPermissionFlags::NoBan</ref>))<sp/>{</highlight></codeline>
<codeline lineno="4965"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>never<sp/>disconnect<sp/>or<sp/>discourage<sp/>peers<sp/>for<sp/>bad<sp/>behavior<sp/>if<sp/>they<sp/>have<sp/>NetPermissionFlags::NoBan<sp/>permission</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4966"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;Not<sp/>punishing<sp/>noban<sp/>peer<sp/>%d!&quot;</highlight><highlight class="normal">,<sp/>peer.m_id);</highlight></codeline>
<codeline lineno="4967"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4968"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4969"><highlight class="normal"></highlight></codeline>
<codeline lineno="4970"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pnode.<ref refid="class_c_node_1a8f1fe2c0472c960adee75891ac0bf9cd" kindref="member">IsManualConn</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4971"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>never<sp/>disconnect<sp/>or<sp/>discourage<sp/>manual<sp/>peers<sp/>for<sp/>bad<sp/>behavior</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4972"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a2c6c3e9c356e14fb4a7139acf4fa7b18" kindref="member">LogWarning</ref>(</highlight><highlight class="stringliteral">&quot;Not<sp/>punishing<sp/>manually<sp/>connected<sp/>peer<sp/>%d!&quot;</highlight><highlight class="normal">,<sp/>peer.m_id);</highlight></codeline>
<codeline lineno="4973"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4974"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4975"><highlight class="normal"></highlight></codeline>
<codeline lineno="4976"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pnode.<ref refid="class_c_node_1afefbbc75aa05390712188a0f1e13d6f5" kindref="member">addr</ref>.<ref refid="class_c_net_addr_1aa4f22952302ef5a4401ee4abf61d9242" kindref="member">IsLocal</ref>())<sp/>{</highlight></codeline>
<codeline lineno="4977"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>disconnect<sp/>local<sp/>peers<sp/>for<sp/>bad<sp/>behavior<sp/>but<sp/>don&apos;t<sp/>discourage<sp/>(since<sp/>that<sp/>would<sp/>discourage</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4978"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>all<sp/>peers<sp/>on<sp/>the<sp/>same<sp/>local<sp/>address)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4979"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Warning:<sp/>disconnecting<sp/>but<sp/>not<sp/>discouraging<sp/>%s<sp/>peer<sp/>%d!\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="4980"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pnode.<ref refid="class_c_node_1ac29adabcdf5ca57c96df534b496f04fe" kindref="member">m_inbound_onion</ref><sp/>?<sp/></highlight><highlight class="stringliteral">&quot;inbound<sp/>onion&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;local&quot;</highlight><highlight class="normal">,<sp/>peer.m_id);</highlight></codeline>
<codeline lineno="4981"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pnode.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4982"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4983"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="4984"><highlight class="normal"></highlight></codeline>
<codeline lineno="4985"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Normal<sp/>case:<sp/>Disconnect<sp/>the<sp/>peer<sp/>and<sp/>discourage<sp/>all<sp/>nodes<sp/>sharing<sp/>the<sp/>address</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4986"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Disconnecting<sp/>and<sp/>discouraging<sp/>peer<sp/>%d!\n&quot;</highlight><highlight class="normal">,<sp/>peer.m_id);</highlight></codeline>
<codeline lineno="4987"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_banman)<sp/>m_banman-&gt;<ref refid="class_ban_man_1ab3b8d1bf1180364d68fcf605bdcf055b" kindref="member">Discourage</ref>(pnode.<ref refid="class_c_node_1afefbbc75aa05390712188a0f1e13d6f5" kindref="member">addr</ref>);</highlight></codeline>
<codeline lineno="4988"><highlight class="normal"><sp/><sp/><sp/><sp/>m_connman.<ref refid="class_c_connman_1ade63741a2d84f56c6986320e25169d8d" kindref="member">DisconnectNode</ref>(pnode.<ref refid="class_c_node_1afefbbc75aa05390712188a0f1e13d6f5" kindref="member">addr</ref>);</highlight></codeline>
<codeline lineno="4989"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4990"><highlight class="normal">}</highlight></codeline>
<codeline lineno="4991"><highlight class="normal"></highlight></codeline>
<codeline lineno="4992"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::ProcessMessages(CNode*<sp/>pfrom,<sp/>std::atomic&lt;bool&gt;&amp;<sp/>interruptMsgProc)</highlight></codeline>
<codeline lineno="4993"><highlight class="normal">{</highlight></codeline>
<codeline lineno="4994"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(m_tx_download_mutex);</highlight></codeline>
<codeline lineno="4995"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="4996"><highlight class="normal"></highlight></codeline>
<codeline lineno="4997"><highlight class="normal"><sp/><sp/><sp/><sp/>PeerRef<sp/>peer<sp/>=<sp/>GetPeerRef(pfrom-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="4998"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="4999"><highlight class="normal"></highlight></codeline>
<codeline lineno="5000"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>For<sp/>outbound<sp/>connections,<sp/>ensure<sp/>that<sp/>the<sp/>initial<sp/>VERSION<sp/>message</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5001"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>has<sp/>been<sp/>sent<sp/>first<sp/>before<sp/>processing<sp/>any<sp/>incoming<sp/>messages</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5002"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pfrom-&gt;<ref refid="class_c_node_1a878e09eabda286e4cabf6ffc0fb24ba3" kindref="member">IsInboundConn</ref>()<sp/>&amp;&amp;<sp/>!peer-&gt;m_outbound_version_message_sent)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5003"><highlight class="normal"></highlight></codeline>
<codeline lineno="5004"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="5005"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(peer-&gt;m_getdata_requests_mutex);</highlight></codeline>
<codeline lineno="5006"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!peer-&gt;m_getdata_requests.empty())<sp/>{</highlight></codeline>
<codeline lineno="5007"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ProcessGetData(*pfrom,<sp/>*peer,<sp/>interruptMsgProc);</highlight></codeline>
<codeline lineno="5008"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5009"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5010"><highlight class="normal"></highlight></codeline>
<codeline lineno="5011"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>processed_orphan<sp/>=<sp/>ProcessOrphanTx(*peer);</highlight></codeline>
<codeline lineno="5012"><highlight class="normal"></highlight></codeline>
<codeline lineno="5013"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom-&gt;<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref>)</highlight></codeline>
<codeline lineno="5014"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5015"><highlight class="normal"></highlight></codeline>
<codeline lineno="5016"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(processed_orphan)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5017"><highlight class="normal"></highlight></codeline>
<codeline lineno="5018"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>this<sp/>maintains<sp/>the<sp/>order<sp/>of<sp/>responses</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5019"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>prevents<sp/>m_getdata_requests<sp/>to<sp/>grow<sp/>unbounded</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5020"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="5021"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(peer-&gt;m_getdata_requests_mutex);</highlight></codeline>
<codeline lineno="5022"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!peer-&gt;m_getdata_requests.empty())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5023"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5024"><highlight class="normal"></highlight></codeline>
<codeline lineno="5025"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Don&apos;t<sp/>bother<sp/>if<sp/>send<sp/>buffer<sp/>is<sp/>too<sp/>full<sp/>to<sp/>respond<sp/>anyway</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5026"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pfrom-&gt;<ref refid="class_c_node_1a0d7c1f3172d1da877e15031b02b54133" kindref="member">fPauseSend</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5027"><highlight class="normal"></highlight></codeline>
<codeline lineno="5028"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>poll_result{pfrom-&gt;<ref refid="class_c_node_1a80e5ed1e109857aff68da9be77297dc3" kindref="member">PollMessage</ref>()};</highlight></codeline>
<codeline lineno="5029"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!poll_result)<sp/>{</highlight></codeline>
<codeline lineno="5030"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>No<sp/>message<sp/>to<sp/>process</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5031"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5032"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5033"><highlight class="normal"></highlight></codeline>
<codeline lineno="5034"><highlight class="normal"><sp/><sp/><sp/><sp/>CNetMessage&amp;<sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a10a0f35066079abd150539d0d13dbf3e" kindref="member">msg</ref>{poll_result-&gt;first};</highlight></codeline>
<codeline lineno="5035"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fMoreWork<sp/>=<sp/>poll_result-&gt;second;</highlight></codeline>
<codeline lineno="5036"><highlight class="normal"></highlight></codeline>
<codeline lineno="5037"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="trace_8h_1ae7d4767c75c045d7e4d4b840fb4a8e5f" kindref="member">TRACEPOINT</ref>(net,<sp/>inbound_message,</highlight></codeline>
<codeline lineno="5038"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),</highlight></codeline>
<codeline lineno="5039"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom-&gt;<ref refid="class_c_node_1a2d49df6ccf2e5770e389f89b13f4432e" kindref="member">m_addr_name</ref>.c_str(),</highlight></codeline>
<codeline lineno="5040"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pfrom-&gt;<ref refid="class_c_node_1a1366f7f0a8a51ed138660cae429e1aa1" kindref="member">ConnectionTypeAsString</ref>().c_str(),</highlight></codeline>
<codeline lineno="5041"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a10a0f35066079abd150539d0d13dbf3e" kindref="member">msg</ref>.m_type.c_str(),</highlight></codeline>
<codeline lineno="5042"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a10a0f35066079abd150539d0d13dbf3e" kindref="member">msg</ref>.m_recv.size(),</highlight></codeline>
<codeline lineno="5043"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a10a0f35066079abd150539d0d13dbf3e" kindref="member">msg</ref>.m_recv.data()</highlight></codeline>
<codeline lineno="5044"><highlight class="normal"><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="5045"><highlight class="normal"></highlight></codeline>
<codeline lineno="5046"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_opts.capture_messages)<sp/>{</highlight></codeline>
<codeline lineno="5047"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="net_8cpp_1ac834a0d98a1e73e434c6ab4e88c7de25" kindref="member">CaptureMessage</ref>(pfrom-&gt;<ref refid="class_c_node_1afefbbc75aa05390712188a0f1e13d6f5" kindref="member">addr</ref>,<sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a10a0f35066079abd150539d0d13dbf3e" kindref="member">msg</ref>.m_type,<sp/><ref refid="span_8h_1a6575ec970cb7f80477e345de6c77129c" kindref="member">MakeUCharSpan</ref>(<ref refid="namespacetests__wycheproof__generate__ecdsa_1a10a0f35066079abd150539d0d13dbf3e" kindref="member">msg</ref>.m_recv),<sp/></highlight><highlight class="comment">/*is_incoming=*/</highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="5048"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5049"><highlight class="normal"></highlight></codeline>
<codeline lineno="5050"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5051"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ProcessMessage(*pfrom,<sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a10a0f35066079abd150539d0d13dbf3e" kindref="member">msg</ref>.m_type,<sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a10a0f35066079abd150539d0d13dbf3e" kindref="member">msg</ref>.m_recv,<sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a10a0f35066079abd150539d0d13dbf3e" kindref="member">msg</ref>.m_time,<sp/>interruptMsgProc);</highlight></codeline>
<codeline lineno="5052"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(interruptMsgProc)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5053"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="5054"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(peer-&gt;m_getdata_requests_mutex);</highlight></codeline>
<codeline lineno="5055"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!peer-&gt;m_getdata_requests.empty())<sp/>fMoreWork<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5056"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5057"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Does<sp/>this<sp/>peer<sp/>has<sp/>an<sp/>orphan<sp/>ready<sp/>to<sp/>reconsider?</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5058"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(Note:<sp/>we<sp/>may<sp/>have<sp/>provided<sp/>a<sp/>parent<sp/>for<sp/>an<sp/>orphan<sp/>provided</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5059"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/>by<sp/>another<sp/>peer<sp/>that<sp/>was<sp/>already<sp/>processed;<sp/>in<sp/>that<sp/>case,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5060"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/>the<sp/>extra<sp/>work<sp/>may<sp/>not<sp/>be<sp/>noticed,<sp/>possibly<sp/>resulting<sp/>in<sp/>an</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5061"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/><sp/>unnecessary<sp/>100ms<sp/>delay)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5062"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_tx_download_mutex);</highlight></codeline>
<codeline lineno="5063"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_txdownloadman.HaveMoreWork(peer-&gt;m_id))<sp/>fMoreWork<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5064"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>std::exception&amp;<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="5065"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s(%s,<sp/>%u<sp/>bytes):<sp/>Exception<sp/>&apos;%s&apos;<sp/>(%s)<sp/>caught\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/><ref refid="util_2strencodings_8cpp_1af661610872e92731fc31facae4d42361" kindref="member">SanitizeString</ref>(<ref refid="namespacetests__wycheproof__generate__ecdsa_1a10a0f35066079abd150539d0d13dbf3e" kindref="member">msg</ref>.m_type),<sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a10a0f35066079abd150539d0d13dbf3e" kindref="member">msg</ref>.m_message_size,<sp/>e.what(),<sp/></highlight><highlight class="keyword">typeid</highlight><highlight class="normal">(e).name());</highlight></codeline>
<codeline lineno="5066"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(...)<sp/>{</highlight></codeline>
<codeline lineno="5067"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s(%s,<sp/>%u<sp/>bytes):<sp/>Unknown<sp/>exception<sp/>caught\n&quot;</highlight><highlight class="normal">,<sp/>__func__,<sp/><ref refid="util_2strencodings_8cpp_1af661610872e92731fc31facae4d42361" kindref="member">SanitizeString</ref>(<ref refid="namespacetests__wycheproof__generate__ecdsa_1a10a0f35066079abd150539d0d13dbf3e" kindref="member">msg</ref>.m_type),<sp/><ref refid="namespacetests__wycheproof__generate__ecdsa_1a10a0f35066079abd150539d0d13dbf3e" kindref="member">msg</ref>.m_message_size);</highlight></codeline>
<codeline lineno="5068"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5069"><highlight class="normal"></highlight></codeline>
<codeline lineno="5070"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>fMoreWork;</highlight></codeline>
<codeline lineno="5071"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5072"><highlight class="normal"></highlight></codeline>
<codeline lineno="5073"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::ConsiderEviction(CNode&amp;<sp/>pto,<sp/>Peer&amp;<sp/>peer,<sp/>std::chrono::seconds<sp/>time_in_seconds)</highlight></codeline>
<codeline lineno="5074"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5075"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="5076"><highlight class="normal"></highlight></codeline>
<codeline lineno="5077"><highlight class="normal"><sp/><sp/><sp/><sp/>CNodeState<sp/>&amp;state<sp/>=<sp/>*<ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(pto.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="5078"><highlight class="normal"></highlight></codeline>
<codeline lineno="5079"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!state.m_chain_sync.m_protect<sp/>&amp;&amp;<sp/>pto.<ref refid="class_c_node_1a9a98751838e41cb1a4a8b1919ef4a167" kindref="member">IsOutboundOrBlockRelayConn</ref>()<sp/>&amp;&amp;<sp/>state.fSyncStarted)<sp/>{</highlight></codeline>
<codeline lineno="5080"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>is<sp/>an<sp/>outbound<sp/>peer<sp/>subject<sp/>to<sp/>disconnection<sp/>if<sp/>they<sp/>don&apos;t</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5081"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>announce<sp/>a<sp/>block<sp/>with<sp/>as<sp/>much<sp/>work<sp/>as<sp/>the<sp/>current<sp/>tip<sp/>within</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5082"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>CHAIN_SYNC_TIMEOUT<sp/>+<sp/>HEADERS_RESPONSE_TIME<sp/>seconds<sp/>(note:<sp/>if</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5083"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>their<sp/>chain<sp/>has<sp/>more<sp/>work<sp/>than<sp/>ours,<sp/>we<sp/>should<sp/>sync<sp/>to<sp/>it,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5084"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>unless<sp/>it&apos;s<sp/>invalid,<sp/>in<sp/>which<sp/>case<sp/>we<sp/>should<sp/>find<sp/>that<sp/>out<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5085"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>disconnect<sp/>from<sp/>them<sp/>elsewhere).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5086"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.pindexBestKnownBlock<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>state.pindexBestKnownBlock-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&gt;=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>()-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref>)<sp/>{</highlight></codeline>
<codeline lineno="5087"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>outbound<sp/>peer<sp/>has<sp/>sent<sp/>us<sp/>a<sp/>block<sp/>with<sp/>at<sp/>least<sp/>as<sp/>much<sp/>work<sp/>as<sp/>our<sp/>current<sp/>tip,<sp/>so<sp/>reset<sp/>the<sp/>timeout<sp/>if<sp/>it<sp/>was<sp/>set</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5088"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.m_chain_sync.m_timeout<sp/>!=<sp/>0s)<sp/>{</highlight></codeline>
<codeline lineno="5089"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.m_chain_sync.m_timeout<sp/>=<sp/>0<ref refid="namespacetest__vectors__musig2__generate_1a5fcf9c70fa717a8efd481752dcb8ffa4" kindref="member">s</ref>;</highlight></codeline>
<codeline lineno="5090"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.m_chain_sync.m_work_header<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5091"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.m_chain_sync.m_sent_getheaders<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5092"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5093"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.m_chain_sync.m_timeout<sp/>==<sp/>0s<sp/>||<sp/>(state.m_chain_sync.m_work_header<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>state.pindexBestKnownBlock<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>state.pindexBestKnownBlock-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&gt;=<sp/>state.m_chain_sync.m_work_header-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref>))<sp/>{</highlight></codeline>
<codeline lineno="5094"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>At<sp/>this<sp/>point<sp/>we<sp/>know<sp/>that<sp/>the<sp/>outbound<sp/>peer<sp/>has<sp/>either<sp/>never<sp/>sent<sp/>us<sp/>a<sp/>block/header<sp/>or<sp/>they<sp/>have,<sp/>but<sp/>its<sp/>tip<sp/>is<sp/>behind<sp/>ours</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5095"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>AND</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5096"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>are<sp/>noticing<sp/>this<sp/>for<sp/>the<sp/>first<sp/>time<sp/>(m_timeout<sp/>is<sp/>0)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5097"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>OR<sp/>we<sp/>noticed<sp/>this<sp/>at<sp/>some<sp/>point<sp/>within<sp/>the<sp/>last<sp/>CHAIN_SYNC_TIMEOUT<sp/>+<sp/>HEADERS_RESPONSE_TIME<sp/>seconds<sp/>and<sp/>set<sp/>a<sp/>timeout</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5098"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>for<sp/>them,<sp/>they<sp/>caught<sp/>up<sp/>to<sp/>our<sp/>tip<sp/>at<sp/>the<sp/>time<sp/>of<sp/>setting<sp/>the<sp/>timer<sp/>but<sp/>not<sp/>to<sp/>our<sp/>current<sp/>one<sp/>(we&apos;ve<sp/>also<sp/>advanced).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5099"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Either<sp/>way,<sp/>set<sp/>a<sp/>new<sp/>timeout<sp/>based<sp/>on<sp/>our<sp/>current<sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5100"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.m_chain_sync.m_timeout<sp/>=<sp/>time_in_seconds<sp/>+<sp/>CHAIN_SYNC_TIMEOUT;</highlight></codeline>
<codeline lineno="5101"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.m_chain_sync.m_work_header<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>();</highlight></codeline>
<codeline lineno="5102"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.m_chain_sync.m_sent_getheaders<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5103"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.m_chain_sync.m_timeout<sp/>&gt;<sp/>0s<sp/>&amp;&amp;<sp/>time_in_seconds<sp/>&gt;<sp/>state.m_chain_sync.m_timeout)<sp/>{</highlight></codeline>
<codeline lineno="5104"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>No<sp/>evidence<sp/>yet<sp/>that<sp/>our<sp/>peer<sp/>has<sp/>synced<sp/>to<sp/>a<sp/>chain<sp/>with<sp/>work<sp/>equal<sp/>to<sp/>that</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>of<sp/>our<sp/>tip,<sp/>when<sp/>we<sp/>first<sp/>detected<sp/>it<sp/>was<sp/>behind.<sp/>Send<sp/>a<sp/>single<sp/>getheaders</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>message<sp/>to<sp/>give<sp/>the<sp/>peer<sp/>a<sp/>chance<sp/>to<sp/>update<sp/>us.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.m_chain_sync.m_sent_getheaders)<sp/>{</highlight></codeline>
<codeline lineno="5108"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>They&apos;ve<sp/>run<sp/>out<sp/>of<sp/>time<sp/>to<sp/>catch<sp/>up!</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5109"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Outbound<sp/>peer<sp/>has<sp/>old<sp/>chain,<sp/>best<sp/>known<sp/>block<sp/>=<sp/>%s,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>state.pindexBestKnownBlock<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>?<sp/>state.pindexBestKnownBlock-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>()<sp/>:<sp/></highlight><highlight class="stringliteral">&quot;&lt;none&gt;&quot;</highlight><highlight class="normal">,<sp/>pto.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="5110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pto.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(state.m_chain_sync.m_work_header);</highlight></codeline>
<codeline lineno="5113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Here,<sp/>we<sp/>assume<sp/>that<sp/>the<sp/>getheaders<sp/>message<sp/>goes<sp/>out,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>because<sp/>it&apos;ll<sp/>either<sp/>go<sp/>out<sp/>or<sp/>be<sp/>skipped<sp/>because<sp/>of<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>getheaders<sp/>in-flight<sp/>already,<sp/>in<sp/>which<sp/>case<sp/>the<sp/>peer<sp/>should</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>still<sp/>respond<sp/>to<sp/>us<sp/>with<sp/>a<sp/>sufficiently<sp/>high<sp/>work<sp/>chain<sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MaybeSendGetHeaders(pto,</highlight></codeline>
<codeline lineno="5118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="chain_8cpp_1a6f7cb8de33a43e97b3dd7517998379bc" kindref="member">GetLocator</ref>(state.m_chain_sync.m_work_header-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>),</highlight></codeline>
<codeline lineno="5119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer);</highlight></codeline>
<codeline lineno="5120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;sending<sp/>getheaders<sp/>to<sp/>outbound<sp/>peer=%d<sp/>to<sp/>verify<sp/>chain<sp/>work<sp/>(current<sp/>best<sp/>known<sp/>block:%s,<sp/>benchmark<sp/>blockhash:<sp/>%s)\n&quot;</highlight><highlight class="normal">,<sp/>pto.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>state.pindexBestKnownBlock<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>?<sp/>state.pindexBestKnownBlock-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>()<sp/>:<sp/></highlight><highlight class="stringliteral">&quot;&lt;none&gt;&quot;</highlight><highlight class="normal">,<sp/>state.m_chain_sync.m_work_header-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="5121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.m_chain_sync.m_sent_getheaders<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5122"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Bump<sp/>the<sp/>timeout<sp/>to<sp/>allow<sp/>a<sp/>response,<sp/>which<sp/>could<sp/>clear<sp/>the<sp/>timeout</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(if<sp/>the<sp/>response<sp/>shows<sp/>the<sp/>peer<sp/>has<sp/>synced),<sp/>reset<sp/>the<sp/>timeout<sp/>(if</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>peer<sp/>syncs<sp/>to<sp/>the<sp/>required<sp/>work<sp/>but<sp/>not<sp/>to<sp/>our<sp/>tip),<sp/>or<sp/>result</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>in<sp/>disconnect<sp/>(if<sp/>we<sp/>advance<sp/>to<sp/>the<sp/>timeout<sp/>and<sp/>pindexBestKnownBlock</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>has<sp/>not<sp/>sufficiently<sp/>progressed)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.m_chain_sync.m_timeout<sp/>=<sp/>time_in_seconds<sp/>+<sp/>HEADERS_RESPONSE_TIME;</highlight></codeline>
<codeline lineno="5128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5129"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5130"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5131"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5132"><highlight class="normal"></highlight></codeline>
<codeline lineno="5133"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds<sp/>now)</highlight></codeline>
<codeline lineno="5134"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5135"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>have<sp/>any<sp/>extra<sp/>block-relay-only<sp/>peers,<sp/>disconnect<sp/>the<sp/>youngest<sp/>unless</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5136"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>it&apos;s<sp/>given<sp/>us<sp/>a<sp/>block<sp/>--<sp/>in<sp/>which<sp/>case,<sp/>compare<sp/>with<sp/>the<sp/>second-youngest,<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5137"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>out<sp/>of<sp/>those<sp/>two,<sp/>disconnect<sp/>the<sp/>peer<sp/>who<sp/>least<sp/>recently<sp/>gave<sp/>us<sp/>a<sp/>block.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5138"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>youngest<sp/>block-relay-only<sp/>peer<sp/>would<sp/>be<sp/>the<sp/>extra<sp/>peer<sp/>we<sp/>connected</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5139"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>temporarily<sp/>in<sp/>order<sp/>to<sp/>sync<sp/>our<sp/>tip;<sp/>see<sp/>net.cpp.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5140"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note<sp/>that<sp/>we<sp/>use<sp/>higher<sp/>nodeid<sp/>as<sp/>a<sp/>measure<sp/>for<sp/>most<sp/>recent<sp/>connection.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5141"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_connman.<ref refid="class_c_connman_1a1d11e3e2f35e758ad83e563ec480aef9" kindref="member">GetExtraBlockRelayCount</ref>()<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="5142"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::pair&lt;NodeId,<sp/>std::chrono::seconds&gt;<sp/>youngest_peer{-1,<sp/>0},<sp/>next_youngest_peer{-1,<sp/>0};</highlight></codeline>
<codeline lineno="5143"><highlight class="normal"></highlight></codeline>
<codeline lineno="5144"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_connman.<ref refid="class_c_connman_1a94ba073a4116729f3850622392d86168" kindref="member">ForEachNode</ref>([&amp;](CNode*<sp/>pnode)<sp/>{</highlight></codeline>
<codeline lineno="5145"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pnode-&gt;<ref refid="class_c_node_1a610ec1d1f02cc4bb029acc3cf47b9f4c" kindref="member">IsBlockOnlyConn</ref>()<sp/>||<sp/>pnode-&gt;<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5146"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pnode-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>()<sp/>&gt;<sp/>youngest_peer.first)<sp/>{</highlight></codeline>
<codeline lineno="5147"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>next_youngest_peer<sp/>=<sp/>youngest_peer;</highlight></codeline>
<codeline lineno="5148"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>youngest_peer.first<sp/>=<sp/>pnode-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>();</highlight></codeline>
<codeline lineno="5149"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>youngest_peer.second<sp/>=<sp/>pnode-&gt;<ref refid="class_c_node_1a187bf49ad10db6ecf4917f24a17048b6" kindref="member">m_last_block_time</ref>;</highlight></codeline>
<codeline lineno="5150"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5151"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="5152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>to_disconnect<sp/>=<sp/>youngest_peer.first;</highlight></codeline>
<codeline lineno="5153"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(youngest_peer.second<sp/>&gt;<sp/>next_youngest_peer.second)<sp/>{</highlight></codeline>
<codeline lineno="5154"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Our<sp/>newest<sp/>block-relay-only<sp/>peer<sp/>gave<sp/>us<sp/>a<sp/>block<sp/>more<sp/>recently;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5155"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>disconnect<sp/>our<sp/>second<sp/>youngest.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5156"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>to_disconnect<sp/>=<sp/>next_youngest_peer.first;</highlight></codeline>
<codeline lineno="5157"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5158"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_connman.<ref refid="class_c_connman_1a0df360faf6c653e1ebea6b5b7eee301b" kindref="member">ForNode</ref>(to_disconnect,<sp/>[&amp;](CNode*<sp/>pnode)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>)<sp/>{</highlight></codeline>
<codeline lineno="5159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="5160"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Make<sp/>sure<sp/>we&apos;re<sp/>not<sp/>getting<sp/>a<sp/>block<sp/>right<sp/>now,<sp/>and<sp/>that</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5161"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we&apos;ve<sp/>been<sp/>connected<sp/>long<sp/>enough<sp/>for<sp/>this<sp/>eviction<sp/>to<sp/>happen</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5162"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>at<sp/>all.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note<sp/>that<sp/>we<sp/>only<sp/>request<sp/>blocks<sp/>from<sp/>a<sp/>peer<sp/>if<sp/>we<sp/>learn<sp/>of<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>valid<sp/>headers<sp/>chain<sp/>with<sp/>at<sp/>least<sp/>as<sp/>much<sp/>work<sp/>as<sp/>our<sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CNodeState<sp/>*node_state<sp/>=<sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(pnode-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="5166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(node_state<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>||</highlight></codeline>
<codeline lineno="5167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(now<sp/>-<sp/>pnode-&gt;<ref refid="class_c_node_1a9d5ec6f76c89a5fb4891fa5a22aa47b2" kindref="member">m_connected</ref><sp/>&gt;=<sp/>MINIMUM_CONNECT_TIME<sp/>&amp;&amp;<sp/>node_state-&gt;vBlocksInFlight.empty()))<sp/>{</highlight></codeline>
<codeline lineno="5168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pnode-&gt;<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;disconnecting<sp/>extra<sp/>block-relay-only<sp/>peer=%d<sp/>(last<sp/>block<sp/>received<sp/>at<sp/>time<sp/>%d)\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pnode-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/><ref refid="util_2time_8h_1a888f421c54ec4d38a01dd0f7ddacd6a6" kindref="member">count_seconds</ref>(pnode-&gt;<ref refid="class_c_node_1a187bf49ad10db6ecf4917f24a17048b6" kindref="member">m_last_block_time</ref>));</highlight></codeline>
<codeline lineno="5171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5172"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5173"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;keeping<sp/>block-relay-only<sp/>peer=%d<sp/>chosen<sp/>for<sp/>eviction<sp/>(connect<sp/>time:<sp/>%d,<sp/>blocks_in_flight:<sp/>%d)\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5174"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pnode-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/><ref refid="util_2time_8h_1a888f421c54ec4d38a01dd0f7ddacd6a6" kindref="member">count_seconds</ref>(pnode-&gt;<ref refid="class_c_node_1a9d5ec6f76c89a5fb4891fa5a22aa47b2" kindref="member">m_connected</ref>),<sp/>node_state-&gt;vBlocksInFlight.size());</highlight></codeline>
<codeline lineno="5175"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5177"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="5178"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5179"><highlight class="normal"></highlight></codeline>
<codeline lineno="5180"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>whether<sp/>we<sp/>have<sp/>too<sp/>many<sp/>outbound-full-relay<sp/>peers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5181"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_connman.<ref refid="class_c_connman_1ab0caa20b590484f9eeae5de7dda6ea8e" kindref="member">GetExtraFullOutboundCount</ref>()<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="5182"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>have<sp/>more<sp/>outbound-full-relay<sp/>peers<sp/>than<sp/>we<sp/>target,<sp/>disconnect<sp/>one.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5183"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Pick<sp/>the<sp/>outbound-full-relay<sp/>peer<sp/>that<sp/>least<sp/>recently<sp/>announced</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5184"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>us<sp/>a<sp/>new<sp/>block,<sp/>with<sp/>ties<sp/>broken<sp/>by<sp/>choosing<sp/>the<sp/>more<sp/>recent</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5185"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>connection<sp/>(higher<sp/>node<sp/>id)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Protect<sp/>peers<sp/>from<sp/>eviction<sp/>if<sp/>we<sp/>don&apos;t<sp/>have<sp/>another<sp/>connection</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>their<sp/>network,<sp/>counting<sp/>both<sp/>outbound-full-relay<sp/>and<sp/>manual<sp/>peers.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>worst_peer<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="5189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>int64_t<sp/>oldest_block_announcement<sp/>=<sp/>std::numeric_limits&lt;int64_t&gt;::max();</highlight></codeline>
<codeline lineno="5190"><highlight class="normal"></highlight></codeline>
<codeline lineno="5191"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_connman.<ref refid="class_c_connman_1a94ba073a4116729f3850622392d86168" kindref="member">ForEachNode</ref>([&amp;](CNode*<sp/>pnode)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>,<sp/>m_connman.<ref refid="class_c_connman_1a8e44ba362501acfe9cd6f249b9c8f750" kindref="member">GetNodesMutex</ref>())<sp/>{</highlight></codeline>
<codeline lineno="5192"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>AssertLockHeld(::cs_main);</highlight></codeline>
<codeline lineno="5193"><highlight class="normal"></highlight></codeline>
<codeline lineno="5194"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>consider<sp/>outbound-full-relay<sp/>peers<sp/>that<sp/>are<sp/>not<sp/>already</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5195"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>marked<sp/>for<sp/>disconnection</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(!pnode-&gt;IsFullOutboundConn()<sp/>||<sp/>pnode-&gt;fDisconnect)<sp/>return;</highlight></codeline>
<codeline lineno="5197"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CNodeState<sp/>*state<sp/>=<sp/>State(pnode-&gt;GetId());</highlight></codeline>
<codeline lineno="5198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(state<sp/>==<sp/>nullptr)<sp/>return;<sp/></highlight><highlight class="comment">//<sp/>shouldn&apos;t<sp/>be<sp/>possible,<sp/>but<sp/>just<sp/>in<sp/>case</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5199"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Don&apos;t<sp/>evict<sp/>our<sp/>protected<sp/>peers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(state-&gt;m_chain_sync.m_protect)<sp/>return;</highlight></codeline>
<codeline lineno="5201"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>this<sp/>is<sp/>the<sp/>only<sp/>connection<sp/>on<sp/>a<sp/>particular<sp/>network<sp/>that<sp/>is</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5202"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>OUTBOUND_FULL_RELAY<sp/>or<sp/>MANUAL,<sp/>protect<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(!m_connman.MultipleManualOrFullOutboundConns(pnode-&gt;addr.GetNetwork()))<sp/>return;</highlight></codeline>
<codeline lineno="5204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(state-&gt;m_last_block_announcement<sp/>&lt;<sp/>oldest_block_announcement<sp/>||<sp/>(state-&gt;m_last_block_announcement<sp/>==<sp/>oldest_block_announcement<sp/>&amp;&amp;<sp/>pnode-&gt;GetId()<sp/>&gt;<sp/>worst_peer))<sp/>{</highlight></codeline>
<codeline lineno="5205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>worst_peer<sp/>=<sp/>pnode-&gt;GetId();</highlight></codeline>
<codeline lineno="5206"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>oldest_block_announcement<sp/>=<sp/>state-&gt;m_last_block_announcement;</highlight></codeline>
<codeline lineno="5207"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="5209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(worst_peer<sp/>!=<sp/>-1)<sp/>{</highlight></codeline>
<codeline lineno="5210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>disconnected<sp/>=<sp/>m_connman.<ref refid="class_c_connman_1a0df360faf6c653e1ebea6b5b7eee301b" kindref="member">ForNode</ref>(worst_peer,<sp/>[&amp;](CNode*<sp/>pnode)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>)<sp/>{</highlight></codeline>
<codeline lineno="5211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">::cs_main</ref>);</highlight></codeline>
<codeline lineno="5212"><highlight class="normal"></highlight></codeline>
<codeline lineno="5213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>disconnect<sp/>a<sp/>peer<sp/>that<sp/>has<sp/>been<sp/>connected<sp/>to<sp/>us<sp/>for</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>some<sp/>reasonable<sp/>fraction<sp/>of<sp/>our<sp/>check-frequency,<sp/>to<sp/>give</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5215"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>it<sp/>time<sp/>for<sp/>new<sp/>information<sp/>to<sp/>have<sp/>arrived.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Also<sp/>don&apos;t<sp/>disconnect<sp/>any<sp/>peer<sp/>we&apos;re<sp/>trying<sp/>to<sp/>download<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5217"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>block<sp/>from.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5218"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CNodeState<sp/>&amp;state<sp/>=<sp/>*<ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(pnode-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="5219"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(now<sp/>-<sp/>pnode-&gt;<ref refid="class_c_node_1a9d5ec6f76c89a5fb4891fa5a22aa47b2" kindref="member">m_connected</ref><sp/>&gt;<sp/>MINIMUM_CONNECT_TIME<sp/>&amp;&amp;<sp/>state.vBlocksInFlight.empty())<sp/>{</highlight></codeline>
<codeline lineno="5220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;disconnecting<sp/>extra<sp/>outbound<sp/>peer=%d<sp/>(last<sp/>block<sp/>announcement<sp/>received<sp/>at<sp/>time<sp/>%d)\n&quot;</highlight><highlight class="normal">,<sp/>pnode-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>oldest_block_announcement);</highlight></codeline>
<codeline lineno="5221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pnode-&gt;<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;keeping<sp/>outbound<sp/>peer=%d<sp/>chosen<sp/>for<sp/>eviction<sp/>(connect<sp/>time:<sp/>%d,<sp/>blocks_in_flight:<sp/>%d)\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pnode-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/><ref refid="util_2time_8h_1a888f421c54ec4d38a01dd0f7ddacd6a6" kindref="member">count_seconds</ref>(pnode-&gt;<ref refid="class_c_node_1a9d5ec6f76c89a5fb4891fa5a22aa47b2" kindref="member">m_connected</ref>),<sp/>state.vBlocksInFlight.size());</highlight></codeline>
<codeline lineno="5226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="5229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(disconnected)<sp/>{</highlight></codeline>
<codeline lineno="5230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>disconnected<sp/>an<sp/>extra<sp/>peer,<sp/>that<sp/>means<sp/>we<sp/>successfully</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5231"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>connected<sp/>to<sp/>at<sp/>least<sp/>one<sp/>peer<sp/>after<sp/>the<sp/>last<sp/>time<sp/>we</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5232"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>detected<sp/>a<sp/>stale<sp/>tip.<sp/>Don&apos;t<sp/>try<sp/>any<sp/>more<sp/>extra<sp/>peers<sp/>until</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>next<sp/>detect<sp/>a<sp/>stale<sp/>tip,<sp/>to<sp/>limit<sp/>the<sp/>load<sp/>we<sp/>put<sp/>on<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>network<sp/>from<sp/>these<sp/>extra<sp/>connections.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_connman.<ref refid="class_c_connman_1ad9b56d7738cb2cc935f98fd5a4f2e606" kindref="member">SetTryNewOutboundPeer</ref>(</highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="5236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5238"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5239"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5240"><highlight class="normal"></highlight></codeline>
<codeline lineno="5241"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::CheckForStaleTipAndEvictPeers()</highlight></codeline>
<codeline lineno="5242"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5243"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="5244"><highlight class="normal"></highlight></codeline>
<codeline lineno="5245"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>now{<ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime&lt;std::chrono::seconds&gt;</ref>()};</highlight></codeline>
<codeline lineno="5246"><highlight class="normal"></highlight></codeline>
<codeline lineno="5247"><highlight class="normal"><sp/><sp/><sp/><sp/>EvictExtraOutboundPeers(now);</highlight></codeline>
<codeline lineno="5248"><highlight class="normal"></highlight></codeline>
<codeline lineno="5249"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(now<sp/>&gt;<sp/>m_stale_tip_check_time)<sp/>{</highlight></codeline>
<codeline lineno="5250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>whether<sp/>our<sp/>tip<sp/>is<sp/>stale,<sp/>and<sp/>if<sp/>so,<sp/>allow<sp/>using<sp/>an<sp/>extra</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>outbound<sp/>peer</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1acef48b2a0b8aa252efa69928192b4d5a" kindref="member">LoadingBlocks</ref>()<sp/>&amp;&amp;<sp/>m_connman.<ref refid="class_c_connman_1abb77ca85329f0052489c70f4fc313944" kindref="member">GetNetworkActive</ref>()<sp/>&amp;&amp;<sp/>m_connman.<ref refid="class_c_connman_1a33a4e1919bc0d75c050cc66a2cabed3a" kindref="member">GetUseAddrmanOutgoing</ref>()<sp/>&amp;&amp;<sp/>TipMayBeStale())<sp/>{</highlight></codeline>
<codeline lineno="5253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Potential<sp/>stale<sp/>tip<sp/>detected,<sp/>will<sp/>try<sp/>using<sp/>extra<sp/>outbound<sp/>peer<sp/>(last<sp/>tip<sp/>update:<sp/>%d<sp/>seconds<sp/>ago)\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1a888f421c54ec4d38a01dd0f7ddacd6a6" kindref="member">count_seconds</ref>(now<sp/>-<sp/>m_last_tip_update.load()));</highlight></codeline>
<codeline lineno="5255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_connman.<ref refid="class_c_connman_1ad9b56d7738cb2cc935f98fd5a4f2e606" kindref="member">SetTryNewOutboundPeer</ref>(</highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="5256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_connman.<ref refid="class_c_connman_1abc34b82d1c414d1a7baf4bfef5210179" kindref="member">GetTryNewOutboundPeer</ref>())<sp/>{</highlight></codeline>
<codeline lineno="5257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_connman.<ref refid="class_c_connman_1ad9b56d7738cb2cc935f98fd5a4f2e606" kindref="member">SetTryNewOutboundPeer</ref>(</highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="5258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_stale_tip_check_time<sp/>=<sp/>now<sp/>+<sp/>STALE_CHECK_INTERVAL;</highlight></codeline>
<codeline lineno="5260"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5261"><highlight class="normal"></highlight></codeline>
<codeline lineno="5262"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!m_initial_sync_finished<sp/>&amp;&amp;<sp/>CanDirectFetch())<sp/>{</highlight></codeline>
<codeline lineno="5263"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_connman.<ref refid="class_c_connman_1ad5345042d09d385f8c8076d79ee2bedf" kindref="member">StartExtraBlockRelayPeers</ref>();</highlight></codeline>
<codeline lineno="5264"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_initial_sync_finished<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5265"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5266"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5267"><highlight class="normal"></highlight></codeline>
<codeline lineno="5268"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::MaybeSendPing(CNode&amp;<sp/>node_to,<sp/>Peer&amp;<sp/>peer,<sp/>std::chrono::microseconds<sp/>now)</highlight></codeline>
<codeline lineno="5269"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5270"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_connman.<ref refid="class_c_connman_1a7c65a78b1f97c25fbcd0ef7b8a131aad" kindref="member">ShouldRunInactivityChecks</ref>(node_to,<sp/>std::chrono::duration_cast&lt;std::chrono::seconds&gt;(now))<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="5271"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_ping_nonce_sent<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="5272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>now<sp/>&gt;<sp/>peer.m_ping_start.load()<sp/>+<sp/>TIMEOUT_INTERVAL)</highlight></codeline>
<codeline lineno="5273"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="5274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>ping<sp/>timeout<sp/>is<sp/>using<sp/>mocktime.<sp/>To<sp/>disable<sp/>the<sp/>check<sp/>during</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>testing,<sp/>increase<sp/>-peertimeout.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5276"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;ping<sp/>timeout:<sp/>%fs,<sp/>%s&quot;</highlight><highlight class="normal">,<sp/>0.000001<sp/>*<sp/><ref refid="util_2time_8h_1a856f7917ac1e6451b436ae92fc133cef" kindref="member">count_microseconds</ref>(now<sp/>-<sp/>peer.m_ping_start.load()),<sp/>node_to.<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="5277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>node_to.<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5279"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5280"><highlight class="normal"></highlight></codeline>
<codeline lineno="5281"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>pingSend<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5282"><highlight class="normal"></highlight></codeline>
<codeline lineno="5283"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer.m_ping_queued)<sp/>{</highlight></codeline>
<codeline lineno="5284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>RPC<sp/>ping<sp/>request<sp/>by<sp/>user</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pingSend<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5286"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5287"><highlight class="normal"></highlight></codeline>
<codeline lineno="5288"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer.m_ping_nonce_sent<sp/>==<sp/>0<sp/>&amp;&amp;<sp/>now<sp/>&gt;<sp/>peer.m_ping_start.load()<sp/>+<sp/>PING_INTERVAL)<sp/>{</highlight></codeline>
<codeline lineno="5289"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ping<sp/>automatically<sp/>sent<sp/>as<sp/>a<sp/>latency<sp/>probe<sp/>&amp;<sp/>keepalive.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pingSend<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5291"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5292"><highlight class="normal"></highlight></codeline>
<codeline lineno="5293"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pingSend)<sp/>{</highlight></codeline>
<codeline lineno="5294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint64_t<sp/><ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref>;</highlight></codeline>
<codeline lineno="5295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">do</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5296"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref><sp/>=<sp/>FastRandomContext().rand64();</highlight></codeline>
<codeline lineno="5297"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(<ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref><sp/>==<sp/>0);</highlight></codeline>
<codeline lineno="5298"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_ping_queued<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_ping_start<sp/>=<sp/>now;</highlight></codeline>
<codeline lineno="5300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(node_to.<ref refid="class_c_node_1af039a299f31c62d63996fd5907c3f953" kindref="member">GetCommonVersion</ref>()<sp/>&gt;<sp/>BIP0031_VERSION)<sp/>{</highlight></codeline>
<codeline lineno="5301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_ping_nonce_sent<sp/>=<sp/><ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref>;</highlight></codeline>
<codeline lineno="5302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(node_to,<sp/><ref refid="namespace_net_msg_type_1a751cef7cb24a52347f18d02f78904833" kindref="member">NetMsgType::PING</ref>,<sp/><ref refid="miner__tests_8cpp_1ad73ee4141a6536b03f4e493b56859e86" kindref="member">nonce</ref>);</highlight></codeline>
<codeline lineno="5303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Peer<sp/>is<sp/>too<sp/>old<sp/>to<sp/>support<sp/>ping<sp/>command<sp/>with<sp/>nonce,<sp/>pong<sp/>will<sp/>never<sp/>arrive.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_ping_nonce_sent<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="5306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(node_to,<sp/><ref refid="namespace_net_msg_type_1a751cef7cb24a52347f18d02f78904833" kindref="member">NetMsgType::PING</ref>);</highlight></codeline>
<codeline lineno="5307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5308"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5309"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5310"><highlight class="normal"></highlight></codeline>
<codeline lineno="5311"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::MaybeSendAddr(CNode&amp;<sp/>node,<sp/>Peer&amp;<sp/>peer,<sp/>std::chrono::microseconds<sp/>current_time)</highlight></codeline>
<codeline lineno="5312"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5313"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Nothing<sp/>to<sp/>do<sp/>for<sp/>non-address-relay<sp/>peers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5314"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!peer.m_addr_relay_enabled)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5315"><highlight class="normal"></highlight></codeline>
<codeline lineno="5316"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(peer.m_addr_send_times_mutex);</highlight></codeline>
<codeline lineno="5317"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Periodically<sp/>advertise<sp/>our<sp/>local<sp/>address<sp/>to<sp/>the<sp/>peer.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5318"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="net_8cpp_1a5067f8b9215406011fa3461be92d819c" kindref="member">fListen</ref><sp/>&amp;&amp;<sp/>!m_chainman.<ref refid="class_chainstate_manager_1a312bb1a2008bae3205f4699b90880d66" kindref="member">IsInitialBlockDownload</ref>()<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="5319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_next_local_addr_send<sp/>&lt;<sp/>current_time)<sp/>{</highlight></codeline>
<codeline lineno="5320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we&apos;ve<sp/>sent<sp/>before,<sp/>clear<sp/>the<sp/>bloom<sp/>filter<sp/>for<sp/>the<sp/>peer,<sp/>so<sp/>that<sp/>our</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>self-announcement<sp/>will<sp/>actually<sp/>go<sp/>out.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>might<sp/>be<sp/>unnecessary<sp/>if<sp/>the<sp/>bloom<sp/>filter<sp/>has<sp/>already<sp/>rolled</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>over<sp/>since<sp/>our<sp/>last<sp/>self-announcement,<sp/>but<sp/>there<sp/>is<sp/>only<sp/>a<sp/>small</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>bandwidth<sp/>cost<sp/>that<sp/>we<sp/>can<sp/>incur<sp/>by<sp/>doing<sp/>this<sp/>(which<sp/>happens</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>once<sp/>a<sp/>day<sp/>on<sp/>average).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer.m_next_local_addr_send<sp/>!=<sp/>0us)<sp/>{</highlight></codeline>
<codeline lineno="5327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_addr_known-&gt;reset();</highlight></codeline>
<codeline lineno="5328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(std::optional&lt;CService&gt;<sp/>local_service<sp/>=<sp/><ref refid="net_8cpp_1a72e179fd909099452d43c48470ed4eaa" kindref="member">GetLocalAddrForPeer</ref>(node))<sp/>{</highlight></codeline>
<codeline lineno="5330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CAddress<sp/>local_addr{*local_service,<sp/>peer.m_our_services,<sp/><ref refid="util_2time_8h_1a7a4e7e09a41ff922cf1eb6fdaae4b3ba" kindref="member">Now&lt;NodeSeconds&gt;</ref>()};</highlight></codeline>
<codeline lineno="5331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PushAddress(peer,<sp/>local_addr);</highlight></codeline>
<codeline lineno="5332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_next_local_addr_send<sp/>=<sp/>current_time<sp/>+<sp/>m_rng.rand_exp_duration(AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);</highlight></codeline>
<codeline lineno="5334"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5335"><highlight class="normal"></highlight></codeline>
<codeline lineno="5336"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>sent<sp/>an<sp/>`addr`<sp/>message<sp/>to<sp/>this<sp/>peer<sp/>recently.<sp/>Nothing<sp/>more<sp/>to<sp/>do.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5337"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(current_time<sp/>&lt;=<sp/>peer.m_next_addr_send)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5338"><highlight class="normal"></highlight></codeline>
<codeline lineno="5339"><highlight class="normal"><sp/><sp/><sp/><sp/>peer.m_next_addr_send<sp/>=<sp/>current_time<sp/>+<sp/>m_rng.rand_exp_duration(AVG_ADDRESS_BROADCAST_INTERVAL);</highlight></codeline>
<codeline lineno="5340"><highlight class="normal"></highlight></codeline>
<codeline lineno="5341"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="check_8h_1adf63e17d34d997e5218a73ef20960ca9" kindref="member">Assume</ref>(peer.m_addrs_to_send.size()<sp/>&lt;=<sp/>MAX_ADDR_TO_SEND))<sp/>{</highlight></codeline>
<codeline lineno="5342"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Should<sp/>be<sp/>impossible<sp/>since<sp/>we<sp/>always<sp/>check<sp/>size<sp/>before<sp/>adding<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>m_addrs_to_send.<sp/>Recover<sp/>by<sp/>trimming<sp/>the<sp/>vector.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_addrs_to_send.resize(MAX_ADDR_TO_SEND);</highlight></codeline>
<codeline lineno="5345"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5346"><highlight class="normal"></highlight></codeline>
<codeline lineno="5347"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Remove<sp/>addr<sp/>records<sp/>that<sp/>the<sp/>peer<sp/>already<sp/>knows<sp/>about,<sp/>and<sp/>add<sp/>new</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5348"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>addrs<sp/>to<sp/>the<sp/>m_addr_known<sp/>filter<sp/>on<sp/>the<sp/>same<sp/>pass.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5349"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>addr_already_known<sp/>=<sp/>[&amp;peer](</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CAddress&amp;<sp/>addr)<sp/><ref refid="thread__annotations_8h_1a0e2e86b0f11d9778240b0a0b263047b1" kindref="member">EXCLUSIVE_LOCKS_REQUIRED</ref>(g_msgproc_mutex)<sp/>{</highlight></codeline>
<codeline lineno="5350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref><sp/>=<sp/>peer.m_addr_known-&gt;contains(addr.<ref refid="class_c_service_1a2f76cbfe9660cf0325a7498e3c5b6f22" kindref="member">GetKey</ref>());</highlight></codeline>
<codeline lineno="5351"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!<ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>)<sp/>peer.m_addr_known-&gt;insert(addr.<ref refid="class_c_service_1a2f76cbfe9660cf0325a7498e3c5b6f22" kindref="member">GetKey</ref>());</highlight></codeline>
<codeline lineno="5352"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>;</highlight></codeline>
<codeline lineno="5353"><highlight class="normal"><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="5354"><highlight class="normal"><sp/><sp/><sp/><sp/>peer.m_addrs_to_send.erase(std::remove_if(peer.m_addrs_to_send.begin(),<sp/>peer.m_addrs_to_send.end(),<sp/>addr_already_known),</highlight></codeline>
<codeline lineno="5355"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_addrs_to_send.end());</highlight></codeline>
<codeline lineno="5356"><highlight class="normal"></highlight></codeline>
<codeline lineno="5357"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>No<sp/>addr<sp/>messages<sp/>to<sp/>send</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5358"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer.m_addrs_to_send.empty())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5359"><highlight class="normal"></highlight></codeline>
<codeline lineno="5360"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer.m_wants_addrv2)<sp/>{</highlight></codeline>
<codeline lineno="5361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(node,<sp/><ref refid="namespace_net_msg_type_1a63d100c38422ce00c66b37d69a07c33e" kindref="member">NetMsgType::ADDRV2</ref>,<sp/><ref refid="class_c_address_1a3e08cfe400d30e4bdb6ab6c47e8629d6" kindref="member">CAddress::V2_NETWORK</ref>(peer.m_addrs_to_send));</highlight></codeline>
<codeline lineno="5362"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(node,<sp/><ref refid="namespace_net_msg_type_1a727f2266aa41f763e1dda50133f71078" kindref="member">NetMsgType::ADDR</ref>,<sp/><ref refid="class_c_address_1a591c2be3475b55db0a72bc14c90dff38" kindref="member">CAddress::V1_NETWORK</ref>(peer.m_addrs_to_send));</highlight></codeline>
<codeline lineno="5364"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5365"><highlight class="normal"><sp/><sp/><sp/><sp/>peer.m_addrs_to_send.clear();</highlight></codeline>
<codeline lineno="5366"><highlight class="normal"></highlight></codeline>
<codeline lineno="5367"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>only<sp/>send<sp/>the<sp/>big<sp/>addr<sp/>message<sp/>once</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5368"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer.m_addrs_to_send.capacity()<sp/>&gt;<sp/>40)<sp/>{</highlight></codeline>
<codeline lineno="5369"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_addrs_to_send.shrink_to_fit();</highlight></codeline>
<codeline lineno="5370"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5371"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5372"><highlight class="normal"></highlight></codeline>
<codeline lineno="5373"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::MaybeSendSendHeaders(CNode&amp;<sp/>node,<sp/>Peer&amp;<sp/>peer)</highlight></codeline>
<codeline lineno="5374"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5375"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Delay<sp/>sending<sp/>SENDHEADERS<sp/>(BIP<sp/>130)<sp/>until<sp/>we&apos;re<sp/>done<sp/>with<sp/>an</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5376"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>initial-headers-sync<sp/>with<sp/>this<sp/>peer.<sp/>Receiving<sp/>headers<sp/>announcements<sp/>for</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5377"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>new<sp/>blocks<sp/>while<sp/>trying<sp/>to<sp/>sync<sp/>their<sp/>headers<sp/>chain<sp/>is<sp/>problematic,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5378"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>because<sp/>of<sp/>the<sp/>state<sp/>tracking<sp/>done.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5379"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!peer.m_sent_sendheaders<sp/>&amp;&amp;<sp/>node.<ref refid="class_c_node_1af039a299f31c62d63996fd5907c3f953" kindref="member">GetCommonVersion</ref>()<sp/>&gt;=<sp/>SENDHEADERS_VERSION)<sp/>{</highlight></codeline>
<codeline lineno="5380"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="5381"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CNodeState<sp/>&amp;state<sp/>=<sp/>*<ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(node.<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="5382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.pindexBestKnownBlock<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="5383"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.pindexBestKnownBlock-&gt;<ref refid="class_c_block_index_1af189e4672d5e71b7e1334a9bebf8d5d4" kindref="member">nChainWork</ref><sp/>&gt;<sp/>m_chainman.<ref refid="class_chainstate_manager_1af6689b42eea6a15ba7e5409ea374cdb4" kindref="member">MinimumChainWork</ref>())<sp/>{</highlight></codeline>
<codeline lineno="5384"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Tell<sp/>our<sp/>peer<sp/>we<sp/>prefer<sp/>to<sp/>receive<sp/>headers<sp/>rather<sp/>than<sp/>inv&apos;s</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5385"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>send<sp/>this<sp/>to<sp/>non-NODE<sp/>NETWORK<sp/>peers<sp/>as<sp/>well,<sp/>because<sp/>even</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>non-NODE<sp/>NETWORK<sp/>peers<sp/>can<sp/>announce<sp/>blocks<sp/>(such<sp/>as<sp/>pruning</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5387"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>nodes)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5388"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(node,<sp/><ref refid="namespace_net_msg_type_1a84032835a1817d040fe6388cb79a940a" kindref="member">NetMsgType::SENDHEADERS</ref>);</highlight></codeline>
<codeline lineno="5389"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_sent_sendheaders<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5390"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5391"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5392"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5393"><highlight class="normal"></highlight></codeline>
<codeline lineno="5394"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>PeerManagerImpl::MaybeSendFeefilter(CNode&amp;<sp/>pto,<sp/>Peer&amp;<sp/>peer,<sp/>std::chrono::microseconds<sp/>current_time)</highlight></codeline>
<codeline lineno="5395"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5396"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_opts.ignore_incoming_txs)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5397"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pto.<ref refid="class_c_node_1af039a299f31c62d63996fd5907c3f953" kindref="member">GetCommonVersion</ref>()<sp/>&lt;<sp/>FEEFILTER_VERSION)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5398"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>peers<sp/>with<sp/>the<sp/>forcerelay<sp/>permission<sp/>should<sp/>not<sp/>filter<sp/>txs<sp/>to<sp/>us</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5399"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pto.<ref refid="class_c_node_1ad093ef142d44eddf28162f2aa26d56c2" kindref="member">HasPermission</ref>(<ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a49d927322ecc171ed375b43da6c96b9c" kindref="member">NetPermissionFlags::ForceRelay</ref>))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5400"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Don&apos;t<sp/>send<sp/>feefilter<sp/>messages<sp/>to<sp/>outbound<sp/>block-relay-only<sp/>peers<sp/>since<sp/>they<sp/>should<sp/>never<sp/>announce</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5401"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>transactions<sp/>to<sp/>us,<sp/>regardless<sp/>of<sp/>feefilter<sp/>state.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5402"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pto.<ref refid="class_c_node_1a610ec1d1f02cc4bb029acc3cf47b9f4c" kindref="member">IsBlockOnlyConn</ref>())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5403"><highlight class="normal"></highlight></codeline>
<codeline lineno="5404"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/>currentFilter<sp/>=<sp/>m_mempool.<ref refid="class_c_tx_mem_pool_1a7afb20886dc0488c9f76578b16b4faad" kindref="member">GetMinFee</ref>().<ref refid="class_c_fee_rate_1ad9e8eebf71570868a82e7f7e63334ec2" kindref="member">GetFeePerK</ref>();</highlight></codeline>
<codeline lineno="5405"><highlight class="normal"></highlight></codeline>
<codeline lineno="5406"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.<ref refid="class_chainstate_manager_1a312bb1a2008bae3205f4699b90880d66" kindref="member">IsInitialBlockDownload</ref>())<sp/>{</highlight></codeline>
<codeline lineno="5407"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Received<sp/>tx-inv<sp/>messages<sp/>are<sp/>discarded<sp/>when<sp/>the<sp/>active</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5408"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>chainstate<sp/>is<sp/>in<sp/>IBD,<sp/>so<sp/>tell<sp/>the<sp/>peer<sp/>to<sp/>not<sp/>send<sp/>them.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5409"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>currentFilter<sp/>=<sp/>MAX_MONEY;</highlight></codeline>
<codeline lineno="5410"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/>MAX_FILTER{m_fee_filter_rounder.round(MAX_MONEY)};</highlight></codeline>
<codeline lineno="5412"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer.m_fee_filter_sent<sp/>==<sp/>MAX_FILTER)<sp/>{</highlight></codeline>
<codeline lineno="5413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Send<sp/>the<sp/>current<sp/>filter<sp/>if<sp/>we<sp/>sent<sp/>MAX_FILTER<sp/>previously</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5414"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>made<sp/>it<sp/>out<sp/>of<sp/>IBD.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_next_send_feefilter<sp/>=<sp/>0us;</highlight></codeline>
<codeline lineno="5416"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5417"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5418"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(current_time<sp/>&gt;<sp/>peer.m_next_send_feefilter)<sp/>{</highlight></codeline>
<codeline lineno="5419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="amount_8h_1a4eaf3a5239714d8c45b851527f7cb564" kindref="member">CAmount</ref><sp/>filterToSend<sp/>=<sp/>m_fee_filter_rounder.round(currentFilter);</highlight></codeline>
<codeline lineno="5420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>always<sp/>have<sp/>a<sp/>fee<sp/>filter<sp/>of<sp/>at<sp/>least<sp/>the<sp/>min<sp/>relay<sp/>fee</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5421"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>filterToSend<sp/>=<sp/>std::max(filterToSend,<sp/>m_mempool.<ref refid="class_c_tx_mem_pool_1a817fbbfe836e70934594dea772b4181b" kindref="member">m_opts</ref>.<ref refid="structkernel_1_1_mem_pool_options_1ad0f673994f163981d3b563b4e80b2d53" kindref="member">min_relay_feerate</ref>.<ref refid="class_c_fee_rate_1ad9e8eebf71570868a82e7f7e63334ec2" kindref="member">GetFeePerK</ref>());</highlight></codeline>
<codeline lineno="5422"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(filterToSend<sp/>!=<sp/>peer.m_fee_filter_sent)<sp/>{</highlight></codeline>
<codeline lineno="5423"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(pto,<sp/><ref refid="namespace_net_msg_type_1a685b5b6d3af7436779d0afbc8f695524" kindref="member">NetMsgType::FEEFILTER</ref>,<sp/>filterToSend);</highlight></codeline>
<codeline lineno="5424"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_fee_filter_sent<sp/>=<sp/>filterToSend;</highlight></codeline>
<codeline lineno="5425"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5426"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_next_send_feefilter<sp/>=<sp/>current_time<sp/>+<sp/>m_rng.rand_exp_duration(AVG_FEEFILTER_BROADCAST_INTERVAL);</highlight></codeline>
<codeline lineno="5427"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5428"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>fee<sp/>filter<sp/>has<sp/>changed<sp/>substantially<sp/>and<sp/>it&apos;s<sp/>still<sp/>more<sp/>than<sp/>MAX_FEEFILTER_CHANGE_DELAY</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5429"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>until<sp/>scheduled<sp/>broadcast,<sp/>then<sp/>move<sp/>the<sp/>broadcast<sp/>to<sp/>within<sp/>MAX_FEEFILTER_CHANGE_DELAY.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5430"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(current_time<sp/>+<sp/>MAX_FEEFILTER_CHANGE_DELAY<sp/>&lt;<sp/>peer.m_next_send_feefilter<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="5431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(currentFilter<sp/>&lt;<sp/>3<sp/>*<sp/>peer.m_fee_filter_sent<sp/>/<sp/>4<sp/>||<sp/>currentFilter<sp/>&gt;<sp/>4<sp/>*<sp/>peer.m_fee_filter_sent<sp/>/<sp/>3))<sp/>{</highlight></codeline>
<codeline lineno="5432"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_next_send_feefilter<sp/>=<sp/>current_time<sp/>+<sp/>m_rng.randrange&lt;std::chrono::microseconds&gt;(MAX_FEEFILTER_CHANGE_DELAY);</highlight></codeline>
<codeline lineno="5433"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5434"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5435"><highlight class="normal"></highlight></codeline>
<codeline lineno="5436"><highlight class="normal"></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="5437"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal">CompareInvMempoolOrder</highlight></codeline>
<codeline lineno="5438"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5439"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CTxMemPool*<sp/>m_mempool;</highlight></codeline>
<codeline lineno="5440"><highlight class="normal"></highlight><highlight class="keyword">public</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="5441"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">explicit</highlight><highlight class="normal"><sp/>CompareInvMempoolOrder(CTxMemPool*<sp/>mempool)<sp/>:<sp/>m_mempool{mempool}<sp/>{}</highlight></codeline>
<codeline lineno="5442"><highlight class="normal"></highlight></codeline>
<codeline lineno="5443"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>operator()(std::set&lt;Wtxid&gt;::iterator<sp/>a,<sp/>std::set&lt;Wtxid&gt;::iterator<sp/>b)</highlight></codeline>
<codeline lineno="5444"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="5445"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>As<sp/>std::make_heap<sp/>produces<sp/>a<sp/>max-heap,<sp/>we<sp/>want<sp/>the<sp/>entries<sp/>with<sp/>the</highlight></codeline>
<codeline lineno="5446"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*<sp/>higher<sp/>mining<sp/>score<sp/>to<sp/>sort<sp/>later.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5447"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>m_mempool-&gt;<ref refid="class_c_tx_mem_pool_1a47f736457eb0a52142718a8623e5c9d6" kindref="member">CompareMiningScoreWithTopology</ref>(*b,<sp/>*a);</highlight></codeline>
<codeline lineno="5448"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5449"><highlight class="normal">};</highlight></codeline>
<codeline lineno="5450"><highlight class="normal">}<sp/></highlight><highlight class="comment">//<sp/>namespace</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5451"><highlight class="normal"></highlight></codeline>
<codeline lineno="5452"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::RejectIncomingTxs(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CNode&amp;<sp/>peer)</highlight><highlight class="keyword"><sp/>const</highlight></codeline>
<codeline lineno="5453"><highlight class="keyword"></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="5454"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>block-relay-only<sp/>peers<sp/>may<sp/>never<sp/>send<sp/>txs<sp/>to<sp/>us</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5455"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer.<ref refid="class_c_node_1a610ec1d1f02cc4bb029acc3cf47b9f4c" kindref="member">IsBlockOnlyConn</ref>())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5456"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer.<ref refid="class_c_node_1aa2d55484d665a0e541f5dbadd40c8854" kindref="member">IsFeelerConn</ref>())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5457"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>In<sp/>-blocksonly<sp/>mode,<sp/>peers<sp/>need<sp/>the<sp/>&apos;relay&apos;<sp/>permission<sp/>to<sp/>send<sp/>txs<sp/>to<sp/>us</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5458"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_opts.ignore_incoming_txs<sp/>&amp;&amp;<sp/>!peer.<ref refid="class_c_node_1ad093ef142d44eddf28162f2aa26d56c2" kindref="member">HasPermission</ref>(<ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a34c4c50fc7bdd0394f3954f73f2be34d" kindref="member">NetPermissionFlags::Relay</ref>))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5459"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5460"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5461"><highlight class="normal"></highlight></codeline>
<codeline lineno="5462"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::SetupAddressRelay(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CNode&amp;<sp/>node,<sp/>Peer&amp;<sp/>peer)</highlight></codeline>
<codeline lineno="5463"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5464"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>don&apos;t<sp/>participate<sp/>in<sp/>addr<sp/>relay<sp/>with<sp/>outbound<sp/>block-relay-only</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5465"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>connections<sp/>to<sp/>prevent<sp/>providing<sp/>adversaries<sp/>with<sp/>the<sp/>additional</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5466"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>information<sp/>of<sp/>addr<sp/>traffic<sp/>to<sp/>infer<sp/>the<sp/>link.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5467"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(node.<ref refid="class_c_node_1a610ec1d1f02cc4bb029acc3cf47b9f4c" kindref="member">IsBlockOnlyConn</ref>())<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5468"><highlight class="normal"></highlight></codeline>
<codeline lineno="5469"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!peer.m_addr_relay_enabled.exchange(</highlight><highlight class="keyword">true</highlight><highlight class="normal">))<sp/>{</highlight></codeline>
<codeline lineno="5470"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>During<sp/>version<sp/>message<sp/>processing<sp/>(non-block-relay-only<sp/>outbound<sp/>peers)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5471"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>or<sp/>on<sp/>first<sp/>addr-related<sp/>message<sp/>we<sp/>have<sp/>received<sp/>(inbound<sp/>peers),<sp/>initialize</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5472"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>m_addr_known.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5473"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer.m_addr_known<sp/>=<sp/>std::make_unique&lt;CRollingBloomFilter&gt;(5000,<sp/>0.001);</highlight></codeline>
<codeline lineno="5474"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5475"><highlight class="normal"></highlight></codeline>
<codeline lineno="5476"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5477"><highlight class="normal">}</highlight></codeline>
<codeline lineno="5478"><highlight class="normal"></highlight></codeline>
<codeline lineno="5479"><highlight class="normal"></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>PeerManagerImpl::SendMessages(CNode*<sp/>pto)</highlight></codeline>
<codeline lineno="5480"><highlight class="normal">{</highlight></codeline>
<codeline lineno="5481"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a2bc429e4b3e667009b3aea3a6fab8e97" kindref="member">AssertLockNotHeld</ref>(m_tx_download_mutex);</highlight></codeline>
<codeline lineno="5482"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="sync_8h_1acd61d0cb3b49f367728193720014aed0" kindref="member">AssertLockHeld</ref>(g_msgproc_mutex);</highlight></codeline>
<codeline lineno="5483"><highlight class="normal"></highlight></codeline>
<codeline lineno="5484"><highlight class="normal"><sp/><sp/><sp/><sp/>PeerRef<sp/>peer<sp/>=<sp/>GetPeerRef(pto-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="5485"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!peer)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5486"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Consensus::Params&amp;<sp/>consensusParams<sp/>=<sp/>m_chainparams.<ref refid="class_c_chain_params_1ae77f209722ff1370ed18dc073d3d373f" kindref="member">GetConsensus</ref>();</highlight></codeline>
<codeline lineno="5487"><highlight class="normal"></highlight></codeline>
<codeline lineno="5488"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>must<sp/>call<sp/>MaybeDiscourageAndDisconnect<sp/>first,<sp/>to<sp/>ensure<sp/>that<sp/>we&apos;ll</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5489"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>disconnect<sp/>misbehaving<sp/>peers<sp/>even<sp/>before<sp/>the<sp/>version<sp/>handshake<sp/>is<sp/>complete.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5490"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(MaybeDiscourageAndDisconnect(*pto,<sp/>*peer))<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5491"><highlight class="normal"></highlight></codeline>
<codeline lineno="5492"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Initiate<sp/>version<sp/>handshake<sp/>for<sp/>outbound<sp/>connections</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5493"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pto-&gt;<ref refid="class_c_node_1a878e09eabda286e4cabf6ffc0fb24ba3" kindref="member">IsInboundConn</ref>()<sp/>&amp;&amp;<sp/>!peer-&gt;m_outbound_version_message_sent)<sp/>{</highlight></codeline>
<codeline lineno="5494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PushNodeVersion(*pto,<sp/>*peer);</highlight></codeline>
<codeline lineno="5495"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_outbound_version_message_sent<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5496"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5497"><highlight class="normal"></highlight></codeline>
<codeline lineno="5498"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Don&apos;t<sp/>send<sp/>anything<sp/>until<sp/>the<sp/>version<sp/>handshake<sp/>is<sp/>complete</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5499"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pto-&gt;<ref refid="class_c_node_1a304b58083dbf991d0f448962530c2e94" kindref="member">fSuccessfullyConnected</ref><sp/>||<sp/>pto-&gt;<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref>)</highlight></codeline>
<codeline lineno="5500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5501"><highlight class="normal"></highlight></codeline>
<codeline lineno="5502"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>current_time{<ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime&lt;std::chrono::microseconds&gt;</ref>()};</highlight></codeline>
<codeline lineno="5503"><highlight class="normal"></highlight></codeline>
<codeline lineno="5504"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pto-&gt;<ref refid="class_c_node_1a6f655d1fa96f652649182e914c75c7e3" kindref="member">IsAddrFetchConn</ref>()<sp/>&amp;&amp;<sp/>current_time<sp/>-<sp/>pto-&gt;<ref refid="class_c_node_1a9d5ec6f76c89a5fb4891fa5a22aa47b2" kindref="member">m_connected</ref><sp/>&gt;<sp/>10<sp/>*<sp/>AVG_ADDRESS_BROADCAST_INTERVAL)<sp/>{</highlight></codeline>
<codeline lineno="5505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;addrfetch<sp/>connection<sp/>timeout,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pto-&gt;<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="5506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pto-&gt;<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5508"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5509"><highlight class="normal"></highlight></codeline>
<codeline lineno="5510"><highlight class="normal"><sp/><sp/><sp/><sp/>MaybeSendPing(*pto,<sp/>*peer,<sp/>current_time);</highlight></codeline>
<codeline lineno="5511"><highlight class="normal"></highlight></codeline>
<codeline lineno="5512"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>MaybeSendPing<sp/>may<sp/>have<sp/>marked<sp/>peer<sp/>for<sp/>disconnection</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5513"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pto-&gt;<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref>)<sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5514"><highlight class="normal"></highlight></codeline>
<codeline lineno="5515"><highlight class="normal"><sp/><sp/><sp/><sp/>MaybeSendAddr(*pto,<sp/>*peer,<sp/>current_time);</highlight></codeline>
<codeline lineno="5516"><highlight class="normal"></highlight></codeline>
<codeline lineno="5517"><highlight class="normal"><sp/><sp/><sp/><sp/>MaybeSendSendHeaders(*pto,<sp/>*peer);</highlight></codeline>
<codeline lineno="5518"><highlight class="normal"></highlight></codeline>
<codeline lineno="5519"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="5520"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(<ref refid="cs__main_8cpp_1ab88a4b9173207cf250ece7820db1f36d" kindref="member">cs_main</ref>);</highlight></codeline>
<codeline lineno="5521"><highlight class="normal"></highlight></codeline>
<codeline lineno="5522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CNodeState<sp/>&amp;state<sp/>=<sp/>*<ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(pto-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="5523"><highlight class="normal"></highlight></codeline>
<codeline lineno="5524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Start<sp/>block<sp/>sync</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.m_best_header<sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="5526"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>m_chainman.m_best_header<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>();</highlight></codeline>
<codeline lineno="5527"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5528"><highlight class="normal"></highlight></codeline>
<codeline lineno="5529"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Determine<sp/>whether<sp/>we<sp/>might<sp/>try<sp/>initial<sp/>headers<sp/>sync<sp/>or<sp/>parallel</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5530"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>block<sp/>download<sp/>from<sp/>this<sp/>peer<sp/>--<sp/>this<sp/>mostly<sp/>affects<sp/>behavior<sp/>while</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5531"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>in<sp/>IBD<sp/>(once<sp/>out<sp/>of<sp/>IBD,<sp/>we<sp/>sync<sp/>from<sp/>all<sp/>peers).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5532"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>sync_blocks_and_headers_from_peer<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5533"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.fPreferredDownload)<sp/>{</highlight></codeline>
<codeline lineno="5534"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sync_blocks_and_headers_from_peer<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5535"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(CanServeBlocks(*peer)<sp/>&amp;&amp;<sp/>!pto-&gt;<ref refid="class_c_node_1a6f655d1fa96f652649182e914c75c7e3" kindref="member">IsAddrFetchConn</ref>())<sp/>{</highlight></codeline>
<codeline lineno="5536"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Typically<sp/>this<sp/>is<sp/>an<sp/>inbound<sp/>peer.<sp/>If<sp/>we<sp/>don&apos;t<sp/>have<sp/>any<sp/>outbound</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5537"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>peers,<sp/>or<sp/>if<sp/>we<sp/>aren&apos;t<sp/>downloading<sp/>any<sp/>blocks<sp/>from<sp/>such<sp/>peers,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5538"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>then<sp/>allow<sp/>block<sp/>downloads<sp/>from<sp/>this<sp/>peer,<sp/>too.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5539"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>prefer<sp/>downloading<sp/>blocks<sp/>from<sp/>outbound<sp/>peers<sp/>to<sp/>avoid</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5540"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>putting<sp/>undue<sp/>load<sp/>on<sp/>(say)<sp/>some<sp/>home<sp/>user<sp/>who<sp/>is<sp/>just<sp/>making</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5541"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>outbound<sp/>connections<sp/>to<sp/>the<sp/>network,<sp/>but<sp/>if<sp/>our<sp/>only<sp/>source<sp/>of</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5542"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>latest<sp/>blocks<sp/>is<sp/>from<sp/>an<sp/>inbound<sp/>peer,<sp/>we<sp/>have<sp/>to<sp/>be<sp/>sure<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5543"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>eventually<sp/>download<sp/>it<sp/>(and<sp/>not<sp/>just<sp/>wait<sp/>indefinitely<sp/>for<sp/>an</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5544"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>outbound<sp/>peer<sp/>to<sp/>have<sp/>it).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5545"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_num_preferred_download_peers<sp/>==<sp/>0<sp/>||<sp/>mapBlocksInFlight.empty())<sp/>{</highlight></codeline>
<codeline lineno="5546"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sync_blocks_and_headers_from_peer<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5547"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5548"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5549"><highlight class="normal"></highlight></codeline>
<codeline lineno="5550"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!state.fSyncStarted<sp/>&amp;&amp;<sp/>CanServeBlocks(*peer)<sp/>&amp;&amp;<sp/>!m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1acef48b2a0b8aa252efa69928192b4d5a" kindref="member">LoadingBlocks</ref>())<sp/>{</highlight></codeline>
<codeline lineno="5551"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Only<sp/>actively<sp/>request<sp/>headers<sp/>from<sp/>a<sp/>single<sp/>peer,<sp/>unless<sp/>we&apos;re<sp/>close<sp/>to<sp/>today.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5552"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((nSyncStarted<sp/>==<sp/>0<sp/>&amp;&amp;<sp/>sync_blocks_and_headers_from_peer)<sp/>||<sp/>m_chainman.m_best_header-&gt;Time()<sp/>&gt;<sp/><ref refid="struct_node_clock_1a1be2fa9903731211253f2e36b5f3b584" kindref="member">NodeClock::now</ref>()<sp/>-<sp/>24h)<sp/>{</highlight></codeline>
<codeline lineno="5553"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindexStart<sp/>=<sp/>m_chainman.m_best_header;</highlight></codeline>
<codeline lineno="5554"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>If<sp/>possible,<sp/>start<sp/>at<sp/>the<sp/>block<sp/>preceding<sp/>the<sp/>currently</highlight></codeline>
<codeline lineno="5555"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>best<sp/>known<sp/>header.<sp/><sp/>This<sp/>ensures<sp/>that<sp/>we<sp/>always<sp/>get<sp/>a</highlight></codeline>
<codeline lineno="5556"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>non-empty<sp/>list<sp/>of<sp/>headers<sp/>back<sp/>as<sp/>long<sp/>as<sp/>the<sp/>peer</highlight></codeline>
<codeline lineno="5557"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>is<sp/>up-to-date.<sp/><sp/>With<sp/>a<sp/>non-empty<sp/>response,<sp/>we<sp/>can<sp/>initialise</highlight></codeline>
<codeline lineno="5558"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>the<sp/>peer&apos;s<sp/>known<sp/>best<sp/>block.<sp/><sp/>This<sp/>wouldn&apos;t<sp/>be<sp/>possible</highlight></codeline>
<codeline lineno="5559"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>we<sp/>requested<sp/>starting<sp/>at<sp/>m_chainman.m_best_header<sp/>and</highlight></codeline>
<codeline lineno="5560"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>got<sp/>back<sp/>an<sp/>empty<sp/>response.<sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5561"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindexStart-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>)</highlight></codeline>
<codeline lineno="5562"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindexStart<sp/>=<sp/>pindexStart-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>;</highlight></codeline>
<codeline lineno="5563"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(MaybeSendGetHeaders(*pto,<sp/><ref refid="chain_8cpp_1a6f7cb8de33a43e97b3dd7517998379bc" kindref="member">GetLocator</ref>(pindexStart),<sp/>*peer))<sp/>{</highlight></codeline>
<codeline lineno="5564"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;initial<sp/>getheaders<sp/>(%d)<sp/>to<sp/>peer=%d<sp/>(startheight:%d)\n&quot;</highlight><highlight class="normal">,<sp/>pindexStart-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>pto-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>peer-&gt;m_starting_height);</highlight></codeline>
<codeline lineno="5565"><highlight class="normal"></highlight></codeline>
<codeline lineno="5566"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.fSyncStarted<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_headers_sync_timeout<sp/>=<sp/>current_time<sp/>+<sp/>HEADERS_DOWNLOAD_TIMEOUT_BASE<sp/>+</highlight></codeline>
<codeline lineno="5568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight></codeline>
<codeline lineno="5569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Convert<sp/>HEADERS_DOWNLOAD_TIMEOUT_PER_HEADER<sp/>to<sp/>microseconds<sp/>before<sp/>scaling</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5570"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>maintain<sp/>precision</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5571"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::chrono::microseconds{HEADERS_DOWNLOAD_TIMEOUT_PER_HEADER}<sp/>*</highlight></codeline>
<codeline lineno="5572"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="util_2time_8h_1ac04088c2a91199afcf20f9536bcbb60e" kindref="member">Ticks&lt;std::chrono::seconds&gt;</ref>(<ref refid="struct_node_clock_1a1be2fa9903731211253f2e36b5f3b584" kindref="member">NodeClock::now</ref>()<sp/>-<sp/>m_chainman.m_best_header-&gt;Time())<sp/>/<sp/>consensusParams.<ref refid="struct_consensus_1_1_params_1a096ffd2f2385b72c7bff4ba651f0bb51" kindref="member">nPowTargetSpacing</ref></highlight></codeline>
<codeline lineno="5573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="5574"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nSyncStarted++;</highlight></codeline>
<codeline lineno="5575"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5576"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5577"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5578"><highlight class="normal"></highlight></codeline>
<codeline lineno="5579"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5580"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Try<sp/>sending<sp/>block<sp/>announcements<sp/>via<sp/>headers</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5581"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5582"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="5583"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>we<sp/>have<sp/>no<sp/>more<sp/>than<sp/>MAX_BLOCKS_TO_ANNOUNCE<sp/>in<sp/>our</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5584"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>list<sp/>of<sp/>block<sp/>hashes<sp/>we&apos;re<sp/>relaying,<sp/>and<sp/>our<sp/>peer<sp/>wants</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5585"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>headers<sp/>announcements,<sp/>then<sp/>find<sp/>the<sp/>first<sp/>header</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5586"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>not<sp/>yet<sp/>known<sp/>to<sp/>our<sp/>peer<sp/>but<sp/>would<sp/>connect,<sp/>and<sp/>send.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5587"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>no<sp/>header<sp/>would<sp/>connect,<sp/>or<sp/>if<sp/>we<sp/>have<sp/>too<sp/>many</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5588"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>blocks,<sp/>or<sp/>if<sp/>the<sp/>peer<sp/>doesn&apos;t<sp/>want<sp/>headers,<sp/>just</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5589"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>add<sp/>all<sp/>to<sp/>the<sp/>inv<sp/>queue.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5590"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(peer-&gt;m_block_inv_mutex);</highlight></codeline>
<codeline lineno="5591"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CBlock&gt;<sp/>vHeaders;</highlight></codeline>
<codeline lineno="5592"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fRevertToInv<sp/>=<sp/>((!peer-&gt;m_prefers_headers<sp/>&amp;&amp;</highlight></codeline>
<codeline lineno="5593"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(!state.m_requested_hb_cmpctblocks<sp/>||<sp/>peer-&gt;m_blocks_for_headers_relay.size()<sp/>&gt;<sp/>1))<sp/>||</highlight></codeline>
<codeline lineno="5594"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_blocks_for_headers_relay.size()<sp/>&gt;<sp/>MAX_BLOCKS_TO_ANNOUNCE);</highlight></codeline>
<codeline lineno="5595"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex<sp/>*pBestIndex<sp/>=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>last<sp/>header<sp/>queued<sp/>for<sp/>delivery</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5596"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ProcessBlockAvailability(pto-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());<sp/></highlight><highlight class="comment">//<sp/>ensure<sp/>pindexBestKnownBlock<sp/>is<sp/>up-to-date</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5597"><highlight class="normal"></highlight></codeline>
<codeline lineno="5598"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!fRevertToInv)<sp/>{</highlight></codeline>
<codeline lineno="5599"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fFoundStartingHeader<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5600"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Try<sp/>to<sp/>find<sp/>first<sp/>header<sp/>that<sp/>our<sp/>peer<sp/>doesn&apos;t<sp/>have,<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5601"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>then<sp/>send<sp/>all<sp/>headers<sp/>past<sp/>that<sp/>one.<sp/><sp/>If<sp/>we<sp/>come<sp/>across<sp/>any</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5602"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>headers<sp/>that<sp/>aren&apos;t<sp/>on<sp/>m_chainman.ActiveChain(),<sp/>give<sp/>up.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5603"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256&amp;<sp/>hash<sp/>:<sp/>peer-&gt;m_blocks_for_headers_relay)<sp/>{</highlight></codeline>
<codeline lineno="5604"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindex<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1a87eab19fb1a7e025715c13377ebfd356" kindref="member">LookupBlockIndex</ref>(hash);</highlight></codeline>
<codeline lineno="5605"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindex);</highlight></codeline>
<codeline lineno="5606"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>()[pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>]<sp/>!=<sp/>pindex)<sp/>{</highlight></codeline>
<codeline lineno="5607"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Bail<sp/>out<sp/>if<sp/>we<sp/>reorged<sp/>away<sp/>from<sp/>this<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5608"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fRevertToInv<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5609"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5610"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5611"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pBestIndex<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>!=<sp/>pBestIndex)<sp/>{</highlight></codeline>
<codeline lineno="5612"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>means<sp/>that<sp/>the<sp/>list<sp/>of<sp/>blocks<sp/>to<sp/>announce<sp/>don&apos;t</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5613"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>connect<sp/>to<sp/>each<sp/>other.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5614"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>shouldn&apos;t<sp/>really<sp/>be<sp/>possible<sp/>to<sp/>hit<sp/>during</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5615"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>regular<sp/>operation<sp/>(because<sp/>reorgs<sp/>should<sp/>take<sp/>us<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5616"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>a<sp/>chain<sp/>that<sp/>has<sp/>some<sp/>block<sp/>not<sp/>on<sp/>the<sp/>prior<sp/>chain,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5617"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>which<sp/>should<sp/>be<sp/>caught<sp/>by<sp/>the<sp/>prior<sp/>check),<sp/>but<sp/>one</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5618"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>way<sp/>this<sp/>could<sp/>happen<sp/>is<sp/>by<sp/>using<sp/>invalidateblock<sp/>/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5619"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>reconsiderblock<sp/>repeatedly<sp/>on<sp/>the<sp/>tip,<sp/>causing<sp/>it<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5620"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>be<sp/>added<sp/>multiple<sp/>times<sp/>to<sp/>m_blocks_for_headers_relay.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5621"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Robustly<sp/>deal<sp/>with<sp/>this<sp/>rare<sp/>situation<sp/>by<sp/>reverting</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5622"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>an<sp/>inv.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5623"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fRevertToInv<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5624"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5625"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5626"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pBestIndex<sp/>=<sp/>pindex;</highlight></codeline>
<codeline lineno="5627"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fFoundStartingHeader)<sp/>{</highlight></codeline>
<codeline lineno="5628"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>add<sp/>this<sp/>to<sp/>the<sp/>headers<sp/>message</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5629"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vHeaders.emplace_back(pindex-&gt;<ref refid="class_c_block_index_1a86fb587abe1eaa7e77de95831c638140" kindref="member">GetBlockHeader</ref>());</highlight></codeline>
<codeline lineno="5630"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(PeerHasHeader(&amp;state,<sp/>pindex))<sp/>{</highlight></codeline>
<codeline lineno="5631"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;<sp/></highlight><highlight class="comment">//<sp/>keep<sp/>looking<sp/>for<sp/>the<sp/>first<sp/>new<sp/>block</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5632"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref><sp/>==<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal"><sp/>||<sp/>PeerHasHeader(&amp;state,<sp/>pindex-&gt;<ref refid="class_c_block_index_1a0265c1d3d6cc413eb1e964b045f3f538" kindref="member">pprev</ref>))<sp/>{</highlight></codeline>
<codeline lineno="5633"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Peer<sp/>doesn&apos;t<sp/>have<sp/>this<sp/>header<sp/>but<sp/>they<sp/>do<sp/>have<sp/>the<sp/>prior<sp/>one.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5634"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Start<sp/>sending<sp/>headers.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5635"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fFoundStartingHeader<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5636"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vHeaders.emplace_back(pindex-&gt;<ref refid="class_c_block_index_1a86fb587abe1eaa7e77de95831c638140" kindref="member">GetBlockHeader</ref>());</highlight></codeline>
<codeline lineno="5637"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5638"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Peer<sp/>doesn&apos;t<sp/>have<sp/>this<sp/>header<sp/>or<sp/>the<sp/>prior<sp/>one<sp/>--<sp/>nothing<sp/>will</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5639"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>connect,<sp/>so<sp/>bail<sp/>out.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5640"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fRevertToInv<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5641"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5642"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5643"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5644"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5645"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!fRevertToInv<sp/>&amp;&amp;<sp/>!vHeaders.empty())<sp/>{</highlight></codeline>
<codeline lineno="5646"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vHeaders.size()<sp/>==<sp/>1<sp/>&amp;&amp;<sp/>state.m_requested_hb_cmpctblocks)<sp/>{</highlight></codeline>
<codeline lineno="5647"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>only<sp/>send<sp/>up<sp/>to<sp/>1<sp/>block<sp/>as<sp/>header-and-ids,<sp/>as<sp/>otherwise</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5648"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>probably<sp/>means<sp/>we&apos;re<sp/>doing<sp/>an<sp/>initial-ish-sync<sp/>or<sp/>they&apos;re<sp/>slow</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5649"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s<sp/>sending<sp/>header-and-ids<sp/>%s<sp/>to<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>__func__,</highlight></codeline>
<codeline lineno="5650"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vHeaders.front().GetHash().ToString(),<sp/>pto-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="5651"><highlight class="normal"></highlight></codeline>
<codeline lineno="5652"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::optional&lt;CSerializedNetMsg&gt;<sp/>cached_cmpctblock_msg;</highlight></codeline>
<codeline lineno="5653"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="5654"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_most_recent_block_mutex);</highlight></codeline>
<codeline lineno="5655"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_most_recent_block_hash<sp/>==<sp/>pBestIndex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>())<sp/>{</highlight></codeline>
<codeline lineno="5656"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cached_cmpctblock_msg<sp/>=<sp/><ref refid="namespace_net_msg_1af64271506a941980bc0af944c721b637" kindref="member">NetMsg::Make</ref>(<ref refid="namespace_net_msg_type_1afb4658de55462fbfe264fc0f1ddb1d44" kindref="member">NetMsgType::CMPCTBLOCK</ref>,<sp/>*m_most_recent_compact_block);</highlight></codeline>
<codeline lineno="5657"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5658"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5659"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cached_cmpctblock_msg.has_value())<sp/>{</highlight></codeline>
<codeline lineno="5660"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>PushMessage(*pto,<sp/>std::move(cached_cmpctblock_msg.value()));</highlight></codeline>
<codeline lineno="5661"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5662"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlock<sp/>block;</highlight></codeline>
<codeline lineno="5663"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/><ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>{m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1ad59bbdccdaca9da495b6b6e80c481a1a" kindref="member">ReadBlock</ref>(block,<sp/>*pBestIndex)};</highlight></codeline>
<codeline lineno="5664"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(<ref refid="bitcoin-cli_8cpp_1a339672ff94e6199019102f50d317c3d7" kindref="member">ret</ref>);</highlight></codeline>
<codeline lineno="5665"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CBlockHeaderAndShortTxIDs<sp/>cmpctblock{block,<sp/>m_rng.rand64()};</highlight></codeline>
<codeline lineno="5666"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(*pto,<sp/><ref refid="namespace_net_msg_type_1afb4658de55462fbfe264fc0f1ddb1d44" kindref="member">NetMsgType::CMPCTBLOCK</ref>,<sp/>cmpctblock);</highlight></codeline>
<codeline lineno="5667"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5668"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.pindexBestHeaderSent<sp/>=<sp/>pBestIndex;</highlight></codeline>
<codeline lineno="5669"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(peer-&gt;m_prefers_headers)<sp/>{</highlight></codeline>
<codeline lineno="5670"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vHeaders.size()<sp/>&gt;<sp/>1)<sp/>{</highlight></codeline>
<codeline lineno="5671"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s:<sp/>%u<sp/>headers,<sp/>range<sp/>(%s,<sp/>%s),<sp/>to<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>__func__,</highlight></codeline>
<codeline lineno="5672"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vHeaders.size(),</highlight></codeline>
<codeline lineno="5673"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vHeaders.front().GetHash().ToString(),</highlight></codeline>
<codeline lineno="5674"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vHeaders.back().GetHash().ToString(),<sp/>pto-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="5675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5676"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s:<sp/>sending<sp/>header<sp/>%s<sp/>to<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>__func__,</highlight></codeline>
<codeline lineno="5677"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vHeaders.front().GetHash().ToString(),<sp/>pto-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="5678"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5679"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(*pto,<sp/><ref refid="namespace_net_msg_type_1a0348bf520b74bfee619eb6bacd40199b" kindref="member">NetMsgType::HEADERS</ref>,<sp/>TX_WITH_WITNESS(vHeaders));</highlight></codeline>
<codeline lineno="5680"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.pindexBestHeaderSent<sp/>=<sp/>pBestIndex;</highlight></codeline>
<codeline lineno="5681"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5682"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fRevertToInv<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5683"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5684"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fRevertToInv)<sp/>{</highlight></codeline>
<codeline lineno="5685"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>falling<sp/>back<sp/>to<sp/>using<sp/>an<sp/>inv,<sp/>just<sp/>try<sp/>to<sp/>inv<sp/>the<sp/>tip.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5686"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>The<sp/>last<sp/>entry<sp/>in<sp/>m_blocks_for_headers_relay<sp/>was<sp/>our<sp/>tip<sp/>at<sp/>some<sp/>point</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5687"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>in<sp/>the<sp/>past.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5688"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!peer-&gt;m_blocks_for_headers_relay.empty())<sp/>{</highlight></codeline>
<codeline lineno="5689"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256&amp;<sp/>hashToAnnounce<sp/>=<sp/>peer-&gt;m_blocks_for_headers_relay.back();</highlight></codeline>
<codeline lineno="5690"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>pindex<sp/>=<sp/>m_chainman.<ref refid="class_chainstate_manager_1a0ffb06ca51d81edfc4488da3aad6718e" kindref="member">m_blockman</ref>.<ref refid="classnode_1_1_block_manager_1a87eab19fb1a7e025715c13377ebfd356" kindref="member">LookupBlockIndex</ref>(hashToAnnounce);</highlight></codeline>
<codeline lineno="5691"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="validation_8cpp_1afb7ea74ba028421697aa7f364741ee6c" kindref="member">assert</ref>(pindex);</highlight></codeline>
<codeline lineno="5692"><highlight class="normal"></highlight></codeline>
<codeline lineno="5693"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Warn<sp/>if<sp/>we&apos;re<sp/>announcing<sp/>a<sp/>block<sp/>that<sp/>is<sp/>not<sp/>on<sp/>the<sp/>main<sp/>chain.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5694"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>This<sp/>should<sp/>be<sp/>very<sp/>rare<sp/>and<sp/>could<sp/>be<sp/>optimized<sp/>out.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5695"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Just<sp/>log<sp/>for<sp/>now.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5696"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>()[pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>]<sp/>!=<sp/>pindex)<sp/>{</highlight></codeline>
<codeline lineno="5697"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Announcing<sp/>block<sp/>%s<sp/>not<sp/>on<sp/>main<sp/>chain<sp/>(tip=%s)\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="5698"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hashToAnnounce.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>m_chainman.<ref refid="class_chainstate_manager_1a8090a09f21aff3aa747263ae6b8268c1" kindref="member">ActiveChain</ref>().<ref refid="class_c_chain_1a04d20312c7fa5b53ad977a09fc79ec52" kindref="member">Tip</ref>()-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="5699"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5700"><highlight class="normal"></highlight></codeline>
<codeline lineno="5701"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>peer&apos;s<sp/>chain<sp/>has<sp/>this<sp/>block,<sp/>don&apos;t<sp/>inv<sp/>it<sp/>back.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5702"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!PeerHasHeader(&amp;state,<sp/>pindex))<sp/>{</highlight></codeline>
<codeline lineno="5703"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_blocks_for_inv_relay.push_back(hashToAnnounce);</highlight></codeline>
<codeline lineno="5704"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;%s:<sp/>sending<sp/>inv<sp/>peer=%d<sp/>hash=%s\n&quot;</highlight><highlight class="normal">,<sp/>__func__,</highlight></codeline>
<codeline lineno="5705"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pto-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>hashToAnnounce.<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>());</highlight></codeline>
<codeline lineno="5706"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5707"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5708"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5709"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_blocks_for_headers_relay.clear();</highlight></codeline>
<codeline lineno="5710"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5711"><highlight class="normal"></highlight></codeline>
<codeline lineno="5712"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5713"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Message:<sp/>inventory</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5714"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5715"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CInv&gt;<sp/>vInv;</highlight></codeline>
<codeline lineno="5716"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="5717"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(peer-&gt;m_block_inv_mutex);</highlight></codeline>
<codeline lineno="5718"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vInv.reserve(std::max&lt;size_t&gt;(peer-&gt;m_blocks_for_inv_relay.size(),<sp/>INVENTORY_BROADCAST_TARGET));</highlight></codeline>
<codeline lineno="5719"><highlight class="normal"></highlight></codeline>
<codeline lineno="5720"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Add<sp/>blocks</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5721"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>uint256&amp;<sp/>hash<sp/>:<sp/>peer-&gt;m_blocks_for_inv_relay)<sp/>{</highlight></codeline>
<codeline lineno="5722"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vInv.emplace_back(<ref refid="protocol_8h_1ac1162efdf35b533ba996ac9d1c96fc05a4cae15fd207d555331995cd5c57689c1" kindref="member">MSG_BLOCK</ref>,<sp/>hash);</highlight></codeline>
<codeline lineno="5723"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vInv.size()<sp/>==<sp/>MAX_INV_SZ)<sp/>{</highlight></codeline>
<codeline lineno="5724"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(*pto,<sp/><ref refid="namespace_net_msg_type_1a74ff47f13e393d7fa01ca77282ae01f6" kindref="member">NetMsgType::INV</ref>,<sp/>vInv);</highlight></codeline>
<codeline lineno="5725"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vInv.clear();</highlight></codeline>
<codeline lineno="5726"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5727"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5728"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_blocks_for_inv_relay.clear();</highlight></codeline>
<codeline lineno="5729"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5730"><highlight class="normal"></highlight></codeline>
<codeline lineno="5731"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>tx_relay<sp/>=<sp/>peer-&gt;GetTxRelay();<sp/>tx_relay<sp/>!=<sp/></highlight><highlight class="keyword">nullptr</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="5732"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(tx_relay-&gt;m_tx_inventory_mutex);</highlight></codeline>
<codeline lineno="5733"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>whether<sp/>periodic<sp/>sends<sp/>should<sp/>happen</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5734"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>fSendTrickle<sp/>=<sp/>pto-&gt;<ref refid="class_c_node_1ad093ef142d44eddf28162f2aa26d56c2" kindref="member">HasPermission</ref>(<ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a12b80870cf3a64e605a95b9c521ac46f" kindref="member">NetPermissionFlags::NoBan</ref>);</highlight></codeline>
<codeline lineno="5735"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tx_relay-&gt;m_next_inv_send_time<sp/>&lt;<sp/>current_time)<sp/>{</highlight></codeline>
<codeline lineno="5736"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fSendTrickle<sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5737"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(pto-&gt;<ref refid="class_c_node_1a878e09eabda286e4cabf6ffc0fb24ba3" kindref="member">IsInboundConn</ref>())<sp/>{</highlight></codeline>
<codeline lineno="5738"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_relay-&gt;m_next_inv_send_time<sp/>=<sp/>NextInvToInbounds(current_time,<sp/>INBOUND_INVENTORY_BROADCAST_INTERVAL,<sp/>pto-&gt;<ref refid="class_c_node_1a1b2452796767909e463719c518ad6fe0" kindref="member">m_network_key</ref>);</highlight></codeline>
<codeline lineno="5739"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5740"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_relay-&gt;m_next_inv_send_time<sp/>=<sp/>current_time<sp/>+<sp/>m_rng.rand_exp_duration(OUTBOUND_INVENTORY_BROADCAST_INTERVAL);</highlight></codeline>
<codeline lineno="5741"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5742"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5743"><highlight class="normal"></highlight></codeline>
<codeline lineno="5744"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Time<sp/>to<sp/>send<sp/>but<sp/>the<sp/>peer<sp/>has<sp/>requested<sp/>we<sp/>not<sp/>relay<sp/>transactions.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5745"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fSendTrickle)<sp/>{</highlight></codeline>
<codeline lineno="5746"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(tx_relay-&gt;m_bloom_filter_mutex);</highlight></codeline>
<codeline lineno="5747"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tx_relay-&gt;m_relay_txs)<sp/>tx_relay-&gt;m_tx_inventory_to_send.clear();</highlight></codeline>
<codeline lineno="5748"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5749"><highlight class="normal"></highlight></codeline>
<codeline lineno="5750"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Respond<sp/>to<sp/>BIP35<sp/>mempool<sp/>requests</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5751"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fSendTrickle<sp/>&amp;&amp;<sp/>tx_relay-&gt;m_send_mempool)<sp/>{</highlight></codeline>
<codeline lineno="5752"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>vtxinfo<sp/>=<sp/>m_mempool.<ref refid="class_c_tx_mem_pool_1a86d9bb8441b9a708ae3fe2b5d468580f" kindref="member">infoAll</ref>();</highlight></codeline>
<codeline lineno="5753"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_relay-&gt;m_send_mempool<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5754"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CFeeRate<sp/>filterrate{tx_relay-&gt;m_fee_filter_received.load()};</highlight></codeline>
<codeline lineno="5755"><highlight class="normal"></highlight></codeline>
<codeline lineno="5756"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(tx_relay-&gt;m_bloom_filter_mutex);</highlight></codeline>
<codeline lineno="5757"><highlight class="normal"></highlight></codeline>
<codeline lineno="5758"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal">&amp;<sp/>txinfo<sp/>:<sp/>vtxinfo)<sp/>{</highlight></codeline>
<codeline lineno="5759"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="transaction__identifier_8h_1ac4bb3c35b94889843d632be4de4b223c" kindref="member">Txid</ref>&amp;<sp/>txid{txinfo.tx-&gt;GetHash()};</highlight></codeline>
<codeline lineno="5760"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="transaction__identifier_8h_1a23364c1312d4dffbbf549b4440333fd9" kindref="member">Wtxid</ref>&amp;<sp/>wtxid{txinfo.tx-&gt;GetWitnessHash()};</highlight></codeline>
<codeline lineno="5761"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>inv<sp/>=<sp/>peer-&gt;m_wtxid_relay<sp/>?</highlight></codeline>
<codeline lineno="5762"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CInv{<ref refid="protocol_8h_1ac1162efdf35b533ba996ac9d1c96fc05a1ff1717282df3ccaaa1bec2bf94dcd51" kindref="member">MSG_WTX</ref>,<sp/>wtxid.<ref refid="classtransaction__identifier_1a1cb411c7b8bb6c9024bc1a87b6d367ba" kindref="member">ToUint256</ref>()}<sp/>:</highlight></codeline>
<codeline lineno="5763"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CInv{<ref refid="protocol_8h_1ac1162efdf35b533ba996ac9d1c96fc05a0494732fc92c975f58783e224585c473" kindref="member">MSG_TX</ref>,<sp/>txid.<ref refid="classtransaction__identifier_1a1cb411c7b8bb6c9024bc1a87b6d367ba" kindref="member">ToUint256</ref>()};</highlight></codeline>
<codeline lineno="5764"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_relay-&gt;m_tx_inventory_to_send.erase(wtxid);</highlight></codeline>
<codeline lineno="5765"><highlight class="normal"></highlight></codeline>
<codeline lineno="5766"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Don&apos;t<sp/>send<sp/>transactions<sp/>that<sp/>peers<sp/>will<sp/>not<sp/>put<sp/>into<sp/>their<sp/>mempool</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5767"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(txinfo.fee<sp/>&lt;<sp/>filterrate.<ref refid="class_c_fee_rate_1a48858bde2b68fc9bd54f5ae34b45f371" kindref="member">GetFee</ref>(txinfo.vsize))<sp/>{</highlight></codeline>
<codeline lineno="5768"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5769"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5770"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tx_relay-&gt;m_bloom_filter)<sp/>{</highlight></codeline>
<codeline lineno="5771"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!tx_relay-&gt;m_bloom_filter-&gt;IsRelevantAndUpdate(*txinfo.tx))<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5772"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5773"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_relay-&gt;m_tx_inventory_known_filter.insert(inv.<ref refid="class_c_inv_1aa5db1ede9ecd9798d4549e62e5e19745" kindref="member">hash</ref>);</highlight></codeline>
<codeline lineno="5774"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vInv.push_back(inv);</highlight></codeline>
<codeline lineno="5775"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vInv.size()<sp/>==<sp/>MAX_INV_SZ)<sp/>{</highlight></codeline>
<codeline lineno="5776"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(*pto,<sp/><ref refid="namespace_net_msg_type_1a74ff47f13e393d7fa01ca77282ae01f6" kindref="member">NetMsgType::INV</ref>,<sp/>vInv);</highlight></codeline>
<codeline lineno="5777"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vInv.clear();</highlight></codeline>
<codeline lineno="5778"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5779"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5780"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5781"><highlight class="normal"></highlight></codeline>
<codeline lineno="5782"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Determine<sp/>transactions<sp/>to<sp/>relay</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5783"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(fSendTrickle)<sp/>{</highlight></codeline>
<codeline lineno="5784"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Produce<sp/>a<sp/>vector<sp/>with<sp/>all<sp/>candidates<sp/>for<sp/>sending</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5785"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;std::set&lt;Wtxid&gt;::iterator&gt;<sp/>vInvTx;</highlight></codeline>
<codeline lineno="5786"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vInvTx.reserve(tx_relay-&gt;m_tx_inventory_to_send.size());</highlight></codeline>
<codeline lineno="5787"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(std::set&lt;Wtxid&gt;::iterator<sp/>it<sp/>=<sp/>tx_relay-&gt;m_tx_inventory_to_send.begin();<sp/>it<sp/>!=<sp/>tx_relay-&gt;m_tx_inventory_to_send.end();<sp/>it++)<sp/>{</highlight></codeline>
<codeline lineno="5788"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vInvTx.push_back(it);</highlight></codeline>
<codeline lineno="5789"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5790"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CFeeRate<sp/>filterrate{tx_relay-&gt;m_fee_filter_received.load()};</highlight></codeline>
<codeline lineno="5791"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Topologically<sp/>and<sp/>fee-rate<sp/>sort<sp/>the<sp/>inventory<sp/>we<sp/>send<sp/>for<sp/>privacy<sp/>and<sp/>priority<sp/>reasons.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5792"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>A<sp/>heap<sp/>is<sp/>used<sp/>so<sp/>that<sp/>not<sp/>all<sp/>items<sp/>need<sp/>sorting<sp/>if<sp/>only<sp/>a<sp/>few<sp/>are<sp/>being<sp/>sent.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5793"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CompareInvMempoolOrder<sp/>compareInvMempoolOrder(&amp;m_mempool);</highlight></codeline>
<codeline lineno="5794"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::make_heap(vInvTx.begin(),<sp/>vInvTx.end(),<sp/>compareInvMempoolOrder);</highlight></codeline>
<codeline lineno="5795"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>No<sp/>reason<sp/>to<sp/>drain<sp/>out<sp/>at<sp/>many<sp/>times<sp/>the<sp/>network&apos;s<sp/>capacity,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5796"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>especially<sp/>since<sp/>we<sp/>have<sp/>many<sp/>peers<sp/>and<sp/>some<sp/>will<sp/>draw<sp/>much<sp/>shorter<sp/>delays.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5797"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nRelayedTransactions<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="5798"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(tx_relay-&gt;m_bloom_filter_mutex);</highlight></codeline>
<codeline lineno="5799"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>broadcast_max{INVENTORY_BROADCAST_TARGET<sp/>+<sp/>(tx_relay-&gt;m_tx_inventory_to_send.size()/1000)*5};</highlight></codeline>
<codeline lineno="5800"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>broadcast_max<sp/>=<sp/>std::min&lt;size_t&gt;(INVENTORY_BROADCAST_MAX,<sp/>broadcast_max);</highlight></codeline>
<codeline lineno="5801"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(!vInvTx.empty()<sp/>&amp;&amp;<sp/>nRelayedTransactions<sp/>&lt;<sp/>broadcast_max)<sp/>{</highlight></codeline>
<codeline lineno="5802"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Fetch<sp/>the<sp/>top<sp/>element<sp/>from<sp/>the<sp/>heap</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5803"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::pop_heap(vInvTx.begin(),<sp/>vInvTx.end(),<sp/>compareInvMempoolOrder);</highlight></codeline>
<codeline lineno="5804"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::set&lt;Wtxid&gt;::iterator<sp/>it<sp/>=<sp/>vInvTx.back();</highlight></codeline>
<codeline lineno="5805"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vInvTx.pop_back();</highlight></codeline>
<codeline lineno="5806"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>wtxid<sp/>=<sp/>*it;</highlight></codeline>
<codeline lineno="5807"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Remove<sp/>it<sp/>from<sp/>the<sp/>to-be-sent<sp/>set</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5808"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_relay-&gt;m_tx_inventory_to_send.erase(it);</highlight></codeline>
<codeline lineno="5809"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Not<sp/>in<sp/>the<sp/>mempool<sp/>anymore?<sp/>don&apos;t<sp/>bother<sp/>sending<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5810"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>txinfo<sp/>=<sp/>m_mempool.<ref refid="class_c_tx_mem_pool_1a004f3e09a902839ab270b91a254bfda9" kindref="member">info</ref>(wtxid);</highlight></codeline>
<codeline lineno="5811"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!txinfo.tx)<sp/>{</highlight></codeline>
<codeline lineno="5812"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5813"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5814"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>`TxRelay::m_tx_inventory_known_filter`<sp/>contains<sp/>either<sp/>txids<sp/>or<sp/>wtxids</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5815"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>depending<sp/>on<sp/>whether<sp/>our<sp/>peer<sp/>supports<sp/>wtxid-relay.<sp/>Therefore,<sp/>first</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5816"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>construct<sp/>the<sp/>inv<sp/>and<sp/>then<sp/>use<sp/>its<sp/>hash<sp/>for<sp/>the<sp/>filter<sp/>check.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5817"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>inv<sp/>=<sp/>peer-&gt;m_wtxid_relay<sp/>?</highlight></codeline>
<codeline lineno="5818"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CInv{<ref refid="protocol_8h_1ac1162efdf35b533ba996ac9d1c96fc05a1ff1717282df3ccaaa1bec2bf94dcd51" kindref="member">MSG_WTX</ref>,<sp/>wtxid.<ref refid="classtransaction__identifier_1a1cb411c7b8bb6c9024bc1a87b6d367ba" kindref="member">ToUint256</ref>()}<sp/>:</highlight></codeline>
<codeline lineno="5819"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CInv{<ref refid="protocol_8h_1ac1162efdf35b533ba996ac9d1c96fc05a0494732fc92c975f58783e224585c473" kindref="member">MSG_TX</ref>,<sp/>txinfo.tx-&gt;GetHash().ToUint256()};</highlight></codeline>
<codeline lineno="5820"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>if<sp/>not<sp/>in<sp/>the<sp/>filter<sp/>already</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5821"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tx_relay-&gt;m_tx_inventory_known_filter.contains(inv.<ref refid="class_c_inv_1aa5db1ede9ecd9798d4549e62e5e19745" kindref="member">hash</ref>))<sp/>{</highlight></codeline>
<codeline lineno="5822"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5823"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5824"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Peer<sp/>told<sp/>you<sp/>to<sp/>not<sp/>send<sp/>transactions<sp/>at<sp/>that<sp/>feerate?<sp/>Don&apos;t<sp/>bother<sp/>sending<sp/>it.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5825"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(txinfo.fee<sp/>&lt;<sp/>filterrate.<ref refid="class_c_fee_rate_1a48858bde2b68fc9bd54f5ae34b45f371" kindref="member">GetFee</ref>(txinfo.vsize))<sp/>{</highlight></codeline>
<codeline lineno="5826"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5827"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5828"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(tx_relay-&gt;m_bloom_filter<sp/>&amp;&amp;<sp/>!tx_relay-&gt;m_bloom_filter-&gt;IsRelevantAndUpdate(*txinfo.tx))<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5829"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Send</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5830"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vInv.push_back(inv);</highlight></codeline>
<codeline lineno="5831"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nRelayedTransactions++;</highlight></codeline>
<codeline lineno="5832"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vInv.size()<sp/>==<sp/>MAX_INV_SZ)<sp/>{</highlight></codeline>
<codeline lineno="5833"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(*pto,<sp/><ref refid="namespace_net_msg_type_1a74ff47f13e393d7fa01ca77282ae01f6" kindref="member">NetMsgType::INV</ref>,<sp/>vInv);</highlight></codeline>
<codeline lineno="5834"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vInv.clear();</highlight></codeline>
<codeline lineno="5835"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5836"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_relay-&gt;m_tx_inventory_known_filter.insert(inv.<ref refid="class_c_inv_1aa5db1ede9ecd9798d4549e62e5e19745" kindref="member">hash</ref>);</highlight></codeline>
<codeline lineno="5837"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5838"><highlight class="normal"></highlight></codeline>
<codeline lineno="5839"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Ensure<sp/>we&apos;ll<sp/>respond<sp/>to<sp/>GETDATA<sp/>requests<sp/>for<sp/>anything<sp/>we&apos;ve<sp/>just<sp/>announced</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5840"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_mempool.<ref refid="class_c_tx_mem_pool_1ab322659c2acf98d3bb6e877e69414281" kindref="member">cs</ref>);</highlight></codeline>
<codeline lineno="5841"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tx_relay-&gt;m_last_inv_sequence<sp/>=<sp/>m_mempool.<ref refid="class_c_tx_mem_pool_1a5c168b6f87d8b12617ed813ba79a0863" kindref="member">GetSequence</ref>();</highlight></codeline>
<codeline lineno="5842"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5843"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5844"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!vInv.empty())</highlight></codeline>
<codeline lineno="5845"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(*pto,<sp/><ref refid="namespace_net_msg_type_1a74ff47f13e393d7fa01ca77282ae01f6" kindref="member">NetMsgType::INV</ref>,<sp/>vInv);</highlight></codeline>
<codeline lineno="5846"><highlight class="normal"></highlight></codeline>
<codeline lineno="5847"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Detect<sp/>whether<sp/>we&apos;re<sp/>stalling</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5848"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>stalling_timeout<sp/>=<sp/>m_block_stalling_timeout.load();</highlight></codeline>
<codeline lineno="5849"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.m_stalling_since.count()<sp/>&amp;&amp;<sp/>state.m_stalling_since<sp/>&lt;<sp/>current_time<sp/>-<sp/>stalling_timeout)<sp/>{</highlight></codeline>
<codeline lineno="5850"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Stalling<sp/>only<sp/>triggers<sp/>when<sp/>the<sp/>block<sp/>download<sp/>window<sp/>cannot<sp/>move.<sp/>During<sp/>normal<sp/>steady<sp/>state,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5851"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>the<sp/>download<sp/>window<sp/>should<sp/>be<sp/>much<sp/>larger<sp/>than<sp/>the<sp/>to-be-downloaded<sp/>set<sp/>of<sp/>blocks,<sp/>so<sp/>disconnection</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5852"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>should<sp/>only<sp/>happen<sp/>during<sp/>initial<sp/>block<sp/>download.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5853"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Peer<sp/>is<sp/>stalling<sp/>block<sp/>download,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pto-&gt;<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="5854"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pto-&gt;<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5855"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Increase<sp/>timeout<sp/>for<sp/>the<sp/>next<sp/>peer<sp/>so<sp/>that<sp/>we<sp/>don&apos;t<sp/>disconnect<sp/>multiple<sp/>peers<sp/>if<sp/>our<sp/>own</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5856"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>bandwidth<sp/>is<sp/>insufficient.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5857"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>new_timeout<sp/>=<sp/>std::min(2<sp/>*<sp/>stalling_timeout,<sp/>BLOCK_STALLING_TIMEOUT_MAX);</highlight></codeline>
<codeline lineno="5858"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(stalling_timeout<sp/>!=<sp/>new_timeout<sp/>&amp;&amp;<sp/>m_block_stalling_timeout.compare_exchange_strong(stalling_timeout,<sp/>new_timeout))<sp/>{</highlight></codeline>
<codeline lineno="5859"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Increased<sp/>stalling<sp/>timeout<sp/>temporarily<sp/>to<sp/>%d<sp/>seconds\n&quot;</highlight><highlight class="normal">,<sp/><ref refid="util_2time_8h_1a888f421c54ec4d38a01dd0f7ddacd6a6" kindref="member">count_seconds</ref>(new_timeout));</highlight></codeline>
<codeline lineno="5860"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5861"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5862"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5863"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>In<sp/>case<sp/>there<sp/>is<sp/>a<sp/>block<sp/>that<sp/>has<sp/>been<sp/>in<sp/>flight<sp/>from<sp/>this<sp/>peer<sp/>for<sp/>block_interval<sp/>*<sp/>(1<sp/>+<sp/>0.5<sp/>*<sp/>N)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5864"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>(with<sp/>N<sp/>the<sp/>number<sp/>of<sp/>peers<sp/>from<sp/>which<sp/>we&apos;re<sp/>downloading<sp/>validated<sp/>blocks),<sp/>disconnect<sp/>due<sp/>to<sp/>timeout.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5865"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>We<sp/>compensate<sp/>for<sp/>other<sp/>peers<sp/>to<sp/>prevent<sp/>killing<sp/>off<sp/>peers<sp/>due<sp/>to<sp/>our<sp/>own<sp/>downstream<sp/>link</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5866"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>being<sp/>saturated.<sp/>We<sp/>only<sp/>count<sp/>validated<sp/>in-flight<sp/>blocks<sp/>so<sp/>peers<sp/>can&apos;t<sp/>advertise<sp/>non-existing<sp/>block<sp/>hashes</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5867"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>to<sp/>unreasonably<sp/>increase<sp/>our<sp/>timeout.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5868"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.vBlocksInFlight.size()<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="5869"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>QueuedBlock<sp/>&amp;queuedBlock<sp/>=<sp/>state.vBlocksInFlight.front();</highlight></codeline>
<codeline lineno="5870"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nOtherPeersWithValidatedDownloads<sp/>=<sp/>m_peers_downloading_from<sp/>-<sp/>1;</highlight></codeline>
<codeline lineno="5871"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(current_time<sp/>&gt;<sp/>state.m_downloading_since<sp/>+<sp/>std::chrono::seconds{consensusParams.nPowTargetSpacing}<sp/>*<sp/>(BLOCK_DOWNLOAD_TIMEOUT_BASE<sp/>+<sp/>BLOCK_DOWNLOAD_TIMEOUT_PER_PEER<sp/>*<sp/>nOtherPeersWithValidatedDownloads))<sp/>{</highlight></codeline>
<codeline lineno="5872"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Timeout<sp/>downloading<sp/>block<sp/>%s,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>queuedBlock.pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),<sp/>pto-&gt;<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="5873"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pto-&gt;<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5874"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5875"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5876"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5877"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>for<sp/>headers<sp/>sync<sp/>timeouts</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5878"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.fSyncStarted<sp/>&amp;&amp;<sp/>peer-&gt;m_headers_sync_timeout<sp/>&lt;<sp/>std::chrono::microseconds::max())<sp/>{</highlight></codeline>
<codeline lineno="5879"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Detect<sp/>whether<sp/>this<sp/>is<sp/>a<sp/>stalling<sp/>initial-headers-sync<sp/>peer</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5880"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(m_chainman.m_best_header-&gt;Time()<sp/>&lt;=<sp/><ref refid="struct_node_clock_1a1be2fa9903731211253f2e36b5f3b584" kindref="member">NodeClock::now</ref>()<sp/>-<sp/>24h)<sp/>{</highlight></codeline>
<codeline lineno="5881"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(current_time<sp/>&gt;<sp/>peer-&gt;m_headers_sync_timeout<sp/>&amp;&amp;<sp/>nSyncStarted<sp/>==<sp/>1<sp/>&amp;&amp;<sp/>(m_num_preferred_download_peers<sp/>-<sp/>state.fPreferredDownload<sp/>&gt;=<sp/>1))<sp/>{</highlight></codeline>
<codeline lineno="5882"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Disconnect<sp/>a<sp/>peer<sp/>(without<sp/>NetPermissionFlags::NoBan<sp/>permission)<sp/>if<sp/>it<sp/>is<sp/>our<sp/>only<sp/>sync<sp/>peer,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5883"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>and<sp/>we<sp/>have<sp/>others<sp/>we<sp/>could<sp/>be<sp/>using<sp/>instead.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5884"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note:<sp/>If<sp/>all<sp/>our<sp/>peers<sp/>are<sp/>inbound,<sp/>then<sp/>we<sp/>won&apos;t</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5885"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>disconnect<sp/>our<sp/>sync<sp/>peer<sp/>for<sp/>stalling;<sp/>we<sp/>have<sp/>bigger</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5886"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>problems<sp/>if<sp/>we<sp/>can&apos;t<sp/>get<sp/>any<sp/>outbound<sp/>peers.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5887"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!pto-&gt;<ref refid="class_c_node_1ad093ef142d44eddf28162f2aa26d56c2" kindref="member">HasPermission</ref>(<ref refid="net__permissions_8h_1ad287666c87723c65e44b221c62ef5ac0a12b80870cf3a64e605a95b9c521ac46f" kindref="member">NetPermissionFlags::NoBan</ref>))<sp/>{</highlight></codeline>
<codeline lineno="5888"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Timeout<sp/>downloading<sp/>headers,<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pto-&gt;<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="5889"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pto-&gt;<ref refid="class_c_node_1ac8452172979ad5823ab9e1372960789d" kindref="member">fDisconnect</ref><sp/>=<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5890"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5891"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5892"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1a57eb3ffc98e6ad1bdbed0a980a54c484" kindref="member">LogInfo</ref>(</highlight><highlight class="stringliteral">&quot;Timeout<sp/>downloading<sp/>headers<sp/>from<sp/>noban<sp/>peer,<sp/>not<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>pto-&gt;<ref refid="class_c_node_1a841208bbd46fc2f0667b580aa224b99e" kindref="member">DisconnectMsg</ref>(<ref refid="logging_8cpp_1a8e02420c2f7c53579ccb90acf301ae75" kindref="member">fLogIPs</ref>));</highlight></codeline>
<codeline lineno="5893"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Reset<sp/>the<sp/>headers<sp/>sync<sp/>state<sp/>so<sp/>that<sp/>we<sp/>have<sp/>a</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5894"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>chance<sp/>to<sp/>try<sp/>downloading<sp/>from<sp/>a<sp/>different<sp/>peer.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5895"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Note:<sp/>this<sp/>will<sp/>also<sp/>result<sp/>in<sp/>at<sp/>least<sp/>one<sp/>more</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5896"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>getheaders<sp/>message<sp/>to<sp/>be<sp/>sent<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5897"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>this<sp/>peer<sp/>(eventually).</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5898"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state.fSyncStarted<sp/>=<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5899"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nSyncStarted--;</highlight></codeline>
<codeline lineno="5900"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_headers_sync_timeout<sp/>=<sp/>0us;</highlight></codeline>
<codeline lineno="5901"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5902"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5903"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="5904"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>After<sp/>we&apos;ve<sp/>caught<sp/>up<sp/>once,<sp/>reset<sp/>the<sp/>timeout<sp/>so<sp/>we<sp/>can&apos;t<sp/>trigger</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5905"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>disconnect<sp/>later.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5906"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>peer-&gt;m_headers_sync_timeout<sp/>=<sp/>std::chrono::microseconds::max();</highlight></codeline>
<codeline lineno="5907"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5908"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5909"><highlight class="normal"></highlight></codeline>
<codeline lineno="5910"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Check<sp/>that<sp/>outbound<sp/>peers<sp/>have<sp/>reasonable<sp/>chains</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5911"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>GetTime()<sp/>is<sp/>used<sp/>by<sp/>this<sp/>anti-DoS<sp/>logic<sp/>so<sp/>we<sp/>can<sp/>test<sp/>this<sp/>using<sp/>mocktime</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5912"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ConsiderEviction(*pto,<sp/>*peer,<sp/><ref refid="util_2time_8cpp_1a46fac5fba8ba905b5f9acb364f5d8c6f" kindref="member">GetTime&lt;std::chrono::seconds&gt;</ref>());</highlight></codeline>
<codeline lineno="5913"><highlight class="normal"></highlight></codeline>
<codeline lineno="5914"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5915"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Message:<sp/>getdata<sp/>(blocks)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5916"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5917"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;CInv&gt;<sp/>vGetData;</highlight></codeline>
<codeline lineno="5918"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(CanServeBlocks(*peer)<sp/>&amp;&amp;<sp/>((sync_blocks_and_headers_from_peer<sp/>&amp;&amp;<sp/>!IsLimitedPeer(*peer))<sp/>||<sp/>!m_chainman.<ref refid="class_chainstate_manager_1a312bb1a2008bae3205f4699b90880d66" kindref="member">IsInitialBlockDownload</ref>())<sp/>&amp;&amp;<sp/>state.vBlocksInFlight.size()<sp/>&lt;<sp/>MAX_BLOCKS_IN_TRANSIT_PER_PEER)<sp/>{</highlight></codeline>
<codeline lineno="5919"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std::vector&lt;const<sp/>CBlockIndex*&gt;<sp/>vToDownload;</highlight></codeline>
<codeline lineno="5920"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="net_8h_1aa637b11e18b77724b35db2229cd12788" kindref="member">NodeId</ref><sp/>staller<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="5921"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>get_inflight_budget<sp/>=<sp/>[&amp;state]()<sp/>{</highlight></codeline>
<codeline lineno="5922"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>std::max(0,<sp/>MAX_BLOCKS_IN_TRANSIT_PER_PEER<sp/>-<sp/></highlight><highlight class="keyword">static_cast&lt;</highlight><highlight class="keywordtype">int</highlight><highlight class="keyword">&gt;</highlight><highlight class="normal">(state.vBlocksInFlight.size()));</highlight></codeline>
<codeline lineno="5923"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>};</highlight></codeline>
<codeline lineno="5924"><highlight class="normal"></highlight></codeline>
<codeline lineno="5925"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>there<sp/>are<sp/>multiple<sp/>chainstates,<sp/>download<sp/>blocks<sp/>for<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5926"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>current<sp/>chainstate<sp/>first,<sp/>to<sp/>prioritize<sp/>getting<sp/>to<sp/>network<sp/>tip</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5927"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>before<sp/>downloading<sp/>historical<sp/>blocks.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5928"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>FindNextBlocksToDownload(*peer,<sp/>get_inflight_budget(),<sp/>vToDownload,<sp/>staller);</highlight></codeline>
<codeline lineno="5929"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>historical_blocks{m_chainman.GetHistoricalBlockRange()};</highlight></codeline>
<codeline lineno="5930"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(historical_blocks<sp/>&amp;&amp;<sp/>!IsLimitedPeer(*peer))<sp/>{</highlight></codeline>
<codeline lineno="5931"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>If<sp/>the<sp/>first<sp/>needed<sp/>historical<sp/>block<sp/>is<sp/>not<sp/>an<sp/>ancestor<sp/>of<sp/>the<sp/>last,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5932"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>we<sp/>need<sp/>to<sp/>start<sp/>requesting<sp/>blocks<sp/>from<sp/>their<sp/>last<sp/>common<sp/>ancestor.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5933"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex*<sp/>from_tip<sp/>=<sp/><ref refid="chain_8cpp_1add771d649e0005eaf353c1d04626df91" kindref="member">LastCommonAncestor</ref>(historical_blocks-&gt;first,<sp/>historical_blocks-&gt;second);</highlight></codeline>
<codeline lineno="5934"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>TryDownloadingHistoricalBlocks(</highlight></codeline>
<codeline lineno="5935"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*peer,</highlight></codeline>
<codeline lineno="5936"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>get_inflight_budget(),</highlight></codeline>
<codeline lineno="5937"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vToDownload,<sp/>from_tip,<sp/>historical_blocks-&gt;second);</highlight></codeline>
<codeline lineno="5938"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5939"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>CBlockIndex<sp/>*pindex<sp/>:<sp/>vToDownload)<sp/>{</highlight></codeline>
<codeline lineno="5940"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>nFetchFlags<sp/>=<sp/>GetFetchFlags(*peer);</highlight></codeline>
<codeline lineno="5941"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vGetData.emplace_back(<ref refid="protocol_8h_1ac1162efdf35b533ba996ac9d1c96fc05a4cae15fd207d555331995cd5c57689c1" kindref="member">MSG_BLOCK</ref><sp/>|<sp/>nFetchFlags,<sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>());</highlight></codeline>
<codeline lineno="5942"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>BlockRequested(pto-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>*pindex);</highlight></codeline>
<codeline lineno="5943"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Requesting<sp/>block<sp/>%s<sp/>(%d)<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>pindex-&gt;<ref refid="class_c_block_index_1af6ec213819803936fd0806fb068965df" kindref="member">GetBlockHash</ref>().<ref refid="classbase__blob_1ab877381b343dbe2a2b32922da6951ed6" kindref="member">ToString</ref>(),</highlight></codeline>
<codeline lineno="5944"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pindex-&gt;<ref refid="class_c_block_index_1a17d981419afeee27eb36a8b43183e49a" kindref="member">nHeight</ref>,<sp/>pto-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>());</highlight></codeline>
<codeline lineno="5945"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5946"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(state.vBlocksInFlight.empty()<sp/>&amp;&amp;<sp/>staller<sp/>!=<sp/>-1)<sp/>{</highlight></codeline>
<codeline lineno="5947"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(<ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(staller)-&gt;m_stalling_since<sp/>==<sp/>0us)<sp/>{</highlight></codeline>
<codeline lineno="5948"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="headers__sync__chainwork__tests_8cpp_1ae883f65c4951396ab945f766e09e3c94" kindref="member">State</ref>(staller)-&gt;m_stalling_since<sp/>=<sp/>current_time;</highlight></codeline>
<codeline lineno="5949"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="logging_8h_1adeb58140a1c97947ad5d0c641415f1fc" kindref="member">LogDebug</ref>(<ref refid="namespace_b_c_log_1a2731eb4660a2a1b8dfab2a4f94ae7395a09c331e69591a2470471d457a17b413c" kindref="member">BCLog::NET</ref>,<sp/></highlight><highlight class="stringliteral">&quot;Stall<sp/>started<sp/>peer=%d\n&quot;</highlight><highlight class="normal">,<sp/>staller);</highlight></codeline>
<codeline lineno="5950"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5951"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5952"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5953"><highlight class="normal"></highlight></codeline>
<codeline lineno="5954"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5955"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Message:<sp/>getdata<sp/>(transactions)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5956"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5957"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="5958"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="sync_8h_1a911fe23f057c2fe5aad629162d6c99d0" kindref="member">LOCK</ref>(m_tx_download_mutex);</highlight></codeline>
<codeline lineno="5959"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>GenTxid&amp;<sp/>gtxid<sp/>:<sp/>m_txdownloadman.GetRequestsToSend(pto-&gt;<ref refid="class_c_node_1a36083c7e95cc6009bd88d120149ec42d" kindref="member">GetId</ref>(),<sp/>current_time))<sp/>{</highlight></codeline>
<codeline lineno="5960"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vGetData.emplace_back(gtxid.<ref refid="class_gen_txid_1a8b67580a1e0b88d28ab0709ab06a0921" kindref="member">IsWtxid</ref>()<sp/>?<sp/><ref refid="protocol_8h_1ac1162efdf35b533ba996ac9d1c96fc05a1ff1717282df3ccaaa1bec2bf94dcd51" kindref="member">MSG_WTX</ref><sp/>:<sp/>(<ref refid="protocol_8h_1ac1162efdf35b533ba996ac9d1c96fc05a0494732fc92c975f58783e224585c473" kindref="member">MSG_TX</ref><sp/>|<sp/>GetFetchFlags(*peer)),<sp/>gtxid.<ref refid="class_gen_txid_1a1cb411c7b8bb6c9024bc1a87b6d367ba" kindref="member">ToUint256</ref>());</highlight></codeline>
<codeline lineno="5961"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(vGetData.size()<sp/>&gt;=<sp/>MAX_GETDATA_SZ)<sp/>{</highlight></codeline>
<codeline lineno="5962"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(*pto,<sp/><ref refid="namespace_net_msg_type_1a18544277034744dbf6f85e748835ecfe" kindref="member">NetMsgType::GETDATA</ref>,<sp/>vGetData);</highlight></codeline>
<codeline lineno="5963"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>vGetData.clear();</highlight></codeline>
<codeline lineno="5964"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5965"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5966"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="5967"><highlight class="normal"></highlight></codeline>
<codeline lineno="5968"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!vGetData.empty())</highlight></codeline>
<codeline lineno="5969"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MakeAndPushMessage(*pto,<sp/><ref refid="namespace_net_msg_type_1a18544277034744dbf6f85e748835ecfe" kindref="member">NetMsgType::GETDATA</ref>,<sp/>vGetData);</highlight></codeline>
<codeline lineno="5970"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="comment">//<sp/>release<sp/>cs_main</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5971"><highlight class="normal"><sp/><sp/><sp/><sp/>MaybeSendFeefilter(*pto,<sp/>*peer,<sp/>current_time);</highlight></codeline>
<codeline lineno="5972"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="5973"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="src/net_processing.cpp"/>
  </compounddef>
</doxygen>
