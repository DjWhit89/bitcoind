\doxysection{src/policy/rbf.h File Reference}
\label{policy_2rbf_8h}\index{src/policy/rbf.h@{src/policy/rbf.h}}
{\ttfamily \#include $<$consensus/amount.\+h$>$}\newline
{\ttfamily \#include $<$primitives/transaction.\+h$>$}\newline
{\ttfamily \#include $<$threadsafety.\+h$>$}\newline
{\ttfamily \#include $<$txmempool.\+h$>$}\newline
{\ttfamily \#include $<$util/feefrac.\+h$>$}\newline
{\ttfamily \#include $<$compare$>$}\newline
{\ttfamily \#include $<$cstddef$>$}\newline
{\ttfamily \#include $<$cstdint$>$}\newline
{\ttfamily \#include $<$optional$>$}\newline
{\ttfamily \#include $<$set$>$}\newline
{\ttfamily \#include $<$string$>$}\newline
\doxysubsubsection*{Enumerations}
\begin{DoxyCompactItemize}
\item 
enum class \textbf{ RBFTransaction\+State} \{ \textbf{ UNKNOWN}
, \textbf{ REPLACEABLE\+\_\+\+BIP125}
, \textbf{ FINAL}
 \}
\item 
enum class \textbf{ Diagram\+Check\+Error} \{ \textbf{ UNCALCULABLE}
, \textbf{ FAILURE}
 \}
\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\textbf{ RBFTransaction\+State} \textbf{ Is\+RBFOpt\+In} (const \textbf{ CTransaction} \&tx, const \textbf{ CTx\+Mem\+Pool} \&pool) \textbf{ EXCLUSIVE\+\_\+\+LOCKS\+\_\+\+REQUIRED}(\textbf{ pool.\+cs})
\item 
\textbf{ RBFTransaction\+State} \textbf{ Is\+RBFOpt\+In\+Empty\+Mempool} (const \textbf{ CTransaction} \&tx)
\item 
std\+::optional$<$ std\+::string $>$ \textbf{ Get\+Entries\+For\+Conflicts} (const \textbf{ CTransaction} \&tx, \textbf{ CTx\+Mem\+Pool} \&pool, const \textbf{ CTx\+Mem\+Pool\+::set\+Entries} \&iters\+\_\+conflicting, \textbf{ CTx\+Mem\+Pool\+::set\+Entries} \&all\+\_\+conflicts) \textbf{ EXCLUSIVE\+\_\+\+LOCKS\+\_\+\+REQUIRED}(\textbf{ pool.\+cs})
\item 
std\+::optional$<$ std\+::string $>$ \textbf{ Entries\+And\+Txids\+Disjoint} (const \textbf{ CTx\+Mem\+Pool\+::set\+Entries} \&ancestors, const std\+::set$<$ \textbf{ Txid} $>$ \&direct\+\_\+conflicts, const \textbf{ Txid} \&txid)
\item 
std\+::optional$<$ std\+::string $>$ \textbf{ Pays\+For\+RBF} (\textbf{ CAmount} original\+\_\+fees, \textbf{ CAmount} replacement\+\_\+fees, size\+\_\+t replacement\+\_\+vsize, \textbf{ CFee\+Rate} relay\+\_\+fee, const \textbf{ Txid} \&txid)
\item 
std\+::optional$<$ std\+::pair$<$ \textbf{ Diagram\+Check\+Error}, std\+::string $>$ $>$ \textbf{ Improves\+Feerate\+Diagram} (\textbf{ CTx\+Mem\+Pool\+::\+Change\+Set} \&changeset)
\end{DoxyCompactItemize}


\label{doc-enum-members}
\doxysubsection{Enumeration Type Documentation}
\index{rbf.h@{rbf.h}!DiagramCheckError@{DiagramCheckError}}
\index{DiagramCheckError@{DiagramCheckError}!rbf.h@{rbf.h}}
\doxysubsubsection{DiagramCheckError}
{\footnotesize\ttfamily \label{policy_2rbf_8h_ae9597f9d7719b814f7f0e748048b20a0} 
enum class \textbf{ Diagram\+Check\+Error}\hspace{0.3cm}{\ttfamily [strong]}}

\begin{DoxyEnumFields}[2]{Enumerator}
\raisebox{\heightof{T}}[0pt][0pt]{\index{UNCALCULABLE@{UNCALCULABLE}!rbf.h@{rbf.h}}\index{rbf.h@{rbf.h}!UNCALCULABLE@{UNCALCULABLE}}}\label{policy_2rbf_8h_ae9597f9d7719b814f7f0e748048b20a0acae5fc662286af99f1148afad86eb54d} 
UNCALCULABLE&Unable to calculate due to topology or other reason \\
\hline

\raisebox{\heightof{T}}[0pt][0pt]{\index{FAILURE@{FAILURE}!rbf.h@{rbf.h}}\index{rbf.h@{rbf.h}!FAILURE@{FAILURE}}}\label{policy_2rbf_8h_ae9597f9d7719b814f7f0e748048b20a0a36fc6065a3e970bc3e6b2e59da52bf2a} 
FAILURE&New diagram wasn\textquotesingle{}t strictly superior \\
\hline

\end{DoxyEnumFields}
\index{rbf.h@{rbf.h}!RBFTransactionState@{RBFTransactionState}}
\index{RBFTransactionState@{RBFTransactionState}!rbf.h@{rbf.h}}
\doxysubsubsection{RBFTransactionState}
{\footnotesize\ttfamily \label{policy_2rbf_8h_a8a266cb2957aad5d08cc4c382ef6d32e} 
enum class \textbf{ RBFTransaction\+State}\hspace{0.3cm}{\ttfamily [strong]}}

The rbf state of unconfirmed transactions \begin{DoxyEnumFields}[2]{Enumerator}
\raisebox{\heightof{T}}[0pt][0pt]{\index{UNKNOWN@{UNKNOWN}!rbf.h@{rbf.h}}\index{rbf.h@{rbf.h}!UNKNOWN@{UNKNOWN}}}\label{policy_2rbf_8h_a8a266cb2957aad5d08cc4c382ef6d32ea696b031073e74bf2cb98e5ef201d4aa3} 
UNKNOWN&Unconfirmed tx that does not signal rbf and is not in the mempool \\
\hline

\raisebox{\heightof{T}}[0pt][0pt]{\index{REPLACEABLE\_BIP125@{REPLACEABLE\_BIP125}!rbf.h@{rbf.h}}\index{rbf.h@{rbf.h}!REPLACEABLE\_BIP125@{REPLACEABLE\_BIP125}}}\label{policy_2rbf_8h_a8a266cb2957aad5d08cc4c382ef6d32eaac738feff3a12c7dfab95461d55faf95} 
REPLACEABLE\+\_\+\+BIP125&Either this tx or a mempool ancestor signals rbf \\
\hline

\raisebox{\heightof{T}}[0pt][0pt]{\index{FINAL@{FINAL}!rbf.h@{rbf.h}}\index{rbf.h@{rbf.h}!FINAL@{FINAL}}}\label{policy_2rbf_8h_a8a266cb2957aad5d08cc4c382ef6d32ea6c8361dc2036c0559376fe4957699f69} 
FINAL&Neither this tx nor a mempool ancestor signals rbf \\
\hline

\end{DoxyEnumFields}


\label{doc-func-members}
\doxysubsection{Function Documentation}
\index{rbf.h@{rbf.h}!EntriesAndTxidsDisjoint@{EntriesAndTxidsDisjoint}}
\index{EntriesAndTxidsDisjoint@{EntriesAndTxidsDisjoint}!rbf.h@{rbf.h}}
\doxysubsubsection{EntriesAndTxidsDisjoint()}
{\footnotesize\ttfamily \label{policy_2rbf_8h_aefb8bb2b6c313b8f80c5dd8247c96460} 
std\+::optional$<$ std\+::string $>$ Entries\+And\+Txids\+Disjoint (\begin{DoxyParamCaption}\item[{const \textbf{ CTx\+Mem\+Pool\+::set\+Entries} \&}]{ancestors}{, }\item[{const std\+::set$<$ \textbf{ Txid} $>$ \&}]{direct\+\_\+conflicts}{, }\item[{const \textbf{ Txid} \&}]{txid}{}\end{DoxyParamCaption})}

Check the intersection between two sets of transactions (a set of mempool entries and a set of txids) to make sure they are disjoint. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{in}}  & {\em ancestors} & Set of mempool entries corresponding to ancestors of the replacement transactions. \\
\hline
\mbox{\texttt{in}}  & {\em direct\+\_\+conflicts} & Set of txids corresponding to the mempool conflicts (candidates to be replaced). \\
\hline
\mbox{\texttt{in}}  & {\em txid} & Transaction ID, included in the error message if violation occurs. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
error message if the sets intersect, std\+::nullopt if they are disjoint. 
\end{DoxyReturn}
\index{rbf.h@{rbf.h}!GetEntriesForConflicts@{GetEntriesForConflicts}}
\index{GetEntriesForConflicts@{GetEntriesForConflicts}!rbf.h@{rbf.h}}
\doxysubsubsection{GetEntriesForConflicts()}
{\footnotesize\ttfamily \label{policy_2rbf_8h_a27150b8633740dad3b39a7615bf697cd} 
std\+::optional$<$ std\+::string $>$ Get\+Entries\+For\+Conflicts (\begin{DoxyParamCaption}\item[{const \textbf{ CTransaction} \&}]{tx}{, }\item[{\textbf{ CTx\+Mem\+Pool} \&}]{pool}{, }\item[{const \textbf{ CTx\+Mem\+Pool\+::set\+Entries} \&}]{iters\+\_\+conflicting}{, }\item[{\textbf{ CTx\+Mem\+Pool\+::set\+Entries} \&}]{all\+\_\+conflicts}{}\end{DoxyParamCaption})}

Get all descendants of iters\+\_\+conflicting. Checks that there are no more than MAX\+\_\+\+REPLACEMENT\+\_\+\+CANDIDATES distinct clusters affected.


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{in}}  & {\em iters\+\_\+conflicting} & The set of iterators to mempool entries. \\
\hline
\mbox{\texttt{out}}  & {\em all\+\_\+conflicts} & Populated with all the mempool entries that would be replaced, which includes iters\+\_\+conflicting and all entries\textquotesingle{} descendants. Not cleared at the start; any existing mempool entries will remain in the set. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
an error message if the number of affected clusters would exceed MAX\+\_\+\+REPLACEMENT\+\_\+\+CANDIDATES, std\+::nullopt otherwise 
\end{DoxyReturn}
\index{rbf.h@{rbf.h}!ImprovesFeerateDiagram@{ImprovesFeerateDiagram}}
\index{ImprovesFeerateDiagram@{ImprovesFeerateDiagram}!rbf.h@{rbf.h}}
\doxysubsubsection{ImprovesFeerateDiagram()}
{\footnotesize\ttfamily \label{policy_2rbf_8h_a2d2f7e53b191b3f5423576a727b2f8e1} 
std\+::optional$<$ std\+::pair$<$ \textbf{ Diagram\+Check\+Error}, std\+::string $>$ $>$ Improves\+Feerate\+Diagram (\begin{DoxyParamCaption}\item[{\textbf{ CTx\+Mem\+Pool\+::\+Change\+Set} \&}]{changeset}{}\end{DoxyParamCaption})}

The replacement transaction must improve the feerate diagram of the mempool. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{in}}  & {\em changeset} & The changeset containing proposed additions/removals \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
error type and string if mempool diagram doesn\textquotesingle{}t improve, otherwise std\+::nullopt. 
\end{DoxyReturn}
\index{rbf.h@{rbf.h}!IsRBFOptIn@{IsRBFOptIn}}
\index{IsRBFOptIn@{IsRBFOptIn}!rbf.h@{rbf.h}}
\doxysubsubsection{IsRBFOptIn()}
{\footnotesize\ttfamily \label{policy_2rbf_8h_a25df898f04ad7966374a4c537e3bfe15} 
\textbf{ RBFTransaction\+State} Is\+RBFOpt\+In (\begin{DoxyParamCaption}\item[{const \textbf{ CTransaction} \&}]{tx}{, }\item[{const \textbf{ CTx\+Mem\+Pool} \&}]{pool}{}\end{DoxyParamCaption})}

Determine whether an unconfirmed transaction is signaling opt-\/in to RBF according to BIP 125 This involves checking sequence numbers of the transaction, as well as the sequence numbers of all in-\/mempool ancestors.


\begin{DoxyParams}{Parameters}
{\em tx} & The unconfirmed transaction \\
\hline
{\em pool} & The mempool, which may contain the tx\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The rbf state 
\end{DoxyReturn}
\index{rbf.h@{rbf.h}!IsRBFOptInEmptyMempool@{IsRBFOptInEmptyMempool}}
\index{IsRBFOptInEmptyMempool@{IsRBFOptInEmptyMempool}!rbf.h@{rbf.h}}
\doxysubsubsection{IsRBFOptInEmptyMempool()}
{\footnotesize\ttfamily \label{policy_2rbf_8h_a86fe76f7bbf47145e335d6ef05a55950} 
\textbf{ RBFTransaction\+State} Is\+RBFOpt\+In\+Empty\+Mempool (\begin{DoxyParamCaption}\item[{const \textbf{ CTransaction} \&}]{tx}{}\end{DoxyParamCaption})}

\index{rbf.h@{rbf.h}!PaysForRBF@{PaysForRBF}}
\index{PaysForRBF@{PaysForRBF}!rbf.h@{rbf.h}}
\doxysubsubsection{PaysForRBF()}
{\footnotesize\ttfamily \label{policy_2rbf_8h_a96e243683f646a5bc2a53eca61b4d1e9} 
std\+::optional$<$ std\+::string $>$ Pays\+For\+RBF (\begin{DoxyParamCaption}\item[{\textbf{ CAmount}}]{original\+\_\+fees}{, }\item[{\textbf{ CAmount}}]{replacement\+\_\+fees}{, }\item[{size\+\_\+t}]{replacement\+\_\+vsize}{, }\item[{\textbf{ CFee\+Rate}}]{relay\+\_\+fee}{, }\item[{const \textbf{ Txid} \&}]{txid}{}\end{DoxyParamCaption})}

The replacement transaction must pay more fees than the original transactions. The additional fees must pay for the replacement\textquotesingle{}s bandwidth at or above the incremental relay feerate. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{in}}  & {\em original\+\_\+fees} & Total modified fees of original transaction(s). \\
\hline
\mbox{\texttt{in}}  & {\em replacement\+\_\+fees} & Total modified fees of replacement transaction(s). \\
\hline
\mbox{\texttt{in}}  & {\em replacement\+\_\+vsize} & Total virtual size of replacement transaction(s). \\
\hline
\mbox{\texttt{in}}  & {\em relay\+\_\+fee} & The node\textquotesingle{}s minimum feerate for transaction relay. \\
\hline
\mbox{\texttt{in}}  & {\em txid} & Transaction ID, included in the error message if violation occurs. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
error string if fees are insufficient, otherwise std\+::nullopt. 
\end{DoxyReturn}
