\doxysection{log\+\_\+reader.\+h}
\label{log__reader_8h_source}\index{src/leveldb/db/log\_reader.h@{src/leveldb/db/log\_reader.h}}
\textbf{ Go to the documentation of this file.}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ Copyright\ (c)\ 2011\ The\ LevelDB\ Authors.\ All\ rights\ reserved.}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ Use\ of\ this\ source\ code\ is\ governed\ by\ a\ BSD-\/style\ license\ that\ can\ be}}
\DoxyCodeLine{00003\ \textcolor{comment}{//\ found\ in\ the\ LICENSE\ file.\ See\ the\ AUTHORS\ file\ for\ names\ of\ contributors.}}
\DoxyCodeLine{00004\ }
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#ifndef\ STORAGE\_LEVELDB\_DB\_LOG\_READER\_H\_}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#define\ STORAGE\_LEVELDB\_DB\_LOG\_READER\_H\_}}
\DoxyCodeLine{00007\ }
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ <stdint.h>}}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ "{}db/log\_format.h"{}}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ "{}leveldb/slice.h"{}}}
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#include\ "{}leveldb/status.h"{}}}
\DoxyCodeLine{00013\ }
\DoxyCodeLine{00014\ \textcolor{keyword}{namespace\ }leveldb\ \{}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{keyword}{class\ }SequentialFile;}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{keyword}{namespace\ }log\ \{}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{keyword}{class\ }Reader\ \{}
\DoxyCodeLine{00021\ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00022\ \ \ \textcolor{comment}{//\ Interface\ for\ reporting\ errors.}}
\DoxyCodeLine{00023\ \ \ \textcolor{keyword}{class\ }Reporter\ \{}
\DoxyCodeLine{00024\ \ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00025\ \ \ \ \ \textcolor{keyword}{virtual}\ \string~Reporter();}
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00027\ \ \ \ \ \textcolor{comment}{//\ Some\ corruption\ was\ detected.\ \ "{}size"{}\ is\ the\ approximate\ number}}
\DoxyCodeLine{00028\ \ \ \ \ \textcolor{comment}{//\ of\ bytes\ dropped\ due\ to\ the\ corruption.}}
\DoxyCodeLine{00029\ \ \ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{void}\ Corruption(\textcolor{keywordtype}{size\_t}\ bytes,\ \textcolor{keyword}{const}\ Status\&\ status)\ =\ 0;}
\DoxyCodeLine{00030\ \ \ \};}
\DoxyCodeLine{00031\ }
\DoxyCodeLine{00032\ \ \ \textcolor{comment}{//\ Create\ a\ reader\ that\ will\ return\ log\ records\ from\ "{}*file"{}.}}
\DoxyCodeLine{00033\ \ \ \textcolor{comment}{//\ "{}*file"{}\ must\ remain\ live\ while\ this\ Reader\ is\ in\ use.}}
\DoxyCodeLine{00034\ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00035\ \ \ \textcolor{comment}{//\ If\ "{}reporter"{}\ is\ non-\/null,\ it\ is\ notified\ whenever\ some\ data\ is}}
\DoxyCodeLine{00036\ \ \ \textcolor{comment}{//\ dropped\ due\ to\ a\ detected\ corruption.\ \ "{}*reporter"{}\ must\ remain}}
\DoxyCodeLine{00037\ \ \ \textcolor{comment}{//\ live\ while\ this\ Reader\ is\ in\ use.}}
\DoxyCodeLine{00038\ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00039\ \ \ \textcolor{comment}{//\ If\ "{}checksum"{}\ is\ true,\ verify\ checksums\ if\ available.}}
\DoxyCodeLine{00040\ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00041\ \ \ \textcolor{comment}{//\ The\ Reader\ will\ start\ reading\ at\ the\ first\ record\ located\ at\ physical}}
\DoxyCodeLine{00042\ \ \ \textcolor{comment}{//\ position\ >=\ initial\_offset\ within\ the\ file.}}
\DoxyCodeLine{00043\ \ \ Reader(SequentialFile*\ file,\ Reporter*\ reporter,\ \textcolor{keywordtype}{bool}\ checksum,}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \ uint64\_t\ initial\_offset);}
\DoxyCodeLine{00045\ }
\DoxyCodeLine{00046\ \ \ Reader(\textcolor{keyword}{const}\ Reader\&)\ =\ \textcolor{keyword}{delete};}
\DoxyCodeLine{00047\ \ \ Reader\&\ operator=(\textcolor{keyword}{const}\ Reader\&)\ =\ \textcolor{keyword}{delete};}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00049\ \ \ \string~Reader();}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00051\ \ \ \textcolor{comment}{//\ Read\ the\ next\ record\ into\ *record.\ \ Returns\ true\ if\ read}}
\DoxyCodeLine{00052\ \ \ \textcolor{comment}{//\ successfully,\ false\ if\ we\ hit\ end\ of\ the\ input.\ \ May\ use}}
\DoxyCodeLine{00053\ \ \ \textcolor{comment}{//\ "{}*scratch"{}\ as\ temporary\ storage.\ \ The\ contents\ filled\ in\ *record}}
\DoxyCodeLine{00054\ \ \ \textcolor{comment}{//\ will\ only\ be\ valid\ until\ the\ next\ mutating\ operation\ on\ this}}
\DoxyCodeLine{00055\ \ \ \textcolor{comment}{//\ reader\ or\ the\ next\ mutation\ to\ *scratch.}}
\DoxyCodeLine{00056\ \ \ \textcolor{keywordtype}{bool}\ ReadRecord(Slice*\ record,\ std::string*\ scratch);}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00058\ \ \ \textcolor{comment}{//\ Returns\ the\ physical\ offset\ of\ the\ last\ record\ returned\ by\ ReadRecord.}}
\DoxyCodeLine{00059\ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00060\ \ \ \textcolor{comment}{//\ Undefined\ before\ the\ first\ call\ to\ ReadRecord.}}
\DoxyCodeLine{00061\ \ \ uint64\_t\ LastRecordOffset();}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00063\ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00064\ \ \ \textcolor{comment}{//\ Extend\ record\ types\ with\ the\ following\ special\ values}}
\DoxyCodeLine{00065\ \ \ \textcolor{keyword}{enum}\ \{}
\DoxyCodeLine{00066\ \ \ \ \ kEof\ =\ kMaxRecordType\ +\ 1,}
\DoxyCodeLine{00067\ \ \ \ \ \textcolor{comment}{//\ Returned\ whenever\ we\ find\ an\ invalid\ physical\ record.}}
\DoxyCodeLine{00068\ \ \ \ \ \textcolor{comment}{//\ Currently\ there\ are\ three\ situations\ in\ which\ this\ happens:}}
\DoxyCodeLine{00069\ \ \ \ \ \textcolor{comment}{//\ *\ The\ record\ has\ an\ invalid\ CRC\ (ReadPhysicalRecord\ reports\ a\ drop)}}
\DoxyCodeLine{00070\ \ \ \ \ \textcolor{comment}{//\ *\ The\ record\ is\ a\ 0-\/length\ record\ (No\ drop\ is\ reported)}}
\DoxyCodeLine{00071\ \ \ \ \ \textcolor{comment}{//\ *\ The\ record\ is\ below\ constructor's\ initial\_offset\ (No\ drop\ is\ reported)}}
\DoxyCodeLine{00072\ \ \ \ \ kBadRecord\ =\ kMaxRecordType\ +\ 2}
\DoxyCodeLine{00073\ \ \ \};}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \textcolor{comment}{//\ Skips\ all\ blocks\ that\ are\ completely\ before\ "{}initial\_offset\_"{}.}}
\DoxyCodeLine{00076\ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00077\ \ \ \textcolor{comment}{//\ Returns\ true\ on\ success.\ Handles\ reporting.}}
\DoxyCodeLine{00078\ \ \ \textcolor{keywordtype}{bool}\ SkipToInitialBlock();}
\DoxyCodeLine{00079\ }
\DoxyCodeLine{00080\ \ \ \textcolor{comment}{//\ Return\ type,\ or\ one\ of\ the\ preceding\ special\ values}}
\DoxyCodeLine{00081\ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ ReadPhysicalRecord(Slice*\ result);}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00083\ \ \ \textcolor{comment}{//\ Reports\ dropped\ bytes\ to\ the\ reporter.}}
\DoxyCodeLine{00084\ \ \ \textcolor{comment}{//\ buffer\_\ must\ be\ updated\ to\ remove\ the\ dropped\ bytes\ prior\ to\ invocation.}}
\DoxyCodeLine{00085\ \ \ \textcolor{keywordtype}{void}\ ReportCorruption(uint64\_t\ bytes,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ reason);}
\DoxyCodeLine{00086\ \ \ \textcolor{keywordtype}{void}\ ReportDrop(uint64\_t\ bytes,\ \textcolor{keyword}{const}\ Status\&\ reason);}
\DoxyCodeLine{00087\ }
\DoxyCodeLine{00088\ \ \ SequentialFile*\ \textcolor{keyword}{const}\ file\_;}
\DoxyCodeLine{00089\ \ \ Reporter*\ \textcolor{keyword}{const}\ reporter\_;}
\DoxyCodeLine{00090\ \ \ \textcolor{keywordtype}{bool}\ \textcolor{keyword}{const}\ checksum\_;}
\DoxyCodeLine{00091\ \ \ \textcolor{keywordtype}{char}*\ \textcolor{keyword}{const}\ backing\_store\_;}
\DoxyCodeLine{00092\ \ \ Slice\ buffer\_;}
\DoxyCodeLine{00093\ \ \ \textcolor{keywordtype}{bool}\ eof\_;\ \ \textcolor{comment}{//\ Last\ Read()\ indicated\ EOF\ by\ returning\ <\ kBlockSize}}
\DoxyCodeLine{00094\ }
\DoxyCodeLine{00095\ \ \ \textcolor{comment}{//\ Offset\ of\ the\ last\ record\ returned\ by\ ReadRecord.}}
\DoxyCodeLine{00096\ \ \ uint64\_t\ last\_record\_offset\_;}
\DoxyCodeLine{00097\ \ \ \textcolor{comment}{//\ Offset\ of\ the\ first\ location\ past\ the\ end\ of\ buffer\_.}}
\DoxyCodeLine{00098\ \ \ uint64\_t\ end\_of\_buffer\_offset\_;}
\DoxyCodeLine{00099\ }
\DoxyCodeLine{00100\ \ \ \textcolor{comment}{//\ Offset\ at\ which\ to\ start\ looking\ for\ the\ first\ record\ to\ return}}
\DoxyCodeLine{00101\ \ \ uint64\_t\ \textcolor{keyword}{const}\ initial\_offset\_;}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00103\ \ \ \textcolor{comment}{//\ True\ if\ we\ are\ resynchronizing\ after\ a\ seek\ (initial\_offset\_\ >\ 0).\ In}}
\DoxyCodeLine{00104\ \ \ \textcolor{comment}{//\ particular,\ a\ run\ of\ kMiddleType\ and\ kLastType\ records\ can\ be\ silently}}
\DoxyCodeLine{00105\ \ \ \textcolor{comment}{//\ skipped\ in\ this\ mode}}
\DoxyCodeLine{00106\ \ \ \textcolor{keywordtype}{bool}\ resyncing\_;}
\DoxyCodeLine{00107\ \};}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00109\ \}\ \ \textcolor{comment}{//\ namespace\ log}}
\DoxyCodeLine{00110\ \}\ \ \textcolor{comment}{//\ namespace\ leveldb}}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00112\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ STORAGE\_LEVELDB\_DB\_LOG\_READER\_H\_}}

\end{DoxyCode}
