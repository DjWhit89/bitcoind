\doxysection{txdownloadman\+\_\+impl.\+h}
\label{txdownloadman__impl_8h_source}\index{src/node/txdownloadman\_impl.h@{src/node/txdownloadman\_impl.h}}
\textbf{ Go to the documentation of this file.}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ Copyright\ (c)\ 2024-\/present\ The\ Bitcoin\ Core\ developers}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ Distributed\ under\ the\ MIT\ software\ license,\ see\ the\ accompanying}}
\DoxyCodeLine{00003\ \textcolor{comment}{//\ file\ COPYING\ or\ http://www.opensource.org/licenses/mit-\/license.php.}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#ifndef\ BITCOIN\_NODE\_TXDOWNLOADMAN\_IMPL\_H}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#define\ BITCOIN\_NODE\_TXDOWNLOADMAN\_IMPL\_H}}
\DoxyCodeLine{00006\ }
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ <node/txdownloadman.h>}}
\DoxyCodeLine{00008\ }
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ <common/bloom.h>}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ <consensus/validation.h>}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ <kernel/chain.h>}}
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#include\ <net.h>}}
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#include\ <node/txorphanage.h>}}
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ <primitives/transaction.h>}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ <policy/packages.h>}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ <txrequest.h>}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{keyword}{class\ }CTxMemPool;}
\DoxyCodeLine{00019\ \textcolor{keyword}{namespace\ }node\ \{}
\DoxyCodeLine{00020\ \textcolor{keyword}{class\ }TxDownloadManagerImpl\ \{}
\DoxyCodeLine{00021\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00022\ \ \ \ \ TxDownloadOptions\ m\_opts;}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00025\ \ \ \ \ std::unique\_ptr<TxOrphanage>\ m\_orphanage;}
\DoxyCodeLine{00027\ \ \ \ \ TxRequestTracker\ m\_txrequest;}
\DoxyCodeLine{00028\ }
\DoxyCodeLine{00063\ \ \ \ \ std::unique\_ptr<CRollingBloomFilter>\ m\_lazy\_recent\_rejects\{\textcolor{keyword}{nullptr}\};}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00065\ \ \ \ \ CRollingBloomFilter\&\ RecentRejectsFilter()}
\DoxyCodeLine{00066\ \ \ \ \ \{}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!m\_lazy\_recent\_rejects)\ \{}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \ \ \ \ m\_lazy\_recent\_rejects\ =\ std::make\_unique<CRollingBloomFilter>(120'000,\ 0.000'001);}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00070\ }
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ *m\_lazy\_recent\_rejects;}
\DoxyCodeLine{00072\ \ \ \ \ \}}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00094\ \ \ \ \ std::unique\_ptr<CRollingBloomFilter>\ m\_lazy\_recent\_rejects\_reconsiderable\{\textcolor{keyword}{nullptr}\};}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ \ \ CRollingBloomFilter\&\ RecentRejectsReconsiderableFilter()}
\DoxyCodeLine{00097\ \ \ \ \ \{}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!m\_lazy\_recent\_rejects\_reconsiderable)\ \{}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ \ \ \ \ m\_lazy\_recent\_rejects\_reconsiderable\ =\ std::make\_unique<CRollingBloomFilter>(120'000,\ 0.000'001);}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00101\ }
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ *m\_lazy\_recent\_rejects\_reconsiderable;}
\DoxyCodeLine{00103\ \ \ \ \ \}}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00106\ \textcolor{comment}{\ \ \ \ \ *\ Filter\ for\ transactions\ that\ have\ been\ recently\ confirmed.}}
\DoxyCodeLine{00107\ \textcolor{comment}{\ \ \ \ \ *\ We\ use\ this\ to\ avoid\ requesting\ transactions\ that\ have\ already\ been}}
\DoxyCodeLine{00108\ \textcolor{comment}{\ \ \ \ \ *\ confirmed.}}
\DoxyCodeLine{00109\ \textcolor{comment}{\ \ \ \ \ *}}
\DoxyCodeLine{00110\ \textcolor{comment}{\ \ \ \ \ *\ Blocks\ don't\ typically\ have\ more\ than\ 4000\ transactions,\ so\ this\ should}}
\DoxyCodeLine{00111\ \textcolor{comment}{\ \ \ \ \ *\ be\ at\ least\ six\ blocks\ (\string~1\ hr)\ worth\ of\ transactions\ that\ we\ can\ store,}}
\DoxyCodeLine{00112\ \textcolor{comment}{\ \ \ \ \ *\ inserting\ both\ a\ txid\ and\ wtxid\ for\ every\ observed\ transaction.}}
\DoxyCodeLine{00113\ \textcolor{comment}{\ \ \ \ \ *\ If\ the\ number\ of\ transactions\ appearing\ in\ a\ block\ goes\ up,\ or\ if\ we\ are}}
\DoxyCodeLine{00114\ \textcolor{comment}{\ \ \ \ \ *\ seeing\ getdata\ requests\ more\ than\ an\ hour\ after\ initial\ announcement,\ we}}
\DoxyCodeLine{00115\ \textcolor{comment}{\ \ \ \ \ *\ can\ increase\ this\ number.}}
\DoxyCodeLine{00116\ \textcolor{comment}{\ \ \ \ \ *\ The\ false\ positive\ rate\ of\ 1/1M\ should\ come\ out\ to\ less\ than\ 1}}
\DoxyCodeLine{00117\ \textcolor{comment}{\ \ \ \ \ *\ transaction\ per\ day\ that\ would\ be\ inadvertently\ ignored\ (which\ is\ the}}
\DoxyCodeLine{00118\ \textcolor{comment}{\ \ \ \ \ *\ same\ probability\ that\ we\ have\ in\ the\ reject\ filter).}}
\DoxyCodeLine{00119\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{00120\ \ \ \ \ std::unique\_ptr<CRollingBloomFilter>\ m\_lazy\_recent\_confirmed\_transactions\{\textcolor{keyword}{nullptr}\};}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00122\ \ \ \ \ CRollingBloomFilter\&\ RecentConfirmedTransactionsFilter()}
\DoxyCodeLine{00123\ \ \ \ \ \{}
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!m\_lazy\_recent\_confirmed\_transactions)\ \{}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ \ \ \ \ m\_lazy\_recent\_confirmed\_transactions\ =\ std::make\_unique<CRollingBloomFilter>(48'000,\ 0.000'001);}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00127\ }
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ *m\_lazy\_recent\_confirmed\_transactions;}
\DoxyCodeLine{00129\ \ \ \ \ \}}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00131\ \ \ \ \ TxDownloadManagerImpl(\textcolor{keyword}{const}\ TxDownloadOptions\&\ options)\ :\ m\_opts\{options\},\ m\_orphanage\{MakeTxOrphanage()\},\ m\_txrequest\{options.m\_deterministic\_txrequest\}\ \{\}}
\DoxyCodeLine{00132\ }
\DoxyCodeLine{00133\ \ \ \ \ \textcolor{keyword}{struct\ }PeerInfo\ \{}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ TxDownloadConnectionInfo\ m\_connection\_info;}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00137\ \ \ \ \ \ \ \ \ PeerInfo(\textcolor{keyword}{const}\ TxDownloadConnectionInfo\&\ info)\ :\ m\_connection\_info\{info\}\ \{\}}
\DoxyCodeLine{00138\ \ \ \ \ \};}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00142\ \ \ \ \ std::map<NodeId,\ PeerInfo>\ m\_peer\_info;}
\DoxyCodeLine{00143\ }
\DoxyCodeLine{00145\ \ \ \ \ uint32\_t\ m\_num\_wtxid\_peers\{0\};}
\DoxyCodeLine{00146\ }
\DoxyCodeLine{00147\ \ \ \ \ \textcolor{keywordtype}{void}\ ActiveTipChange();}
\DoxyCodeLine{00148\ \ \ \ \ \textcolor{keywordtype}{void}\ BlockConnected(\textcolor{keyword}{const}\ std::shared\_ptr<const\ CBlock>\&\ pblock);}
\DoxyCodeLine{00149\ \ \ \ \ \textcolor{keywordtype}{void}\ BlockDisconnected();}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00158\ \ \ \ \ \textcolor{keywordtype}{bool}\ AlreadyHaveTx(\textcolor{keyword}{const}\ GenTxid\&\ gtxid,\ \textcolor{keywordtype}{bool}\ include\_reconsiderable);}
\DoxyCodeLine{00159\ }
\DoxyCodeLine{00160\ \ \ \ \ \textcolor{keywordtype}{void}\ ConnectedPeer(NodeId\ nodeid,\ \textcolor{keyword}{const}\ TxDownloadConnectionInfo\&\ info);}
\DoxyCodeLine{00161\ \ \ \ \ \textcolor{keywordtype}{void}\ DisconnectedPeer(NodeId\ nodeid);}
\DoxyCodeLine{00162\ }
\DoxyCodeLine{00166\ \ \ \ \ \textcolor{keywordtype}{bool}\ AddTxAnnouncement(NodeId\ peer,\ \textcolor{keyword}{const}\ GenTxid\&\ gtxid,\ std::chrono::microseconds\ now);}
\DoxyCodeLine{00167\ }
\DoxyCodeLine{00169\ \ \ \ \ std::vector<GenTxid>\ GetRequestsToSend(NodeId\ nodeid,\ std::chrono::microseconds\ current\_time);}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00172\ \ \ \ \ \textcolor{keywordtype}{void}\ ReceivedNotFound(NodeId\ nodeid,\ \textcolor{keyword}{const}\ std::vector<GenTxid>\&\ gtxids);}
\DoxyCodeLine{00173\ }
\DoxyCodeLine{00177\ \ \ \ \ std::optional<PackageToValidate>\ Find1P1CPackage(\textcolor{keyword}{const}\ CTransactionRef\&\ ptx,\ NodeId\ nodeid);}
\DoxyCodeLine{00178\ }
\DoxyCodeLine{00179\ \ \ \ \ \textcolor{keywordtype}{void}\ MempoolAcceptedTx(\textcolor{keyword}{const}\ CTransactionRef\&\ tx);}
\DoxyCodeLine{00180\ \ \ \ \ RejectedTxTodo\ MempoolRejectedTx(\textcolor{keyword}{const}\ CTransactionRef\&\ ptx,\ \textcolor{keyword}{const}\ TxValidationState\&\ state,\ NodeId\ nodeid,\ \textcolor{keywordtype}{bool}\ first\_time\_failure);}
\DoxyCodeLine{00181\ \ \ \ \ \textcolor{keywordtype}{void}\ MempoolRejectedPackage(\textcolor{keyword}{const}\ Package\&\ package);}
\DoxyCodeLine{00182\ }
\DoxyCodeLine{00183\ \ \ \ \ std::pair<bool,\ std::optional<PackageToValidate>>\ ReceivedTx(NodeId\ nodeid,\ \textcolor{keyword}{const}\ CTransactionRef\&\ ptx);}
\DoxyCodeLine{00184\ }
\DoxyCodeLine{00185\ \ \ \ \ \textcolor{keywordtype}{bool}\ HaveMoreWork(NodeId\ nodeid);}
\DoxyCodeLine{00186\ \ \ \ \ CTransactionRef\ GetTxToReconsider(NodeId\ nodeid);}
\DoxyCodeLine{00187\ }
\DoxyCodeLine{00188\ \ \ \ \ \textcolor{keywordtype}{void}\ CheckIsEmpty();}
\DoxyCodeLine{00189\ \ \ \ \ \textcolor{keywordtype}{void}\ CheckIsEmpty(NodeId\ nodeid);}
\DoxyCodeLine{00190\ }
\DoxyCodeLine{00191\ \ \ \ \ std::vector<TxOrphanage::OrphanInfo>\ GetOrphanTransactions()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00192\ }
\DoxyCodeLine{00193\ \textcolor{keyword}{protected}:}
\DoxyCodeLine{00195\ \ \ \ \ std::vector<Txid>\ GetUniqueParents(\textcolor{keyword}{const}\ CTransaction\&\ tx);}
\DoxyCodeLine{00196\ }
\DoxyCodeLine{00201\ \ \ \ \ \textcolor{keywordtype}{bool}\ MaybeAddOrphanResolutionCandidate(\textcolor{keyword}{const}\ std::vector<Txid>\&\ unique\_parents,\ \textcolor{keyword}{const}\ Wtxid\&\ wtxid,\ NodeId\ nodeid,\ std::chrono::microseconds\ now);}
\DoxyCodeLine{00202\ \};}
\DoxyCodeLine{00203\ \}\ \textcolor{comment}{//\ namespace\ node}}
\DoxyCodeLine{00204\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ BITCOIN\_NODE\_TXDOWNLOADMAN\_IMPL\_H}}

\end{DoxyCode}
