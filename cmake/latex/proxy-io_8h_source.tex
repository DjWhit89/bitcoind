\doxysection{proxy-\/io.h}
\label{proxy-io_8h_source}\index{src/ipc/libmultiprocess/include/mp/proxy-\/io.h@{src/ipc/libmultiprocess/include/mp/proxy-\/io.h}}
\textbf{ Go to the documentation of this file.}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ Copyright\ (c)\ The\ Bitcoin\ Core\ developers}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ Distributed\ under\ the\ MIT\ software\ license,\ see\ the\ accompanying}}
\DoxyCodeLine{00003\ \textcolor{comment}{//\ file\ COPYING\ or\ http://www.opensource.org/licenses/mit-\/license.php.}}
\DoxyCodeLine{00004\ }
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#ifndef\ MP\_PROXY\_IO\_H}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#define\ MP\_PROXY\_IO\_H}}
\DoxyCodeLine{00007\ }
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ <mp/proxy.h>}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ <mp/util.h>}}
\DoxyCodeLine{00010\ }
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ <mp/proxy.capnp.h>}}
\DoxyCodeLine{00012\ }
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#include\ <capnp/rpc-\/twoparty.h>}}
\DoxyCodeLine{00014\ }
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ <assert.h>}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ <condition\_variable>}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ <functional>}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ <kj/function.h>}}
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#include\ <map>}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ <memory>}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ <optional>}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ <sstream>}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ <string>}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ <thread>}}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00026\ \textcolor{keyword}{namespace\ }mp\ \{}
\DoxyCodeLine{00027\ \textcolor{keyword}{struct\ }ThreadContext;}
\DoxyCodeLine{00028\ }
\DoxyCodeLine{00029\ \textcolor{keyword}{struct\ }InvokeContext}
\DoxyCodeLine{00030\ \{}
\DoxyCodeLine{00031\ \ \ \ \ Connection\&\ connection;}
\DoxyCodeLine{00032\ \};}
\DoxyCodeLine{00033\ }
\DoxyCodeLine{00034\ \textcolor{keyword}{struct\ }ClientInvokeContext\ :\ InvokeContext}
\DoxyCodeLine{00035\ \{}
\DoxyCodeLine{00036\ \ \ \ \ ThreadContext\&\ thread\_context;}
\DoxyCodeLine{00037\ \ \ \ \ ClientInvokeContext(Connection\&\ conn,\ ThreadContext\&\ thread\_context)}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ :\ InvokeContext\{conn\},\ thread\_context\{thread\_context\}}
\DoxyCodeLine{00039\ \ \ \ \ \{}
\DoxyCodeLine{00040\ \ \ \ \ \}}
\DoxyCodeLine{00041\ \};}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ ProxyServer,\ \textcolor{keyword}{typename}\ CallContext\_>}
\DoxyCodeLine{00044\ \textcolor{keyword}{struct\ }ServerInvokeContext\ :\ InvokeContext}
\DoxyCodeLine{00045\ \{}
\DoxyCodeLine{00046\ \ \ \ \ \textcolor{keyword}{using\ }CallContext\ =\ CallContext\_;}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \ \ \ \ ProxyServer\&\ proxy\_server;}
\DoxyCodeLine{00049\ \ \ \ \ CallContext\&\ call\_context;}
\DoxyCodeLine{00050\ \ \ \ \ \textcolor{keywordtype}{int}\ req;}
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00052\ \ \ \ \ ServerInvokeContext(ProxyServer\&\ proxy\_server,\ CallContext\&\ call\_context,\ \textcolor{keywordtype}{int}\ req)}
\DoxyCodeLine{00053\ \ \ \ \ \ \ \ \ :\ InvokeContext\{*proxy\_server.m\_context.connection\},\ proxy\_server\{proxy\_server\},\ call\_context\{call\_context\},\ req\{req\}}
\DoxyCodeLine{00054\ \ \ \ \ \{}
\DoxyCodeLine{00055\ \ \ \ \ \}}
\DoxyCodeLine{00056\ \};}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00058\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Interface,\ \textcolor{keyword}{typename}\ Params,\ \textcolor{keyword}{typename}\ Results>}
\DoxyCodeLine{00059\ \textcolor{keyword}{using\ }ServerContext\ =\ ServerInvokeContext<ProxyServer<Interface>,\ ::capnp::CallContext<Params,\ Results>>;}
\DoxyCodeLine{00060\ }
\DoxyCodeLine{00061\ \textcolor{keyword}{template}\ <>}
\DoxyCodeLine{00062\ \textcolor{keyword}{struct\ }ProxyClient<Thread>\ :\ \textcolor{keyword}{public}\ ProxyClientBase<Thread,\ ::capnp::Void>}
\DoxyCodeLine{00063\ \{}
\DoxyCodeLine{00064\ \ \ \ \ \textcolor{keyword}{using\ }ProxyClientBase::ProxyClientBase;}
\DoxyCodeLine{00065\ \ \ \ \ \textcolor{comment}{//\ https://stackoverflow.com/questions/22357887/comparing-\/two-\/mapiterators-\/why-\/does-\/it-\/need-\/the-\/copy-\/constructor-\/of-\/stdpair}}
\DoxyCodeLine{00066\ \ \ \ \ ProxyClient(\textcolor{keyword}{const}\ ProxyClient\&)\ =\ \textcolor{keyword}{delete};}
\DoxyCodeLine{00067\ \ \ \ \ \string~ProxyClient();}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00078\ \ \ \ \ std::optional<CleanupIt>\ m\_disconnect\_cb;}
\DoxyCodeLine{00079\ \};}
\DoxyCodeLine{00080\ }
\DoxyCodeLine{00081\ \textcolor{keyword}{template}\ <>}
\DoxyCodeLine{00082\ \textcolor{keyword}{struct\ }ProxyServer<Thread>\ final\ :\ \textcolor{keyword}{public}\ Thread::Server}
\DoxyCodeLine{00083\ \{}
\DoxyCodeLine{00084\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00085\ \ \ \ \ ProxyServer(ThreadContext\&\ thread\_context,\ std::thread\&\&\ thread);}
\DoxyCodeLine{00086\ \ \ \ \ \string~ProxyServer();}
\DoxyCodeLine{00087\ \ \ \ \ kj::Promise<void>\ getName(GetNameContext\ context)\ \textcolor{keyword}{override};}
\DoxyCodeLine{00088\ \ \ \ \ ThreadContext\&\ m\_thread\_context;}
\DoxyCodeLine{00089\ \ \ \ \ std::thread\ m\_thread;}
\DoxyCodeLine{00090\ \};}
\DoxyCodeLine{00091\ }
\DoxyCodeLine{00093\ \textcolor{keyword}{class\ }LoggingErrorHandler\ :\ \textcolor{keyword}{public}\ kj::TaskSet::ErrorHandler}
\DoxyCodeLine{00094\ \{}
\DoxyCodeLine{00095\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00096\ \ \ \ \ LoggingErrorHandler(EventLoop\&\ loop)\ :\ m\_loop(loop)\ \{\}}
\DoxyCodeLine{00097\ \ \ \ \ \textcolor{keywordtype}{void}\ taskFailed(kj::Exception\&\&\ exception)\ \textcolor{keyword}{override};}
\DoxyCodeLine{00098\ \ \ \ \ EventLoop\&\ m\_loop;}
\DoxyCodeLine{00099\ \};}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00102\ \textcolor{keyword}{enum\ class}\ Log\ \{}
\DoxyCodeLine{00103\ \ \ \ \ Trace\ =\ 0,}
\DoxyCodeLine{00104\ \ \ \ \ Debug,}
\DoxyCodeLine{00105\ \ \ \ \ Info,}
\DoxyCodeLine{00106\ \ \ \ \ Warning,}
\DoxyCodeLine{00107\ \ \ \ \ Error,}
\DoxyCodeLine{00108\ \ \ \ \ Raise,}
\DoxyCodeLine{00109\ \};}
\DoxyCodeLine{00110\ }
\DoxyCodeLine{00111\ kj::StringPtr\ KJ\_STRINGIFY(Log\ flags);}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00113\ \textcolor{keyword}{struct\ }LogMessage\ \{}
\DoxyCodeLine{00114\ }
\DoxyCodeLine{00116\ \ \ \ \ std::string\ message;}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00119\ \ \ \ \ Log\ level;}
\DoxyCodeLine{00120\ \};}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00122\ \textcolor{keyword}{using\ }LogFn\ =\ std::function<void(LogMessage)>;}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00124\ \textcolor{keyword}{struct\ }LogOptions\ \{}
\DoxyCodeLine{00125\ }
\DoxyCodeLine{00127\ \ \ \ \ LogFn\ log\_fn;}
\DoxyCodeLine{00128\ }
\DoxyCodeLine{00131\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ max\_chars\{200\};}
\DoxyCodeLine{00132\ }
\DoxyCodeLine{00135\ \ \ \ \ Log\ log\_level\{Log::Trace\};}
\DoxyCodeLine{00136\ \};}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ \textcolor{keyword}{class\ }Logger}
\DoxyCodeLine{00139\ \{}
\DoxyCodeLine{00140\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00141\ \ \ \ \ Logger(\textcolor{keyword}{const}\ LogOptions\&\ options,\ Log\ log\_level)\ :\ m\_options(options),\ m\_log\_level(log\_level)\ \{\}}
\DoxyCodeLine{00142\ }
\DoxyCodeLine{00143\ \ \ \ \ Logger(Logger\&\&)\ =\ \textcolor{keyword}{delete};}
\DoxyCodeLine{00144\ \ \ \ \ Logger\&\ operator=(Logger\&\&)\ =\ \textcolor{keyword}{delete};}
\DoxyCodeLine{00145\ \ \ \ \ Logger(\textcolor{keyword}{const}\ Logger\&)\ =\ \textcolor{keyword}{delete};}
\DoxyCodeLine{00146\ \ \ \ \ Logger\&\ operator=(\textcolor{keyword}{const}\ Logger\&)\ =\ \textcolor{keyword}{delete};}
\DoxyCodeLine{00147\ }
\DoxyCodeLine{00148\ \ \ \ \ \string~Logger()\ noexcept(false)}
\DoxyCodeLine{00149\ \ \ \ \ \{}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (enabled())\ m\_options.log\_fn(\{std::move(m\_buffer).str(),\ m\_log\_level\});}
\DoxyCodeLine{00151\ \ \ \ \ \}}
\DoxyCodeLine{00152\ }
\DoxyCodeLine{00153\ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00154\ \ \ \ \ \textcolor{keyword}{friend}\ Logger\&\ operator<<(Logger\&\ logger,\ T\&\&\ value)}
\DoxyCodeLine{00155\ \ \ \ \ \{}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (logger.enabled())\ logger.m\_buffer\ <<\ std::forward<T>(value);}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ logger;}
\DoxyCodeLine{00158\ \ \ \ \ \}}
\DoxyCodeLine{00159\ }
\DoxyCodeLine{00160\ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00161\ \ \ \ \ \textcolor{keyword}{friend}\ Logger\&\ operator<<(Logger\&\&\ logger,\ T\&\&\ value)}
\DoxyCodeLine{00162\ \ \ \ \ \{}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ logger\ <<\ std::forward<T>(value);}
\DoxyCodeLine{00164\ \ \ \ \ \}}
\DoxyCodeLine{00165\ }
\DoxyCodeLine{00166\ \ \ \ \ \textcolor{keyword}{explicit}\ \textcolor{keyword}{operator}\ bool()\textcolor{keyword}{\ const}}
\DoxyCodeLine{00167\ \textcolor{keyword}{\ \ \ \ }\{}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ enabled();}
\DoxyCodeLine{00169\ \ \ \ \ \}}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00172\ \ \ \ \ \textcolor{keywordtype}{bool}\ enabled()\textcolor{keyword}{\ const}}
\DoxyCodeLine{00173\ \textcolor{keyword}{\ \ \ \ }\{}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ m\_options.log\_fn\ \&\&\ m\_log\_level\ >=\ m\_options.log\_level;}
\DoxyCodeLine{00175\ \ \ \ \ \}}
\DoxyCodeLine{00176\ }
\DoxyCodeLine{00177\ \ \ \ \ \textcolor{keyword}{const}\ LogOptions\&\ m\_options;}
\DoxyCodeLine{00178\ \ \ \ \ Log\ m\_log\_level;}
\DoxyCodeLine{00179\ \ \ \ \ std::ostringstream\ m\_buffer;}
\DoxyCodeLine{00180\ \};}
\DoxyCodeLine{00181\ }
\DoxyCodeLine{00182\ \textcolor{preprocessor}{\#define\ MP\_LOGPLAIN(loop,\ ...)\ if\ (mp::Logger\ logger\{(loop).m\_log\_opts,\ \_\_VA\_ARGS\_\_\};\ logger)\ logger}}
\DoxyCodeLine{00183\ }
\DoxyCodeLine{00184\ \textcolor{preprocessor}{\#define\ MP\_LOG(loop,\ ...)\ MP\_LOGPLAIN(loop,\ \_\_VA\_ARGS\_\_)\ <<\ "{}\{"{}\ <<\ LongThreadName((loop).m\_exe\_name)\ <<\ "{}\}\ "{}}}
\DoxyCodeLine{00185\ }
\DoxyCodeLine{00186\ std::string\ LongThreadName(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ exe\_name);}
\DoxyCodeLine{00187\ }
\DoxyCodeLine{00213\ \textcolor{keyword}{class\ }EventLoop}
\DoxyCodeLine{00214\ \{}
\DoxyCodeLine{00215\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00217\ \ \ \ \ EventLoop(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ exe\_name,\ LogFn\ log\_fn,\ \textcolor{keywordtype}{void}*\ context\ =\ \textcolor{keyword}{nullptr})}
\DoxyCodeLine{00218\ \ \ \ \ \ \ \ \ :\ EventLoop(exe\_name,\ LogOptions\{std::move(log\_fn)\},\ context)\{\}}
\DoxyCodeLine{00219\ }
\DoxyCodeLine{00221\ \ \ \ \ EventLoop(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ exe\_name,\ LogOptions\ log\_opts,\ \textcolor{keywordtype}{void}*\ context\ =\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00222\ }
\DoxyCodeLine{00224\ \ \ \ \ EventLoop(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ exe\_name,\ std::function<\textcolor{keywordtype}{void}(\textcolor{keywordtype}{bool},\ std::string)>\ old\_callback,\ \textcolor{keywordtype}{void}*\ context\ =\ \textcolor{keyword}{nullptr})}
\DoxyCodeLine{00225\ \ \ \ \ \ \ \ \ :\ EventLoop(exe\_name,}
\DoxyCodeLine{00226\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ LogFn\{[old\_callback\ =\ std::move(old\_callback)](LogMessage\ log\_data)\ \{old\_callback(log\_data.level\ ==\ Log::Raise,\ std::move(log\_data.message));\}\},}
\DoxyCodeLine{00227\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ context)\{\}}
\DoxyCodeLine{00228\ }
\DoxyCodeLine{00229\ \ \ \ \ \string~EventLoop();}
\DoxyCodeLine{00230\ }
\DoxyCodeLine{00234\ \ \ \ \ \textcolor{keywordtype}{void}\ loop();}
\DoxyCodeLine{00235\ }
\DoxyCodeLine{00238\ \ \ \ \ \textcolor{keywordtype}{void}\ post(kj::Function<\textcolor{keywordtype}{void}()>\ fn);}
\DoxyCodeLine{00239\ }
\DoxyCodeLine{00243\ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Callable>}
\DoxyCodeLine{00244\ \ \ \ \ \textcolor{keywordtype}{void}\ sync(Callable\&\&\ callable)}
\DoxyCodeLine{00245\ \ \ \ \ \{}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \ \ post(std::forward<Callable>(callable));}
\DoxyCodeLine{00247\ \ \ \ \ \}}
\DoxyCodeLine{00248\ }
\DoxyCodeLine{00251\ \ \ \ \ \textcolor{keywordtype}{void}\ addAsyncCleanup(std::function<\textcolor{keywordtype}{void}()>\ fn);}
\DoxyCodeLine{00252\ }
\DoxyCodeLine{00264\ \ \ \ \ \textcolor{keywordtype}{void}\ startAsyncThread()\ MP\_REQUIRES(m\_mutex);}
\DoxyCodeLine{00265\ }
\DoxyCodeLine{00267\ \ \ \ \ \textcolor{keywordtype}{bool}\ done()\ const\ MP\_REQUIRES(m\_mutex);}
\DoxyCodeLine{00268\ }
\DoxyCodeLine{00271\ \ \ \ \ const\ \textcolor{keywordtype}{char}*\ m\_exe\_name;}
\DoxyCodeLine{00272\ }
\DoxyCodeLine{00274\ \ \ \ \ std::thread::\textcolor{keywordtype}{id}\ m\_thread\_id\ =\ std::this\_thread::get\_id();}
\DoxyCodeLine{00275\ }
\DoxyCodeLine{00278\ \ \ \ \ std::thread\ m\_async\_thread;}
\DoxyCodeLine{00279\ }
\DoxyCodeLine{00281\ \ \ \ \ kj::Function<\textcolor{keywordtype}{void}()>*\ m\_post\_fn\ MP\_GUARDED\_BY(m\_mutex)\ =\ \textcolor{keywordtype}{nullptr};}
\DoxyCodeLine{00282\ }
\DoxyCodeLine{00284\ \ \ \ \ std::optional<CleanupList>\ m\_async\_fns\ MP\_GUARDED\_BY(m\_mutex);}
\DoxyCodeLine{00285\ }
\DoxyCodeLine{00287\ \ \ \ \ \textcolor{keywordtype}{int}\ m\_wait\_fd\ =\ -\/1;}
\DoxyCodeLine{00288\ }
\DoxyCodeLine{00290\ \ \ \ \ \textcolor{keywordtype}{int}\ m\_post\_fd\ =\ -\/1;}
\DoxyCodeLine{00291\ }
\DoxyCodeLine{00294\ \ \ \ \ \textcolor{keywordtype}{int}\ m\_num\_clients\ MP\_GUARDED\_BY(m\_mutex)\ =\ 0;}
\DoxyCodeLine{00295\ }
\DoxyCodeLine{00298\ \ \ \ \ Mutex\ m\_mutex;}
\DoxyCodeLine{00299\ \ \ \ \ std::condition\_variable\ m\_cv;}
\DoxyCodeLine{00300\ }
\DoxyCodeLine{00302\ \ \ \ \ kj::AsyncIoContext\ m\_io\_context;}
\DoxyCodeLine{00303\ }
\DoxyCodeLine{00305\ \ \ \ \ LoggingErrorHandler\ m\_error\_handler\{*\textcolor{keyword}{this}\};}
\DoxyCodeLine{00306\ }
\DoxyCodeLine{00308\ \ \ \ \ std::unique\_ptr<kj::TaskSet>\ m\_task\_set;}
\DoxyCodeLine{00309\ }
\DoxyCodeLine{00311\ \ \ \ \ std::list<Connection>\ m\_incoming\_connections;}
\DoxyCodeLine{00312\ }
\DoxyCodeLine{00314\ \ \ \ \ LogOptions\ m\_log\_opts;}
\DoxyCodeLine{00315\ }
\DoxyCodeLine{00317\ \ \ \ \ \textcolor{keywordtype}{void}*\ m\_context;}
\DoxyCodeLine{00318\ \};}
\DoxyCodeLine{00319\ }
\DoxyCodeLine{00326\ \textcolor{keyword}{struct\ }Waiter}
\DoxyCodeLine{00327\ \{}
\DoxyCodeLine{00328\ \ \ \ \ Waiter()\ =\ \textcolor{keywordflow}{default};}
\DoxyCodeLine{00329\ }
\DoxyCodeLine{00330\ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Fn>}
\DoxyCodeLine{00331\ \ \ \ \ \textcolor{keywordtype}{bool}\ post(Fn\&\&\ fn)}
\DoxyCodeLine{00332\ \ \ \ \ \{}
\DoxyCodeLine{00333\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ Lock\ lock(m\_mutex);}
\DoxyCodeLine{00334\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_fn)\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00335\ \ \ \ \ \ \ \ \ m\_fn\ =\ std::forward<Fn>(fn);}
\DoxyCodeLine{00336\ \ \ \ \ \ \ \ \ m\_cv.notify\_all();}
\DoxyCodeLine{00337\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00338\ \ \ \ \ \}}
\DoxyCodeLine{00339\ }
\DoxyCodeLine{00340\ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{class}\ Predicate>}
\DoxyCodeLine{00341\ \ \ \ \ \textcolor{keywordtype}{void}\ wait(Lock\&\ lock,\ Predicate\ pred)}
\DoxyCodeLine{00342\ \ \ \ \ \{}
\DoxyCodeLine{00343\ \ \ \ \ \ \ \ \ m\_cv.wait(lock.m\_lock,\ [\&]()\ MP\_REQUIRES(m\_mutex)\ \{}
\DoxyCodeLine{00344\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Important\ for\ this\ to\ be\ "{}while\ (m\_fn)"{},\ not\ "{}if\ (m\_fn)"{}\ to\ avoid}}
\DoxyCodeLine{00345\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ a\ lost-\/wakeup\ bug.\ A\ new\ m\_fn\ and\ m\_cv\ notification\ might\ be\ sent}}
\DoxyCodeLine{00346\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ after\ the\ fn()\ call\ and\ before\ the\ lock.lock()\ call\ in\ this\ loop}}
\DoxyCodeLine{00347\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ in\ the\ case\ where\ a\ capnp\ response\ is\ sent\ and\ a\ brand\ new}}
\DoxyCodeLine{00348\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ request\ is\ immediately\ received.}}
\DoxyCodeLine{00349\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (m\_fn)\ \{}
\DoxyCodeLine{00350\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ fn\ =\ std::move(*m\_fn);}
\DoxyCodeLine{00351\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_fn.reset();}
\DoxyCodeLine{00352\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Unlock(lock,\ fn);}
\DoxyCodeLine{00353\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00354\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ done\ =\ pred();}
\DoxyCodeLine{00355\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ done;}
\DoxyCodeLine{00356\ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00357\ \ \ \ \ \}}
\DoxyCodeLine{00358\ }
\DoxyCodeLine{00366\ \ \ \ \ Mutex\ m\_mutex;}
\DoxyCodeLine{00367\ \ \ \ \ std::condition\_variable\ m\_cv;}
\DoxyCodeLine{00368\ \ \ \ \ std::optional<kj::Function<void()>>\ m\_fn\ MP\_GUARDED\_BY(m\_mutex);}
\DoxyCodeLine{00369\ \};}
\DoxyCodeLine{00370\ }
\DoxyCodeLine{00376\ \textcolor{keyword}{class\ }Connection}
\DoxyCodeLine{00377\ \{}
\DoxyCodeLine{00378\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00379\ \ \ \ \ Connection(EventLoop\&\ loop,\ kj::Own<kj::AsyncIoStream>\&\&\ stream\_)}
\DoxyCodeLine{00380\ \ \ \ \ \ \ \ \ :\ m\_loop(loop),\ m\_stream(kj::mv(stream\_)),}
\DoxyCodeLine{00381\ \ \ \ \ \ \ \ \ \ \ m\_network(*m\_stream,\ ::capnp::rpc::twoparty::Side::CLIENT,\ ::capnp::ReaderOptions()),}
\DoxyCodeLine{00382\ \ \ \ \ \ \ \ \ \ \ m\_rpc\_system(::capnp::makeRpcClient(m\_network))\ \{\}}
\DoxyCodeLine{00383\ \ \ \ \ Connection(EventLoop\&\ loop,}
\DoxyCodeLine{00384\ \ \ \ \ \ \ \ \ kj::Own<kj::AsyncIoStream>\&\&\ stream\_,}
\DoxyCodeLine{00385\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ std::function<::capnp::Capability::Client(Connection\&)>\&\ make\_client)}
\DoxyCodeLine{00386\ \ \ \ \ \ \ \ \ :\ m\_loop(loop),\ m\_stream(kj::mv(stream\_)),}
\DoxyCodeLine{00387\ \ \ \ \ \ \ \ \ \ \ m\_network(*m\_stream,\ ::capnp::rpc::twoparty::Side::SERVER,\ ::capnp::ReaderOptions()),}
\DoxyCodeLine{00388\ \ \ \ \ \ \ \ \ \ \ m\_rpc\_system(::capnp::makeRpcServer(m\_network,\ make\_client(*this)))\ \{\}}
\DoxyCodeLine{00389\ }
\DoxyCodeLine{00395\ \ \ \ \ \string~Connection();}
\DoxyCodeLine{00396\ }
\DoxyCodeLine{00400\ \ \ \ \ CleanupIt\ addSyncCleanup(std::function<\textcolor{keywordtype}{void}()>\ fn);}
\DoxyCodeLine{00401\ \ \ \ \ \textcolor{keywordtype}{void}\ removeSyncCleanup(CleanupIt\ it);}
\DoxyCodeLine{00402\ }
\DoxyCodeLine{00404\ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ F>}
\DoxyCodeLine{00405\ \ \ \ \ \textcolor{keywordtype}{void}\ onDisconnect(F\&\&\ f)}
\DoxyCodeLine{00406\ \ \ \ \ \{}
\DoxyCodeLine{00407\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Add\ disconnect\ handler\ to\ local\ TaskSet\ to\ ensure\ it\ is\ cancelled\ and}}
\DoxyCodeLine{00408\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ will\ never\ run\ after\ connection\ object\ is\ destroyed.\ But\ when\ disconnect}}
\DoxyCodeLine{00409\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ handler\ fires,\ do\ not\ call\ the\ function\ f\ right\ away,\ instead\ add\ it}}
\DoxyCodeLine{00410\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ to\ the\ EventLoop\ TaskSet\ to\ avoid\ "{}Promise\ callback\ destroyed\ itself"{}}}
\DoxyCodeLine{00411\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ error\ in\ cases\ where\ f\ deletes\ this\ Connection\ object.}}
\DoxyCodeLine{00412\ \ \ \ \ \ \ \ \ m\_on\_disconnect.add(m\_network.onDisconnect().then(}
\DoxyCodeLine{00413\ \ \ \ \ \ \ \ \ \ \ \ \ [f\ =\ std::forward<F>(f),\ \textcolor{keyword}{this}]()\ \textcolor{keyword}{mutable}\ \{\ m\_loop-\/>m\_task\_set-\/>add(kj::evalLater(kj::mv(f)));\ \}));}
\DoxyCodeLine{00414\ \ \ \ \ \}}
\DoxyCodeLine{00415\ }
\DoxyCodeLine{00416\ \ \ \ \ EventLoopRef\ m\_loop;}
\DoxyCodeLine{00417\ \ \ \ \ kj::Own<kj::AsyncIoStream>\ m\_stream;}
\DoxyCodeLine{00418\ \ \ \ \ LoggingErrorHandler\ m\_error\_handler\{*m\_loop\};}
\DoxyCodeLine{00419\ \ \ \ \ kj::TaskSet\ m\_on\_disconnect\{m\_error\_handler\};}
\DoxyCodeLine{00420\ \ \ \ \ ::capnp::TwoPartyVatNetwork\ m\_network;}
\DoxyCodeLine{00421\ \ \ \ \ std::optional<::capnp::RpcSystem<::capnp::rpc::twoparty::VatId>>\ m\_rpc\_system;}
\DoxyCodeLine{00422\ }
\DoxyCodeLine{00423\ \ \ \ \ \textcolor{comment}{//\ ThreadMap\ interface\ client,\ used\ to\ create\ a\ remote\ server\ thread\ when\ an}}
\DoxyCodeLine{00424\ \ \ \ \ \textcolor{comment}{//\ client\ IPC\ call\ is\ being\ made\ for\ the\ first\ time\ from\ a\ new\ thread.}}
\DoxyCodeLine{00425\ \ \ \ \ ThreadMap::Client\ m\_thread\_map\{\textcolor{keyword}{nullptr}\};}
\DoxyCodeLine{00426\ }
\DoxyCodeLine{00429\ \ \ \ \ ::capnp::CapabilityServerSet<Thread>\ m\_threads;}
\DoxyCodeLine{00430\ }
\DoxyCodeLine{00434\ \ \ \ \ CleanupList\ m\_sync\_cleanup\_fns;}
\DoxyCodeLine{00435\ \};}
\DoxyCodeLine{00436\ }
\DoxyCodeLine{00445\ \textcolor{keyword}{struct\ }ServerVatId}
\DoxyCodeLine{00446\ \{}
\DoxyCodeLine{00447\ \ \ \ \ ::capnp::word\ scratch[4]\{\};}
\DoxyCodeLine{00448\ \ \ \ \ ::capnp::MallocMessageBuilder\ message\{scratch\};}
\DoxyCodeLine{00449\ \ \ \ \ ::capnp::rpc::twoparty::VatId::Builder\ vat\_id\{message.getRoot<::capnp::rpc::twoparty::VatId>()\};}
\DoxyCodeLine{00450\ \ \ \ \ ServerVatId()\ \{\ vat\_id.setSide(::capnp::rpc::twoparty::Side::SERVER);\ \}}
\DoxyCodeLine{00451\ \};}
\DoxyCodeLine{00452\ }
\DoxyCodeLine{00453\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Interface,\ \textcolor{keyword}{typename}\ Impl>}
\DoxyCodeLine{00454\ ProxyClientBase<Interface,\ Impl>::ProxyClientBase(\textcolor{keyword}{typename}\ Interface::Client\ client,}
\DoxyCodeLine{00455\ \ \ \ \ Connection*\ connection,}
\DoxyCodeLine{00456\ \ \ \ \ \textcolor{keywordtype}{bool}\ destroy\_connection)}
\DoxyCodeLine{00457\ \ \ \ \ :\ m\_client(std::move(client)),\ m\_context(connection)}
\DoxyCodeLine{00458\ }
\DoxyCodeLine{00459\ \{}
\DoxyCodeLine{00460\ \ \ \ \ \textcolor{comment}{//\ Handler\ for\ the\ connection\ getting\ destroyed\ before\ this\ client\ object.}}
\DoxyCodeLine{00461\ \ \ \ \ \textcolor{keyword}{auto}\ disconnect\_cb\ =\ m\_context.connection-\/>addSyncCleanup([\textcolor{keyword}{this}]()\ \{}
\DoxyCodeLine{00462\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Release\ client\ capability\ by\ move-\/assigning\ to\ temporary.}}
\DoxyCodeLine{00463\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00464\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ Interface::Client(std::move(m\_client));}
\DoxyCodeLine{00465\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00466\ \ \ \ \ \ \ \ \ Lock\ lock\{m\_context.loop-\/>m\_mutex\};}
\DoxyCodeLine{00467\ \ \ \ \ \ \ \ \ m\_context.connection\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00468\ \ \ \ \ \});}
\DoxyCodeLine{00469\ }
\DoxyCodeLine{00470\ \ \ \ \ \textcolor{comment}{//\ Two\ shutdown\ sequences\ are\ supported:}}
\DoxyCodeLine{00471\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00472\ \ \ \ \ \textcolor{comment}{//\ -\/\ A\ normal\ sequence\ where\ client\ proxy\ objects\ are\ deleted\ by\ external}}
\DoxyCodeLine{00473\ \ \ \ \ \textcolor{comment}{//\ \ \ code\ that\ no\ longer\ needs\ them}}
\DoxyCodeLine{00474\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00475\ \ \ \ \ \textcolor{comment}{//\ -\/\ A\ garbage\ collection\ sequence\ where\ the\ connection\ or\ event\ loop\ shuts}}
\DoxyCodeLine{00476\ \ \ \ \ \textcolor{comment}{//\ \ \ down\ while\ external\ code\ is\ still\ holding\ client\ references.}}
\DoxyCodeLine{00477\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00478\ \ \ \ \ \textcolor{comment}{//\ The\ first\ case\ is\ handled\ here\ when\ m\_context.connection\ is\ not\ null.\ The}}
\DoxyCodeLine{00479\ \ \ \ \ \textcolor{comment}{//\ second\ case\ is\ handled\ by\ the\ disconnect\_cb\ function,\ which\ sets}}
\DoxyCodeLine{00480\ \ \ \ \ \textcolor{comment}{//\ m\_context.connection\ to\ null\ so\ nothing\ happens\ here.}}
\DoxyCodeLine{00481\ \ \ \ \ m\_context.cleanup\_fns.emplace\_front([\textcolor{keyword}{this},\ destroy\_connection,\ disconnect\_cb]\{}
\DoxyCodeLine{00482\ \ \ \ \ \{}
\DoxyCodeLine{00483\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ the\ capnp\ interface\ defines\ a\ destroy\ method,\ call\ it\ to\ destroy}}
\DoxyCodeLine{00484\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ the\ remote\ object,\ waiting\ for\ it\ to\ be\ deleted\ server\ side.\ If\ the}}
\DoxyCodeLine{00485\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ capnp\ interface\ does\ not\ define\ a\ destroy\ method,\ this\ will\ just\ call}}
\DoxyCodeLine{00486\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ an\ empty\ stub\ defined\ in\ the\ ProxyClientBase\ class\ and\ do\ nothing.}}
\DoxyCodeLine{00487\ \ \ \ \ \ \ \ \ Sub::destroy(*\textcolor{keyword}{this});}
\DoxyCodeLine{00488\ }
\DoxyCodeLine{00489\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ FIXME:\ Could\ just\ invoke\ removed\ addCleanup\ fn\ here\ instead\ of\ duplicating\ code}}
\DoxyCodeLine{00490\ \ \ \ \ \ \ \ \ m\_context.loop-\/>sync([\&]()\ \{}
\DoxyCodeLine{00491\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Remove\ disconnect\ callback\ on\ cleanup\ so\ it\ doesn't\ run\ and\ try}}
\DoxyCodeLine{00492\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ to\ access\ this\ object\ after\ it's\ destroyed.\ This\ call\ needs\ to}}
\DoxyCodeLine{00493\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ run\ inside\ loop-\/>sync()\ on\ the\ event\ loop\ thread\ because}}
\DoxyCodeLine{00494\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ otherwise,\ if\ there\ were\ an\ ill-\/timed\ disconnect,\ the}}
\DoxyCodeLine{00495\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ onDisconnect\ handler\ could\ fire\ and\ delete\ the\ Connection\ object}}
\DoxyCodeLine{00496\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ before\ the\ removeSyncCleanup\ call.}}
\DoxyCodeLine{00497\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_context.connection)\ m\_context.connection-\/>removeSyncCleanup(disconnect\_cb);}
\DoxyCodeLine{00498\ }
\DoxyCodeLine{00499\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Release\ client\ capability\ by\ move-\/assigning\ to\ temporary.}}
\DoxyCodeLine{00500\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00501\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ Interface::Client(std::move(m\_client));}
\DoxyCodeLine{00502\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00503\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (destroy\_connection)\ \{}
\DoxyCodeLine{00504\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ m\_context.connection;}
\DoxyCodeLine{00505\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_context.connection\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00506\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00507\ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00508\ \ \ \ \ \}}
\DoxyCodeLine{00509\ \ \ \ \ \});}
\DoxyCodeLine{00510\ \ \ \ \ Sub::construct(*\textcolor{keyword}{this});}
\DoxyCodeLine{00511\ \}}
\DoxyCodeLine{00512\ }
\DoxyCodeLine{00513\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Interface,\ \textcolor{keyword}{typename}\ Impl>}
\DoxyCodeLine{00514\ ProxyClientBase<Interface,\ Impl>::\string~ProxyClientBase()\ noexcept}
\DoxyCodeLine{00515\ \{}
\DoxyCodeLine{00516\ \ \ \ \ CleanupRun(m\_context.cleanup\_fns);}
\DoxyCodeLine{00517\ \}}
\DoxyCodeLine{00518\ }
\DoxyCodeLine{00519\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Interface,\ \textcolor{keyword}{typename}\ Impl>}
\DoxyCodeLine{00520\ ProxyServerBase<Interface,\ Impl>::ProxyServerBase(std::shared\_ptr<Impl>\ impl,\ Connection\&\ connection)}
\DoxyCodeLine{00521\ \ \ \ \ :\ m\_impl(std::move(impl)),\ m\_context(\&connection)}
\DoxyCodeLine{00522\ \{}
\DoxyCodeLine{00523\ \ \ \ \ assert(m\_impl);}
\DoxyCodeLine{00524\ \}}
\DoxyCodeLine{00525\ }
\DoxyCodeLine{00538\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Interface,\ \textcolor{keyword}{typename}\ Impl>}
\DoxyCodeLine{00539\ ProxyServerBase<Interface,\ Impl>::\string~ProxyServerBase()}
\DoxyCodeLine{00540\ \{}
\DoxyCodeLine{00541\ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_impl)\ \{}
\DoxyCodeLine{00542\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ impl\ is\ non-\/null\ at\ this\ point,\ it\ means\ no\ client\ is\ waiting\ for}}
\DoxyCodeLine{00543\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ the\ m\_impl\ server\ object\ to\ be\ destroyed\ synchronously.\ This\ can}}
\DoxyCodeLine{00544\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ happen\ either\ if\ the\ interface\ did\ not\ define\ a\ "{}destroy"{}\ method\ (see}}
\DoxyCodeLine{00545\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ invokeDestroy\ method\ below),\ or\ if\ a\ destroy\ method\ was\ defined,\ but}}
\DoxyCodeLine{00546\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ the\ connection\ was\ broken\ before\ it\ could\ be\ called.}}
\DoxyCodeLine{00547\ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00548\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ In\ either\ case,\ be\ conservative\ and\ run\ the\ cleanup\ on\ an}}
\DoxyCodeLine{00549\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ asynchronous\ thread,\ to\ avoid\ destructors\ or\ cleanup\ functions}}
\DoxyCodeLine{00550\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ blocking\ or\ deadlocking\ the\ current\ EventLoop\ thread,\ since\ they}}
\DoxyCodeLine{00551\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ could\ be\ making\ IPC\ calls.}}
\DoxyCodeLine{00552\ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00553\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Technically\ this\ is\ a\ little\ too\ conservative\ since\ if\ the\ interface}}
\DoxyCodeLine{00554\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ defines\ a\ "{}destroy"{}\ method,\ but\ the\ destroy\ method\ does\ not\ accept\ a}}
\DoxyCodeLine{00555\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Context\ parameter\ specifying\ a\ worker\ thread,\ the\ cleanup\ method}}
\DoxyCodeLine{00556\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ would\ run\ on\ the\ EventLoop\ thread\ normally\ (when\ connection\ is}}
\DoxyCodeLine{00557\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ unbroken),\ but\ will\ not\ run\ on\ the\ EventLoop\ thread\ now\ (when}}
\DoxyCodeLine{00558\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ connection\ is\ broken).\ Probably\ some\ refactoring\ of\ the\ destructor}}
\DoxyCodeLine{00559\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ and\ invokeDestroy\ function\ is\ possible\ to\ make\ this\ cleaner\ and\ more}}
\DoxyCodeLine{00560\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ consistent.}}
\DoxyCodeLine{00561\ \ \ \ \ \ \ \ \ m\_context.loop-\/>addAsyncCleanup([impl=std::move(m\_impl),\ fns=std::move(m\_context.cleanup\_fns)]()\ \textcolor{keyword}{mutable}\ \{}
\DoxyCodeLine{00562\ \ \ \ \ \ \ \ \ \ \ \ \ impl.reset();}
\DoxyCodeLine{00563\ \ \ \ \ \ \ \ \ \ \ \ \ CleanupRun(fns);}
\DoxyCodeLine{00564\ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00565\ \ \ \ \ \}}
\DoxyCodeLine{00566\ \ \ \ \ assert(m\_context.cleanup\_fns.empty());}
\DoxyCodeLine{00567\ \}}
\DoxyCodeLine{00568\ }
\DoxyCodeLine{00586\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Interface,\ \textcolor{keyword}{typename}\ Impl>}
\DoxyCodeLine{00587\ \textcolor{keywordtype}{void}\ ProxyServerBase<Interface,\ Impl>::invokeDestroy()}
\DoxyCodeLine{00588\ \{}
\DoxyCodeLine{00589\ \ \ \ \ m\_impl.reset();}
\DoxyCodeLine{00590\ \ \ \ \ CleanupRun(m\_context.cleanup\_fns);}
\DoxyCodeLine{00591\ \}}
\DoxyCodeLine{00592\ }
\DoxyCodeLine{00599\ \textcolor{keyword}{using\ }ConnThreads\ =\ std::map<Connection*,\ std::optional<ProxyClient<Thread>>>;}
\DoxyCodeLine{00600\ \textcolor{keyword}{using\ }ConnThread\ =\ ConnThreads::iterator;}
\DoxyCodeLine{00601\ }
\DoxyCodeLine{00602\ \textcolor{comment}{//\ Retrieve\ ProxyClient<Thread>\ object\ associated\ with\ this\ connection\ from\ a}}
\DoxyCodeLine{00603\ \textcolor{comment}{//\ map,\ or\ create\ a\ new\ one\ and\ insert\ it\ into\ the\ map.\ Return\ map\ iterator\ and}}
\DoxyCodeLine{00604\ \textcolor{comment}{//\ inserted\ bool.}}
\DoxyCodeLine{00605\ std::tuple<ConnThread,\ bool>\ SetThread(GuardedRef<ConnThreads>\ threads,\ Connection*\ connection,\ \textcolor{keyword}{const}\ std::function<Thread::Client()>\&\ make\_thread);}
\DoxyCodeLine{00606\ }
\DoxyCodeLine{00620\ \textcolor{keyword}{struct\ }ThreadContext}
\DoxyCodeLine{00621\ \{}
\DoxyCodeLine{00623\ \ \ \ \ std::string\ thread\_name;}
\DoxyCodeLine{00624\ }
\DoxyCodeLine{00640\ \ \ \ \ std::unique\_ptr<Waiter>\ waiter\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00641\ }
\DoxyCodeLine{00659\ \ \ \ \ ConnThreads\ callback\_threads\ MP\_GUARDED\_BY(waiter-\/>m\_mutex);}
\DoxyCodeLine{00660\ }
\DoxyCodeLine{00670\ \ \ \ \ ConnThreads\ request\_threads\ MP\_GUARDED\_BY(waiter-\/>m\_mutex);}
\DoxyCodeLine{00671\ }
\DoxyCodeLine{00675\ \ \ \ \ \textcolor{keywordtype}{bool}\ loop\_thread\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00676\ \};}
\DoxyCodeLine{00677\ }
\DoxyCodeLine{00681\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ InitInterface>}
\DoxyCodeLine{00682\ std::unique\_ptr<ProxyClient<InitInterface>>\ ConnectStream(EventLoop\&\ loop,\ \textcolor{keywordtype}{int}\ fd)}
\DoxyCodeLine{00683\ \{}
\DoxyCodeLine{00684\ \ \ \ \ \textcolor{keyword}{typename}\ InitInterface::Client\ init\_client(\textcolor{keyword}{nullptr});}
\DoxyCodeLine{00685\ \ \ \ \ std::unique\_ptr<Connection>\ connection;}
\DoxyCodeLine{00686\ \ \ \ \ loop.sync([\&]\ \{}
\DoxyCodeLine{00687\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ stream\ =}
\DoxyCodeLine{00688\ \ \ \ \ \ \ \ \ \ \ \ \ loop.m\_io\_context.lowLevelProvider-\/>wrapSocketFd(fd,\ kj::LowLevelAsyncIoProvider::TAKE\_OWNERSHIP);}
\DoxyCodeLine{00689\ \ \ \ \ \ \ \ \ connection\ =\ std::make\_unique<Connection>(loop,\ kj::mv(stream));}
\DoxyCodeLine{00690\ \ \ \ \ \ \ \ \ init\_client\ =\ connection-\/>m\_rpc\_system-\/>bootstrap(ServerVatId().vat\_id).castAs<InitInterface>();}
\DoxyCodeLine{00691\ \ \ \ \ \ \ \ \ Connection*\ connection\_ptr\ =\ connection.get();}
\DoxyCodeLine{00692\ \ \ \ \ \ \ \ \ connection-\/>onDisconnect([\&loop,\ connection\_ptr]\ \{}
\DoxyCodeLine{00693\ \ \ \ \ \ \ \ \ \ \ \ \ MP\_LOG(loop,\ Log::Warning)\ <<\ \textcolor{stringliteral}{"{}IPC\ client:\ unexpected\ network\ disconnect."{}};}
\DoxyCodeLine{00694\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ connection\_ptr;}
\DoxyCodeLine{00695\ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00696\ \ \ \ \ \});}
\DoxyCodeLine{00697\ \ \ \ \ \textcolor{keywordflow}{return}\ std::make\_unique<ProxyClient<InitInterface>>(}
\DoxyCodeLine{00698\ \ \ \ \ \ \ \ \ kj::mv(init\_client),\ connection.release(),\ \textcolor{comment}{/*\ destroy\_connection=\ */}\ \textcolor{keyword}{true});}
\DoxyCodeLine{00699\ \}}
\DoxyCodeLine{00700\ }
\DoxyCodeLine{00705\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ InitInterface,\ \textcolor{keyword}{typename}\ InitImpl>}
\DoxyCodeLine{00706\ \textcolor{keywordtype}{void}\ \_Serve(EventLoop\&\ loop,\ kj::Own<kj::AsyncIoStream>\&\&\ stream,\ InitImpl\&\ init)}
\DoxyCodeLine{00707\ \{}
\DoxyCodeLine{00708\ \ \ \ \ loop.m\_incoming\_connections.emplace\_front(loop,\ kj::mv(stream),\ [\&](Connection\&\ connection)\ \{}
\DoxyCodeLine{00709\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Disable\ deleter\ so\ proxy\ server\ object\ doesn't\ attempt\ to\ delete\ the}}
\DoxyCodeLine{00710\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ init\ implementation\ when\ the\ proxy\ client\ is\ destroyed\ or}}
\DoxyCodeLine{00711\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ disconnected.}}
\DoxyCodeLine{00712\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ kj::heap<ProxyServer<InitInterface>>(std::shared\_ptr<InitImpl>(\&init,\ [](InitImpl*)\{\}),\ connection);}
\DoxyCodeLine{00713\ \ \ \ \ \});}
\DoxyCodeLine{00714\ \ \ \ \ \textcolor{keyword}{auto}\ it\ =\ loop.m\_incoming\_connections.begin();}
\DoxyCodeLine{00715\ \ \ \ \ it-\/>onDisconnect([\&loop,\ it]\ \{}
\DoxyCodeLine{00716\ \ \ \ \ \ \ \ \ MP\_LOG(loop,\ Log::Info)\ <<\ \textcolor{stringliteral}{"{}IPC\ server:\ socket\ disconnected."{}};}
\DoxyCodeLine{00717\ \ \ \ \ \ \ \ \ loop.m\_incoming\_connections.erase(it);}
\DoxyCodeLine{00718\ \ \ \ \ \});}
\DoxyCodeLine{00719\ \}}
\DoxyCodeLine{00720\ }
\DoxyCodeLine{00724\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ InitInterface,\ \textcolor{keyword}{typename}\ InitImpl>}
\DoxyCodeLine{00725\ \textcolor{keywordtype}{void}\ \_Listen(EventLoop\&\ loop,\ kj::Own<kj::ConnectionReceiver>\&\&\ listener,\ InitImpl\&\ init)}
\DoxyCodeLine{00726\ \{}
\DoxyCodeLine{00727\ \ \ \ \ \textcolor{keyword}{auto}*\ ptr\ =\ listener.get();}
\DoxyCodeLine{00728\ \ \ \ \ loop.m\_task\_set-\/>add(ptr-\/>accept().then(}
\DoxyCodeLine{00729\ \ \ \ \ \ \ \ \ [\&loop,\ \&init,\ listener\ =\ kj::mv(listener)](kj::Own<kj::AsyncIoStream>\&\&\ stream)\ \textcolor{keyword}{mutable}\ \{}
\DoxyCodeLine{00730\ \ \ \ \ \ \ \ \ \ \ \ \ \_Serve<InitInterface>(loop,\ kj::mv(stream),\ init);}
\DoxyCodeLine{00731\ \ \ \ \ \ \ \ \ \ \ \ \ \_Listen<InitInterface>(loop,\ kj::mv(listener),\ init);}
\DoxyCodeLine{00732\ \ \ \ \ \ \ \ \ \}));}
\DoxyCodeLine{00733\ \}}
\DoxyCodeLine{00734\ }
\DoxyCodeLine{00737\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ InitInterface,\ \textcolor{keyword}{typename}\ InitImpl>}
\DoxyCodeLine{00738\ \textcolor{keywordtype}{void}\ ServeStream(EventLoop\&\ loop,\ \textcolor{keywordtype}{int}\ fd,\ InitImpl\&\ init)}
\DoxyCodeLine{00739\ \{}
\DoxyCodeLine{00740\ \ \ \ \ \_Serve<InitInterface>(}
\DoxyCodeLine{00741\ \ \ \ \ \ \ \ \ loop,\ loop.m\_io\_context.lowLevelProvider-\/>wrapSocketFd(fd,\ kj::LowLevelAsyncIoProvider::TAKE\_OWNERSHIP),\ init);}
\DoxyCodeLine{00742\ \}}
\DoxyCodeLine{00743\ }
\DoxyCodeLine{00746\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ InitInterface,\ \textcolor{keyword}{typename}\ InitImpl>}
\DoxyCodeLine{00747\ \textcolor{keywordtype}{void}\ ListenConnections(EventLoop\&\ loop,\ \textcolor{keywordtype}{int}\ fd,\ InitImpl\&\ init)}
\DoxyCodeLine{00748\ \{}
\DoxyCodeLine{00749\ \ \ \ \ loop.sync([\&]()\ \{}
\DoxyCodeLine{00750\ \ \ \ \ \ \ \ \ \_Listen<InitInterface>(loop,}
\DoxyCodeLine{00751\ \ \ \ \ \ \ \ \ \ \ \ \ loop.m\_io\_context.lowLevelProvider-\/>wrapListenSocketFd(fd,\ kj::LowLevelAsyncIoProvider::TAKE\_OWNERSHIP),}
\DoxyCodeLine{00752\ \ \ \ \ \ \ \ \ \ \ \ \ init);}
\DoxyCodeLine{00753\ \ \ \ \ \});}
\DoxyCodeLine{00754\ \}}
\DoxyCodeLine{00755\ }
\DoxyCodeLine{00756\ \textcolor{keyword}{extern}\ \textcolor{keyword}{thread\_local}\ ThreadContext\ g\_thread\_context;\ \textcolor{comment}{//\ NOLINT(bitcoin-\/nontrivial-\/threadlocal)}}
\DoxyCodeLine{00757\ \textcolor{comment}{//\ Silence\ nonstandard\ bitcoin\ tidy\ error\ "{}Variable\ with\ non-\/trivial\ destructor}}
\DoxyCodeLine{00758\ \textcolor{comment}{//\ cannot\ be\ thread\_local"{}\ which\ should\ not\ be\ a\ problem\ on\ modern\ platforms,\ and}}
\DoxyCodeLine{00759\ \textcolor{comment}{//\ could\ lead\ to\ a\ small\ memory\ leak\ at\ worst\ on\ older\ ones.}}
\DoxyCodeLine{00760\ }
\DoxyCodeLine{00761\ \}\ \textcolor{comment}{//\ namespace\ mp}}
\DoxyCodeLine{00762\ }
\DoxyCodeLine{00763\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ MP\_PROXY\_IO\_H}}

\end{DoxyCode}
