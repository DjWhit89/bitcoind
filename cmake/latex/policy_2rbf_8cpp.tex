\doxysection{src/policy/rbf.cpp File Reference}
\label{policy_2rbf_8cpp}\index{src/policy/rbf.cpp@{src/policy/rbf.cpp}}
{\ttfamily \#include $<$policy/rbf.\+h$>$}\newline
{\ttfamily \#include $<$consensus/amount.\+h$>$}\newline
{\ttfamily \#include $<$kernel/mempool\+\_\+entry.\+h$>$}\newline
{\ttfamily \#include $<$policy/feerate.\+h$>$}\newline
{\ttfamily \#include $<$primitives/transaction.\+h$>$}\newline
{\ttfamily \#include $<$sync.\+h$>$}\newline
{\ttfamily \#include $<$tinyformat.\+h$>$}\newline
{\ttfamily \#include $<$txmempool.\+h$>$}\newline
{\ttfamily \#include $<$uint256.\+h$>$}\newline
{\ttfamily \#include $<$util/check.\+h$>$}\newline
{\ttfamily \#include $<$util/moneystr.\+h$>$}\newline
{\ttfamily \#include $<$util/rbf.\+h$>$}\newline
{\ttfamily \#include $<$limits$>$}\newline
{\ttfamily \#include $<$vector$>$}\newline
{\ttfamily \#include $<$compare$>$}\newline
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\textbf{ RBFTransaction\+State} \textbf{ Is\+RBFOpt\+In} (const \textbf{ CTransaction} \&tx, const \textbf{ CTx\+Mem\+Pool} \&pool)
\item 
\textbf{ RBFTransaction\+State} \textbf{ Is\+RBFOpt\+In\+Empty\+Mempool} (const \textbf{ CTransaction} \&tx)
\item 
std\+::optional$<$ std\+::string $>$ \textbf{ Get\+Entries\+For\+Conflicts} (const \textbf{ CTransaction} \&tx, \textbf{ CTx\+Mem\+Pool} \&pool, const \textbf{ CTx\+Mem\+Pool\+::set\+Entries} \&iters\+\_\+conflicting, \textbf{ CTx\+Mem\+Pool\+::set\+Entries} \&all\+\_\+conflicts)
\item 
std\+::optional$<$ std\+::string $>$ \textbf{ Entries\+And\+Txids\+Disjoint} (const \textbf{ CTx\+Mem\+Pool\+::set\+Entries} \&ancestors, const std\+::set$<$ \textbf{ Txid} $>$ \&direct\+\_\+conflicts, const \textbf{ Txid} \&txid)
\item 
std\+::optional$<$ std\+::string $>$ \textbf{ Pays\+For\+RBF} (\textbf{ CAmount} original\+\_\+fees, \textbf{ CAmount} replacement\+\_\+fees, size\+\_\+t replacement\+\_\+vsize, \textbf{ CFee\+Rate} relay\+\_\+fee, const \textbf{ Txid} \&txid)
\item 
std\+::optional$<$ std\+::pair$<$ \textbf{ Diagram\+Check\+Error}, std\+::string $>$ $>$ \textbf{ Improves\+Feerate\+Diagram} (\textbf{ CTx\+Mem\+Pool\+::\+Change\+Set} \&changeset)
\end{DoxyCompactItemize}


\label{doc-func-members}
\doxysubsection{Function Documentation}
\index{rbf.cpp@{rbf.cpp}!EntriesAndTxidsDisjoint@{EntriesAndTxidsDisjoint}}
\index{EntriesAndTxidsDisjoint@{EntriesAndTxidsDisjoint}!rbf.cpp@{rbf.cpp}}
\doxysubsubsection{EntriesAndTxidsDisjoint()}
{\footnotesize\ttfamily \label{policy_2rbf_8cpp_aefb8bb2b6c313b8f80c5dd8247c96460} 
std\+::optional$<$ std\+::string $>$ Entries\+And\+Txids\+Disjoint (\begin{DoxyParamCaption}\item[{const \textbf{ CTx\+Mem\+Pool\+::set\+Entries} \&}]{ancestors}{, }\item[{const std\+::set$<$ \textbf{ Txid} $>$ \&}]{direct\+\_\+conflicts}{, }\item[{const \textbf{ Txid} \&}]{txid}{}\end{DoxyParamCaption})}

Check the intersection between two sets of transactions (a set of mempool entries and a set of txids) to make sure they are disjoint. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{in}}  & {\em ancestors} & Set of mempool entries corresponding to ancestors of the replacement transactions. \\
\hline
\mbox{\texttt{in}}  & {\em direct\+\_\+conflicts} & Set of txids corresponding to the mempool conflicts (candidates to be replaced). \\
\hline
\mbox{\texttt{in}}  & {\em txid} & Transaction ID, included in the error message if violation occurs. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
error message if the sets intersect, std\+::nullopt if they are disjoint. 
\end{DoxyReturn}
\index{rbf.cpp@{rbf.cpp}!GetEntriesForConflicts@{GetEntriesForConflicts}}
\index{GetEntriesForConflicts@{GetEntriesForConflicts}!rbf.cpp@{rbf.cpp}}
\doxysubsubsection{GetEntriesForConflicts()}
{\footnotesize\ttfamily \label{policy_2rbf_8cpp_aff72d993cabe4197acdf58571fdd588d} 
std\+::optional$<$ std\+::string $>$ Get\+Entries\+For\+Conflicts (\begin{DoxyParamCaption}\item[{const \textbf{ CTransaction} \&}]{tx}{, }\item[{\textbf{ CTx\+Mem\+Pool} \&}]{pool}{, }\item[{const \textbf{ CTx\+Mem\+Pool\+::set\+Entries} \&}]{iters\+\_\+conflicting}{, }\item[{\textbf{ CTx\+Mem\+Pool\+::set\+Entries} \&}]{all\+\_\+conflicts}{}\end{DoxyParamCaption})}

Get all descendants of iters\+\_\+conflicting. Checks that there are no more than MAX\+\_\+\+REPLACEMENT\+\_\+\+CANDIDATES distinct clusters affected.


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{in}}  & {\em iters\+\_\+conflicting} & The set of iterators to mempool entries. \\
\hline
\mbox{\texttt{out}}  & {\em all\+\_\+conflicts} & Populated with all the mempool entries that would be replaced, which includes iters\+\_\+conflicting and all entries\textquotesingle{} descendants. Not cleared at the start; any existing mempool entries will remain in the set. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
an error message if the number of affected clusters would exceed MAX\+\_\+\+REPLACEMENT\+\_\+\+CANDIDATES, std\+::nullopt otherwise 
\end{DoxyReturn}
\index{rbf.cpp@{rbf.cpp}!ImprovesFeerateDiagram@{ImprovesFeerateDiagram}}
\index{ImprovesFeerateDiagram@{ImprovesFeerateDiagram}!rbf.cpp@{rbf.cpp}}
\doxysubsubsection{ImprovesFeerateDiagram()}
{\footnotesize\ttfamily \label{policy_2rbf_8cpp_a2d2f7e53b191b3f5423576a727b2f8e1} 
std\+::optional$<$ std\+::pair$<$ \textbf{ Diagram\+Check\+Error}, std\+::string $>$ $>$ Improves\+Feerate\+Diagram (\begin{DoxyParamCaption}\item[{\textbf{ CTx\+Mem\+Pool\+::\+Change\+Set} \&}]{changeset}{}\end{DoxyParamCaption})}

The replacement transaction must improve the feerate diagram of the mempool. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{in}}  & {\em changeset} & The changeset containing proposed additions/removals \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
error type and string if mempool diagram doesn\textquotesingle{}t improve, otherwise std\+::nullopt. 
\end{DoxyReturn}
\index{rbf.cpp@{rbf.cpp}!IsRBFOptIn@{IsRBFOptIn}}
\index{IsRBFOptIn@{IsRBFOptIn}!rbf.cpp@{rbf.cpp}}
\doxysubsubsection{IsRBFOptIn()}
{\footnotesize\ttfamily \label{policy_2rbf_8cpp_af064c2148a1866c2d9cac8c2b245849a} 
\textbf{ RBFTransaction\+State} Is\+RBFOpt\+In (\begin{DoxyParamCaption}\item[{const \textbf{ CTransaction} \&}]{tx}{, }\item[{const \textbf{ CTx\+Mem\+Pool} \&}]{pool}{}\end{DoxyParamCaption})}

Determine whether an unconfirmed transaction is signaling opt-\/in to RBF according to BIP 125 This involves checking sequence numbers of the transaction, as well as the sequence numbers of all in-\/mempool ancestors.


\begin{DoxyParams}{Parameters}
{\em tx} & The unconfirmed transaction \\
\hline
{\em pool} & The mempool, which may contain the tx\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The rbf state 
\end{DoxyReturn}
\index{rbf.cpp@{rbf.cpp}!IsRBFOptInEmptyMempool@{IsRBFOptInEmptyMempool}}
\index{IsRBFOptInEmptyMempool@{IsRBFOptInEmptyMempool}!rbf.cpp@{rbf.cpp}}
\doxysubsubsection{IsRBFOptInEmptyMempool()}
{\footnotesize\ttfamily \label{policy_2rbf_8cpp_a86fe76f7bbf47145e335d6ef05a55950} 
\textbf{ RBFTransaction\+State} Is\+RBFOpt\+In\+Empty\+Mempool (\begin{DoxyParamCaption}\item[{const \textbf{ CTransaction} \&}]{tx}{}\end{DoxyParamCaption})}

\index{rbf.cpp@{rbf.cpp}!PaysForRBF@{PaysForRBF}}
\index{PaysForRBF@{PaysForRBF}!rbf.cpp@{rbf.cpp}}
\doxysubsubsection{PaysForRBF()}
{\footnotesize\ttfamily \label{policy_2rbf_8cpp_a96e243683f646a5bc2a53eca61b4d1e9} 
std\+::optional$<$ std\+::string $>$ Pays\+For\+RBF (\begin{DoxyParamCaption}\item[{\textbf{ CAmount}}]{original\+\_\+fees}{, }\item[{\textbf{ CAmount}}]{replacement\+\_\+fees}{, }\item[{size\+\_\+t}]{replacement\+\_\+vsize}{, }\item[{\textbf{ CFee\+Rate}}]{relay\+\_\+fee}{, }\item[{const \textbf{ Txid} \&}]{txid}{}\end{DoxyParamCaption})}

The replacement transaction must pay more fees than the original transactions. The additional fees must pay for the replacement\textquotesingle{}s bandwidth at or above the incremental relay feerate. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{in}}  & {\em original\+\_\+fees} & Total modified fees of original transaction(s). \\
\hline
\mbox{\texttt{in}}  & {\em replacement\+\_\+fees} & Total modified fees of replacement transaction(s). \\
\hline
\mbox{\texttt{in}}  & {\em replacement\+\_\+vsize} & Total virtual size of replacement transaction(s). \\
\hline
\mbox{\texttt{in}}  & {\em relay\+\_\+fee} & The node\textquotesingle{}s minimum feerate for transaction relay. \\
\hline
\mbox{\texttt{in}}  & {\em txid} & Transaction ID, included in the error message if violation occurs. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
error string if fees are insufficient, otherwise std\+::nullopt. 
\end{DoxyReturn}
