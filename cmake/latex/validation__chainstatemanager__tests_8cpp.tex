\doxysection{src/test/validation\+\_\+chainstatemanager\+\_\+tests.cpp File Reference}
\label{validation__chainstatemanager__tests_8cpp}\index{src/test/validation\_chainstatemanager\_tests.cpp@{src/test/validation\_chainstatemanager\_tests.cpp}}
{\ttfamily \#include $<$chainparams.\+h$>$}\newline
{\ttfamily \#include $<$consensus/validation.\+h$>$}\newline
{\ttfamily \#include $<$kernel/disconnected\+\_\+transactions.\+h$>$}\newline
{\ttfamily \#include $<$node/chainstatemanager\+\_\+args.\+h$>$}\newline
{\ttfamily \#include $<$node/kernel\+\_\+notifications.\+h$>$}\newline
{\ttfamily \#include $<$node/utxo\+\_\+snapshot.\+h$>$}\newline
{\ttfamily \#include $<$random.\+h$>$}\newline
{\ttfamily \#include $<$rpc/blockchain.\+h$>$}\newline
{\ttfamily \#include $<$sync.\+h$>$}\newline
{\ttfamily \#include $<$test/util/chainstate.\+h$>$}\newline
{\ttfamily \#include $<$test/util/logging.\+h$>$}\newline
{\ttfamily \#include $<$test/util/random.\+h$>$}\newline
{\ttfamily \#include $<$test/util/setup\+\_\+common.\+h$>$}\newline
{\ttfamily \#include $<$test/util/validation.\+h$>$}\newline
{\ttfamily \#include $<$uint256.\+h$>$}\newline
{\ttfamily \#include $<$util/result.\+h$>$}\newline
{\ttfamily \#include $<$util/vector.\+h$>$}\newline
{\ttfamily \#include $<$validation.\+h$>$}\newline
{\ttfamily \#include $<$validationinterface.\+h$>$}\newline
{\ttfamily \#include $<$tinyformat.\+h$>$}\newline
{\ttfamily \#include $<$vector$>$}\newline
{\ttfamily \#include $<$boost/test/unit\+\_\+test.\+hpp$>$}\newline
\doxysubsubsection*{Data Structures}
\begin{DoxyCompactItemize}
\item 
struct \textbf{ Snapshot\+Test\+Setup}
\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\textbf{ BOOST\+\_\+\+FIXTURE\+\_\+\+TEST\+\_\+\+CASE} (chainstatemanager, \textbf{ Test\+Chain100\+Setup})
\item 
\textbf{ BOOST\+\_\+\+FIXTURE\+\_\+\+TEST\+\_\+\+CASE} (chainstatemanager\+\_\+rebalance\+\_\+caches, \textbf{ Test\+Chain100\+Setup})
\begin{DoxyCompactList}\small\item\em Test rebalancing the caches associated with each chainstate. \end{DoxyCompactList}\item 
\textbf{ BOOST\+\_\+\+FIXTURE\+\_\+\+TEST\+\_\+\+CASE} (chainstatemanager\+\_\+activate\+\_\+snapshot, \textbf{ Snapshot\+Test\+Setup})
\begin{DoxyCompactList}\small\item\em Test basic snapshot activation. \end{DoxyCompactList}\item 
\textbf{ BOOST\+\_\+\+FIXTURE\+\_\+\+TEST\+\_\+\+CASE} (chainstatemanager\+\_\+loadblockindex, \textbf{ Test\+Chain100\+Setup})
\item 
\textbf{ BOOST\+\_\+\+FIXTURE\+\_\+\+TEST\+\_\+\+CASE} (chainstatemanager\+\_\+snapshot\+\_\+init, \textbf{ Snapshot\+Test\+Setup})
\item 
\textbf{ BOOST\+\_\+\+FIXTURE\+\_\+\+TEST\+\_\+\+CASE} (chainstatemanager\+\_\+snapshot\+\_\+completion, \textbf{ Snapshot\+Test\+Setup})
\item 
\textbf{ BOOST\+\_\+\+FIXTURE\+\_\+\+TEST\+\_\+\+CASE} (chainstatemanager\+\_\+snapshot\+\_\+completion\+\_\+hash\+\_\+mismatch, \textbf{ Snapshot\+Test\+Setup})
\item 
{\footnotesize template$<$typename \textbf{ Options}$>$ }\\\textbf{ util\+::\+Result}$<$ \textbf{ Options} $>$ \textbf{ Set\+Opts\+From\+Args} (\textbf{ Args\+Manager} \&args\+\_\+man, \textbf{ Options} opts, const std\+::vector$<$ const char $\ast$ $>$ \&\textbf{ args})
\item 
\textbf{ BOOST\+\_\+\+FIXTURE\+\_\+\+TEST\+\_\+\+CASE} (chainstatemanager\+\_\+args, \textbf{ Basic\+Testing\+Setup})
\end{DoxyCompactItemize}


\label{doc-func-members}
\doxysubsection{Function Documentation}
\index{validation\_chainstatemanager\_tests.cpp@{validation\_chainstatemanager\_tests.cpp}!BOOST\_FIXTURE\_TEST\_CASE@{BOOST\_FIXTURE\_TEST\_CASE}}
\index{BOOST\_FIXTURE\_TEST\_CASE@{BOOST\_FIXTURE\_TEST\_CASE}!validation\_chainstatemanager\_tests.cpp@{validation\_chainstatemanager\_tests.cpp}}
\doxysubsubsection{BOOST\_FIXTURE\_TEST\_CASE()\hspace{0.1cm}{\footnotesize\ttfamily [1/8]}}
{\footnotesize\ttfamily \label{validation__chainstatemanager__tests_8cpp_a301705121873dc1f0740853d8b4e69dd} 
BOOST\+\_\+\+FIXTURE\+\_\+\+TEST\+\_\+\+CASE (\begin{DoxyParamCaption}\item[{chainstatemanager}]{}{, }\item[{\textbf{ Test\+Chain100\+Setup}}]{}{}\end{DoxyParamCaption})}

Basic tests for \doxyref{Chainstate\+Manager}{p.}{class_chainstate_manager}.

First create a legacy (IBD) chainstate, then create a snapshot chainstate. \index{validation\_chainstatemanager\_tests.cpp@{validation\_chainstatemanager\_tests.cpp}!BOOST\_FIXTURE\_TEST\_CASE@{BOOST\_FIXTURE\_TEST\_CASE}}
\index{BOOST\_FIXTURE\_TEST\_CASE@{BOOST\_FIXTURE\_TEST\_CASE}!validation\_chainstatemanager\_tests.cpp@{validation\_chainstatemanager\_tests.cpp}}
\doxysubsubsection{BOOST\_FIXTURE\_TEST\_CASE()\hspace{0.1cm}{\footnotesize\ttfamily [2/8]}}
{\footnotesize\ttfamily \label{validation__chainstatemanager__tests_8cpp_a61cddb2ff38dfc956f408627426ad831} 
BOOST\+\_\+\+FIXTURE\+\_\+\+TEST\+\_\+\+CASE (\begin{DoxyParamCaption}\item[{chainstatemanager\+\_\+activate\+\_\+snapshot}]{}{, }\item[{\textbf{ Snapshot\+Test\+Setup}}]{}{}\end{DoxyParamCaption})}



Test basic snapshot activation. 

\index{validation\_chainstatemanager\_tests.cpp@{validation\_chainstatemanager\_tests.cpp}!BOOST\_FIXTURE\_TEST\_CASE@{BOOST\_FIXTURE\_TEST\_CASE}}
\index{BOOST\_FIXTURE\_TEST\_CASE@{BOOST\_FIXTURE\_TEST\_CASE}!validation\_chainstatemanager\_tests.cpp@{validation\_chainstatemanager\_tests.cpp}}
\doxysubsubsection{BOOST\_FIXTURE\_TEST\_CASE()\hspace{0.1cm}{\footnotesize\ttfamily [3/8]}}
{\footnotesize\ttfamily \label{validation__chainstatemanager__tests_8cpp_a7ab8b31a5eb81b78d599a519a1d46ae4} 
BOOST\+\_\+\+FIXTURE\+\_\+\+TEST\+\_\+\+CASE (\begin{DoxyParamCaption}\item[{chainstatemanager\+\_\+args}]{}{, }\item[{\textbf{ Basic\+Testing\+Setup}}]{}{}\end{DoxyParamCaption})}

Try to apply the provided args to a \doxyref{Chainstate\+Manager\+::\+Options}{p.}{class_chainstate_manager_a66bc0ee7102eaf1cbd62d3a9d7087e52}

Like get\+\_\+opts, but requires the provided args to be valid and unwraps the result\index{validation\_chainstatemanager\_tests.cpp@{validation\_chainstatemanager\_tests.cpp}!BOOST\_FIXTURE\_TEST\_CASE@{BOOST\_FIXTURE\_TEST\_CASE}}
\index{BOOST\_FIXTURE\_TEST\_CASE@{BOOST\_FIXTURE\_TEST\_CASE}!validation\_chainstatemanager\_tests.cpp@{validation\_chainstatemanager\_tests.cpp}}
\doxysubsubsection{BOOST\_FIXTURE\_TEST\_CASE()\hspace{0.1cm}{\footnotesize\ttfamily [4/8]}}
{\footnotesize\ttfamily \label{validation__chainstatemanager__tests_8cpp_a3a3fe29418d2d46e55ccbc85af3b2b1d} 
BOOST\+\_\+\+FIXTURE\+\_\+\+TEST\+\_\+\+CASE (\begin{DoxyParamCaption}\item[{chainstatemanager\+\_\+loadblockindex}]{}{, }\item[{\textbf{ Test\+Chain100\+Setup}}]{}{}\end{DoxyParamCaption})}

Test Load\+Block\+Index behavior when multiple chainstates are in use.


\begin{DoxyItemize}
\item First, verify that set\+Block\+Index\+Candidates is as expected when using a single, fully-\/validating chainstate.
\item Then mark a region of the chain as missing data and introduce a second chainstate that will tolerate assumed-\/valid blocks. Run Load\+Block\+Index() and ensure that the first chainstate only contains fully validated blocks and the other chainstate contains all blocks, except those marked assume-\/valid, because those entries don\textquotesingle{}t HAVE\+\_\+\+DATA. 
\end{DoxyItemize}\index{validation\_chainstatemanager\_tests.cpp@{validation\_chainstatemanager\_tests.cpp}!BOOST\_FIXTURE\_TEST\_CASE@{BOOST\_FIXTURE\_TEST\_CASE}}
\index{BOOST\_FIXTURE\_TEST\_CASE@{BOOST\_FIXTURE\_TEST\_CASE}!validation\_chainstatemanager\_tests.cpp@{validation\_chainstatemanager\_tests.cpp}}
\doxysubsubsection{BOOST\_FIXTURE\_TEST\_CASE()\hspace{0.1cm}{\footnotesize\ttfamily [5/8]}}
{\footnotesize\ttfamily \label{validation__chainstatemanager__tests_8cpp_aa8c4bdd4e1e5b33b2969d25c974c1217} 
BOOST\+\_\+\+FIXTURE\+\_\+\+TEST\+\_\+\+CASE (\begin{DoxyParamCaption}\item[{chainstatemanager\+\_\+rebalance\+\_\+caches}]{}{, }\item[{\textbf{ Test\+Chain100\+Setup}}]{}{}\end{DoxyParamCaption})}



Test rebalancing the caches associated with each chainstate. 

\index{validation\_chainstatemanager\_tests.cpp@{validation\_chainstatemanager\_tests.cpp}!BOOST\_FIXTURE\_TEST\_CASE@{BOOST\_FIXTURE\_TEST\_CASE}}
\index{BOOST\_FIXTURE\_TEST\_CASE@{BOOST\_FIXTURE\_TEST\_CASE}!validation\_chainstatemanager\_tests.cpp@{validation\_chainstatemanager\_tests.cpp}}
\doxysubsubsection{BOOST\_FIXTURE\_TEST\_CASE()\hspace{0.1cm}{\footnotesize\ttfamily [6/8]}}
{\footnotesize\ttfamily \label{validation__chainstatemanager__tests_8cpp_ada7b275ae07594dc9562b26cffc7d6f3} 
BOOST\+\_\+\+FIXTURE\+\_\+\+TEST\+\_\+\+CASE (\begin{DoxyParamCaption}\item[{chainstatemanager\+\_\+snapshot\+\_\+completion}]{}{, }\item[{\textbf{ Snapshot\+Test\+Setup}}]{}{}\end{DoxyParamCaption})}

\index{validation\_chainstatemanager\_tests.cpp@{validation\_chainstatemanager\_tests.cpp}!BOOST\_FIXTURE\_TEST\_CASE@{BOOST\_FIXTURE\_TEST\_CASE}}
\index{BOOST\_FIXTURE\_TEST\_CASE@{BOOST\_FIXTURE\_TEST\_CASE}!validation\_chainstatemanager\_tests.cpp@{validation\_chainstatemanager\_tests.cpp}}
\doxysubsubsection{BOOST\_FIXTURE\_TEST\_CASE()\hspace{0.1cm}{\footnotesize\ttfamily [7/8]}}
{\footnotesize\ttfamily \label{validation__chainstatemanager__tests_8cpp_a9e009b1c1d0f716ce5138605a4942a43} 
BOOST\+\_\+\+FIXTURE\+\_\+\+TEST\+\_\+\+CASE (\begin{DoxyParamCaption}\item[{chainstatemanager\+\_\+snapshot\+\_\+completion\+\_\+hash\+\_\+mismatch}]{}{, }\item[{\textbf{ Snapshot\+Test\+Setup}}]{}{}\end{DoxyParamCaption})}

\index{validation\_chainstatemanager\_tests.cpp@{validation\_chainstatemanager\_tests.cpp}!BOOST\_FIXTURE\_TEST\_CASE@{BOOST\_FIXTURE\_TEST\_CASE}}
\index{BOOST\_FIXTURE\_TEST\_CASE@{BOOST\_FIXTURE\_TEST\_CASE}!validation\_chainstatemanager\_tests.cpp@{validation\_chainstatemanager\_tests.cpp}}
\doxysubsubsection{BOOST\_FIXTURE\_TEST\_CASE()\hspace{0.1cm}{\footnotesize\ttfamily [8/8]}}
{\footnotesize\ttfamily \label{validation__chainstatemanager__tests_8cpp_a2b0bd9b1e5eee516db5c844aec4fac82} 
BOOST\+\_\+\+FIXTURE\+\_\+\+TEST\+\_\+\+CASE (\begin{DoxyParamCaption}\item[{chainstatemanager\+\_\+snapshot\+\_\+init}]{}{, }\item[{\textbf{ Snapshot\+Test\+Setup}}]{}{}\end{DoxyParamCaption})}

Ensure that snapshot chainstate can be loaded when found on disk after a restart, and that new blocks can be connected to both chainstates. \index{validation\_chainstatemanager\_tests.cpp@{validation\_chainstatemanager\_tests.cpp}!SetOptsFromArgs@{SetOptsFromArgs}}
\index{SetOptsFromArgs@{SetOptsFromArgs}!validation\_chainstatemanager\_tests.cpp@{validation\_chainstatemanager\_tests.cpp}}
\doxysubsubsection{SetOptsFromArgs()}
{\footnotesize\ttfamily \label{validation__chainstatemanager__tests_8cpp_afe326c1717f474de62b20203113d43a4} 
template$<$typename \textbf{ Options}$>$ \\
\textbf{ util\+::\+Result}$<$ \textbf{ Options} $>$ Set\+Opts\+From\+Args (\begin{DoxyParamCaption}\item[{\textbf{ Args\+Manager} \&}]{args\+\_\+man}{, }\item[{\textbf{ Options}}]{opts}{, }\item[{const std\+::vector$<$ const char $\ast$ $>$ \&}]{args}{}\end{DoxyParamCaption})}

Helper function to parse args into args\+\_\+man and return the result of applying them to opts 