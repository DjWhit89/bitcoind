\doxysection{validation.\+h}
\label{consensus_2validation_8h_source}\index{src/consensus/validation.h@{src/consensus/validation.h}}
\textbf{ Go to the documentation of this file.}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ Copyright\ (c)\ 2009-\/2010\ Satoshi\ Nakamoto}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ Copyright\ (c)\ 2009-\/present\ The\ Bitcoin\ Core\ developers}}
\DoxyCodeLine{00003\ \textcolor{comment}{//\ Distributed\ under\ the\ MIT\ software\ license,\ see\ the\ accompanying}}
\DoxyCodeLine{00004\ \textcolor{comment}{//\ file\ COPYING\ or\ http://www.opensource.org/licenses/mit-\/license.php.}}
\DoxyCodeLine{00005\ }
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#ifndef\ BITCOIN\_CONSENSUS\_VALIDATION\_H}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#define\ BITCOIN\_CONSENSUS\_VALIDATION\_H}}
\DoxyCodeLine{00008\ }
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ <string>}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ <consensus/consensus.h>}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ <primitives/transaction.h>}}
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#include\ <primitives/block.h>}}
\DoxyCodeLine{00013\ }
\DoxyCodeLine{00015\ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ \textcolor{keywordtype}{int}\ NO\_WITNESS\_COMMITMENT\{-\/1\};}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00018\ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ \textcolor{keywordtype}{size\_t}\ MINIMUM\_WITNESS\_COMMITMENT\{38\};}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00023\ \textcolor{keyword}{enum\ class}\ TxValidationResult\ \{}
\DoxyCodeLine{00024\ \ \ \ \ TX\_RESULT\_UNSET\ =\ 0,\ \ \ \ \ }
\DoxyCodeLine{00025\ \ \ \ \ TX\_CONSENSUS,\ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00026\ \ \ \ \ TX\_INPUTS\_NOT\_STANDARD,\ \ \ }
\DoxyCodeLine{00027\ \ \ \ \ TX\_NOT\_STANDARD,\ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00028\ \ \ \ \ TX\_MISSING\_INPUTS,\ \ \ \ \ \ \ \ }
\DoxyCodeLine{00029\ \ \ \ \ TX\_PREMATURE\_SPEND,\ \ \ \ \ \ \ }
\DoxyCodeLine{00035\ \ \ \ \ TX\_WITNESS\_MUTATED,}
\DoxyCodeLine{00039\ \ \ \ \ TX\_WITNESS\_STRIPPED,}
\DoxyCodeLine{00045\ \ \ \ \ TX\_CONFLICT,}
\DoxyCodeLine{00046\ \ \ \ \ TX\_MEMPOOL\_POLICY,\ \ \ \ \ \ \ \ }
\DoxyCodeLine{00047\ \ \ \ \ TX\_NO\_MEMPOOL,\ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00048\ \ \ \ \ TX\_RECONSIDERABLE,\ \ \ \ \ \ \ \ }
\DoxyCodeLine{00049\ \ \ \ \ TX\_UNKNOWN,\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00050\ \};}
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00057\ \textcolor{keyword}{enum\ class}\ BlockValidationResult\ \{}
\DoxyCodeLine{00058\ \ \ \ \ BLOCK\_RESULT\_UNSET\ =\ 0,\ \ }
\DoxyCodeLine{00059\ \ \ \ \ BLOCK\_CONSENSUS,\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00060\ \ \ \ \ BLOCK\_CACHED\_INVALID,\ \ \ \ }
\DoxyCodeLine{00061\ \ \ \ \ BLOCK\_INVALID\_HEADER,\ \ \ \ }
\DoxyCodeLine{00062\ \ \ \ \ BLOCK\_MUTATED,\ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00063\ \ \ \ \ BLOCK\_MISSING\_PREV,\ \ \ \ \ \ }
\DoxyCodeLine{00064\ \ \ \ \ BLOCK\_INVALID\_PREV,\ \ \ \ \ \ }
\DoxyCodeLine{00065\ \ \ \ \ BLOCK\_TIME\_FUTURE,\ \ \ \ \ \ \ }
\DoxyCodeLine{00066\ \ \ \ \ BLOCK\_HEADER\_LOW\_WORK\ \ \ \ }
\DoxyCodeLine{00067\ \};}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ }
\DoxyCodeLine{00074\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Result>}
\DoxyCodeLine{00075\ \textcolor{keyword}{class\ }ValidationState}
\DoxyCodeLine{00076\ \{}
\DoxyCodeLine{00077\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00078\ \ \ \ \ \textcolor{keyword}{enum\ class}\ ModeState\ \{}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ M\_VALID,\ \ \ }
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ M\_INVALID,\ }
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ M\_ERROR,\ \ \ }
\DoxyCodeLine{00082\ \ \ \ \ \}\ m\_mode\{ModeState::M\_VALID\};}
\DoxyCodeLine{00083\ \ \ \ \ Result\ m\_result\{\};}
\DoxyCodeLine{00084\ \ \ \ \ std::string\ m\_reject\_reason;}
\DoxyCodeLine{00085\ \ \ \ \ std::string\ m\_debug\_message;}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00087\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00088\ \ \ \ \ \textcolor{keywordtype}{bool}\ Invalid(Result\ result,}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ std::string\&\ reject\_reason\ =\ \textcolor{stringliteral}{"{}"{}},}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ std::string\&\ debug\_message\ =\ \textcolor{stringliteral}{"{}"{}})}
\DoxyCodeLine{00091\ \ \ \ \ \{}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ m\_result\ =\ result;}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ m\_reject\_reason\ =\ reject\_reason;}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ m\_debug\_message\ =\ debug\_message;}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_mode\ !=\ ModeState::M\_ERROR)\ m\_mode\ =\ ModeState::M\_INVALID;}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00097\ \ \ \ \ \}}
\DoxyCodeLine{00098\ \ \ \ \ \textcolor{keywordtype}{bool}\ Error(\textcolor{keyword}{const}\ std::string\&\ reject\_reason)}
\DoxyCodeLine{00099\ \ \ \ \ \{}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_mode\ ==\ ModeState::M\_VALID)}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ \ \ \ \ m\_reject\_reason\ =\ reject\_reason;}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ m\_mode\ =\ ModeState::M\_ERROR;}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00104\ \ \ \ \ \}}
\DoxyCodeLine{00105\ \ \ \ \ \textcolor{keywordtype}{bool}\ IsValid()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ m\_mode\ ==\ ModeState::M\_VALID;\ \}}
\DoxyCodeLine{00106\ \ \ \ \ \textcolor{keywordtype}{bool}\ IsInvalid()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ m\_mode\ ==\ ModeState::M\_INVALID;\ \}}
\DoxyCodeLine{00107\ \ \ \ \ \textcolor{keywordtype}{bool}\ IsError()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ m\_mode\ ==\ ModeState::M\_ERROR;\ \}}
\DoxyCodeLine{00108\ \ \ \ \ Result\ GetResult()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ m\_result;\ \}}
\DoxyCodeLine{00109\ \ \ \ \ std::string\ GetRejectReason()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ m\_reject\_reason;\ \}}
\DoxyCodeLine{00110\ \ \ \ \ std::string\ GetDebugMessage()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ m\_debug\_message;\ \}}
\DoxyCodeLine{00111\ \ \ \ \ std::string\ ToString()\textcolor{keyword}{\ const}}
\DoxyCodeLine{00112\ \textcolor{keyword}{\ \ \ \ }\{}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (IsValid())\ \{}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{stringliteral}{"{}Valid"{}};}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00116\ }
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!m\_debug\_message.empty())\ \{}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ m\_reject\_reason\ +\ \textcolor{stringliteral}{"{},\ "{}}\ +\ m\_debug\_message;}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ m\_reject\_reason;}
\DoxyCodeLine{00122\ \ \ \ \ \}}
\DoxyCodeLine{00123\ \};}
\DoxyCodeLine{00124\ }
\DoxyCodeLine{00125\ \textcolor{keyword}{class\ }TxValidationState\ :\ \textcolor{keyword}{public}\ ValidationState<TxValidationResult>\ \{\};}
\DoxyCodeLine{00126\ \textcolor{keyword}{class\ }BlockValidationState\ :\ \textcolor{keyword}{public}\ ValidationState<BlockValidationResult>\ \{\};}
\DoxyCodeLine{00127\ }
\DoxyCodeLine{00128\ \textcolor{comment}{//\ These\ implement\ the\ weight\ =\ (stripped\_size\ *\ 4)\ +\ witness\_size\ formula,}}
\DoxyCodeLine{00129\ \textcolor{comment}{//\ using\ only\ serialization\ with\ and\ without\ witness\ data.\ As\ witness\_size}}
\DoxyCodeLine{00130\ \textcolor{comment}{//\ is\ equal\ to\ total\_size\ -\/\ stripped\_size,\ this\ formula\ is\ identical\ to:}}
\DoxyCodeLine{00131\ \textcolor{comment}{//\ weight\ =\ (stripped\_size\ *\ 3)\ +\ total\_size.}}
\DoxyCodeLine{00132\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ int32\_t\ GetTransactionWeight(\textcolor{keyword}{const}\ CTransaction\&\ tx)}
\DoxyCodeLine{00133\ \{}
\DoxyCodeLine{00134\ \ \ \ \ return\ ::GetSerializeSize(TX\_NO\_WITNESS(tx))\ *\ (WITNESS\_SCALE\_FACTOR\ -\/\ 1)\ +\ ::GetSerializeSize(TX\_WITH\_WITNESS(tx));}
\DoxyCodeLine{00135\ \}}
\DoxyCodeLine{00136\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ int64\_t\ GetBlockWeight(\textcolor{keyword}{const}\ CBlock\&\ block)}
\DoxyCodeLine{00137\ \{}
\DoxyCodeLine{00138\ \ \ \ \ return\ ::GetSerializeSize(TX\_NO\_WITNESS(block))\ *\ (WITNESS\_SCALE\_FACTOR\ -\/\ 1)\ +\ ::GetSerializeSize(TX\_WITH\_WITNESS(block));}
\DoxyCodeLine{00139\ \}}
\DoxyCodeLine{00140\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ int64\_t\ GetTransactionInputWeight(\textcolor{keyword}{const}\ CTxIn\&\ txin)}
\DoxyCodeLine{00141\ \{}
\DoxyCodeLine{00142\ \ \ \ \ \textcolor{comment}{//\ scriptWitness\ size\ is\ added\ here\ because\ witnesses\ and\ txins\ are\ split\ up\ in\ segwit\ serialization.}}
\DoxyCodeLine{00143\ \ \ \ \ return\ ::GetSerializeSize(TX\_NO\_WITNESS(txin))\ *\ (WITNESS\_SCALE\_FACTOR\ -\/\ 1)\ +\ ::GetSerializeSize(TX\_WITH\_WITNESS(txin))\ +\ ::GetSerializeSize(txin.scriptWitness.stack);}
\DoxyCodeLine{00144\ \}}
\DoxyCodeLine{00145\ }
\DoxyCodeLine{00147\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{int}\ GetWitnessCommitmentIndex(\textcolor{keyword}{const}\ CBlock\&\ block)}
\DoxyCodeLine{00148\ \{}
\DoxyCodeLine{00149\ \ \ \ \ \textcolor{keywordtype}{int}\ commitpos\ =\ NO\_WITNESS\_COMMITMENT;}
\DoxyCodeLine{00150\ \ \ \ \ \textcolor{keywordflow}{if}\ (!block.vtx.empty())\ \{}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ o\ =\ 0;\ o\ <\ block.vtx[0]-\/>vout.size();\ o++)\ \{}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ CTxOut\&\ vout\ =\ block.vtx[0]-\/>vout[o];}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (vout.scriptPubKey.size()\ >=\ MINIMUM\_WITNESS\_COMMITMENT\ \&\&}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ vout.scriptPubKey[0]\ ==\ OP\_RETURN\ \&\&}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ vout.scriptPubKey[1]\ ==\ 0x24\ \&\&}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ vout.scriptPubKey[2]\ ==\ 0xaa\ \&\&}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ vout.scriptPubKey[3]\ ==\ 0x21\ \&\&}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ vout.scriptPubKey[4]\ ==\ 0xa9\ \&\&}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ vout.scriptPubKey[5]\ ==\ 0xed)\ \{}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ commitpos\ =\ o;}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00163\ \ \ \ \ \}}
\DoxyCodeLine{00164\ \ \ \ \ \textcolor{keywordflow}{return}\ commitpos;}
\DoxyCodeLine{00165\ \}}
\DoxyCodeLine{00166\ }
\DoxyCodeLine{00167\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ BITCOIN\_CONSENSUS\_VALIDATION\_H}}

\end{DoxyCode}
