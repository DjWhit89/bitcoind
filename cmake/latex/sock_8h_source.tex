\doxysection{sock.\+h}
\label{sock_8h_source}\index{src/util/sock.h@{src/util/sock.h}}
\textbf{ Go to the documentation of this file.}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ Copyright\ (c)\ 2020-\/present\ The\ Bitcoin\ Core\ developers}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ Distributed\ under\ the\ MIT\ software\ license,\ see\ the\ accompanying}}
\DoxyCodeLine{00003\ \textcolor{comment}{//\ file\ COPYING\ or\ http://www.opensource.org/licenses/mit-\/license.php.}}
\DoxyCodeLine{00004\ }
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#ifndef\ BITCOIN\_UTIL\_SOCK\_H}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#define\ BITCOIN\_UTIL\_SOCK\_H}}
\DoxyCodeLine{00007\ }
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ <compat/compat.h>}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ <util/threadinterrupt.h>}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ <util/time.h>}}
\DoxyCodeLine{00011\ }
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#include\ <chrono>}}
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#include\ <memory>}}
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ <string>}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ <unordered\_map>}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00021\ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ \textcolor{keyword}{auto}\ MAX\_WAIT\_FOR\_IO\ =\ 1s;}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00026\ \textcolor{keyword}{class\ }Sock}
\DoxyCodeLine{00027\ \{}
\DoxyCodeLine{00028\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00029\ \ \ \ \ Sock()\ =\ \textcolor{keyword}{delete};}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00034\ \ \ \ \ \textcolor{keyword}{explicit}\ Sock(SOCKET\ s);}
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00039\ \ \ \ \ Sock(\textcolor{keyword}{const}\ Sock\&)\ =\ \textcolor{keyword}{delete};}
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00044\ \ \ \ \ Sock(Sock\&\&\ other);}
\DoxyCodeLine{00045\ }
\DoxyCodeLine{00049\ \ \ \ \ \textcolor{keyword}{virtual}\ \string~Sock();}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00054\ \ \ \ \ Sock\&\ operator=(\textcolor{keyword}{const}\ Sock\&)\ =\ \textcolor{keyword}{delete};}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00059\ \ \ \ \ \textcolor{keyword}{virtual}\ Sock\&\ operator=(Sock\&\&\ other);}
\DoxyCodeLine{00060\ }
\DoxyCodeLine{00065\ \ \ \ \ [[nodiscard]]\ \textcolor{keyword}{virtual}\ ssize\_t\ Send(\textcolor{keyword}{const}\ \textcolor{keywordtype}{void}*\ data,\ \textcolor{keywordtype}{size\_t}\ len,\ \textcolor{keywordtype}{int}\ flags)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00071\ \ \ \ \ [[nodiscard]]\ \textcolor{keyword}{virtual}\ ssize\_t\ Recv(\textcolor{keywordtype}{void}*\ buf,\ \textcolor{keywordtype}{size\_t}\ len,\ \textcolor{keywordtype}{int}\ flags)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00072\ }
\DoxyCodeLine{00077\ \ \ \ \ [[nodiscard]]\ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{int}\ Connect(\textcolor{keyword}{const}\ sockaddr*\ addr,\ socklen\_t\ addr\_len)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00083\ \ \ \ \ [[nodiscard]]\ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{int}\ Bind(\textcolor{keyword}{const}\ sockaddr*\ addr,\ socklen\_t\ addr\_len)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00089\ \ \ \ \ [[nodiscard]]\ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{int}\ Listen(\textcolor{keywordtype}{int}\ backlog)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00090\ }
\DoxyCodeLine{00097\ \ \ \ \ [[nodiscard]]\ \textcolor{keyword}{virtual}\ std::unique\_ptr<Sock>\ Accept(sockaddr*\ addr,\ socklen\_t*\ addr\_len)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00098\ }
\DoxyCodeLine{00104\ \ \ \ \ [[nodiscard]]\ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{int}\ GetSockOpt(\textcolor{keywordtype}{int}\ level,}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ opt\_name,}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{void}*\ opt\_val,}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ socklen\_t*\ opt\_len)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00114\ \ \ \ \ [[nodiscard]]\ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{int}\ SetSockOpt(\textcolor{keywordtype}{int}\ level,}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ opt\_name,}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{void}*\ opt\_val,}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ socklen\_t\ opt\_len)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00118\ }
\DoxyCodeLine{00124\ \ \ \ \ [[nodiscard]]\ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{int}\ GetSockName(sockaddr*\ name,\ socklen\_t*\ name\_len)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00125\ }
\DoxyCodeLine{00130\ \ \ \ \ [[nodiscard]]\ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{bool}\ SetNonBlocking()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00136\ \ \ \ \ [[nodiscard]]\ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{bool}\ IsSelectable()\ \textcolor{keyword}{const};}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ \ \ \ \ \textcolor{keyword}{using\ }Event\ =\ uint8\_t;}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00143\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ Event\ RECV\ =\ 0b001;}
\DoxyCodeLine{00144\ }
\DoxyCodeLine{00148\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ Event\ SEND\ =\ 0b010;}
\DoxyCodeLine{00149\ }
\DoxyCodeLine{00154\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ Event\ ERR\ =\ 0b100;}
\DoxyCodeLine{00155\ }
\DoxyCodeLine{00166\ \ \ \ \ [[nodiscard]]\ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{bool}\ Wait(std::chrono::milliseconds\ timeout,}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Event\ requested,}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Event*\ occurred\ =\ \textcolor{keyword}{nullptr})\ \textcolor{keyword}{const};}
\DoxyCodeLine{00169\ }
\DoxyCodeLine{00173\ \ \ \ \ \textcolor{keyword}{struct\ }Events\ \{}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \ \ \textcolor{keyword}{explicit}\ Events(Event\ req)\ :\ requested\{req\}\ \{\}}
\DoxyCodeLine{00175\ \ \ \ \ \ \ \ \ Event\ requested;}
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ Event\ occurred\{0\};}
\DoxyCodeLine{00177\ \ \ \ \ \};}
\DoxyCodeLine{00178\ }
\DoxyCodeLine{00179\ \ \ \ \ \textcolor{keyword}{struct\ }HashSharedPtrSock\ \{}
\DoxyCodeLine{00180\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ operator()(\textcolor{keyword}{const}\ std::shared\_ptr<const\ Sock>\&\ s)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00181\ \textcolor{keyword}{\ \ \ \ \ \ \ \ }\{}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ s\ ?\ s-\/>m\_socket\ :\ std::numeric\_limits<SOCKET>::max();}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00184\ \ \ \ \ \};}
\DoxyCodeLine{00185\ }
\DoxyCodeLine{00186\ \ \ \ \ \textcolor{keyword}{struct\ }EqualSharedPtrSock\ \{}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ operator()(\textcolor{keyword}{const}\ std::shared\_ptr<const\ Sock>\&\ lhs,}
\DoxyCodeLine{00188\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ std::shared\_ptr<const\ Sock>\&\ rhs)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00189\ \textcolor{keyword}{\ \ \ \ \ \ \ \ }\{}
\DoxyCodeLine{00190\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (lhs\ \&\&\ rhs)\ \{}
\DoxyCodeLine{00191\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ lhs-\/>m\_socket\ ==\ rhs-\/>m\_socket;}
\DoxyCodeLine{00192\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00193\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!lhs\ \&\&\ !rhs)\ \{}
\DoxyCodeLine{00194\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00196\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00197\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00198\ \ \ \ \ \};}
\DoxyCodeLine{00199\ }
\DoxyCodeLine{00208\ \ \ \ \ \textcolor{keyword}{using\ }EventsPerSock\ =\ std::unordered\_map<std::shared\_ptr<const\ Sock>,\ Events,\ HashSharedPtrSock,\ EqualSharedPtrSock>;}
\DoxyCodeLine{00209\ }
\DoxyCodeLine{00218\ \ \ \ \ [[nodiscard]]\ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{bool}\ WaitMany(std::chrono::milliseconds\ timeout,}
\DoxyCodeLine{00219\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ EventsPerSock\&\ events\_per\_sock)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00220\ }
\DoxyCodeLine{00221\ \ \ \ \ \textcolor{comment}{/*\ Higher\ level,\ convenience,\ methods.\ These\ may\ throw.\ */}}
\DoxyCodeLine{00222\ }
\DoxyCodeLine{00231\ \ \ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{void}\ SendComplete(std::span<const\ unsigned\ char>\ data,}
\DoxyCodeLine{00232\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::chrono::milliseconds\ timeout,}
\DoxyCodeLine{00233\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CThreadInterrupt\&\ interrupt)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00234\ }
\DoxyCodeLine{00238\ \ \ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{void}\ SendComplete(std::span<const\ char>\ data,}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::chrono::milliseconds\ timeout,}
\DoxyCodeLine{00240\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CThreadInterrupt\&\ interrupt)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00241\ }
\DoxyCodeLine{00254\ \ \ \ \ [[nodiscard]]\ \textcolor{keyword}{virtual}\ std::string\ RecvUntilTerminator(uint8\_t\ terminator,}
\DoxyCodeLine{00255\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::chrono::milliseconds\ timeout,}
\DoxyCodeLine{00256\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CThreadInterrupt\&\ interrupt,}
\DoxyCodeLine{00257\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ max\_data)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00258\ }
\DoxyCodeLine{00264\ \ \ \ \ [[nodiscard]]\ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{bool}\ IsConnected(std::string\&\ errmsg)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00265\ }
\DoxyCodeLine{00269\ \ \ \ \ \textcolor{keywordtype}{bool}\ operator==(SOCKET\ s)\ \textcolor{keyword}{const};}
\DoxyCodeLine{00270\ }
\DoxyCodeLine{00271\ \textcolor{keyword}{protected}:}
\DoxyCodeLine{00275\ \ \ \ \ SOCKET\ m\_socket;}
\DoxyCodeLine{00276\ }
\DoxyCodeLine{00277\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00281\ \ \ \ \ \textcolor{keywordtype}{void}\ Close();}
\DoxyCodeLine{00282\ \};}
\DoxyCodeLine{00283\ }
\DoxyCodeLine{00285\ std::string\ NetworkErrorString(\textcolor{keywordtype}{int}\ err);}
\DoxyCodeLine{00286\ }
\DoxyCodeLine{00287\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ BITCOIN\_UTIL\_SOCK\_H}}

\end{DoxyCode}
