\doxysection{examples\+\_\+util.\+h}
\label{examples__util_8h_source}\index{src/secp256k1/examples/examples\_util.h@{src/secp256k1/examples/examples\_util.h}}
\textbf{ Go to the documentation of this file.}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{/*************************************************************************}}
\DoxyCodeLine{00002\ \textcolor{comment}{\ *\ Copyright\ (c)\ 2020-\/2021\ Elichai\ Turkel\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ *}}
\DoxyCodeLine{00003\ \textcolor{comment}{\ *\ Distributed\ under\ the\ CC0\ software\ license,\ see\ the\ accompanying\ file\ *}}
\DoxyCodeLine{00004\ \textcolor{comment}{\ *\ EXAMPLES\_COPYING\ or\ https://creativecommons.org/publicdomain/zero/1.0\ *}}
\DoxyCodeLine{00005\ \textcolor{comment}{\ *************************************************************************/}}
\DoxyCodeLine{00006\ }
\DoxyCodeLine{00007\ \textcolor{comment}{/*}}
\DoxyCodeLine{00008\ \textcolor{comment}{\ *\ This\ file\ is\ an\ attempt\ at\ collecting\ best\ practice\ methods\ for\ obtaining\ randomness\ with\ different\ operating\ systems.}}
\DoxyCodeLine{00009\ \textcolor{comment}{\ *\ It\ may\ be\ out-\/of-\/date.\ Consult\ the\ documentation\ of\ the\ operating\ system\ before\ considering\ to\ use\ the\ methods\ below.}}
\DoxyCodeLine{00010\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00011\ \textcolor{comment}{\ *\ Platform\ randomness\ sources:}}
\DoxyCodeLine{00012\ \textcolor{comment}{\ *\ Linux\ \ \ -\/>\ \`{}getrandom(2)`(`sys/random.h`),\ if\ not\ available\ \`{}/dev/urandom`\ should\ be\ used.\ http://man7.org/linux/man-\/pages/man2/getrandom.2.html,\ https://linux.die.net/man/4/urandom}}
\DoxyCodeLine{00013\ \textcolor{comment}{\ *\ macOS\ \ \ -\/>\ \`{}getentropy(2)`(`sys/random.h`),\ if\ not\ available\ \`{}/dev/urandom`\ should\ be\ used.\ https://www.unix.com/man-\/page/mojave/2/getentropy,\ https://opensource.apple.com/source/xnu/xnu-\/517.12.7/bsd/man/man4/random.4.auto.html}}
\DoxyCodeLine{00014\ \textcolor{comment}{\ *\ FreeBSD\ -\/>\ \`{}getrandom(2)`(`sys/random.h`),\ if\ not\ available\ \`{}kern.arandom`\ should\ be\ used.\ https://www.freebsd.org/cgi/man.cgi?query=getrandom,\ https://www.freebsd.org/cgi/man.cgi?query=random\&sektion=4}}
\DoxyCodeLine{00015\ \textcolor{comment}{\ *\ OpenBSD\ -\/>\ \`{}getentropy(2)`(`unistd.h`),\ if\ not\ available\ \`{}/dev/urandom`\ should\ be\ used.\ https://man.openbsd.org/getentropy,\ https://man.openbsd.org/urandom}}
\DoxyCodeLine{00016\ \textcolor{comment}{\ *\ Windows\ -\/>\ \`{}BCryptGenRandom`(`bcrypt.h`).\ https://docs.microsoft.com/en-\/us/windows/win32/api/bcrypt/nf-\/bcrypt-\/bcryptgenrandom}}
\DoxyCodeLine{00017\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#if\ defined(\_WIN32)}}
\DoxyCodeLine{00020\ \textcolor{comment}{/*}}
\DoxyCodeLine{00021\ \textcolor{comment}{\ *\ The\ defined\ WIN32\_NO\_STATUS\ macro\ disables\ return\ code\ definitions\ in}}
\DoxyCodeLine{00022\ \textcolor{comment}{\ *\ windows.h,\ which\ avoids\ "{}macro\ redefinition"{}\ MSVC\ warnings\ in\ ntstatus.h.}}
\DoxyCodeLine{00023\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#define\ WIN32\_NO\_STATUS}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ <windows.h>}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#undef\ WIN32\_NO\_STATUS}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ <ntstatus.h>}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ <bcrypt.h>}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#elif\ defined(\_\_linux\_\_)\ ||\ defined(\_\_APPLE\_\_)\ ||\ defined(\_\_FreeBSD\_\_)}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#include\ <sys/random.h>}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#elif\ defined(\_\_OpenBSD\_\_)}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#include\ <unistd.h>}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\#error\ "{}Couldn't\ identify\ the\ OS"{}}}
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00037\ \textcolor{preprocessor}{\#include\ <stddef.h>}}
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\#include\ <limits.h>}}
\DoxyCodeLine{00039\ \textcolor{preprocessor}{\#include\ <stdio.h>}}
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \textcolor{comment}{/*\ Returns\ 1\ on\ success,\ and\ 0\ on\ failure.\ */}}
\DoxyCodeLine{00043\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{int}\ fill\_random(\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}*\ data,\ \textcolor{keywordtype}{size\_t}\ size)\ \{}
\DoxyCodeLine{00044\ \textcolor{preprocessor}{\#if\ defined(\_WIN32)}}
\DoxyCodeLine{00045\ \ \ \ \ NTSTATUS\ res\ =\ BCryptGenRandom(NULL,\ data,\ size,\ BCRYPT\_USE\_SYSTEM\_PREFERRED\_RNG);}
\DoxyCodeLine{00046\ \ \ \ \ \textcolor{keywordflow}{if}\ (res\ !=\ STATUS\_SUCCESS\ ||\ size\ >\ ULONG\_MAX)\ \{}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00048\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 1;}
\DoxyCodeLine{00050\ \ \ \ \ \}}
\DoxyCodeLine{00051\ \textcolor{preprocessor}{\#elif\ defined(\_\_linux\_\_)\ ||\ defined(\_\_FreeBSD\_\_)}}
\DoxyCodeLine{00052\ \ \ \ \ \textcolor{comment}{/*\ If\ \`{}getrandom(2)`\ is\ not\ available\ you\ should\ fallback\ to\ /dev/urandom\ */}}
\DoxyCodeLine{00053\ \ \ \ \ ssize\_t\ res\ =\ getrandom(data,\ size,\ 0);}
\DoxyCodeLine{00054\ \ \ \ \ \textcolor{keywordflow}{if}\ (res\ <\ 0\ ||\ (\textcolor{keywordtype}{size\_t})res\ !=\ size\ )\ \{}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00056\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 1;}
\DoxyCodeLine{00058\ \ \ \ \ \}}
\DoxyCodeLine{00059\ \textcolor{preprocessor}{\#elif\ defined(\_\_APPLE\_\_)\ ||\ defined(\_\_OpenBSD\_\_)}}
\DoxyCodeLine{00060\ \ \ \ \ \textcolor{comment}{/*\ If\ \`{}getentropy(2)`\ is\ not\ available\ you\ should\ fallback\ to\ either}}
\DoxyCodeLine{00061\ \textcolor{comment}{\ \ \ \ \ *\ \`{}SecRandomCopyBytes`\ or\ /dev/urandom\ */}}
\DoxyCodeLine{00062\ \ \ \ \ \textcolor{keywordtype}{int}\ res\ =\ getentropy(data,\ size);}
\DoxyCodeLine{00063\ \ \ \ \ \textcolor{keywordflow}{if}\ (res\ ==\ 0)\ \{}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 1;}
\DoxyCodeLine{00065\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00066\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00067\ \ \ \ \ \}}
\DoxyCodeLine{00068\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00069\ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00070\ \}}
\DoxyCodeLine{00071\ }
\DoxyCodeLine{00072\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ print\_hex(\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}*\ data,\ \textcolor{keywordtype}{size\_t}\ size)\ \{}
\DoxyCodeLine{00073\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ i;}
\DoxyCodeLine{00074\ \ \ \ \ printf(\textcolor{stringliteral}{"{}0x"{}});}
\DoxyCodeLine{00075\ \ \ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ size;\ i++)\ \{}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}\%02x"{}},\ data[i]);}
\DoxyCodeLine{00077\ \ \ \ \ \}}
\DoxyCodeLine{00078\ \ \ \ \ printf(\textcolor{stringliteral}{"{}\(\backslash\)n"{}});}
\DoxyCodeLine{00079\ \}}
\DoxyCodeLine{00080\ }
\DoxyCodeLine{00081\ \textcolor{preprocessor}{\#if\ defined(\_MSC\_VER)}}
\DoxyCodeLine{00082\ \textcolor{comment}{//\ For\ SecureZeroMemory}}
\DoxyCodeLine{00083\ \textcolor{preprocessor}{\#include\ <Windows.h>}}
\DoxyCodeLine{00084\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00085\ \textcolor{comment}{/*\ Cleanses\ memory\ to\ prevent\ leaking\ sensitive\ info.\ Won't\ be\ optimized\ out.\ */}}
\DoxyCodeLine{00086\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ secure\_erase(\textcolor{keywordtype}{void}\ *ptr,\ \textcolor{keywordtype}{size\_t}\ len)\ \{}
\DoxyCodeLine{00087\ \textcolor{preprocessor}{\#if\ defined(\_MSC\_VER)}}
\DoxyCodeLine{00088\ \ \ \ \ \textcolor{comment}{/*\ SecureZeroMemory\ is\ guaranteed\ not\ to\ be\ optimized\ out\ by\ MSVC.\ */}}
\DoxyCodeLine{00089\ \ \ \ \ SecureZeroMemory(ptr,\ len);}
\DoxyCodeLine{00090\ \textcolor{preprocessor}{\#elif\ defined(\_\_GNUC\_\_)}}
\DoxyCodeLine{00091\ \ \ \ \ \textcolor{comment}{/*\ We\ use\ a\ memory\ barrier\ that\ scares\ the\ compiler\ away\ from\ optimizing\ out\ the\ memset.}}
\DoxyCodeLine{00092\ \textcolor{comment}{\ \ \ \ \ *}}
\DoxyCodeLine{00093\ \textcolor{comment}{\ \ \ \ \ *\ Quoting\ Adam\ Langley\ <agl@google.com>\ in\ commit\ ad1907fe73334d6c696c8539646c21b11178f20f}}
\DoxyCodeLine{00094\ \textcolor{comment}{\ \ \ \ \ *\ in\ BoringSSL\ (ISC\ License):}}
\DoxyCodeLine{00095\ \textcolor{comment}{\ \ \ \ \ *\ \ \ \ As\ best\ as\ we\ can\ tell,\ this\ is\ sufficient\ to\ break\ any\ optimisations\ that}}
\DoxyCodeLine{00096\ \textcolor{comment}{\ \ \ \ \ *\ \ \ \ might\ try\ to\ eliminate\ "{}superfluous"{}\ memsets.}}
\DoxyCodeLine{00097\ \textcolor{comment}{\ \ \ \ \ *\ This\ method\ used\ in\ memzero\_explicit()\ the\ Linux\ kernel,\ too.\ Its\ advantage\ is\ that\ it\ is}}
\DoxyCodeLine{00098\ \textcolor{comment}{\ \ \ \ \ *\ pretty\ efficient,\ because\ the\ compiler\ can\ still\ implement\ the\ memset()\ efficiently,}}
\DoxyCodeLine{00099\ \textcolor{comment}{\ \ \ \ \ *\ just\ not\ remove\ it\ entirely.\ See\ "{}Dead\ Store\ Elimination\ (Still)\ Considered\ Harmful"{}\ by}}
\DoxyCodeLine{00100\ \textcolor{comment}{\ \ \ \ \ *\ Yang\ et\ al.\ (USENIX\ Security\ 2017)\ for\ more\ background.}}
\DoxyCodeLine{00101\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{00102\ \ \ \ \ memset(ptr,\ 0,\ len);}
\DoxyCodeLine{00103\ \ \ \ \ \_\_asm\_\_\ \_\_volatile\_\_(\textcolor{stringliteral}{"{}"{}}\ :\ :\ \textcolor{stringliteral}{"{}r"{}}(ptr)\ :\ \textcolor{stringliteral}{"{}memory"{}});}
\DoxyCodeLine{00104\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00105\ \ \ \ \ \textcolor{keywordtype}{void}\ *(*\textcolor{keyword}{volatile}\ \textcolor{keyword}{const}\ volatile\_memset)(\textcolor{keywordtype}{void}\ *,\ \textcolor{keywordtype}{int},\ \textcolor{keywordtype}{size\_t})\ =\ memset;}
\DoxyCodeLine{00106\ \ \ \ \ volatile\_memset(ptr,\ 0,\ len);}
\DoxyCodeLine{00107\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00108\ \}}

\end{DoxyCode}
