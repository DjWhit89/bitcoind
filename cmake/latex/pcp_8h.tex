\doxysection{src/common/pcp.h File Reference}
\label{pcp_8h}\index{src/common/pcp.h@{src/common/pcp.h}}
{\ttfamily \#include $<$netaddress.\+h$>$}\newline
{\ttfamily \#include $<$util/threadinterrupt.\+h$>$}\newline
{\ttfamily \#include $<$variant$>$}\newline
\doxysubsubsection*{Data Structures}
\begin{DoxyCompactItemize}
\item 
struct \textbf{ Mapping\+Result}
\begin{DoxyCompactList}\small\item\em Successful response to a port mapping. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Typedefs}
\begin{DoxyCompactItemize}
\item 
typedef std\+::array$<$ uint8\+\_\+t, \textbf{ PCP\+\_\+\+MAP\+\_\+\+NONCE\+\_\+\+SIZE} $>$ \textbf{ PCPMapping\+Nonce}
\begin{DoxyCompactList}\small\item\em PCP mapping nonce. Arbitrary data chosen by the client to identify a mapping. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Enumerations}
\begin{DoxyCompactItemize}
\item 
enum class \textbf{ Mapping\+Error} \{ \textbf{ NETWORK\+\_\+\+ERROR}
, \textbf{ PROTOCOL\+\_\+\+ERROR}
, \textbf{ UNSUPP\+\_\+\+VERSION}
, \textbf{ NO\+\_\+\+RESOURCES}
 \}
\begin{DoxyCompactList}\small\item\em Unsuccessful response to a port mapping. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
std\+::variant$<$ \textbf{ Mapping\+Result}, \textbf{ Mapping\+Error} $>$ \textbf{ NATPMPRequest\+Port\+Map} (const \textbf{ CNet\+Addr} \&gateway, uint16\+\_\+t port, uint32\+\_\+t lifetime, \textbf{ CThread\+Interrupt} \&interrupt, int num\+\_\+tries=3, std\+::chrono\+::milliseconds timeout\+\_\+per\+\_\+try=std\+::chrono\+::milliseconds(1000))
\item 
std\+::variant$<$ \textbf{ Mapping\+Result}, \textbf{ Mapping\+Error} $>$ \textbf{ PCPRequest\+Port\+Map} (const \textbf{ PCPMapping\+Nonce} \&\textbf{ nonce}, const \textbf{ CNet\+Addr} \&gateway, const \textbf{ CNet\+Addr} \&bind, uint16\+\_\+t port, uint32\+\_\+t lifetime, \textbf{ CThread\+Interrupt} \&interrupt, int num\+\_\+tries=3, std\+::chrono\+::milliseconds timeout\+\_\+per\+\_\+try=std\+::chrono\+::milliseconds(1000))
\end{DoxyCompactItemize}
\doxysubsubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
constexpr size\+\_\+t \textbf{ PCP\+\_\+\+MAP\+\_\+\+NONCE\+\_\+\+SIZE} = 12
\begin{DoxyCompactList}\small\item\em Mapping nonce size in bytes (see RFC6887 section 11.\+1). \end{DoxyCompactList}\end{DoxyCompactItemize}


\label{doc-typedef-members}
\doxysubsection{Typedef Documentation}
\index{pcp.h@{pcp.h}!PCPMappingNonce@{PCPMappingNonce}}
\index{PCPMappingNonce@{PCPMappingNonce}!pcp.h@{pcp.h}}
\doxysubsubsection{PCPMappingNonce}
{\footnotesize\ttfamily \label{pcp_8h_a761c2cf99a646566fbfd29df4d42d498} 
typedef std\+::array$<$uint8\+\_\+t, \textbf{ PCP\+\_\+\+MAP\+\_\+\+NONCE\+\_\+\+SIZE}$>$ \textbf{ PCPMapping\+Nonce}}



PCP mapping nonce. Arbitrary data chosen by the client to identify a mapping. 



\label{doc-enum-members}
\doxysubsection{Enumeration Type Documentation}
\index{pcp.h@{pcp.h}!MappingError@{MappingError}}
\index{MappingError@{MappingError}!pcp.h@{pcp.h}}
\doxysubsubsection{MappingError}
{\footnotesize\ttfamily \label{pcp_8h_aa28e34b90cecaa1b5630d1c12b6c8b24} 
enum class \textbf{ Mapping\+Error}\hspace{0.3cm}{\ttfamily [strong]}}



Unsuccessful response to a port mapping. 

\begin{DoxyEnumFields}[2]{Enumerator}
\raisebox{\heightof{T}}[0pt][0pt]{\index{NETWORK\_ERROR@{NETWORK\_ERROR}!pcp.h@{pcp.h}}\index{pcp.h@{pcp.h}!NETWORK\_ERROR@{NETWORK\_ERROR}}}\label{pcp_8h_aa28e34b90cecaa1b5630d1c12b6c8b24a547ba52b62f9302ee1b6950111c36f9f} 
NETWORK\+\_\+\+ERROR&Any kind of network-\/level error. \\
\hline

\raisebox{\heightof{T}}[0pt][0pt]{\index{PROTOCOL\_ERROR@{PROTOCOL\_ERROR}!pcp.h@{pcp.h}}\index{pcp.h@{pcp.h}!PROTOCOL\_ERROR@{PROTOCOL\_ERROR}}}\label{pcp_8h_aa28e34b90cecaa1b5630d1c12b6c8b24a23f149f0f9ae9ed9e0119e7209178a5d} 
PROTOCOL\+\_\+\+ERROR&Any kind of protocol-\/level error, except unsupported version or no resources. \\
\hline

\raisebox{\heightof{T}}[0pt][0pt]{\index{UNSUPP\_VERSION@{UNSUPP\_VERSION}!pcp.h@{pcp.h}}\index{pcp.h@{pcp.h}!UNSUPP\_VERSION@{UNSUPP\_VERSION}}}\label{pcp_8h_aa28e34b90cecaa1b5630d1c12b6c8b24a4c734943fdf497b8695362e2809a9121} 
UNSUPP\+\_\+\+VERSION&Unsupported protocol version. \\
\hline

\raisebox{\heightof{T}}[0pt][0pt]{\index{NO\_RESOURCES@{NO\_RESOURCES}!pcp.h@{pcp.h}}\index{pcp.h@{pcp.h}!NO\_RESOURCES@{NO\_RESOURCES}}}\label{pcp_8h_aa28e34b90cecaa1b5630d1c12b6c8b24a3e052484eaaabf0d14b8c4b40267694f} 
NO\+\_\+\+RESOURCES&No resources available (port probably already mapped). \\
\hline

\end{DoxyEnumFields}


\label{doc-func-members}
\doxysubsection{Function Documentation}
\index{pcp.h@{pcp.h}!NATPMPRequestPortMap@{NATPMPRequestPortMap}}
\index{NATPMPRequestPortMap@{NATPMPRequestPortMap}!pcp.h@{pcp.h}}
\doxysubsubsection{NATPMPRequestPortMap()}
{\footnotesize\ttfamily \label{pcp_8h_a27f8753992ca17a18ceb6b4e70cf3753} 
std\+::variant$<$ \textbf{ Mapping\+Result}, \textbf{ Mapping\+Error} $>$ NATPMPRequest\+Port\+Map (\begin{DoxyParamCaption}\item[{const \textbf{ CNet\+Addr} \&}]{gateway}{, }\item[{uint16\+\_\+t}]{port}{, }\item[{uint32\+\_\+t}]{lifetime}{, }\item[{\textbf{ CThread\+Interrupt} \&}]{interrupt}{, }\item[{int}]{num\+\_\+tries}{ = {\ttfamily 3}, }\item[{std\+::chrono\+::milliseconds}]{timeout\+\_\+per\+\_\+try}{ = {\ttfamily std\+:\+:chrono\+:\+:milliseconds(1000)}}\end{DoxyParamCaption})}

Try to open a port using RFC 6886 NAT-\/\+PMP. IPv4 only.


\begin{DoxyItemize}
\item gateway\+: Destination address for PCP requests (usually the default gateway).
\item port\+: Internal port, and desired external port.
\item lifetime\+: Requested lifetime in seconds for mapping. The server may assign as shorter or longer lifetime. A lifetime of 0 deletes the mapping.
\item num\+\_\+tries\+: Number of tries in case of no response.
\end{DoxyItemize}

Returns the external\+\_\+ip\+:external\+\_\+port of the mapping if successful, otherwise a \doxyref{Mapping\+Error}{p.}{pcp_8h_aa28e34b90cecaa1b5630d1c12b6c8b24}. \index{pcp.h@{pcp.h}!PCPRequestPortMap@{PCPRequestPortMap}}
\index{PCPRequestPortMap@{PCPRequestPortMap}!pcp.h@{pcp.h}}
\doxysubsubsection{PCPRequestPortMap()}
{\footnotesize\ttfamily \label{pcp_8h_a3ec42e87c68901186c61a68e39e0c0ec} 
std\+::variant$<$ \textbf{ Mapping\+Result}, \textbf{ Mapping\+Error} $>$ PCPRequest\+Port\+Map (\begin{DoxyParamCaption}\item[{const \textbf{ PCPMapping\+Nonce} \&}]{nonce}{, }\item[{const \textbf{ CNet\+Addr} \&}]{gateway}{, }\item[{const \textbf{ CNet\+Addr} \&}]{bind}{, }\item[{uint16\+\_\+t}]{port}{, }\item[{uint32\+\_\+t}]{lifetime}{, }\item[{\textbf{ CThread\+Interrupt} \&}]{interrupt}{, }\item[{int}]{num\+\_\+tries}{ = {\ttfamily 3}, }\item[{std\+::chrono\+::milliseconds}]{timeout\+\_\+per\+\_\+try}{ = {\ttfamily std\+:\+:chrono\+:\+:milliseconds(1000)}}\end{DoxyParamCaption})}

Try to open a port using RFC 6887 Port Control Protocol (PCP). Handles IPv4 and IPv6.


\begin{DoxyItemize}
\item nonce\+: Mapping cookie. Keep this the same over renewals.
\item gateway\+: Destination address for PCP requests (usually the default gateway).
\item bind\+: Specific local bind address for IPv6 pinholing. Set this as INADDR\+\_\+\+ANY for IPv4.
\item port\+: Internal port, and desired external port.
\item lifetime\+: Requested lifetime in seconds for mapping. The server may assign as shorter or longer lifetime. A lifetime of 0 deletes the mapping.
\item num\+\_\+tries\+: Number of tries in case of no response.
\end{DoxyItemize}

Returns the external\+\_\+ip\+:external\+\_\+port of the mapping if successful, otherwise a \doxyref{Mapping\+Error}{p.}{pcp_8h_aa28e34b90cecaa1b5630d1c12b6c8b24}. 

\label{doc-var-members}
\doxysubsection{Variable Documentation}
\index{pcp.h@{pcp.h}!PCP\_MAP\_NONCE\_SIZE@{PCP\_MAP\_NONCE\_SIZE}}
\index{PCP\_MAP\_NONCE\_SIZE@{PCP\_MAP\_NONCE\_SIZE}!pcp.h@{pcp.h}}
\doxysubsubsection{PCP\_MAP\_NONCE\_SIZE}
{\footnotesize\ttfamily \label{pcp_8h_a85e8c19b124b5dee5fb8f43f8dcc0b75} 
size\+\_\+t PCP\+\_\+\+MAP\+\_\+\+NONCE\+\_\+\+SIZE = 12\hspace{0.3cm}{\ttfamily [constexpr]}}



Mapping nonce size in bytes (see RFC6887 section 11.\+1). 

