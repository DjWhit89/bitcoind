\doxysection{src/random.h File Reference}
\label{random_8h}\index{src/random.h@{src/random.h}}
{\ttfamily \#include $<$crypto/chacha20.\+h$>$}\newline
{\ttfamily \#include $<$crypto/common.\+h$>$}\newline
{\ttfamily \#include $<$span.\+h$>$}\newline
{\ttfamily \#include $<$uint256.\+h$>$}\newline
{\ttfamily \#include $<$util/check.\+h$>$}\newline
{\ttfamily \#include $<$bit$>$}\newline
{\ttfamily \#include $<$cassert$>$}\newline
{\ttfamily \#include $<$chrono$>$}\newline
{\ttfamily \#include $<$concepts$>$}\newline
{\ttfamily \#include $<$cstdint$>$}\newline
{\ttfamily \#include $<$limits$>$}\newline
{\ttfamily \#include $<$type\+\_\+traits$>$}\newline
{\ttfamily \#include $<$vector$>$}\newline
\doxysubsubsection*{Data Structures}
\begin{DoxyCompactItemize}
\item 
class \textbf{ Random\+Mixin$<$ T $>$}
\item 
class \textbf{ Fast\+Random\+Context}
\item 
class \textbf{ Insecure\+Random\+Context}
\end{DoxyCompactItemize}
\doxysubsubsection*{Concepts}
\begin{DoxyCompactItemize}
\item 
concept \textbf{ Random\+Number\+Generator}
\item 
concept \textbf{ Std\+Chrono\+Duration}
\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \textbf{ Random\+Init} ()
\item 
void \textbf{ Rand\+Add\+Periodic} () noexcept
\item 
void \textbf{ Rand\+Add\+Event} (const uint32\+\_\+t event\+\_\+info) noexcept
\item 
void \textbf{ Get\+Rand\+Bytes} (std\+::span$<$ unsigned char $>$ bytes) noexcept
\item 
void \textbf{ Get\+Strong\+Rand\+Bytes} (std\+::span$<$ unsigned char $>$ bytes) noexcept
\item 
double \textbf{ Make\+Exponentially\+Distributed} (uint64\+\_\+t uniform) noexcept
\item 
\textbf{ uint256} \textbf{ Get\+Rand\+Hash} () noexcept
\item 
bool \textbf{ Random\+\_\+\+Sanity\+Check} ()
\end{DoxyCompactItemize}


\label{doc-func-members}
\doxysubsection{Function Documentation}
\index{random.h@{random.h}!GetRandBytes@{GetRandBytes}}
\index{GetRandBytes@{GetRandBytes}!random.h@{random.h}}
\doxysubsubsection{GetRandBytes()}
{\footnotesize\ttfamily \label{random_8h_ab12e884f2063117fd7ae32b213b83175} 
void Get\+Rand\+Bytes (\begin{DoxyParamCaption}\item[{std\+::span$<$ unsigned char $>$}]{bytes}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [noexcept]}}

Generate random data via the internal PRNG.

These functions are designed to be fast (sub microsecond), but do not necessarily meaningfully add entropy to the PRNG state.

In test mode (see Seed\+Random\+For\+Test in \doxyref{src/test/util/random.\+h}{p.}{test_2util_2random_8h}), the normal PRNG state is bypassed, and a deterministic, seeded, PRNG is used instead.

Thread-\/safe. \index{random.h@{random.h}!GetRandHash@{GetRandHash}}
\index{GetRandHash@{GetRandHash}!random.h@{random.h}}
\doxysubsubsection{GetRandHash()}
{\footnotesize\ttfamily \label{random_8h_a88672f91432a247654f2c06298dd58ee} 
\textbf{ uint256} Get\+Rand\+Hash (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [noexcept]}}

Generate a random \doxyref{uint256}{p.}{classuint256}. \index{random.h@{random.h}!GetStrongRandBytes@{GetStrongRandBytes}}
\index{GetStrongRandBytes@{GetStrongRandBytes}!random.h@{random.h}}
\doxysubsubsection{GetStrongRandBytes()}
{\footnotesize\ttfamily \label{random_8h_a573a23ce1afe5405047d74faaafe7cbd} 
void Get\+Strong\+Rand\+Bytes (\begin{DoxyParamCaption}\item[{std\+::span$<$ unsigned char $>$}]{bytes}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [noexcept]}}

Gather entropy from various sources, feed it into the internal PRNG, and generate random data using it.

This function will cause failure whenever the OS RNG fails.

The normal PRNG is never bypassed here, even in test mode.

Thread-\/safe. \index{random.h@{random.h}!MakeExponentiallyDistributed@{MakeExponentiallyDistributed}}
\index{MakeExponentiallyDistributed@{MakeExponentiallyDistributed}!random.h@{random.h}}
\doxysubsubsection{MakeExponentiallyDistributed()}
{\footnotesize\ttfamily \label{random_8h_ac5b0dc6cd7937fa98493857db6389696} 
double Make\+Exponentially\+Distributed (\begin{DoxyParamCaption}\item[{uint64\+\_\+t}]{uniform}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [noexcept]}}

Given a uniformly random uint64\+\_\+t, return an exponentially distributed double with mean 1. \index{random.h@{random.h}!RandAddEvent@{RandAddEvent}}
\index{RandAddEvent@{RandAddEvent}!random.h@{random.h}}
\doxysubsubsection{RandAddEvent()}
{\footnotesize\ttfamily \label{random_8h_ac10d1b23919c03e5f708da1748e476a1} 
void Rand\+Add\+Event (\begin{DoxyParamCaption}\item[{const uint32\+\_\+t}]{event\+\_\+info}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [noexcept]}}

Gathers entropy from the low bits of the time at which events occur. Should be called with a uint32\+\_\+t describing the event at the time an event occurs.

Thread-\/safe. \index{random.h@{random.h}!RandAddPeriodic@{RandAddPeriodic}}
\index{RandAddPeriodic@{RandAddPeriodic}!random.h@{random.h}}
\doxysubsubsection{RandAddPeriodic()}
{\footnotesize\ttfamily \label{random_8h_a315ac9735459c7f7ba575faa0810d03e} 
void Rand\+Add\+Periodic (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [noexcept]}}

Gather entropy from various expensive sources, and feed them to the PRNG state.

Thread-\/safe. \index{random.h@{random.h}!Random\_SanityCheck@{Random\_SanityCheck}}
\index{Random\_SanityCheck@{Random\_SanityCheck}!random.h@{random.h}}
\doxysubsubsection{Random\_SanityCheck()}
{\footnotesize\ttfamily \label{random_8h_a7fb6c441a23070a7f510fd48b5ca2a18} 
bool Random\+\_\+\+Sanity\+Check (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})}

Check that OS randomness is available and returning the requested number of bytes. \index{random.h@{random.h}!RandomInit@{RandomInit}}
\index{RandomInit@{RandomInit}!random.h@{random.h}}
\doxysubsubsection{RandomInit()}
{\footnotesize\ttfamily \label{random_8h_aa4c101f3cf6614b5922770a6f5ca7209} 
void Random\+Init (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})}

Overall design of the RNG and entropy sources.

We maintain a single global 256-\/bit RNG state for all high-\/quality randomness. The following (classes of) functions interact with that state by mixing in new entropy, and optionally extracting random output from it\+:


\begin{DoxyItemize}
\item Get\+Rand\+Bytes, Get\+Rand\+Hash, Get\+Rand\+Dur, as well as construction of \doxyref{Fast\+Random\+Context}{p.}{class_fast_random_context} objects, perform \textquotesingle{}fast\textquotesingle{} seeding, consisting of mixing in\+:
\begin{DoxyItemize}
\item A stack pointer (indirectly committing to calling thread and call stack)
\item A high-\/precision timestamp (rdtsc when available, c++ high\+\_\+resolution\+\_\+clock otherwise)
\item 64 bits from the hardware RNG (rdrand) when available. These entropy sources are very fast, and only designed to protect against situations where a VM state restore/copy results in multiple systems with the same randomness. \doxyref{Fast\+Random\+Context}{p.}{class_fast_random_context} on the other hand does not protect against this once created, but is even faster (and acceptable to use inside tight loops).
\end{DoxyItemize}
\item The \doxyref{Get\+Strong\+Rand\+Bytes()}{p.}{random_8h_a573a23ce1afe5405047d74faaafe7cbd} function performs \textquotesingle{}slow\textquotesingle{} seeding, including everything that fast seeding includes, but additionally\+:
\begin{DoxyItemize}
\item OS entropy (/dev/urandom, getrandom(), ...). The application will terminate if this entropy source fails.
\item Another high-\/precision timestamp (indirectly committing to a benchmark of all the previous sources). These entropy sources are slower, but designed to make sure the RNG state contains fresh data that is unpredictable to attackers.
\end{DoxyItemize}
\item \doxyref{Rand\+Add\+Periodic()}{p.}{random_8h_a315ac9735459c7f7ba575faa0810d03e} seeds everything that fast seeding includes, but additionally\+:
\begin{DoxyItemize}
\item A high-\/precision timestamp
\item Dynamic environment data (clocks, resource usage, ...)
\item Strengthen the entropy for 10 ms using repeated SHA512. This is run once every minute.
\end{DoxyItemize}
\item On first use of the RNG (regardless of what function is called first), all entropy sources used in the \textquotesingle{}slow\textquotesingle{} seeder are included, but also\+:
\begin{DoxyItemize}
\item 256 bits from the hardware RNG (rdseed or rdrand) when available.
\item Dynamic environment data (performance monitoring, ...)
\item Static environment data
\item Strengthen the entropy for 100 ms using repeated SHA512.
\end{DoxyItemize}
\end{DoxyItemize}

When mixing in new entropy, H = SHA512(entropy $\vert$$\vert$ old\+\_\+rng\+\_\+state) is computed, and (up to) the first 32 bytes of H are produced as output, while the last 32 bytes become the new RNG state.

During tests, the RNG can be put into a special deterministic mode, in which the output of all RNG functions, with the exception of \doxyref{Get\+Strong\+Rand\+Bytes()}{p.}{random_8h_a573a23ce1afe5405047d74faaafe7cbd}, is replaced with the output of a deterministic RNG. This deterministic RNG does not gather entropy, and is unaffected by \doxyref{Rand\+Add\+Periodic()}{p.}{random_8h_a315ac9735459c7f7ba575faa0810d03e} or \doxyref{Rand\+Add\+Event()}{p.}{random_8h_ac10d1b23919c03e5f708da1748e476a1}. It produces pseudorandom data that only depends on the seed it was initialized with, possibly until it is reinitialized. Initialize global RNG state and log any CPU features that are used.

Calling this function is optional. RNG state will be initialized when first needed if it is not called. 