\chapter{leveldb File format }
\label{md_src_2leveldb_2doc_2table__format}\index{leveldb File format@{leveldb File format}}
\begin{DoxyVerb}<beginning_of_file>
[data block 1]
[data block 2]
...
[data block N]
[meta block 1]
...
[meta block K]
[metaindex block]
[index block]
[Footer]        (fixed size; starts at file_size - sizeof(Footer))
<end_of_file>
\end{DoxyVerb}


The file contains internal pointers. Each such pointer is called a Block\+Handle and contains the following information\+: \begin{DoxyVerb}offset:   varint64
size:     varint64
\end{DoxyVerb}


See {\texttt{varints}} for an explanation of varint64 format.


\begin{DoxyEnumerate}
\item The sequence of key/value pairs in the file are stored in sorted order and partitioned into a sequence of data blocks. These blocks come one after another at the beginning of the file. Each data block is formatted according to the code in {\ttfamily \doxyref{block\+\_\+builder.\+cc}{p.}{block__builder_8cc}}, and then optionally compressed.
\item After the data blocks we store a bunch of meta blocks. The supported meta block types are described below. More meta block types may be added in the future. Each meta block is again formatted using {\ttfamily \doxyref{block\+\_\+builder.\+cc}{p.}{block__builder_8cc}} and then optionally compressed.
\item A "{}metaindex"{} block. It contains one entry for every other meta block where the key is the name of the meta block and the value is a Block\+Handle pointing to that meta block.
\item An "{}index"{} block. This block contains one entry per data block, where the key is a string $>$= last key in that data block and before the first key in the successive data block. The value is the Block\+Handle for the data block.
\item At the very end of the file is a fixed length footer that contains the Block\+Handle of the metaindex and index blocks as well as a magic number. \begin{DoxyVerb} metaindex_handle: char[p];     // Block handle for metaindex
 index_handle:     char[q];     // Block handle for index
 padding:          char[40-p-q];// zeroed bytes to make fixed length
                                // (40==2*BlockHandle::kMaxEncodedLength)
 magic:            fixed64;     // == 0xdb4775248b80fb57 (little-endian)
\end{DoxyVerb}

\end{DoxyEnumerate}\doxysection{"{}filter"{} Meta Block}\label{md_src_2leveldb_2doc_2table__format_autotoc_md67}
If a {\ttfamily \doxyref{Filter\+Policy}{p.}{class_filter_policy}} was specified when the database was opened, a filter block is stored in each table. The "{}metaindex"{} block contains an entry that maps from {\ttfamily filter.$<$N$>$} to the Block\+Handle for the filter block where {\ttfamily $<$N$>$} is the string returned by the filter policy\textquotesingle{}s {\ttfamily Name()} method.

The filter block stores a sequence of filters, where filter i contains the output of {\ttfamily \doxyref{Filter\+Policy\+::\+Create\+Filter()}{p.}{class_filter_policy_a241d436d9ae9acf92f551d2238ad4b71}} on all keys that are stored in a block whose file offset falls within the range \begin{DoxyVerb}[ i*base ... (i+1)*base-1 ]
\end{DoxyVerb}


Currently, "{}base"{} is 2KB. So for example, if blocks X and Y start in the range {\ttfamily [ 0KB .. 2KB-\/1 ]}, all of the keys in X and Y will be converted to a filter by calling {\ttfamily \doxyref{Filter\+Policy\+::\+Create\+Filter()}{p.}{class_filter_policy_a241d436d9ae9acf92f551d2238ad4b71}}, and the resulting filter will be stored as the first filter in the filter block.

The filter block is formatted as follows\+: \begin{DoxyVerb}[filter 0]
[filter 1]
[filter 2]
...
[filter N-1]

[offset of filter 0]                  : 4 bytes
[offset of filter 1]                  : 4 bytes
[offset of filter 2]                  : 4 bytes
...
[offset of filter N-1]                : 4 bytes

[offset of beginning of offset array] : 4 bytes
lg(base)                              : 1 byte
\end{DoxyVerb}


The offset array at the end of the filter block allows efficient mapping from a data block offset to the corresponding filter.\doxysection{"{}stats"{} Meta Block}\label{md_src_2leveldb_2doc_2table__format_autotoc_md68}
This meta block contains a bunch of stats. The key is the name of the statistic. The value contains the statistic.

TODO(postrelease)\+: record following stats. \begin{DoxyVerb}data size
index size
key size (uncompressed)
value size (uncompressed)
number of entries
number of data blocks
\end{DoxyVerb}
 