\doxysection{tests\+\_\+exhaustive\+\_\+impl.\+h}
\label{schnorrsig_2tests__exhaustive__impl_8h_source}\index{src/secp256k1/src/modules/schnorrsig/tests\_exhaustive\_impl.h@{src/secp256k1/src/modules/schnorrsig/tests\_exhaustive\_impl.h}}
\textbf{ Go to the documentation of this file.}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{/***********************************************************************}}
\DoxyCodeLine{00002\ \textcolor{comment}{\ *\ Copyright\ (c)\ 2020\ Pieter\ Wuille\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ *}}
\DoxyCodeLine{00003\ \textcolor{comment}{\ *\ Distributed\ under\ the\ MIT\ software\ license,\ see\ the\ accompanying\ \ \ \ *}}
\DoxyCodeLine{00004\ \textcolor{comment}{\ *\ file\ COPYING\ or\ https://www.opensource.org/licenses/mit-\/license.php.*}}
\DoxyCodeLine{00005\ \textcolor{comment}{\ ***********************************************************************/}}
\DoxyCodeLine{00006\ }
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#ifndef\ SECP256K1\_MODULE\_SCHNORRSIG\_TESTS\_EXHAUSTIVE\_H}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#define\ SECP256K1\_MODULE\_SCHNORRSIG\_TESTS\_EXHAUSTIVE\_H}}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ "{}../../../include/secp256k1\_schnorrsig.h"{}}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ "{}main\_impl.h"{}}}
\DoxyCodeLine{00012\ }
\DoxyCodeLine{00013\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ invalid\_pubkey\_bytes[][32]\ =\ \{}
\DoxyCodeLine{00014\ \ \ \ \ \textcolor{comment}{/*\ 0\ */}}
\DoxyCodeLine{00015\ \ \ \ \ \{}
\DoxyCodeLine{00016\ \ \ \ \ \ \ \ \ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,}
\DoxyCodeLine{00017\ \ \ \ \ \ \ \ \ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0}
\DoxyCodeLine{00018\ \ \ \ \ \},}
\DoxyCodeLine{00019\ \ \ \ \ \textcolor{comment}{/*\ 2\ */}}
\DoxyCodeLine{00020\ \ \ \ \ \{}
\DoxyCodeLine{00021\ \ \ \ \ \ \ \ \ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,}
\DoxyCodeLine{00022\ \ \ \ \ \ \ \ \ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 2}
\DoxyCodeLine{00023\ \ \ \ \ \},}
\DoxyCodeLine{00024\ \ \ \ \ \textcolor{comment}{/*\ order\ */}}
\DoxyCodeLine{00025\ \ \ \ \ \{}
\DoxyCodeLine{00026\ \ \ \ \ \ \ \ \ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,}
\DoxyCodeLine{00027\ \ \ \ \ \ \ \ \ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,}
\DoxyCodeLine{00028\ \ \ \ \ \ \ \ \ ((EXHAUSTIVE\_TEST\_ORDER\ +\ 0UL)\ >>\ 24)\ \&\ 0xFF,}
\DoxyCodeLine{00029\ \ \ \ \ \ \ \ \ ((EXHAUSTIVE\_TEST\_ORDER\ +\ 0UL)\ >>\ 16)\ \&\ 0xFF,}
\DoxyCodeLine{00030\ \ \ \ \ \ \ \ \ ((EXHAUSTIVE\_TEST\_ORDER\ +\ 0UL)\ >>\ 8)\ \&\ 0xFF,}
\DoxyCodeLine{00031\ \ \ \ \ \ \ \ \ (EXHAUSTIVE\_TEST\_ORDER\ +\ 0UL)\ \&\ 0xFF}
\DoxyCodeLine{00032\ \ \ \ \ \},}
\DoxyCodeLine{00033\ \ \ \ \ \textcolor{comment}{/*\ order\ +\ 1\ */}}
\DoxyCodeLine{00034\ \ \ \ \ \{}
\DoxyCodeLine{00035\ \ \ \ \ \ \ \ \ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ ((EXHAUSTIVE\_TEST\_ORDER\ +\ 1UL)\ >>\ 24)\ \&\ 0xFF,}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ ((EXHAUSTIVE\_TEST\_ORDER\ +\ 1UL)\ >>\ 16)\ \&\ 0xFF,}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ ((EXHAUSTIVE\_TEST\_ORDER\ +\ 1UL)\ >>\ 8)\ \&\ 0xFF,}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \ \ (EXHAUSTIVE\_TEST\_ORDER\ +\ 1UL)\ \&\ 0xFF}
\DoxyCodeLine{00041\ \ \ \ \ \},}
\DoxyCodeLine{00042\ \ \ \ \ \textcolor{comment}{/*\ field\ size\ */}}
\DoxyCodeLine{00043\ \ \ \ \ \{}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFE,\ 0xFF,\ 0xFF,\ 0xFC,\ 0x2F}
\DoxyCodeLine{00046\ \ \ \ \ \},}
\DoxyCodeLine{00047\ \ \ \ \ \textcolor{comment}{/*\ field\ size\ +\ 1\ (note\ that\ 1\ is\ legal)\ */}}
\DoxyCodeLine{00048\ \ \ \ \ \{}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ \ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFE,\ 0xFF,\ 0xFF,\ 0xFC,\ 0x30}
\DoxyCodeLine{00051\ \ \ \ \ \},}
\DoxyCodeLine{00052\ \ \ \ \ \textcolor{comment}{/*\ 2\string^256\ -\/\ 1\ */}}
\DoxyCodeLine{00053\ \ \ \ \ \{}
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \ \ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF,\ 0xFF}
\DoxyCodeLine{00056\ \ \ \ \ \}}
\DoxyCodeLine{00057\ \};}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00059\ \textcolor{preprocessor}{\#define\ NUM\_INVALID\_KEYS\ (sizeof(invalid\_pubkey\_bytes)\ /\ sizeof(invalid\_pubkey\_bytes[0]))}}
\DoxyCodeLine{00060\ }
\DoxyCodeLine{00061\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{int}\ secp256k1\_hardened\_nonce\_function\_smallint(\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *nonce32,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *msg,}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ msglen,}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *key32,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *xonly\_pk32,}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *algo,\ \textcolor{keywordtype}{size\_t}\ algolen,}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{void}*\ data)\ \{}
\DoxyCodeLine{00066\ \ \ \ \ secp256k1\_scalar\ s;}
\DoxyCodeLine{00067\ \ \ \ \ \textcolor{keywordtype}{int}\ *idata\ =\ data;}
\DoxyCodeLine{00068\ \ \ \ \ (void)msg;}
\DoxyCodeLine{00069\ \ \ \ \ (void)msglen;}
\DoxyCodeLine{00070\ \ \ \ \ (void)key32;}
\DoxyCodeLine{00071\ \ \ \ \ (void)xonly\_pk32;}
\DoxyCodeLine{00072\ \ \ \ \ (void)algo;}
\DoxyCodeLine{00073\ \ \ \ \ (void)algolen;}
\DoxyCodeLine{00074\ \ \ \ \ secp256k1\_scalar\_set\_int(\&s,\ *idata);}
\DoxyCodeLine{00075\ \ \ \ \ secp256k1\_scalar\_get\_b32(nonce32,\ \&s);}
\DoxyCodeLine{00076\ \ \ \ \ \textcolor{keywordflow}{return}\ 1;}
\DoxyCodeLine{00077\ \}}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00079\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ test\_exhaustive\_schnorrsig\_verify(\textcolor{keyword}{const}\ secp256k1\_context\ *ctx,\ \textcolor{keyword}{const}\ secp256k1\_xonly\_pubkey*\ pubkeys,\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ (*xonly\_pubkey\_bytes)[32],\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}*\ parities)\ \{}
\DoxyCodeLine{00080\ \ \ \ \ \textcolor{keywordtype}{int}\ d;}
\DoxyCodeLine{00081\ \ \ \ \ uint64\_t\ iter\ =\ 0;}
\DoxyCodeLine{00082\ \ \ \ \ \textcolor{comment}{/*\ Iterate\ over\ the\ possible\ public\ keys\ to\ verify\ against\ (through\ their\ corresponding\ DL\ d).\ */}}
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{keywordflow}{for}\ (d\ =\ 1;\ d\ <=\ EXHAUSTIVE\_TEST\_ORDER\ /\ 2;\ ++d)\ \{}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ actual\_d;}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ k;}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ pk32[32];}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ memcpy(pk32,\ xonly\_pubkey\_bytes[d\ -\/\ 1],\ 32);}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ actual\_d\ =\ parities[d\ -\/\ 1]\ ?\ EXHAUSTIVE\_TEST\_ORDER\ -\/\ d\ :\ d;}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ Iterate\ over\ the\ possible\ valid\ first\ 32\ bytes\ in\ the\ signature,\ through\ their\ corresponding\ DL\ k.}}
\DoxyCodeLine{00090\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ Values\ above\ EXHAUSTIVE\_TEST\_ORDER/2\ refer\ to\ the\ entries\ in\ invalid\_pubkey\_bytes.\ */}}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (k\ =\ 1;\ k\ <=\ EXHAUSTIVE\_TEST\_ORDER\ /\ 2\ +\ NUM\_INVALID\_KEYS;\ ++k)\ \{}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ sig64[64];}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ actual\_k\ =\ -\/1;}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ e\_done[EXHAUSTIVE\_TEST\_ORDER]\ =\ \{0\};}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ e\_count\_done\ =\ 0;}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (skip\_section(\&iter))\ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (k\ <=\ EXHAUSTIVE\_TEST\_ORDER\ /\ 2)\ \{}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ memcpy(sig64,\ xonly\_pubkey\_bytes[k\ -\/\ 1],\ 32);}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ actual\_k\ =\ parities[k\ -\/\ 1]\ ?\ EXHAUSTIVE\_TEST\_ORDER\ -\/\ k\ :\ k;}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ memcpy(sig64,\ invalid\_pubkey\_bytes[k\ -\/\ 1\ -\/\ EXHAUSTIVE\_TEST\_ORDER\ /\ 2],\ 32);}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ Randomly\ generate\ messages\ until\ all\ challenges\ have\ been\ hit.\ */}}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (e\_count\_done\ <\ EXHAUSTIVE\_TEST\_ORDER)\ \{}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ secp256k1\_scalar\ e;}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ msg32[32];}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ testrand256(msg32);}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ secp256k1\_schnorrsig\_challenge(\&e,\ sig64,\ msg32,\ \textcolor{keyword}{sizeof}(msg32),\ pk32);}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ Only\ do\ work\ if\ we\ hit\ a\ challenge\ we\ haven't\ tried\ before.\ */}}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!e\_done[e])\ \{}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ Iterate\ over\ the\ possible\ valid\ last\ 32\ bytes\ in\ the\ signature.}}
\DoxyCodeLine{00112\ \textcolor{comment}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0..order=that\ s\ value;\ order+1=random\ bytes\ */}}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ count\_valid\ =\ 0;}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ s;}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (s\ =\ 0;\ s\ <=\ EXHAUSTIVE\_TEST\_ORDER\ +\ 1;\ ++s)\ \{}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ expect\_valid,\ valid;}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (s\ <=\ EXHAUSTIVE\_TEST\_ORDER)\ \{}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ memset(sig64\ +\ 32,\ 0,\ 32);}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ secp256k1\_write\_be32(sig64\ +\ 60,\ s);}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ expect\_valid\ =\ actual\_k\ !=\ -\/1\ \&\&\ s\ !=\ EXHAUSTIVE\_TEST\_ORDER\ \&\&}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (s\ ==\ (actual\_k\ +\ actual\_d\ *\ e)\ \%\ EXHAUSTIVE\_TEST\_ORDER);}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00123\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ testrand256(sig64\ +\ 32);}
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ expect\_valid\ =\ 0;}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ valid\ =\ secp256k1\_schnorrsig\_verify(ctx,\ sig64,\ msg32,\ \textcolor{keyword}{sizeof}(msg32),\ \&pubkeys[d\ -\/\ 1]);}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CHECK(valid\ ==\ expect\_valid);}
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ count\_valid\ +=\ valid;}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ Exactly\ one\ s\ value\ must\ verify,\ unless\ R\ is\ illegal.\ */}}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CHECK(count\_valid\ ==\ (actual\_k\ !=\ -\/1));}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ Don't\ retry\ other\ messages\ that\ result\ in\ the\ same\ challenge.\ */}}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ e\_done[e]\ =\ 1;}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ++e\_count\_done;}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00137\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00138\ \ \ \ \ \}}
\DoxyCodeLine{00139\ \}}
\DoxyCodeLine{00140\ }
\DoxyCodeLine{00141\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ test\_exhaustive\_schnorrsig\_sign(\textcolor{keyword}{const}\ secp256k1\_context\ *ctx,\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ (*xonly\_pubkey\_bytes)[32],\ \textcolor{keyword}{const}\ secp256k1\_keypair*\ keypairs,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}*\ parities)\ \{}
\DoxyCodeLine{00142\ \ \ \ \ \textcolor{keywordtype}{int}\ d,\ k;}
\DoxyCodeLine{00143\ \ \ \ \ uint64\_t\ iter\ =\ 0;}
\DoxyCodeLine{00144\ \ \ \ \ secp256k1\_schnorrsig\_extraparams\ extraparams\ =\ SECP256K1\_SCHNORRSIG\_EXTRAPARAMS\_INIT;}
\DoxyCodeLine{00145\ }
\DoxyCodeLine{00146\ \ \ \ \ \textcolor{comment}{/*\ Loop\ over\ keys.\ */}}
\DoxyCodeLine{00147\ \ \ \ \ \textcolor{keywordflow}{for}\ (d\ =\ 1;\ d\ <\ EXHAUSTIVE\_TEST\_ORDER;\ ++d)\ \{}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ actual\_d\ =\ d;}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (parities[d\ -\/\ 1])\ actual\_d\ =\ EXHAUSTIVE\_TEST\_ORDER\ -\/\ d;}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ Loop\ over\ nonces.\ */}}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (k\ =\ 1;\ k\ <\ EXHAUSTIVE\_TEST\_ORDER;\ ++k)\ \{}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ e\_done[EXHAUSTIVE\_TEST\_ORDER]\ =\ \{0\};}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ e\_count\_done\ =\ 0;}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ msg32[32];}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ sig64[64];}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ actual\_k\ =\ k;}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (skip\_section(\&iter))\ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ \ \ \ \ extraparams.noncefp\ =\ secp256k1\_hardened\_nonce\_function\_smallint;}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \ \ \ \ extraparams.ndata\ =\ \&k;}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (parities[k\ -\/\ 1])\ actual\_k\ =\ EXHAUSTIVE\_TEST\_ORDER\ -\/\ k;}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ Generate\ random\ messages\ until\ all\ challenges\ have\ been\ tried.\ */}}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (e\_count\_done\ <\ EXHAUSTIVE\_TEST\_ORDER)\ \{}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ secp256k1\_scalar\ e;}
\DoxyCodeLine{00164\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ testrand256(msg32);}
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ secp256k1\_schnorrsig\_challenge(\&e,\ xonly\_pubkey\_bytes[k\ -\/\ 1],\ msg32,\ \textcolor{keyword}{sizeof}(msg32),\ xonly\_pubkey\_bytes[d\ -\/\ 1]);}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ Only\ do\ work\ if\ we\ hit\ a\ challenge\ we\ haven't\ tried\ before.\ */}}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!e\_done[e])\ \{}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ secp256k1\_scalar\ expected\_s\ =\ (actual\_k\ +\ e\ *\ actual\_d)\ \%\ EXHAUSTIVE\_TEST\_ORDER;}
\DoxyCodeLine{00169\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ expected\_s\_bytes[32];}
\DoxyCodeLine{00170\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ secp256k1\_scalar\_get\_b32(expected\_s\_bytes,\ \&expected\_s);}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ Invoke\ the\ real\ function\ to\ construct\ a\ signature.\ */}}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CHECK(secp256k1\_schnorrsig\_sign\_custom(ctx,\ sig64,\ msg32,\ \textcolor{keyword}{sizeof}(msg32),\ \&keypairs[d\ -\/\ 1],\ \&extraparams));}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ The\ first\ 32\ bytes\ must\ match\ the\ xonly\ pubkey\ for\ the\ specified\ k.\ */}}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CHECK(secp256k1\_memcmp\_var(sig64,\ xonly\_pubkey\_bytes[k\ -\/\ 1],\ 32)\ ==\ 0);}
\DoxyCodeLine{00175\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ The\ last\ 32\ bytes\ must\ match\ the\ expected\ s\ value.\ */}}
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ CHECK(secp256k1\_memcmp\_var(sig64\ +\ 32,\ expected\_s\_bytes,\ 32)\ ==\ 0);}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ Don't\ retry\ other\ messages\ that\ result\ in\ the\ same\ challenge.\ */}}
\DoxyCodeLine{00178\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ e\_done[e]\ =\ 1;}
\DoxyCodeLine{00179\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ++e\_count\_done;}
\DoxyCodeLine{00180\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00181\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00183\ \ \ \ \ \}}
\DoxyCodeLine{00184\ \}}
\DoxyCodeLine{00185\ }
\DoxyCodeLine{00186\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ test\_exhaustive\_schnorrsig(\textcolor{keyword}{const}\ secp256k1\_context\ *ctx)\ \{}
\DoxyCodeLine{00187\ \ \ \ \ secp256k1\_keypair\ keypair[EXHAUSTIVE\_TEST\_ORDER\ -\/\ 1];}
\DoxyCodeLine{00188\ \ \ \ \ secp256k1\_xonly\_pubkey\ xonly\_pubkey[EXHAUSTIVE\_TEST\_ORDER\ -\/\ 1];}
\DoxyCodeLine{00189\ \ \ \ \ \textcolor{keywordtype}{int}\ parity[EXHAUSTIVE\_TEST\_ORDER\ -\/\ 1];}
\DoxyCodeLine{00190\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ xonly\_pubkey\_bytes[EXHAUSTIVE\_TEST\_ORDER\ -\/\ 1][32];}
\DoxyCodeLine{00191\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ i;}
\DoxyCodeLine{00192\ }
\DoxyCodeLine{00193\ \ \ \ \ \textcolor{comment}{/*\ Verify\ that\ all\ invalid\_pubkey\_bytes\ are\ actually\ invalid.\ */}}
\DoxyCodeLine{00194\ \ \ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ NUM\_INVALID\_KEYS;\ ++i)\ \{}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \ \ secp256k1\_xonly\_pubkey\ pk;}
\DoxyCodeLine{00196\ \ \ \ \ \ \ \ \ CHECK(!secp256k1\_xonly\_pubkey\_parse(ctx,\ \&pk,\ invalid\_pubkey\_bytes[i]));}
\DoxyCodeLine{00197\ \ \ \ \ \}}
\DoxyCodeLine{00198\ }
\DoxyCodeLine{00199\ \ \ \ \ \textcolor{comment}{/*\ Construct\ keypairs\ and\ xonly-\/pubkeys\ for\ the\ entire\ group.\ */}}
\DoxyCodeLine{00200\ \ \ \ \ \textcolor{keywordflow}{for}\ (i\ =\ 1;\ i\ <\ EXHAUSTIVE\_TEST\_ORDER;\ ++i)\ \{}
\DoxyCodeLine{00201\ \ \ \ \ \ \ \ \ secp256k1\_scalar\ scalar\_i;}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ buf[32];}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \ \ secp256k1\_scalar\_set\_int(\&scalar\_i,\ i);}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ secp256k1\_scalar\_get\_b32(buf,\ \&scalar\_i);}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \ \ CHECK(secp256k1\_keypair\_create(ctx,\ \&keypair[i\ -\/\ 1],\ buf));}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \ \ CHECK(secp256k1\_keypair\_xonly\_pub(ctx,\ \&xonly\_pubkey[i\ -\/\ 1],\ \&parity[i\ -\/\ 1],\ \&keypair[i\ -\/\ 1]));}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \ \ CHECK(secp256k1\_xonly\_pubkey\_serialize(ctx,\ xonly\_pubkey\_bytes[i\ -\/\ 1],\ \&xonly\_pubkey[i\ -\/\ 1]));}
\DoxyCodeLine{00208\ \ \ \ \ \}}
\DoxyCodeLine{00209\ }
\DoxyCodeLine{00210\ \ \ \ \ test\_exhaustive\_schnorrsig\_sign(ctx,\ xonly\_pubkey\_bytes,\ keypair,\ parity);}
\DoxyCodeLine{00211\ \ \ \ \ test\_exhaustive\_schnorrsig\_verify(ctx,\ xonly\_pubkey,\ xonly\_pubkey\_bytes,\ parity);}
\DoxyCodeLine{00212\ \}}
\DoxyCodeLine{00213\ }
\DoxyCodeLine{00214\ \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
