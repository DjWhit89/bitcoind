\doxysection{banman.\+h}
\label{banman_8h_source}\index{src/banman.h@{src/banman.h}}
\textbf{ Go to the documentation of this file.}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ Copyright\ (c)\ 2009-\/2010\ Satoshi\ Nakamoto}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ Copyright\ (c)\ 2009-\/present\ The\ Bitcoin\ Core\ developers}}
\DoxyCodeLine{00003\ \textcolor{comment}{//\ Distributed\ under\ the\ MIT\ software\ license,\ see\ the\ accompanying}}
\DoxyCodeLine{00004\ \textcolor{comment}{//\ file\ COPYING\ or\ http://www.opensource.org/licenses/mit-\/license.php.}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#ifndef\ BITCOIN\_BANMAN\_H}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#define\ BITCOIN\_BANMAN\_H}}
\DoxyCodeLine{00007\ }
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ <addrdb.h>}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ <common/bloom.h>}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ <net\_types.h>}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ <sync.h>}}
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#include\ <util/fs.h>}}
\DoxyCodeLine{00013\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ <chrono>}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ <cstdint>}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ <memory>}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{comment}{//\ NOTE:\ When\ adjusting\ this,\ update\ rpcnet:setban's\ help\ ("{}24h"{})}}
\DoxyCodeLine{00019\ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ DEFAULT\_MISBEHAVING\_BANTIME\ =\ 60\ *\ 60\ *\ 24;\ \textcolor{comment}{//\ Default\ 24-\/hour\ ban}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00022\ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ std::chrono::minutes\ DUMP\_BANS\_INTERVAL\{15\};}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00024\ \textcolor{keyword}{class\ }CClientUIInterface;}
\DoxyCodeLine{00025\ \textcolor{keyword}{class\ }CNetAddr;}
\DoxyCodeLine{00026\ \textcolor{keyword}{class\ }CSubNet;}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \textcolor{comment}{//\ Banman\ manages\ two\ related\ but\ distinct\ concepts:}}
\DoxyCodeLine{00029\ \textcolor{comment}{//}}
\DoxyCodeLine{00030\ \textcolor{comment}{//\ 1.\ Banning.\ This\ is\ configured\ manually\ by\ the\ user,\ through\ the\ setban\ RPC.}}
\DoxyCodeLine{00031\ \textcolor{comment}{//\ If\ an\ address\ or\ subnet\ is\ banned,\ we\ never\ accept\ incoming\ connections\ from}}
\DoxyCodeLine{00032\ \textcolor{comment}{//\ it\ and\ never\ create\ outgoing\ connections\ to\ it.\ We\ won't\ gossip\ its\ address}}
\DoxyCodeLine{00033\ \textcolor{comment}{//\ to\ other\ peers\ in\ addr\ messages.\ Banned\ addresses\ and\ subnets\ are\ stored\ to}}
\DoxyCodeLine{00034\ \textcolor{comment}{//\ disk\ on\ shutdown\ and\ reloaded\ on\ startup.\ Banning\ can\ be\ used\ to}}
\DoxyCodeLine{00035\ \textcolor{comment}{//\ prevent\ connections\ with\ spy\ nodes\ or\ other\ griefers.}}
\DoxyCodeLine{00036\ \textcolor{comment}{//}}
\DoxyCodeLine{00037\ \textcolor{comment}{//\ 2.\ Discouragement.\ If\ a\ peer\ misbehaves\ (see\ Misbehaving()\ in}}
\DoxyCodeLine{00038\ \textcolor{comment}{//\ net\_processing.cpp),\ we'll\ mark\ that\ address\ as\ discouraged.\ We\ still\ allow}}
\DoxyCodeLine{00039\ \textcolor{comment}{//\ incoming\ connections\ from\ them,\ but\ they're\ preferred\ for\ eviction\ when}}
\DoxyCodeLine{00040\ \textcolor{comment}{//\ we\ receive\ new\ incoming\ connections.\ We\ never\ make\ outgoing\ connections\ to}}
\DoxyCodeLine{00041\ \textcolor{comment}{//\ them,\ and\ do\ not\ gossip\ their\ address\ to\ other\ peers.\ This\ is\ implemented\ as}}
\DoxyCodeLine{00042\ \textcolor{comment}{//\ a\ bloom\ filter.\ We\ can\ (probabilistically)\ test\ for\ membership,\ but\ can't}}
\DoxyCodeLine{00043\ \textcolor{comment}{//\ list\ all\ discouraged\ addresses\ or\ unmark\ them\ as\ discouraged.\ Discouragement}}
\DoxyCodeLine{00044\ \textcolor{comment}{//\ can\ prevent\ our\ limited\ connection\ slots\ being\ used\ up\ by\ incompatible}}
\DoxyCodeLine{00045\ \textcolor{comment}{//\ or\ broken\ peers.}}
\DoxyCodeLine{00046\ \textcolor{comment}{//}}
\DoxyCodeLine{00047\ \textcolor{comment}{//\ Neither\ banning\ nor\ discouragement\ are\ protections\ against\ denial-\/of-\/service}}
\DoxyCodeLine{00048\ \textcolor{comment}{//\ attacks,\ since\ if\ an\ attacker\ has\ a\ way\ to\ waste\ our\ resources\ and\ we}}
\DoxyCodeLine{00049\ \textcolor{comment}{//\ disconnect\ from\ them\ and\ ban\ that\ address,\ it's\ trivial\ for\ them\ to}}
\DoxyCodeLine{00050\ \textcolor{comment}{//\ reconnect\ from\ another\ IP\ address.}}
\DoxyCodeLine{00051\ \textcolor{comment}{//}}
\DoxyCodeLine{00052\ \textcolor{comment}{//\ Attempting\ to\ automatically\ disconnect\ or\ ban\ any\ class\ of\ peer\ carries\ the}}
\DoxyCodeLine{00053\ \textcolor{comment}{//\ risk\ of\ splitting\ the\ network.\ For\ example,\ if\ we\ banned/disconnected\ for\ a}}
\DoxyCodeLine{00054\ \textcolor{comment}{//\ transaction\ that\ fails\ a\ policy\ check\ and\ a\ future\ version\ changes\ the}}
\DoxyCodeLine{00055\ \textcolor{comment}{//\ policy\ check\ so\ the\ transaction\ is\ accepted,\ then\ that\ transaction\ could}}
\DoxyCodeLine{00056\ \textcolor{comment}{//\ cause\ the\ network\ to\ split\ between\ old\ nodes\ and\ new\ nodes.}}
\DoxyCodeLine{00057\ \textcolor{comment}{//}}
\DoxyCodeLine{00058\ \textcolor{comment}{//\ NOTE:\ previously\ a\ misbehaving\ peer\ would\ get\ banned\ instead\ of\ discouraged.}}
\DoxyCodeLine{00059\ \textcolor{comment}{//\ This\ meant\ a\ peer\ could\ unboundedly\ grow\ our\ in-\/memory\ map\ of\ banned\ ips.\ When}}
\DoxyCodeLine{00060\ \textcolor{comment}{//\ receiving\ an\ ADDR\ message\ we\ would\ also\ compare\ every\ address\ received\ to\ every}}
\DoxyCodeLine{00061\ \textcolor{comment}{//\ item\ in\ the\ map.\ See\ https://bitcoincore.org/en/2024/07/03/disclose-\/unbounded-\/banlist.}}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00063\ \textcolor{keyword}{class\ }BanMan}
\DoxyCodeLine{00064\ \{}
\DoxyCodeLine{00065\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00066\ \ \ \ \ \string~BanMan();}
\DoxyCodeLine{00067\ \ \ \ \ BanMan(fs::path\ ban\_file,\ CClientUIInterface*\ client\_interface,\ int64\_t\ default\_ban\_time);}
\DoxyCodeLine{00068\ \ \ \ \ \textcolor{keywordtype}{void}\ Ban(\textcolor{keyword}{const}\ CNetAddr\&\ net\_addr,\ int64\_t\ ban\_time\_offset\ =\ 0,\ \textcolor{keywordtype}{bool}\ since\_unix\_epoch\ =\ \textcolor{keyword}{false})\ EXCLUSIVE\_LOCKS\_REQUIRED(!m\_banned\_mutex);}
\DoxyCodeLine{00069\ \ \ \ \ \textcolor{keywordtype}{void}\ Ban(\textcolor{keyword}{const}\ CSubNet\&\ sub\_net,\ int64\_t\ ban\_time\_offset\ =\ 0,\ \textcolor{keywordtype}{bool}\ since\_unix\_epoch\ =\ \textcolor{keyword}{false})\ EXCLUSIVE\_LOCKS\_REQUIRED(!m\_banned\_mutex);}
\DoxyCodeLine{00070\ \ \ \ \ \textcolor{keywordtype}{void}\ Discourage(\textcolor{keyword}{const}\ CNetAddr\&\ net\_addr)\ EXCLUSIVE\_LOCKS\_REQUIRED(!m\_banned\_mutex);}
\DoxyCodeLine{00071\ \ \ \ \ \textcolor{keywordtype}{void}\ ClearBanned()\ EXCLUSIVE\_LOCKS\_REQUIRED(!m\_banned\_mutex);}
\DoxyCodeLine{00072\ }
\DoxyCodeLine{00074\ \ \ \ \ \textcolor{keywordtype}{bool}\ IsBanned(\textcolor{keyword}{const}\ CNetAddr\&\ net\_addr)\ EXCLUSIVE\_LOCKS\_REQUIRED(!m\_banned\_mutex);}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00077\ \ \ \ \ \textcolor{keywordtype}{bool}\ IsBanned(\textcolor{keyword}{const}\ CSubNet\&\ sub\_net)\ EXCLUSIVE\_LOCKS\_REQUIRED(!m\_banned\_mutex);}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00080\ \ \ \ \ \textcolor{keywordtype}{bool}\ IsDiscouraged(\textcolor{keyword}{const}\ CNetAddr\&\ net\_addr)\ EXCLUSIVE\_LOCKS\_REQUIRED(!m\_banned\_mutex);}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00082\ \ \ \ \ \textcolor{keywordtype}{bool}\ Unban(\textcolor{keyword}{const}\ CNetAddr\&\ net\_addr)\ EXCLUSIVE\_LOCKS\_REQUIRED(!m\_banned\_mutex);}
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{keywordtype}{bool}\ Unban(\textcolor{keyword}{const}\ CSubNet\&\ sub\_net)\ EXCLUSIVE\_LOCKS\_REQUIRED(!m\_banned\_mutex);}
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{keywordtype}{void}\ GetBanned(banmap\_t\&\ banmap)\ EXCLUSIVE\_LOCKS\_REQUIRED(!m\_banned\_mutex);}
\DoxyCodeLine{00085\ \ \ \ \ \textcolor{keywordtype}{void}\ DumpBanlist()\ EXCLUSIVE\_LOCKS\_REQUIRED(!m\_banned\_mutex);}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00087\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00088\ \ \ \ \ \textcolor{keywordtype}{void}\ LoadBanlist()\ EXCLUSIVE\_LOCKS\_REQUIRED(!m\_banned\_mutex);}
\DoxyCodeLine{00090\ \ \ \ \ \textcolor{keywordtype}{void}\ SweepBanned()\ EXCLUSIVE\_LOCKS\_REQUIRED(m\_banned\_mutex);}
\DoxyCodeLine{00091\ }
\DoxyCodeLine{00092\ \ \ \ \ Mutex\ m\_banned\_mutex;}
\DoxyCodeLine{00093\ \ \ \ \ banmap\_t\ m\_banned\ GUARDED\_BY(m\_banned\_mutex);}
\DoxyCodeLine{00094\ \ \ \ \ \textcolor{keywordtype}{bool}\ m\_is\_dirty\ GUARDED\_BY(m\_banned\_mutex)\{\textcolor{keyword}{false}\};}
\DoxyCodeLine{00095\ \ \ \ \ CClientUIInterface*\ m\_client\_interface\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00096\ \ \ \ \ CBanDB\ m\_ban\_db;}
\DoxyCodeLine{00097\ \ \ \ \ \textcolor{keyword}{const}\ int64\_t\ m\_default\_ban\_time;}
\DoxyCodeLine{00098\ \ \ \ \ CRollingBloomFilter\ m\_discouraged\ GUARDED\_BY(m\_banned\_mutex)\ \{50000,\ 0.000001\};}
\DoxyCodeLine{00099\ \};}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00101\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ BITCOIN\_BANMAN\_H}}

\end{DoxyCode}
