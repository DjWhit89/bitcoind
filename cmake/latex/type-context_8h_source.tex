\doxysection{type-\/context.h}
\label{type-context_8h_source}\index{src/ipc/libmultiprocess/include/mp/type-\/context.h@{src/ipc/libmultiprocess/include/mp/type-\/context.h}}
\textbf{ Go to the documentation of this file.}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ Copyright\ (c)\ The\ Bitcoin\ Core\ developers}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ Distributed\ under\ the\ MIT\ software\ license,\ see\ the\ accompanying}}
\DoxyCodeLine{00003\ \textcolor{comment}{//\ file\ COPYING\ or\ http://www.opensource.org/licenses/mit-\/license.php.}}
\DoxyCodeLine{00004\ }
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#ifndef\ MP\_PROXY\_TYPE\_CONTEXT\_H}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#define\ MP\_PROXY\_TYPE\_CONTEXT\_H}}
\DoxyCodeLine{00007\ }
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ <mp/proxy-\/io.h>}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ <mp/util.h>}}
\DoxyCodeLine{00010\ }
\DoxyCodeLine{00011\ \textcolor{keyword}{namespace\ }mp\ \{}
\DoxyCodeLine{00012\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Output>}
\DoxyCodeLine{00013\ \textcolor{keywordtype}{void}\ CustomBuildField(TypeList<>,}
\DoxyCodeLine{00014\ \ \ \ \ Priority<1>,}
\DoxyCodeLine{00015\ \ \ \ \ ClientInvokeContext\&\ invoke\_context,}
\DoxyCodeLine{00016\ \ \ \ \ Output\&\&\ output,}
\DoxyCodeLine{00017\ \ \ \ \ \textcolor{keyword}{typename}\ std::enable\_if<std::is\_same<\textcolor{keyword}{decltype}(output.get()),\ Context::Builder>::value>::type*\ enable\ =\ \textcolor{keyword}{nullptr})}
\DoxyCodeLine{00018\ \{}
\DoxyCodeLine{00019\ \ \ \ \ \textcolor{keyword}{auto}\&\ connection\ =\ invoke\_context.connection;}
\DoxyCodeLine{00020\ \ \ \ \ \textcolor{keyword}{auto}\&\ thread\_context\ =\ invoke\_context.thread\_context;}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \ \ \ \ \textcolor{comment}{//\ Create\ local\ Thread::Server\ object\ corresponding\ to\ the\ current\ thread}}
\DoxyCodeLine{00023\ \ \ \ \ \textcolor{comment}{//\ and\ pass\ a\ Thread::Client\ reference\ to\ it\ in\ the\ Context.callbackThread}}
\DoxyCodeLine{00024\ \ \ \ \ \textcolor{comment}{//\ field\ so\ the\ function\ being\ called\ can\ make\ callbacks\ to\ this\ thread.}}
\DoxyCodeLine{00025\ \ \ \ \ \textcolor{comment}{//\ Also\ store\ the\ Thread::Client\ reference\ in\ the\ callback\_threads\ map\ so}}
\DoxyCodeLine{00026\ \ \ \ \ \textcolor{comment}{//\ future\ calls\ over\ this\ connection\ can\ reuse\ it.}}
\DoxyCodeLine{00027\ \ \ \ \ \textcolor{keyword}{auto}\ [callback\_thread,\ \_]\{SetThread(}
\DoxyCodeLine{00028\ \ \ \ \ \ \ \ \ GuardedRef\{thread\_context.waiter-\/>m\_mutex,\ thread\_context.callback\_threads\},\ \&connection,}
\DoxyCodeLine{00029\ \ \ \ \ \ \ \ \ [\&]\ \{\ \textcolor{keywordflow}{return}\ connection.m\_threads.add(kj::heap<ProxyServer<Thread>>(thread\_context,\ std::thread\{\}));\ \})\};}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \ \ \ \ \textcolor{comment}{//\ Call\ remote\ ThreadMap.makeThread\ function\ so\ server\ will\ create\ a}}
\DoxyCodeLine{00032\ \ \ \ \ \textcolor{comment}{//\ dedicated\ worker\ thread\ to\ run\ function\ calls\ from\ this\ thread.\ Store\ the}}
\DoxyCodeLine{00033\ \ \ \ \ \textcolor{comment}{//\ Thread::Client\ reference\ it\ returns\ in\ the\ request\_threads\ map.}}
\DoxyCodeLine{00034\ \ \ \ \ \textcolor{keyword}{auto}\ make\_request\_thread\{[\&]\{}
\DoxyCodeLine{00035\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ code\ will\ only\ run\ if\ an\ IPC\ client\ call\ is\ being\ made\ for\ the}}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ first\ time\ on\ this\ thread.\ After\ the\ first\ call,\ subsequent\ calls}}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ will\ use\ the\ existing\ request\ thread.\ This\ code\ will\ also\ never\ run\ at}}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ all\ if\ the\ current\ thread\ is\ a\ request\ thread\ created\ for\ a\ different}}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ IPC\ client,\ because\ in\ that\ case\ PassField\ code\ (below)\ will\ have\ set}}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ request\_thread\ to\ point\ to\ the\ calling\ thread.}}
\DoxyCodeLine{00041\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ request\ =\ connection.m\_thread\_map.makeThreadRequest();}
\DoxyCodeLine{00042\ \ \ \ \ \ \ \ \ request.setName(thread\_context.thread\_name);}
\DoxyCodeLine{00043\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ request.send().getResult();\ \textcolor{comment}{//\ Nonblocking\ due\ to\ capnp\ request\ pipelining.}}
\DoxyCodeLine{00044\ \ \ \ \ \}\};}
\DoxyCodeLine{00045\ \ \ \ \ \textcolor{keyword}{auto}\ [request\_thread,\ \_1]\{SetThread(}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ GuardedRef\{thread\_context.waiter-\/>m\_mutex,\ thread\_context.request\_threads\},}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ \&connection,\ make\_request\_thread)\};}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00049\ \ \ \ \ \textcolor{keyword}{auto}\ context\ =\ output.init();}
\DoxyCodeLine{00050\ \ \ \ \ context.setThread(request\_thread-\/>second-\/>m\_client);}
\DoxyCodeLine{00051\ \ \ \ \ context.setCallbackThread(callback\_thread-\/>second-\/>m\_client);}
\DoxyCodeLine{00052\ \}}
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00056\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Accessor,\ \textcolor{keyword}{typename}\ ServerContext,\ \textcolor{keyword}{typename}\ Fn,\ \textcolor{keyword}{typename}...\ Args>}
\DoxyCodeLine{00057\ \textcolor{keyword}{auto}\ PassField(Priority<1>,\ TypeList<>,\ ServerContext\&\ server\_context,\ \textcolor{keyword}{const}\ Fn\&\ fn,\ Args\&\&...\ args)\ -\/>}
\DoxyCodeLine{00058\ \ \ \ \ \textcolor{keyword}{typename}\ std::enable\_if<}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ \ std::is\_same<\textcolor{keyword}{decltype}(Accessor::get(server\_context.call\_context.getParams())),\ Context::Reader>::value,}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ kj::Promise<typename\ ServerContext::CallContext>>::type}
\DoxyCodeLine{00061\ \{}
\DoxyCodeLine{00062\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ params\ =\ server\_context.call\_context.getParams();}
\DoxyCodeLine{00063\ \ \ \ \ Context::Reader\ context\_arg\ =\ Accessor::get(params);}
\DoxyCodeLine{00064\ \ \ \ \ \textcolor{keyword}{auto}\ future\ =\ kj::newPromiseAndFulfiller<typename\ ServerContext::CallContext>();}
\DoxyCodeLine{00065\ \ \ \ \ \textcolor{keyword}{auto}\&\ server\ =\ server\_context.proxy\_server;}
\DoxyCodeLine{00066\ \ \ \ \ \textcolor{keywordtype}{int}\ req\ =\ server\_context.req;}
\DoxyCodeLine{00067\ \ \ \ \ \textcolor{keyword}{auto}\ invoke\ =\ [fulfiller\ =\ kj::mv(future.fulfiller),}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \ call\_context\ =\ kj::mv(server\_context.call\_context),\ \&server,\ req,\ fn,\ args...]()\ \textcolor{keyword}{mutable}\ \{}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ params\ =\ call\_context.getParams();}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Context::Reader\ context\_arg\ =\ Accessor::get(params);}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ServerContext\ server\_context\{server,\ call\_context,\ req\};}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Before\ invoking\ the\ function,\ store\ a\ reference\ to\ the}}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ callbackThread\ provided\ by\ the\ client\ in\ the}}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ thread\_local.request\_threads\ map.\ This\ way,\ if\ this}}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ server\ thread\ needs\ to\ execute\ any\ RPCs\ that\ call\ back\ to}}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ the\ client,\ they\ will\ happen\ on\ the\ same\ client\ thread}}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ that\ is\ waiting\ for\ this\ function,\ just\ like\ what\ would}}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ happen\ if\ this\ were\ a\ normal\ function\ call\ made\ on\ the}}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ local\ stack.}}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ the\ request\_threads\ map\ already\ has\ an\ entry\ for\ this}}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ connection,\ it\ will\ be\ left\ unchanged,\ and\ it\ indicates}}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ that\ the\ current\ thread\ is\ an\ RPC\ client\ thread\ which\ is}}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ in\ the\ middle\ of\ an\ RPC\ call,\ and\ the\ current\ RPC\ call\ is}}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ a\ nested\ call\ from\ the\ remote\ thread\ handling\ that\ RPC}}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ call.\ In\ this\ case,\ the\ callbackThread\ value\ should\ point}}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ to\ the\ same\ thread\ already\ in\ the\ map,\ so\ there\ is\ no}}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ need\ to\ update\ the\ map.}}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ thread\_context\ =\ g\_thread\_context;}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\&\ request\_threads\ =\ thread\_context.request\_threads;}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ConnThread\ request\_thread;}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ inserted;}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ server.m\_context.loop-\/>sync([\&]\ \{}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::tie(request\_thread,\ inserted)\ =\ SetThread(}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ GuardedRef\{thread\_context.waiter-\/>m\_mutex,\ request\_threads\},\ server.m\_context.connection,}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ [\&]\ \{\ \textcolor{keywordflow}{return}\ context\_arg.getCallbackThread();\ \});}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00099\ }
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ an\ entry\ was\ inserted\ into\ the\ request\_threads\ map,}}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ remove\ it\ after\ calling\ fn.invoke.\ If\ an\ entry\ was\ not}}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ inserted,\ one\ already\ existed,\ meaning\ this\ must\ be\ a}}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ recursive\ call\ (IPC\ call\ calling\ back\ to\ the\ caller\ which}}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ makes\ another\ IPC\ call),\ so\ avoid\ modifying\ the\ map.}}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ erase\_thread\{inserted\};}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ KJ\_DEFER(\textcolor{keywordflow}{if}\ (erase\_thread)\ \{}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Erase\ the\ request\_threads\ entry\ on\ the\ event\ loop}}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ thread\ with\ loop-\/>sync(),\ so\ if\ the\ connection\ is}}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ broken\ there\ is\ not\ a\ race\ between\ this\ thread\ and}}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ the\ disconnect\ handler\ trying\ to\ destroy\ the\ thread}}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ client\ object.}}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ server.m\_context.loop-\/>sync([\&]\ \{}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Look\ up\ the\ thread\ again\ without\ using\ existing}}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ iterator\ since\ entry\ may\ no\ longer\ be\ there\ after}}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ a\ disconnect.\ Destroy\ node\ after\ releasing}}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Waiter::m\_mutex,\ so\ the\ ProxyClient<Thread>}}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ destructor\ is\ able\ to\ use\ EventLoop::mutex}}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ without\ violating\ lock\ order.}}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ConnThreads::node\_type\ removed;}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Lock\ lock(thread\_context.waiter-\/>m\_mutex);}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ removed\ =\ request\_threads.extract(server.m\_context.connection);}
\DoxyCodeLine{00123\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ fn.invoke(server\_context,\ args...);}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ KJ\_IF\_MAYBE(exception,\ kj::runCatchingExceptions([\&]()\ \{}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ server.m\_context.loop-\/>sync([\&]\ \{}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ fulfiller\_dispose\ =\ kj::mv(fulfiller);}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ fulfiller\_dispose-\/>fulfill(kj::mv(call\_context));}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}))}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ server.m\_context.loop-\/>sync([\&]()\ \{}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ fulfiller\_dispose\ =\ kj::mv(fulfiller);}
\DoxyCodeLine{00137\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ fulfiller\_dispose-\/>reject(kj::mv(*exception));}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00139\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00140\ \ \ \ \ \ \ \ \ \ \ \ \ \};}
\DoxyCodeLine{00141\ }
\DoxyCodeLine{00142\ \ \ \ \ \textcolor{comment}{//\ Lookup\ Thread\ object\ specified\ by\ the\ client.\ The\ specified\ thread\ should}}
\DoxyCodeLine{00143\ \ \ \ \ \textcolor{comment}{//\ be\ a\ local\ Thread::Server\ object,\ but\ it\ needs\ to\ be\ looked\ up}}
\DoxyCodeLine{00144\ \ \ \ \ \textcolor{comment}{//\ asynchronously\ with\ getLocalServer().}}
\DoxyCodeLine{00145\ \ \ \ \ \textcolor{keyword}{auto}\ thread\_client\ =\ context\_arg.getThread();}
\DoxyCodeLine{00146\ \ \ \ \ \textcolor{keywordflow}{return}\ server.m\_context.connection-\/>m\_threads.getLocalServer(thread\_client)}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ .then([\&server,\ invoke\ =\ kj::mv(invoke),\ req](\textcolor{keyword}{const}\ kj::Maybe<Thread::Server\&>\&\ perhaps)\ \textcolor{keyword}{mutable}\ \{}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Assuming\ the\ thread\ object\ is\ found,\ pass\ it\ a\ pointer\ to\ the}}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \`{}invoke`\ lambda\ above\ which\ will\ invoke\ the\ function\ on\ that}}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ thread.}}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \ \ \ \ KJ\_IF\_MAYBE\ (thread\_server,\ perhaps)\ \{}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ thread\ =\ \textcolor{keyword}{static\_cast<}ProxyServer<Thread>\&\textcolor{keyword}{>}(*thread\_server);}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ MP\_LOG(*server.m\_context.loop,\ Log::Debug)}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}IPC\ server\ post\ request\ \ \#"{}}\ <<\ req\ <<\ \textcolor{stringliteral}{"{}\ \{"{}}\ <<\ thread.m\_thread\_context.thread\_name\ <<\ \textcolor{stringliteral}{"{}\}"{}};}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!thread.m\_thread\_context.waiter-\/>post(std::move(invoke)))\ \{}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ MP\_LOG(*server.m\_context.loop,\ Log::Error)}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}IPC\ server\ error\ request\ \#"{}}\ <<\ req}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ \{"{}}\ <<\ thread.m\_thread\_context.thread\_name\ <<\ \textcolor{stringliteral}{"{}\}"{}}\ <<\ \textcolor{stringliteral}{"{},\ thread\ busy"{}};}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}thread\ busy"{}});}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ MP\_LOG(*server.m\_context.loop,\ Log::Error)}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}IPC\ server\ error\ request\ \#"{}}\ <<\ req\ <<\ \textcolor{stringliteral}{"{},\ missing\ thread\ to\ execute\ request"{}};}
\DoxyCodeLine{00164\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}invalid\ thread\ handle"{}});}
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ \})}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Wait\ for\ the\ invocation\ to\ finish\ before\ returning\ to\ the\ caller.}}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ .then([invoke\_wait\ =\ kj::mv(future.promise)]()\ \textcolor{keyword}{mutable}\ \{\ \textcolor{keywordflow}{return}\ kj::mv(invoke\_wait);\ \});}
\DoxyCodeLine{00169\ \}}
\DoxyCodeLine{00170\ \}\ \textcolor{comment}{//\ namespace\ mp}}
\DoxyCodeLine{00171\ }
\DoxyCodeLine{00172\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ MP\_PROXY\_TYPE\_CONTEXT\_H}}

\end{DoxyCode}
